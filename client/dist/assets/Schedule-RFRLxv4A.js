import{_ as tt,v as j,D as At,G as at,H as lt,c as _,o as m,F as M,m as T,e as L,l as I,w as y,b as v,I as Oe,J as jt,t as E,r as b,K as x,k as be,j as Mt,d as f,x as z,h as ne,E as B,u as xt,g as O,n as et,f as Ut,z as ge,L as Nt}from"./index-wMK2ufhn.js";import{a as U}from"./api-CXz_2J58.js";import{u as Lt}from"./auth-BrjY59lp.js";const zt={class:"dashboard"},Ot={class:"metric-label"},Tt={class:"metric-value"},Yt=Object.assign({name:"ScheduleDashboard"},{__name:"ScheduleDashboard",props:{summary:{type:Object,default:()=>({direct:0,unscheduled:0,onLeave:0})}},setup(Te){const D=Te,p=j(()=>[{label:"直屬員工數",value:D.summary.direct,icon:At,color:"#0f766e"},{label:"未排班員工",value:D.summary.unscheduled,icon:at,color:"#dc2626"},{label:"請假中員工",value:D.summary.onLeave,icon:lt,color:"#f59e0b"}]);return(P,$)=>{const oe=L("el-card");return m(),_("div",zt,[(m(!0),_(M,null,T(p.value,w=>(m(),I(oe,{class:"metric-card",key:w.label},{default:y(()=>[(m(),I(Oe(w.icon),{class:"metric-icon",style:jt({color:w.color})},null,8,["style"])),v("div",Ot,E(w.label),1),v("div",Tt,E(w.value),1)]),_:2},1024))),128))])}}}),Rt=tt(Yt,[["__scopeId","data-v-ceb5c889"]]),Ft={class:"schedule-page"},Bt={class:"filters-card"},Pt={class:"filters-content"},Wt={class:"filter-group"},Jt={class:"filter-group"},Kt={class:"filter-group"},Ht={key:0,class:"filter-group include-self-group"},qt={class:"actions-card"},Gt={class:"primary-actions"},Qt={class:"secondary-actions"},Xt={class:"range-picker-wrapper"},Zt={class:"schedule-card"},ea={class:"schedule-header"},ta={class:"schedule-legend","data-test":"schedule-legend"},aa={key:1,class:"legend-empty","data-test":"shift-legend-empty"},la={key:0,class:"batch-toolbar"},sa={class:"employee-info"},na={class:"department-name"},oa={key:0,class:"sub-department"},ra={class:"employee-name"},ia={class:"day-header"},ua=["title"],da={key:0,class:"leave-indicator","data-test":"leave-indicator"},ca={class:"department-selects"},va={class:"shift-details"},pa={class:"detail-row"},ma={class:"detail-value"},fa={class:"detail-row"},ha={class:"detail-value"},ya={key:0,class:"detail-row"},_a={class:"detail-value"},ba={class:"modern-shift-tag"},ga={key:3,class:"missing-label"},Sa={key:2,class:"empty-cell"},wa={key:1,class:"modern-schedule-cell collapsed-cell"},ka={key:0,class:"approval-card"},Da={class:"approval-header"},Ca={class:"approval-count"},Ia={class:"applicant-name"},Va={class:"form-type"},Ea={__name:"Schedule",setup(Te){const D=b(x().format("YYYY-MM")),p=b({}),P=b([]),$=b([]),oe=b([]),w=b([]),Y=b([]),k=b(""),C=b(""),A=b(""),R=b(""),S=b(""),ue=b(""),Q=b([]),de=b(null),re=b(!1),Ye=b({direct:0,unscheduled:0,onLeave:0}),Se=b(""),we=b("all"),ke=b(new Set),X=b(new Set),W=b(new Set),te=b(new Set),je=b([]),ce=b(""),Z=b(""),J=b(""),De=b(!1),st=j(()=>X.value),nt=j(()=>W.value),ot=j(()=>te.value),Re=j(()=>{if(!Array.isArray(P.value)||!P.value.length)return[];const t=new Set;return P.value.reduce((e,a)=>{if(!a)return e;const l=$e(a)||a.name||a.code||"未命名班別",n=String(a._id||`${a.code??""}-${a.name??""}`);return!n||t.has(n)||(t.add(n),e.push({key:n,label:l,className:Qe(a)||"shift-normal"})),e},[])}),ae=(t,e)=>`${t}-${e}`,Me=t=>{const[e,a]=String(t).split("-");return{empId:e,day:Number(a)}},Ce=(t,e)=>{const a=p.value[t];if(!a)return!1;const l=a[e];return l?!l.leave:!1},xe=j(()=>{const t=new Set,e=K.value,a=$.value,l=(n,r)=>{Ce(n,r)&&t.add(ae(n,r))};return te.value.forEach(n=>{const{empId:r,day:c}=Me(n);l(r,c)}),X.value.forEach(n=>{e.forEach(r=>l(n,r.date))}),W.value.forEach(n=>{a.forEach(r=>l(r._id,n))}),t}),Ue=j(()=>xe.value.size>0),Fe=j(()=>Z.value?Xe(Z.value):[]),rt=(t,e)=>xe.value.has(ae(t,e)),Ie=()=>{const t=new Set($.value.map(l=>l._id)),e=new Set(K.value.map(l=>l.date));X.value=new Set(Array.from(X.value).filter(l=>t.has(l))),W.value=new Set(Array.from(W.value).filter(l=>e.has(l)));const a=new Set;te.value.forEach(l=>{const{empId:n,day:r}=Me(l);t.has(n)&&e.has(r)&&Ce(n,r)&&a.add(ae(n,r))}),te.value=a},it=()=>{X.value=new Set,W.value=new Set,te.value=new Set,je.value=[]},ut=(t,e)=>{const a=new Set(X.value);(typeof e=="boolean"?e:!a.has(t))?a.add(t):a.delete(t),X.value=a},dt=(t,e)=>{const a=new Set(W.value);(typeof e=="boolean"?e:!a.has(t))?a.add(t):a.delete(t),W.value=a},ct=(t,e,a)=>{if(!Ce(t,e))return;const l=ae(t,e),n=new Set(te.value);(typeof a=="boolean"?a:!n.has(l))?n.add(l):n.delete(l),te.value=n},vt=()=>{X.value=new Set($.value.map(t=>t._id))},pt=()=>{W.value=new Set(K.value.map(t=>t.date))},Be=t=>[...t].sort((e,a)=>{const l=(e.department||"").localeCompare(a.department||"");return l!==0?l:(e.name||"").localeCompare(a.name||"")}),mt=t=>{if(!Array.isArray(t)||t.length!==2)return;const[e,a]=t;if(!e||!a)return;const l=x(`${D.value}-01`),n=x(e),r=x(a);if(!n.isValid()||!r.isValid())return;const c=l.endOf("month");let u=n.isBefore(l)?l:n;const o=[];for(;(u.isBefore(r)||u.isSame(r,"day"))&&(u.year()===l.year()&&u.month()===l.month()&&o.push(u.date()),!u.isSame(c,"day"));)u=u.add(1,"day");W.value=new Set(o)};be(Z,(t,e)=>{t!==e&&(J.value="")}),be(Fe,t=>{J.value&&!t.some(e=>e._id===J.value)&&(J.value="")}),be(re,async(t,e)=>{t!==e&&ve.value&&(await fe(k.value,C.value),await me(),await ze())});const Ne=t=>{const e=p.value[t]||{},a=Object.values(e),l=a.some(r=>r.shiftId),n=a.some(r=>r.leave);return l?n?"onLeave":"scheduled":"unscheduled"},ft=j(()=>{let t=Se.value?$.value.filter(e=>e.name.includes(Se.value)):$.value;return we.value!=="all"&&(t=t.filter(e=>Ne(e._id)===we.value)),t}),Pe=j(()=>$.value.length>50),ht=t=>{ke.value.has(t)?ke.value.delete(t):ke.value.add(t)},yt=j(()=>Y.value.filter(t=>t.department===k.value)),_t=xt(),ie=Lt();ie.loadUser();const We=j(()=>["supervisor","admin"].includes(ie.role)),ve=j(()=>ie.role==="supervisor"),pe=We,Je=t=>{var l,n;const e=(l=B)==null?void 0:l.warning;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.warning:void 0;typeof a=="function"&&a!==e&&a(t)},Le=t=>{var l,n;const e=(l=B)==null?void 0:l.info;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.info:void 0;typeof a=="function"&&a!==e&&a(t)},bt=t=>{var l,n;const e=(l=B)==null?void 0:l.success;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.success:void 0;typeof a=="function"&&a!==e&&a(t)},gt=(t,e)=>{var l,n;const a=(n=(l=p.value)==null?void 0:l[t])==null?void 0:n[e];return a!=null&&a.leave?"已核准請假，該日不列入工作時數":""},K=j(()=>{const t=x(D.value+"-01"),e=t.endOf("month").date(),a=["日","一","二","三","四","五","六"];return Array.from({length:e},(l,n)=>{const r=n+1,c=a[t.date(r).day()];return{date:r,label:`${r}(${c})`}})});be($,Ie),be(K,Ie);async function St(){const t=await U("/api/shifts");if(t.ok){const e=await t.json(),a=Array.isArray(e==null?void 0:e.shifts)?e.shifts:Array.isArray(e)?e:[];Array.isArray(a)&&(P.value=a.map(l=>({_id:l._id,code:l.code,name:l.name??"",startTime:l.startTime,endTime:l.endTime,remark:l.remark})))}else t.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",t.status)}async function Ke(t=""){try{const e=t||A.value,a=e?`/api/sub-departments?department=${e}`:"/api/sub-departments",l=await U(a);if(!l.ok)throw new Error("Failed to fetch sub departments");const n=await l.json(),r=w.value.reduce((o,i)=>{const h=String(i._id);return o[h]=h,i.name&&(o[i.name]=h),o},{});A.value&&(r[A.value]=A.value),R.value&&(r[R.value]=A.value||R.value);const c=Array.isArray(n)?n.map(o=>{const i=o==null?void 0:o.department;let h="";return i&&typeof i=="object"?h=(i==null?void 0:i._id)||(i==null?void 0:i.id)||r[i==null?void 0:i.name]||"":h=r[i]||i||"",{...o,_id:String((o==null?void 0:o._id)??(o==null?void 0:o.id)??""),department:String(h)}}).filter(o=>o._id):[];let u=c;if(e&&(u=c.filter(o=>o.department===String(e)),!u.length&&S.value)){const o=c.find(i=>i._id===S.value);o?u=[o]:u=[{_id:S.value,name:ue.value||"",department:String(e)}]}if(ie.role==="supervisor"){const o=Q.value.length?Q.value:S.value?[S.value]:[],i=new Set(o.map(h=>String(h)));i.size?u=u.filter(h=>i.has(String(h._id))):u=[]}Y.value=u,Y.value.length?S.value&&Y.value.some(o=>o._id===S.value)?C.value=S.value:C.value&&Y.value.some(o=>o._id===C.value)||(C.value=Y.value[0]._id):C.value=""}catch(e){console.error(e),Y.value=[],C.value=""}}async function wt(){var t;try{const e=await U("/api/departments"),a=e.ok?await e.json():[],l=Array.isArray(a)?a.map(u=>{const o=(u==null?void 0:u._id)??(u==null?void 0:u.id)??(u==null?void 0:u.value)??"";return{...u,_id:String(o),name:(u==null?void 0:u.name)??""}}).filter(u=>u._id):[],n=k.value||A.value;let r=l;n&&(r=l.filter(u=>u._id===n||R.value&&u.name===R.value),!r.length&&n&&(r=[{_id:n,name:R.value||((t=l.find(u=>u._id===n))==null?void 0:t.name)||""}])),w.value=r.length?r:l,w.value.length?w.value.some(u=>u._id===k.value)||(k.value=w.value[0]._id):!k.value&&n&&(k.value=n);const c=k.value||A.value||(w.value.length?w.value[0]._id:"");await Ke(c)}catch(e){console.error(e)}}const Ve=()=>{var a,l;if(!We.value||typeof window>"u")return"";const t=(a=window.sessionStorage)==null?void 0:a.getItem("employeeId");if(t&&t!=="undefined")return t;const e=(l=window.localStorage)==null?void 0:l.getItem("employeeId");return e&&e!=="undefined"?e:""};async function kt(){if(ie.role!=="supervisor"){A.value="",R.value="",S.value="",ue.value="",Q.value=[],de.value=null;return}const t=Ve();if(!t){A.value="",R.value="",S.value="",ue.value="",Q.value=[],de.value=null;return}let e=null;try{const o=await U(`/api/employees/${t}`);if(!o.ok)throw new Error("Failed to fetch supervisor context");e=await o.json()}catch(o){console.error(o),de.value=null}de.value=e||null;const a=e==null?void 0:e.department;let l="",n="";if(a&&typeof a=="object")l=(a==null?void 0:a._id)||(a==null?void 0:a.id)||(a==null?void 0:a.value)||"",n=(a==null?void 0:a.name)||(e==null?void 0:e.departmentName)||"";else if(typeof a=="string"){const o=w.value.find(i=>String(i==null?void 0:i._id)===a||String((i==null?void 0:i.id)??"")===a||(i==null?void 0:i.code)===a||(i==null?void 0:i.name)===a);l=(o==null?void 0:o._id)||(o==null?void 0:o.id)||a,n=(o==null?void 0:o.name)||(e==null?void 0:e.departmentName)||a}A.value=l?String(l):"",R.value=n?String(n):"",A.value?k.value=A.value:k.value="";const r=e==null?void 0:e.subDepartment;let c="",u="";if(r&&typeof r=="object")c=(r==null?void 0:r._id)||(r==null?void 0:r.id)||(r==null?void 0:r.value)||"",u=(r==null?void 0:r.name)||(e==null?void 0:e.subDepartmentName)||"";else if(typeof r=="string"){const o=Y.value.find(i=>String(i==null?void 0:i._id)===r||String((i==null?void 0:i.id)??"")===r||(i==null?void 0:i.code)===r||(i==null?void 0:i.name)===r);c=(o==null?void 0:o._id)||(o==null?void 0:o.id)||r,u=(o==null?void 0:o.name)||(e==null?void 0:e.subDepartmentName)||r}S.value=c?String(c):"",ue.value=u?String(u):"",S.value?C.value=S.value:C.value="",await Dt(t)}async function Dt(t=""){if(ie.role!=="supervisor"){Q.value=[];return}const e=t||Ve();if(!e){Q.value=S.value?[String(S.value)]:[];return}try{const a=await U(`/api/employees?supervisor=${e}`);if(!a.ok)throw new Error("Failed to fetch direct reports");const l=await a.json(),n=Array.isArray(l)?l:[],r=new Set,c=[],u=o=>{if(!o&&o!==0)return;const i=String(o);i&&(r.has(i)||(r.add(i),c.push(i)))};n.forEach(o=>{const i=o==null?void 0:o.subDepartment;u(i&&typeof i=="object"?(i==null?void 0:i._id)||(i==null?void 0:i.id)||(i==null?void 0:i.value):i)}),u(S.value),Q.value=c}catch(a){console.error(a),Q.value=S.value?[String(S.value)]:[]}}async function me(){const t=Ve(),e=[`month=${D.value}`];t&&e.push(`supervisor=${t}`),re.value&&ve.value&&e.push("includeSelf=true");const a=`?${e.join("&")}`;try{const l=await U(`/api/schedules/monthly${a}`);if(!l.ok)throw new Error("Failed to fetch schedules");const n=await l.json(),r=Array.isArray(n)?n:[],c=K.value;p.value={},!$.value.length&&r.length&&await fe(k.value,C.value),$.value.forEach(o=>{const i=String(o._id);p.value[i]={},c.forEach(h=>{p.value[i][h.date]={shiftId:"",department:o.departmentId,subDepartment:o.subDepartmentId}})}),r.forEach(o=>{var s;const i=((s=o.employee)==null?void 0:s._id)||o.employee;if(!i)return;const h=String(i);p.value[h]||(p.value[h]={},c.forEach(d=>{p.value[h][d.date]={shiftId:"",department:"",subDepartment:""}}));const N=x(o.date).date(),F=$.value.find(d=>String(d._id)===h)||{};p.value[h][N]={id:o._id,shiftId:o.shiftId,department:o.department||F.departmentId,subDepartment:o.subDepartment||F.subDepartmentId}});const u=await U(`/api/schedules/leave-approvals${a}`);if(u.ok){const o=await u.json(),i=Array.isArray(o==null?void 0:o.approvals)?o.approvals:[],h=Array.isArray(o==null?void 0:o.leaves)?o.leaves:[];oe.value=i;const N=x(`${D.value}-01`).startOf("day"),F=N.endOf("month").startOf("day");h.forEach(s=>{var ee,he,ye;if(s.status!=="approved")return;const d=((ee=s.employee)==null?void 0:ee._id)||s.employee;if(!d)return;const V=String(d),H=x(s.startDate).startOf("day"),q=x(s.endDate).startOf("day");if(!H.isValid()||!q.isValid())return;let G=H.isBefore(N)?N:H;const se=q.isAfter(F)?F:q;for(;!G.isAfter(se);){const Ae=G.date(),_e=(ye=(he=p.value)==null?void 0:he[V])==null?void 0:ye[Ae];_e&&(_e.leave={type:s.leaveType,startDate:s.startDate,endDate:s.endDate,excludesHours:!0}),G=G.add(1,"day")}})}Ie()}catch(l){console.error(l),B.error("取得排班資料失敗")}}function He(t){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:p.value,employees:$.value,days:K.value,shifts:P.value})),_t.push({name:t==="week"?"PreviewWeek":"PreviewMonth"})}async function qe(t){try{const e=await U(`/api/schedules/export?month=${D.value}&format=${t}`);if(!e.ok)throw new Error;const a=await e.blob(),l=URL.createObjectURL(a),n=document.createElement("a");n.href=l,n.download=`schedules-${D.value}.${t==="excel"?"xlsx":"pdf"}`,n.click(),URL.revokeObjectURL(l)}catch{B.error("匯出失敗")}}async function Ct(t,e,a){const l=`${D.value}-${String(e).padStart(2,"0")}`,n=p.value[t][e];if(n!=null&&n.leave){Le("該日已核准請假，無法調整排班");return}const r=(n==null?void 0:n.shiftId)??"";if(n&&n.id)try{const c=await U(`/api/schedules/${n.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:a,department:n.department,subDepartment:n.subDepartment})});c.ok||await Ee(c,"更新排班失敗",t,e,r)}catch{await Ee(null,"更新排班失敗",t,e,r)}else try{const c=await U("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:t,date:l,shiftId:a,department:n.department,subDepartment:n.subDepartment})});if(c.ok){const u=await c.json();p.value[t][e]={id:u._id,shiftId:u.shiftId,department:n.department,subDepartment:n.subDepartment}}else await Ee(c,"新增排班失敗",t,e,r)}catch{await Ee(null,"新增排班失敗",t,e,r)}}async function It(){C.value="",await Ke(k.value),await fe(k.value,""),await me()}async function Vt(){await fe(k.value,C.value),await me()}async function Ee(t,e,a,l,n){p.value[a]||(p.value[a]={});const r=p.value[a][l]||{shiftId:"",department:"",subDepartment:""};r.shiftId=n,p.value[a][l]=r;let c="";try{if(t){const u=await t.json();c=(u==null?void 0:u.error)||""}}catch{}c==="employee conflict"?ge.alert("人員衝突"):c==="department overlap"?ge.alert("跨區重複"):c==="leave conflict"?ge.alert("請假衝突"):B.error(e)}async function Ge(t,e="批次套用失敗"){let a="";try{if(t){const l=await t.json();a=(l==null?void 0:l.error)||""}}catch{}a==="employee conflict"?B.warning("部分員工既有排班已更新，請重新整理檢查"):a==="department overlap"?ge.alert("部門或單位與既有資料不一致，無法套用"):a==="leave conflict"?ge.alert("選取日期包含已核准請假，無法套用"):a?B.error(a):B.error(e)}async function Et(){if(!Ue.value){Je("請先選取要套用的儲存格");return}if(!ce.value){Je("請選擇欲套用的班別");return}const t=[];if(xe.value.forEach(l=>{var i;const{empId:n,day:r}=Me(l),c=(i=p.value[n])==null?void 0:i[r];if(!c||c.leave)return;const u=Z.value||c.department||"";let o=c.subDepartment||"";Z.value?o=J.value||"":J.value&&(o=J.value),t.push({employee:n,day:r,date:`${D.value}-${String(r).padStart(2,"0")}`,shiftId:ce.value,department:u,subDepartment:o})}),!t.length){Le("選取的儲存格皆無需更新");return}const e=new Map;t.forEach(l=>{e.set(ae(l.employee,l.day),l)}),De.value=!0;const a=Nt.service({fullscreen:!0,lock:!0,text:"批次套用中..."});try{let l;try{l=await U("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:t.map(({day:r,...c})=>c)})})}catch{await Ge(null);return}if(!l.ok){await Ge(l);return}const n=await l.json();if(!Array.isArray(n)||!n.length){Le("沒有可更新的資料");return}n.forEach(r=>{var N;const c=((N=r.employee)==null?void 0:N._id)||r.employee,u=x(r.date).date();p.value[c]||(p.value[c]={});const o=ae(c,u),i=e.get(o)||{},h=p.value[c][u]||{};p.value[c][u]={...h,id:r._id||i.id||h.id,shiftId:r.shiftId||i.shiftId||h.shiftId,department:i.department??r.department??h.department??"",subDepartment:i.subDepartment??r.subDepartment??h.subDepartment??""},delete p.value[c][u].leave}),bt("批次套用完成")}finally{a==null||a.close(),De.value=!1}}function le(t){return P.value.find(e=>e._id===t)}function $e(t){if(!t)return"";const e=t.code??"",a=t.name??"";return!e&&!a?"":a?`${e}(${a})`:e}function Qe(t){const e=t&&typeof t=="object"?t:le(t);if(!e)return"";const a=`${e.code??""}${e.name??""}`;return/早/.test(a)?"shift-morning":/晚|夜/.test(a)?"shift-evening":"shift-normal"}function Xe(t){return Y.value.filter(e=>e.department===t)}async function fe(t="",e=""){var u;const a=Ve(),l=[],n=t||k.value||A.value,r=e||C.value;a&&l.push(`supervisor=${a}`),n&&l.push(`department=${n}`),r&&l.push(`subDepartment=${r}`);const c=`/api/employees${l.length?`?${l.join("&")}`:""}`;try{const o=await U(c);if(!o.ok)throw new Error("Failed to fetch employees");const i=await o.json(),h=w.value.reduce((d,V)=>(d[V._id]=V.name,d),{}),N=Y.value.reduce((d,V)=>(d[V._id]=V.name,d),{}),F=i.map(d=>{const V=(d==null?void 0:d._id)??(d==null?void 0:d.id)??"",H=(d==null?void 0:d.department)??"",q=(d==null?void 0:d.subDepartment)??"",G=V?String(V):"",se=H?String(H):"",ee=q?String(q):"";return{_id:G,name:d.name,departmentId:se,subDepartmentId:ee,department:h[se]||"",subDepartment:N[ee]||""}});let s=Be(F);if(re.value&&ve.value){const d=a?String(a):"";d&&!s.some(V=>V._id===d)&&(s=Be([...s,{_id:d,name:((u=de.value)==null?void 0:u.name)||"主管本人",departmentId:A.value||"",subDepartmentId:S.value||"",department:R.value||"",subDepartment:ue.value||""}]))}$.value=s,Ie()}catch(o){console.error(o),B.error("取得員工資料失敗")}}async function ze(){try{const t=[`month=${D.value}`];re.value&&ve.value&&t.push("includeSelf=true");const e=await U(`/api/schedules/summary?${t.join("&")}`);if(e.ok){const a=await e.json();Ye.value={direct:a.length,unscheduled:a.filter(l=>l.shiftCount===0).length,onLeave:a.filter(l=>l.leaveCount>0).length}}}catch(t){console.error(t)}}async function $t(t){const e=t?x(t):x();D.value=e.isValid()?e.format("YYYY-MM"):x().format("YYYY-MM"),await me(),await ze()}return Mt(async()=>{await ze(),await St(),await kt(),await wt(),await fe(k.value,C.value),await me()}),(t,e)=>{const a=L("el-date-picker"),l=L("el-option"),n=L("el-select"),r=L("el-switch"),c=L("el-button"),u=L("el-input"),o=L("el-table-column"),i=L("el-checkbox"),h=L("el-tag"),N=L("el-popover"),F=L("el-table");return m(),_("div",Ft,[e[38]||(e[38]=v("div",{class:"page-header"},[v("h1",{class:"page-title"},"排班管理"),v("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),f(Rt,{summary:Ye.value},null,8,["summary"]),v("div",Bt,[e[20]||(e[20]=v("div",{class:"filters-header"},[v("h3",{class:"filters-title"},"篩選條件")],-1)),v("div",Pt,[v("div",Wt,[e[16]||(e[16]=v("label",{class:"filter-label"},"選擇月份",-1)),f(a,{modelValue:D.value,"onUpdate:modelValue":e[0]||(e[0]=s=>D.value=s),type:"month","value-format":"YYYY-MM",onChange:$t,class:"modern-date-picker"},null,8,["modelValue"])]),v("div",Jt,[e[17]||(e[17]=v("label",{class:"filter-label"},"部門",-1)),f(n,{modelValue:k.value,"onUpdate:modelValue":e[1]||(e[1]=s=>k.value=s),placeholder:"請選擇部門",onChange:It,disabled:!0,class:"modern-select"},{default:y(()=>[(m(!0),_(M,null,T(w.value,s=>(m(),I(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),v("div",Kt,[e[18]||(e[18]=v("label",{class:"filter-label"},"單位",-1)),f(n,{modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=s=>C.value=s),placeholder:"請選擇單位",onChange:Vt,class:"modern-select"},{default:y(()=>[(m(!0),_(M,null,T(yt.value,s=>(m(),I(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),ve.value?(m(),_("div",Ht,[e[19]||(e[19]=v("label",{class:"filter-label"},"包含自己",-1)),f(r,{modelValue:re.value,"onUpdate:modelValue":e[3]||(e[3]=s=>re.value=s),"active-text":"是","inactive-text":"否","inline-prompt":""},null,8,["modelValue"])])):z("",!0)])]),v("div",qt,[v("div",Gt,[f(c,{type:"primary",class:"action-btn primary",onClick:it,disabled:!Ue.value},{default:y(()=>e[21]||(e[21]=[v("i",{class:"el-icon-close"},null,-1),O(" 清除選取 ")])),_:1},8,["disabled"]),f(c,{type:"primary",class:"action-btn primary",plain:"",onClick:vt,disabled:!$.value.length},{default:y(()=>e[22]||(e[22]=[v("i",{class:"el-icon-user"},null,-1),O(" 全選員工 ")])),_:1},8,["disabled"]),f(c,{type:"primary",class:"action-btn primary",plain:"",onClick:pt,disabled:!K.value.length},{default:y(()=>e[23]||(e[23]=[v("i",{class:"el-icon-date"},null,-1),O(" 全選日期 ")])),_:1},8,["disabled"])]),v("div",Qt,[v("div",Xt,[e[24]||(e[24]=v("label",{class:"range-label"},"自訂日期範圍",-1)),f(a,{modelValue:je.value,"onUpdate:modelValue":e[4]||(e[4]=s=>je.value=s),type:"daterange","start-placeholder":"開始日期","end-placeholder":"結束日期","range-separator":"至","unlink-panels":"",disabled:!K.value.length,class:"modern-date-picker range-picker",onChange:mt},null,8,["modelValue","disabled"])]),f(c,{onClick:e[5]||(e[5]=s=>He("week")),class:"action-btn secondary"},{default:y(()=>e[25]||(e[25]=[v("i",{class:"el-icon-calendar"},null,-1),O(" 預覽週表 ")])),_:1}),f(c,{onClick:e[6]||(e[6]=s=>He("month")),class:"action-btn secondary"},{default:y(()=>e[26]||(e[26]=[v("i",{class:"el-icon-date"},null,-1),O(" 預覽月表 ")])),_:1}),f(c,{onClick:e[7]||(e[7]=()=>qe("pdf")),class:"action-btn export"},{default:y(()=>e[27]||(e[27]=[v("i",{class:"el-icon-download"},null,-1),O(" 匯出 PDF ")])),_:1}),f(c,{onClick:e[8]||(e[8]=()=>qe("excel")),class:"action-btn export"},{default:y(()=>e[28]||(e[28]=[v("i",{class:"el-icon-s-grid"},null,-1),O(" 匯出 Excel ")])),_:1})])]),v("div",Zt,[v("div",ea,[e[30]||(e[30]=v("h3",{class:"schedule-title"},"員工排班表",-1)),v("div",ta,[Re.value.length?(m(!0),_(M,{key:0},T(Re.value,s=>(m(),_("span",{key:s.key,class:et(["legend-item",s.className]),"data-test":"shift-legend-item"},E(s.label),3))),128)):(m(),_("span",aa," 尚未設定班別 ")),e[29]||(e[29]=v("span",{class:"legend-item leave"},"請假",-1))]),f(u,{modelValue:Se.value,"onUpdate:modelValue":e[9]||(e[9]=s=>Se.value=s),placeholder:"搜尋員工",clearable:"",class:"employee-search"},null,8,["modelValue"]),f(n,{modelValue:we.value,"onUpdate:modelValue":e[10]||(e[10]=s=>we.value=s),placeholder:"狀態",class:"status-filter"},{default:y(()=>[f(l,{label:"全部",value:"all"}),f(l,{label:"缺班",value:"unscheduled"}),f(l,{label:"待審核請假",value:"onLeave"})]),_:1},8,["modelValue"])]),ne(pe)?(m(),_("div",la,[f(n,{modelValue:ce.value,"onUpdate:modelValue":e[11]||(e[11]=s=>ce.value=s),placeholder:"套用班別",class:"modern-select batch-select",filterable:"","data-test":"batch-shift-select"},{default:y(()=>[(m(!0),_(M,null,T(P.value,s=>(m(),I(l,{key:s._id,label:$e(s),value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(n,{modelValue:Z.value,"onUpdate:modelValue":e[12]||(e[12]=s=>Z.value=s),placeholder:"套用部門",clearable:"",class:"modern-select batch-select","data-test":"batch-dept-select"},{default:y(()=>[(m(!0),_(M,null,T(w.value,s=>(m(),I(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(n,{modelValue:J.value,"onUpdate:modelValue":e[13]||(e[13]=s=>J.value=s),placeholder:"套用單位",clearable:"",class:"modern-select batch-select",disabled:!Z.value,"data-test":"batch-subdept-select"},{default:y(()=>[(m(!0),_(M,null,T(Fe.value,s=>(m(),I(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),f(c,{type:"primary",class:"action-btn primary apply-btn",disabled:!Ue.value||!ce.value||De.value,loading:De.value,onClick:Et,"data-test":"batch-apply-button"},{default:y(()=>e[31]||(e[31]=[O(" 套用至選取 ")])),_:1},8,["disabled","loading"])])):z("",!0),f(F,{class:"modern-schedule-table",data:ft.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"},onRowClick:e[15]||(e[15]=s=>Pe.value&&ht(s._id))},{default:y(()=>[f(o,{label:"部門／單位",width:"180",fixed:"left"},{default:y(({row:s})=>[v("div",sa,[v("div",na,E(s.department),1),s.subDepartment?(m(),_("div",oa,E(s.subDepartment),1)):z("",!0)])]),_:1}),f(o,{prop:"name",label:"員工姓名",width:"150",fixed:"left"},{default:y(({row:s})=>[v("div",ra,[ne(pe)?(m(),I(i,{key:0,class:"row-checkbox","model-value":st.value.has(s._id),onChange:d=>ut(s._id,d)},null,8,["model-value","onChange"])):z("",!0),Ne(s._id)==="unscheduled"?(m(),I(Oe(ne(at)),{key:1,class:"status-icon unscheduled"})):Ne(s._id)==="onLeave"?(m(),I(Oe(ne(lt)),{key:2,class:"status-icon on-leave"})):z("",!0),O(" "+E(s.name),1)])]),_:1}),(m(!0),_(M,null,T(K.value,s=>(m(),I(o,{key:s.date,label:s.label,width:"140",align:"center"},{header:y(()=>[v("div",ia,[v("span",null,E(s.label),1),ne(pe)?(m(),I(i,{key:0,class:"day-checkbox","model-value":nt.value.has(s.date),onChange:d=>dt(s.date,d)},null,8,["model-value","onChange"])):z("",!0)])]),default:y(({row:d})=>{var V,H,q,G,se,ee,he,ye,Ae,_e,Ze;return[!Pe.value||ke.value.has(d._id)?(m(),_("div",{key:0,class:et(["modern-schedule-cell",[(H=(V=p.value[d._id])==null?void 0:V[s.date])!=null&&H.leave?"":Qe((G=(q=p.value[d._id])==null?void 0:q[s.date])==null?void 0:G.shiftId),{"has-leave":(ee=(se=p.value[d._id])==null?void 0:se[s.date])==null?void 0:ee.leave,"missing-shift":!((ye=(he=p.value[d._id])==null?void 0:he[s.date])!=null&&ye.shiftId)&&!((_e=(Ae=p.value[d._id])==null?void 0:Ae[s.date])!=null&&_e.leave),"is-selected":rt(d._id,s.date)}]]),title:gt(d._id,s.date)},[ne(pe)?(m(),_("div",{key:0,class:"cell-selection",onClick:e[14]||(e[14]=Ut(()=>{},["stop"]))},[f(i,{"model-value":ot.value.has(ae(d._id,s.date)),disabled:!Ce(d._id,s.date),onChange:g=>ct(d._id,s.date,g),size:"small"},null,8,["model-value","disabled","onChange"])])):z("",!0),(Ze=p.value[d._id])!=null&&Ze[s.date]?(m(),_(M,{key:1},[p.value[d._id][s.date].leave?(m(),_("div",da,[f(h,{type:"warning",effect:"light",size:"small",class:"leave-tag"},{default:y(()=>e[32]||(e[32]=[O(" 休假中 ")])),_:1}),e[33]||(e[33]=v("span",{class:"leave-note"},"已核准請假，不列入工時",-1))])):ne(pe)?(m(),_(M,{key:1},[f(n,{modelValue:p.value[d._id][s.date].shiftId,"onUpdate:modelValue":g=>p.value[d._id][s.date].shiftId=g,placeholder:"選擇班別",onChange:g=>Ct(d._id,s.date,g),class:"cell-select shift-select",size:"small"},{default:y(()=>[(m(!0),_(M,null,T(P.value,g=>(m(),I(l,{key:g._id,label:$e(g),value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),v("div",ca,[f(n,{modelValue:p.value[d._id][s.date].department,"onUpdate:modelValue":g=>p.value[d._id][s.date].department=g,placeholder:"部門",size:"small",onChange:()=>p.value[d._id][s.date].subDepartment="",class:"cell-select dept-select"},{default:y(()=>[(m(!0),_(M,null,T(w.value,g=>(m(),I(l,{key:g._id,label:g.name,value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),f(n,{modelValue:p.value[d._id][s.date].subDepartment,"onUpdate:modelValue":g=>p.value[d._id][s.date].subDepartment=g,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:y(()=>[(m(!0),_(M,null,T(Xe(p.value[d._id][s.date].department),g=>(m(),I(l,{key:g._id,label:g.name,value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(m(),_(M,{key:2},[le(p.value[d._id][s.date].shiftId)?(m(),I(N,{key:0,placement:"top",trigger:"hover",width:200},{reference:y(()=>[v("div",ba,E($e(le(p.value[d._id][s.date].shiftId))),1)]),default:y(()=>[v("div",va,[v("div",pa,[e[34]||(e[34]=v("span",{class:"detail-label"},"上班時間：",-1)),v("span",ma,E(le(p.value[d._id][s.date].shiftId).startTime),1)]),v("div",fa,[e[35]||(e[35]=v("span",{class:"detail-label"},"下班時間：",-1)),v("span",ha,E(le(p.value[d._id][s.date].shiftId).endTime),1)]),le(p.value[d._id][s.date].shiftId).remark?(m(),_("div",ya,[e[36]||(e[36]=v("span",{class:"detail-label"},"備註：",-1)),v("span",_a,E(le(p.value[d._id][s.date].shiftId).remark),1)])):z("",!0)])]),_:2},1024)):z("",!0)],64)),!p.value[d._id][s.date].shiftId&&!p.value[d._id][s.date].leave?(m(),_("div",ga," 未排班 ")):z("",!0)],64)):(m(),_("span",Sa,"-"))],10,ua)):(m(),_("div",wa,"展開班表"))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])]),oe.value.length?(m(),_("div",ka,[v("div",Da,[e[37]||(e[37]=v("h3",{class:"approval-title"},"待處理審批",-1)),v("div",Ca,E(oe.value.length)+" 項待處理",1)]),f(F,{class:"modern-approval-table",data:oe.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:y(()=>[f(o,{label:"申請人",width:"120"},{default:y(({row:s})=>{var d;return[v("div",Ia,E((d=s.applicant_employee)==null?void 0:d.name),1)]}),_:1}),f(o,{label:"申請類型",width:"150"},{default:y(({row:s})=>{var d;return[v("div",Va,E(((d=s.form)==null?void 0:d.name)||"未知類型"),1)]}),_:1}),f(o,{prop:"status",label:"狀態",width:"100"},{default:y(({row:s})=>[f(h,{type:s.status==="approved"?"success":s.status==="rejected"?"danger":"warning",class:"status-tag"},{default:y(()=>[O(E(s.status),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])):z("",!0)])}}},Ma=tt(Ea,[["__scopeId","data-v-193a233a"]]);export{Ma as default};
