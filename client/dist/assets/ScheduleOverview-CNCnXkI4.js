import{_ as pe,r as u,D as se,j as I,k as ve,c as d,b as n,d as y,n as A,q as fe,w as m,e as p,F as z,t as M,E as q,o,g as J,v as x,p as _e}from"./index-D4KTiw27.js";import{a as O}from"./api-BCEPQkJB.js";const be={class:"schedule-overview-page"},ye={class:"filters-header"},ge={class:"export-actions"},he={class:"filters-grid"},we={class:"filter-item"},ke={class:"filter-item"},De={class:"filter-item"},Ae={class:"filter-item"},xe={key:3,class:"overview-results"},ze={class:"organization-header"},Me={class:"organization-title"},Ve={class:"organization-meta"},Ee={class:"department-header"},Re={class:"department-title"},$e={class:"department-meta"},Ce={class:"unit-header"},Oe={class:"unit-title"},Se={class:"unit-meta"},Ue={class:"unit-table-wrapper"},Le={__name:"ScheduleOverview",setup(Ne){const k=u(se().format("YYYY-MM")),g=u(""),v=u(""),f=u(""),T=u([]),E=u([]),K=u([]),S=u(!1),R=u(""),U=u([]),L=u([]),H=u(!1),$=u(!1),N=u("");let j=0;const _=t=>{if(!t&&t!==0)return"";if(typeof t=="string")return t;if(typeof t=="object"){if(t!=null&&t._id)return String(t._id);if(t!=null&&t.id)return String(t.id)}return String(t)},Q=I(()=>{const t=g.value;return t?E.value.filter(e=>_(e.organization)===t):E.value}),W=I(()=>{const t=v.value,e=g.value;return K.value.filter(s=>{const a=_(s.department);if(t)return a===t;if(!e)return!0;const r=E.value.find(i=>_(i._id)===a);return r?_(r.organization)===e:!1})}),le=I(()=>L.value.some(t=>t.departments.some(e=>e.subDepartments.some(s=>s.employees.length)))),X=I(()=>!k.value||S.value||$.value||!H.value),ne=t=>{const e=se(t);return e.isValid()?e.format("MM/DD"):t},re=t=>t.employees.map(e=>{const s={};return U.value.forEach(a=>{s[a]=""}),(e.schedules||[]).forEach(a=>{const r=a.date;s[r]||(s[r]=a.shiftName||"")}),{id:e.id,name:e.name,title:e.title||"",entries:s}}).sort((e,s)=>e.name.localeCompare(s.name,"zh-Hant",{sensitivity:"base"}));async function Y(t,e){if(!t.ok){let s=e;try{const a=await t.json();s=(a==null?void 0:a.error)||(a==null?void 0:a.message)||s}catch{}throw new Error(s)}return t.json()}async function oe(t,e){if(!t.ok){let s=e;try{const a=await t.json();s=(a==null?void 0:a.error)||(a==null?void 0:a.message)||s}catch{}throw new Error(s)}return t.blob()}async function ie(){try{const[t,e,s]=await Promise.all([O("/api/organizations"),O("/api/departments"),O("/api/sub-departments")]),[a,r,i]=await Promise.all([Y(t,"無法載入機構資料"),Y(e,"無法載入部門資料"),Y(s,"無法載入小單位資料")]);T.value=Array.isArray(a)?a:[],E.value=Array.isArray(r)?r:[],K.value=Array.isArray(i)?i:[],H.value=!0}catch(t){const e=(t==null?void 0:t.message)||"無法載入必要資料";R.value=e,q.error(e)}}function ue(t){return Array.isArray(t)?t.map(e=>{const s=Array.isArray(e.departments)?e.departments.map(a=>{const r=new Map;(Array.isArray(a.subDepartments)?a.subDepartments:[]).forEach(b=>{if(!b)return;const V=b.id||`name:${b.name||""}`;let h=r.get(V);h||(h={...b,_employeesMap:new Map},h.employees=[],r.set(V,h)),(Array.isArray(b.employees)?b.employees:[]).forEach(c=>{if(!c)return;const F=c.id||`name:${c.name||""}`,l=h._employeesMap,w=l.get(F);if(!w)l.set(F,{...c,schedules:Array.isArray(c.schedules)?[...c.schedules]:[]});else if(Array.isArray(c.schedules)&&c.schedules.length){const D=Array.isArray(w.schedules)?w.schedules:[];w.schedules=D.concat(c.schedules)}})});const C=Array.from(r.values()).map(b=>{const{_employeesMap:V,...h}=b;return{...h,employees:Array.from(V.values())}});return{...a,subDepartments:C}}):[];return{...e,departments:s}}):[]}async function B(){if(!H.value||!k.value)return;const t=++j;S.value=!0,R.value="";try{const e=new URLSearchParams({month:k.value});g.value&&e.set("organization",g.value),v.value&&e.set("department",v.value),f.value&&e.set("subDepartment",f.value);const s=await O(`/api/schedules/overview?${e.toString()}`),a=await Y(s,"無法載入班表總覽資料");if(t!==j)return;const r=Array.isArray(a==null?void 0:a.days)?a.days:[],i=Array.isArray(a==null?void 0:a.organizations)?a.organizations:[];U.value=r,L.value=ue(i)}catch(e){if(t!==j)return;const s=(e==null?void 0:e.message)||"載入班表總覽失敗";R.value=s,L.value=[],U.value=[],q.error(s)}finally{t===j&&(S.value=!1)}}function Z(){B()}function ce(){Q.value.some(t=>_(t._id)===v.value)||(v.value=""),f.value="",B()}function de(){W.value.some(t=>_(t._id)===f.value)||(f.value=""),B()}function G(t,e){if(!e)return"";const s=t.value.find(a=>_(a._id||a.id)===e);return(s==null?void 0:s.name)||""}function me(t){const e=t==="pdf"?"pdf":"xlsx",s=G(T,g.value)||"全部機構",a=G(E,v.value)||"全部部門",r=G(K,f.value)||"全部小單位";return`班表總覽_${k.value}_${s}_${a}_${r}.${e}`}async function ee(t){if(!k.value){q.error("請先選擇月份");return}$.value=!0,N.value=t;try{const e=new URLSearchParams({month:k.value});g.value&&e.set("organization",g.value),v.value&&e.set("department",v.value),f.value&&e.set("subDepartment",f.value),e.set("format",t);const s=await O(`/api/schedules/overview/export?${e.toString()}`),a=await oe(s,"匯出失敗"),r=URL.createObjectURL(a),i=document.createElement("a");i.href=r,i.download=me(t),i.click(),URL.revokeObjectURL(r)}catch(e){const s=(e==null?void 0:e.message)||"匯出失敗";q.error(s)}finally{$.value=!1,N.value=""}}return ve(async()=>{await ie(),await B()}),(t,e)=>{const s=p("el-button"),a=p("el-button-group"),r=p("el-date-picker"),i=p("el-option"),C=p("el-select"),b=p("el-card"),V=p("el-alert"),h=p("el-skeleton"),te=p("el-empty"),c=p("el-table-column"),F=p("el-table");return o(),d("div",be,[e[13]||(e[13]=n("div",{class:"page-header"},[n("h1",{class:"page-title"},"班表總覽"),n("p",{class:"page-subtitle"},"依照機構、部門與小單位快速檢視每月排班狀態")],-1)),y(b,{class:"filters-card",shadow:"never"},{header:m(()=>[n("div",ye,[e[8]||(e[8]=n("div",{class:"filters-title"},"篩選條件",-1)),n("div",ge,[y(a,null,{default:m(()=>[y(s,{type:"primary",plain:"","data-test":"export-excel",loading:$.value&&N.value==="excel",disabled:X.value,onClick:e[0]||(e[0]=l=>ee("excel"))},{default:m(()=>e[6]||(e[6]=[J(" 匯出 Excel ")])),_:1},8,["loading","disabled"]),y(s,{type:"primary",plain:"","data-test":"export-pdf",loading:$.value&&N.value==="pdf",disabled:X.value,onClick:e[1]||(e[1]=l=>ee("pdf"))},{default:m(()=>e[7]||(e[7]=[J(" 匯出 PDF ")])),_:1},8,["loading","disabled"])]),_:1})])])]),default:m(()=>[n("div",he,[n("div",we,[e[9]||(e[9]=n("label",{class:"filter-label"},"月份",-1)),y(r,{modelValue:k.value,"onUpdate:modelValue":e[2]||(e[2]=l=>k.value=l),type:"month","value-format":"YYYY-MM",placeholder:"選擇月份",class:"filter-control",onChange:Z},null,8,["modelValue"])]),n("div",ke,[e[10]||(e[10]=n("label",{class:"filter-label"},"機構",-1)),y(C,{modelValue:g.value,"onUpdate:modelValue":e[3]||(e[3]=l=>g.value=l),placeholder:"全部機構",clearable:"",class:"filter-control",onChange:ce},{default:m(()=>[(o(!0),d(z,null,M(T.value,l=>(o(),A(i,{key:l._id||l.id,label:l.name,value:_(l._id||l.id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),n("div",De,[e[11]||(e[11]=n("label",{class:"filter-label"},"部門",-1)),y(C,{modelValue:v.value,"onUpdate:modelValue":e[4]||(e[4]=l=>v.value=l),placeholder:"全部部門",clearable:"",class:"filter-control",onChange:de},{default:m(()=>[(o(!0),d(z,null,M(Q.value,l=>(o(),A(i,{key:l._id,label:l.name,value:_(l._id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),n("div",Ae,[e[12]||(e[12]=n("label",{class:"filter-label"},"小單位",-1)),y(C,{modelValue:f.value,"onUpdate:modelValue":e[5]||(e[5]=l=>f.value=l),placeholder:"全部小單位",clearable:"",class:"filter-control",onChange:Z},{default:m(()=>[(o(!0),d(z,null,M(W.value,l=>(o(),A(i,{key:l._id,label:l.name,value:_(l._id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])]),_:1}),R.value?(o(),A(V,{key:0,type:"error",closable:!1,"show-icon":"",class:"message-block"},{default:m(()=>[J(x(R.value),1)]),_:1})):fe("",!0),S.value?(o(),A(h,{key:1,animated:"",rows:4,class:"overview-skeleton"})):le.value?(o(),d("div",xe,[(o(!0),d(z,null,M(L.value,l=>(o(),d("section",{key:l.id,class:"organization-block","data-test":"organization-block"},[n("header",ze,[n("h2",Me,x(l.name),1),n("span",Ve,x(l.departments.length)+" 個部門",1)]),(o(!0),d(z,null,M(l.departments,w=>(o(),d("article",{key:w.id,class:"department-block","data-test":"department-block"},[n("header",Ee,[n("h3",Re,x(w.name),1),n("span",$e,x(w.subDepartments.length)+" 個小單位",1)]),(o(!0),d(z,null,M(w.subDepartments,D=>(o(),d("div",{key:D.id,class:"unit-card","data-test":"subdepartment-block"},[n("div",Ce,[n("h4",Oe,x(D.name),1),n("span",Se,x(D.employees.length)+" 位人員",1)]),n("div",Ue,[(o(),A(F,{data:re(D),border:"",stripe:"",class:"overview-table",key:`${D.id}-table`},{default:m(()=>[y(c,{prop:"name",label:"姓名",fixed:"left","min-width":"140"}),y(c,{prop:"title",label:"職稱","min-width":"140"}),(o(!0),d(z,null,M(U.value,P=>(o(),A(c,{key:`${D.id}-${P}`,label:ne(P),"min-width":110},{default:m(({row:ae})=>[n("span",{class:_e(["shift-label",{empty:!ae.entries[P]}])},x(ae.entries[P]||"—"),3)]),_:2},1032,["label"]))),128))]),_:2},1032,["data"]))])]))),128))]))),128))]))),128))])):(o(),A(te,{key:2,description:"目前沒有符合條件的班表資料",class:"empty-state"}))])}}},Be=pe(Le,[["__scopeId","data-v-d92bb2cb"]]);export{Be as default};
