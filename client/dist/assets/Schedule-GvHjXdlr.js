import{B as Oe,r as b,p as Ue,_ as fe,x as z,C as Me,D as he,G as _e,c as h,o as c,F as D,l as R,e as I,k as S,w as v,b as d,H as X,I as Te,t as g,J as F,j as Le,d as m,y as P,a as Ne,E as L,u as Re,g as N,h as ve,n as Ae,z as Q}from"./index-C25OXyZh.js";import{a as w}from"./api-C2nzzaKe.js";const Fe=Oe("auth",()=>{const O=b("employee");function y(){const o=Ue();if(o)try{const x=JSON.parse(atob(o.split(".")[1]));O.value=x.role||"employee"}catch{O.value="employee"}else O.value="employee"}return{role:O,loadUser:y}}),Pe={class:"dashboard"},ze={class:"metric-label"},Be={class:"metric-value"},Je={__name:"ScheduleDashboard",props:{summary:{type:Object,default:()=>({direct:0,unscheduled:0,onLeave:0})}},setup(O){const y=O,o=z(()=>[{label:"直屬員工數",value:y.summary.direct,icon:Me,color:"#0f766e"},{label:"未排班員工",value:y.summary.unscheduled,icon:he,color:"#dc2626"},{label:"請假中員工",value:y.summary.onLeave,icon:_e,color:"#f59e0b"}]);return(x,C)=>{const A=I("el-card");return c(),h("div",Pe,[(c(!0),h(D,null,R(o.value,k=>(c(),S(A,{class:"metric-card",key:k.label},{default:v(()=>[(c(),S(X(k.icon),{class:"metric-icon",style:Te({color:k.color})},null,8,["style"])),d("div",ze,g(k.label),1),d("div",Be,g(k.value),1)]),_:2},1024))),128))])}}},Ye=fe(Je,[["__scopeId","data-v-d84f556d"]]),We={class:"schedule-page"},Ge={class:"filters-card"},He={class:"filters-content"},qe={class:"filter-group"},Ke={class:"filter-group"},Qe={class:"filter-group"},Xe={class:"actions-card"},Ze={class:"primary-actions"},et={class:"secondary-actions"},tt={class:"schedule-card"},at={class:"schedule-header"},lt={class:"employee-info"},st={class:"department-name"},nt={key:0,class:"sub-department"},ot={class:"employee-name"},dt={class:"department-selects"},rt={key:0,class:"leave-indicator"},it={class:"shift-details"},ut={class:"detail-row"},ct={class:"detail-value"},pt={class:"detail-row"},mt={class:"detail-value"},vt={key:0,class:"detail-row"},ft={class:"detail-value"},ht={class:"modern-shift-tag"},_t={key:2,class:"missing-label"},yt={key:1,class:"empty-cell"},bt={key:1,class:"modern-schedule-cell collapsed-cell"},gt={key:0,class:"approval-card"},kt={class:"approval-header"},wt={class:"approval-count"},St={class:"applicant-name"},Dt={class:"form-type"},It={__name:"Schedule",setup(O){const y=b(F().format("YYYY-MM")),o=b({}),x=b([]),C=b([]),A=b([]),k=b([]),U=b([]),V=b(""),$=b(""),Z=b({direct:0,unscheduled:0,onLeave:0}),B=b(""),J=b("all"),Y=b(new Set),q=a=>{const e=o.value[a]||{},i=Object.values(e),r=i.some(l=>l.shiftId),s=i.some(l=>l.leave);return r?s?"onLeave":"scheduled":"unscheduled"},ye=z(()=>{let a=B.value?C.value.filter(e=>e.name.includes(B.value)):C.value;return J.value!=="all"&&(a=a.filter(e=>q(e._id)===J.value)),a}),ee=z(()=>C.value.length>50),be=a=>{Y.value.has(a)?Y.value.delete(a):Y.value.add(a)},ge=z(()=>U.value.filter(a=>a.department===V.value)),ke=Re(),te=Fe();te.loadUser();const we=z(()=>["supervisor","admin"].includes(te.role)),K=z(()=>{const a=F(y.value+"-01"),e=a.endOf("month").date(),i=["日","一","二","三","四","五","六"];return Array.from({length:e},(r,s)=>{const l=s+1,n=i[a.date(l).day()];return{date:l,label:`${l}(${n})`}})});async function Se(){const a=await w("/api/attendance-settings");if(a.ok){const e=await a.json(),i=Array.isArray(e==null?void 0:e.shifts)?e.shifts:e;Array.isArray(i)&&(x.value=i.map(r=>({_id:r._id,code:r.code,startTime:r.startTime,endTime:r.endTime,remark:r.remark})))}else a.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",a.status)}async function ae(a=""){try{const e=a?`/api/sub-departments?department=${a}`:"/api/sub-departments",i=await w(e);if(!i.ok)throw new Error("Failed to fetch sub departments");const r=await i.json(),s=k.value.reduce((l,n)=>(l[n._id]=n._id,l[n.name]=n._id,l),{});U.value=Array.isArray(r)?r.map(l=>{let n="";return l&&typeof l.department=="object"?n=l.department._id||s[l.department.name]||"":n=s[l.department]||l.department||"",{...l,_id:String(l._id),department:String(n)}}):[],U.value.length&&!$.value&&($.value=U.value[0]._id)}catch(e){console.error(e),U.value=[],$.value=""}}async function De(){try{const a=await w("/api/departments");k.value=a.ok?await a.json():[],await ae(V.value)}catch(a){console.error(a)}}async function W(){const a=localStorage.getItem("employeeId"),e=a&&a!=="undefined"?`&supervisor=${a}`:"";try{const i=await w(`/api/schedules/monthly?month=${y.value}${e}`);if(!i.ok)throw new Error("Failed to fetch schedules");const r=await i.json();console.log("Schedules:",r);const s=K.value;o.value={},C.value.length||await H(V.value,$.value),C.value.forEach(n=>{o.value[n._id]={},s.forEach(p=>{o.value[n._id][p.date]={shiftId:"",department:n.departmentId,subDepartment:n.subDepartmentId}})}),r.forEach(n=>{var f;const p=((f=n.employee)==null?void 0:f._id)||n.employee,E=F(n.date).date(),j=C.value.find(t=>t._id===p)||{};o.value[p][E]={id:n._id,shiftId:n.shiftId,department:n.department||j.departmentId,subDepartment:n.subDepartment||j.subDepartmentId}});const l=await w(`/api/schedules/leave-approvals?month=${y.value}${e}`);if(l.ok){const n=await l.json();A.value=n.approvals||[],(n.leaves||[]).forEach(p=>{var t,u;if(p.status!=="approved")return;const E=((t=p.employee)==null?void 0:t._id)||p.employee,j=F(p.startDate).date(),f=F(p.endDate).date();for(let T=j;T<=f;T++)(u=o.value[E])!=null&&u[T]&&(o.value[E][T].leave={type:p.leaveType})})}}catch(i){console.error(i),L.error("取得排班資料失敗")}}async function Ie(){if(Object.values(o.value).some(i=>Object.values(i).some(r=>!r.shiftId&&!r.leave))){L.warning("尚有未排班項目，請確認後再儲存");return}const e=[];if(Object.keys(o.value).forEach(i=>{Object.keys(o.value[i]).forEach(r=>{const s=o.value[i][r];s.shiftId&&!s.id&&e.push({employee:i,date:`${y.value}-${String(r).padStart(2,"0")}`,shiftId:s.shiftId,department:s.department,subDepartment:s.subDepartment})})}),!!e.length)try{const i=await w("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:e})});if(!i.ok)throw new Error("save failed");(await i.json()).forEach(s=>{var p;const l=((p=s.employee)==null?void 0:p._id)||s.employee,n=F(s.date).date();o.value[l]||(o.value[l]={}),o.value[l][n]={id:s._id,shiftId:s.shiftId}}),L.success("儲存完成")}catch{L.error("儲存失敗")}}function le(a){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:o.value,employees:C.value,days:K.value,shifts:x.value})),ke.push({name:a==="week"?"PreviewWeek":"PreviewMonth"})}async function se(a){try{const e=await w(`/api/schedules/export?month=${y.value}&format=${a}`);if(!e.ok)throw new Error;const i=await e.blob(),r=URL.createObjectURL(i),s=document.createElement("a");s.href=r,s.download=`schedules-${y.value}.${a==="excel"?"xlsx":"pdf"}`,s.click(),URL.revokeObjectURL(r)}catch{L.error("匯出失敗")}}async function Ce(a,e,i){const r=`${y.value}-${String(e).padStart(2,"0")}`,s=o.value[a][e],l=s.shiftId;if(s&&s.id)try{const n=await w(`/api/schedules/${s.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:i,department:s.department,subDepartment:s.subDepartment})});n.ok||await G(n,"更新排班失敗",a,e,l)}catch{await G(null,"更新排班失敗",a,e,l)}else try{const n=await w("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:a,date:r,shiftId:i,department:s.department,subDepartment:s.subDepartment})});if(n.ok){const p=await n.json();o.value[a][e]={id:p._id,shiftId:p.shiftId,department:s.department,subDepartment:s.subDepartment}}else await G(n,"新增排班失敗",a,e,l)}catch{await G(null,"新增排班失敗",a,e,l)}}async function Ve(){$.value="",await ae(V.value),await H(V.value,""),await W()}async function $e(){await H(V.value,$.value),await W()}async function G(a,e,i,r,s){o.value[i][r].shiftId=s;let l="";try{if(a){const n=await a.json();l=(n==null?void 0:n.error)||""}}catch{}l==="employee conflict"?Q.alert("人員衝突"):l==="department overlap"?Q.alert("跨區重複"):l==="leave conflict"?Q.alert("請假衝突"):L.error(e)}function M(a){return x.value.find(e=>e._id===a)}function je(a){const e=M(a);return e?/早/.test(e.code)?"shift-morning":/晚|夜/.test(e.code)?"shift-evening":"shift-normal":""}function xe(a){return U.value.filter(e=>e.department===a)}async function H(a="",e=""){const i=localStorage.getItem("employeeId"),r=[];i&&i!=="undefined"&&r.push(`supervisor=${i}`),a&&r.push(`department=${a}`),e&&r.push(`subDepartment=${e}`);const s=`/api/employees${r.length?`?${r.join("&")}`:""}`;try{const l=await w(s);if(!l.ok)throw new Error("Failed to fetch employees");const n=await l.json(),p=k.value.reduce((f,t)=>(f[t._id]=t.name,f),{}),E=U.value.reduce((f,t)=>(f[t._id]=t.name,f),{}),j=n.map(f=>({_id:f._id,name:f.name,departmentId:f.department,subDepartmentId:f.subDepartment,department:p[f.department]||"",subDepartment:E[f.subDepartment]||""})).sort((f,t)=>f.department.localeCompare(t.department));C.value=j}catch(l){console.error(l),L.error("取得員工資料失敗")}}async function ne(){try{const a=await w(`/api/schedules/summary?month=${y.value}`);if(a.ok){const e=await a.json();Z.value={direct:e.length,unscheduled:e.filter(i=>i.shiftCount===0).length,onLeave:e.filter(i=>i.leaveCount>0).length}}}catch(a){console.error(a)}}async function Ee(){await W(),await ne()}return Le(async()=>{await ne(),await Se(),await De(),await H(V.value,$.value),await W()}),(a,e)=>{const i=I("el-date-picker"),r=I("el-option"),s=I("el-select"),l=I("el-button"),n=I("el-input"),p=I("el-table-column"),E=I("el-popover"),j=I("el-table"),f=I("el-tag");return c(),h("div",We,[e[24]||(e[24]=d("div",{class:"page-header"},[d("h1",{class:"page-title"},"排班管理"),d("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),m(Ye,{summary:Z.value},null,8,["summary"]),d("div",Ge,[e[13]||(e[13]=d("div",{class:"filters-header"},[d("h3",{class:"filters-title"},"篩選條件")],-1)),d("div",He,[d("div",qe,[e[10]||(e[10]=d("label",{class:"filter-label"},"選擇月份",-1)),m(i,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=t=>y.value=t),type:"month",onChange:Ee,class:"modern-date-picker"},null,8,["modelValue"])]),d("div",Ke,[e[11]||(e[11]=d("label",{class:"filter-label"},"部門",-1)),m(s,{modelValue:V.value,"onUpdate:modelValue":e[1]||(e[1]=t=>V.value=t),placeholder:"請選擇部門",onChange:Ve,class:"modern-select"},{default:v(()=>[(c(!0),h(D,null,R(k.value,t=>(c(),S(r,{key:t._id,label:t.name,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),d("div",Qe,[e[12]||(e[12]=d("label",{class:"filter-label"},"單位",-1)),m(s,{modelValue:$.value,"onUpdate:modelValue":e[2]||(e[2]=t=>$.value=t),placeholder:"請選擇單位",onChange:$e,class:"modern-select"},{default:v(()=>[(c(!0),h(D,null,R(ge.value,t=>(c(),S(r,{key:t._id,label:t.name,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])]),d("div",Xe,[d("div",Ze,[m(l,{type:"primary",onClick:Ie,class:"action-btn primary"},{default:v(()=>e[14]||(e[14]=[d("i",{class:"el-icon-check"},null,-1),N(" 儲存排班 ")])),_:1})]),d("div",et,[m(l,{onClick:e[3]||(e[3]=t=>le("week")),class:"action-btn secondary"},{default:v(()=>e[15]||(e[15]=[d("i",{class:"el-icon-calendar"},null,-1),N(" 預覽週表 ")])),_:1}),m(l,{onClick:e[4]||(e[4]=t=>le("month")),class:"action-btn secondary"},{default:v(()=>e[16]||(e[16]=[d("i",{class:"el-icon-date"},null,-1),N(" 預覽月表 ")])),_:1}),m(l,{onClick:e[5]||(e[5]=()=>se("pdf")),class:"action-btn export"},{default:v(()=>e[17]||(e[17]=[d("i",{class:"el-icon-download"},null,-1),N(" 匯出 PDF ")])),_:1}),m(l,{onClick:e[6]||(e[6]=()=>se("excel")),class:"action-btn export"},{default:v(()=>e[18]||(e[18]=[d("i",{class:"el-icon-s-grid"},null,-1),N(" 匯出 Excel ")])),_:1})])]),d("div",tt,[d("div",at,[e[19]||(e[19]=Ne('<h3 class="schedule-title" data-v-f4ec2620>員工排班表</h3><div class="schedule-legend" data-v-f4ec2620><span class="legend-item morning" data-v-f4ec2620>早班</span><span class="legend-item evening" data-v-f4ec2620>晚班</span><span class="legend-item normal" data-v-f4ec2620>正常班</span><span class="legend-item leave" data-v-f4ec2620>請假</span></div>',2)),m(n,{modelValue:B.value,"onUpdate:modelValue":e[7]||(e[7]=t=>B.value=t),placeholder:"搜尋員工",clearable:"",class:"employee-search"},null,8,["modelValue"]),m(s,{modelValue:J.value,"onUpdate:modelValue":e[8]||(e[8]=t=>J.value=t),placeholder:"狀態",class:"status-filter"},{default:v(()=>[m(r,{label:"全部",value:"all"}),m(r,{label:"缺班",value:"unscheduled"}),m(r,{label:"待審核請假",value:"onLeave"})]),_:1},8,["modelValue"])]),m(j,{class:"modern-schedule-table",data:ye.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"},onRowClick:e[9]||(e[9]=t=>ee.value&&be(t._id))},{default:v(()=>[m(p,{label:"部門／單位",width:"180",fixed:"left"},{default:v(({row:t})=>[d("div",lt,[d("div",st,g(t.department),1),t.subDepartment?(c(),h("div",nt,g(t.subDepartment),1)):P("",!0)])]),_:1}),m(p,{prop:"name",label:"員工姓名",width:"120",fixed:"left"},{default:v(({row:t})=>[d("div",ot,[q(t._id)==="unscheduled"?(c(),S(X(ve(he)),{key:0,class:"status-icon unscheduled"})):q(t._id)==="onLeave"?(c(),S(X(ve(_e)),{key:1,class:"status-icon on-leave"})):P("",!0),N(" "+g(t.name),1)])]),_:1}),(c(!0),h(D,null,R(K.value,t=>(c(),S(p,{key:t.date,label:t.label,width:"140",align:"center"},{default:v(({row:u})=>{var T,oe,de,re,ie,ue,ce,pe,me;return[!ee.value||Y.value.has(u._id)?(c(),h("div",{key:0,class:Ae(["modern-schedule-cell",[je((oe=(T=o.value[u._id])==null?void 0:T[t.date])==null?void 0:oe.shiftId),{"has-leave":(re=(de=o.value[u._id])==null?void 0:de[t.date])==null?void 0:re.leave,"missing-shift":!((ue=(ie=o.value[u._id])==null?void 0:ie[t.date])!=null&&ue.shiftId)&&!((pe=(ce=o.value[u._id])==null?void 0:ce[t.date])!=null&&pe.leave)}]])},[(me=o.value[u._id])!=null&&me[t.date]?(c(),h(D,{key:0},[we.value?(c(),h(D,{key:0},[m(s,{modelValue:o.value[u._id][t.date].shiftId,"onUpdate:modelValue":_=>o.value[u._id][t.date].shiftId=_,placeholder:"選擇班別",onChange:_=>Ce(u._id,t.date,_),class:"cell-select shift-select",size:"small"},{default:v(()=>[(c(!0),h(D,null,R(x.value,_=>(c(),S(r,{key:_._id,label:_.code,value:_._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),d("div",dt,[m(s,{modelValue:o.value[u._id][t.date].department,"onUpdate:modelValue":_=>o.value[u._id][t.date].department=_,placeholder:"部門",size:"small",onChange:()=>o.value[u._id][t.date].subDepartment="",class:"cell-select dept-select"},{default:v(()=>[(c(!0),h(D,null,R(k.value,_=>(c(),S(r,{key:_._id,label:_.name,value:_._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),m(s,{modelValue:o.value[u._id][t.date].subDepartment,"onUpdate:modelValue":_=>o.value[u._id][t.date].subDepartment=_,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:v(()=>[(c(!0),h(D,null,R(xe(o.value[u._id][t.date].department),_=>(c(),S(r,{key:_._id,label:_.name,value:_._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(c(),h(D,{key:1},[o.value[u._id][t.date].leave?(c(),h("div",rt," 請假中 ")):M(o.value[u._id][t.date].shiftId)?(c(),S(E,{key:1,placement:"top",trigger:"hover",width:200},{reference:v(()=>[d("div",ht,g(M(o.value[u._id][t.date].shiftId).code),1)]),default:v(()=>[d("div",it,[d("div",ut,[e[20]||(e[20]=d("span",{class:"detail-label"},"上班時間：",-1)),d("span",ct,g(M(o.value[u._id][t.date].shiftId).startTime),1)]),d("div",pt,[e[21]||(e[21]=d("span",{class:"detail-label"},"下班時間：",-1)),d("span",mt,g(M(o.value[u._id][t.date].shiftId).endTime),1)]),M(o.value[u._id][t.date].shiftId).remark?(c(),h("div",vt,[e[22]||(e[22]=d("span",{class:"detail-label"},"備註：",-1)),d("span",ft,g(M(o.value[u._id][t.date].shiftId).remark),1)])):P("",!0)])]),_:2},1024)):P("",!0)],64)),!o.value[u._id][t.date].shiftId&&!o.value[u._id][t.date].leave?(c(),h("div",_t," 未排班 ")):P("",!0)],64)):(c(),h("span",yt,"-"))],2)):(c(),h("div",bt,"展開班表"))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])]),A.value.length?(c(),h("div",gt,[d("div",kt,[e[23]||(e[23]=d("h3",{class:"approval-title"},"待處理審批",-1)),d("div",wt,g(A.value.length)+" 項待處理",1)]),m(j,{class:"modern-approval-table",data:A.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:v(()=>[m(p,{label:"申請人",width:"120"},{default:v(({row:t})=>{var u;return[d("div",St,g((u=t.applicant_employee)==null?void 0:u.name),1)]}),_:1}),m(p,{label:"申請類型",width:"150"},{default:v(({row:t})=>{var u;return[d("div",Dt,g(((u=t.form)==null?void 0:u.name)||"未知類型"),1)]}),_:1}),m(p,{prop:"status",label:"狀態",width:"100"},{default:v(({row:t})=>[m(f,{type:t.status==="approved"?"success":t.status==="rejected"?"danger":"warning",class:"status-tag"},{default:v(()=>[N(g(t.status),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])):P("",!0)])}}},$t=fe(It,[["__scopeId","data-v-f4ec2620"]]);export{$t as default};
