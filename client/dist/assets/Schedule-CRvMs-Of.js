import{A as kt,r as _,q as Dt,_ as Ye,v as U,C as Ct,D as He,G as qe,c as b,o as m,F as x,m as R,e as O,l as C,w as h,b as p,H as Me,I as It,t as E,J as N,k as Ie,j as Vt,d as f,x as z,a as Et,h as se,E as T,u as $t,g as M,n as At,f as jt,z as pe,K as xt}from"./index-Bzhab6Am.js";import{a as j}from"./api-2KlvJGqf.js";const Ut=kt("auth",()=>{const X=_("employee");function S(){const c=Dt();if(c)try{const F=JSON.parse(atob(c.split(".")[1]));X.value=F.role||"employee"}catch{X.value="employee"}else X.value="employee"}return{role:X,loadUser:S}}),Mt={class:"dashboard"},Ot={class:"metric-label"},Lt={class:"metric-value"},Nt=Object.assign({name:"ScheduleDashboard"},{__name:"ScheduleDashboard",props:{summary:{type:Object,default:()=>({direct:0,unscheduled:0,onLeave:0})}},setup(X){const S=X,c=U(()=>[{label:"直屬員工數",value:S.summary.direct,icon:Ct,color:"#0f766e"},{label:"未排班員工",value:S.summary.unscheduled,icon:He,color:"#dc2626"},{label:"請假中員工",value:S.summary.onLeave,icon:qe,color:"#f59e0b"}]);return(F,V)=>{const ne=O("el-card");return m(),b("div",Mt,[(m(!0),b(x,null,R(c.value,k=>(m(),C(ne,{class:"metric-card",key:k.label},{default:h(()=>[(m(),C(Me(k.icon),{class:"metric-icon",style:It({color:k.color})},null,8,["style"])),p("div",Ot,E(k.label),1),p("div",Lt,E(k.value),1)]),_:2},1024))),128))])}}}),zt=Ye(Nt,[["__scopeId","data-v-ceb5c889"]]),Tt={class:"schedule-page"},Rt={class:"filters-card"},Ft={class:"filters-content"},Bt={class:"filter-group"},Pt={class:"filter-group"},Jt={class:"filter-group"},Wt={class:"actions-card"},Kt={class:"primary-actions"},Yt={class:"secondary-actions"},Ht={class:"range-picker-wrapper"},qt={class:"schedule-card"},Gt={class:"schedule-header"},Qt={key:0,class:"batch-toolbar"},Xt={class:"employee-info"},Zt={class:"department-name"},ea={key:0,class:"sub-department"},ta={class:"employee-name"},aa={class:"day-header"},la=["title"],sa={key:0,class:"leave-indicator","data-test":"leave-indicator"},na={class:"department-selects"},oa={class:"shift-details"},ra={class:"detail-row"},ia={class:"detail-value"},ua={class:"detail-row"},da={class:"detail-value"},ca={key:0,class:"detail-row"},va={class:"detail-value"},pa={class:"modern-shift-tag"},ma={key:3,class:"missing-label"},fa={key:2,class:"empty-cell"},ha={key:1,class:"modern-schedule-cell collapsed-cell"},ya={key:0,class:"approval-card"},_a={class:"approval-header"},ba={class:"approval-count"},ga={class:"applicant-name"},Sa={class:"form-type"},wa={__name:"Schedule",setup(X){const S=_(N().format("YYYY-MM")),c=_({}),F=_([]),V=_([]),ne=_([]),k=_([]),B=_([]),D=_(""),I=_(""),$=_(""),P=_(""),w=_(""),me=_(""),H=_([]),Oe=_({direct:0,unscheduled:0,onLeave:0}),fe=_(""),he=_("all"),ye=_(new Set),q=_(new Set),J=_(new Set),Z=_(new Set),Ve=_([]),oe=_(""),G=_(""),W=_(""),_e=_(!1),Ge=U(()=>q.value),Qe=U(()=>J.value),Xe=U(()=>Z.value),ee=(a,e)=>`${a}-${e}`,Ee=a=>{const[e,l]=String(a).split("-");return{empId:e,day:Number(l)}},be=(a,e)=>{const l=c.value[a];if(!l)return!1;const s=l[e];return s?!s.leave:!1},$e=U(()=>{const a=new Set,e=K.value,l=V.value,s=(n,r)=>{be(n,r)&&a.add(ee(n,r))};return Z.value.forEach(n=>{const{empId:r,day:v}=Ee(n);s(r,v)}),q.value.forEach(n=>{e.forEach(r=>s(n,r.date))}),J.value.forEach(n=>{l.forEach(r=>s(r._id,n))}),a}),Ae=U(()=>$e.value.size>0),Le=U(()=>G.value?Je(G.value):[]),Ze=(a,e)=>$e.value.has(ee(a,e)),ge=()=>{const a=new Set(V.value.map(s=>s._id)),e=new Set(K.value.map(s=>s.date));q.value=new Set(Array.from(q.value).filter(s=>a.has(s))),J.value=new Set(Array.from(J.value).filter(s=>e.has(s)));const l=new Set;Z.value.forEach(s=>{const{empId:n,day:r}=Ee(s);a.has(n)&&e.has(r)&&be(n,r)&&l.add(ee(n,r))}),Z.value=l},et=()=>{q.value=new Set,J.value=new Set,Z.value=new Set,Ve.value=[]},tt=(a,e)=>{const l=new Set(q.value);(typeof e=="boolean"?e:!l.has(a))?l.add(a):l.delete(a),q.value=l},at=(a,e)=>{const l=new Set(J.value);(typeof e=="boolean"?e:!l.has(a))?l.add(a):l.delete(a),J.value=l},lt=(a,e,l)=>{if(!be(a,e))return;const s=ee(a,e),n=new Set(Z.value);(typeof l=="boolean"?l:!n.has(s))?n.add(s):n.delete(s),Z.value=n},st=()=>{q.value=new Set(V.value.map(a=>a._id))},nt=()=>{J.value=new Set(K.value.map(a=>a.date))},ot=a=>{if(!Array.isArray(a)||a.length!==2)return;const[e,l]=a;if(!e||!l)return;const s=N(`${S.value}-01`),n=N(e),r=N(l);if(!n.isValid()||!r.isValid())return;const v=s.endOf("month");let o=n.isBefore(s)?s:n;const i=[];for(;(o.isBefore(r)||o.isSame(r,"day"))&&(o.year()===s.year()&&o.month()===s.month()&&i.push(o.date()),!o.isSame(v,"day"));)o=o.add(1,"day");J.value=new Set(i)};Ie(G,(a,e)=>{a!==e&&(W.value="")}),Ie(Le,a=>{W.value&&!a.some(e=>e._id===W.value)&&(W.value="")});const je=a=>{const e=c.value[a]||{},l=Object.values(e),s=l.some(r=>r.shiftId),n=l.some(r=>r.leave);return s?n?"onLeave":"scheduled":"unscheduled"},rt=U(()=>{let a=fe.value?V.value.filter(e=>e.name.includes(fe.value)):V.value;return he.value!=="all"&&(a=a.filter(e=>je(e._id)===he.value)),a}),Ne=U(()=>V.value.length>50),it=a=>{ye.value.has(a)?ye.value.delete(a):ye.value.add(a)},ut=U(()=>B.value.filter(a=>a.department===D.value)),dt=$t(),re=Ut();re.loadUser();const ze=U(()=>["supervisor","admin"].includes(re.role)),ie=ze,Te=a=>{var s,n;const e=(s=T)==null?void 0:s.warning;typeof e=="function"&&e(a);const l=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.warning:void 0;typeof l=="function"&&l!==e&&l(a)},xe=a=>{var s,n;const e=(s=T)==null?void 0:s.info;typeof e=="function"&&e(a);const l=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.info:void 0;typeof l=="function"&&l!==e&&l(a)},ct=a=>{var s,n;const e=(s=T)==null?void 0:s.success;typeof e=="function"&&e(a);const l=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.success:void 0;typeof l=="function"&&l!==e&&l(a)},vt=(a,e)=>{var s,n;const l=(n=(s=c.value)==null?void 0:s[a])==null?void 0:n[e];return l!=null&&l.leave?"已核准請假，該日不列入工作時數":""},K=U(()=>{const a=N(S.value+"-01"),e=a.endOf("month").date(),l=["日","一","二","三","四","五","六"];return Array.from({length:e},(s,n)=>{const r=n+1,v=l[a.date(r).day()];return{date:r,label:`${r}(${v})`}})});Ie(V,ge),Ie(K,ge);async function pt(){const a=await j("/api/shifts");if(a.ok){const e=await a.json(),l=Array.isArray(e==null?void 0:e.shifts)?e.shifts:Array.isArray(e)?e:[];Array.isArray(l)&&(F.value=l.map(s=>({_id:s._id,code:s.code,name:s.name??"",startTime:s.startTime,endTime:s.endTime,remark:s.remark})))}else a.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",a.status)}async function Re(a=""){try{const e=a||$.value,l=e?`/api/sub-departments?department=${e}`:"/api/sub-departments",s=await j(l);if(!s.ok)throw new Error("Failed to fetch sub departments");const n=await s.json(),r=k.value.reduce((i,u)=>{const y=String(u._id);return i[y]=y,u.name&&(i[u.name]=y),i},{});$.value&&(r[$.value]=$.value),P.value&&(r[P.value]=$.value||P.value);const v=Array.isArray(n)?n.map(i=>{const u=i==null?void 0:i.department;let y="";return u&&typeof u=="object"?y=(u==null?void 0:u._id)||(u==null?void 0:u.id)||r[u==null?void 0:u.name]||"":y=r[u]||u||"",{...i,_id:String((i==null?void 0:i._id)??(i==null?void 0:i.id)??""),department:String(y)}}).filter(i=>i._id):[];let o=v;if(e&&(o=v.filter(i=>i.department===String(e)),!o.length&&w.value)){const i=v.find(u=>u._id===w.value);i?o=[i]:o=[{_id:w.value,name:me.value||"",department:String(e)}]}if(re.role==="supervisor"){const i=H.value.length?H.value:w.value?[w.value]:[],u=new Set(i.map(y=>String(y)));u.size?o=o.filter(y=>u.has(String(y._id))):o=[]}B.value=o,B.value.length?w.value&&B.value.some(i=>i._id===w.value)?I.value=w.value:I.value&&B.value.some(i=>i._id===I.value)||(I.value=B.value[0]._id):I.value=""}catch(e){console.error(e),B.value=[],I.value=""}}async function mt(){var a;try{const e=await j("/api/departments"),l=e.ok?await e.json():[],s=Array.isArray(l)?l.map(o=>{const i=(o==null?void 0:o._id)??(o==null?void 0:o.id)??(o==null?void 0:o.value)??"";return{...o,_id:String(i),name:(o==null?void 0:o.name)??""}}).filter(o=>o._id):[],n=D.value||$.value;let r=s;n&&(r=s.filter(o=>o._id===n||P.value&&o.name===P.value),!r.length&&n&&(r=[{_id:n,name:P.value||((a=s.find(o=>o._id===n))==null?void 0:a.name)||""}])),k.value=r.length?r:s,k.value.length?k.value.some(o=>o._id===D.value)||(D.value=k.value[0]._id):!D.value&&n&&(D.value=n);const v=D.value||$.value||(k.value.length?k.value[0]._id:"");await Re(v)}catch(e){console.error(e)}}const Se=()=>{var l,s;if(!ze.value||typeof window>"u")return"";const a=(l=window.sessionStorage)==null?void 0:l.getItem("employeeId");if(a&&a!=="undefined")return a;const e=(s=window.localStorage)==null?void 0:s.getItem("employeeId");return e&&e!=="undefined"?e:""};async function ft(){if(re.role!=="supervisor"){$.value="",P.value="",w.value="",me.value="",H.value=[];return}const a=Se();if(!a){$.value="",P.value="",w.value="",me.value="",H.value=[];return}let e=null;try{const i=await j(`/api/employees/${a}`);if(!i.ok)throw new Error("Failed to fetch supervisor context");e=await i.json()}catch(i){console.error(i)}const l=e==null?void 0:e.department,s=typeof l=="object"?(l==null?void 0:l._id)||(l==null?void 0:l.id)||(l==null?void 0:l.value):l,n=typeof l=="object"?(l==null?void 0:l.name)||"":(e==null?void 0:e.departmentName)||"";$.value=s?String(s):"",P.value=n?String(n):"",$.value?D.value=$.value:D.value="";const r=e==null?void 0:e.subDepartment,v=typeof r=="object"?(r==null?void 0:r._id)||(r==null?void 0:r.id)||(r==null?void 0:r.value):r,o=typeof r=="object"?(r==null?void 0:r.name)||"":(e==null?void 0:e.subDepartmentName)||"";w.value=v?String(v):"",me.value=o?String(o):"",w.value?I.value=w.value:I.value="",await ht(a)}async function ht(a=""){if(re.role!=="supervisor"){H.value=[];return}const e=a||Se();if(!e){H.value=w.value?[String(w.value)]:[];return}try{const l=await j(`/api/employees?supervisor=${e}`);if(!l.ok)throw new Error("Failed to fetch direct reports");const s=await l.json(),n=Array.isArray(s)?s:[],r=new Set,v=[],o=i=>{if(!i&&i!==0)return;const u=String(i);u&&(r.has(u)||(r.add(u),v.push(u)))};n.forEach(i=>{const u=i==null?void 0:i.subDepartment;o(u&&typeof u=="object"?(u==null?void 0:u._id)||(u==null?void 0:u.id)||(u==null?void 0:u.value):u)}),o(w.value),H.value=v}catch(l){console.error(l),H.value=w.value?[String(w.value)]:[]}}async function we(){const a=Se(),e=a?`&supervisor=${a}`:"";try{const l=await j(`/api/schedules/monthly?month=${S.value}${e}`);if(!l.ok)throw new Error("Failed to fetch schedules");const s=await l.json(),n=Array.isArray(s)?s:[],r=K.value;c.value={},!V.value.length&&n.length&&await De(D.value,I.value),V.value.forEach(o=>{const i=String(o._id);c.value[i]={},r.forEach(u=>{c.value[i][u.date]={shiftId:"",department:o.departmentId,subDepartment:o.subDepartmentId}})}),n.forEach(o=>{var t;const i=((t=o.employee)==null?void 0:t._id)||o.employee;if(!i)return;const u=String(i);c.value[u]||(c.value[u]={},r.forEach(d=>{c.value[u][d.date]={shiftId:"",department:"",subDepartment:""}}));const y=N(o.date).date(),A=V.value.find(d=>String(d._id)===u)||{};c.value[u][y]={id:o._id,shiftId:o.shiftId,department:o.department||A.departmentId,subDepartment:o.subDepartment||A.subDepartmentId}});const v=await j(`/api/schedules/leave-approvals?month=${S.value}${e}`);if(v.ok){const o=await v.json(),i=Array.isArray(o==null?void 0:o.approvals)?o.approvals:[],u=Array.isArray(o==null?void 0:o.leaves)?o.leaves:[];ne.value=i;const y=N(`${S.value}-01`).startOf("day"),A=y.endOf("month").startOf("day");u.forEach(t=>{var ue,de,ce;if(t.status!=="approved")return;const d=((ue=t.employee)==null?void 0:ue._id)||t.employee;if(!d)return;const ae=String(d),Y=N(t.startDate).startOf("day"),Q=N(t.endDate).startOf("day");if(!Y.isValid()||!Q.isValid())return;let L=Y.isBefore(y)?y:Y;const le=Q.isAfter(A)?A:Q;for(;!L.isAfter(le);){const Ce=L.date(),ve=(ce=(de=c.value)==null?void 0:de[ae])==null?void 0:ce[Ce];ve&&(ve.leave={type:t.leaveType,startDate:t.startDate,endDate:t.endDate,excludesHours:!0}),L=L.add(1,"day")}})}ge()}catch(l){console.error(l),T.error("取得排班資料失敗")}}function Fe(a){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:c.value,employees:V.value,days:K.value,shifts:F.value})),dt.push({name:a==="week"?"PreviewWeek":"PreviewMonth"})}async function Be(a){try{const e=await j(`/api/schedules/export?month=${S.value}&format=${a}`);if(!e.ok)throw new Error;const l=await e.blob(),s=URL.createObjectURL(l),n=document.createElement("a");n.href=s,n.download=`schedules-${S.value}.${a==="excel"?"xlsx":"pdf"}`,n.click(),URL.revokeObjectURL(s)}catch{T.error("匯出失敗")}}async function yt(a,e,l){const s=`${S.value}-${String(e).padStart(2,"0")}`,n=c.value[a][e];if(n!=null&&n.leave){xe("該日已核准請假，無法調整排班");return}const r=(n==null?void 0:n.shiftId)??"";if(n&&n.id)try{const v=await j(`/api/schedules/${n.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:l,department:n.department,subDepartment:n.subDepartment})});v.ok||await ke(v,"更新排班失敗",a,e,r)}catch{await ke(null,"更新排班失敗",a,e,r)}else try{const v=await j("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:a,date:s,shiftId:l,department:n.department,subDepartment:n.subDepartment})});if(v.ok){const o=await v.json();c.value[a][e]={id:o._id,shiftId:o.shiftId,department:n.department,subDepartment:n.subDepartment}}else await ke(v,"新增排班失敗",a,e,r)}catch{await ke(null,"新增排班失敗",a,e,r)}}async function _t(){I.value="",await Re(D.value),await De(D.value,""),await we()}async function bt(){await De(D.value,I.value),await we()}async function ke(a,e,l,s,n){c.value[l]||(c.value[l]={});const r=c.value[l][s]||{shiftId:"",department:"",subDepartment:""};r.shiftId=n,c.value[l][s]=r;let v="";try{if(a){const o=await a.json();v=(o==null?void 0:o.error)||""}}catch{}v==="employee conflict"?pe.alert("人員衝突"):v==="department overlap"?pe.alert("跨區重複"):v==="leave conflict"?pe.alert("請假衝突"):T.error(e)}async function Pe(a,e="批次套用失敗"){let l="";try{if(a){const s=await a.json();l=(s==null?void 0:s.error)||""}}catch{}l==="employee conflict"?T.warning("部分員工既有排班已更新，請重新整理檢查"):l==="department overlap"?pe.alert("部門或單位與既有資料不一致，無法套用"):l==="leave conflict"?pe.alert("選取日期包含已核准請假，無法套用"):l?T.error(l):T.error(e)}async function gt(){if(!Ae.value){Te("請先選取要套用的儲存格");return}if(!oe.value){Te("請選擇欲套用的班別");return}const a=[];if($e.value.forEach(s=>{var u;const{empId:n,day:r}=Ee(s),v=(u=c.value[n])==null?void 0:u[r];if(!v||v.leave)return;const o=G.value||v.department||"";let i=v.subDepartment||"";G.value?i=W.value||"":W.value&&(i=W.value),a.push({employee:n,day:r,date:`${S.value}-${String(r).padStart(2,"0")}`,shiftId:oe.value,department:o,subDepartment:i})}),!a.length){xe("選取的儲存格皆無需更新");return}const e=new Map;a.forEach(s=>{e.set(ee(s.employee,s.day),s)}),_e.value=!0;const l=xt.service({fullscreen:!0,lock:!0,text:"批次套用中..."});try{let s;try{s=await j("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:a.map(({day:r,...v})=>v)})})}catch{await Pe(null);return}if(!s.ok){await Pe(s);return}const n=await s.json();if(!Array.isArray(n)||!n.length){xe("沒有可更新的資料");return}n.forEach(r=>{var A;const v=((A=r.employee)==null?void 0:A._id)||r.employee,o=N(r.date).date();c.value[v]||(c.value[v]={});const i=ee(v,o),u=e.get(i)||{},y=c.value[v][o]||{};c.value[v][o]={...y,id:r._id||u.id||y.id,shiftId:r.shiftId||u.shiftId||y.shiftId,department:u.department??r.department??y.department??"",subDepartment:u.subDepartment??r.subDepartment??y.subDepartment??""},delete c.value[v][o].leave}),ct("批次套用完成")}finally{l==null||l.close(),_e.value=!1}}function te(a){return F.value.find(e=>e._id===a)}function Ue(a){if(!a)return"";const e=a.code??"",l=a.name??"";return!e&&!l?"":l?`${e}(${l})`:e}function St(a){const e=te(a);return e?/早/.test(e.code)?"shift-morning":/晚|夜/.test(e.code)?"shift-evening":"shift-normal":""}function Je(a){return B.value.filter(e=>e.department===a)}async function De(a="",e=""){const l=Se(),s=[],n=a||D.value||$.value,r=e||I.value;l&&s.push(`supervisor=${l}`),n&&s.push(`department=${n}`),r&&s.push(`subDepartment=${r}`);const v=`/api/employees${s.length?`?${s.join("&")}`:""}`;try{const o=await j(v);if(!o.ok)throw new Error("Failed to fetch employees");const i=await o.json(),u=k.value.reduce((t,d)=>(t[d._id]=d.name,t),{}),y=B.value.reduce((t,d)=>(t[d._id]=d.name,t),{}),A=i.map(t=>{const d=(t==null?void 0:t._id)??(t==null?void 0:t.id)??"",ae=(t==null?void 0:t.department)??"",Y=(t==null?void 0:t.subDepartment)??"",Q=d?String(d):"",L=ae?String(ae):"",le=Y?String(Y):"";return{_id:Q,name:t.name,departmentId:L,subDepartmentId:le,department:u[L]||"",subDepartment:y[le]||""}}).sort((t,d)=>t.department.localeCompare(d.department));V.value=A,ge()}catch(o){console.error(o),T.error("取得員工資料失敗")}}async function We(){try{const a=await j(`/api/schedules/summary?month=${S.value}`);if(a.ok){const e=await a.json();Oe.value={direct:e.length,unscheduled:e.filter(l=>l.shiftCount===0).length,onLeave:e.filter(l=>l.leaveCount>0).length}}}catch(a){console.error(a)}}async function wt(){await we(),await We()}return Vt(async()=>{await We(),await pt(),await ft(),await mt(),await De(D.value,I.value),await we()}),(a,e)=>{const l=O("el-date-picker"),s=O("el-option"),n=O("el-select"),r=O("el-button"),v=O("el-input"),o=O("el-table-column"),i=O("el-checkbox"),u=O("el-tag"),y=O("el-popover"),A=O("el-table");return m(),b("div",Tt,[e[35]||(e[35]=p("div",{class:"page-header"},[p("h1",{class:"page-title"},"排班管理"),p("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),f(zt,{summary:Oe.value},null,8,["summary"]),p("div",Rt,[e[18]||(e[18]=p("div",{class:"filters-header"},[p("h3",{class:"filters-title"},"篩選條件")],-1)),p("div",Ft,[p("div",Bt,[e[15]||(e[15]=p("label",{class:"filter-label"},"選擇月份",-1)),f(l,{modelValue:S.value,"onUpdate:modelValue":e[0]||(e[0]=t=>S.value=t),type:"month",onChange:wt,class:"modern-date-picker"},null,8,["modelValue"])]),p("div",Pt,[e[16]||(e[16]=p("label",{class:"filter-label"},"部門",-1)),f(n,{modelValue:D.value,"onUpdate:modelValue":e[1]||(e[1]=t=>D.value=t),placeholder:"請選擇部門",onChange:_t,disabled:!0,class:"modern-select"},{default:h(()=>[(m(!0),b(x,null,R(k.value,t=>(m(),C(s,{key:t._id,label:t.name,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),p("div",Jt,[e[17]||(e[17]=p("label",{class:"filter-label"},"單位",-1)),f(n,{modelValue:I.value,"onUpdate:modelValue":e[2]||(e[2]=t=>I.value=t),placeholder:"請選擇單位",onChange:bt,class:"modern-select"},{default:h(()=>[(m(!0),b(x,null,R(ut.value,t=>(m(),C(s,{key:t._id,label:t.name,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])]),p("div",Wt,[p("div",Kt,[f(r,{type:"primary",class:"action-btn primary",onClick:et,disabled:!Ae.value},{default:h(()=>e[19]||(e[19]=[p("i",{class:"el-icon-close"},null,-1),M(" 清除選取 ")])),_:1},8,["disabled"]),f(r,{type:"primary",class:"action-btn primary",plain:"",onClick:st,disabled:!V.value.length},{default:h(()=>e[20]||(e[20]=[p("i",{class:"el-icon-user"},null,-1),M(" 全選員工 ")])),_:1},8,["disabled"]),f(r,{type:"primary",class:"action-btn primary",plain:"",onClick:nt,disabled:!K.value.length},{default:h(()=>e[21]||(e[21]=[p("i",{class:"el-icon-date"},null,-1),M(" 全選日期 ")])),_:1},8,["disabled"])]),p("div",Yt,[p("div",Ht,[e[22]||(e[22]=p("label",{class:"range-label"},"自訂日期範圍",-1)),f(l,{modelValue:Ve.value,"onUpdate:modelValue":e[3]||(e[3]=t=>Ve.value=t),type:"daterange","start-placeholder":"開始日期","end-placeholder":"結束日期","range-separator":"至","unlink-panels":"",disabled:!K.value.length,class:"modern-date-picker range-picker",onChange:ot},null,8,["modelValue","disabled"])]),f(r,{onClick:e[4]||(e[4]=t=>Fe("week")),class:"action-btn secondary"},{default:h(()=>e[23]||(e[23]=[p("i",{class:"el-icon-calendar"},null,-1),M(" 預覽週表 ")])),_:1}),f(r,{onClick:e[5]||(e[5]=t=>Fe("month")),class:"action-btn secondary"},{default:h(()=>e[24]||(e[24]=[p("i",{class:"el-icon-date"},null,-1),M(" 預覽月表 ")])),_:1}),f(r,{onClick:e[6]||(e[6]=()=>Be("pdf")),class:"action-btn export"},{default:h(()=>e[25]||(e[25]=[p("i",{class:"el-icon-download"},null,-1),M(" 匯出 PDF ")])),_:1}),f(r,{onClick:e[7]||(e[7]=()=>Be("excel")),class:"action-btn export"},{default:h(()=>e[26]||(e[26]=[p("i",{class:"el-icon-s-grid"},null,-1),M(" 匯出 Excel ")])),_:1})])]),p("div",qt,[p("div",Gt,[e[27]||(e[27]=Et('<h3 class="schedule-title" data-v-72810a27>員工排班表</h3><div class="schedule-legend" data-v-72810a27><span class="legend-item morning" data-v-72810a27>早班</span><span class="legend-item evening" data-v-72810a27>晚班</span><span class="legend-item normal" data-v-72810a27>正常班</span><span class="legend-item leave" data-v-72810a27>請假</span></div>',2)),f(v,{modelValue:fe.value,"onUpdate:modelValue":e[8]||(e[8]=t=>fe.value=t),placeholder:"搜尋員工",clearable:"",class:"employee-search"},null,8,["modelValue"]),f(n,{modelValue:he.value,"onUpdate:modelValue":e[9]||(e[9]=t=>he.value=t),placeholder:"狀態",class:"status-filter"},{default:h(()=>[f(s,{label:"全部",value:"all"}),f(s,{label:"缺班",value:"unscheduled"}),f(s,{label:"待審核請假",value:"onLeave"})]),_:1},8,["modelValue"])]),se(ie)?(m(),b("div",Qt,[f(n,{modelValue:oe.value,"onUpdate:modelValue":e[10]||(e[10]=t=>oe.value=t),placeholder:"套用班別",class:"modern-select batch-select",filterable:"","data-test":"batch-shift-select"},{default:h(()=>[(m(!0),b(x,null,R(F.value,t=>(m(),C(s,{key:t._id,label:Ue(t),value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(n,{modelValue:G.value,"onUpdate:modelValue":e[11]||(e[11]=t=>G.value=t),placeholder:"套用部門",clearable:"",class:"modern-select batch-select","data-test":"batch-dept-select"},{default:h(()=>[(m(!0),b(x,null,R(k.value,t=>(m(),C(s,{key:t._id,label:t.name,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(n,{modelValue:W.value,"onUpdate:modelValue":e[12]||(e[12]=t=>W.value=t),placeholder:"套用單位",clearable:"",class:"modern-select batch-select",disabled:!G.value,"data-test":"batch-subdept-select"},{default:h(()=>[(m(!0),b(x,null,R(Le.value,t=>(m(),C(s,{key:t._id,label:t.name,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),f(r,{type:"primary",class:"action-btn primary apply-btn",disabled:!Ae.value||!oe.value||_e.value,loading:_e.value,onClick:gt,"data-test":"batch-apply-button"},{default:h(()=>e[28]||(e[28]=[M(" 套用至選取 ")])),_:1},8,["disabled","loading"])])):z("",!0),f(A,{class:"modern-schedule-table",data:rt.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"},onRowClick:e[14]||(e[14]=t=>Ne.value&&it(t._id))},{default:h(()=>[f(o,{label:"部門／單位",width:"180",fixed:"left"},{default:h(({row:t})=>[p("div",Xt,[p("div",Zt,E(t.department),1),t.subDepartment?(m(),b("div",ea,E(t.subDepartment),1)):z("",!0)])]),_:1}),f(o,{prop:"name",label:"員工姓名",width:"150",fixed:"left"},{default:h(({row:t})=>[p("div",ta,[se(ie)?(m(),C(i,{key:0,class:"row-checkbox","model-value":Ge.value.has(t._id),onChange:d=>tt(t._id,d)},null,8,["model-value","onChange"])):z("",!0),je(t._id)==="unscheduled"?(m(),C(Me(se(He)),{key:1,class:"status-icon unscheduled"})):je(t._id)==="onLeave"?(m(),C(Me(se(qe)),{key:2,class:"status-icon on-leave"})):z("",!0),M(" "+E(t.name),1)])]),_:1}),(m(!0),b(x,null,R(K.value,t=>(m(),C(o,{key:t.date,label:t.label,width:"140",align:"center"},{header:h(()=>[p("div",aa,[p("span",null,E(t.label),1),se(ie)?(m(),C(i,{key:0,class:"day-checkbox","model-value":Qe.value.has(t.date),onChange:d=>at(t.date,d)},null,8,["model-value","onChange"])):z("",!0)])]),default:h(({row:d})=>{var ae,Y,Q,L,le,ue,de,ce,Ce,ve,Ke;return[!Ne.value||ye.value.has(d._id)?(m(),b("div",{key:0,class:At(["modern-schedule-cell",[(Y=(ae=c.value[d._id])==null?void 0:ae[t.date])!=null&&Y.leave?"":St((L=(Q=c.value[d._id])==null?void 0:Q[t.date])==null?void 0:L.shiftId),{"has-leave":(ue=(le=c.value[d._id])==null?void 0:le[t.date])==null?void 0:ue.leave,"missing-shift":!((ce=(de=c.value[d._id])==null?void 0:de[t.date])!=null&&ce.shiftId)&&!((ve=(Ce=c.value[d._id])==null?void 0:Ce[t.date])!=null&&ve.leave),"is-selected":Ze(d._id,t.date)}]]),title:vt(d._id,t.date)},[se(ie)?(m(),b("div",{key:0,class:"cell-selection",onClick:e[13]||(e[13]=jt(()=>{},["stop"]))},[f(i,{"model-value":Xe.value.has(ee(d._id,t.date)),disabled:!be(d._id,t.date),onChange:g=>lt(d._id,t.date,g),size:"small"},null,8,["model-value","disabled","onChange"])])):z("",!0),(Ke=c.value[d._id])!=null&&Ke[t.date]?(m(),b(x,{key:1},[c.value[d._id][t.date].leave?(m(),b("div",sa,[f(u,{type:"warning",effect:"light",size:"small",class:"leave-tag"},{default:h(()=>e[29]||(e[29]=[M(" 休假中 ")])),_:1}),e[30]||(e[30]=p("span",{class:"leave-note"},"已核准請假，不列入工時",-1))])):se(ie)?(m(),b(x,{key:1},[f(n,{modelValue:c.value[d._id][t.date].shiftId,"onUpdate:modelValue":g=>c.value[d._id][t.date].shiftId=g,placeholder:"選擇班別",onChange:g=>yt(d._id,t.date,g),class:"cell-select shift-select",size:"small"},{default:h(()=>[(m(!0),b(x,null,R(F.value,g=>(m(),C(s,{key:g._id,label:Ue(g),value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),p("div",na,[f(n,{modelValue:c.value[d._id][t.date].department,"onUpdate:modelValue":g=>c.value[d._id][t.date].department=g,placeholder:"部門",size:"small",onChange:()=>c.value[d._id][t.date].subDepartment="",class:"cell-select dept-select"},{default:h(()=>[(m(!0),b(x,null,R(k.value,g=>(m(),C(s,{key:g._id,label:g.name,value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),f(n,{modelValue:c.value[d._id][t.date].subDepartment,"onUpdate:modelValue":g=>c.value[d._id][t.date].subDepartment=g,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:h(()=>[(m(!0),b(x,null,R(Je(c.value[d._id][t.date].department),g=>(m(),C(s,{key:g._id,label:g.name,value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(m(),b(x,{key:2},[te(c.value[d._id][t.date].shiftId)?(m(),C(y,{key:0,placement:"top",trigger:"hover",width:200},{reference:h(()=>[p("div",pa,E(Ue(te(c.value[d._id][t.date].shiftId))),1)]),default:h(()=>[p("div",oa,[p("div",ra,[e[31]||(e[31]=p("span",{class:"detail-label"},"上班時間：",-1)),p("span",ia,E(te(c.value[d._id][t.date].shiftId).startTime),1)]),p("div",ua,[e[32]||(e[32]=p("span",{class:"detail-label"},"下班時間：",-1)),p("span",da,E(te(c.value[d._id][t.date].shiftId).endTime),1)]),te(c.value[d._id][t.date].shiftId).remark?(m(),b("div",ca,[e[33]||(e[33]=p("span",{class:"detail-label"},"備註：",-1)),p("span",va,E(te(c.value[d._id][t.date].shiftId).remark),1)])):z("",!0)])]),_:2},1024)):z("",!0)],64)),!c.value[d._id][t.date].shiftId&&!c.value[d._id][t.date].leave?(m(),b("div",ma," 未排班 ")):z("",!0)],64)):(m(),b("span",fa,"-"))],10,la)):(m(),b("div",ha,"展開班表"))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])]),ne.value.length?(m(),b("div",ya,[p("div",_a,[e[34]||(e[34]=p("h3",{class:"approval-title"},"待處理審批",-1)),p("div",ba,E(ne.value.length)+" 項待處理",1)]),f(A,{class:"modern-approval-table",data:ne.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:h(()=>[f(o,{label:"申請人",width:"120"},{default:h(({row:t})=>{var d;return[p("div",ga,E((d=t.applicant_employee)==null?void 0:d.name),1)]}),_:1}),f(o,{label:"申請類型",width:"150"},{default:h(({row:t})=>{var d;return[p("div",Sa,E(((d=t.form)==null?void 0:d.name)||"未知類型"),1)]}),_:1}),f(o,{prop:"status",label:"狀態",width:"100"},{default:h(({row:t})=>[f(u,{type:t.status==="approved"?"success":t.status==="rejected"?"danger":"warning",class:"status-tag"},{default:h(()=>[M(E(t.status),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])):z("",!0)])}}},Ca=Ye(wa,[["__scopeId","data-v-72810a27"]]);export{Ca as default};
