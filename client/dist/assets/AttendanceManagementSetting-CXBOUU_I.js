import{i as le,a as J}from"./api-Cg1hb4Al.js";import{_ as oe,r as w,y as ne,j as P,m as ae,n as A,o as f,w as a,b as _,c as V,q as F,d as e,g as v,e as d,v as C,t as Y,F as K,E as U,k as ce}from"./index-e4ZYiO4C.js";const ge={class:"import-section"},_e={class:"upload-tip"},be={class:"mapping-grid"},ye={class:"mapping-label"},Ce={class:"dialog-actions"},Ve={class:"preview-section"},ke={class:"summary-text"},Ee={key:2},Ie={key:4},Ue={key:0},we={key:1},xe={key:2},Ae={key:0,class:"mapping-section"},De={class:"dialog-actions"},Me={__name:"AttendanceImportDialog",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","import-complete"],setup(W,{expose:N,emit:o}){const M=W,H=o,T=w(M.modelValue),k=w(null),m=w(null),n=w(!1),c=w(!1),y=w([]),r=ne({}),g=ne({timezone:"Asia/Kuala_Lumpur",mappings:{userId:"USERID",timestamp:"CHECKTIME",type:"CHECKTYPE",remark:"REMARK"}}),$=["Asia/Kuala_Lumpur","Asia/Taipei","Asia/Shanghai","Asia/Tokyo","UTC","America/Los_Angeles","Europe/London"],B={userId:"USERID 欄位",timestamp:"CHECKTIME 欄位",type:"CHECKTYPE 欄位",remark:"備註欄位 (選填)"},j=P(()=>y.value.map(t=>({value:t._id,label:`${t.name||t.email||t.employeeId||t._id}（${t.employeeId||t.email||t._id}）`}))),O=P(()=>{var t;return((t=m.value)==null?void 0:t.preview)??[]}),E=P(()=>{var t;return((t=m.value)==null?void 0:t.missingUsers)??[]}),h=P(()=>m.value?E.value.length===0?!0:E.value.every(t=>{const l=r[t.identifier];return l?l.ignore?!0:!!l.employeeId:!1}):!1);ae(()=>M.modelValue,t=>{T.value=t,t&&u()}),ae(T,t=>{H("update:modelValue",t),t||L()});function L(){k.value=null,m.value=null,n.value=!1,c.value=!1,Object.keys(r).forEach(t=>delete r[t]),g.mappings.userId="USERID",g.mappings.timestamp="CHECKTIME",g.mappings.type="CHECKTYPE",g.mappings.remark="REMARK",g.timezone="Asia/Kuala_Lumpur"}async function u(){try{const t=await J("/api/employees");if(t.ok)y.value=await t.json();else throw new Error("無法取得員工清單")}catch(t){console.warn("載入員工清單失敗",t),U.warning("載入員工清單失敗，稍後可再試")}}function z(){T.value=!1}function se(t){t!=null&&t.raw&&(k.value=t.raw)}function ie(t,l){if(!t)return"";try{const p=new Date(t);return new Intl.DateTimeFormat(void 0,{timeZone:l||"UTC",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(p)}catch{return String(t)}}function D(t){return r[t]||(r[t]={employeeId:"",ignore:!1}),r[t]}function ue(t){const l=D(t);l.ignore&&(l.employeeId="")}function X(t,l){const p=Array.isArray(t==null?void 0:t.failureReasons)?t.failureReasons.filter(Boolean):[],i=p.length?p.join("、"):"";return t!=null&&t.message&&i?`${t.message}：${i}`:t!=null&&t.message?t.message:i||l}function q({dryRun:t}){if(!k.value)return null;const l=new FormData;if(l.append("file",k.value),l.append("mappings",JSON.stringify(g.mappings)),l.append("options",JSON.stringify({timezone:g.timezone,dryRun:t})),!t&&E.value.length){const p={},i=[];E.value.forEach(S=>{const x=r[S.identifier];x&&(x.ignore?i.push(S.identifier):x.employeeId&&(p[S.identifier]={_id:x.employeeId}))}),Object.keys(p).length&&l.append("userMappings",JSON.stringify(p)),i.length&&l.append("ignoreUsers",JSON.stringify(i))}return l}async function Z(){if(!k.value){U.warning("請先選擇要匯入的檔案");return}n.value=!0;try{const t=q({dryRun:!0}),l=await le(t),p=await(async()=>{try{return await l.json()}catch{return{}}})();if(!l.ok){U.error(p.message||"預覽失敗");return}m.value=p,Object.keys(r).forEach(i=>delete r[i]),(p.missingUsers||[]).forEach(i=>{r[i.identifier]=D(i.identifier)}),(p.missingUsers||[]).length===0?U.success("預覽完成，可直接匯入"):U.warning("部分資料需要對應員工後才能匯入")}catch(t){console.error(t),U.error("預覽失敗，請稍後再試")}finally{n.value=!1}}async function G(){var l;if(!h.value)return;const t=q({dryRun:!1});if(t){c.value=!0;try{const p=await le(t),i=await(async()=>{try{return await p.json()}catch{return{}}})();if(!p.ok){i&&typeof i=="object"&&(m.value=i.summary?i:m.value),U.error(X(i,"匯入失敗，請稍後再試"));return}if(m.value=i,Number(((l=i==null?void 0:i.summary)==null?void 0:l.importedCount)??0)<=0){U.error(X(i,"所有資料均未匯入"));return}U.success(i.message||"考勤資料匯入完成"),H("import-complete",i),z()}catch(p){console.error(p),U.error("匯入失敗，請稍後再試")}finally{c.value=!1}}}return N({selectedFile:k,submitPreview:Z,submitImport:G,missingResolutions:r}),(t,l)=>{const p=d("el-alert"),i=d("el-button"),S=d("el-upload"),x=d("el-form-item"),Q=d("el-option"),ee=d("el-select"),re=d("el-input"),de=d("el-form"),me=d("el-divider"),I=d("el-table-column"),R=d("el-tag"),te=d("el-table"),pe=d("el-checkbox"),fe=d("el-dialog");return f(),A(fe,{"model-value":T.value,title:"考勤資料匯入",width:"720px",onClose:z},{default:a(()=>[_("div",ge,[e(p,{type:"info","show-icon":"",class:"import-hint"},{title:a(()=>l[1]||(l[1]=[v("上傳考勤檔案後可先預覽資料，確認欄位與員工對應再正式匯入。")])),default:a(()=>[l[2]||(l[2]=v(" 系統預設欄位為 USERID、CHECKTIME、CHECKTYPE，若來源檔案不同可於下方調整欄位名稱。 "))]),_:1}),e(de,{"label-width":"140px",class:"import-form"},{default:a(()=>[e(x,{label:"檔案上傳"},{default:a(()=>[e(S,{action:"","auto-upload":!1,"show-file-list":!1,accept:".xlsx,.csv",onChange:se},{tip:a(()=>[_("div",_e,C(k.value?`已選擇：${k.value.name}`:"支援 Excel 或 CSV 檔案，欄位需包含 USERID、CHECKTIME、CHECKTYPE。"),1)]),default:a(()=>[e(i,{type:"primary"},{default:a(()=>l[3]||(l[3]=[v("選擇檔案")])),_:1})]),_:1})]),_:1}),e(x,{label:"時區"},{default:a(()=>[e(ee,{modelValue:g.timezone,"onUpdate:modelValue":l[0]||(l[0]=s=>g.timezone=s),placeholder:"選擇時區",filterable:""},{default:a(()=>[(f(),V(K,null,Y($,s=>e(Q,{key:s,label:s,value:s},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),e(x,{label:"欄位對應"},{default:a(()=>[_("div",be,[(f(!0),V(K,null,Y(g.mappings,(s,b)=>(f(),V("div",{class:"mapping-item",key:b},[_("label",ye,C(B[b]),1),e(re,{modelValue:g.mappings[b],"onUpdate:modelValue":ve=>g.mappings[b]=ve,placeholder:"輸入對應欄位名稱"},null,8,["modelValue","onUpdate:modelValue"])]))),128))]),l[4]||(l[4]=_("div",{class:"mapping-suggest"}," 常見別名示例：USERID/EmpID、CHECKTIME/DateTime、CHECKTYPE/InOut/Direction、REMARK/Memo ",-1))]),_:1})]),_:1}),_("div",Ce,[e(i,{onClick:z},{default:a(()=>l[5]||(l[5]=[v("取消")])),_:1}),e(i,{type:"primary",loading:n.value,onClick:Z},{default:a(()=>l[6]||(l[6]=[v("預覽資料")])),_:1},8,["loading"])])]),m.value?(f(),V(K,{key:0},[e(me),_("section",Ve,[l[13]||(l[13]=_("h3",null,"匯入預覽",-1)),_("p",ke," 共 "+C(m.value.summary.totalRows)+" 筆， 已匹配 "+C(m.value.summary.readyCount)+" 筆， 待處理 "+C(m.value.summary.missingCount)+" 筆， 忽略 "+C(m.value.summary.ignoredCount)+" 筆， 發生錯誤 "+C(m.value.summary.errorCount)+" 筆。 ",1),e(te,{data:O.value,height:"240",border:""},{default:a(()=>[e(I,{prop:"rowNumber",label:"列",width:"60"}),e(I,{prop:"userId",label:"USERID",width:"140"}),e(I,{label:"時間",width:"220"},{default:a(({row:s})=>[_("span",null,C(ie(s.timestamp,g.timezone)),1)]),_:1}),e(I,{prop:"action",label:"動作",width:"120"},{default:a(({row:s})=>[s.action==="in"||s.action==="clockIn"?(f(),A(R,{key:0},{default:a(()=>l[7]||(l[7]=[v("I / 上班")])),_:1})):s.action==="out"||s.action==="clockOut"?(f(),A(R,{key:1,type:"warning"},{default:a(()=>l[8]||(l[8]=[v(" O / 下班 ")])),_:1})):(f(),V("span",Ee,C(s.action),1))]),_:1}),e(I,{prop:"status",label:"狀態",width:"110"},{default:a(({row:s})=>[s.status==="ready"?(f(),A(R,{key:0,type:"success"},{default:a(()=>l[9]||(l[9]=[v("已就緒")])),_:1})):s.status==="missing"?(f(),A(R,{key:1,type:"info"},{default:a(()=>l[10]||(l[10]=[v("未匹配")])),_:1})):s.status==="ignored"?(f(),A(R,{key:2},{default:a(()=>l[11]||(l[11]=[v("忽略")])),_:1})):s.status==="error"?(f(),A(R,{key:3,type:"danger"},{default:a(()=>l[12]||(l[12]=[v("錯誤")])),_:1})):(f(),V("span",Ie,C(s.status),1))]),_:1}),e(I,{label:"訊息"},{default:a(({row:s})=>{var b;return[Array.isArray(s.errors)&&s.errors.length?(f(),V("span",Ue,C(s.errors.join("、")),1)):s.status==="missing"?(f(),V("span",we,"尚未對應員工")):s.status==="ready"?(f(),V("span",xe,C(((b=s.employee)==null?void 0:b.name)||""),1)):F("",!0)]}),_:1})]),_:1},8,["data"])]),E.value.length?(f(),V("section",Ae,[l[15]||(l[15]=_("h3",null,"員工對應",-1)),l[16]||(l[16]=_("p",{class:"section-hint"},"為下列識別值選擇對應的員工或設定忽略後即可重新送出匯入。",-1)),e(te,{data:E.value,height:"240",border:""},{default:a(()=>[e(I,{prop:"identifier",label:"USERID",width:"180"}),e(I,{prop:"count",label:"筆數",width:"80"}),e(I,{label:"對應員工"},{default:a(({row:s})=>[e(ee,{modelValue:D(s.identifier).employeeId,"onUpdate:modelValue":b=>D(s.identifier).employeeId=b,placeholder:"選擇員工",disabled:D(s.identifier).ignore,filterable:"",style:{width:"100%"}},{default:a(()=>[(f(!0),V(K,null,Y(j.value,b=>(f(),A(Q,{key:b.value,label:b.label,value:b.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"])]),_:1}),e(I,{label:"忽略",width:"120"},{default:a(({row:s})=>[e(pe,{modelValue:D(s.identifier).ignore,"onUpdate:modelValue":b=>D(s.identifier).ignore=b,onChange:b=>ue(s.identifier)},{default:a(()=>l[14]||(l[14]=[v(" 忽略此次匯入 ")])),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"])])):F("",!0),_("div",De,[e(i,{onClick:z},{default:a(()=>l[17]||(l[17]=[v("取消")])),_:1}),e(i,{type:"primary",disabled:!h.value,loading:c.value,onClick:G},{default:a(()=>l[18]||(l[18]=[v(" 開始匯入 ")])),_:1},8,["disabled","loading"])])],64)):F("",!0)]),_:1},8,["model-value"])}}},Te=oe(Me,[["__scopeId","data-v-023f8be6"]]),Se={class:"attendance-mgmt-setting"},Re={__name:"AttendanceManagementSetting",setup(W){const N=w(!1),o=w({enableImport:!1,importFormat:"",importMapping:"",allowMakeUpClock:!0,makeUpDays:3,makeUpNeedApprove:!0,supervisorCrossDept:!1,hrAllDept:!0,employeeHistoryMonths:6,nonExtWorkAlert:!1,overtimeNoClockNotify:!0,notifyTargets:["員工","主管"]}),M=w("");async function H(){const m=await J("/api/attendance-settings");if(!m.ok)return;const n=await m.json(),c=Array.isArray(n)?n[0]:n;if(c){const y=c.management||c;Object.assign(o.value,y),M.value=c._id||""}}async function T(){const m={management:{...o.value}},n=await J("/api/attendance-settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)});if(n.ok){const c=await n.json();c.management&&Object.assign(o.value,c.management),M.value=c._id||M.value,alert("已儲存「考勤管理設定」")}}function k(){alert("考勤資料匯入完成")}return ce(H),(m,n)=>{const c=d("el-divider"),y=d("el-switch"),r=d("el-form-item"),g=d("el-option"),$=d("el-select"),B=d("el-input"),j=d("el-button"),O=d("el-input-number"),E=d("el-checkbox"),h=d("el-checkbox-group"),L=d("el-form");return f(),V(K,null,[_("div",Se,[n[22]||(n[22]=_("h2",null,"考勤管理設定",-1)),e(L,{model:o.value,"label-width":"180px",class:"setting-form"},{default:a(()=>[e(c,{"content-position":"left"},{default:a(()=>n[14]||(n[14]=[v("資料匯入設定")])),_:1}),e(r,{label:"是否啟用外部刷卡匯入"},{default:a(()=>[e(y,{modelValue:o.value.enableImport,"onUpdate:modelValue":n[0]||(n[0]=u=>o.value.enableImport=u),"active-text":"啟用","inactive-text":"停用"},null,8,["modelValue"])]),_:1}),e(r,{label:"匯入檔案格式"},{default:a(()=>[e($,{modelValue:o.value.importFormat,"onUpdate:modelValue":n[1]||(n[1]=u=>o.value.importFormat=u),placeholder:"選擇匯入檔格式",disabled:!o.value.enableImport},{default:a(()=>[e(g,{label:"CSV",value:"csv"}),e(g,{label:"Excel (XLSX)",value:"xlsx"}),e(g,{label:"TXT (定長欄位)",value:"txt"})]),_:1},8,["modelValue","disabled"])]),_:1}),e(r,{label:"匯入欄位對應 (範例)"},{default:a(()=>[e(B,{modelValue:o.value.importMapping,"onUpdate:modelValue":n[2]||(n[2]=u=>o.value.importMapping=u),placeholder:"如：員工編號→Column A, 日期→Column B, 上班時間→Column C...",disabled:!o.value.enableImport},null,8,["modelValue","disabled"])]),_:1}),e(r,{label:"考勤資料匯入"},{default:a(()=>[e(j,{type:"primary",disabled:!o.value.enableImport,"data-test":"attendance-import-button",onClick:n[3]||(n[3]=u=>N.value=!0)},{default:a(()=>n[15]||(n[15]=[v(" 開啟匯入流程 ")])),_:1},8,["disabled"])]),_:1}),e(c,{"content-position":"left"},{default:a(()=>n[16]||(n[16]=[v("補打卡審核設定")])),_:1}),e(r,{label:"是否允許員工提出補打卡"},{default:a(()=>[e(y,{modelValue:o.value.allowMakeUpClock,"onUpdate:modelValue":n[4]||(n[4]=u=>o.value.allowMakeUpClock=u),"active-text":"允許","inactive-text":"不允許"},null,8,["modelValue"])]),_:1}),e(r,{label:"最晚可補打卡天數"},{default:a(()=>[e(O,{modelValue:o.value.makeUpDays,"onUpdate:modelValue":n[5]||(n[5]=u=>o.value.makeUpDays=u),min:0,disabled:!o.value.allowMakeUpClock},null,8,["modelValue","disabled"]),n[17]||(n[17]=_("small",null,"（允許員工多少天之內可以補打卡）",-1))]),_:1}),e(r,{label:"補打卡是否需主管簽核"},{default:a(()=>[e(y,{modelValue:o.value.makeUpNeedApprove,"onUpdate:modelValue":n[6]||(n[6]=u=>o.value.makeUpNeedApprove=u),disabled:!o.value.allowMakeUpClock},null,8,["modelValue","disabled"])]),_:1}),e(c,{"content-position":"left"},{default:a(()=>n[18]||(n[18]=[v("查詢權限設定")])),_:1}),e(r,{label:"主管是否可查跨部門考勤"},{default:a(()=>[e(y,{modelValue:o.value.supervisorCrossDept,"onUpdate:modelValue":n[7]||(n[7]=u=>o.value.supervisorCrossDept=u),"active-text":"是","inactive-text":"否"},null,8,["modelValue"])]),_:1}),e(r,{label:"HR 是否可查所有部門"},{default:a(()=>[e(y,{modelValue:o.value.hrAllDept,"onUpdate:modelValue":n[8]||(n[8]=u=>o.value.hrAllDept=u),"active-text":"是","inactive-text":"否"},null,8,["modelValue"])]),_:1}),e(r,{label:"員工可查詢歷史紀錄(月)"},{default:a(()=>[e(O,{modelValue:o.value.employeeHistoryMonths,"onUpdate:modelValue":n[9]||(n[9]=u=>o.value.employeeHistoryMonths=u),min:1},null,8,["modelValue"]),n[19]||(n[19]=_("small",null,"（員工可往前查詢幾個月？）",-1))]),_:1}),e(c,{"content-position":"left"},{default:a(()=>n[20]||(n[20]=[v("異常提醒")])),_:1}),e(r,{label:"非延長工時提醒"},{default:a(()=>[e(y,{modelValue:o.value.nonExtWorkAlert,"onUpdate:modelValue":n[10]||(n[10]=u=>o.value.nonExtWorkAlert=u),"active-text":"啟用","inactive-text":"停用"},null,8,["modelValue"])]),_:1}),e(r,{label:"逾時未打卡是否自動通知"},{default:a(()=>[e(y,{modelValue:o.value.overtimeNoClockNotify,"onUpdate:modelValue":n[11]||(n[11]=u=>o.value.overtimeNoClockNotify=u),"active-text":"啟用","inactive-text":"停用"},null,8,["modelValue"])]),_:1}),e(r,{label:"通知對象"},{default:a(()=>[e(h,{modelValue:o.value.notifyTargets,"onUpdate:modelValue":n[12]||(n[12]=u=>o.value.notifyTargets=u)},{default:a(()=>[e(E,{label:"員工"}),e(E,{label:"主管"}),e(E,{label:"HR"})]),_:1},8,["modelValue"])]),_:1}),e(r,null,{default:a(()=>[e(j,{type:"primary",onClick:T},{default:a(()=>n[21]||(n[21]=[v("儲存設定")])),_:1})]),_:1})]),_:1},8,["model"])]),e(Te,{modelValue:N.value,"onUpdate:modelValue":n[13]||(n[13]=u=>N.value=u),onImportComplete:k},null,8,["modelValue"])],64)}}},He=oe(Re,[["__scopeId","data-v-2e813ea5"]]);export{He as default};
