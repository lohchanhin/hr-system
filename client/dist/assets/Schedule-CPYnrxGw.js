import{_ as ea,j as w,I as Ba,J as ta,K as aa,c as y,o as p,F as T,t as W,n as O,w as h,b as d,L as Dt,A as pt,v as S,e as V,r as g,D as G,y as Xt,m as ve,k as Ja,d as f,q as N,h as be,p as Zt,E as ue,u as Ka,g as I,f as Wa,B as Ae,M as qa}from"./index-e4ZYiO4C.js";import{a as B}from"./api-Cg1hb4Al.js";import{u as Ha}from"./auth-YZEZ77TH.js";import{b as Ga}from"./shiftColors-BbvJ2s1U.js";const Qa={class:"dashboard"},Xa={class:"metric-label"},Za={class:"metric-value"},el=Object.assign({name:"ScheduleDashboard"},{__name:"ScheduleDashboard",props:{summary:{type:Object,default:()=>({direct:0,unscheduled:0,onLeave:0})}},setup(At){const Te=At,vt=w(()=>[{label:"直屬員工數",value:Te.summary.direct,icon:Ba,color:"#0f766e"},{label:"未排班員工",value:Te.summary.unscheduled,icon:ta,color:"#dc2626"},{label:"請假中員工",value:Te.summary.onLeave,icon:aa,color:"#f59e0b"}]);return(It,Vt)=>{const U=V("el-card");return p(),y("div",Qa,[(p(!0),y(T,null,W(vt.value,v=>(p(),O(U,{class:"metric-card",key:v.label},{default:h(()=>[(p(),O(Dt(v.icon),{class:"metric-icon",style:pt({color:v.color})},null,8,["style"])),d("div",Xa,S(v.label),1),d("div",Za,S(v.value),1)]),_:2},1024))),128))])}}}),tl=ea(el,[["__scopeId","data-v-ceb5c889"]]),al={class:"schedule-page"},ll={class:"filters-card"},sl={class:"filters-content"},nl={class:"filter-group"},ol={class:"filter-group"},il={class:"filter-group"},rl={key:0,class:"filter-group include-self-group"},ul={key:0,class:"publish-card"},dl={class:"publish-header"},cl={class:"publish-progress","data-test":"publish-steps"},pl={class:"publish-meta-row"},vl={key:0,class:"publish-meta","data-test":"publish-meta"},fl={key:1,class:"publish-meta","data-test":"publish-meta"},ml={key:2,class:"publish-progress-indicator"},hl={class:"progress-label"},yl={class:"publish-actions"},_l={class:"publish-stats"},gl={key:0,class:"status-card pending","data-test":"pending-card"},bl={class:"card-header"},Sl={class:"card-badge"},wl={class:"card-list"},kl={class:"card-name"},El={class:"card-count"},Cl={key:1,class:"status-card disputed","data-test":"disputed-card"},Dl={class:"card-header"},Al={class:"card-badge"},Il={class:"card-list"},Vl={class:"card-item-main"},$l={class:"card-name"},zl={class:"card-count"},jl={key:0,class:"card-note"},xl={key:2,class:"status-card ready","data-test":"ready-card"},Ml={key:3,class:"status-card finalized","data-test":"finalized-card"},Nl={class:"actions-card"},Pl={class:"primary-actions"},Rl={class:"secondary-actions"},Tl={class:"range-picker-wrapper"},Fl={class:"schedule-card"},Ol={class:"schedule-header"},Ul={class:"schedule-legend","data-test":"schedule-legend"},Ll={key:1,class:"legend-empty","data-test":"shift-legend-empty"},Yl={key:0,class:"batch-toolbar"},Bl={class:"employee-info"},Jl={class:"department-name"},Kl={key:0,class:"sub-department"},Wl={class:"employee-name"},ql={class:"day-header"},Hl=["title"],Gl={key:0,class:"leave-indicator","data-test":"leave-indicator"},Ql={class:"department-selects"},Xl={class:"shift-details"},Zl={class:"detail-row"},es={class:"detail-value"},ts={class:"detail-row"},as={class:"detail-value"},ls={key:0,class:"detail-row"},ss={class:"detail-value"},ns={key:3,class:"missing-label"},os={key:2,class:"empty-cell"},is={key:1,class:"modern-schedule-cell collapsed-cell"},rs={key:1,class:"pagination-bar"},us={key:1,class:"approval-card"},ds={class:"approval-header"},cs={class:"approval-count"},ps={class:"applicant-name"},vs={class:"form-type"},fs={key:0},ms={class:"mb-2"},hs={class:"mb-2"},ys={class:"mb-2"},_s={class:"mb-1"},gs={class:"mr-2"},bs="schedule-include-self",Ss={__name:"Schedule",setup(At){const Te=t=>t?new Date(t).toLocaleString():"-",vt=t=>Array.isArray(t)?t.join(", "):t??"-",It={leave:"請假",attendance:"出勤",overtime:"加班",shift:"排班",reimbursement:"報銷",expense:"費用",travel:"出差",recruitment:"招募",onboarding:"入職",general:"一般"},Vt=(t,e="")=>{if(t==null)return e||"未知類型";const a=String(t).trim();return a?It[a.toLowerCase()]||a:e||"未知類型"},U=g(G().format("YYYY-MM")),v=g({}),Fe=g([]),fe=g([]),x=g([]),Ie=g([]),ee=g([]),oe=g([]),$=g(""),P=g(""),q=g(""),ie=g(""),R=g(""),Oe=g(""),me=g([]),Ue=g(null),Q=g(!1);let $t=!0;const zt=g({direct:0,unscheduled:0,onLeave:0}),Le=g(""),Ye=g("all"),at=g(new Set),se=g(new Set),X=g(new Set),Se=g(new Set),Be=g(new Map),ft=g([]),Je=g(""),he=g(""),de=g(""),lt=g(!1),Ke=g(!1),We=g(!1),F=Xt({visible:!1,doc:null}),mt=Xt({}),ce=g(20),Z=g(1),st=g(null),nt=g(new Set),ht=g(!1);function we(){var a,l;if(typeof window>"u")return"";const t=(a=window.sessionStorage)==null?void 0:a.getItem("employeeId");if(t&&t!=="undefined")return t;const e=(l=window.localStorage)==null?void 0:l.getItem("employeeId");return e&&e!=="undefined"?e:""}function jt(t){return t?`${bs}:${String(t)}`:""}function xt(t=we()){var l;if(typeof window>"u")return null;const e=jt(t);if(!e)return null;const a=(l=window.localStorage)==null?void 0:l.getItem(e);return a==="true"?!0:a==="false"?!1:null}function yt(t,e=we()){var l;if(typeof window>"u")return;const a=jt(e);if(a)try{(l=window.localStorage)==null||l.setItem(a,t?"true":"false")}catch(n){console.warn("Failed to persist includeSelf preference",n)}}const la=w(()=>se.value),sa=w(()=>X.value),na=w(()=>Se.value),Mt=w(()=>{if(!Array.isArray(fe.value)||!fe.value.length)return[];const t=new Set;return fe.value.reduce((e,a)=>{if(!a)return e;const l=ut(a)||a.name||a.code||"未命名班別",n=String(a._id||`${a.code??""}-${a.name??""}`);return!n||t.has(n)||(t.add(n),e.push({key:n,label:l,style:Ct(a)})),e},[])}),ye=(t,e)=>`${t}-${e}`,_t=t=>{const[e,a]=String(t).split("-");return{empId:e,day:Number(a)}},qe=(t,e)=>{const a=v.value[t];if(!a)return!1;const l=a[e];return l?!l.leave:!1},gt=w(()=>new Set(Be.value.keys())),Ve=t=>{const e=new Map(Be.value);t(e),Be.value=e},pe=(t,e,a,l,n)=>{const i=ye(e,a);if(!qe(e,a)){t.delete(i);return}if(!n){const r=t.get(i);if(!r)return;r[l]=!1,r.manual||r.employee||r.day?t.set(i,r):t.delete(i);return}const c=t.get(i)||{manual:!1,employee:!1,day:!1};c[l]=!0,t.set(i,c)},oa=()=>{const t=new Map,e=(a,l,n)=>{if(!qe(a,l))return;const i=ye(a,l),c=t.get(i)||{manual:!1,employee:!1,day:!1};c[n]=!0,t.set(i,c)};Se.value.forEach(a=>{const{empId:l,day:n}=_t(a);e(l,n,"manual")}),se.value.forEach(a=>{te.value.forEach(l=>e(a,l.date,"employee"))}),X.value.forEach(a=>{x.value.forEach(l=>e(l._id,a,"day"))}),Be.value=t},bt=w(()=>gt.value.size>0),Nt=w(()=>he.value?Ht(he.value):[]),ia=(t,e)=>gt.value.has(ye(t,e)),ot=()=>{const t=new Set(x.value.map(l=>l._id)),e=new Set(te.value.map(l=>l.date));se.value=new Set(Array.from(se.value).filter(l=>t.has(l))),X.value=new Set(Array.from(X.value).filter(l=>e.has(l)));const a=new Set;Se.value.forEach(l=>{const{empId:n,day:i}=_t(l);t.has(n)&&e.has(i)&&qe(n,i)&&a.add(ye(n,i))}),Se.value=a,oa()},ra=()=>{se.value=new Set,X.value=new Set,Se.value=new Set,Be.value=new Map,ft.value=[]},ua=(t,e)=>{const a=new Set(se.value),l=typeof e=="boolean"?e:!a.has(t);l?a.add(t):a.delete(t),se.value=a,Ve(n=>{te.value.forEach(i=>pe(n,t,i.date,"employee",l))})},da=(t,e)=>{const a=new Set(X.value),l=typeof e=="boolean"?e:!a.has(t);l?a.add(t):a.delete(t),X.value=a,Ve(n=>{x.value.forEach(i=>pe(n,i._id,t,"day",l))})},ca=(t,e,a)=>{if(!qe(t,e))return;const l=ye(t,e),n=new Set(Se.value),i=typeof a=="boolean"?a:!n.has(l);i?n.add(l):n.delete(l),Se.value=n,Ve(c=>pe(c,t,e,"manual",i))},pa=()=>{const t=se.value;se.value=new Set(x.value.map(l=>l._id));const e=Array.from(se.value).filter(l=>!t.has(l)),a=Array.from(t).filter(l=>!se.value.has(l));Ve(l=>{e.forEach(n=>{te.value.forEach(i=>pe(l,n,i.date,"employee",!0))}),a.forEach(n=>{te.value.forEach(i=>pe(l,n,i.date,"employee",!1))})})},va=()=>{const t=X.value;X.value=new Set(te.value.map(l=>l.date));const e=Array.from(X.value).filter(l=>!t.has(l)),a=Array.from(t).filter(l=>!X.value.has(l));Ve(l=>{e.forEach(n=>{x.value.forEach(i=>pe(l,i._id,n,"day",!0))}),a.forEach(n=>{x.value.forEach(i=>pe(l,i._id,n,"day",!1))})})},Pt=t=>[...t].sort((e,a)=>{const l=(e.department||"").localeCompare(a.department||"");return l!==0?l:(e.name||"").localeCompare(a.name||"")}),fa=t=>{if(!Array.isArray(t)||t.length!==2)return;const[e,a]=t;if(!e||!a)return;const l=G(`${U.value}-01`),n=G(e),i=G(a);if(!n.isValid()||!i.isValid())return;const c=l.endOf("month");let r=n.isBefore(l)?l:n;const u=[];for(;(r.isBefore(i)||r.isSame(i,"day"))&&(r.year()===l.year()&&r.month()===l.month()&&u.push(r.date()),!r.isSame(c,"day"));)r=r.add(1,"day");const s=X.value,_=new Set(u);X.value=_;const C=u.filter(L=>!s.has(L)),A=Array.from(s).filter(L=>!_.has(L));Ve(L=>{C.forEach(z=>{x.value.forEach(b=>pe(L,b._id,z,"day",!0))}),A.forEach(z=>{x.value.forEach(b=>pe(L,b._id,z,"day",!1))})})};ve(he,(t,e)=>{t!==e&&(de.value="")}),ve(Nt,t=>{de.value&&!t.some(e=>e._id===de.value)&&(de.value="")}),ve(Q,async(t,e)=>{if(t===e)return;const a=Ce()||we();yt(t,a),ke.refreshRole({forceRefresh:!0}),!$t&&re.value&&(Z.value=1,await dt($.value,P.value),await ne({reset:!0}),await Ge())}),ve([Le,Ye],()=>{Z.value=1});const St=t=>{const e=v.value[t]||{},a=Object.values(e),l=a.some(i=>i.shiftId),n=a.some(i=>i.leave);return l?n?"onLeave":"scheduled":"unscheduled"},$e=w(()=>{let t=Le.value?x.value.filter(e=>e.name.includes(Le.value)):x.value;return Ye.value!=="all"&&(t=t.filter(e=>St(e._id)===Ye.value)),t}),ma=w(()=>$e.value.length?Math.max(1,Math.ceil($e.value.length/ce.value)):1),Rt=w(()=>{const t=(Z.value-1)*ce.value,e=t+ce.value;return $e.value.slice(t,e)}),Tt=w(()=>Rt.value.map(t=>String(t._id)));ve([$e,ce],()=>{const t=ma.value;Z.value>t&&(Z.value=t)}),ve(Tt,()=>{ne()});const Ft=w(()=>x.value.length>50),ha=t=>{at.value.has(t)?at.value.delete(t):at.value.add(t)},ya=w(()=>oe.value.filter(t=>t.department===$.value)),_a=Ka(),ke=Ha();ke.loadUser();const Ot=w(()=>["supervisor","admin"].includes(ke.role)),re=w(()=>ke.role==="supervisor"),ze=Ot,je=g(""),E=w(()=>{if(st.value){const s=st.value;return{status:s.status||"draft",pendingEmployees:s.pendingEmployees||[],disputedEmployees:s.disputedEmployees||[],publishedAt:s.publishedAt||null,hasSchedules:s.hasSchedules??!1,totalEmployees:s.totalEmployees??0,allEmployeesConfirmed:s.allEmployeesConfirmed??!1}}const t={status:"draft",pendingEmployees:[],disputedEmployees:[],publishedAt:null,hasSchedules:!1,totalEmployees:0,allEmployeesConfirmed:!1},e=Array.isArray(Fe.value)?Fe.value:[];if(!e.length)return t;t.hasSchedules=!0;const a=new Map;let l=null,n=!1,i=!1,c=!1;e.forEach(s=>{if(!s)return;const _=s.state||"draft",C=s.employeeResponse||"pending",A=s.employee||{},L=(A==null?void 0:A._id)??(A==null?void 0:A.id)??s.employee,z=L?String(L):"",b=(A==null?void 0:A.name)||s.employeeName||z;if(_!=="draft"&&(n=!0),(_==="changes_requested"||C==="disputed")&&(i=!0),_==="finalized"&&(c=!0),s!=null&&s.publishedAt){const Y=new Date(s.publishedAt);Number.isNaN(Y)||(!l||l<Y)&&(l=Y)}if(!z)return;a.has(z)||a.set(z,{id:z,name:b||z,pendingCount:0,disputedCount:0,latestNote:"",latestResponseAt:null});const D=a.get(z);if(_==="pending_confirmation"&&C==="pending"&&(D.pendingCount+=1),(C==="disputed"||_==="changes_requested")&&(D.disputedCount+=1,s!=null&&s.responseNote&&(D.latestNote=s.responseNote)),s!=null&&s.responseAt){const Y=new Date(s.responseAt);Number.isNaN(Y)||(!D.latestResponseAt||D.latestResponseAt<Y)&&(D.latestResponseAt=Y)}});const r=[],u=[];return a.forEach(s=>{s.pendingCount>0&&r.push({id:s.id,name:s.name,pendingCount:s.pendingCount}),s.disputedCount>0&&u.push({id:s.id,name:s.name,disputedCount:s.disputedCount,latestNote:s.latestNote,latestResponseAt:s.latestResponseAt?s.latestResponseAt.toISOString():null})}),t.pendingEmployees=r,t.disputedEmployees=u,t.totalEmployees=a.size,t.publishedAt=l?l.toISOString():null,c?t.status="finalized":i?t.status="disputed":n?t.status=r.length?"pending":"ready":t.status="draft",t.allEmployeesConfirmed=t.status==="ready"&&r.length===0&&u.length===0,t}),ga=w(()=>({draft:"尚未發布",pending:"待員工確認",ready:"可完成發布",disputed:"需處理異議",finalized:"已完成發布"})[E.value.status]||"尚未發布"),xe=w(()=>E.value.pendingEmployees.reduce((t,e)=>t+(Number(e==null?void 0:e.pendingCount)||0),0)),Me=w(()=>E.value.disputedEmployees.reduce((t,e)=>t+(Number(e==null?void 0:e.disputedCount)||0),0)),ba=w(()=>{const t=E.value.status;return t==="pending"?1:t==="disputed"?2:t==="ready"||t==="finalized"?3:0}),it=w(()=>{const t=E.value.status,e=xe.value>0,a=Me.value>0;return{draft:t==="draft"?"process":"finish",pending:t==="draft"?"wait":e||t==="pending"?"process":"finish",disputed:a?"error":t==="draft"||t==="pending"?"wait":"finish",finalized:t==="finalized"?"success":t==="ready"?"process":"wait"}}),Sa=w(()=>E.value.hasSchedules?xe.value>0?`${xe.value} 筆待回覆`:"員工已完成回覆":"尚未發送確認"),wa=w(()=>E.value.hasSchedules?Me.value>0?`${Me.value} 筆異議待處理`:"無異議紀錄":"尚未進入異議流程"),ka=w(()=>E.value.status==="finalized"?"班表已鎖定":E.value.status==="ready"?"可執行最終發布":"等待完成發布"),wt=w(()=>{if(E.value.status==="finalized")return 100;const t=E.value.totalEmployees;if(!t||t<=0)return E.value.status==="draft"?0:20;const e=Math.max(t-E.value.pendingEmployees.length,0),a=Math.round(e/t*100);return Math.min(Math.max(a,0),100)}),Ut=w(()=>Ke.value||!E.value.hasSchedules||E.value.status==="finalized"),Lt=w(()=>We.value||E.value.status!=="ready");ve(re,t=>{const e=Ce()||we();if(!t){Q.value&&(Q.value=!1),yt(!1,e);return}const a=xt(e);a===!0?Q.value=!0:a===!1&&e&&yt(!1,e)});const Ee=t=>{var l,n;const e=(l=ue)==null?void 0:l.warning;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.warning:void 0;typeof a=="function"&&a!==e&&a(t)},He=t=>{var l,n;const e=(l=ue)==null?void 0:l.info;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.info:void 0;typeof a=="function"&&a!==e&&a(t)},kt=t=>{var l,n;const e=(l=ue)==null?void 0:l.success;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.success:void 0;typeof a=="function"&&a!==e&&a(t)},Ea=t=>{if(!t)return"";const e=G(t);return e.isValid()?e.format("YYYY/MM/DD HH:mm"):""};function Yt(){const t={month:U.value};return $.value&&(t.department=$.value),P.value&&(t.subDepartment=P.value),Q.value&&re.value&&(t.includeSelf=!0),t}async function Ca(){if(!Ke.value)try{Ke.value=!0;const t=await B("/api/schedules/publish",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Yt())});if(!t.ok){let e="發布失敗";try{const a=await t.json();a!=null&&a.error&&(e=a.error)}catch{}throw new Error(e)}kt("已將班表發送給員工確認"),await ne(),await Ge()}catch(t){Ee((t==null?void 0:t.message)||"發布失敗")}finally{Ke.value=!1}}async function Da(){if(!We.value)try{We.value=!0;const t=await B("/api/schedules/publish/finalize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Yt())});if(t.status===409){let e="仍有員工未回覆";try{const a=await t.json();a!=null&&a.error&&(e=a.error)}catch{}Ee(e),await ne();return}if(!t.ok){let e="完成發布失敗";try{const a=await t.json();a!=null&&a.error&&(e=a.error)}catch{}throw new Error(e)}kt("班表已完成發布"),await ne(),await Ge()}catch(t){Ee((t==null?void 0:t.message)||"完成發布失敗")}finally{We.value=!1}}async function Aa(){if(Ut.value){Ee("目前沒有可發布的班表");return}try{await Ae.confirm("確認要將本月班表發送給員工確認嗎？","批次發布",{type:"warning",confirmButtonText:"送出",cancelButtonText:"取消"})}catch{return}await Ca()}async function Ia(){if(E.value.status==="finalized"){He("班表已完成發布");return}if(Lt.value){Ee("仍有員工尚未回覆，請確認後再完成發布");return}try{await Ae.confirm("全部員工已確認，是否完成發布並鎖定班表？","完成發布",{type:"success",confirmButtonText:"完成",cancelButtonText:"取消"})}catch{return}await Da()}const Bt=t=>({pending:"待簽核",approved:"已核可",rejected:"已否決",returned:"已退簽"})[t]||t||"-",Va=t=>{if(t&&typeof t=="object"){const e=t._id||t.employeeId||"";return t.name||mt[e]||e}return mt[t]||t||"-"},$a=(t,e)=>{var l,n;const a=(n=(l=v.value)==null?void 0:l[t])==null?void 0:n[e];return a!=null&&a.leave?"已核准請假，該日不列入工作時數":""},te=w(()=>{const t=G(U.value+"-01"),e=t.endOf("month").date(),a=["日","一","二","三","四","五","六"];return Array.from({length:e},(l,n)=>{const i=n+1,c=a[t.date(i).day()];return{date:i,label:`${i}(${c})`}})});ve(x,ot),ve(te,ot);async function za(){const t=await B("/api/shifts");if(t.ok){const e=await t.json(),a=Array.isArray(e==null?void 0:e.shifts)?e.shifts:Array.isArray(e)?e:[];Array.isArray(a)&&(fe.value=a.map(l=>({_id:l._id,code:l.code,name:l.name??"",startTime:l.startTime,endTime:l.endTime,remark:l.remark})))}else t.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",t.status)}async function Jt(t=""){try{const e=t||q.value,a=e?`/api/sub-departments?department=${e}`:"/api/sub-departments",l=await B(a);if(!l.ok)throw new Error("Failed to fetch sub departments");const n=await l.json(),i=ee.value.reduce((u,s)=>{const _=String(s._id);return u[_]=_,s.name&&(u[s.name]=_),u},{});q.value&&(i[q.value]=q.value),ie.value&&(i[ie.value]=q.value||ie.value);const c=Array.isArray(n)?n.map(u=>{const s=u==null?void 0:u.department;let _="";return s&&typeof s=="object"?_=(s==null?void 0:s._id)||(s==null?void 0:s.id)||i[s==null?void 0:s.name]||"":_=i[s]||s||"",{...u,_id:String((u==null?void 0:u._id)??(u==null?void 0:u.id)??""),department:String(_)}}).filter(u=>u._id):[];let r=c;if(e&&(r=c.filter(u=>u.department===String(e)),!r.length&&R.value)){const u=c.find(s=>s._id===R.value);u?r=[u]:r=[{_id:R.value,name:Oe.value||"",department:String(e)}]}if(!r.length&&c.length&&(r=c),ke.role==="supervisor"){const u=me.value.length?me.value:R.value?[R.value]:[],s=new Set(u.map(_=>String(_)));s.size&&(r=r.filter(_=>s.has(String(_._id))))}oe.value=r,oe.value.length?R.value&&oe.value.some(u=>u._id===R.value)?P.value=R.value:P.value&&oe.value.some(u=>u._id===P.value)||(P.value=oe.value[0]._id):P.value=""}catch(e){console.error(e),oe.value=[],P.value=""}}async function ja(){var t;try{const e=await B("/api/departments"),a=e.ok?await e.json():[],l=Array.isArray(a)?a.map(r=>{const u=(r==null?void 0:r._id)??(r==null?void 0:r.id)??(r==null?void 0:r.value)??"";return{...r,_id:String(u),name:(r==null?void 0:r.name)??""}}).filter(r=>r._id):[],n=$.value||q.value;let i=l;n&&(i=l.filter(r=>r._id===n||ie.value&&r.name===ie.value),!i.length&&n&&(i=[{_id:n,name:ie.value||((t=l.find(r=>r._id===n))==null?void 0:t.name)||""}])),ee.value=i.length?i:l,ee.value.length?ee.value.some(r=>r._id===$.value)||($.value=ee.value[0]._id):!$.value&&n&&($.value=n);const c=$.value||q.value||(ee.value.length?ee.value[0]._id:"");await Jt(c)}catch(e){console.error(e)}}function Ce(){return Ot.value?we():""}async function xa(){if(ke.role!=="supervisor"){q.value="",ie.value="",R.value="",Oe.value="",me.value=[],Ue.value=null;return}const t=Ce();if(!t){q.value="",ie.value="",R.value="",Oe.value="",me.value=[],Ue.value=null;return}let e=null;try{const u=await B(`/api/employees/${t}`);if(!u.ok)throw new Error("Failed to fetch supervisor context");e=await u.json()}catch(u){console.error(u),Ue.value=null}Ue.value=e||null;const a=e==null?void 0:e.department;let l="",n="";if(a&&typeof a=="object")l=(a==null?void 0:a._id)||(a==null?void 0:a.id)||(a==null?void 0:a.value)||"",n=(a==null?void 0:a.name)||(e==null?void 0:e.departmentName)||"";else if(typeof a=="string"){const u=ee.value.find(s=>String(s==null?void 0:s._id)===a||String((s==null?void 0:s.id)??"")===a||(s==null?void 0:s.code)===a||(s==null?void 0:s.name)===a);l=(u==null?void 0:u._id)||(u==null?void 0:u.id)||a,n=(u==null?void 0:u.name)||(e==null?void 0:e.departmentName)||a}q.value=l?String(l):"",ie.value=n?String(n):"",q.value?$.value=q.value:$.value="";const i=e==null?void 0:e.subDepartment;let c="",r="";if(i&&typeof i=="object")c=(i==null?void 0:i._id)||(i==null?void 0:i.id)||(i==null?void 0:i.value)||"",r=(i==null?void 0:i.name)||(e==null?void 0:e.subDepartmentName)||"";else if(typeof i=="string"){const u=oe.value.find(s=>String(s==null?void 0:s._id)===i||String((s==null?void 0:s.id)??"")===i||(s==null?void 0:s.code)===i||(s==null?void 0:s.name)===i);c=(u==null?void 0:u._id)||(u==null?void 0:u.id)||i,r=(u==null?void 0:u.name)||(e==null?void 0:e.subDepartmentName)||i}R.value=c?String(c):"",Oe.value=r?String(r):"",R.value?P.value=R.value:P.value="",await Ma(t)}async function Ma(t=""){if(ke.role!=="supervisor"){me.value=[];return}const e=t||Ce();if(!e){me.value=R.value?[String(R.value)]:[];return}try{const a=await B(`/api/employees?supervisor=${e}`);if(!a.ok)throw new Error("Failed to fetch direct reports");const l=await a.json(),n=Array.isArray(l)?l:[],i=new Set,c=[],r=u=>{if(!u&&u!==0)return;const s=String(u);s&&(i.has(s)||(i.add(s),c.push(s)))};n.forEach(u=>{const s=u==null?void 0:u.subDepartment;r(s&&typeof s=="object"?(s==null?void 0:s._id)||(s==null?void 0:s.id)||(s==null?void 0:s.value):s)}),r(R.value),me.value=c}catch(a){console.error(a),me.value=R.value?[String(R.value)]:[]}}function Et(t){const e=String(t);v.value[e]||(v.value[e]={});const a=x.value.find(n=>String(n._id)===e)||{},l={shiftId:"",department:a.departmentId||"",subDepartment:a.subDepartmentId||""};te.value.forEach(n=>{v.value[e][n.date]?(v.value[e][n.date].shiftId=v.value[e][n.date].shiftId||"",v.value[e][n.date].department=v.value[e][n.date].department||l.department,v.value[e][n.date].subDepartment=v.value[e][n.date].subDepartment||l.subDepartment):v.value[e][n.date]={...l}})}function Na(){v.value={},Fe.value=[],st.value=null,nt.value=new Set,Ie.value=[]}async function ne({reset:t=!1}={}){let e=Tt.value;if(!e.length&&x.value.length){const r=(Z.value-1)*ce.value,u=r+ce.value;e=x.value.slice(r,u).map(s=>String(s._id))}const a=e.length>0;if(t&&Na(),!(t||!a||e.some(r=>!nt.value.has(r)))||ht.value)return;ht.value=!0;const n=Ce(),i=[`month=${U.value}`];(a||n)&&(i.push(`page=${Z.value}`),i.push(`limit=${ce.value}`),i.push(`employeeIds=${e.join(",")}`)),n&&i.push(`supervisor=${n}`),Q.value&&re.value&&i.push("includeSelf=true");const c=`?${i.join("&")}`;try{const r=await B(`/api/schedules/monthly${c}`);if(!r.ok)throw new Error("Failed to fetch schedules");const u=await r.json(),s=Array.isArray(u)?u:Array.isArray(u==null?void 0:u.schedules)?u.schedules:[],_=Array.isArray(u)?null:u==null?void 0:u.publishSummary;st.value=_?{status:_.status||"draft",pendingEmployees:_.pendingEmployees||[],disputedEmployees:_.disputedEmployees||[],publishedAt:_.publishedAt||null,hasSchedules:_.hasSchedules??!1,totalEmployees:_.totalEmployees??0,allEmployeesConfirmed:_.allEmployeesConfirmed??!1}:null,Fe.value=s;const C=new Set(e);e.forEach(k=>Et(k)),s.forEach(k=>{var M;const ae=((M=k.employee)==null?void 0:M._id)||k.employee;if(!ae)return;const J=String(ae);if(!C.has(J))return;Et(J);const o=G(k.date).date(),m=x.value.find(H=>String(H._id)===J)||{};v.value[J][o]={id:k._id,shiftId:k.shiftId,department:k.department||m.departmentId,subDepartment:k.subDepartment||m.subDepartmentId}});const A=[`month=${U.value}`];(a||n)&&A.push(`employeeIds=${e.join(",")}`),Q.value&&re.value&&A.push("includeSelf=true"),n&&A.push(`supervisor=${n}`);const L=$.value,z=P.value;L&&A.push(`department=${L}`),z&&A.push(`subDepartment=${z}`);const b=`?${A.join("&")}`,D=await B(`/api/schedules/leave-approvals${b}`);if(D!=null&&D.ok&&typeof D.json=="function"){const k=await D.json(),ae=Array.isArray(k==null?void 0:k.approvals)?k.approvals:[],J=Array.isArray(k==null?void 0:k.leaves)?k.leaves:[];Ie.value=ae;const o=G(`${U.value}-01`).startOf("day"),m=o.endOf("month").startOf("day");J.forEach(M=>{var Xe,Ze,et;if(M.status!=="approved")return;const H=((Xe=M.employee)==null?void 0:Xe._id)||M.employee;if(!H)return;const K=String(H);if(!(C.size>0?C.has(K):x.value.some(ge=>String(ge==null?void 0:ge._id)===K)))return;Et(K);const Pe=G(M.startDate).startOf("day"),Re=G(M.endDate).startOf("day");if(!Pe.isValid()||!Re.isValid())return;let De=Pe.isBefore(o)?o:Pe;const ct=Re.isAfter(m)?m:Re;for(;!De.isAfter(ct);){const ge=De.date(),tt=(et=(Ze=v.value)==null?void 0:Ze[K])==null?void 0:et[ge];tt&&(tt.leave={type:M.leaveType,startDate:M.startDate,endDate:M.endDate,excludesHours:!0}),De=De.add(1,"day")}})}else Ie.value=[];const Y=Ce()||we();if(Q.value&&re.value&&Y){const k=s.some(J=>{var m;const o=((m=J==null?void 0:J.employee)==null?void 0:m._id)||(J==null?void 0:J.employee);return o&&String(o)===Y}),ae=[U.value,$.value||"",P.value||""].join("|");k?je.value&&(je.value=""):je.value!==ae&&(He("尚未為主管建立班表，請先建立排班。"),je.value=ae)}else je.value&&(je.value="");const Ne=new Set(nt.value);e.forEach(k=>Ne.add(k)),nt.value=Ne,ot()}catch(r){console.error(r),ue.error("取得排班資料失敗"),Fe.value=[]}finally{ht.value=!1}}function Pa(t){Z.value=t,ne()}function Ra(t){ce.value=t,Z.value=1,ne()}async function Ta(t){var n;if(!t)return;F.visible=!1,F.doc=null;const e=await B(`/api/approvals/${t}`);if(!e.ok)return;const a=await e.json();F.doc=a,F.visible=!0,(Array.isArray((n=F.doc)==null?void 0:n.steps)?F.doc.steps:[]).forEach(i=>{(Array.isArray(i==null?void 0:i.approvers)?i.approvers:[]).forEach(r=>{var u,s;(u=r==null?void 0:r.approver)!=null&&u._id&&((s=r==null?void 0:r.approver)!=null&&s.name)&&(mt[r.approver._id]=r.approver.name)})})}function Kt(t){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:v.value,employees:x.value,days:te.value,shifts:fe.value})),_a.push({name:t==="week"?"PreviewWeek":"PreviewMonth"})}async function Wt(t){try{const e=await B(`/api/schedules/export?month=${U.value}&format=${t}`);if(!e.ok)throw new Error;const a=await e.blob(),l=URL.createObjectURL(a),n=document.createElement("a");n.href=l,n.download=`schedules-${U.value}.${t==="excel"?"xlsx":"pdf"}`,n.click(),URL.revokeObjectURL(l)}catch{ue.error("匯出失敗")}}async function Fa(t,e,a){const l=`${U.value}-${String(e).padStart(2,"0")}`,n=v.value[t][e];if(n!=null&&n.leave){He("該日已核准請假，無法調整排班");return}const i=(n==null?void 0:n.shiftId)??"";if(n&&n.id)try{const c=await B(`/api/schedules/${n.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:a,department:n.department,subDepartment:n.subDepartment})});c.ok||await rt(c,"更新排班失敗",t,e,i)}catch{await rt(null,"更新排班失敗",t,e,i)}else try{const c=await B("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:t,date:l,shiftId:a,department:n.department,subDepartment:n.subDepartment})});if(c.ok){const r=await c.json();v.value[t][e]={id:r._id,shiftId:r.shiftId,department:n.department,subDepartment:n.subDepartment}}else await rt(c,"新增排班失敗",t,e,i)}catch{await rt(null,"新增排班失敗",t,e,i)}}async function Oa(){P.value="",await Jt($.value),await dt($.value,""),Z.value=1,await ne({reset:!0})}async function Ua(){await dt($.value,P.value),Z.value=1,await ne({reset:!0})}async function rt(t,e,a,l,n){v.value[a]||(v.value[a]={});const i=v.value[a][l]||{shiftId:"",department:"",subDepartment:""};i.shiftId=n,v.value[a][l]=i;let c="";try{if(t){const r=await t.json();c=(r==null?void 0:r.error)||""}}catch{}c==="employee conflict"?Ae.alert("人員衝突"):c==="department overlap"?Ae.alert("跨區重複"):c==="leave conflict"?Ae.alert("請假衝突"):ue.error(e)}async function qt(t,e="批次套用失敗"){let a="";try{if(t){const l=await t.json();a=(l==null?void 0:l.error)||""}}catch{}a==="employee conflict"?ue.warning("部分員工既有排班已更新，請重新整理檢查"):a==="department overlap"?Ae.alert("部門或單位與既有資料不一致，無法套用"):a==="leave conflict"?Ae.alert("選取日期包含已核准請假，無法套用"):a?ue.error(a):ue.error(e)}async function La(){if(!bt.value){Ee("請先選取要套用的儲存格");return}if(!Je.value){Ee("請選擇欲套用的班別");return}const t=[];if(gt.value.forEach(l=>{var s;const{empId:n,day:i}=_t(l),c=(s=v.value[n])==null?void 0:s[i];if(!c||c.leave)return;const r=he.value||c.department||"";let u=c.subDepartment||"";he.value?u=de.value||"":de.value&&(u=de.value),t.push({employee:n,day:i,date:`${U.value}-${String(i).padStart(2,"0")}`,shiftId:Je.value,department:r,subDepartment:u})}),!t.length){He("選取的儲存格皆無需更新");return}const e=new Map;t.forEach(l=>{e.set(ye(l.employee,l.day),l)}),lt.value=!0;const a=qa.service({fullscreen:!0,lock:!0,text:"批次套用中..."});try{let l;try{l=await B("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:t.map(({day:i,...c})=>c)})})}catch{await qt(null);return}if(!l.ok){await qt(l);return}const n=await l.json();if(!Array.isArray(n)||!n.length){He("沒有可更新的資料");return}n.forEach(i=>{var C;const c=((C=i.employee)==null?void 0:C._id)||i.employee,r=G(i.date).date();v.value[c]||(v.value[c]={});const u=ye(c,r),s=e.get(u)||{},_=v.value[c][r]||{};v.value[c][r]={..._,id:i._id||s.id||_.id,shiftId:i.shiftId||s.shiftId||_.shiftId,department:s.department??i.department??_.department??"",subDepartment:s.subDepartment??i.subDepartment??_.subDepartment??""},delete v.value[c][r].leave}),kt("批次套用完成")}finally{a==null||a.close(),lt.value=!1}}function _e(t){return fe.value.find(e=>e._id===t)}function ut(t){if(!t)return"";const e=t.code??"",a=t.name??"";return!e&&!a?"":a?`${e}(${a})`:e}function Ct(t){const e=t&&typeof t=="object"?t:_e(t);return e?Ga(e):{}}function Ht(t){return oe.value.filter(e=>e.department===t)}async function dt(t="",e=""){var r;const a=Ce(),l=[],n=t||$.value||q.value,i=e||P.value;a&&l.push(`supervisor=${a}`),n&&l.push(`department=${n}`),i&&l.push(`subDepartment=${i}`);const c=`/api/employees${l.length?`?${l.join("&")}`:""}`;try{const u=await B(c);if(!u.ok)throw new Error("Failed to fetch employees");const s=typeof u.json=="function"?await u.json():[],_=Array.isArray(s)?s:[],C=ee.value.reduce((b,D)=>(b[D._id]=D.name,b),{}),A=oe.value.reduce((b,D)=>(b[D._id]=D.name,b),{}),L=_.map(b=>{const D=(b==null?void 0:b._id)??(b==null?void 0:b.id)??"",Y=(b==null?void 0:b.department)??"",Qe=(b==null?void 0:b.subDepartment)??"",Ne=D?String(D):"",k=Y?String(Y):"",ae=Qe?String(Qe):"";return{_id:Ne,name:b.name,departmentId:k,subDepartmentId:ae,department:C[k]||"",subDepartment:A[ae]||""}});let z=Pt(L);if(Q.value&&re.value){const b=a?String(a):"";b&&!z.some(D=>D._id===b)&&(z=Pt([...z,{_id:b,name:((r=Ue.value)==null?void 0:r.name)||"主管本人",departmentId:q.value||"",subDepartmentId:R.value||"",department:ie.value||"",subDepartment:Oe.value||""}]))}x.value=z,ot()}catch(u){console.error(u),ue.error("取得員工資料失敗")}}async function Ge(){try{const t=[`month=${U.value}`];Q.value&&re.value&&t.push("includeSelf=true");const e=await B(`/api/schedules/summary?${t.join("&")}`);if(e.ok){const a=await e.json();zt.value={direct:a.length,unscheduled:a.filter(l=>l.shiftCount===0).length,onLeave:a.filter(l=>l.leaveCount>0).length}}}catch(t){console.error(t)}}async function Ya(t){const e=t?G(t):G();U.value=e.isValid()?e.format("YYYY-MM"):G().format("YYYY-MM"),Z.value=1,await ne({reset:!0}),await Ge()}return Ja(async()=>{const t=we();xt(t)===!0&&re.value&&(Q.value=!0);try{await Ge(),await za(),await xa(),await ja(),await dt($.value,P.value),await ne({reset:!0})}finally{$t=!1}}),(t,e)=>{const a=V("el-date-picker"),l=V("el-option"),n=V("el-select"),i=V("el-switch"),c=V("el-step"),r=V("el-steps"),u=V("el-progress"),s=V("el-button"),_=V("el-input"),C=V("el-table-column"),A=V("el-checkbox"),L=V("el-tag"),z=V("el-popover"),b=V("el-table"),D=V("el-pagination"),Y=V("el-divider"),Qe=V("el-descriptions-item"),Ne=V("el-descriptions"),k=V("el-timeline-item"),ae=V("el-timeline"),J=V("el-dialog");return p(),y(T,null,[d("div",al,[e[48]||(e[48]=d("div",{class:"page-header"},[d("h1",{class:"page-title"},"排班管理"),d("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),f(tl,{summary:zt.value},null,8,["summary"]),d("div",ll,[e[22]||(e[22]=d("div",{class:"filters-header"},[d("h3",{class:"filters-title"},"篩選條件")],-1)),d("div",sl,[d("div",nl,[e[18]||(e[18]=d("label",{class:"filter-label"},"選擇月份",-1)),f(a,{modelValue:U.value,"onUpdate:modelValue":e[0]||(e[0]=o=>U.value=o),type:"month","value-format":"YYYY-MM",onChange:Ya,class:"modern-date-picker"},null,8,["modelValue"])]),d("div",ol,[e[19]||(e[19]=d("label",{class:"filter-label"},"部門",-1)),f(n,{modelValue:$.value,"onUpdate:modelValue":e[1]||(e[1]=o=>$.value=o),placeholder:"請選擇部門",onChange:Oa,disabled:!0,class:"modern-select"},{default:h(()=>[(p(!0),y(T,null,W(ee.value,o=>(p(),O(l,{key:o._id,label:o.name,value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),d("div",il,[e[20]||(e[20]=d("label",{class:"filter-label"},"單位",-1)),f(n,{modelValue:P.value,"onUpdate:modelValue":e[2]||(e[2]=o=>P.value=o),placeholder:"請選擇單位",onChange:Ua,class:"modern-select"},{default:h(()=>[(p(!0),y(T,null,W(ya.value,o=>(p(),O(l,{key:o._id,label:o.name,value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),re.value?(p(),y("div",rl,[e[21]||(e[21]=d("label",{class:"filter-label"},"包含自己",-1)),f(i,{modelValue:Q.value,"onUpdate:modelValue":e[3]||(e[3]=o=>Q.value=o),"active-text":"是","inactive-text":"否","inline-prompt":""},null,8,["modelValue"])])):N("",!0)])]),be(ze)?(p(),y("div",ul,[d("div",dl,[e[23]||(e[23]=d("div",{class:"publish-header-text"},[d("h3",{class:"publish-title"},"發布狀態"),d("p",{class:"publish-subtitle"},"追蹤班表送審、回覆與鎖定流程")],-1)),d("span",{class:Zt(["status-badge",`status-${E.value.status}`]),"data-test":"publish-status-badge"},S(ga.value),3)]),d("div",cl,[f(r,{active:ba.value,"finish-status":"success","align-center":""},{default:h(()=>[f(c,{title:"草稿",description:"建立班表草稿",status:it.value.draft},null,8,["status"]),f(c,{title:"待確認",description:Sa.value,status:it.value.pending},null,8,["description","status"]),f(c,{title:"異議",description:wa.value,status:it.value.disputed},null,8,["description","status"]),f(c,{title:"完成",description:ka.value,status:it.value.finalized},null,8,["description","status"])]),_:1},8,["active"])]),d("div",pl,[E.value.publishedAt?(p(),y("p",vl," 最近發布："+S(Ea(E.value.publishedAt)),1)):(p(),y("p",fl,"本月尚未發布。")),wt.value>0&&E.value.status!=="finalized"?(p(),y("div",ml,[f(u,{percentage:wt.value,"stroke-width":8,status:"success","show-text":!1},null,8,["percentage"]),d("span",hl,S(wt.value)+"% 完成",1)])):N("",!0)]),d("div",yl,[f(s,{type:"primary",class:"publish-btn",loading:Ke.value,disabled:Ut.value,onClick:Aa},{default:h(()=>e[24]||(e[24]=[I(" 發送待確認 ")])),_:1},8,["loading","disabled"]),f(s,{type:"success",plain:"",class:"publish-btn",loading:We.value,disabled:Lt.value,onClick:Ia},{default:h(()=>e[25]||(e[25]=[I(" 完成發布 ")])),_:1},8,["loading","disabled"])]),d("div",_l,[xe.value?(p(),y("div",gl,[d("div",bl,[e[26]||(e[26]=d("span",{class:"card-title"},"待回覆",-1)),d("span",Sl,S(xe.value),1)]),d("ul",wl,[(p(!0),y(T,null,W(E.value.pendingEmployees,o=>(p(),y("li",{key:o.id,class:"card-item"},[d("span",kl,S(o.name),1),d("span",El,S(o.pendingCount)+" 筆",1)]))),128))])])):N("",!0),Me.value?(p(),y("div",Cl,[d("div",Dl,[e[27]||(e[27]=d("span",{class:"card-title"},"異議",-1)),d("span",Al,S(Me.value),1)]),d("ul",Il,[(p(!0),y(T,null,W(E.value.disputedEmployees,o=>(p(),y("li",{key:o.id,class:"card-item"},[d("div",Vl,[d("span",$l,S(o.name),1),d("span",zl,S(o.disputedCount)+" 筆",1)]),o.latestNote?(p(),y("div",jl," 最新意見："+S(o.latestNote),1)):N("",!0)]))),128))])])):N("",!0),!xe.value&&!Me.value&&E.value.status!=="draft"&&E.value.status!=="finalized"?(p(),y("div",xl,e[28]||(e[28]=[d("div",{class:"card-header"},[d("span",{class:"card-title"},"回覆完成"),d("span",{class:"card-badge success"},"✓")],-1),d("p",{class:"card-message"},"所有員工已完成回覆，可執行最終發布。",-1)]))):N("",!0),E.value.status==="finalized"?(p(),y("div",Ml,e[29]||(e[29]=[d("div",{class:"card-header"},[d("span",{class:"card-title"},"已鎖定"),d("span",{class:"card-badge success"},"100%")],-1),d("p",{class:"card-message"},"班表已完成發布並鎖定。",-1)]))):N("",!0)])])):N("",!0),d("div",Nl,[d("div",Pl,[f(s,{type:"primary",class:"action-btn primary",onClick:ra,disabled:!bt.value},{default:h(()=>e[30]||(e[30]=[d("i",{class:"el-icon-close"},null,-1),I(" 清除選取 ")])),_:1},8,["disabled"]),f(s,{type:"primary",class:"action-btn primary",plain:"",onClick:pa,disabled:!x.value.length},{default:h(()=>e[31]||(e[31]=[d("i",{class:"el-icon-user"},null,-1),I(" 全選員工 ")])),_:1},8,["disabled"]),f(s,{type:"primary",class:"action-btn primary",plain:"",onClick:va,disabled:!te.value.length},{default:h(()=>e[32]||(e[32]=[d("i",{class:"el-icon-date"},null,-1),I(" 全選日期 ")])),_:1},8,["disabled"])]),d("div",Rl,[d("div",Tl,[e[33]||(e[33]=d("label",{class:"range-label"},"自訂日期範圍",-1)),f(a,{modelValue:ft.value,"onUpdate:modelValue":e[4]||(e[4]=o=>ft.value=o),type:"daterange","start-placeholder":"開始日期","end-placeholder":"結束日期","range-separator":"至","unlink-panels":"",disabled:!te.value.length,class:"modern-date-picker range-picker",onChange:fa},null,8,["modelValue","disabled"])]),f(s,{onClick:e[5]||(e[5]=o=>Kt("week")),class:"action-btn secondary"},{default:h(()=>e[34]||(e[34]=[d("i",{class:"el-icon-calendar"},null,-1),I(" 預覽週表 ")])),_:1}),f(s,{onClick:e[6]||(e[6]=o=>Kt("month")),class:"action-btn secondary"},{default:h(()=>e[35]||(e[35]=[d("i",{class:"el-icon-date"},null,-1),I(" 預覽月表 ")])),_:1}),f(s,{onClick:e[7]||(e[7]=()=>Wt("pdf")),class:"action-btn export"},{default:h(()=>e[36]||(e[36]=[d("i",{class:"el-icon-download"},null,-1),I(" 匯出 PDF ")])),_:1}),f(s,{onClick:e[8]||(e[8]=()=>Wt("excel")),class:"action-btn export"},{default:h(()=>e[37]||(e[37]=[d("i",{class:"el-icon-s-grid"},null,-1),I(" 匯出 Excel ")])),_:1})])]),d("div",Fl,[d("div",Ol,[e[39]||(e[39]=d("h3",{class:"schedule-title"},"員工排班表",-1)),d("div",Ul,[Mt.value.length?(p(!0),y(T,{key:0},W(Mt.value,o=>(p(),y("span",{key:o.key,class:"legend-item",style:pt(o.style),"data-test":"shift-legend-item"},S(o.label),5))),128)):(p(),y("span",Ll," 尚未設定班別 ")),e[38]||(e[38]=d("span",{class:"legend-item leave"},"請假",-1))]),f(_,{modelValue:Le.value,"onUpdate:modelValue":e[9]||(e[9]=o=>Le.value=o),placeholder:"搜尋員工",clearable:"",class:"employee-search"},null,8,["modelValue"]),f(n,{modelValue:Ye.value,"onUpdate:modelValue":e[10]||(e[10]=o=>Ye.value=o),placeholder:"狀態",class:"status-filter"},{default:h(()=>[f(l,{label:"全部",value:"all"}),f(l,{label:"缺班",value:"unscheduled"}),f(l,{label:"待審核請假",value:"onLeave"})]),_:1},8,["modelValue"])]),be(ze)?(p(),y("div",Yl,[f(n,{modelValue:Je.value,"onUpdate:modelValue":e[11]||(e[11]=o=>Je.value=o),placeholder:"套用班別",class:"modern-select batch-select",filterable:"","data-test":"batch-shift-select"},{default:h(()=>[(p(!0),y(T,null,W(fe.value,o=>(p(),O(l,{key:o._id,label:ut(o),value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(n,{modelValue:he.value,"onUpdate:modelValue":e[12]||(e[12]=o=>he.value=o),placeholder:"套用部門",clearable:"",class:"modern-select batch-select","data-test":"batch-dept-select"},{default:h(()=>[(p(!0),y(T,null,W(ee.value,o=>(p(),O(l,{key:o._id,label:o.name,value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(n,{modelValue:de.value,"onUpdate:modelValue":e[13]||(e[13]=o=>de.value=o),placeholder:"套用單位",clearable:"",class:"modern-select batch-select",disabled:!he.value,"data-test":"batch-subdept-select"},{default:h(()=>[(p(!0),y(T,null,W(Nt.value,o=>(p(),O(l,{key:o._id,label:o.name,value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),f(s,{type:"primary",class:"action-btn primary apply-btn",disabled:!bt.value||!Je.value||lt.value,loading:lt.value,onClick:La,"data-test":"batch-apply-button"},{default:h(()=>e[40]||(e[40]=[I(" 套用至選取 ")])),_:1},8,["disabled","loading"])])):N("",!0),f(b,{class:"modern-schedule-table",data:Rt.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"},onRowClick:e[15]||(e[15]=o=>Ft.value&&ha(o._id))},{default:h(()=>[f(C,{label:"部門／單位",width:"180",fixed:"left"},{default:h(({row:o})=>[d("div",Bl,[d("div",Jl,S(o.department),1),o.subDepartment?(p(),y("div",Kl,S(o.subDepartment),1)):N("",!0)])]),_:1}),f(C,{prop:"name",label:"員工姓名",width:"150",fixed:"left"},{default:h(({row:o})=>[d("div",Wl,[be(ze)?(p(),O(A,{key:0,class:"row-checkbox","model-value":la.value.has(o._id),onChange:m=>ua(o._id,m)},null,8,["model-value","onChange"])):N("",!0),St(o._id)==="unscheduled"?(p(),O(Dt(be(ta)),{key:1,class:"status-icon unscheduled"})):St(o._id)==="onLeave"?(p(),O(Dt(be(aa)),{key:2,class:"status-icon on-leave"})):N("",!0),I(" "+S(o.name),1)])]),_:1}),(p(!0),y(T,null,W(te.value,o=>(p(),O(C,{key:o.date,label:o.label,width:"140",align:"center"},{header:h(()=>[d("div",ql,[d("span",null,S(o.label),1),be(ze)?(p(),O(A,{key:0,class:"day-checkbox","model-value":sa.value.has(o.date),onChange:m=>da(o.date,m)},null,8,["model-value","onChange"])):N("",!0)])]),default:h(({row:m})=>{var M,H,K,le,Pe,Re,De,ct,Xe,Ze,et,ge,tt,Gt,Qt;return[!Ft.value||at.value.has(m._id)?(p(),y("div",{key:0,class:Zt(["modern-schedule-cell",[{"has-leave":(H=(M=v.value[m._id])==null?void 0:M[o.date])==null?void 0:H.leave,"missing-shift":!((le=(K=v.value[m._id])==null?void 0:K[o.date])!=null&&le.shiftId)&&!((Re=(Pe=v.value[m._id])==null?void 0:Pe[o.date])!=null&&Re.leave),"is-selected":ia(m._id,o.date),"has-shift":!((ct=(De=v.value[m._id])==null?void 0:De[o.date])!=null&&ct.leave)&&!!((Ze=(Xe=v.value[m._id])==null?void 0:Xe[o.date])!=null&&Ze.shiftId)}]]),style:pt((ge=(et=v.value[m._id])==null?void 0:et[o.date])!=null&&ge.leave?void 0:Ct((Gt=(tt=v.value[m._id])==null?void 0:tt[o.date])==null?void 0:Gt.shiftId)),title:$a(m._id,o.date)},[be(ze)?(p(),y("div",{key:0,class:"cell-selection",onClick:e[14]||(e[14]=Wa(()=>{},["stop"]))},[f(A,{"model-value":na.value.has(ye(m._id,o.date)),disabled:!qe(m._id,o.date),onChange:j=>ca(m._id,o.date,j),size:"small"},null,8,["model-value","disabled","onChange"])])):N("",!0),(Qt=v.value[m._id])!=null&&Qt[o.date]?(p(),y(T,{key:1},[v.value[m._id][o.date].leave?(p(),y("div",Gl,[f(L,{type:"warning",effect:"light",size:"small",class:"leave-tag"},{default:h(()=>e[41]||(e[41]=[I(" 休假中 ")])),_:1}),e[42]||(e[42]=d("span",{class:"leave-note"},"已核准請假，不列入工時",-1))])):be(ze)?(p(),y(T,{key:1},[f(n,{modelValue:v.value[m._id][o.date].shiftId,"onUpdate:modelValue":j=>v.value[m._id][o.date].shiftId=j,placeholder:"選擇班別",onChange:j=>Fa(m._id,o.date,j),class:"cell-select shift-select",size:"small"},{default:h(()=>[(p(!0),y(T,null,W(fe.value,j=>(p(),O(l,{key:j._id,label:ut(j),value:j._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),d("div",Ql,[f(n,{modelValue:v.value[m._id][o.date].department,"onUpdate:modelValue":j=>v.value[m._id][o.date].department=j,placeholder:"部門",size:"small",onChange:()=>v.value[m._id][o.date].subDepartment="",class:"cell-select dept-select"},{default:h(()=>[(p(!0),y(T,null,W(ee.value,j=>(p(),O(l,{key:j._id,label:j.name,value:j._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),f(n,{modelValue:v.value[m._id][o.date].subDepartment,"onUpdate:modelValue":j=>v.value[m._id][o.date].subDepartment=j,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:h(()=>[(p(!0),y(T,null,W(Ht(v.value[m._id][o.date].department),j=>(p(),O(l,{key:j._id,label:j.name,value:j._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(p(),y(T,{key:2},[_e(v.value[m._id][o.date].shiftId)?(p(),O(z,{key:0,placement:"top",trigger:"hover",width:200},{reference:h(()=>[d("div",{class:"modern-shift-tag",style:pt(Ct(_e(v.value[m._id][o.date].shiftId)))},S(ut(_e(v.value[m._id][o.date].shiftId))),5)]),default:h(()=>[d("div",Xl,[d("div",Zl,[e[43]||(e[43]=d("span",{class:"detail-label"},"上班時間：",-1)),d("span",es,S(_e(v.value[m._id][o.date].shiftId).startTime),1)]),d("div",ts,[e[44]||(e[44]=d("span",{class:"detail-label"},"下班時間：",-1)),d("span",as,S(_e(v.value[m._id][o.date].shiftId).endTime),1)]),_e(v.value[m._id][o.date].shiftId).remark?(p(),y("div",ls,[e[45]||(e[45]=d("span",{class:"detail-label"},"備註：",-1)),d("span",ss,S(_e(v.value[m._id][o.date].shiftId).remark),1)])):N("",!0)])]),_:2},1024)):N("",!0)],64)),!v.value[m._id][o.date].shiftId&&!v.value[m._id][o.date].leave?(p(),y("div",ns," 未排班 ")):N("",!0)],64)):(p(),y("span",os,"-"))],14,Hl)):(p(),y("div",is,"展開班表"))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"]),$e.value.length?(p(),y("div",rs,[f(D,{background:"",layout:"prev, pager, next, ->, sizes, total",total:$e.value.length,"page-size":ce.value,"current-page":Z.value,"page-sizes":[10,20,30,50],onCurrentChange:Pa,onSizeChange:Ra},null,8,["total","page-size","current-page"])])):N("",!0)]),Ie.value.length?(p(),y("div",us,[d("div",ds,[e[46]||(e[46]=d("h3",{class:"approval-title"},"待處理審批",-1)),d("div",cs,S(Ie.value.length)+" 項待處理",1)]),f(b,{class:"modern-approval-table",data:Ie.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:h(()=>[f(C,{label:"申請人",width:"120"},{default:h(({row:o})=>{var m;return[d("div",ps,S((m=o.applicant_employee)==null?void 0:m.name),1)]}),_:1}),f(C,{label:"申請類型",width:"150"},{default:h(({row:o})=>{var m,M;return[d("div",vs,S(Vt((m=o.form)==null?void 0:m.category,(M=o.form)==null?void 0:M.name)),1)]}),_:1}),f(C,{prop:"status",label:"狀態",width:"100"},{default:h(({row:o})=>[f(L,{type:o.status==="approved"?"success":o.status==="rejected"?"danger":"warning",class:"status-tag"},{default:h(()=>[I(S(o.status),1)]),_:2},1032,["type"])]),_:1}),f(C,{label:"操作",width:"120"},{default:h(({row:o})=>[f(s,{size:"small",onClick:m=>Ta(o._id),disabled:!o._id},{default:h(()=>e[47]||(e[47]=[I(" 查看 ")])),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"])])):N("",!0)]),f(J,{modelValue:F.visible,"onUpdate:modelValue":e[17]||(e[17]=o=>F.visible=o),title:"申請單明細",width:"760px"},{footer:h(()=>[f(s,{onClick:e[16]||(e[16]=o=>F.visible=!1)},{default:h(()=>e[54]||(e[54]=[I("關閉")])),_:1})]),default:h(()=>{var o,m,M;return[F.doc?(p(),y("div",fs,[d("p",ms,[e[49]||(e[49]=d("b",null,"表單：",-1)),I(S((o=F.doc.form)==null?void 0:o.name)+"（"+S((m=F.doc.form)==null?void 0:m.category)+"）",1)]),d("p",hs,[e[50]||(e[50]=d("b",null,"申請人：",-1)),I(S(((M=F.doc.applicant_employee)==null?void 0:M.name)||"-"),1)]),d("p",ys,[e[51]||(e[51]=d("b",null,"狀態：",-1)),I(S(Bt(F.doc.status)),1)]),f(Y,{"content-position":"left"},{default:h(()=>e[52]||(e[52]=[I("填寫內容")])),_:1}),f(Ne,{column:1,size:"small",border:""},{default:h(()=>{var H;return[(p(!0),y(T,null,W(((H=F.doc.form)==null?void 0:H.fields)||[],K=>(p(),O(Qe,{key:K._id,label:K.label},{default:h(()=>{var le;return[d("span",null,S(vt((le=F.doc.form_data)==null?void 0:le[K._id])),1)]}),_:2},1032,["label"]))),128))]}),_:1}),f(Y,{"content-position":"left"},{default:h(()=>e[53]||(e[53]=[I("流程")])),_:1}),f(ae,null,{default:h(()=>[(p(!0),y(T,null,W(F.doc.steps,(H,K)=>(p(),O(k,{key:K,timestamp:`第 ${K+1} 關`,type:K===F.doc.current_step_index?"primary":"info"},{default:h(()=>[d("div",_s,[d("span",gs,"需全員同意："+S(H.all_must_approve?"是":"否"),1),d("span",null,"必簽："+S(H.is_required?"是":"否"),1)]),f(b,{data:H.approvers,size:"small",border:""},{default:h(()=>[f(C,{label:"審核人",width:"200"},{default:h(({row:le})=>[I(S(Va(le.approver)),1)]),_:1}),f(C,{label:"決議",width:"120"},{default:h(({row:le})=>[I(S(Bt(le.decision)),1)]),_:1}),f(C,{label:"時間",width:"200"},{default:h(({row:le})=>[I(S(Te(le.decided_at)),1)]),_:1}),f(C,{prop:"comment",label:"意見"})]),_:2},1032,["data"])]),_:2},1032,["timestamp","type"]))),128))]),_:1})])):N("",!0)]}),_:1},8,["modelValue"])],64)}}},Ds=ea(Ss,[["__scopeId","data-v-b7d12543"]]);export{Ds as default};
