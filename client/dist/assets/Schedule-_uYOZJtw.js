import{_ as pt,v as L,D as Pt,G as mt,H as ft,c as b,o as p,F as j,m as Y,e as $,l as A,w as h,b as d,I as Fe,J as Wt,t as S,r as g,K as T,q as ct,k as Se,j as Jt,d as f,x as W,h as de,E as G,u as Kt,g as k,n as vt,f as qt,z as we,L as Ht}from"./index-Bc12ixp6.js";import{a as z}from"./api-BuNyVVPZ.js";import{u as Gt}from"./auth-CI9_ws1P.js";const Qt={class:"dashboard"},Xt={class:"metric-label"},Zt={class:"metric-value"},ea=Object.assign({name:"ScheduleDashboard"},{__name:"ScheduleDashboard",props:{summary:{type:Object,default:()=>({direct:0,unscheduled:0,onLeave:0})}},setup(Be){const pe=Be,Me=L(()=>[{label:"直屬員工數",value:pe.summary.direct,icon:Pt,color:"#0f766e"},{label:"未排班員工",value:pe.summary.unscheduled,icon:mt,color:"#dc2626"},{label:"請假中員工",value:pe.summary.onLeave,icon:ft,color:"#f59e0b"}]);return(O,m)=>{const K=$("el-card");return p(),b("div",Qt,[(p(!0),b(j,null,Y(Me.value,D=>(p(),A(K,{class:"metric-card",key:D.label},{default:h(()=>[(p(),A(Fe(D.icon),{class:"metric-icon",style:Wt({color:D.color})},null,8,["style"])),d("div",Xt,S(D.label),1),d("div",Zt,S(D.value),1)]),_:2},1024))),128))])}}}),ta=pt(ea,[["__scopeId","data-v-ceb5c889"]]),aa={class:"schedule-page"},la={class:"filters-card"},sa={class:"filters-content"},na={class:"filter-group"},oa={class:"filter-group"},ra={class:"filter-group"},ia={key:0,class:"filter-group include-self-group"},ua={class:"actions-card"},da={class:"primary-actions"},ca={class:"secondary-actions"},va={class:"range-picker-wrapper"},pa={class:"schedule-card"},ma={class:"schedule-header"},fa={class:"schedule-legend","data-test":"schedule-legend"},ha={key:1,class:"legend-empty","data-test":"shift-legend-empty"},ya={key:0,class:"batch-toolbar"},_a={class:"employee-info"},ba={class:"department-name"},ga={key:0,class:"sub-department"},Sa={class:"employee-name"},wa={class:"day-header"},ka=["title"],Da={key:0,class:"leave-indicator","data-test":"leave-indicator"},Ca={class:"department-selects"},Va={class:"shift-details"},Ia={class:"detail-row"},Ea={class:"detail-value"},$a={class:"detail-row"},Aa={class:"detail-value"},ja={key:0,class:"detail-row"},xa={class:"detail-value"},Ma={class:"modern-shift-tag"},Ua={key:3,class:"missing-label"},Na={key:2,class:"empty-cell"},za={key:1,class:"modern-schedule-cell collapsed-cell"},La={key:0,class:"approval-card"},Oa={class:"approval-header"},Ta={class:"approval-count"},Ya={class:"applicant-name"},Ra={class:"form-type"},Fa={key:0},Ba={class:"mb-2"},Pa={class:"mb-2"},Wa={class:"mb-2"},Ja={class:"mb-1"},Ka={class:"mr-2"},qa={__name:"Schedule",setup(Be){const pe=t=>t?new Date(t).toLocaleString():"-",Me=t=>Array.isArray(t)?t.join(", "):t??"-",O=g(T().format("YYYY-MM")),m=g({}),K=g([]),D=g([]),ke=g([]),R=g([]),q=g([]),I=g(""),x=g(""),M=g(""),H=g(""),C=g(""),me=g(""),ee=g([]),fe=g(null),ce=g(!1),Pe=g({direct:0,unscheduled:0,onLeave:0}),De=g(""),Ce=g("all"),Ve=g(new Set),te=g(new Set),Q=g(new Set),re=g(new Set),Ue=g([]),he=g(""),ae=g(""),X=g(""),Ie=g(!1),E=ct({visible:!1,doc:null}),Ne=ct({}),ht=L(()=>te.value),yt=L(()=>Q.value),_t=L(()=>re.value),We=L(()=>{if(!Array.isArray(K.value)||!K.value.length)return[];const t=new Set;return K.value.reduce((e,a)=>{if(!a)return e;const l=xe(a)||a.name||a.code||"未命名班別",o=String(a._id||`${a.code??""}-${a.name??""}`);return!o||t.has(o)||(t.add(o),e.push({key:o,label:l,className:at(a)||"shift-normal"})),e},[])}),ie=(t,e)=>`${t}-${e}`,ze=t=>{const[e,a]=String(t).split("-");return{empId:e,day:Number(a)}},Ee=(t,e)=>{const a=m.value[t];if(!a)return!1;const l=a[e];return l?!l.leave:!1},Le=L(()=>{const t=new Set,e=Z.value,a=D.value,l=(o,r)=>{Ee(o,r)&&t.add(ie(o,r))};return re.value.forEach(o=>{const{empId:r,day:c}=ze(o);l(r,c)}),te.value.forEach(o=>{e.forEach(r=>l(o,r.date))}),Q.value.forEach(o=>{a.forEach(r=>l(r._id,o))}),t}),Oe=L(()=>Le.value.size>0),Je=L(()=>ae.value?lt(ae.value):[]),bt=(t,e)=>Le.value.has(ie(t,e)),$e=()=>{const t=new Set(D.value.map(l=>l._id)),e=new Set(Z.value.map(l=>l.date));te.value=new Set(Array.from(te.value).filter(l=>t.has(l))),Q.value=new Set(Array.from(Q.value).filter(l=>e.has(l)));const a=new Set;re.value.forEach(l=>{const{empId:o,day:r}=ze(l);t.has(o)&&e.has(r)&&Ee(o,r)&&a.add(ie(o,r))}),re.value=a},gt=()=>{te.value=new Set,Q.value=new Set,re.value=new Set,Ue.value=[]},St=(t,e)=>{const a=new Set(te.value);(typeof e=="boolean"?e:!a.has(t))?a.add(t):a.delete(t),te.value=a},wt=(t,e)=>{const a=new Set(Q.value);(typeof e=="boolean"?e:!a.has(t))?a.add(t):a.delete(t),Q.value=a},kt=(t,e,a)=>{if(!Ee(t,e))return;const l=ie(t,e),o=new Set(re.value);(typeof a=="boolean"?a:!o.has(l))?o.add(l):o.delete(l),re.value=o},Dt=()=>{te.value=new Set(D.value.map(t=>t._id))},Ct=()=>{Q.value=new Set(Z.value.map(t=>t.date))},Ke=t=>[...t].sort((e,a)=>{const l=(e.department||"").localeCompare(a.department||"");return l!==0?l:(e.name||"").localeCompare(a.name||"")}),Vt=t=>{if(!Array.isArray(t)||t.length!==2)return;const[e,a]=t;if(!e||!a)return;const l=T(`${O.value}-01`),o=T(e),r=T(a);if(!o.isValid()||!r.isValid())return;const c=l.endOf("month");let u=o.isBefore(l)?l:o;const n=[];for(;(u.isBefore(r)||u.isSame(r,"day"))&&(u.year()===l.year()&&u.month()===l.month()&&n.push(u.date()),!u.isSame(c,"day"));)u=u.add(1,"day");Q.value=new Set(n)};Se(ae,(t,e)=>{t!==e&&(X.value="")}),Se(Je,t=>{X.value&&!t.some(e=>e._id===X.value)&&(X.value="")}),Se(ce,async(t,e)=>{t!==e&&ye.value&&(await ge(I.value,x.value),await be(),await Re())});const Te=t=>{const e=m.value[t]||{},a=Object.values(e),l=a.some(r=>r.shiftId),o=a.some(r=>r.leave);return l?o?"onLeave":"scheduled":"unscheduled"},It=L(()=>{let t=De.value?D.value.filter(e=>e.name.includes(De.value)):D.value;return Ce.value!=="all"&&(t=t.filter(e=>Te(e._id)===Ce.value)),t}),qe=L(()=>D.value.length>50),Et=t=>{Ve.value.has(t)?Ve.value.delete(t):Ve.value.add(t)},$t=L(()=>q.value.filter(t=>t.department===I.value)),At=Kt(),ve=Gt();ve.loadUser();const He=L(()=>["supervisor","admin"].includes(ve.role)),ye=L(()=>ve.role==="supervisor"),_e=He,Ge=t=>{var l,o;const e=(l=G)==null?void 0:l.warning;typeof e=="function"&&e(t);const a=typeof window<"u"?(o=window.ElMessage)==null?void 0:o.warning:void 0;typeof a=="function"&&a!==e&&a(t)},Ye=t=>{var l,o;const e=(l=G)==null?void 0:l.info;typeof e=="function"&&e(t);const a=typeof window<"u"?(o=window.ElMessage)==null?void 0:o.info:void 0;typeof a=="function"&&a!==e&&a(t)},jt=t=>{var l,o;const e=(l=G)==null?void 0:l.success;typeof e=="function"&&e(t);const a=typeof window<"u"?(o=window.ElMessage)==null?void 0:o.success:void 0;typeof a=="function"&&a!==e&&a(t)},Qe=t=>({pending:"待簽核",approved:"已核可",rejected:"已否決",returned:"已退簽"})[t]||t||"-",xt=t=>{if(t&&typeof t=="object"){const e=t._id||t.employeeId||"";return t.name||Ne[e]||e}return Ne[t]||t||"-"},Mt=(t,e)=>{var l,o;const a=(o=(l=m.value)==null?void 0:l[t])==null?void 0:o[e];return a!=null&&a.leave?"已核准請假，該日不列入工作時數":""},Z=L(()=>{const t=T(O.value+"-01"),e=t.endOf("month").date(),a=["日","一","二","三","四","五","六"];return Array.from({length:e},(l,o)=>{const r=o+1,c=a[t.date(r).day()];return{date:r,label:`${r}(${c})`}})});Se(D,$e),Se(Z,$e);async function Ut(){const t=await z("/api/shifts");if(t.ok){const e=await t.json(),a=Array.isArray(e==null?void 0:e.shifts)?e.shifts:Array.isArray(e)?e:[];Array.isArray(a)&&(K.value=a.map(l=>({_id:l._id,code:l.code,name:l.name??"",startTime:l.startTime,endTime:l.endTime,remark:l.remark})))}else t.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",t.status)}async function Xe(t=""){try{const e=t||M.value,a=e?`/api/sub-departments?department=${e}`:"/api/sub-departments",l=await z(a);if(!l.ok)throw new Error("Failed to fetch sub departments");const o=await l.json(),r=R.value.reduce((n,i)=>{const y=String(i._id);return n[y]=y,i.name&&(n[i.name]=y),n},{});M.value&&(r[M.value]=M.value),H.value&&(r[H.value]=M.value||H.value);const c=Array.isArray(o)?o.map(n=>{const i=n==null?void 0:n.department;let y="";return i&&typeof i=="object"?y=(i==null?void 0:i._id)||(i==null?void 0:i.id)||r[i==null?void 0:i.name]||"":y=r[i]||i||"",{...n,_id:String((n==null?void 0:n._id)??(n==null?void 0:n.id)??""),department:String(y)}}).filter(n=>n._id):[];let u=c;if(e&&(u=c.filter(n=>n.department===String(e)),!u.length&&C.value)){const n=c.find(i=>i._id===C.value);n?u=[n]:u=[{_id:C.value,name:me.value||"",department:String(e)}]}if(ve.role==="supervisor"){const n=ee.value.length?ee.value:C.value?[C.value]:[],i=new Set(n.map(y=>String(y)));i.size?u=u.filter(y=>i.has(String(y._id))):u=[]}q.value=u,q.value.length?C.value&&q.value.some(n=>n._id===C.value)?x.value=C.value:x.value&&q.value.some(n=>n._id===x.value)||(x.value=q.value[0]._id):x.value=""}catch(e){console.error(e),q.value=[],x.value=""}}async function Nt(){var t;try{const e=await z("/api/departments"),a=e.ok?await e.json():[],l=Array.isArray(a)?a.map(u=>{const n=(u==null?void 0:u._id)??(u==null?void 0:u.id)??(u==null?void 0:u.value)??"";return{...u,_id:String(n),name:(u==null?void 0:u.name)??""}}).filter(u=>u._id):[],o=I.value||M.value;let r=l;o&&(r=l.filter(u=>u._id===o||H.value&&u.name===H.value),!r.length&&o&&(r=[{_id:o,name:H.value||((t=l.find(u=>u._id===o))==null?void 0:t.name)||""}])),R.value=r.length?r:l,R.value.length?R.value.some(u=>u._id===I.value)||(I.value=R.value[0]._id):!I.value&&o&&(I.value=o);const c=I.value||M.value||(R.value.length?R.value[0]._id:"");await Xe(c)}catch(e){console.error(e)}}const Ae=()=>{var a,l;if(!He.value||typeof window>"u")return"";const t=(a=window.sessionStorage)==null?void 0:a.getItem("employeeId");if(t&&t!=="undefined")return t;const e=(l=window.localStorage)==null?void 0:l.getItem("employeeId");return e&&e!=="undefined"?e:""};async function zt(){if(ve.role!=="supervisor"){M.value="",H.value="",C.value="",me.value="",ee.value=[],fe.value=null;return}const t=Ae();if(!t){M.value="",H.value="",C.value="",me.value="",ee.value=[],fe.value=null;return}let e=null;try{const n=await z(`/api/employees/${t}`);if(!n.ok)throw new Error("Failed to fetch supervisor context");e=await n.json()}catch(n){console.error(n),fe.value=null}fe.value=e||null;const a=e==null?void 0:e.department;let l="",o="";if(a&&typeof a=="object")l=(a==null?void 0:a._id)||(a==null?void 0:a.id)||(a==null?void 0:a.value)||"",o=(a==null?void 0:a.name)||(e==null?void 0:e.departmentName)||"";else if(typeof a=="string"){const n=R.value.find(i=>String(i==null?void 0:i._id)===a||String((i==null?void 0:i.id)??"")===a||(i==null?void 0:i.code)===a||(i==null?void 0:i.name)===a);l=(n==null?void 0:n._id)||(n==null?void 0:n.id)||a,o=(n==null?void 0:n.name)||(e==null?void 0:e.departmentName)||a}M.value=l?String(l):"",H.value=o?String(o):"",M.value?I.value=M.value:I.value="";const r=e==null?void 0:e.subDepartment;let c="",u="";if(r&&typeof r=="object")c=(r==null?void 0:r._id)||(r==null?void 0:r.id)||(r==null?void 0:r.value)||"",u=(r==null?void 0:r.name)||(e==null?void 0:e.subDepartmentName)||"";else if(typeof r=="string"){const n=q.value.find(i=>String(i==null?void 0:i._id)===r||String((i==null?void 0:i.id)??"")===r||(i==null?void 0:i.code)===r||(i==null?void 0:i.name)===r);c=(n==null?void 0:n._id)||(n==null?void 0:n.id)||r,u=(n==null?void 0:n.name)||(e==null?void 0:e.subDepartmentName)||r}C.value=c?String(c):"",me.value=u?String(u):"",C.value?x.value=C.value:x.value="",await Lt(t)}async function Lt(t=""){if(ve.role!=="supervisor"){ee.value=[];return}const e=t||Ae();if(!e){ee.value=C.value?[String(C.value)]:[];return}try{const a=await z(`/api/employees?supervisor=${e}`);if(!a.ok)throw new Error("Failed to fetch direct reports");const l=await a.json(),o=Array.isArray(l)?l:[],r=new Set,c=[],u=n=>{if(!n&&n!==0)return;const i=String(n);i&&(r.has(i)||(r.add(i),c.push(i)))};o.forEach(n=>{const i=n==null?void 0:n.subDepartment;u(i&&typeof i=="object"?(i==null?void 0:i._id)||(i==null?void 0:i.id)||(i==null?void 0:i.value):i)}),u(C.value),ee.value=c}catch(a){console.error(a),ee.value=C.value?[String(C.value)]:[]}}async function be(){const t=Ae(),e=[`month=${O.value}`];t&&e.push(`supervisor=${t}`),ce.value&&ye.value&&e.push("includeSelf=true");const a=`?${e.join("&")}`;try{const l=await z(`/api/schedules/monthly${a}`);if(!l.ok)throw new Error("Failed to fetch schedules");const o=await l.json(),r=Array.isArray(o)?o:[],c=Z.value;m.value={},!D.value.length&&r.length&&await ge(I.value,x.value),D.value.forEach(n=>{const i=String(n._id);m.value[i]={},c.forEach(y=>{m.value[i][y.date]={shiftId:"",department:n.departmentId,subDepartment:n.subDepartmentId}})}),r.forEach(n=>{var V;const i=((V=n.employee)==null?void 0:V._id)||n.employee;if(!i)return;const y=String(i);m.value[y]||(m.value[y]={},c.forEach(_=>{m.value[y][_.date]={shiftId:"",department:"",subDepartment:""}}));const F=T(n.date).date(),J=D.value.find(_=>String(_._id)===y)||{};m.value[y][F]={id:n._id,shiftId:n.shiftId,department:n.department||J.departmentId,subDepartment:n.subDepartment||J.subDepartmentId}});const u=await z(`/api/schedules/leave-approvals${a}`);if(u.ok){const n=await u.json(),i=Array.isArray(n==null?void 0:n.approvals)?n.approvals:[],y=Array.isArray(n==null?void 0:n.leaves)?n.leaves:[];ke.value=i;const F=T(`${O.value}-01`).startOf("day"),J=F.endOf("month").startOf("day");y.forEach(V=>{var v,oe,B;if(V.status!=="approved")return;const _=((v=V.employee)==null?void 0:v._id)||V.employee;if(!_)return;const U=String(_),le=T(V.startDate).startOf("day"),se=T(V.endDate).startOf("day");if(!le.isValid()||!se.isValid())return;let ne=le.isBefore(F)?F:le;const s=se.isAfter(J)?J:se;for(;!ne.isAfter(s);){const P=ne.date(),N=(B=(oe=m.value)==null?void 0:oe[U])==null?void 0:B[P];N&&(N.leave={type:V.leaveType,startDate:V.startDate,endDate:V.endDate,excludesHours:!0}),ne=ne.add(1,"day")}})}$e()}catch(l){console.error(l),G.error("取得排班資料失敗")}}async function Ot(t){var o;if(!t)return;E.visible=!1,E.doc=null;const e=await z(`/api/approvals/${t}`);if(!e.ok)return;const a=await e.json();E.doc=a,E.visible=!0,(Array.isArray((o=E.doc)==null?void 0:o.steps)?E.doc.steps:[]).forEach(r=>{(Array.isArray(r==null?void 0:r.approvers)?r.approvers:[]).forEach(u=>{var n,i;(n=u==null?void 0:u.approver)!=null&&n._id&&((i=u==null?void 0:u.approver)!=null&&i.name)&&(Ne[u.approver._id]=u.approver.name)})})}function Ze(t){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:m.value,employees:D.value,days:Z.value,shifts:K.value})),At.push({name:t==="week"?"PreviewWeek":"PreviewMonth"})}async function et(t){try{const e=await z(`/api/schedules/export?month=${O.value}&format=${t}`);if(!e.ok)throw new Error;const a=await e.blob(),l=URL.createObjectURL(a),o=document.createElement("a");o.href=l,o.download=`schedules-${O.value}.${t==="excel"?"xlsx":"pdf"}`,o.click(),URL.revokeObjectURL(l)}catch{G.error("匯出失敗")}}async function Tt(t,e,a){const l=`${O.value}-${String(e).padStart(2,"0")}`,o=m.value[t][e];if(o!=null&&o.leave){Ye("該日已核准請假，無法調整排班");return}const r=(o==null?void 0:o.shiftId)??"";if(o&&o.id)try{const c=await z(`/api/schedules/${o.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:a,department:o.department,subDepartment:o.subDepartment})});c.ok||await je(c,"更新排班失敗",t,e,r)}catch{await je(null,"更新排班失敗",t,e,r)}else try{const c=await z("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:t,date:l,shiftId:a,department:o.department,subDepartment:o.subDepartment})});if(c.ok){const u=await c.json();m.value[t][e]={id:u._id,shiftId:u.shiftId,department:o.department,subDepartment:o.subDepartment}}else await je(c,"新增排班失敗",t,e,r)}catch{await je(null,"新增排班失敗",t,e,r)}}async function Yt(){x.value="",await Xe(I.value),await ge(I.value,""),await be()}async function Rt(){await ge(I.value,x.value),await be()}async function je(t,e,a,l,o){m.value[a]||(m.value[a]={});const r=m.value[a][l]||{shiftId:"",department:"",subDepartment:""};r.shiftId=o,m.value[a][l]=r;let c="";try{if(t){const u=await t.json();c=(u==null?void 0:u.error)||""}}catch{}c==="employee conflict"?we.alert("人員衝突"):c==="department overlap"?we.alert("跨區重複"):c==="leave conflict"?we.alert("請假衝突"):G.error(e)}async function tt(t,e="批次套用失敗"){let a="";try{if(t){const l=await t.json();a=(l==null?void 0:l.error)||""}}catch{}a==="employee conflict"?G.warning("部分員工既有排班已更新，請重新整理檢查"):a==="department overlap"?we.alert("部門或單位與既有資料不一致，無法套用"):a==="leave conflict"?we.alert("選取日期包含已核准請假，無法套用"):a?G.error(a):G.error(e)}async function Ft(){if(!Oe.value){Ge("請先選取要套用的儲存格");return}if(!he.value){Ge("請選擇欲套用的班別");return}const t=[];if(Le.value.forEach(l=>{var i;const{empId:o,day:r}=ze(l),c=(i=m.value[o])==null?void 0:i[r];if(!c||c.leave)return;const u=ae.value||c.department||"";let n=c.subDepartment||"";ae.value?n=X.value||"":X.value&&(n=X.value),t.push({employee:o,day:r,date:`${O.value}-${String(r).padStart(2,"0")}`,shiftId:he.value,department:u,subDepartment:n})}),!t.length){Ye("選取的儲存格皆無需更新");return}const e=new Map;t.forEach(l=>{e.set(ie(l.employee,l.day),l)}),Ie.value=!0;const a=Ht.service({fullscreen:!0,lock:!0,text:"批次套用中..."});try{let l;try{l=await z("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:t.map(({day:r,...c})=>c)})})}catch{await tt(null);return}if(!l.ok){await tt(l);return}const o=await l.json();if(!Array.isArray(o)||!o.length){Ye("沒有可更新的資料");return}o.forEach(r=>{var F;const c=((F=r.employee)==null?void 0:F._id)||r.employee,u=T(r.date).date();m.value[c]||(m.value[c]={});const n=ie(c,u),i=e.get(n)||{},y=m.value[c][u]||{};m.value[c][u]={...y,id:r._id||i.id||y.id,shiftId:r.shiftId||i.shiftId||y.shiftId,department:i.department??r.department??y.department??"",subDepartment:i.subDepartment??r.subDepartment??y.subDepartment??""},delete m.value[c][u].leave}),jt("批次套用完成")}finally{a==null||a.close(),Ie.value=!1}}function ue(t){return K.value.find(e=>e._id===t)}function xe(t){if(!t)return"";const e=t.code??"",a=t.name??"";return!e&&!a?"":a?`${e}(${a})`:e}function at(t){const e=t&&typeof t=="object"?t:ue(t);if(!e)return"";const a=`${e.code??""}${e.name??""}`;return/早/.test(a)?"shift-morning":/晚|夜/.test(a)?"shift-evening":"shift-normal"}function lt(t){return q.value.filter(e=>e.department===t)}async function ge(t="",e=""){var u;const a=Ae(),l=[],o=t||I.value||M.value,r=e||x.value;a&&l.push(`supervisor=${a}`),o&&l.push(`department=${o}`),r&&l.push(`subDepartment=${r}`);const c=`/api/employees${l.length?`?${l.join("&")}`:""}`;try{const n=await z(c);if(!n.ok)throw new Error("Failed to fetch employees");const i=await n.json(),y=R.value.reduce((_,U)=>(_[U._id]=U.name,_),{}),F=q.value.reduce((_,U)=>(_[U._id]=U.name,_),{}),J=i.map(_=>{const U=(_==null?void 0:_._id)??(_==null?void 0:_.id)??"",le=(_==null?void 0:_.department)??"",se=(_==null?void 0:_.subDepartment)??"",ne=U?String(U):"",s=le?String(le):"",v=se?String(se):"";return{_id:ne,name:_.name,departmentId:s,subDepartmentId:v,department:y[s]||"",subDepartment:F[v]||""}});let V=Ke(J);if(ce.value&&ye.value){const _=a?String(a):"";_&&!V.some(U=>U._id===_)&&(V=Ke([...V,{_id:_,name:((u=fe.value)==null?void 0:u.name)||"主管本人",departmentId:M.value||"",subDepartmentId:C.value||"",department:H.value||"",subDepartment:me.value||""}]))}D.value=V,$e()}catch(n){console.error(n),G.error("取得員工資料失敗")}}async function Re(){try{const t=[`month=${O.value}`];ce.value&&ye.value&&t.push("includeSelf=true");const e=await z(`/api/schedules/summary?${t.join("&")}`);if(e.ok){const a=await e.json();Pe.value={direct:a.length,unscheduled:a.filter(l=>l.shiftCount===0).length,onLeave:a.filter(l=>l.leaveCount>0).length}}}catch(t){console.error(t)}}async function Bt(t){const e=t?T(t):T();O.value=e.isValid()?e.format("YYYY-MM"):T().format("YYYY-MM"),await be(),await Re()}return Jt(async()=>{await Re(),await Ut(),await zt(),await Nt(),await ge(I.value,x.value),await be()}),(t,e)=>{const a=$("el-date-picker"),l=$("el-option"),o=$("el-select"),r=$("el-switch"),c=$("el-button"),u=$("el-input"),n=$("el-table-column"),i=$("el-checkbox"),y=$("el-tag"),F=$("el-popover"),J=$("el-table"),V=$("el-divider"),_=$("el-descriptions-item"),U=$("el-descriptions"),le=$("el-timeline-item"),se=$("el-timeline"),ne=$("el-dialog");return p(),b(j,null,[d("div",aa,[e[41]||(e[41]=d("div",{class:"page-header"},[d("h1",{class:"page-title"},"排班管理"),d("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),f(ta,{summary:Pe.value},null,8,["summary"]),d("div",la,[e[22]||(e[22]=d("div",{class:"filters-header"},[d("h3",{class:"filters-title"},"篩選條件")],-1)),d("div",sa,[d("div",na,[e[18]||(e[18]=d("label",{class:"filter-label"},"選擇月份",-1)),f(a,{modelValue:O.value,"onUpdate:modelValue":e[0]||(e[0]=s=>O.value=s),type:"month","value-format":"YYYY-MM",onChange:Bt,class:"modern-date-picker"},null,8,["modelValue"])]),d("div",oa,[e[19]||(e[19]=d("label",{class:"filter-label"},"部門",-1)),f(o,{modelValue:I.value,"onUpdate:modelValue":e[1]||(e[1]=s=>I.value=s),placeholder:"請選擇部門",onChange:Yt,disabled:!0,class:"modern-select"},{default:h(()=>[(p(!0),b(j,null,Y(R.value,s=>(p(),A(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),d("div",ra,[e[20]||(e[20]=d("label",{class:"filter-label"},"單位",-1)),f(o,{modelValue:x.value,"onUpdate:modelValue":e[2]||(e[2]=s=>x.value=s),placeholder:"請選擇單位",onChange:Rt,class:"modern-select"},{default:h(()=>[(p(!0),b(j,null,Y($t.value,s=>(p(),A(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),ye.value?(p(),b("div",ia,[e[21]||(e[21]=d("label",{class:"filter-label"},"包含自己",-1)),f(r,{modelValue:ce.value,"onUpdate:modelValue":e[3]||(e[3]=s=>ce.value=s),"active-text":"是","inactive-text":"否","inline-prompt":""},null,8,["modelValue"])])):W("",!0)])]),d("div",ua,[d("div",da,[f(c,{type:"primary",class:"action-btn primary",onClick:gt,disabled:!Oe.value},{default:h(()=>e[23]||(e[23]=[d("i",{class:"el-icon-close"},null,-1),k(" 清除選取 ")])),_:1},8,["disabled"]),f(c,{type:"primary",class:"action-btn primary",plain:"",onClick:Dt,disabled:!D.value.length},{default:h(()=>e[24]||(e[24]=[d("i",{class:"el-icon-user"},null,-1),k(" 全選員工 ")])),_:1},8,["disabled"]),f(c,{type:"primary",class:"action-btn primary",plain:"",onClick:Ct,disabled:!Z.value.length},{default:h(()=>e[25]||(e[25]=[d("i",{class:"el-icon-date"},null,-1),k(" 全選日期 ")])),_:1},8,["disabled"])]),d("div",ca,[d("div",va,[e[26]||(e[26]=d("label",{class:"range-label"},"自訂日期範圍",-1)),f(a,{modelValue:Ue.value,"onUpdate:modelValue":e[4]||(e[4]=s=>Ue.value=s),type:"daterange","start-placeholder":"開始日期","end-placeholder":"結束日期","range-separator":"至","unlink-panels":"",disabled:!Z.value.length,class:"modern-date-picker range-picker",onChange:Vt},null,8,["modelValue","disabled"])]),f(c,{onClick:e[5]||(e[5]=s=>Ze("week")),class:"action-btn secondary"},{default:h(()=>e[27]||(e[27]=[d("i",{class:"el-icon-calendar"},null,-1),k(" 預覽週表 ")])),_:1}),f(c,{onClick:e[6]||(e[6]=s=>Ze("month")),class:"action-btn secondary"},{default:h(()=>e[28]||(e[28]=[d("i",{class:"el-icon-date"},null,-1),k(" 預覽月表 ")])),_:1}),f(c,{onClick:e[7]||(e[7]=()=>et("pdf")),class:"action-btn export"},{default:h(()=>e[29]||(e[29]=[d("i",{class:"el-icon-download"},null,-1),k(" 匯出 PDF ")])),_:1}),f(c,{onClick:e[8]||(e[8]=()=>et("excel")),class:"action-btn export"},{default:h(()=>e[30]||(e[30]=[d("i",{class:"el-icon-s-grid"},null,-1),k(" 匯出 Excel ")])),_:1})])]),d("div",pa,[d("div",ma,[e[32]||(e[32]=d("h3",{class:"schedule-title"},"員工排班表",-1)),d("div",fa,[We.value.length?(p(!0),b(j,{key:0},Y(We.value,s=>(p(),b("span",{key:s.key,class:vt(["legend-item",s.className]),"data-test":"shift-legend-item"},S(s.label),3))),128)):(p(),b("span",ha," 尚未設定班別 ")),e[31]||(e[31]=d("span",{class:"legend-item leave"},"請假",-1))]),f(u,{modelValue:De.value,"onUpdate:modelValue":e[9]||(e[9]=s=>De.value=s),placeholder:"搜尋員工",clearable:"",class:"employee-search"},null,8,["modelValue"]),f(o,{modelValue:Ce.value,"onUpdate:modelValue":e[10]||(e[10]=s=>Ce.value=s),placeholder:"狀態",class:"status-filter"},{default:h(()=>[f(l,{label:"全部",value:"all"}),f(l,{label:"缺班",value:"unscheduled"}),f(l,{label:"待審核請假",value:"onLeave"})]),_:1},8,["modelValue"])]),de(_e)?(p(),b("div",ya,[f(o,{modelValue:he.value,"onUpdate:modelValue":e[11]||(e[11]=s=>he.value=s),placeholder:"套用班別",class:"modern-select batch-select",filterable:"","data-test":"batch-shift-select"},{default:h(()=>[(p(!0),b(j,null,Y(K.value,s=>(p(),A(l,{key:s._id,label:xe(s),value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(o,{modelValue:ae.value,"onUpdate:modelValue":e[12]||(e[12]=s=>ae.value=s),placeholder:"套用部門",clearable:"",class:"modern-select batch-select","data-test":"batch-dept-select"},{default:h(()=>[(p(!0),b(j,null,Y(R.value,s=>(p(),A(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(o,{modelValue:X.value,"onUpdate:modelValue":e[13]||(e[13]=s=>X.value=s),placeholder:"套用單位",clearable:"",class:"modern-select batch-select",disabled:!ae.value,"data-test":"batch-subdept-select"},{default:h(()=>[(p(!0),b(j,null,Y(Je.value,s=>(p(),A(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),f(c,{type:"primary",class:"action-btn primary apply-btn",disabled:!Oe.value||!he.value||Ie.value,loading:Ie.value,onClick:Ft,"data-test":"batch-apply-button"},{default:h(()=>e[33]||(e[33]=[k(" 套用至選取 ")])),_:1},8,["disabled","loading"])])):W("",!0),f(J,{class:"modern-schedule-table",data:It.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"},onRowClick:e[15]||(e[15]=s=>qe.value&&Et(s._id))},{default:h(()=>[f(n,{label:"部門／單位",width:"180",fixed:"left"},{default:h(({row:s})=>[d("div",_a,[d("div",ba,S(s.department),1),s.subDepartment?(p(),b("div",ga,S(s.subDepartment),1)):W("",!0)])]),_:1}),f(n,{prop:"name",label:"員工姓名",width:"150",fixed:"left"},{default:h(({row:s})=>[d("div",Sa,[de(_e)?(p(),A(i,{key:0,class:"row-checkbox","model-value":ht.value.has(s._id),onChange:v=>St(s._id,v)},null,8,["model-value","onChange"])):W("",!0),Te(s._id)==="unscheduled"?(p(),A(Fe(de(mt)),{key:1,class:"status-icon unscheduled"})):Te(s._id)==="onLeave"?(p(),A(Fe(de(ft)),{key:2,class:"status-icon on-leave"})):W("",!0),k(" "+S(s.name),1)])]),_:1}),(p(!0),b(j,null,Y(Z.value,s=>(p(),A(n,{key:s.date,label:s.label,width:"140",align:"center"},{header:h(()=>[d("div",wa,[d("span",null,S(s.label),1),de(_e)?(p(),A(i,{key:0,class:"day-checkbox","model-value":yt.value.has(s.date),onChange:v=>wt(s.date,v)},null,8,["model-value","onChange"])):W("",!0)])]),default:h(({row:v})=>{var oe,B,P,N,st,nt,ot,rt,it,ut,dt;return[!qe.value||Ve.value.has(v._id)?(p(),b("div",{key:0,class:vt(["modern-schedule-cell",[(B=(oe=m.value[v._id])==null?void 0:oe[s.date])!=null&&B.leave?"":at((N=(P=m.value[v._id])==null?void 0:P[s.date])==null?void 0:N.shiftId),{"has-leave":(nt=(st=m.value[v._id])==null?void 0:st[s.date])==null?void 0:nt.leave,"missing-shift":!((rt=(ot=m.value[v._id])==null?void 0:ot[s.date])!=null&&rt.shiftId)&&!((ut=(it=m.value[v._id])==null?void 0:it[s.date])!=null&&ut.leave),"is-selected":bt(v._id,s.date)}]]),title:Mt(v._id,s.date)},[de(_e)?(p(),b("div",{key:0,class:"cell-selection",onClick:e[14]||(e[14]=qt(()=>{},["stop"]))},[f(i,{"model-value":_t.value.has(ie(v._id,s.date)),disabled:!Ee(v._id,s.date),onChange:w=>kt(v._id,s.date,w),size:"small"},null,8,["model-value","disabled","onChange"])])):W("",!0),(dt=m.value[v._id])!=null&&dt[s.date]?(p(),b(j,{key:1},[m.value[v._id][s.date].leave?(p(),b("div",Da,[f(y,{type:"warning",effect:"light",size:"small",class:"leave-tag"},{default:h(()=>e[34]||(e[34]=[k(" 休假中 ")])),_:1}),e[35]||(e[35]=d("span",{class:"leave-note"},"已核准請假，不列入工時",-1))])):de(_e)?(p(),b(j,{key:1},[f(o,{modelValue:m.value[v._id][s.date].shiftId,"onUpdate:modelValue":w=>m.value[v._id][s.date].shiftId=w,placeholder:"選擇班別",onChange:w=>Tt(v._id,s.date,w),class:"cell-select shift-select",size:"small"},{default:h(()=>[(p(!0),b(j,null,Y(K.value,w=>(p(),A(l,{key:w._id,label:xe(w),value:w._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),d("div",Ca,[f(o,{modelValue:m.value[v._id][s.date].department,"onUpdate:modelValue":w=>m.value[v._id][s.date].department=w,placeholder:"部門",size:"small",onChange:()=>m.value[v._id][s.date].subDepartment="",class:"cell-select dept-select"},{default:h(()=>[(p(!0),b(j,null,Y(R.value,w=>(p(),A(l,{key:w._id,label:w.name,value:w._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),f(o,{modelValue:m.value[v._id][s.date].subDepartment,"onUpdate:modelValue":w=>m.value[v._id][s.date].subDepartment=w,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:h(()=>[(p(!0),b(j,null,Y(lt(m.value[v._id][s.date].department),w=>(p(),A(l,{key:w._id,label:w.name,value:w._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(p(),b(j,{key:2},[ue(m.value[v._id][s.date].shiftId)?(p(),A(F,{key:0,placement:"top",trigger:"hover",width:200},{reference:h(()=>[d("div",Ma,S(xe(ue(m.value[v._id][s.date].shiftId))),1)]),default:h(()=>[d("div",Va,[d("div",Ia,[e[36]||(e[36]=d("span",{class:"detail-label"},"上班時間：",-1)),d("span",Ea,S(ue(m.value[v._id][s.date].shiftId).startTime),1)]),d("div",$a,[e[37]||(e[37]=d("span",{class:"detail-label"},"下班時間：",-1)),d("span",Aa,S(ue(m.value[v._id][s.date].shiftId).endTime),1)]),ue(m.value[v._id][s.date].shiftId).remark?(p(),b("div",ja,[e[38]||(e[38]=d("span",{class:"detail-label"},"備註：",-1)),d("span",xa,S(ue(m.value[v._id][s.date].shiftId).remark),1)])):W("",!0)])]),_:2},1024)):W("",!0)],64)),!m.value[v._id][s.date].shiftId&&!m.value[v._id][s.date].leave?(p(),b("div",Ua," 未排班 ")):W("",!0)],64)):(p(),b("span",Na,"-"))],10,ka)):(p(),b("div",za,"展開班表"))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])]),ke.value.length?(p(),b("div",La,[d("div",Oa,[e[39]||(e[39]=d("h3",{class:"approval-title"},"待處理審批",-1)),d("div",Ta,S(ke.value.length)+" 項待處理",1)]),f(J,{class:"modern-approval-table",data:ke.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:h(()=>[f(n,{label:"申請人",width:"120"},{default:h(({row:s})=>{var v;return[d("div",Ya,S((v=s.applicant_employee)==null?void 0:v.name),1)]}),_:1}),f(n,{label:"申請類型",width:"150"},{default:h(({row:s})=>{var v;return[d("div",Ra,S(((v=s.form)==null?void 0:v.name)||"未知類型"),1)]}),_:1}),f(n,{prop:"status",label:"狀態",width:"100"},{default:h(({row:s})=>[f(y,{type:s.status==="approved"?"success":s.status==="rejected"?"danger":"warning",class:"status-tag"},{default:h(()=>[k(S(s.status),1)]),_:2},1032,["type"])]),_:1}),f(n,{label:"操作",width:"120"},{default:h(({row:s})=>[f(c,{size:"small",onClick:v=>Ot(s._id),disabled:!s._id},{default:h(()=>e[40]||(e[40]=[k(" 查看 ")])),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"])])):W("",!0)]),f(ne,{modelValue:E.visible,"onUpdate:modelValue":e[17]||(e[17]=s=>E.visible=s),title:"申請單明細",width:"760px"},{footer:h(()=>[f(c,{onClick:e[16]||(e[16]=s=>E.visible=!1)},{default:h(()=>e[47]||(e[47]=[k("關閉")])),_:1})]),default:h(()=>{var s,v,oe;return[E.doc?(p(),b("div",Fa,[d("p",Ba,[e[42]||(e[42]=d("b",null,"表單：",-1)),k(S((s=E.doc.form)==null?void 0:s.name)+"（"+S((v=E.doc.form)==null?void 0:v.category)+"）",1)]),d("p",Pa,[e[43]||(e[43]=d("b",null,"申請人：",-1)),k(S(((oe=E.doc.applicant_employee)==null?void 0:oe.name)||"-"),1)]),d("p",Wa,[e[44]||(e[44]=d("b",null,"狀態：",-1)),k(S(Qe(E.doc.status)),1)]),f(V,{"content-position":"left"},{default:h(()=>e[45]||(e[45]=[k("填寫內容")])),_:1}),f(U,{column:1,size:"small",border:""},{default:h(()=>{var B;return[(p(!0),b(j,null,Y(((B=E.doc.form)==null?void 0:B.fields)||[],P=>(p(),A(_,{key:P._id,label:P.label},{default:h(()=>{var N;return[d("span",null,S(Me((N=E.doc.form_data)==null?void 0:N[P._id])),1)]}),_:2},1032,["label"]))),128))]}),_:1}),f(V,{"content-position":"left"},{default:h(()=>e[46]||(e[46]=[k("流程")])),_:1}),f(se,null,{default:h(()=>[(p(!0),b(j,null,Y(E.doc.steps,(B,P)=>(p(),A(le,{key:P,timestamp:`第 ${P+1} 關`,type:P===E.doc.current_step_index?"primary":"info"},{default:h(()=>[d("div",Ja,[d("span",Ka,"需全員同意："+S(B.all_must_approve?"是":"否"),1),d("span",null,"必簽："+S(B.is_required?"是":"否"),1)]),f(J,{data:B.approvers,size:"small",border:""},{default:h(()=>[f(n,{label:"審核人",width:"200"},{default:h(({row:N})=>[k(S(xt(N.approver)),1)]),_:1}),f(n,{label:"決議",width:"120"},{default:h(({row:N})=>[k(S(Qe(N.decision)),1)]),_:1}),f(n,{label:"時間",width:"200"},{default:h(({row:N})=>[k(S(pe(N.decided_at)),1)]),_:1}),f(n,{prop:"comment",label:"意見"})]),_:2},1032,["data"])]),_:2},1032,["timestamp","type"]))),128))]),_:1})])):W("",!0)]}),_:1},8,["modelValue"])],64)}}},Xa=pt(qa,[["__scopeId","data-v-4d7b8744"]]);export{Xa as default};
