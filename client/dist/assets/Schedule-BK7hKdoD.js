import{_ as It,v as O,G as ll,H as Ct,I as Vt,c as _,o as f,F as x,m as P,e as A,l as j,w as y,b as d,J as Ze,z as Re,t as g,r as b,K as R,q as Dt,k as ye,j as al,d as h,x as W,h as fe,E as Q,u as nl,g as I,n as sl,f as ol,A as $e,L as rl}from"./index-B1-Hvwow.js";import{a as N}from"./api-Coim478o.js";import{u as il}from"./auth-AN6u9mWJ.js";import{b as ul}from"./shiftColors-BbvJ2s1U.js";const dl={class:"dashboard"},cl={class:"metric-label"},vl={class:"metric-value"},pl=Object.assign({name:"ScheduleDashboard"},{__name:"ScheduleDashboard",props:{summary:{type:Object,default:()=>({direct:0,unscheduled:0,onLeave:0})}},setup(et){const _e=et,Pe=O(()=>[{label:"直屬員工數",value:_e.summary.direct,icon:ll,color:"#0f766e"},{label:"未排班員工",value:_e.summary.unscheduled,icon:Ct,color:"#dc2626"},{label:"請假中員工",value:_e.summary.onLeave,icon:Vt,color:"#f59e0b"}]);return(tt,lt)=>{const U=A("el-card");return f(),_("div",dl,[(f(!0),_(x,null,P(Pe.value,p=>(f(),j(U,{class:"metric-card",key:p.label},{default:y(()=>[(f(),j(Ze(p.icon),{class:"metric-icon",style:Re({color:p.color})},null,8,["style"])),d("div",cl,g(p.label),1),d("div",vl,g(p.value),1)]),_:2},1024))),128))])}}}),fl=It(pl,[["__scopeId","data-v-ceb5c889"]]),ml={class:"schedule-page"},hl={class:"filters-card"},yl={class:"filters-content"},_l={class:"filter-group"},bl={class:"filter-group"},gl={class:"filter-group"},Sl={key:0,class:"filter-group include-self-group"},wl={class:"actions-card"},kl={class:"primary-actions"},Dl={class:"secondary-actions"},Il={class:"range-picker-wrapper"},Cl={class:"schedule-card"},Vl={class:"schedule-header"},El={class:"schedule-legend","data-test":"schedule-legend"},$l={key:1,class:"legend-empty","data-test":"shift-legend-empty"},Al={key:0,class:"batch-toolbar"},jl={class:"employee-info"},xl={class:"department-name"},Ml={key:0,class:"sub-department"},Ul={class:"employee-name"},Ll={class:"day-header"},zl=["title"],Nl={key:0,class:"leave-indicator","data-test":"leave-indicator"},Ol={class:"department-selects"},Tl={class:"shift-details"},Yl={class:"detail-row"},Fl={class:"detail-value"},Rl={class:"detail-row"},Pl={class:"detail-value"},Bl={key:0,class:"detail-row"},Kl={class:"detail-value"},Wl={key:3,class:"missing-label"},Jl={key:2,class:"empty-cell"},ql={key:1,class:"modern-schedule-cell collapsed-cell"},Gl={key:0,class:"approval-card"},Hl={class:"approval-header"},Ql={class:"approval-count"},Xl={class:"applicant-name"},Zl={class:"form-type"},ea={key:0},ta={class:"mb-2"},la={class:"mb-2"},aa={class:"mb-2"},na={class:"mb-1"},sa={class:"mr-2"},oa="schedule-include-self",ra={__name:"Schedule",setup(et){const _e=t=>t?new Date(t).toLocaleString():"-",Pe=t=>Array.isArray(t)?t.join(", "):t??"-",tt={leave:"請假",attendance:"出勤",overtime:"加班",shift:"排班",reimbursement:"報銷",expense:"費用",travel:"出差",recruitment:"招募",onboarding:"入職",general:"一般"},lt=(t,e="")=>{if(t==null)return e||"未知類型";const l=String(t).trim();return l?tt[l.toLowerCase()]||l:e||"未知類型"},U=b(R().format("YYYY-MM")),p=b({}),le=b([]),T=b([]),Ae=b([]),B=b([]),q=b([]),C=b(""),E=b(""),L=b(""),G=b(""),V=b(""),be=b(""),ae=b([]),ge=b(null),J=b(!1);let at=!0;const nt=b({direct:0,unscheduled:0,onLeave:0}),je=b(""),xe=b("all"),Me=b(new Set),ne=b(new Set),X=b(new Set),de=b(new Set),Be=b([]),Se=b(""),se=b(""),Z=b(""),Ue=b(!1),$=Dt({visible:!1,doc:null}),Ke=Dt({});function ce(){var l,a;if(typeof window>"u")return"";const t=(l=window.sessionStorage)==null?void 0:l.getItem("employeeId");if(t&&t!=="undefined")return t;const e=(a=window.localStorage)==null?void 0:a.getItem("employeeId");return e&&e!=="undefined"?e:""}function st(t){return t?`${oa}:${String(t)}`:""}function ot(t=ce()){var a;if(typeof window>"u")return null;const e=st(t);if(!e)return null;const l=(a=window.localStorage)==null?void 0:a.getItem(e);return l==="true"?!0:l==="false"?!1:null}function We(t,e=ce()){var a;if(typeof window>"u")return;const l=st(e);if(l)try{(a=window.localStorage)==null||a.setItem(l,t?"true":"false")}catch(s){console.warn("Failed to persist includeSelf preference",s)}}const Et=O(()=>ne.value),$t=O(()=>X.value),At=O(()=>de.value),rt=O(()=>{if(!Array.isArray(le.value)||!le.value.length)return[];const t=new Set;return le.value.reduce((e,l)=>{if(!l)return e;const a=Te(l)||l.name||l.code||"未命名班別",s=String(l._id||`${l.code??""}-${l.name??""}`);return!s||t.has(s)||(t.add(s),e.push({key:s,label:a,style:Qe(l)})),e},[])}),ve=(t,e)=>`${t}-${e}`,Je=t=>{const[e,l]=String(t).split("-");return{empId:e,day:Number(l)}},Le=(t,e)=>{const l=p.value[t];if(!l)return!1;const a=l[e];return a?!a.leave:!1},qe=O(()=>{const t=new Set,e=ee.value,l=T.value,a=(s,o)=>{Le(s,o)&&t.add(ve(s,o))};return de.value.forEach(s=>{const{empId:o,day:c}=Je(s);a(o,c)}),ne.value.forEach(s=>{e.forEach(o=>a(s,o.date))}),X.value.forEach(s=>{l.forEach(o=>a(o._id,s))}),t}),Ge=O(()=>qe.value.size>0),it=O(()=>se.value?_t(se.value):[]),jt=(t,e)=>qe.value.has(ve(t,e)),ze=()=>{const t=new Set(T.value.map(a=>a._id)),e=new Set(ee.value.map(a=>a.date));ne.value=new Set(Array.from(ne.value).filter(a=>t.has(a))),X.value=new Set(Array.from(X.value).filter(a=>e.has(a)));const l=new Set;de.value.forEach(a=>{const{empId:s,day:o}=Je(a);t.has(s)&&e.has(o)&&Le(s,o)&&l.add(ve(s,o))}),de.value=l},xt=()=>{ne.value=new Set,X.value=new Set,de.value=new Set,Be.value=[]},Mt=(t,e)=>{const l=new Set(ne.value);(typeof e=="boolean"?e:!l.has(t))?l.add(t):l.delete(t),ne.value=l},Ut=(t,e)=>{const l=new Set(X.value);(typeof e=="boolean"?e:!l.has(t))?l.add(t):l.delete(t),X.value=l},Lt=(t,e,l)=>{if(!Le(t,e))return;const a=ve(t,e),s=new Set(de.value);(typeof l=="boolean"?l:!s.has(a))?s.add(a):s.delete(a),de.value=s},zt=()=>{ne.value=new Set(T.value.map(t=>t._id))},Nt=()=>{X.value=new Set(ee.value.map(t=>t.date))},ut=t=>[...t].sort((e,l)=>{const a=(e.department||"").localeCompare(l.department||"");return a!==0?a:(e.name||"").localeCompare(l.name||"")}),Ot=t=>{if(!Array.isArray(t)||t.length!==2)return;const[e,l]=t;if(!e||!l)return;const a=R(`${U.value}-01`),s=R(e),o=R(l);if(!s.isValid()||!o.isValid())return;const c=a.endOf("month");let u=s.isBefore(a)?a:s;const r=[];for(;(u.isBefore(o)||u.isSame(o,"day"))&&(u.year()===a.year()&&u.month()===a.month()&&r.push(u.date()),!u.isSame(c,"day"));)u=u.add(1,"day");X.value=new Set(r)};ye(se,(t,e)=>{t!==e&&(Z.value="")}),ye(it,t=>{Z.value&&!t.some(e=>e._id===Z.value)&&(Z.value="")}),ye(J,async(t,e)=>{if(t===e)return;const l=pe()||ce();We(t,l),!at&&oe.value&&(await De(C.value,E.value),await ke(),await Xe())});const He=t=>{const e=p.value[t]||{},l=Object.values(e),a=l.some(o=>o.shiftId),s=l.some(o=>o.leave);return a?s?"onLeave":"scheduled":"unscheduled"},Tt=O(()=>{let t=je.value?T.value.filter(e=>e.name.includes(je.value)):T.value;return xe.value!=="all"&&(t=t.filter(e=>He(e._id)===xe.value)),t}),dt=O(()=>T.value.length>50),Yt=t=>{Me.value.has(t)?Me.value.delete(t):Me.value.add(t)},Ft=O(()=>q.value.filter(t=>t.department===C.value)),Rt=nl(),me=il();me.loadUser();const ct=O(()=>["supervisor","admin"].includes(me.role)),oe=O(()=>me.role==="supervisor"),we=ct,he=b("");ye(oe,t=>{const e=pe()||ce();if(!t){J.value&&(J.value=!1),We(!1,e);return}const l=ot(e);l===!0?J.value=!0:l===!1&&e&&We(!1,e)});const vt=t=>{var a,s;const e=(a=Q)==null?void 0:a.warning;typeof e=="function"&&e(t);const l=typeof window<"u"?(s=window.ElMessage)==null?void 0:s.warning:void 0;typeof l=="function"&&l!==e&&l(t)},Ne=t=>{var a,s;const e=(a=Q)==null?void 0:a.info;typeof e=="function"&&e(t);const l=typeof window<"u"?(s=window.ElMessage)==null?void 0:s.info:void 0;typeof l=="function"&&l!==e&&l(t)},Pt=t=>{var a,s;const e=(a=Q)==null?void 0:a.success;typeof e=="function"&&e(t);const l=typeof window<"u"?(s=window.ElMessage)==null?void 0:s.success:void 0;typeof l=="function"&&l!==e&&l(t)},pt=t=>({pending:"待簽核",approved:"已核可",rejected:"已否決",returned:"已退簽"})[t]||t||"-",Bt=t=>{if(t&&typeof t=="object"){const e=t._id||t.employeeId||"";return t.name||Ke[e]||e}return Ke[t]||t||"-"},Kt=(t,e)=>{var a,s;const l=(s=(a=p.value)==null?void 0:a[t])==null?void 0:s[e];return l!=null&&l.leave?"已核准請假，該日不列入工作時數":""},ee=O(()=>{const t=R(U.value+"-01"),e=t.endOf("month").date(),l=["日","一","二","三","四","五","六"];return Array.from({length:e},(a,s)=>{const o=s+1,c=l[t.date(o).day()];return{date:o,label:`${o}(${c})`}})});ye(T,ze),ye(ee,ze);async function Wt(){const t=await N("/api/shifts");if(t.ok){const e=await t.json(),l=Array.isArray(e==null?void 0:e.shifts)?e.shifts:Array.isArray(e)?e:[];Array.isArray(l)&&(le.value=l.map(a=>({_id:a._id,code:a.code,name:a.name??"",startTime:a.startTime,endTime:a.endTime,remark:a.remark})))}else t.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",t.status)}async function ft(t=""){try{const e=t||L.value,l=e?`/api/sub-departments?department=${e}`:"/api/sub-departments",a=await N(l);if(!a.ok)throw new Error("Failed to fetch sub departments");const s=await a.json(),o=B.value.reduce((r,i)=>{const S=String(i._id);return r[S]=S,i.name&&(r[i.name]=S),r},{});L.value&&(o[L.value]=L.value),G.value&&(o[G.value]=L.value||G.value);const c=Array.isArray(s)?s.map(r=>{const i=r==null?void 0:r.department;let S="";return i&&typeof i=="object"?S=(i==null?void 0:i._id)||(i==null?void 0:i.id)||o[i==null?void 0:i.name]||"":S=o[i]||i||"",{...r,_id:String((r==null?void 0:r._id)??(r==null?void 0:r.id)??""),department:String(S)}}).filter(r=>r._id):[];let u=c;if(e&&(u=c.filter(r=>r.department===String(e)),!u.length&&V.value)){const r=c.find(i=>i._id===V.value);r?u=[r]:u=[{_id:V.value,name:be.value||"",department:String(e)}]}if(me.role==="supervisor"){const r=ae.value.length?ae.value:V.value?[V.value]:[],i=new Set(r.map(S=>String(S)));i.size?u=u.filter(S=>i.has(String(S._id))):u=[]}q.value=u,q.value.length?V.value&&q.value.some(r=>r._id===V.value)?E.value=V.value:E.value&&q.value.some(r=>r._id===E.value)||(E.value=q.value[0]._id):E.value=""}catch(e){console.error(e),q.value=[],E.value=""}}async function Jt(){var t;try{const e=await N("/api/departments"),l=e.ok?await e.json():[],a=Array.isArray(l)?l.map(u=>{const r=(u==null?void 0:u._id)??(u==null?void 0:u.id)??(u==null?void 0:u.value)??"";return{...u,_id:String(r),name:(u==null?void 0:u.name)??""}}).filter(u=>u._id):[],s=C.value||L.value;let o=a;s&&(o=a.filter(u=>u._id===s||G.value&&u.name===G.value),!o.length&&s&&(o=[{_id:s,name:G.value||((t=a.find(u=>u._id===s))==null?void 0:t.name)||""}])),B.value=o.length?o:a,B.value.length?B.value.some(u=>u._id===C.value)||(C.value=B.value[0]._id):!C.value&&s&&(C.value=s);const c=C.value||L.value||(B.value.length?B.value[0]._id:"");await ft(c)}catch(e){console.error(e)}}function pe(){return ct.value?ce():""}async function qt(){if(me.role!=="supervisor"){L.value="",G.value="",V.value="",be.value="",ae.value=[],ge.value=null;return}const t=pe();if(!t){L.value="",G.value="",V.value="",be.value="",ae.value=[],ge.value=null;return}let e=null;try{const r=await N(`/api/employees/${t}`);if(!r.ok)throw new Error("Failed to fetch supervisor context");e=await r.json()}catch(r){console.error(r),ge.value=null}ge.value=e||null;const l=e==null?void 0:e.department;let a="",s="";if(l&&typeof l=="object")a=(l==null?void 0:l._id)||(l==null?void 0:l.id)||(l==null?void 0:l.value)||"",s=(l==null?void 0:l.name)||(e==null?void 0:e.departmentName)||"";else if(typeof l=="string"){const r=B.value.find(i=>String(i==null?void 0:i._id)===l||String((i==null?void 0:i.id)??"")===l||(i==null?void 0:i.code)===l||(i==null?void 0:i.name)===l);a=(r==null?void 0:r._id)||(r==null?void 0:r.id)||l,s=(r==null?void 0:r.name)||(e==null?void 0:e.departmentName)||l}L.value=a?String(a):"",G.value=s?String(s):"",L.value?C.value=L.value:C.value="";const o=e==null?void 0:e.subDepartment;let c="",u="";if(o&&typeof o=="object")c=(o==null?void 0:o._id)||(o==null?void 0:o.id)||(o==null?void 0:o.value)||"",u=(o==null?void 0:o.name)||(e==null?void 0:e.subDepartmentName)||"";else if(typeof o=="string"){const r=q.value.find(i=>String(i==null?void 0:i._id)===o||String((i==null?void 0:i.id)??"")===o||(i==null?void 0:i.code)===o||(i==null?void 0:i.name)===o);c=(r==null?void 0:r._id)||(r==null?void 0:r.id)||o,u=(r==null?void 0:r.name)||(e==null?void 0:e.subDepartmentName)||o}V.value=c?String(c):"",be.value=u?String(u):"",V.value?E.value=V.value:E.value="",await Gt(t)}async function Gt(t=""){if(me.role!=="supervisor"){ae.value=[];return}const e=t||pe();if(!e){ae.value=V.value?[String(V.value)]:[];return}try{const l=await N(`/api/employees?supervisor=${e}`);if(!l.ok)throw new Error("Failed to fetch direct reports");const a=await l.json(),s=Array.isArray(a)?a:[],o=new Set,c=[],u=r=>{if(!r&&r!==0)return;const i=String(r);i&&(o.has(i)||(o.add(i),c.push(i)))};s.forEach(r=>{const i=r==null?void 0:r.subDepartment;u(i&&typeof i=="object"?(i==null?void 0:i._id)||(i==null?void 0:i.id)||(i==null?void 0:i.value):i)}),u(V.value),ae.value=c}catch(l){console.error(l),ae.value=V.value?[String(V.value)]:[]}}async function ke(){const t=pe(),e=[`month=${U.value}`];t&&e.push(`supervisor=${t}`),J.value&&oe.value&&e.push("includeSelf=true");const l=`?${e.join("&")}`;try{const a=await N(`/api/schedules/monthly${l}`);if(!a.ok)throw new Error("Failed to fetch schedules");const s=await a.json(),o=Array.isArray(s)?s:[],c=ee.value;p.value={},!T.value.length&&o.length&&await De(C.value,E.value),T.value.forEach(m=>{const w=String(m._id);p.value[w]={},c.forEach(k=>{p.value[w][k.date]={shiftId:"",department:m.departmentId,subDepartment:m.subDepartmentId}})}),o.forEach(m=>{var n;const w=((n=m.employee)==null?void 0:n._id)||m.employee;if(!w)return;const k=String(w);p.value[k]||(p.value[k]={},c.forEach(v=>{p.value[k][v.date]={shiftId:"",department:"",subDepartment:""}}));const Y=R(m.date).date(),K=T.value.find(v=>String(v._id)===k)||{};p.value[k][Y]={id:m._id,shiftId:m.shiftId,department:m.department||K.departmentId,subDepartment:m.subDepartment||K.subDepartmentId}});const u=e.slice(),r=C.value,i=E.value;r&&u.push(`department=${r}`),i&&u.push(`subDepartment=${i}`);const S=`?${u.join("&")}`,te=await N(`/api/schedules/leave-approvals${S}`);if(te.ok){const m=await te.json(),w=Array.isArray(m==null?void 0:m.approvals)?m.approvals:[],k=Array.isArray(m==null?void 0:m.leaves)?m.leaves:[];Ae.value=w;const Y=R(`${U.value}-01`).startOf("day"),K=Y.endOf("month").startOf("day");k.forEach(n=>{var Ie,Ce,Ve;if(n.status!=="approved")return;const v=((Ie=n.employee)==null?void 0:Ie._id)||n.employee;if(!v)return;const H=String(v),F=R(n.startDate).startOf("day"),z=R(n.endDate).startOf("day");if(!F.isValid()||!z.isValid())return;let M=F.isBefore(Y)?Y:F;const Ye=z.isAfter(K)?K:z;for(;!M.isAfter(Ye);){const Fe=M.date(),Ee=(Ve=(Ce=p.value)==null?void 0:Ce[H])==null?void 0:Ve[Fe];Ee&&(Ee.leave={type:n.leaveType,startDate:n.startDate,endDate:n.endDate,excludesHours:!0}),M=M.add(1,"day")}})}const ie=pe()||ce();if(J.value&&oe.value&&ie){const m=o.some(k=>{var K;const Y=((K=k==null?void 0:k.employee)==null?void 0:K._id)||(k==null?void 0:k.employee);return Y&&String(Y)===ie}),w=[U.value,C.value||"",E.value||""].join("|");m?he.value&&(he.value=""):he.value!==w&&(Ne("尚未為主管建立班表，請先建立排班。"),he.value=w)}else he.value&&(he.value="");ze()}catch(a){console.error(a),Q.error("取得排班資料失敗")}}async function Ht(t){var s;if(!t)return;$.visible=!1,$.doc=null;const e=await N(`/api/approvals/${t}`);if(!e.ok)return;const l=await e.json();$.doc=l,$.visible=!0,(Array.isArray((s=$.doc)==null?void 0:s.steps)?$.doc.steps:[]).forEach(o=>{(Array.isArray(o==null?void 0:o.approvers)?o.approvers:[]).forEach(u=>{var r,i;(r=u==null?void 0:u.approver)!=null&&r._id&&((i=u==null?void 0:u.approver)!=null&&i.name)&&(Ke[u.approver._id]=u.approver.name)})})}function mt(t){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:p.value,employees:T.value,days:ee.value,shifts:le.value})),Rt.push({name:t==="week"?"PreviewWeek":"PreviewMonth"})}async function ht(t){try{const e=await N(`/api/schedules/export?month=${U.value}&format=${t}`);if(!e.ok)throw new Error;const l=await e.blob(),a=URL.createObjectURL(l),s=document.createElement("a");s.href=a,s.download=`schedules-${U.value}.${t==="excel"?"xlsx":"pdf"}`,s.click(),URL.revokeObjectURL(a)}catch{Q.error("匯出失敗")}}async function Qt(t,e,l){const a=`${U.value}-${String(e).padStart(2,"0")}`,s=p.value[t][e];if(s!=null&&s.leave){Ne("該日已核准請假，無法調整排班");return}const o=(s==null?void 0:s.shiftId)??"";if(s&&s.id)try{const c=await N(`/api/schedules/${s.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:l,department:s.department,subDepartment:s.subDepartment})});c.ok||await Oe(c,"更新排班失敗",t,e,o)}catch{await Oe(null,"更新排班失敗",t,e,o)}else try{const c=await N("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:t,date:a,shiftId:l,department:s.department,subDepartment:s.subDepartment})});if(c.ok){const u=await c.json();p.value[t][e]={id:u._id,shiftId:u.shiftId,department:s.department,subDepartment:s.subDepartment}}else await Oe(c,"新增排班失敗",t,e,o)}catch{await Oe(null,"新增排班失敗",t,e,o)}}async function Xt(){E.value="",await ft(C.value),await De(C.value,""),await ke()}async function Zt(){await De(C.value,E.value),await ke()}async function Oe(t,e,l,a,s){p.value[l]||(p.value[l]={});const o=p.value[l][a]||{shiftId:"",department:"",subDepartment:""};o.shiftId=s,p.value[l][a]=o;let c="";try{if(t){const u=await t.json();c=(u==null?void 0:u.error)||""}}catch{}c==="employee conflict"?$e.alert("人員衝突"):c==="department overlap"?$e.alert("跨區重複"):c==="leave conflict"?$e.alert("請假衝突"):Q.error(e)}async function yt(t,e="批次套用失敗"){let l="";try{if(t){const a=await t.json();l=(a==null?void 0:a.error)||""}}catch{}l==="employee conflict"?Q.warning("部分員工既有排班已更新，請重新整理檢查"):l==="department overlap"?$e.alert("部門或單位與既有資料不一致，無法套用"):l==="leave conflict"?$e.alert("選取日期包含已核准請假，無法套用"):l?Q.error(l):Q.error(e)}async function el(){if(!Ge.value){vt("請先選取要套用的儲存格");return}if(!Se.value){vt("請選擇欲套用的班別");return}const t=[];if(qe.value.forEach(a=>{var i;const{empId:s,day:o}=Je(a),c=(i=p.value[s])==null?void 0:i[o];if(!c||c.leave)return;const u=se.value||c.department||"";let r=c.subDepartment||"";se.value?r=Z.value||"":Z.value&&(r=Z.value),t.push({employee:s,day:o,date:`${U.value}-${String(o).padStart(2,"0")}`,shiftId:Se.value,department:u,subDepartment:r})}),!t.length){Ne("選取的儲存格皆無需更新");return}const e=new Map;t.forEach(a=>{e.set(ve(a.employee,a.day),a)}),Ue.value=!0;const l=rl.service({fullscreen:!0,lock:!0,text:"批次套用中..."});try{let a;try{a=await N("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:t.map(({day:o,...c})=>c)})})}catch{await yt(null);return}if(!a.ok){await yt(a);return}const s=await a.json();if(!Array.isArray(s)||!s.length){Ne("沒有可更新的資料");return}s.forEach(o=>{var te;const c=((te=o.employee)==null?void 0:te._id)||o.employee,u=R(o.date).date();p.value[c]||(p.value[c]={});const r=ve(c,u),i=e.get(r)||{},S=p.value[c][u]||{};p.value[c][u]={...S,id:o._id||i.id||S.id,shiftId:o.shiftId||i.shiftId||S.shiftId,department:i.department??o.department??S.department??"",subDepartment:i.subDepartment??o.subDepartment??S.subDepartment??""},delete p.value[c][u].leave}),Pt("批次套用完成")}finally{l==null||l.close(),Ue.value=!1}}function re(t){return le.value.find(e=>e._id===t)}function Te(t){if(!t)return"";const e=t.code??"",l=t.name??"";return!e&&!l?"":l?`${e}(${l})`:e}function Qe(t){const e=t&&typeof t=="object"?t:re(t);return e?ul(e):{}}function _t(t){return q.value.filter(e=>e.department===t)}async function De(t="",e=""){var u;const l=pe(),a=[],s=t||C.value||L.value,o=e||E.value;l&&a.push(`supervisor=${l}`),s&&a.push(`department=${s}`),o&&a.push(`subDepartment=${o}`);const c=`/api/employees${a.length?`?${a.join("&")}`:""}`;try{const r=await N(c);if(!r.ok)throw new Error("Failed to fetch employees");const i=await r.json(),S=B.value.reduce((m,w)=>(m[w._id]=w.name,m),{}),te=q.value.reduce((m,w)=>(m[w._id]=w.name,m),{}),ie=i.map(m=>{const w=(m==null?void 0:m._id)??(m==null?void 0:m.id)??"",k=(m==null?void 0:m.department)??"",Y=(m==null?void 0:m.subDepartment)??"",K=w?String(w):"",n=k?String(k):"",v=Y?String(Y):"";return{_id:K,name:m.name,departmentId:n,subDepartmentId:v,department:S[n]||"",subDepartment:te[v]||""}});let ue=ut(ie);if(J.value&&oe.value){const m=l?String(l):"";m&&!ue.some(w=>w._id===m)&&(ue=ut([...ue,{_id:m,name:((u=ge.value)==null?void 0:u.name)||"主管本人",departmentId:L.value||"",subDepartmentId:V.value||"",department:G.value||"",subDepartment:be.value||""}]))}T.value=ue,ze()}catch(r){console.error(r),Q.error("取得員工資料失敗")}}async function Xe(){try{const t=[`month=${U.value}`];J.value&&oe.value&&t.push("includeSelf=true");const e=await N(`/api/schedules/summary?${t.join("&")}`);if(e.ok){const l=await e.json();nt.value={direct:l.length,unscheduled:l.filter(a=>a.shiftCount===0).length,onLeave:l.filter(a=>a.leaveCount>0).length}}}catch(t){console.error(t)}}async function tl(t){const e=t?R(t):R();U.value=e.isValid()?e.format("YYYY-MM"):R().format("YYYY-MM"),await ke(),await Xe()}return al(async()=>{const t=ce();ot(t)===!0&&oe.value&&(J.value=!0);try{await Xe(),await Wt(),await qt(),await Jt(),await De(C.value,E.value),await ke()}finally{at=!1}}),(t,e)=>{const l=A("el-date-picker"),a=A("el-option"),s=A("el-select"),o=A("el-switch"),c=A("el-button"),u=A("el-input"),r=A("el-table-column"),i=A("el-checkbox"),S=A("el-tag"),te=A("el-popover"),ie=A("el-table"),ue=A("el-divider"),m=A("el-descriptions-item"),w=A("el-descriptions"),k=A("el-timeline-item"),Y=A("el-timeline"),K=A("el-dialog");return f(),_(x,null,[d("div",ml,[e[41]||(e[41]=d("div",{class:"page-header"},[d("h1",{class:"page-title"},"排班管理"),d("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),h(fl,{summary:nt.value},null,8,["summary"]),d("div",hl,[e[22]||(e[22]=d("div",{class:"filters-header"},[d("h3",{class:"filters-title"},"篩選條件")],-1)),d("div",yl,[d("div",_l,[e[18]||(e[18]=d("label",{class:"filter-label"},"選擇月份",-1)),h(l,{modelValue:U.value,"onUpdate:modelValue":e[0]||(e[0]=n=>U.value=n),type:"month","value-format":"YYYY-MM",onChange:tl,class:"modern-date-picker"},null,8,["modelValue"])]),d("div",bl,[e[19]||(e[19]=d("label",{class:"filter-label"},"部門",-1)),h(s,{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=n=>C.value=n),placeholder:"請選擇部門",onChange:Xt,disabled:!0,class:"modern-select"},{default:y(()=>[(f(!0),_(x,null,P(B.value,n=>(f(),j(a,{key:n._id,label:n.name,value:n._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),d("div",gl,[e[20]||(e[20]=d("label",{class:"filter-label"},"單位",-1)),h(s,{modelValue:E.value,"onUpdate:modelValue":e[2]||(e[2]=n=>E.value=n),placeholder:"請選擇單位",onChange:Zt,class:"modern-select"},{default:y(()=>[(f(!0),_(x,null,P(Ft.value,n=>(f(),j(a,{key:n._id,label:n.name,value:n._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),oe.value?(f(),_("div",Sl,[e[21]||(e[21]=d("label",{class:"filter-label"},"包含自己",-1)),h(o,{modelValue:J.value,"onUpdate:modelValue":e[3]||(e[3]=n=>J.value=n),"active-text":"是","inactive-text":"否","inline-prompt":""},null,8,["modelValue"])])):W("",!0)])]),d("div",wl,[d("div",kl,[h(c,{type:"primary",class:"action-btn primary",onClick:xt,disabled:!Ge.value},{default:y(()=>e[23]||(e[23]=[d("i",{class:"el-icon-close"},null,-1),I(" 清除選取 ")])),_:1},8,["disabled"]),h(c,{type:"primary",class:"action-btn primary",plain:"",onClick:zt,disabled:!T.value.length},{default:y(()=>e[24]||(e[24]=[d("i",{class:"el-icon-user"},null,-1),I(" 全選員工 ")])),_:1},8,["disabled"]),h(c,{type:"primary",class:"action-btn primary",plain:"",onClick:Nt,disabled:!ee.value.length},{default:y(()=>e[25]||(e[25]=[d("i",{class:"el-icon-date"},null,-1),I(" 全選日期 ")])),_:1},8,["disabled"])]),d("div",Dl,[d("div",Il,[e[26]||(e[26]=d("label",{class:"range-label"},"自訂日期範圍",-1)),h(l,{modelValue:Be.value,"onUpdate:modelValue":e[4]||(e[4]=n=>Be.value=n),type:"daterange","start-placeholder":"開始日期","end-placeholder":"結束日期","range-separator":"至","unlink-panels":"",disabled:!ee.value.length,class:"modern-date-picker range-picker",onChange:Ot},null,8,["modelValue","disabled"])]),h(c,{onClick:e[5]||(e[5]=n=>mt("week")),class:"action-btn secondary"},{default:y(()=>e[27]||(e[27]=[d("i",{class:"el-icon-calendar"},null,-1),I(" 預覽週表 ")])),_:1}),h(c,{onClick:e[6]||(e[6]=n=>mt("month")),class:"action-btn secondary"},{default:y(()=>e[28]||(e[28]=[d("i",{class:"el-icon-date"},null,-1),I(" 預覽月表 ")])),_:1}),h(c,{onClick:e[7]||(e[7]=()=>ht("pdf")),class:"action-btn export"},{default:y(()=>e[29]||(e[29]=[d("i",{class:"el-icon-download"},null,-1),I(" 匯出 PDF ")])),_:1}),h(c,{onClick:e[8]||(e[8]=()=>ht("excel")),class:"action-btn export"},{default:y(()=>e[30]||(e[30]=[d("i",{class:"el-icon-s-grid"},null,-1),I(" 匯出 Excel ")])),_:1})])]),d("div",Cl,[d("div",Vl,[e[32]||(e[32]=d("h3",{class:"schedule-title"},"員工排班表",-1)),d("div",El,[rt.value.length?(f(!0),_(x,{key:0},P(rt.value,n=>(f(),_("span",{key:n.key,class:"legend-item",style:Re(n.style),"data-test":"shift-legend-item"},g(n.label),5))),128)):(f(),_("span",$l," 尚未設定班別 ")),e[31]||(e[31]=d("span",{class:"legend-item leave"},"請假",-1))]),h(u,{modelValue:je.value,"onUpdate:modelValue":e[9]||(e[9]=n=>je.value=n),placeholder:"搜尋員工",clearable:"",class:"employee-search"},null,8,["modelValue"]),h(s,{modelValue:xe.value,"onUpdate:modelValue":e[10]||(e[10]=n=>xe.value=n),placeholder:"狀態",class:"status-filter"},{default:y(()=>[h(a,{label:"全部",value:"all"}),h(a,{label:"缺班",value:"unscheduled"}),h(a,{label:"待審核請假",value:"onLeave"})]),_:1},8,["modelValue"])]),fe(we)?(f(),_("div",Al,[h(s,{modelValue:Se.value,"onUpdate:modelValue":e[11]||(e[11]=n=>Se.value=n),placeholder:"套用班別",class:"modern-select batch-select",filterable:"","data-test":"batch-shift-select"},{default:y(()=>[(f(!0),_(x,null,P(le.value,n=>(f(),j(a,{key:n._id,label:Te(n),value:n._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),h(s,{modelValue:se.value,"onUpdate:modelValue":e[12]||(e[12]=n=>se.value=n),placeholder:"套用部門",clearable:"",class:"modern-select batch-select","data-test":"batch-dept-select"},{default:y(()=>[(f(!0),_(x,null,P(B.value,n=>(f(),j(a,{key:n._id,label:n.name,value:n._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),h(s,{modelValue:Z.value,"onUpdate:modelValue":e[13]||(e[13]=n=>Z.value=n),placeholder:"套用單位",clearable:"",class:"modern-select batch-select",disabled:!se.value,"data-test":"batch-subdept-select"},{default:y(()=>[(f(!0),_(x,null,P(it.value,n=>(f(),j(a,{key:n._id,label:n.name,value:n._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),h(c,{type:"primary",class:"action-btn primary apply-btn",disabled:!Ge.value||!Se.value||Ue.value,loading:Ue.value,onClick:el,"data-test":"batch-apply-button"},{default:y(()=>e[33]||(e[33]=[I(" 套用至選取 ")])),_:1},8,["disabled","loading"])])):W("",!0),h(ie,{class:"modern-schedule-table",data:Tt.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"},onRowClick:e[15]||(e[15]=n=>dt.value&&Yt(n._id))},{default:y(()=>[h(r,{label:"部門／單位",width:"180",fixed:"left"},{default:y(({row:n})=>[d("div",jl,[d("div",xl,g(n.department),1),n.subDepartment?(f(),_("div",Ml,g(n.subDepartment),1)):W("",!0)])]),_:1}),h(r,{prop:"name",label:"員工姓名",width:"150",fixed:"left"},{default:y(({row:n})=>[d("div",Ul,[fe(we)?(f(),j(i,{key:0,class:"row-checkbox","model-value":Et.value.has(n._id),onChange:v=>Mt(n._id,v)},null,8,["model-value","onChange"])):W("",!0),He(n._id)==="unscheduled"?(f(),j(Ze(fe(Ct)),{key:1,class:"status-icon unscheduled"})):He(n._id)==="onLeave"?(f(),j(Ze(fe(Vt)),{key:2,class:"status-icon on-leave"})):W("",!0),I(" "+g(n.name),1)])]),_:1}),(f(!0),_(x,null,P(ee.value,n=>(f(),j(r,{key:n.date,label:n.label,width:"140",align:"center"},{header:y(()=>[d("div",Ll,[d("span",null,g(n.label),1),fe(we)?(f(),j(i,{key:0,class:"day-checkbox","model-value":$t.value.has(n.date),onChange:v=>Ut(n.date,v)},null,8,["model-value","onChange"])):W("",!0)])]),default:y(({row:v})=>{var H,F,z,M,Ye,Ie,Ce,Ve,Fe,Ee,bt,gt,St,wt,kt;return[!dt.value||Me.value.has(v._id)?(f(),_("div",{key:0,class:sl(["modern-schedule-cell",[{"has-leave":(F=(H=p.value[v._id])==null?void 0:H[n.date])==null?void 0:F.leave,"missing-shift":!((M=(z=p.value[v._id])==null?void 0:z[n.date])!=null&&M.shiftId)&&!((Ie=(Ye=p.value[v._id])==null?void 0:Ye[n.date])!=null&&Ie.leave),"is-selected":jt(v._id,n.date),"has-shift":!((Ve=(Ce=p.value[v._id])==null?void 0:Ce[n.date])!=null&&Ve.leave)&&!!((Ee=(Fe=p.value[v._id])==null?void 0:Fe[n.date])!=null&&Ee.shiftId)}]]),style:Re((gt=(bt=p.value[v._id])==null?void 0:bt[n.date])!=null&&gt.leave?void 0:Qe((wt=(St=p.value[v._id])==null?void 0:St[n.date])==null?void 0:wt.shiftId)),title:Kt(v._id,n.date)},[fe(we)?(f(),_("div",{key:0,class:"cell-selection",onClick:e[14]||(e[14]=ol(()=>{},["stop"]))},[h(i,{"model-value":At.value.has(ve(v._id,n.date)),disabled:!Le(v._id,n.date),onChange:D=>Lt(v._id,n.date,D),size:"small"},null,8,["model-value","disabled","onChange"])])):W("",!0),(kt=p.value[v._id])!=null&&kt[n.date]?(f(),_(x,{key:1},[p.value[v._id][n.date].leave?(f(),_("div",Nl,[h(S,{type:"warning",effect:"light",size:"small",class:"leave-tag"},{default:y(()=>e[34]||(e[34]=[I(" 休假中 ")])),_:1}),e[35]||(e[35]=d("span",{class:"leave-note"},"已核准請假，不列入工時",-1))])):fe(we)?(f(),_(x,{key:1},[h(s,{modelValue:p.value[v._id][n.date].shiftId,"onUpdate:modelValue":D=>p.value[v._id][n.date].shiftId=D,placeholder:"選擇班別",onChange:D=>Qt(v._id,n.date,D),class:"cell-select shift-select",size:"small"},{default:y(()=>[(f(!0),_(x,null,P(le.value,D=>(f(),j(a,{key:D._id,label:Te(D),value:D._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),d("div",Ol,[h(s,{modelValue:p.value[v._id][n.date].department,"onUpdate:modelValue":D=>p.value[v._id][n.date].department=D,placeholder:"部門",size:"small",onChange:()=>p.value[v._id][n.date].subDepartment="",class:"cell-select dept-select"},{default:y(()=>[(f(!0),_(x,null,P(B.value,D=>(f(),j(a,{key:D._id,label:D.name,value:D._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),h(s,{modelValue:p.value[v._id][n.date].subDepartment,"onUpdate:modelValue":D=>p.value[v._id][n.date].subDepartment=D,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:y(()=>[(f(!0),_(x,null,P(_t(p.value[v._id][n.date].department),D=>(f(),j(a,{key:D._id,label:D.name,value:D._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(f(),_(x,{key:2},[re(p.value[v._id][n.date].shiftId)?(f(),j(te,{key:0,placement:"top",trigger:"hover",width:200},{reference:y(()=>[d("div",{class:"modern-shift-tag",style:Re(Qe(re(p.value[v._id][n.date].shiftId)))},g(Te(re(p.value[v._id][n.date].shiftId))),5)]),default:y(()=>[d("div",Tl,[d("div",Yl,[e[36]||(e[36]=d("span",{class:"detail-label"},"上班時間：",-1)),d("span",Fl,g(re(p.value[v._id][n.date].shiftId).startTime),1)]),d("div",Rl,[e[37]||(e[37]=d("span",{class:"detail-label"},"下班時間：",-1)),d("span",Pl,g(re(p.value[v._id][n.date].shiftId).endTime),1)]),re(p.value[v._id][n.date].shiftId).remark?(f(),_("div",Bl,[e[38]||(e[38]=d("span",{class:"detail-label"},"備註：",-1)),d("span",Kl,g(re(p.value[v._id][n.date].shiftId).remark),1)])):W("",!0)])]),_:2},1024)):W("",!0)],64)),!p.value[v._id][n.date].shiftId&&!p.value[v._id][n.date].leave?(f(),_("div",Wl," 未排班 ")):W("",!0)],64)):(f(),_("span",Jl,"-"))],14,zl)):(f(),_("div",ql,"展開班表"))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])]),Ae.value.length?(f(),_("div",Gl,[d("div",Hl,[e[39]||(e[39]=d("h3",{class:"approval-title"},"待處理審批",-1)),d("div",Ql,g(Ae.value.length)+" 項待處理",1)]),h(ie,{class:"modern-approval-table",data:Ae.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:y(()=>[h(r,{label:"申請人",width:"120"},{default:y(({row:n})=>{var v;return[d("div",Xl,g((v=n.applicant_employee)==null?void 0:v.name),1)]}),_:1}),h(r,{label:"申請類型",width:"150"},{default:y(({row:n})=>{var v,H;return[d("div",Zl,g(lt((v=n.form)==null?void 0:v.category,(H=n.form)==null?void 0:H.name)),1)]}),_:1}),h(r,{prop:"status",label:"狀態",width:"100"},{default:y(({row:n})=>[h(S,{type:n.status==="approved"?"success":n.status==="rejected"?"danger":"warning",class:"status-tag"},{default:y(()=>[I(g(n.status),1)]),_:2},1032,["type"])]),_:1}),h(r,{label:"操作",width:"120"},{default:y(({row:n})=>[h(c,{size:"small",onClick:v=>Ht(n._id),disabled:!n._id},{default:y(()=>e[40]||(e[40]=[I(" 查看 ")])),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"])])):W("",!0)]),h(K,{modelValue:$.visible,"onUpdate:modelValue":e[17]||(e[17]=n=>$.visible=n),title:"申請單明細",width:"760px"},{footer:y(()=>[h(c,{onClick:e[16]||(e[16]=n=>$.visible=!1)},{default:y(()=>e[47]||(e[47]=[I("關閉")])),_:1})]),default:y(()=>{var n,v,H;return[$.doc?(f(),_("div",ea,[d("p",ta,[e[42]||(e[42]=d("b",null,"表單：",-1)),I(g((n=$.doc.form)==null?void 0:n.name)+"（"+g((v=$.doc.form)==null?void 0:v.category)+"）",1)]),d("p",la,[e[43]||(e[43]=d("b",null,"申請人：",-1)),I(g(((H=$.doc.applicant_employee)==null?void 0:H.name)||"-"),1)]),d("p",aa,[e[44]||(e[44]=d("b",null,"狀態：",-1)),I(g(pt($.doc.status)),1)]),h(ue,{"content-position":"left"},{default:y(()=>e[45]||(e[45]=[I("填寫內容")])),_:1}),h(w,{column:1,size:"small",border:""},{default:y(()=>{var F;return[(f(!0),_(x,null,P(((F=$.doc.form)==null?void 0:F.fields)||[],z=>(f(),j(m,{key:z._id,label:z.label},{default:y(()=>{var M;return[d("span",null,g(Pe((M=$.doc.form_data)==null?void 0:M[z._id])),1)]}),_:2},1032,["label"]))),128))]}),_:1}),h(ue,{"content-position":"left"},{default:y(()=>e[46]||(e[46]=[I("流程")])),_:1}),h(Y,null,{default:y(()=>[(f(!0),_(x,null,P($.doc.steps,(F,z)=>(f(),j(k,{key:z,timestamp:`第 ${z+1} 關`,type:z===$.doc.current_step_index?"primary":"info"},{default:y(()=>[d("div",na,[d("span",sa,"需全員同意："+g(F.all_must_approve?"是":"否"),1),d("span",null,"必簽："+g(F.is_required?"是":"否"),1)]),h(ie,{data:F.approvers,size:"small",border:""},{default:y(()=>[h(r,{label:"審核人",width:"200"},{default:y(({row:M})=>[I(g(Bt(M.approver)),1)]),_:1}),h(r,{label:"決議",width:"120"},{default:y(({row:M})=>[I(g(pt(M.decision)),1)]),_:1}),h(r,{label:"時間",width:"200"},{default:y(({row:M})=>[I(g(_e(M.decided_at)),1)]),_:1}),h(r,{prop:"comment",label:"意見"})]),_:2},1032,["data"])]),_:2},1032,["timestamp","type"]))),128))]),_:1})])):W("",!0)]}),_:1},8,["modelValue"])],64)}}},va=It(ra,[["__scopeId","data-v-79b23a3b"]]);export{va as default};
