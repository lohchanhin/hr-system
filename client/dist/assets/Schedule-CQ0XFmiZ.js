import{_ as ea,j as w,I as Ka,J as ta,K as aa,c as h,o as p,F as P,t as K,n as T,w as y,b as d,L as Et,A as dt,v as b,e as x,r as g,D as B,y as Xt,m as me,k as Wa,d as f,q as N,h as Se,p as Zt,E as ce,u as qa,g as $,f as Ha,B as Ve,M as Ga}from"./index-BkCwXqkM.js";import{a as J}from"./api-747mdiEG.js";import{u as Qa}from"./auth-_IRAct42.js";import{b as Xa}from"./shiftColors-BbvJ2s1U.js";const Za={class:"dashboard"},el={class:"metric-label"},tl={class:"metric-value"},al=Object.assign({name:"ScheduleDashboard"},{__name:"ScheduleDashboard",props:{summary:{type:Object,default:()=>({direct:0,unscheduled:0,onLeave:0})}},setup(Dt){const Fe=Dt,ct=w(()=>[{label:"直屬員工數",value:Fe.summary.direct,icon:Ka,color:"#0f766e"},{label:"未排班員工",value:Fe.summary.unscheduled,icon:ta,color:"#dc2626"},{label:"請假中員工",value:Fe.summary.onLeave,icon:aa,color:"#f59e0b"}]);return(At,It)=>{const L=x("el-card");return p(),h("div",Za,[(p(!0),h(P,null,K(ct.value,m=>(p(),T(L,{class:"metric-card",key:m.label},{default:y(()=>[(p(),T(Et(m.icon),{class:"metric-icon",style:dt({color:m.color})},null,8,["style"])),d("div",el,b(m.label),1),d("div",tl,b(m.value),1)]),_:2},1024))),128))])}}}),ll=ea(al,[["__scopeId","data-v-ffe8883b"]]),sl={class:"schedule-page"},nl={class:"filters-card"},ol={class:"filters-content"},il={class:"filter-group"},rl={class:"filter-group"},ul={class:"filter-group"},dl={key:0,class:"filter-group include-self-group"},cl={key:0,class:"publish-card"},pl={class:"publish-header"},vl={class:"publish-progress","data-test":"publish-steps"},fl={class:"publish-meta-row"},ml={key:0,class:"publish-meta","data-test":"publish-meta"},hl={key:1,class:"publish-meta","data-test":"publish-meta"},yl={key:2,class:"publish-progress-indicator"},_l={class:"progress-label"},gl={class:"publish-actions"},bl={class:"publish-stats"},Sl={key:0,class:"status-card pending","data-test":"pending-card"},wl={class:"card-header"},kl={class:"card-badge"},Cl={class:"card-list"},El={class:"card-name"},Dl={class:"card-count"},Al={key:1,class:"status-card disputed","data-test":"disputed-card"},Il={class:"card-header"},Vl={class:"card-badge"},$l={class:"card-list"},xl={class:"card-item-main"},zl={class:"card-name"},Ml={class:"card-count"},jl={key:0,class:"disputes-list"},Nl={class:"dispute-date"},Pl={key:0,class:"dispute-note"},Ol={key:1,class:"dispute-note empty"},Ll={key:2,class:"status-card ready","data-test":"ready-card"},Rl={key:3,class:"status-card finalized","data-test":"finalized-card"},Tl={class:"actions-card"},Fl={class:"primary-actions"},Ul={class:"secondary-actions"},Yl={class:"range-picker-wrapper"},Bl={class:"schedule-card"},Jl={class:"schedule-header"},Kl={class:"schedule-legend","data-test":"schedule-legend"},Wl={key:1,class:"legend-empty","data-test":"shift-legend-empty"},ql={key:0,class:"batch-toolbar"},Hl={class:"employee-info"},Gl={class:"department-name"},Ql={key:0,class:"sub-department"},Xl={class:"employee-name"},Zl={class:"day-header"},es=["title"],ts={key:0,class:"leave-indicator","data-test":"leave-indicator"},as={class:"department-selects"},ls={class:"shift-details"},ss={class:"detail-row"},ns={class:"detail-value"},os={class:"detail-row"},is={class:"detail-value"},rs={key:0,class:"detail-row"},us={class:"detail-value"},ds={key:3,class:"missing-label"},cs={key:2,class:"empty-cell"},ps={key:1,class:"modern-schedule-cell collapsed-cell"},vs={key:1,class:"pagination-bar"},fs={key:1,class:"approval-card"},ms={class:"approval-header"},hs={class:"approval-count"},ys={class:"applicant-name"},_s={class:"form-type"},gs={key:0},bs={class:"mb-2"},Ss={class:"mb-2"},ws={class:"mb-2"},ks={class:"mb-1"},Cs={class:"mr-2"},Es="schedule-include-self",Ds={__name:"Schedule",setup(Dt){const Fe=t=>t?new Date(t).toLocaleString():"-",ct=t=>Array.isArray(t)?t.join(", "):t??"-",At={leave:"請假",attendance:"出勤",overtime:"加班",shift:"排班",reimbursement:"報銷",expense:"費用",travel:"出差",recruitment:"招募",onboarding:"入職",general:"一般"},It=(t,e="")=>{if(t==null)return e||"未知類型";const a=String(t).trim();return a?At[a.toLowerCase()]||a:e||"未知類型"},L=g(B().format("YYYY-MM")),m=g({}),Ue=g([]),he=g([]),W=g([]),$e=g([]),ee=g([]),ne=g([]),V=g(""),z=g(""),H=g(""),oe=g(""),O=g(""),Ye=g(""),ye=g([]),Be=g(null),Q=g(!1);let Vt=!0;const $t=g({direct:0,unscheduled:0,onLeave:0}),Je=g(""),Ke=g("all"),et=g(new Set),pe=g(new Set),le=g(new Set),we=g(new Set),We=g(new Map),pt=g([]),qe=g(""),_e=g(""),ve=g(""),tt=g(!1),He=g(!1),Ge=g(!1),R=Xt({visible:!1,doc:null}),vt=Xt({}),fe=g(20),X=g(1),at=g(null),lt=g(new Set),ft=g(!1);function ke(){var a,l;if(typeof window>"u")return"";const t=(a=window.sessionStorage)==null?void 0:a.getItem("employeeId");if(t&&t!=="undefined")return t;const e=(l=window.localStorage)==null?void 0:l.getItem("employeeId");return e&&e!=="undefined"?e:""}function xt(t){return t?`${Es}:${String(t)}`:""}function zt(t=ke()){var l;if(typeof window>"u")return null;const e=xt(t);if(!e)return null;const a=(l=window.localStorage)==null?void 0:l.getItem(e);return a==="true"?!0:a==="false"?!1:null}function mt(t,e=ke()){var l;if(typeof window>"u")return;const a=xt(e);if(a)try{(l=window.localStorage)==null||l.setItem(a,t?"true":"false")}catch(n){console.warn("Failed to persist includeSelf preference",n)}}const la=w(()=>pe.value),sa=w(()=>le.value),na=w(()=>we.value),ge=(t,e)=>`${t}::${e}`,ht=t=>{const e=String(t),a=e.lastIndexOf("::");if(a===-1)return{empId:e,day:NaN};const l=e.slice(0,a),n=Number(e.slice(a+2));return{empId:l,day:n}},Qe=g({}),Z=(t,e)=>{const a=Qe.value[String(t)];return a?!!a[Number(e)]:!1},Ce=(t,e)=>{const a=m.value[t];return!a||!a[e]?!1:!Z(t,e)},Mt=w(()=>{if(!Array.isArray(he.value)||!he.value.length)return[];const t=new Set;return he.value.reduce((e,a)=>{if(!a)return e;const l=it(a)||a.name||a.code||"未命名班別",n=String(a._id||`${a.code??""}-${a.name??""}`);return!n||t.has(n)||(t.add(n),e.push({key:n,label:l,style:kt(a)})),e},[])}),yt=w(()=>new Set(We.value.keys())),xe=t=>{const e=new Map(We.value);t(e),We.value=e},Ee=(t,e,a,l,n)=>{const i=ge(e,a);if(!Ce(e,a)){t.delete(i);return}if(!n){const r=t.get(i);if(!r)return;r[l]=!1,r.manual||r.employee||r.day?t.set(i,r):t.delete(i);return}const c=t.get(i)||{manual:!1,employee:!1,day:!1};c[l]=!0,t.set(i,c)},oa=()=>{const t=new Map,e=(a,l,n)=>{if(!Ce(a,l))return;const i=ge(a,l),c=t.get(i)||{manual:!1,employee:!1,day:!1};c[n]=!0,t.set(i,c)};we.value.forEach(a=>{const{empId:l,day:n}=ht(a);e(l,n,"manual")}),pe.value.forEach(a=>{re.value.forEach(l=>e(a,l.date,"employee"))}),le.value.forEach(a=>{W.value.forEach(l=>e(l._id,a,"day"))}),We.value=t},_t=w(()=>yt.value.size>0),jt=w(()=>_e.value?Wt(_e.value):[]),ia=(t,e)=>Ce(t,e)?yt.value.has(ge(t,e)):!1,st=()=>{const t=new Set(W.value.map(l=>l._id)),e=new Set(re.value.map(l=>l.date));pe.value=new Set(Array.from(pe.value).filter(l=>t.has(l))),le.value=new Set(Array.from(le.value).filter(l=>e.has(l)));const a=new Set;we.value.forEach(l=>{const{empId:n,day:i}=ht(l);t.has(n)&&e.has(i)&&Ce(n,i)&&a.add(ge(n,i))}),we.value=a,oa()},ra=()=>{pe.value=new Set,le.value=new Set,we.value=new Set,We.value=new Map,pt.value=[]},ua=(t,e)=>{const a=new Set(pe.value),l=typeof e=="boolean"?e:!a.has(t);l?a.add(t):a.delete(t),pe.value=a,xe(n=>{re.value.forEach(i=>Ee(n,t,i.date,"employee",l))})},da=(t,e)=>{const a=new Set(le.value),l=typeof e=="boolean"?e:!a.has(t);l?a.add(t):a.delete(t),le.value=a,xe(n=>{W.value.forEach(i=>Ee(n,i._id,t,"day",l))})},ca=(t,e,a)=>{if(!Ce(t,e))return;const l=ge(t,e),n=new Set(we.value),i=typeof a=="boolean"?a:!n.has(l);i?n.add(l):n.delete(l),we.value=n,xe(c=>Ee(c,t,e,"manual",i))},pa=()=>{const t=Me.value.map(n=>n._id),e=pe.value,a=new Set(e);let l=!1;t.some(n=>!a.has(n))&&(l=!0),l?t.forEach(n=>a.add(n)):t.forEach(n=>a.delete(n)),pe.value=a,xe(n=>{t.forEach(i=>{re.value.forEach(c=>{Ce(i,c.date)&&Ee(n,i,c.date,"employee",l)})})})},va=()=>{const t=le.value,e=re.value.map(i=>i.date),a=e.every(i=>t.has(i)),l=new Set(t);a?e.forEach(i=>l.delete(i)):e.forEach(i=>l.add(i)),le.value=l;const n=!a;xe(i=>{e.forEach(c=>{Me.value.forEach(r=>{Ce(r._id,c)&&Ee(i,r._id,c,"day",n)})})})},Nt=t=>[...t].sort((e,a)=>{const l=(e.department||"").localeCompare(a.department||"");return l!==0?l:(e.name||"").localeCompare(a.name||"")}),fa=t=>{if(!Array.isArray(t)||t.length!==2)return;const[e,a]=t;if(!e||!a)return;const l=B(`${L.value}-01`),n=B(e),i=B(a);if(!n.isValid()||!i.isValid())return;const c=l.endOf("month");let r=n.isBefore(l)?l:n;const u=[];for(;(r.isBefore(i)||r.isSame(i,"day"))&&(r.year()===l.year()&&r.month()===l.month()&&u.push(r.date()),!r.isSame(c,"day"));)r=r.add(1,"day");const s=le.value,_=new Set(u);le.value=_;const E=u.filter(F=>!s.has(F)),I=Array.from(s).filter(F=>!_.has(F));xe(F=>{E.forEach(M=>{Me.value.forEach(S=>Ee(F,S._id,M,"day",!0))}),I.forEach(M=>{Me.value.forEach(S=>Ee(F,S._id,M,"day",!1))})})};me(_e,(t,e)=>{t!==e&&(ve.value="")}),me(jt,t=>{ve.value&&!t.some(e=>e._id===ve.value)&&(ve.value="")}),me(Q,async(t,e)=>{if(t===e)return;const a=Ie()||ke();mt(t,a),De.refreshRole({forceRefresh:!0}),!Vt&&ie.value&&(X.value=1,await rt(V.value,z.value),await te({reset:!0}),await ue())}),me([Je,Ke],()=>{X.value=1,te({reset:!0})});const gt=t=>{const e=m.value[t]||{},a=Object.values(e);if(!a.length)return"unscheduled";const l=a.some(i=>!i.shiftId&&!i.leave&&!Z(t,i.day)),n=a.some(i=>i.leave||Z(t,i.day));return l?"unscheduled":n?"onLeave":"scheduled"},ze=w(()=>{let t=Je.value?W.value.filter(e=>e.name.includes(Je.value)):W.value;return Ke.value!=="all"&&(t=t.filter(e=>gt(e._id)===Ke.value)),t}),ma=w(()=>ze.value.length?Math.max(1,Math.ceil(ze.value.length/fe.value)):1),Me=w(()=>{const t=(X.value-1)*fe.value,e=t+fe.value;return ze.value.slice(t,e)}),Pt=w(()=>Me.value.map(t=>String(t._id)));me([ze,fe],()=>{const t=ma.value;X.value>t&&(X.value=t)}),me(Pt,()=>{te()}),me(W,st),me(Qe,st);const Ot=w(()=>W.value.length>50),ha=t=>{et.value.has(t)?et.value.delete(t):et.value.add(t)},ya=w(()=>ne.value.filter(t=>t.department===V.value)),_a=qa(),De=Qa();De.loadUser();const Lt=w(()=>["supervisor","admin"].includes(De.role)),ie=w(()=>De.role==="supervisor"),je=Lt,Ne=g(""),C=w(()=>{if(at.value){const s=at.value;return{status:s.status||"draft",pendingEmployees:s.pendingEmployees||[],disputedEmployees:s.disputedEmployees||[],publishedAt:s.publishedAt||null,hasSchedules:s.hasSchedules??!1,totalEmployees:s.totalEmployees??0,allEmployeesConfirmed:s.allEmployeesConfirmed??!1}}const t={status:"draft",pendingEmployees:[],disputedEmployees:[],publishedAt:null,hasSchedules:!1,totalEmployees:0,allEmployeesConfirmed:!1},e=Array.isArray(Ue.value)?Ue.value:[];if(!e.length)return t;t.hasSchedules=!0;const a=new Map;let l=null,n=!1,i=!1,c=!1;e.forEach(s=>{if(!s)return;const _=s.state||"draft",E=s.employeeResponse||"pending",I=s.employee||{},F=(I==null?void 0:I._id)??(I==null?void 0:I.id)??s.employee,M=F?String(F):"",S=(I==null?void 0:I.name)||s.employeeName||M;if(_!=="draft"&&(n=!0),(_==="changes_requested"||E==="disputed")&&(i=!0),_==="finalized"&&(c=!0),s!=null&&s.publishedAt){const U=new Date(s.publishedAt);Number.isNaN(U)||(!l||l<U)&&(l=U)}if(!M)return;a.has(M)||a.set(M,{id:M,name:S||M,pendingCount:0,disputedCount:0,latestNote:"",latestResponseAt:null,disputes:[]});const D=a.get(M);if(_==="pending_confirmation"&&E==="pending"&&(D.pendingCount+=1),(E==="disputed"||_==="changes_requested")&&(D.disputedCount+=1,s!=null&&s.responseNote&&(D.latestNote=s.responseNote),D.disputes.push({date:s.date,note:s.responseNote||"",responseAt:s.responseAt})),s!=null&&s.responseAt){const U=new Date(s.responseAt);Number.isNaN(U)||(!D.latestResponseAt||D.latestResponseAt<U)&&(D.latestResponseAt=U)}});const r=[],u=[];return a.forEach(s=>{s.pendingCount>0&&r.push({id:s.id,name:s.name,pendingCount:s.pendingCount}),s.disputedCount>0&&u.push({id:s.id,name:s.name,disputedCount:s.disputedCount,latestNote:s.latestNote,latestResponseAt:s.latestResponseAt?s.latestResponseAt.toISOString():null,disputes:s.disputes})}),t.pendingEmployees=r,t.disputedEmployees=u,t.totalEmployees=a.size,t.publishedAt=l?l.toISOString():null,c?t.status="finalized":i?t.status="disputed":n?t.status=r.length?"pending":"ready":t.status="draft",t.allEmployeesConfirmed=t.status==="ready"&&r.length===0&&u.length===0,t}),ga=w(()=>({draft:"尚未發布",pending:"待員工確認",ready:"可完成發布",disputed:"需處理異議",finalized:"已完成發布"})[C.value.status]||"尚未發布"),Pe=w(()=>C.value.pendingEmployees.reduce((t,e)=>t+(Number(e==null?void 0:e.pendingCount)||0),0)),Oe=w(()=>C.value.disputedEmployees.reduce((t,e)=>t+(Number(e==null?void 0:e.disputedCount)||0),0)),ba=w(()=>{const t=C.value.status;return t==="pending"?1:t==="disputed"?2:t==="ready"||t==="finalized"?3:0}),nt=w(()=>{const t=C.value.status,e=Pe.value>0,a=Oe.value>0;return{draft:t==="draft"?"process":"finish",pending:t==="draft"?"wait":e||t==="pending"?"process":"finish",disputed:a?"error":t==="draft"||t==="pending"?"wait":"finish",finalized:t==="finalized"?"success":t==="ready"?"process":"wait"}}),Sa=w(()=>C.value.hasSchedules?Pe.value>0?`${Pe.value} 筆待回覆`:"員工已完成回覆":"尚未發送確認"),wa=w(()=>C.value.hasSchedules?Oe.value>0?`${Oe.value} 筆異議待處理`:"無異議紀錄":"尚未進入異議流程"),ka=w(()=>C.value.status==="finalized"?"班表已鎖定":C.value.status==="ready"?"可執行最終發布":"等待完成發布"),bt=w(()=>{if(C.value.status==="finalized")return 100;const t=C.value.totalEmployees;if(!t||t<=0)return C.value.status==="draft"?0:20;const e=Math.max(t-C.value.pendingEmployees.length,0),a=Math.round(e/t*100);return Math.min(Math.max(a,0),100)}),Rt=w(()=>He.value||!C.value.hasSchedules||C.value.status==="finalized"),Tt=w(()=>Ge.value||C.value.status!=="ready");me(ie,t=>{const e=Ie()||ke();if(!t){Q.value&&(Q.value=!1),mt(!1,e);return}const a=zt(e);a===!0?Q.value=!0:a===!1&&e&&mt(!1,e)});const Ae=t=>{var l,n;const e=(l=ce)==null?void 0:l.warning;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.warning:void 0;typeof a=="function"&&a!==e&&a(t)},Xe=t=>{var l,n;const e=(l=ce)==null?void 0:l.info;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.info:void 0;typeof a=="function"&&a!==e&&a(t)},St=t=>{var l,n;const e=(l=ce)==null?void 0:l.success;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.success:void 0;typeof a=="function"&&a!==e&&a(t)},Ca=t=>{if(!t)return"";const e=B(t);return e.isValid()?e.format("YYYY/MM/DD HH:mm"):""},Ea=t=>{if(!t)return"";const e=B(t);return e.isValid()?e.format("MM/DD"):""};function Ft(){const t={month:L.value};return V.value&&(t.department=V.value),z.value&&(t.subDepartment=z.value),Q.value&&ie.value&&(t.includeSelf=!0),t}async function Da(){if(!He.value)try{He.value=!0;const t=await J("/api/schedules/publish",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Ft())});if(!t.ok){let e="發布失敗";try{const a=await t.json();a!=null&&a.error&&(e=a.error)}catch{}throw new Error(e)}St("已將班表發送給員工確認"),await te(),await ue()}catch(t){Ae((t==null?void 0:t.message)||"發布失敗")}finally{He.value=!1}}async function Aa(){if(!Ge.value)try{Ge.value=!0;const t=await J("/api/schedules/publish/finalize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Ft())});if(t.status===409){let e="仍有員工未回覆";try{const a=await t.json();a!=null&&a.error&&(e=a.error)}catch{}Ae(e),await te();return}if(!t.ok){let e="完成發布失敗";try{const a=await t.json();a!=null&&a.error&&(e=a.error)}catch{}throw new Error(e)}St("班表已完成發布"),await te(),await ue()}catch(t){Ae((t==null?void 0:t.message)||"完成發布失敗")}finally{Ge.value=!1}}async function Ia(){if(Rt.value){Ae("目前沒有可發布的班表");return}try{await Ve.confirm("確認要將本月班表發送給員工確認嗎？","批次發布",{type:"warning",confirmButtonText:"送出",cancelButtonText:"取消"})}catch{return}await Da()}async function Va(){if(C.value.status==="finalized"){Xe("班表已完成發布");return}if(Tt.value){Ae("仍有員工尚未回覆，請確認後再完成發布");return}try{await Ve.confirm("全部員工已確認，是否完成發布並鎖定班表？","完成發布",{type:"success",confirmButtonText:"完成",cancelButtonText:"取消"})}catch{return}await Aa()}const Ut=t=>({pending:"待簽核",approved:"已核可",rejected:"已否決",returned:"已退簽"})[t]||t||"-",$a=t=>{if(t&&typeof t=="object"){const e=t._id||t.employeeId||"";return t.name||vt[e]||e}return vt[t]||t||"-"},xa=(t,e)=>Z(t,e)?"已核准請假，該日不列入工作時數":"",re=w(()=>{const t=B(L.value+"-01"),e=t.endOf("month").date(),a=["日","一","二","三","四","五","六"];return Array.from({length:e},(l,n)=>{const i=n+1,c=a[t.date(i).day()];return{date:i,label:`${i}(${c})`}})});async function za(){const t=await J("/api/shifts");if(t.ok){const e=await t.json(),a=Array.isArray(e==null?void 0:e.shifts)?e.shifts:Array.isArray(e)?e:[];Array.isArray(a)&&(he.value=a.map(l=>({_id:l._id,code:l.code,name:l.name??"",startTime:l.startTime,endTime:l.endTime,remark:l.remark})))}else t.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",t.status)}async function Yt(t=""){try{const e=t||H.value,a=e?`/api/sub-departments?department=${e}`:"/api/sub-departments",l=await J(a);if(!l.ok)throw new Error("Failed to fetch sub departments");const n=await l.json(),i=ee.value.reduce((u,s)=>{const _=String(s._id);return u[_]=_,s.name&&(u[s.name]=_),u},{});H.value&&(i[H.value]=H.value),oe.value&&(i[oe.value]=H.value||oe.value);const c=Array.isArray(n)?n.map(u=>{const s=u==null?void 0:u.department;let _="";return s&&typeof s=="object"?_=(s==null?void 0:s._id)||(s==null?void 0:s.id)||i[s==null?void 0:s.name]||"":_=i[s]||s||"",{...u,_id:String((u==null?void 0:u._id)??(u==null?void 0:u.id)??""),department:String(_)}}).filter(u=>u._id):[];let r=c;if(e&&(r=c.filter(u=>u.department===String(e)),!r.length&&O.value)){const u=c.find(s=>s._id===O.value);u?r=[u]:r=[{_id:O.value,name:Ye.value||"",department:String(e)}]}if(!r.length&&c.length&&(r=c),De.role==="supervisor"){const u=ye.value.length?ye.value:O.value?[O.value]:[],s=new Set(u.map(_=>String(_)));s.size&&(r=r.filter(_=>s.has(String(_._id))))}ne.value=r,ne.value.length?O.value&&ne.value.some(u=>u._id===O.value)?z.value=O.value:z.value&&ne.value.some(u=>u._id===z.value)||(z.value=ne.value[0]._id):z.value=""}catch(e){console.error(e),ne.value=[],z.value=""}}async function Ma(){var t;try{const e=await J("/api/departments"),a=e.ok?await e.json():[],l=Array.isArray(a)?a.map(r=>{const u=(r==null?void 0:r._id)??(r==null?void 0:r.id)??(r==null?void 0:r.value)??"";return{...r,_id:String(u),name:(r==null?void 0:r.name)??""}}).filter(r=>r._id):[],n=V.value||H.value;let i=l;n&&(i=l.filter(r=>r._id===n||oe.value&&r.name===oe.value),!i.length&&n&&(i=[{_id:n,name:oe.value||((t=l.find(r=>r._id===n))==null?void 0:t.name)||""}])),ee.value=i.length?i:l,ee.value.length?ee.value.some(r=>r._id===V.value)||(V.value=ee.value[0]._id):!V.value&&n&&(V.value=n);const c=V.value||H.value||(ee.value.length?ee.value[0]._id:"");await Yt(c)}catch(e){console.error(e)}}function Ie(){return Lt.value?ke():""}async function ja(){if(De.role!=="supervisor"){H.value="",oe.value="",O.value="",Ye.value="",ye.value=[],Be.value=null;return}const t=Ie();if(!t){H.value="",oe.value="",O.value="",Ye.value="",ye.value=[],Be.value=null;return}let e=null;try{const u=await J(`/api/employees/${t}`);if(!u.ok)throw new Error("Failed to fetch supervisor context");e=await u.json()}catch(u){console.error(u),Be.value=null}Be.value=e||null;const a=e==null?void 0:e.department;let l="",n="";if(a&&typeof a=="object")l=(a==null?void 0:a._id)||(a==null?void 0:a.id)||(a==null?void 0:a.value)||"",n=(a==null?void 0:a.name)||(e==null?void 0:e.departmentName)||"";else if(typeof a=="string"){const u=ee.value.find(s=>String(s==null?void 0:s._id)===a||String((s==null?void 0:s.id)??"")===a||(s==null?void 0:s.code)===a||(s==null?void 0:s.name)===a);l=(u==null?void 0:u._id)||(u==null?void 0:u.id)||a,n=(u==null?void 0:u.name)||(e==null?void 0:e.departmentName)||a}H.value=l?String(l):"",oe.value=n?String(n):"",H.value?V.value=H.value:V.value="";const i=e==null?void 0:e.subDepartment;let c="",r="";if(i&&typeof i=="object")c=(i==null?void 0:i._id)||(i==null?void 0:i.id)||(i==null?void 0:i.value)||"",r=(i==null?void 0:i.name)||(e==null?void 0:e.subDepartmentName)||"";else if(typeof i=="string"){const u=ne.value.find(s=>String(s==null?void 0:s._id)===i||String((s==null?void 0:s.id)??"")===i||(s==null?void 0:s.code)===i||(s==null?void 0:s.name)===i);c=(u==null?void 0:u._id)||(u==null?void 0:u.id)||i,r=(u==null?void 0:u.name)||(e==null?void 0:e.subDepartmentName)||i}O.value=c?String(c):"",Ye.value=r?String(r):"",O.value?z.value=O.value:z.value="",await Na(t)}async function Na(t=""){if(De.role!=="supervisor"){ye.value=[];return}const e=t||Ie();if(!e){ye.value=O.value?[String(O.value)]:[];return}try{const a=await J(`/api/employees?supervisor=${e}`);if(!a.ok)throw new Error("Failed to fetch direct reports");const l=await a.json(),n=Array.isArray(l)?l:[],i=new Set,c=[],r=u=>{if(!u&&u!==0)return;const s=String(u);s&&(i.has(s)||(i.add(s),c.push(s)))};n.forEach(u=>{const s=u==null?void 0:u.subDepartment;r(s&&typeof s=="object"?(s==null?void 0:s._id)||(s==null?void 0:s.id)||(s==null?void 0:s.value):s)}),r(O.value),ye.value=c}catch(a){console.error(a),ye.value=O.value?[String(O.value)]:[]}}function wt(t){const e=String(t);m.value[e]||(m.value[e]={});const a=W.value.find(n=>String(n._id)===e)||{},l={shiftId:"",department:a.departmentId||"",subDepartment:a.subDepartmentId||""};re.value.forEach(n=>{m.value[e][n.date]?(m.value[e][n.date].shiftId=m.value[e][n.date].shiftId||"",m.value[e][n.date].department=m.value[e][n.date].department||l.department,m.value[e][n.date].subDepartment=m.value[e][n.date].subDepartment||l.subDepartment):m.value[e][n.date]={...l}})}function Pa(){m.value={},Ue.value=[],at.value=null,lt.value=new Set,$e.value=[],Qe.value={}}async function te({reset:t=!1}={}){let e=Pt.value;if(!e.length&&W.value.length){const r=(X.value-1)*fe.value,u=r+fe.value;e=W.value.slice(r,u).map(s=>String(s._id))}const a=e.length>0;if(t&&Pa(),!(t||!a||e.some(r=>!lt.value.has(r)))||ft.value)return;ft.value=!0;const n=Ie(),i=[`month=${L.value}`];(a||n)&&(i.push(`page=${X.value}`),i.push(`limit=${fe.value}`),i.push(`employeeIds=${e.join(",")}`)),n&&i.push(`supervisor=${n}`),Q.value&&ie.value&&i.push("includeSelf=true");const c=`?${i.join("&")}`;try{const r=await J(`/api/schedules/monthly${c}`);if(!r.ok)throw new Error("Failed to fetch schedules");const u=await r.json(),s=Array.isArray(u)?u:Array.isArray(u==null?void 0:u.schedules)?u.schedules:[],_=Array.isArray(u)?null:u==null?void 0:u.publishSummary;at.value=_?{status:_.status||"draft",pendingEmployees:_.pendingEmployees||[],disputedEmployees:_.disputedEmployees||[],publishedAt:_.publishedAt||null,hasSchedules:_.hasSchedules??!1,totalEmployees:_.totalEmployees??0,allEmployeesConfirmed:_.allEmployeesConfirmed??!1}:null,Ue.value=s;const E=new Set(e);e.forEach(k=>wt(k)),s.forEach(k=>{var Y;const ae=((Y=k.employee)==null?void 0:Y._id)||k.employee;if(!ae)return;const q=String(ae);if(!E.has(q))return;wt(q);const o=B(k.date).date(),v=W.value.find(j=>String(j._id)===q)||{};m.value[q][o]={id:k._id,shiftId:k.shiftId,department:k.department||v.departmentId,subDepartment:k.subDepartment||v.subDepartmentId}});const I=[`month=${L.value}`];(a||n)&&I.push(`employeeIds=${e.join(",")}`),Q.value&&ie.value&&I.push("includeSelf=true"),n&&I.push(`supervisor=${n}`);const F=V.value,M=z.value;F&&I.push(`department=${F}`),M&&I.push(`subDepartment=${M}`);const S=`?${I.join("&")}`,D=await J(`/api/schedules/leave-approvals${S}`);if(D!=null&&D.ok&&typeof D.json=="function"){const k=await D.json(),ae=Array.isArray(k==null?void 0:k.approvals)?k.approvals:[],q=Array.isArray(k==null?void 0:k.leaves)?k.leaves:[];$e.value=ae;const o={},v=B(`${L.value}-01`).startOf("day"),Y=v.endOf("month").startOf("day");q.forEach(j=>{var qt,Ht,Gt;if(String(j.status||j.decision||"").toLowerCase()!=="approved")return;const G=((qt=j.employee)==null?void 0:qt._id)||j.employee;if(!G)return;const de=String(G);if(!(E.size>0?E.has(de):W.value.some(Te=>String(Te==null?void 0:Te._id)===de)))return;wt(de);const Re=B(j.startDate).startOf("day"),A=B(j.endDate).startOf("day");if(!Re.isValid()||!A.isValid())return;let ut=Re.isBefore(v)?v:Re;const Ja=A.isAfter(Y)?Y:A;for(;!ut.isAfter(Ja);){const Te=ut.date();o[de]||(o[de]={}),o[de][Te]=!0;const Qt=(Gt=(Ht=m.value)==null?void 0:Ht[de])==null?void 0:Gt[Te];Qt&&(Qt.leave={type:j.leaveType,startDate:j.startDate,endDate:j.endDate,excludesHours:!0}),ut=ut.add(1,"day")}}),Qe.value=o}else $e.value=[],Qe.value={};const U=Ie()||ke();if(Q.value&&ie.value&&U){const k=s.some(q=>{var v;const o=((v=q==null?void 0:q.employee)==null?void 0:v._id)||(q==null?void 0:q.employee);return o&&String(o)===U}),ae=[L.value,V.value||"",z.value||""].join("|");k?Ne.value&&(Ne.value=""):Ne.value!==ae&&(Xe("尚未為主管建立班表，請先建立排班。"),Ne.value=ae)}else Ne.value&&(Ne.value="");const Le=new Set(lt.value);e.forEach(k=>Le.add(k)),lt.value=Le,st()}catch(r){console.error(r),ce.error("取得排班資料失敗"),Ue.value=[]}finally{ft.value=!1}}function Oa(t){X.value=t,te()}function La(t){fe.value=t,X.value=1,te()}async function Ra(t){var n;if(!t)return;R.visible=!1,R.doc=null;const e=await J(`/api/approvals/${t}`);if(!e.ok)return;const a=await e.json();R.doc=a,R.visible=!0,(Array.isArray((n=R.doc)==null?void 0:n.steps)?R.doc.steps:[]).forEach(i=>{(Array.isArray(i==null?void 0:i.approvers)?i.approvers:[]).forEach(r=>{var u,s;(u=r==null?void 0:r.approver)!=null&&u._id&&((s=r==null?void 0:r.approver)!=null&&s.name)&&(vt[r.approver._id]=r.approver.name)})})}function Bt(t){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:m.value,employees:W.value,days:re.value,shifts:he.value})),_a.push({name:t==="week"?"PreviewWeek":"PreviewMonth"})}async function Jt(t){try{const e=await J(`/api/schedules/export?month=${L.value}&format=${t}`);if(!e.ok)throw new Error;const a=await e.blob(),l=URL.createObjectURL(a),n=document.createElement("a");n.href=l,n.download=`schedules-${L.value}.${t==="excel"?"xlsx":"pdf"}`,n.click(),URL.revokeObjectURL(l)}catch{ce.error("匯出失敗")}}async function Ta(t,e,a){const l=`${L.value}-${String(e).padStart(2,"0")}`,n=m.value[t][e];if(n!=null&&n.leave||Z(t,e)){Xe("該日已核准請假，無法調整排班");return}const i=(n==null?void 0:n.shiftId)??"";if(n&&n.id)try{const c=await J(`/api/schedules/${n.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:a,department:n.department,subDepartment:n.subDepartment})});c.ok?await ue():await ot(c,"更新排班失敗",t,e,i)}catch{await ot(null,"更新排班失敗",t,e,i)}else try{const c=await J("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:t,date:l,shiftId:a,department:n.department,subDepartment:n.subDepartment})});if(c.ok){const r=await c.json();m.value[t][e]={id:r._id,shiftId:r.shiftId,department:n.department,subDepartment:n.subDepartment},await ue()}else await ot(c,"新增排班失敗",t,e,i)}catch{await ot(null,"新增排班失敗",t,e,i)}}async function Fa(){z.value="",await Yt(V.value),await rt(V.value,""),X.value=1,await te({reset:!0}),await ue()}async function Ua(){await rt(V.value,z.value),X.value=1,await te({reset:!0}),await ue()}async function ot(t,e,a,l,n){m.value[a]||(m.value[a]={});const i=m.value[a][l]||{shiftId:"",department:"",subDepartment:""};i.shiftId=n,m.value[a][l]=i;let c="";try{if(t){const r=await t.json();c=(r==null?void 0:r.error)||""}}catch{}c==="employee conflict"?Ve.alert("人員衝突"):c==="department overlap"?Ve.alert("跨區重複"):c==="leave conflict"?Ve.alert("請假衝突"):ce.error(e)}async function Kt(t,e="批次套用失敗"){let a="";try{if(t){const l=await t.json();a=(l==null?void 0:l.error)||""}}catch{}a==="employee conflict"?ce.warning("部分員工既有排班已更新，請重新整理檢查"):a==="department overlap"?Ve.alert("部門或單位與既有資料不一致，無法套用"):a==="leave conflict"?Ve.alert("選取日期包含已核准請假，無法套用"):a?ce.error(a):ce.error(e)}async function Ya(){if(!_t.value){Ae("請先選取要套用的儲存格");return}if(!qe.value){Ae("請選擇欲套用的班別");return}const t=[];if(yt.value.forEach(l=>{var s;const{empId:n,day:i}=ht(l),c=(s=m.value[n])==null?void 0:s[i];if(!c||Z(n,i))return;const r=_e.value||c.department||"";let u=c.subDepartment||"";_e.value?u=ve.value||"":ve.value&&(u=ve.value),t.push({employee:n,day:i,date:`${L.value}-${String(i).padStart(2,"0")}`,shiftId:qe.value,department:r,subDepartment:u})}),!t.length){Xe("選取的儲存格皆無需更新（或皆為請假日）");return}const e=new Map;t.forEach(l=>{e.set(ge(l.employee,l.day),l)}),tt.value=!0;const a=Ga.service({fullscreen:!0,lock:!0,text:"批次套用中..."});try{let l;try{l=await J("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:t.map(({day:i,...c})=>c)})})}catch{await Kt(null);return}if(!l.ok){await Kt(l);return}const n=await l.json();if(!Array.isArray(n)||!n.length){Xe("沒有可更新的資料");return}n.forEach(i=>{var E;const c=((E=i.employee)==null?void 0:E._id)||i.employee,r=B(i.date).date();m.value[c]||(m.value[c]={});const u=ge(c,r),s=e.get(u)||{},_=m.value[c][r]||{};m.value[c][r]={..._,id:i._id||s.id||_.id,shiftId:i.shiftId||s.shiftId||_.shiftId,department:s.department??i.department??_.department??"",subDepartment:s.subDepartment??i.subDepartment??_.subDepartment??""}}),St("批次套用完成"),await ue()}finally{a==null||a.close(),tt.value=!1}}function be(t){return he.value.find(e=>e._id===t)}function it(t){if(!t)return"";const e=t.code??"",a=t.name??"";return!e&&!a?"":a?`${e}(${a})`:e}function kt(t){const e=t&&typeof t=="object"?t:be(t);return e?Xa(e):{}}function Wt(t){return ne.value.filter(e=>e.department===t)}async function rt(t="",e=""){var r;const a=Ie(),l=[],n=t||V.value||H.value,i=e||z.value;a&&l.push(`supervisor=${a}`),n&&l.push(`department=${n}`),i&&l.push(`subDepartment=${i}`);const c=`/api/employees${l.length?`?${l.join("&")}`:""}`;try{const u=await J(c);if(!u.ok)throw new Error("Failed to fetch employees");const s=typeof u.json=="function"?await u.json():[],_=Array.isArray(s)?s:[],E=ee.value.reduce((S,D)=>(S[D._id]=D.name,S),{}),I=ne.value.reduce((S,D)=>(S[D._id]=D.name,S),{}),F=_.map(S=>{const D=(S==null?void 0:S._id)??(S==null?void 0:S.id)??"",U=(S==null?void 0:S.department)??"",Ze=(S==null?void 0:S.subDepartment)??"",Le=D?String(D):"",k=U?String(U):"",ae=Ze?String(Ze):"";return{_id:Le,name:S.name,departmentId:k,subDepartmentId:ae,department:E[k]||"",subDepartment:I[ae]||""}});let M=Nt(F);if(Q.value&&ie.value){const S=a?String(a):"";S&&!M.some(D=>D._id===S)&&(M=Nt([...M,{_id:S,name:((r=Be.value)==null?void 0:r.name)||"主管本人",departmentId:H.value||"",subDepartmentId:O.value||"",department:oe.value||"",subDepartment:Ye.value||""}]))}W.value=M,st()}catch(u){console.error(u),ce.error("取得員工資料失敗")}}async function ue(){try{const t=[`month=${L.value}`];V.value&&t.push(`department=${V.value}`),z.value&&t.push(`subDepartment=${z.value}`),Q.value&&ie.value&&t.push("includeSelf=true");const e=await J(`/api/schedules/summary?${t.join("&")}`);if(!e.ok)return;const a=await e.json(),l=Array.isArray(a)?a:[],n=B(`${L.value}-01`).daysInMonth();$t.value={direct:l.length,unscheduled:l.filter(i=>{const c=Number(i.shiftCount||0),r=Number(i.leaveCount||0);return c+r<n}).length,onLeave:l.filter(i=>Number(i.leaveCount||0)>0).length}}catch(t){console.error(t)}}async function Ba(t){const e=t?B(t):B();L.value=e.isValid()?e.format("YYYY-MM"):B().format("YYYY-MM"),X.value=1,await te({reset:!0}),await ue()}return Wa(async()=>{const t=ke();zt(t)===!0&&ie.value&&(Q.value=!0);try{await ue(),await za(),await ja(),await Ma(),await rt(V.value,z.value),await te({reset:!0})}finally{Vt=!1}}),(t,e)=>{const a=x("el-date-picker"),l=x("el-option"),n=x("el-select"),i=x("el-switch"),c=x("el-step"),r=x("el-steps"),u=x("el-progress"),s=x("el-button"),_=x("el-input"),E=x("el-table-column"),I=x("el-checkbox"),F=x("el-tag"),M=x("el-popover"),S=x("el-table"),D=x("el-pagination"),U=x("el-divider"),Ze=x("el-descriptions-item"),Le=x("el-descriptions"),k=x("el-timeline-item"),ae=x("el-timeline"),q=x("el-dialog");return p(),h(P,null,[d("div",sl,[e[48]||(e[48]=d("div",{class:"page-header"},[d("h1",{class:"page-title"},"排班管理"),d("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),f(ll,{summary:$t.value},null,8,["summary"]),d("div",nl,[e[22]||(e[22]=d("div",{class:"filters-header"},[d("h3",{class:"filters-title"},"篩選條件")],-1)),d("div",ol,[d("div",il,[e[18]||(e[18]=d("label",{class:"filter-label"},"選擇月份",-1)),f(a,{modelValue:L.value,"onUpdate:modelValue":e[0]||(e[0]=o=>L.value=o),type:"month","value-format":"YYYY-MM",onChange:Ba,class:"modern-date-picker"},null,8,["modelValue"])]),d("div",rl,[e[19]||(e[19]=d("label",{class:"filter-label"},"部門",-1)),f(n,{modelValue:V.value,"onUpdate:modelValue":e[1]||(e[1]=o=>V.value=o),placeholder:"請選擇部門",onChange:Fa,disabled:!0,class:"modern-select"},{default:y(()=>[(p(!0),h(P,null,K(ee.value,o=>(p(),T(l,{key:o._id,label:o.name,value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),d("div",ul,[e[20]||(e[20]=d("label",{class:"filter-label"},"單位",-1)),f(n,{modelValue:z.value,"onUpdate:modelValue":e[2]||(e[2]=o=>z.value=o),placeholder:"請選擇單位",onChange:Ua,class:"modern-select"},{default:y(()=>[(p(!0),h(P,null,K(ya.value,o=>(p(),T(l,{key:o._id,label:o.name,value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),ie.value?(p(),h("div",dl,[e[21]||(e[21]=d("label",{class:"filter-label"},"包含自己",-1)),f(i,{modelValue:Q.value,"onUpdate:modelValue":e[3]||(e[3]=o=>Q.value=o),"active-text":"是","inactive-text":"否","inline-prompt":""},null,8,["modelValue"])])):N("",!0)])]),Se(je)?(p(),h("div",cl,[d("div",pl,[e[23]||(e[23]=d("div",{class:"publish-header-text"},[d("h3",{class:"publish-title"},"發布狀態"),d("p",{class:"publish-subtitle"},"追蹤班表送審、回覆與鎖定流程")],-1)),d("span",{class:Zt(["status-badge",`status-${C.value.status}`]),"data-test":"publish-status-badge"},b(ga.value),3)]),d("div",vl,[f(r,{active:ba.value,"finish-status":"success","align-center":""},{default:y(()=>[f(c,{title:"草稿",description:"建立班表草稿",status:nt.value.draft},null,8,["status"]),f(c,{title:"待確認",description:Sa.value,status:nt.value.pending},null,8,["description","status"]),f(c,{title:"異議",description:wa.value,status:nt.value.disputed},null,8,["description","status"]),f(c,{title:"完成",description:ka.value,status:nt.value.finalized},null,8,["description","status"])]),_:1},8,["active"])]),d("div",fl,[C.value.publishedAt?(p(),h("p",ml," 最近發布："+b(Ca(C.value.publishedAt)),1)):(p(),h("p",hl,"本月尚未發布。")),bt.value>0&&C.value.status!=="finalized"?(p(),h("div",yl,[f(u,{percentage:bt.value,"stroke-width":8,status:"success","show-text":!1},null,8,["percentage"]),d("span",_l,b(bt.value)+"% 完成",1)])):N("",!0)]),d("div",gl,[f(s,{type:"primary",class:"publish-btn",loading:He.value,disabled:Rt.value,onClick:Ia},{default:y(()=>[...e[24]||(e[24]=[$(" 發送待確認 ",-1)])]),_:1},8,["loading","disabled"]),f(s,{type:"success",plain:"",class:"publish-btn",loading:Ge.value,disabled:Tt.value,onClick:Va},{default:y(()=>[...e[25]||(e[25]=[$(" 完成發布 ",-1)])]),_:1},8,["loading","disabled"])]),d("div",bl,[Pe.value?(p(),h("div",Sl,[d("div",wl,[e[26]||(e[26]=d("span",{class:"card-title"},"待回覆",-1)),d("span",kl,b(Pe.value),1)]),d("ul",Cl,[(p(!0),h(P,null,K(C.value.pendingEmployees,o=>(p(),h("li",{key:o.id,class:"card-item"},[d("span",El,b(o.name),1),d("span",Dl,b(o.pendingCount)+" 筆",1)]))),128))])])):N("",!0),Oe.value?(p(),h("div",Al,[d("div",Il,[e[27]||(e[27]=d("span",{class:"card-title"},"異議",-1)),d("span",Vl,b(Oe.value),1)]),d("ul",$l,[(p(!0),h(P,null,K(C.value.disputedEmployees,o=>(p(),h("li",{key:o.id,class:"card-item"},[d("div",xl,[d("span",zl,b(o.name),1),d("span",Ml,b(o.disputedCount)+" 筆",1)]),o.disputes&&o.disputes.length>0?(p(),h("div",jl,[(p(!0),h(P,null,K(o.disputes,(v,Y)=>(p(),h("div",{key:Y,class:"dispute-item"},[d("div",Nl,b(Ea(v.date)),1),v.note?(p(),h("div",Pl,b(v.note),1)):(p(),h("div",Ol," （無具體說明） "))]))),128))])):N("",!0)]))),128))])])):N("",!0),!Pe.value&&!Oe.value&&C.value.status!=="draft"&&C.value.status!=="finalized"?(p(),h("div",Ll,[...e[28]||(e[28]=[d("div",{class:"card-header"},[d("span",{class:"card-title"},"回覆完成"),d("span",{class:"card-badge success"},"✓")],-1),d("p",{class:"card-message"},"所有員工已完成回覆，可執行最終發布。",-1)])])):N("",!0),C.value.status==="finalized"?(p(),h("div",Rl,[...e[29]||(e[29]=[d("div",{class:"card-header"},[d("span",{class:"card-title"},"已鎖定"),d("span",{class:"card-badge success"},"100%")],-1),d("p",{class:"card-message"},"班表已完成發布並鎖定。",-1)])])):N("",!0)])])):N("",!0),d("div",Tl,[d("div",Fl,[f(s,{type:"primary",class:"action-btn primary",onClick:ra,disabled:!_t.value},{default:y(()=>[...e[30]||(e[30]=[d("i",{class:"el-icon-close"},null,-1),$(" 清除選取 ",-1)])]),_:1},8,["disabled"]),f(s,{type:"primary",class:"action-btn primary",plain:"",onClick:pa,disabled:!W.value.length},{default:y(()=>[...e[31]||(e[31]=[d("i",{class:"el-icon-user"},null,-1),$(" 全選員工 ",-1)])]),_:1},8,["disabled"]),f(s,{type:"primary",class:"action-btn primary",plain:"",onClick:va,disabled:!re.value.length},{default:y(()=>[...e[32]||(e[32]=[d("i",{class:"el-icon-date"},null,-1),$(" 全選日期 ",-1)])]),_:1},8,["disabled"])]),d("div",Ul,[d("div",Yl,[e[33]||(e[33]=d("label",{class:"range-label"},"自訂日期範圍",-1)),f(a,{modelValue:pt.value,"onUpdate:modelValue":e[4]||(e[4]=o=>pt.value=o),type:"daterange","start-placeholder":"開始日期","end-placeholder":"結束日期","range-separator":"至","unlink-panels":"",disabled:!re.value.length,class:"modern-date-picker range-picker",onChange:fa},null,8,["modelValue","disabled"])]),f(s,{onClick:e[5]||(e[5]=o=>Bt("week")),class:"action-btn secondary"},{default:y(()=>[...e[34]||(e[34]=[d("i",{class:"el-icon-calendar"},null,-1),$(" 預覽週表 ",-1)])]),_:1}),f(s,{onClick:e[6]||(e[6]=o=>Bt("month")),class:"action-btn secondary"},{default:y(()=>[...e[35]||(e[35]=[d("i",{class:"el-icon-date"},null,-1),$(" 預覽月表 ",-1)])]),_:1}),f(s,{onClick:e[7]||(e[7]=()=>Jt("pdf")),class:"action-btn export"},{default:y(()=>[...e[36]||(e[36]=[d("i",{class:"el-icon-download"},null,-1),$(" 匯出 PDF ",-1)])]),_:1}),f(s,{onClick:e[8]||(e[8]=()=>Jt("excel")),class:"action-btn export"},{default:y(()=>[...e[37]||(e[37]=[d("i",{class:"el-icon-s-grid"},null,-1),$(" 匯出 Excel ",-1)])]),_:1})])]),d("div",Bl,[d("div",Jl,[e[39]||(e[39]=d("h3",{class:"schedule-title"},"員工排班表",-1)),d("div",Kl,[Mt.value.length?(p(!0),h(P,{key:0},K(Mt.value,o=>(p(),h("span",{key:o.key,class:"legend-item",style:dt(o.style),"data-test":"shift-legend-item"},b(o.label),5))),128)):(p(),h("span",Wl," 尚未設定班別 ")),e[38]||(e[38]=d("span",{class:"legend-item leave"},"請假",-1))]),f(_,{modelValue:Je.value,"onUpdate:modelValue":e[9]||(e[9]=o=>Je.value=o),placeholder:"搜尋員工",clearable:"",class:"employee-search"},null,8,["modelValue"]),f(n,{modelValue:Ke.value,"onUpdate:modelValue":e[10]||(e[10]=o=>Ke.value=o),placeholder:"狀態",class:"status-filter"},{default:y(()=>[f(l,{label:"全部",value:"all"}),f(l,{label:"缺班",value:"unscheduled"}),f(l,{label:"待審核請假",value:"onLeave"})]),_:1},8,["modelValue"])]),Se(je)?(p(),h("div",ql,[f(n,{modelValue:qe.value,"onUpdate:modelValue":e[11]||(e[11]=o=>qe.value=o),placeholder:"套用班別",class:"modern-select batch-select",filterable:"","data-test":"batch-shift-select"},{default:y(()=>[(p(!0),h(P,null,K(he.value,o=>(p(),T(l,{key:o._id,label:it(o),value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(n,{modelValue:_e.value,"onUpdate:modelValue":e[12]||(e[12]=o=>_e.value=o),placeholder:"套用部門",clearable:"",class:"modern-select batch-select","data-test":"batch-dept-select"},{default:y(()=>[(p(!0),h(P,null,K(ee.value,o=>(p(),T(l,{key:o._id,label:o.name,value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(n,{modelValue:ve.value,"onUpdate:modelValue":e[13]||(e[13]=o=>ve.value=o),placeholder:"套用單位",clearable:"",class:"modern-select batch-select",disabled:!_e.value,"data-test":"batch-subdept-select"},{default:y(()=>[(p(!0),h(P,null,K(jt.value,o=>(p(),T(l,{key:o._id,label:o.name,value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),f(s,{type:"primary",class:"action-btn primary apply-btn",disabled:!_t.value||!qe.value||tt.value,loading:tt.value,onClick:Ya,"data-test":"batch-apply-button"},{default:y(()=>[...e[40]||(e[40]=[$(" 套用至選取 ",-1)])]),_:1},8,["disabled","loading"])])):N("",!0),f(S,{class:"modern-schedule-table",data:Me.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"},onRowClick:e[15]||(e[15]=o=>Ot.value&&ha(o._id))},{default:y(()=>[f(E,{label:"部門／單位",width:"180",fixed:"left"},{default:y(({row:o})=>[d("div",Hl,[d("div",Gl,b(o.department),1),o.subDepartment?(p(),h("div",Ql,b(o.subDepartment),1)):N("",!0)])]),_:1}),f(E,{prop:"name",label:"員工姓名",width:"150",fixed:"left"},{default:y(({row:o})=>[d("div",Xl,[Se(je)?(p(),T(I,{key:0,class:"row-checkbox","model-value":la.value.has(o._id),onChange:v=>ua(o._id,v)},null,8,["model-value","onChange"])):N("",!0),gt(o._id)==="unscheduled"?(p(),T(Et(Se(ta)),{key:1,class:"status-icon unscheduled"})):gt(o._id)==="onLeave"?(p(),T(Et(Se(aa)),{key:2,class:"status-icon on-leave"})):N("",!0),$(" "+b(o.name),1)])]),_:1}),(p(!0),h(P,null,K(re.value,o=>(p(),T(E,{key:o.date,label:o.label,width:"140",align:"center"},{header:y(()=>[d("div",Zl,[d("span",null,b(o.label),1),Se(je)?(p(),T(I,{key:0,class:"day-checkbox","model-value":sa.value.has(o.date),onChange:v=>da(o.date,v)},null,8,["model-value","onChange"])):N("",!0)])]),default:y(({row:v})=>{var Y,j,se,G,de,Ct,Re;return[!Ot.value||et.value.has(v._id)?(p(),h("div",{key:0,class:Zt(["modern-schedule-cell",[{"has-leave":Z(v._id,o.date),"missing-shift":!((j=(Y=m.value[v._id])==null?void 0:Y[o.date])!=null&&j.shiftId)&&!Z(v._id,o.date),"is-selected":ia(v._id,o.date),"has-shift":!Z(v._id,o.date)&&!!((G=(se=m.value[v._id])==null?void 0:se[o.date])!=null&&G.shiftId)}]]),style:dt(Z(v._id,o.date)?void 0:kt((Ct=(de=m.value[v._id])==null?void 0:de[o.date])==null?void 0:Ct.shiftId)),title:xa(v._id,o.date)},[Se(je)&&!Z(v._id,o.date)?(p(),h("div",{key:0,class:"cell-selection",onClick:e[14]||(e[14]=Ha(()=>{},["stop"]))},[f(I,{"model-value":na.value.has(ge(v._id,o.date)),onChange:A=>ca(v._id,o.date,A),size:"small"},null,8,["model-value","onChange"])])):N("",!0),(Re=m.value[v._id])!=null&&Re[o.date]?(p(),h(P,{key:1},[Z(v._id,o.date)?(p(),h("div",ts,[f(F,{type:"warning",effect:"light",size:"small",class:"leave-tag"},{default:y(()=>[...e[41]||(e[41]=[$(" 休假中 ",-1)])]),_:1}),e[42]||(e[42]=d("span",{class:"leave-note"},"已核准請假，不列入工時",-1))])):Se(je)?(p(),h(P,{key:1},[f(n,{modelValue:m.value[v._id][o.date].shiftId,"onUpdate:modelValue":A=>m.value[v._id][o.date].shiftId=A,placeholder:"選擇班別",onChange:A=>Ta(v._id,o.date,A),class:"cell-select shift-select",size:"small"},{default:y(()=>[(p(!0),h(P,null,K(he.value,A=>(p(),T(l,{key:A._id,label:it(A),value:A._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),d("div",as,[f(n,{modelValue:m.value[v._id][o.date].department,"onUpdate:modelValue":A=>m.value[v._id][o.date].department=A,placeholder:"部門",size:"small",onChange:()=>m.value[v._id][o.date].subDepartment="",class:"cell-select dept-select"},{default:y(()=>[(p(!0),h(P,null,K(ee.value,A=>(p(),T(l,{key:A._id,label:A.name,value:A._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),f(n,{modelValue:m.value[v._id][o.date].subDepartment,"onUpdate:modelValue":A=>m.value[v._id][o.date].subDepartment=A,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:y(()=>[(p(!0),h(P,null,K(Wt(m.value[v._id][o.date].department),A=>(p(),T(l,{key:A._id,label:A.name,value:A._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(p(),h(P,{key:2},[be(m.value[v._id][o.date].shiftId)?(p(),T(M,{key:0,placement:"top",trigger:"hover",width:200},{reference:y(()=>[d("div",{class:"modern-shift-tag",style:dt(kt(be(m.value[v._id][o.date].shiftId)))},b(it(be(m.value[v._id][o.date].shiftId))),5)]),default:y(()=>[d("div",ls,[d("div",ss,[e[43]||(e[43]=d("span",{class:"detail-label"},"上班時間：",-1)),d("span",ns,b(be(m.value[v._id][o.date].shiftId).startTime),1)]),d("div",os,[e[44]||(e[44]=d("span",{class:"detail-label"},"下班時間：",-1)),d("span",is,b(be(m.value[v._id][o.date].shiftId).endTime),1)]),be(m.value[v._id][o.date].shiftId).remark?(p(),h("div",rs,[e[45]||(e[45]=d("span",{class:"detail-label"},"備註：",-1)),d("span",us,b(be(m.value[v._id][o.date].shiftId).remark),1)])):N("",!0)])]),_:2},1024)):N("",!0)],64)),!m.value[v._id][o.date].shiftId&&!Z(v._id,o.date)?(p(),h("div",ds," 未排班 ")):N("",!0)],64)):(p(),h("span",cs,"-"))],14,es)):(p(),h("div",ps," 展開班表 "))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"]),ze.value.length?(p(),h("div",vs,[f(D,{background:"",layout:"prev, pager, next, ->, sizes, total",total:ze.value.length,"page-size":fe.value,"current-page":X.value,"page-sizes":[10,20,30,50],onCurrentChange:Oa,onSizeChange:La},null,8,["total","page-size","current-page"])])):N("",!0)]),$e.value.length?(p(),h("div",fs,[d("div",ms,[e[46]||(e[46]=d("h3",{class:"approval-title"},"待處理審批",-1)),d("div",hs,b($e.value.length)+" 項待處理",1)]),f(S,{class:"modern-approval-table",data:$e.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:y(()=>[f(E,{label:"申請人",width:"120"},{default:y(({row:o})=>{var v;return[d("div",ys,b((v=o.applicant_employee)==null?void 0:v.name),1)]}),_:1}),f(E,{label:"申請類型",width:"150"},{default:y(({row:o})=>{var v,Y;return[d("div",_s,b(It((v=o.form)==null?void 0:v.category,(Y=o.form)==null?void 0:Y.name)),1)]}),_:1}),f(E,{prop:"status",label:"狀態",width:"100"},{default:y(({row:o})=>[f(F,{type:o.status==="approved"?"success":o.status==="rejected"?"danger":"warning",class:"status-tag"},{default:y(()=>[$(b(o.status),1)]),_:2},1032,["type"])]),_:1}),f(E,{label:"操作",width:"120"},{default:y(({row:o})=>[f(s,{size:"small",onClick:v=>Ra(o._id),disabled:!o._id},{default:y(()=>[...e[47]||(e[47]=[$(" 查看 ",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data"])])):N("",!0)]),f(q,{modelValue:R.visible,"onUpdate:modelValue":e[17]||(e[17]=o=>R.visible=o),title:"申請單明細",width:"760px"},{footer:y(()=>[f(s,{onClick:e[16]||(e[16]=o=>R.visible=!1)},{default:y(()=>[...e[54]||(e[54]=[$("關閉",-1)])]),_:1})]),default:y(()=>{var o,v,Y;return[R.doc?(p(),h("div",gs,[d("p",bs,[e[49]||(e[49]=d("b",null,"表單：",-1)),$(b((o=R.doc.form)==null?void 0:o.name)+"（"+b((v=R.doc.form)==null?void 0:v.category)+"） ",1)]),d("p",Ss,[e[50]||(e[50]=d("b",null,"申請人：",-1)),$(b(((Y=R.doc.applicant_employee)==null?void 0:Y.name)||"-"),1)]),d("p",ws,[e[51]||(e[51]=d("b",null,"狀態：",-1)),$(b(Ut(R.doc.status)),1)]),f(U,{"content-position":"left"},{default:y(()=>[...e[52]||(e[52]=[$("填寫內容",-1)])]),_:1}),f(Le,{column:1,size:"small",border:""},{default:y(()=>{var j;return[(p(!0),h(P,null,K(((j=R.doc.form)==null?void 0:j.fields)||[],se=>(p(),T(Ze,{key:se._id,label:se.label},{default:y(()=>{var G;return[d("span",null,b(ct((G=R.doc.form_data)==null?void 0:G[se._id])),1)]}),_:2},1032,["label"]))),128))]}),_:1}),f(U,{"content-position":"left"},{default:y(()=>[...e[53]||(e[53]=[$("流程",-1)])]),_:1}),f(ae,null,{default:y(()=>[(p(!0),h(P,null,K(R.doc.steps,(j,se)=>(p(),T(k,{key:se,timestamp:`第 ${se+1} 關`,type:se===R.doc.current_step_index?"primary":"info"},{default:y(()=>[d("div",ks,[d("span",Cs,"需全員同意："+b(j.all_must_approve?"是":"否"),1),d("span",null,"必簽："+b(j.is_required?"是":"否"),1)]),f(S,{data:j.approvers,size:"small",border:""},{default:y(()=>[f(E,{label:"審核人",width:"200"},{default:y(({row:G})=>[$(b($a(G.approver)),1)]),_:1}),f(E,{label:"決議",width:"120"},{default:y(({row:G})=>[$(b(Ut(G.decision)),1)]),_:1}),f(E,{label:"時間",width:"200"},{default:y(({row:G})=>[$(b(Fe(G.decided_at)),1)]),_:1}),f(E,{prop:"comment",label:"意見"})]),_:1},8,["data"])]),_:2},1032,["timestamp","type"]))),128))]),_:1})])):N("",!0)]}),_:1},8,["modelValue"])],64)}}},xs=ea(Ds,[["__scopeId","data-v-e2beebed"]]);export{xs as default};
