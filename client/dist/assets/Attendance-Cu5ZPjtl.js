import{_ as mt,r as N,j as nt,k as ft,N as pt,c as ht,b as i,d as T,v as F,w as _,e as U,D as L,z as gt,o as yt,p as ot,g as H,E as G}from"./index-DpSSJiaP.js";import{a as z}from"./api-Bv_P9dnf.js";const Q={},Y=(Q==null?void 0:Q.VITE_TIMEZONE)||"Asia/Taipei",W=60*1e3,rt=24*60*60*1e3,B=Object.freeze({clockIn:{earlyMinutes:60,lateMinutes:240},clockOut:{earlyMinutes:240,lateMinutes:120}}),bt=Object.freeze({earlyMinutes:{min:0,max:720},lateMinutes:{min:0,max:720}});function vt(t,{min:o=0,max:s=Number.POSITIVE_INFINITY}={}){const a=Number(t);return Number.isFinite(a)?Math.min(Math.max(a,o),s):null}const kt=Object.freeze({clockIn:"上班簽到",clockOut:"下班簽退"});function ct(t=B){const o={clockIn:{...B.clockIn},clockOut:{...B.clockOut}},s=typeof t=="object"&&t?t:{};return["clockIn","clockOut"].forEach(a=>{const l=o[a],d=s[a]||{};["earlyMinutes","lateMinutes"].forEach(r=>{const c=vt(d[r],bt[r]);c!==null&&(l[r]=c)})}),o}function X(t){const o=Number(t);return Number.isFinite(o)?o:NaN}function at(t){if(!t||typeof t!="string")return null;const o=t.trim().match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);if(!o)return null;const s=X(o[1]),a=X(o[2]),l=o[3]?X(o[3]):0;return Number.isNaN(s)||Number.isNaN(a)||Number.isNaN(l)||s<0||s>=24||a<0||a>=60||l<0||l>=60?null:{hour:s,minute:a,second:l}}function Z(t,o=Y){const{year:s,month:a,day:l,hour:d=0,minute:r=0,second:c=0}=t||{};if(!s||!a||!l)return null;const m=Date.UTC(s,a-1,l,d,r,c),y=new Date(m),p=new Intl.DateTimeFormat("en-US",{timeZone:o,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(y).reduce((b,g)=>(g.type!=="literal"&&(b[g.type]=g.value),b),{}),S=Date.UTC(Number(p.year),Number(p.month)-1,Number(p.day),Number(p.hour),Number(p.minute),Number(p.second))-y.getTime();return new Date(m-S)}function tt(t,o=Y){if(!t)return null;const a=new Intl.DateTimeFormat("en-US",{timeZone:o,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(new Date(t)).reduce((c,m)=>(m.type!=="literal"&&(c[m.type]=m.value),c),{}),l=Number(a.year),d=Number(a.month),r=Number(a.day);return!l||!d||!r?null:{year:l,month:d,day:r}}function st({year:t,month:o,day:s}){return!t||!o||!s?null:new Date(Date.UTC(t,o-1,s))}function wt(t,o=Y){if(!t&&t!==0)return null;if(t instanceof Date)return new Date(t);if(typeof t=="string"){const a=t.trim().match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);if(!a)return null;const l=Number(a[1]),d=Number(a[2]),r=Number(a[3]);return!l||!d||!r?null:new Date(Date.UTC(l,d-1,r))}return null}function Tt(t,o,s=Y){if(!t||!o)return null;const a=tt(t,s),l=at(o.startTime),d=at(o.endTime);if(!a||!l||!d)return null;const r=Z({...a,...l},s);let c=Z({...a,...d},s);return!r||!c?null:((o.crossDay||c<=r)&&(c=new Date(c.getTime()+rt)),{start:r,end:c})}function _t(t,o,s,a=B){if(!o||!s)return null;const l=ct(a)[t];if(!l)return null;const{earlyMinutes:d,lateMinutes:r}=l;if(t==="clockIn"){const c=new Date(o.getTime()-d*W),m=new Date(o.getTime()+r*W),y=m<s?m:s;return{start:c,end:y}}if(t==="clockOut"){const c=new Date(s.getTime()-d*W),m=c>o?c:o,y=new Date(s.getTime()+r*W);return{start:m,end:y}}return null}function Dt(t,o){if(!t||!o)return!1;const s=new Date(t).getTime();return Number.isNaN(s)?!1:s>=o.start.getTime()&&s<=o.end.getTime()}function Nt(t,o=Y){if(!t)return null;const s=new Intl.DateTimeFormat("zh-TW",{timeZone:o,hour:"2-digit",minute:"2-digit",hour12:!1});return{start:s.format(t.start),end:s.format(t.end)}}function It(t){return t&&typeof t=="object"&&typeof t.toString=="function"?t.toString():t||t===0?String(t):""}function it({now:t=new Date,schedules:o=[],shifts:s=[],timeZone:a=Y,actionBuffers:l=B}={}){const d=new Map;s.forEach(u=>{u!=null&&u._id&&d.set(String(u._id),u)});const r=[];o.forEach(u=>{const v=wt(u.date,a);if(!v)return;const h=It(u.shiftId),E=d.get(h);if(!E)return;const D=Tt(v,E,a);D&&r.push({schedule:u,shift:E,scheduleDate:v,shiftStart:D.start,shiftEnd:D.end})});const c=tt(t,a),m=c?st(c):null,y=c?Z(c,a):null,C=y?new Date(y.getTime()-rt):null,p=C?tt(C,a):null,M=p?st(p):null;if(!r.length)return{context:null,actions:{clockIn:{disabled:!0,reason:"今日未設定班表，無法打卡",window:null,formatted:null},clockOut:{disabled:!0,reason:"今日未設定班表，無法打卡",window:null,formatted:null}},timeZone:a};const S=m==null?void 0:m.getTime(),b=M==null?void 0:M.getTime(),g=t.getTime(),V=r.find(u=>g>=u.shiftStart.getTime()&&g<=u.shiftEnd.getTime()),J=r.find(u=>S!==void 0&&u.scheduleDate.getTime()===S),K=r.find(u=>b!==void 0&&u.scheduleDate.getTime()===b),$=V||J||K||r[0],j={},q=ct(l);return["clockIn","clockOut"].forEach(u=>{const v=_t(u,$.shiftStart,$.shiftEnd,q);if(!v){j[u]={disabled:!0,reason:"班別尚未設定簽到簽退時間",window:null,formatted:null};return}const h=Nt(v,a),E=Dt(t,v),D=g<v.start.getTime(),O=kt[u]||u;let A;E?A=h?`${O}開放時段：${h.start} ~ ${h.end}`:`${O}開放中`:D?A=h?`${O}尚未開放，允許時段為 ${h.start} ~ ${h.end}`:`${O}尚未開放`:A=h?`${O}時段已結束，允許時段為 ${h.start} ~ ${h.end}`:`${O}時段已結束`,j[u]={disabled:!E,reason:A,window:v,formatted:h}}),{context:$,actions:j,timeZone:a}}function Mt(){return Y}const St={class:"attendance-page"},Et={class:"page-header"},Ot={class:"current-time"},Ct={class:"time-display"},At={class:"date-display"},Ut={class:"punch-section"},Yt={class:"punch-grid"},xt={class:"records-section"},$t={class:"table-container"},jt={class:"time-cell"},Pt={class:"remark-text"},Ft={class:"dialog-footer"},zt={__name:"Attendance",setup(t){const o={上班簽到:"clockIn",下班簽退:"clockOut",外出登記:"outing",中午休息:"breakIn"},s=Object.fromEntries(Object.entries(o).map(([n,e])=>[e,n])),a=N([]),l=N(""),d=N("");let r=null;const c=N(!1),m=N(""),y=N(""),C=N([]),p=N([]),M=N(),S=N(it()),b=nt(()=>{var n;return((n=S.value.actions)==null?void 0:n.clockIn)||{disabled:!0,reason:"今日未設定班表，無法打卡"}}),g=nt(()=>{var n;return((n=S.value.actions)==null?void 0:n.clockOut)||{disabled:!0,reason:"今日未設定班表，無法打卡"}});function V(n=new Date){S.value=it({now:n,schedules:p.value,shifts:C.value,timeZone:Mt(),actionBuffers:M.value})}async function J(){const n=await z("/api/attendance");if(n.ok){const e=await n.json();a.value=e.map(f=>{const k=f.timestamp;return{action:s[f.action]||f.action,time:k?L(k).format("YYYY/MM/DD HH:mm:ss"):"",remark:f.remark||"",timestamp:k}})}}async function K(){try{const n=await z("/api/shifts");if(!n.ok)throw new Error("failed");const e=await n.json().catch(()=>[]);C.value=Array.isArray(e)?e:[]}catch(n){console.error(n),C.value=[]}}async function $(){const n=A();if(!n){p.value=[];return}try{const e=L().format("YYYY-MM"),f=new URLSearchParams({month:e,employee:n}),k=await z(`/api/schedules/monthly?${f.toString()}`);if(!k.ok)throw new Error("failed");const I=await k.json().catch(()=>[]);p.value=Array.isArray(I)?I:[]}catch(e){console.error(e),p.value=[]}}async function j(){try{const n=await z("/api/attendance-settings");if(!(n!=null&&n.ok))throw new Error("failed");const e=await n.json().catch(()=>null);M.value=e==null?void 0:e.actionBuffers}catch(n){console.error(n),M.value=void 0}}async function q(){await Promise.all([K(),$(),j()]),V(new Date)}function u(){if(b.value.disabled){G.warning(b.value.reason);return}D("上班簽到")}function v(){if(g.value.disabled){G.warning(g.value.reason);return}D("下班簽退")}function h(){D("外出登記")}function E(){D("中午休息")}function D(n){y.value=n,m.value="",c.value=!0}async function O(){c.value=!1,await lt(y.value,m.value)}function A(){let n=localStorage.getItem("employeeId");if(!n){const e=gt();if(e)try{const f=JSON.parse(atob(e.split(".")[1]));n=f.employeeId||f.id}catch{n=null}}return n}async function lt(n,e=""){const f=A();if(!f){G.warning("請重新登入");return}const k={action:o[n]||n,timestamp:new Date,remark:e,employee:f},I=await z("/api/attendance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(k)});if(I.ok){const x=await I.json(),P=x.timestamp||k.timestamp,R={action:s[x.action]||x.action,time:P?L(P).format("YYYY/MM/DD HH:mm:ss"):"",remark:x.remark||"",timestamp:P};a.value.unshift(R)}}function et(){const n=L();l.value=n.format("HH:mm:ss"),d.value=n.format("YYYY/MM/DD"),V(n.toDate())}function ut(n){return{上班簽到:"success",下班簽退:"warning",外出登記:"info",中午休息:"primary"}[n]||"default"}return ft(()=>{J(),q(),et(),r=setInterval(et,1e3)}),pt(()=>{r&&clearInterval(r)}),(n,e)=>{const f=U("el-tooltip"),k=U("el-tag"),I=U("el-table-column"),x=U("el-table"),P=U("el-input"),R=U("el-button"),dt=U("el-dialog");return yt(),ht("div",St,[i("div",Et,[e[3]||(e[3]=i("div",{class:"header-content"},[i("h1",{class:"page-title"},"出勤打卡"),i("p",{class:"page-description"},"快速進行上下班打卡、外出登記和補卡操作")],-1)),i("div",Ot,[i("div",Ct,F(l.value),1),i("div",At,F(d.value),1)])]),i("div",Ut,[e[8]||(e[8]=i("h2",{class:"section-title"},"快速打卡",-1)),i("div",Yt,[T(f,{disabled:!b.value.reason,content:b.value.reason,placement:"bottom"},{default:_(()=>[i("div",{class:ot(["punch-card",{disabled:b.value.disabled}]),onClick:u},e[4]||(e[4]=[i("div",{class:"punch-icon clock-in"},[i("i",{class:"el-icon-sunrise"})],-1),i("h3",{class:"punch-title"},"上班簽到",-1),i("p",{class:"punch-desc"},"開始新的一天",-1)]),2)]),_:1},8,["disabled","content"]),T(f,{disabled:!g.value.reason,content:g.value.reason,placement:"bottom"},{default:_(()=>[i("div",{class:ot(["punch-card",{disabled:g.value.disabled}]),onClick:v},e[5]||(e[5]=[i("div",{class:"punch-icon clock-out"},[i("i",{class:"el-icon-sunset"})],-1),i("h3",{class:"punch-title"},"下班簽退",-1),i("p",{class:"punch-desc"},"結束工作時間",-1)]),2)]),_:1},8,["disabled","content"]),i("div",{class:"punch-card",onClick:h},e[6]||(e[6]=[i("div",{class:"punch-icon outing"},[i("i",{class:"el-icon-position"})],-1),i("h3",{class:"punch-title"},"外出登記",-1),i("p",{class:"punch-desc"},"臨時外出記錄",-1)])),i("div",{class:"punch-card",onClick:E},e[7]||(e[7]=[i("div",{class:"punch-icon break-time"},[i("i",{class:"el-icon-coffee-cup"})],-1),i("h3",{class:"punch-title"},"休息時間",-1),i("p",{class:"punch-desc"},"中午休息登記",-1)]))])]),i("div",xt,[e[10]||(e[10]=i("h2",{class:"section-title"},"今日打卡記錄",-1)),i("div",$t,[T(x,{data:a.value,class:"records-table","header-cell-style":{background:"#f8fafc",color:"#475569",fontWeight:"600"},"row-style":{height:"56px"}},{default:_(()=>[T(I,{prop:"action",label:"打卡類型",width:"140"},{default:_(({row:w})=>[T(k,{type:ut(w.action),class:"action-tag"},{default:_(()=>[H(F(w.action),1)]),_:2},1032,["type"])]),_:1}),T(I,{prop:"time",label:"打卡時間",width:"200"},{default:_(({row:w})=>[i("div",jt,[e[9]||(e[9]=i("i",{class:"el-icon-time time-icon"},null,-1)),H(" "+F(w.time),1)])]),_:1}),T(I,{prop:"remark",label:"備註說明"},{default:_(({row:w})=>[i("span",Pt,F(w.remark||"無備註"),1)]),_:1})]),_:1},8,["data"])])]),T(dt,{modelValue:c.value,"onUpdate:modelValue":e[2]||(e[2]=w=>c.value=w),title:"新增備註",width:"400px"},{footer:_(()=>[i("span",Ft,[T(R,{onClick:e[1]||(e[1]=w=>c.value=!1)},{default:_(()=>e[11]||(e[11]=[H("取消")])),_:1}),T(R,{type:"primary",onClick:O},{default:_(()=>e[12]||(e[12]=[H("確認")])),_:1})])]),default:_(()=>[T(P,{modelValue:m.value,"onUpdate:modelValue":e[0]||(e[0]=w=>m.value=w),placeholder:"請輸入備註（可留空）"},null,8,["modelValue"])]),_:1},8,["modelValue"])])}}},Rt=mt(zt,[["__scopeId","data-v-48332ece"]]);export{Rt as default};
