import{_ as me,r as i,D as X,j as N,k as pe,c,b as n,d as _,n as h,q as ve,w as d,e as m,F as w,t as k,E as j,o,g as T,v as y,p as fe}from"./index-DIggq0wA.js";import{a as R}from"./api-D1pbDsfn.js";const _e={class:"schedule-overview-page"},be={class:"filters-header"},ge={class:"export-actions"},he={class:"filters-grid"},ye={class:"filter-item"},we={class:"filter-item"},ke={class:"filter-item"},De={class:"filter-item"},xe={key:3,class:"overview-results"},ze={class:"organization-header"},Ve={class:"organization-title"},Re={class:"organization-meta"},Ce={class:"department-header"},Se={class:"department-title"},Ee={class:"department-meta"},$e={class:"unit-header"},Oe={class:"unit-title"},Ae={class:"unit-meta"},Le={class:"unit-table-wrapper"},Me={__name:"ScheduleOverview",setup(Ue){const g=i(X().format("YYYY-MM")),b=i(""),p=i(""),v=i(""),Y=i([]),x=i([]),B=i([]),C=i(!1),z=i(""),S=i([]),E=i([]),F=i(!1),V=i(!1),$=i("");let O=0;const f=t=>{if(!t&&t!==0)return"";if(typeof t=="string")return t;if(typeof t=="object"){if(t!=null&&t._id)return String(t._id);if(t!=null&&t.id)return String(t.id)}return String(t)},H=N(()=>{const t=b.value;return t?x.value.filter(e=>f(e.organization)===t):x.value}),G=N(()=>{const t=p.value,e=b.value;return B.value.filter(l=>{const a=f(l.department);if(t)return a===t;if(!e)return!0;const r=x.value.find(u=>f(u._id)===a);return r?f(r.organization)===e:!1})}),Z=N(()=>E.value.some(t=>t.departments.some(e=>e.subDepartments.some(l=>l.employees.length)))),J=N(()=>!g.value||C.value||V.value||!F.value),ee=t=>{const e=X(t);return e.isValid()?e.format("MM/DD"):t},te=t=>t.employees.map(e=>{const l={};return S.value.forEach(a=>{l[a]=""}),e.schedules.forEach(a=>{const r=a.date;l[r]||(l[r]=a.shiftName||"")}),{id:e.id,name:e.name,title:e.title||"",entries:l}}).sort((e,l)=>e.name.localeCompare(l.name,"zh-Hant",{sensitivity:"base"}));async function A(t,e){if(!t.ok){let l=e;try{const a=await t.json();l=(a==null?void 0:a.error)||(a==null?void 0:a.message)||l}catch{}throw new Error(l)}return t.json()}async function ae(t,e){if(!t.ok){let l=e;try{const a=await t.json();l=(a==null?void 0:a.error)||(a==null?void 0:a.message)||l}catch{}throw new Error(l)}return t.blob()}async function le(){try{const[t,e,l]=await Promise.all([R("/api/organizations"),R("/api/departments"),R("/api/sub-departments")]),[a,r,u]=await Promise.all([A(t,"無法載入機構資料"),A(e,"無法載入部門資料"),A(l,"無法載入小單位資料")]);Y.value=Array.isArray(a)?a:[],x.value=Array.isArray(r)?r:[],B.value=Array.isArray(u)?u:[],F.value=!0}catch(t){const e=(t==null?void 0:t.message)||"無法載入必要資料";z.value=e,j.error(e)}}async function L(){if(!F.value||!g.value)return;const t=++O;C.value=!0,z.value="";try{const e=new URLSearchParams({month:g.value});b.value&&e.set("organization",b.value),p.value&&e.set("department",p.value),v.value&&e.set("subDepartment",v.value);const l=await R(`/api/schedules/overview?${e.toString()}`),a=await A(l,"無法載入班表總覽資料");if(t!==O)return;S.value=Array.isArray(a==null?void 0:a.days)?a.days:[],E.value=Array.isArray(a==null?void 0:a.organizations)?a.organizations:[]}catch(e){if(t!==O)return;const l=(e==null?void 0:e.message)||"載入班表總覽失敗";z.value=l,E.value=[],S.value=[],j.error(l)}finally{t===O&&(C.value=!1)}}function K(){L()}function se(){H.value.some(t=>f(t._id)===p.value)||(p.value=""),v.value="",L()}function ne(){G.value.some(t=>f(t._id)===v.value)||(v.value=""),L()}function P(t,e){if(!e)return"";const l=t.value.find(a=>f(a._id||a.id)===e);return(l==null?void 0:l.name)||""}function oe(t){const e=t==="pdf"?"pdf":"xlsx",l=P(Y,b.value)||"全部機構",a=P(x,p.value)||"全部部門",r=P(B,v.value)||"全部小單位";return`班表總覽_${g.value}_${l}_${a}_${r}.${e}`}async function Q(t){if(!g.value){j.error("請先選擇月份");return}V.value=!0,$.value=t;try{const e=new URLSearchParams({month:g.value});b.value&&e.set("organization",b.value),p.value&&e.set("department",p.value),v.value&&e.set("subDepartment",v.value),e.set("format",t);const l=await R(`/api/schedules/overview/export?${e.toString()}`),a=await ae(l,"匯出失敗"),r=URL.createObjectURL(a),u=document.createElement("a");u.href=r,u.download=oe(t),u.click(),URL.revokeObjectURL(r)}catch(e){const l=(e==null?void 0:e.message)||"匯出失敗";j.error(l)}finally{V.value=!1,$.value=""}}return pe(async()=>{await le(),await L()}),(t,e)=>{const l=m("el-button"),a=m("el-button-group"),r=m("el-date-picker"),u=m("el-option"),I=m("el-select"),re=m("el-card"),ie=m("el-alert"),ue=m("el-skeleton"),ce=m("el-empty"),q=m("el-table-column"),de=m("el-table");return o(),c("div",_e,[e[13]||(e[13]=n("div",{class:"page-header"},[n("h1",{class:"page-title"},"班表總覽"),n("p",{class:"page-subtitle"},"依照機構、部門與小單位快速檢視每月排班狀態")],-1)),_(re,{class:"filters-card",shadow:"never"},{header:d(()=>[n("div",be,[e[8]||(e[8]=n("div",{class:"filters-title"},"篩選條件",-1)),n("div",ge,[_(a,null,{default:d(()=>[_(l,{type:"primary",plain:"","data-test":"export-excel",loading:V.value&&$.value==="excel",disabled:J.value,onClick:e[0]||(e[0]=s=>Q("excel"))},{default:d(()=>e[6]||(e[6]=[T(" 匯出 Excel ")])),_:1},8,["loading","disabled"]),_(l,{type:"primary",plain:"","data-test":"export-pdf",loading:V.value&&$.value==="pdf",disabled:J.value,onClick:e[1]||(e[1]=s=>Q("pdf"))},{default:d(()=>e[7]||(e[7]=[T(" 匯出 PDF ")])),_:1},8,["loading","disabled"])]),_:1})])])]),default:d(()=>[n("div",he,[n("div",ye,[e[9]||(e[9]=n("label",{class:"filter-label"},"月份",-1)),_(r,{modelValue:g.value,"onUpdate:modelValue":e[2]||(e[2]=s=>g.value=s),type:"month","value-format":"YYYY-MM",placeholder:"選擇月份",class:"filter-control",onChange:K},null,8,["modelValue"])]),n("div",we,[e[10]||(e[10]=n("label",{class:"filter-label"},"機構",-1)),_(I,{modelValue:b.value,"onUpdate:modelValue":e[3]||(e[3]=s=>b.value=s),placeholder:"全部機構",clearable:"",class:"filter-control",onChange:se},{default:d(()=>[(o(!0),c(w,null,k(Y.value,s=>(o(),h(u,{key:s._id||s.id,label:s.name,value:f(s._id||s.id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),n("div",ke,[e[11]||(e[11]=n("label",{class:"filter-label"},"部門",-1)),_(I,{modelValue:p.value,"onUpdate:modelValue":e[4]||(e[4]=s=>p.value=s),placeholder:"全部部門",clearable:"",class:"filter-control",onChange:ne},{default:d(()=>[(o(!0),c(w,null,k(H.value,s=>(o(),h(u,{key:s._id,label:s.name,value:f(s._id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),n("div",De,[e[12]||(e[12]=n("label",{class:"filter-label"},"小單位",-1)),_(I,{modelValue:v.value,"onUpdate:modelValue":e[5]||(e[5]=s=>v.value=s),placeholder:"全部小單位",clearable:"",class:"filter-control",onChange:K},{default:d(()=>[(o(!0),c(w,null,k(G.value,s=>(o(),h(u,{key:s._id,label:s.name,value:f(s._id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])]),_:1}),z.value?(o(),h(ie,{key:0,type:"error",closable:!1,"show-icon":"",class:"message-block"},{default:d(()=>[T(y(z.value),1)]),_:1})):ve("",!0),C.value?(o(),h(ue,{key:1,animated:"",rows:4,class:"overview-skeleton"})):Z.value?(o(),c("div",xe,[(o(!0),c(w,null,k(E.value,s=>(o(),c("section",{key:s.id,class:"organization-block","data-test":"organization-block"},[n("header",ze,[n("h2",Ve,y(s.name),1),n("span",Re,y(s.departments.length)+" 個部門",1)]),(o(!0),c(w,null,k(s.departments,M=>(o(),c("article",{key:M.id,class:"department-block","data-test":"department-block"},[n("header",Ce,[n("h3",Se,y(M.name),1),n("span",Ee,y(M.subDepartments.length)+" 個小單位",1)]),(o(!0),c(w,null,k(M.subDepartments,D=>(o(),c("div",{key:D.id,class:"unit-card","data-test":"subdepartment-block"},[n("div",$e,[n("h4",Oe,y(D.name),1),n("span",Ae,y(D.employees.length)+" 位人員",1)]),n("div",Le,[(o(),h(de,{data:te(D),border:"",stripe:"",class:"overview-table",key:`${D.id}-table`},{default:d(()=>[_(q,{prop:"name",label:"姓名",fixed:"left","min-width":"140"}),_(q,{prop:"title",label:"職稱","min-width":"140"}),(o(!0),c(w,null,k(S.value,U=>(o(),h(q,{key:`${D.id}-${U}`,label:ee(U),"min-width":110},{default:d(({row:W})=>[n("span",{class:fe(["shift-label",{empty:!W.entries[U]}])},y(W.entries[U]||"—"),3)]),_:2},1032,["label"]))),128))]),_:2},1032,["data"]))])]))),128))]))),128))]))),128))])):(o(),h(ce,{key:2,description:"目前沒有符合條件的班表資料",class:"empty-state"}))])}}},Ye=me(Me,[["__scopeId","data-v-944f9162"]]);export{Ye as default};
