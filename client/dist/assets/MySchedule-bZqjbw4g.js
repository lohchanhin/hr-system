import{_ as se,r as f,D as M,y as ae,j as A,k as le,m as oe,c as k,b as _,q as j,n as ie,d as c,e as m,p as ce,v as h,w as r,z as ue,o as b,g as y,B as U,E as S}from"./index-e4ZYiO4C.js";import{a as B}from"./api-Cg1hb4Al.js";const re={class:"my-schedule"},de={class:"toolbar"},pe={key:1,class:"batch-toolbar"},fe={class:"batch-info"},me={class:"batch-actions"},he={class:"note-text"},ye={key:0,class:"note-time"},ve={class:"actions-cell"},ge={key:3,class:"empty-text"},_e={__name:"MySchedule",setup(be){const v=f([]),E=f({}),C=f(M().format("YYYY-MM")),p=f(""),N=f(!1),i=ae({visible:!1,schedule:null,note:""}),d=f([]),D=f(null);function I(e){if(!e)return"";const t=(e.name||"").trim(),l=(e.code||"").trim();return t&&l?`${t} (${l})`:t||l}function O(e){return e?e.state==="finalized"?{text:"已完成",type:"success"}:e.state==="changes_requested"||e.employeeResponse==="disputed"?{text:"已提出異議",type:"danger"}:e.state==="pending_confirmation"?e.employeeResponse==="confirmed"?{text:"已確認",type:"success"}:{text:"待確認",type:"warning"}:{text:"草稿",type:"info"}:{text:"未發布",type:"info"}}const T=A(()=>{if(!v.value.length)return null;const e=v.value;return e.every(o=>o.state==="finalized")?{type:"success",message:"本月班表已完成發布，感謝您的回覆。"}:e.some(o=>o.state==="changes_requested"||o.employeeResponse==="disputed")?{type:"danger",message:"您已提交異議，主管調整後將再通知您。"}:e.some(o=>o.state==="pending_confirmation"&&o.employeeResponse==="pending")?{type:"warning",message:"尚有班表待確認，如有疑問請提出異議。"}:e.some(o=>o.state==="pending_confirmation"&&o.employeeResponse==="confirmed")?{type:"info",message:"已完成確認，等待主管完成發布。"}:null}),x=e=>(e==null?void 0:e.state)==="pending_confirmation"&&(e==null?void 0:e.employeeResponse)!=="confirmed"&&(e==null?void 0:e.state)!=="changes_requested"&&(e==null?void 0:e.state)!=="finalized"&&p.value!==(e==null?void 0:e._id),J=e=>(e==null?void 0:e.state)==="pending_confirmation"&&(e==null?void 0:e.employeeResponse)!=="disputed"&&(e==null?void 0:e.state)!=="finalized"&&p.value!==(e==null?void 0:e._id),g=A(()=>v.value.filter(e=>x(e))),q=A(()=>new Set(g.value.map(t=>t._id)).size?g.value.every(t=>d.value.some(l=>(l==null?void 0:l._id)===t._id)):!1),L=A(()=>d.value.length>0&&d.value.every(e=>x(e))),F=e=>x(e);function G(e){d.value=Array.isArray(e)?e:[]}function P(){var t;d.value=[];const e=D.value;(t=e==null?void 0:e.clearSelection)==null||t.call(e)}function K(){var l;const e=D.value;if(!e)return;const t=g.value;if(t.length){if(q.value){t.forEach(n=>{var s;return(s=e.toggleRowSelection)==null?void 0:s.call(e,n,!1)}),d.value=[];return}(l=e.clearSelection)==null||l.call(e),t.forEach(n=>{var s;return(s=e.toggleRowSelection)==null?void 0:s.call(e,n,!0)})}}async function Q(e,t,l=""){if(!(!Array.isArray(e)||!e.length)){N.value=!0;try{const n=await B("/api/schedules/respond/bulk",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({scheduleIds:e,response:t,note:l})}),s=await n.json().catch(()=>null);if(!n.ok){const u=(s==null?void 0:s.error)||"批次操作失敗";throw new Error(u)}const o=typeof(s==null?void 0:s.count)=="number"?s.count:e.length;S.success(`已批次確認 ${o} 筆班表`),P(),await Y()}catch(n){throw S.error((n==null?void 0:n.message)||"批次操作失敗"),n}finally{N.value=!1}}}async function W(){if(!d.value.length)return;try{await U.confirm(`確認批次確認 ${d.value.length} 筆班表嗎？`,"批次確認",{type:"success",confirmButtonText:"確認",cancelButtonText:"取消"})}catch{return}const e=d.value.map(t=>t==null?void 0:t._id).filter(Boolean);if(e.length)try{await Q(e,"confirm")}catch{}}async function X(){try{const e=await B("/api/shifts"),t=await e.json().catch(()=>null);if(!e.ok)return;const l=Array.isArray(t)?t:[];E.value=Object.fromEntries(l.map(n=>[n._id,{name:n.name||"",code:n.code||""}]))}catch(e){console.error(e)}}async function H(e,t,l=""){if(e){p.value=e;try{const n=await B(`/api/schedules/${e}/respond`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({response:t,note:l})}),s=await n.json().catch(()=>null);if(!n.ok){const o=(s==null?void 0:s.error)||"回覆失敗";throw new Error(o)}S.success(t==="confirm"?"已確認班表":"異議已送出"),await Y()}catch(n){throw S.error((n==null?void 0:n.message)||"回覆失敗"),n}finally{p.value=""}}}async function Z(e){if(e!=null&&e._id){try{await U.confirm(`確認 ${e.date} 的班表安排嗎？`,"確認排班",{type:"success",confirmButtonText:"確認",cancelButtonText:"取消"})}catch{return}try{await H(e._id,"confirm")}catch{}}}function w(e){e!=null&&e._id&&(i.schedule=e,i.note=e.responseNote||"",i.visible=!0)}async function ee(){var l;const e=(l=i.schedule)==null?void 0:l._id;if(!e){i.visible=!1,i.note="";return}const t=(i.note||"").trim();if(!t){S.warning("請輸入異議原因");return}try{await H(e,"dispute",t),i.visible=!1,i.note="",i.schedule=null}catch{}}async function Y(){const e=ue();if(e)try{await X();const t=JSON.parse(atob(e.split(".")[1])),l=t.employeeId||t.id||t._id||t.sub;if(!l)return;const n=new URLSearchParams({month:C.value});n.set("employee",l);const s=await B(`/api/schedules/monthly?${n.toString()}`);if(s.ok){const o=await s.json();v.value=o.map(u=>{const z=E.value[u.shiftId],V=u.state||"draft",a=u.employeeResponse||"pending",R=u.responseNote||"",$=u.responseAt||"",te=$?M($).format("YYYY/MM/DD HH:mm"):"",ne=u.publishedAt?M(u.publishedAt).format("YYYY/MM/DD HH:mm"):"";return{...u,date:M(u.date).format("YYYY/MM/DD"),shiftName:I(z)||u.shiftName||"",state:V,employeeResponse:a,responseNote:R,responseAt:te,responseAtRaw:$,publishedAt:ne}}),P()}}catch(t){console.error(t)}}return le(Y),oe(C,Y),(e,t)=>{const l=m("el-date-picker"),n=m("el-button"),s=m("el-table-column"),o=m("el-tag"),u=m("el-table"),z=m("el-input"),V=m("el-dialog");return b(),k("div",re,[_("div",de,[c(l,{modelValue:C.value,"onUpdate:modelValue":t[0]||(t[0]=a=>C.value=a),type:"month","value-format":"YYYY-MM"},null,8,["modelValue"])]),T.value?(b(),k("div",{key:0,class:ce(["status-banner",T.value.type])},h(T.value.message),3)):j("",!0),g.value.length?(b(),k("div",pe,[_("div",fe," 可確認班表："+h(d.value.length)+" / "+h(g.value.length),1),_("div",me,[c(n,{size:"small",type:"primary",plain:"",disabled:!g.value.length,onClick:K},{default:r(()=>[y(h(q.value?"取消全選":"全選可確認"),1)]),_:1},8,["disabled"]),c(n,{size:"small",type:"success",disabled:!L.value,loading:N.value,onClick:W},{default:r(()=>t[5]||(t[5]=[y(" 批次確認 ")])),_:1},8,["disabled","loading"])])])):j("",!0),v.value.length?(b(),ie(u,{key:2,ref_key:"scheduleTableRef",ref:D,data:v.value,class:"schedule-table",border:"",stripe:"",onSelectionChange:G},{default:r(()=>[c(s,{type:"selection",width:"48",selectable:F}),c(s,{prop:"date",label:"日期",width:"140"}),c(s,{prop:"shiftName",label:"班別","min-width":"160"}),c(s,{label:"狀態",width:"140"},{default:r(({row:a})=>[c(o,{type:O(a).type,effect:"light"},{default:r(()=>[y(h(O(a).text),1)]),_:2},1032,["type"])]),_:1}),c(s,{label:"異議備註","min-width":"220"},{default:r(({row:a})=>[_("div",he,h(a.responseNote?a.responseNote:"—"),1),a.responseAt?(b(),k("div",ye,"更新於 "+h(a.responseAt),1)):j("",!0)]),_:1}),c(s,{label:"操作",width:"220"},{default:r(({row:a})=>[_("div",ve,[c(n,{size:"small",type:"success",loading:p.value===a._id,disabled:!x(a),onClick:R=>Z(a)},{default:r(()=>t[6]||(t[6]=[y(" 確認 ")])),_:2},1032,["loading","disabled","onClick"]),c(n,{size:"small",type:"danger",plain:"",loading:p.value===a._id,disabled:!J(a),onClick:R=>w(a)},{default:r(()=>t[7]||(t[7]=[y(" 提出異議 ")])),_:2},1032,["loading","disabled","onClick"])])]),_:1})]),_:1},8,["data"])):(b(),k("p",ge,"目前無排班資料")),c(V,{modelValue:i.visible,"onUpdate:modelValue":t[3]||(t[3]=a=>i.visible=a),title:"提出異議",width:"480px",onClosed:t[4]||(t[4]=a=>i.schedule=null)},{footer:r(()=>{var a;return[c(n,{onClick:t[2]||(t[2]=R=>i.visible=!1)},{default:r(()=>t[8]||(t[8]=[y("取消")])),_:1}),c(n,{type:"danger",loading:p.value===(((a=i.schedule)==null?void 0:a._id)||""),onClick:ee},{default:r(()=>t[9]||(t[9]=[y(" 送出異議 ")])),_:1},8,["loading"])]}),default:r(()=>[t[10]||(t[10]=_("p",{class:"dialog-tip"},"請填寫異議原因，送出後主管會收到通知並重新調整班表。",-1)),c(z,{modelValue:i.note,"onUpdate:modelValue":t[1]||(t[1]=a=>i.note=a),type:"textarea",rows:4,maxlength:"500","show-word-limit":"",placeholder:"請輸入異議原因"},null,8,["modelValue"])]),_:1},8,["modelValue"])])}}},Ce=se(_e,[["__scopeId","data-v-848d0149"]]);export{Ce as default};
