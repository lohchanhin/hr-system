import{i as te,a as J}from"./api-Coim478o.js";import{_ as oe,r as w,q as le,v as P,k as ae,l as A,o as d,w as o,b as g,c as C,x as F,d as e,g as m,e as r,t as V,m as Y,F as K,E as U,j as ve}from"./index-B1-Hvwow.js";const ce={class:"import-section"},ge={class:"upload-tip"},_e={class:"mapping-grid"},ye={class:"mapping-label"},be={class:"dialog-actions"},Ve={class:"preview-section"},Ce={class:"summary-text"},ke={key:2},Ee={key:4},Ie={key:0},Ue={key:1},we={key:2},xe={key:0,class:"mapping-section"},Ae={class:"dialog-actions"},De={__name:"AttendanceImportDialog",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","import-complete"],setup(W,{expose:R,emit:n}){const M=W,H=n,T=w(M.modelValue),k=w(null),p=w(null),l=w(!1),f=w(!1),b=w([]),u=le({}),v=le({timezone:"Asia/Kuala_Lumpur",mappings:{userId:"USERID",timestamp:"CHECKTIME",type:"CHECKTYPE",remark:"REMARK"}}),L=["Asia/Kuala_Lumpur","Asia/Taipei","Asia/Shanghai","Asia/Tokyo","UTC","America/Los_Angeles","Europe/London"],B={userId:"USERID 欄位",timestamp:"CHECKTIME 欄位",type:"CHECKTYPE 欄位",remark:"備註欄位 (選填)"},O=P(()=>b.value.map(a=>({value:a._id,label:`${a.name||a.email||a.employeeId||a._id}（${a.employeeId||a.email||a._id}）`}))),j=P(()=>{var a;return((a=p.value)==null?void 0:a.preview)??[]}),E=P(()=>{var a;return((a=p.value)==null?void 0:a.missingUsers)??[]}),h=P(()=>p.value?E.value.length===0?!0:E.value.every(a=>{const t=u[a.identifier];return t?t.ignore?!0:!!t.employeeId:!1}):!1);ae(()=>M.modelValue,a=>{T.value=a,a&&i()}),ae(T,a=>{H("update:modelValue",a),a||$()});function $(){k.value=null,p.value=null,l.value=!1,f.value=!1,Object.keys(u).forEach(a=>delete u[a]),v.mappings.userId="USERID",v.mappings.timestamp="CHECKTIME",v.mappings.type="CHECKTYPE",v.mappings.remark="REMARK",v.timezone="Asia/Kuala_Lumpur"}async function i(){try{const a=await J("/api/employees");if(a.ok)b.value=await a.json();else throw new Error("無法取得員工清單")}catch(a){console.warn("載入員工清單失敗",a),U.warning("載入員工清單失敗，稍後可再試")}}function z(){T.value=!1}function ne(a){a!=null&&a.raw&&(k.value=a.raw)}function se(a,t){if(!a)return"";try{const c=new Date(a);return new Intl.DateTimeFormat(void 0,{timeZone:t||"UTC",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(c)}catch{return String(a)}}function D(a){return u[a]||(u[a]={employeeId:"",ignore:!1}),u[a]}function ie(a){const t=D(a);t.ignore&&(t.employeeId="")}function X({dryRun:a}){if(!k.value)return null;const t=new FormData;if(t.append("file",k.value),t.append("mappings",JSON.stringify(v.mappings)),t.append("options",JSON.stringify({timezone:v.timezone,dryRun:a})),!a&&E.value.length){const c={},y=[];E.value.forEach(N=>{const x=u[N.identifier];x&&(x.ignore?y.push(N.identifier):x.employeeId&&(c[N.identifier]={_id:x.employeeId}))}),Object.keys(c).length&&t.append("userMappings",JSON.stringify(c)),y.length&&t.append("ignoreUsers",JSON.stringify(y))}return t}async function q(){if(!k.value){U.warning("請先選擇要匯入的檔案");return}l.value=!0;try{const a=X({dryRun:!0}),t=await te(a),c=await(async()=>{try{return await t.json()}catch{return{}}})();if(!t.ok){U.error(c.message||"預覽失敗");return}p.value=c,Object.keys(u).forEach(y=>delete u[y]),(c.missingUsers||[]).forEach(y=>{u[y.identifier]=D(y.identifier)}),(c.missingUsers||[]).length===0?U.success("預覽完成，可直接匯入"):U.warning("部分資料需要對應員工後才能匯入")}catch(a){console.error(a),U.error("預覽失敗，請稍後再試")}finally{l.value=!1}}async function Z(){if(!h.value)return;const a=X({dryRun:!1});if(a){f.value=!0;try{const t=await te(a),c=await(async()=>{try{return await t.json()}catch{return{}}})();if(!t.ok){U.error(c.message||"匯入失敗，請稍後再試");return}p.value=c,U.success(c.message||"考勤資料匯入完成"),H("import-complete",c),z()}catch(t){console.error(t),U.error("匯入失敗，請稍後再試")}finally{f.value=!1}}}return R({selectedFile:k,submitPreview:q,submitImport:Z,missingResolutions:u}),(a,t)=>{const c=r("el-alert"),y=r("el-button"),N=r("el-upload"),x=r("el-form-item"),G=r("el-option"),Q=r("el-select"),ue=r("el-input"),re=r("el-form"),de=r("el-divider"),I=r("el-table-column"),S=r("el-tag"),ee=r("el-table"),me=r("el-checkbox"),pe=r("el-dialog");return d(),A(pe,{"model-value":T.value,title:"考勤資料匯入",width:"720px",onClose:z},{default:o(()=>[g("div",ce,[e(c,{type:"info","show-icon":"",class:"import-hint"},{title:o(()=>t[1]||(t[1]=[m("上傳考勤檔案後可先預覽資料，確認欄位與員工對應再正式匯入。")])),default:o(()=>[t[2]||(t[2]=m(" 系統預設欄位為 USERID、CHECKTIME、CHECKTYPE，若來源檔案不同可於下方調整欄位名稱。 "))]),_:1}),e(re,{"label-width":"140px",class:"import-form"},{default:o(()=>[e(x,{label:"檔案上傳"},{default:o(()=>[e(N,{action:"","auto-upload":!1,"show-file-list":!1,accept:".xlsx,.csv",onChange:ne},{tip:o(()=>[g("div",ge,V(k.value?`已選擇：${k.value.name}`:"支援 Excel 或 CSV 檔案，欄位需包含 USERID、CHECKTIME、CHECKTYPE。"),1)]),default:o(()=>[e(y,{type:"primary"},{default:o(()=>t[3]||(t[3]=[m("選擇檔案")])),_:1})]),_:1})]),_:1}),e(x,{label:"時區"},{default:o(()=>[e(Q,{modelValue:v.timezone,"onUpdate:modelValue":t[0]||(t[0]=s=>v.timezone=s),placeholder:"選擇時區",filterable:""},{default:o(()=>[(d(),C(K,null,Y(L,s=>e(G,{key:s,label:s,value:s},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),e(x,{label:"欄位對應"},{default:o(()=>[g("div",_e,[(d(!0),C(K,null,Y(v.mappings,(s,_)=>(d(),C("div",{class:"mapping-item",key:_},[g("label",ye,V(B[_]),1),e(ue,{modelValue:v.mappings[_],"onUpdate:modelValue":fe=>v.mappings[_]=fe,placeholder:"輸入對應欄位名稱"},null,8,["modelValue","onUpdate:modelValue"])]))),128))]),t[4]||(t[4]=g("div",{class:"mapping-suggest"}," 常見別名示例：USERID/EmpID、CHECKTIME/DateTime、CHECKTYPE/InOut/Direction、REMARK/Memo ",-1))]),_:1})]),_:1}),g("div",be,[e(y,{onClick:z},{default:o(()=>t[5]||(t[5]=[m("取消")])),_:1}),e(y,{type:"primary",loading:l.value,onClick:q},{default:o(()=>t[6]||(t[6]=[m("預覽資料")])),_:1},8,["loading"])])]),p.value?(d(),C(K,{key:0},[e(de),g("section",Ve,[t[13]||(t[13]=g("h3",null,"匯入預覽",-1)),g("p",Ce," 共 "+V(p.value.summary.totalRows)+" 筆， 已匹配 "+V(p.value.summary.readyCount)+" 筆， 待處理 "+V(p.value.summary.missingCount)+" 筆， 忽略 "+V(p.value.summary.ignoredCount)+" 筆， 發生錯誤 "+V(p.value.summary.errorCount)+" 筆。 ",1),e(ee,{data:j.value,height:"240",border:""},{default:o(()=>[e(I,{prop:"rowNumber",label:"列",width:"60"}),e(I,{prop:"userId",label:"USERID",width:"140"}),e(I,{label:"時間",width:"220"},{default:o(({row:s})=>[g("span",null,V(se(s.timestamp,v.timezone)),1)]),_:1}),e(I,{prop:"action",label:"動作",width:"120"},{default:o(({row:s})=>[s.action==="in"?(d(),A(S,{key:0},{default:o(()=>t[7]||(t[7]=[m("I / 上班")])),_:1})):s.action==="out"?(d(),A(S,{key:1,type:"warning"},{default:o(()=>t[8]||(t[8]=[m("O / 下班")])),_:1})):(d(),C("span",ke,V(s.action),1))]),_:1}),e(I,{prop:"status",label:"狀態",width:"110"},{default:o(({row:s})=>[s.status==="ready"?(d(),A(S,{key:0,type:"success"},{default:o(()=>t[9]||(t[9]=[m("已就緒")])),_:1})):s.status==="missing"?(d(),A(S,{key:1,type:"info"},{default:o(()=>t[10]||(t[10]=[m("未匹配")])),_:1})):s.status==="ignored"?(d(),A(S,{key:2},{default:o(()=>t[11]||(t[11]=[m("忽略")])),_:1})):s.status==="error"?(d(),A(S,{key:3,type:"danger"},{default:o(()=>t[12]||(t[12]=[m("錯誤")])),_:1})):(d(),C("span",Ee,V(s.status),1))]),_:1}),e(I,{label:"訊息"},{default:o(({row:s})=>{var _;return[Array.isArray(s.errors)&&s.errors.length?(d(),C("span",Ie,V(s.errors.join("、")),1)):s.status==="missing"?(d(),C("span",Ue,"尚未對應員工")):s.status==="ready"?(d(),C("span",we,V(((_=s.employee)==null?void 0:_.name)||""),1)):F("",!0)]}),_:1})]),_:1},8,["data"])]),E.value.length?(d(),C("section",xe,[t[15]||(t[15]=g("h3",null,"員工對應",-1)),t[16]||(t[16]=g("p",{class:"section-hint"},"為下列識別值選擇對應的員工或設定忽略後即可重新送出匯入。",-1)),e(ee,{data:E.value,height:"240",border:""},{default:o(()=>[e(I,{prop:"identifier",label:"USERID",width:"180"}),e(I,{prop:"count",label:"筆數",width:"80"}),e(I,{label:"對應員工"},{default:o(({row:s})=>[e(Q,{modelValue:D(s.identifier).employeeId,"onUpdate:modelValue":_=>D(s.identifier).employeeId=_,placeholder:"選擇員工",disabled:D(s.identifier).ignore,filterable:"",style:{width:"100%"}},{default:o(()=>[(d(!0),C(K,null,Y(O.value,_=>(d(),A(G,{key:_.value,label:_.label,value:_.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"])]),_:1}),e(I,{label:"忽略",width:"120"},{default:o(({row:s})=>[e(me,{modelValue:D(s.identifier).ignore,"onUpdate:modelValue":_=>D(s.identifier).ignore=_,onChange:_=>ie(s.identifier)},{default:o(()=>t[14]||(t[14]=[m(" 忽略此次匯入 ")])),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:1})]),_:1},8,["data"])])):F("",!0),g("div",Ae,[e(y,{onClick:z},{default:o(()=>t[17]||(t[17]=[m("取消")])),_:1}),e(y,{type:"primary",disabled:!h.value,loading:f.value,onClick:Z},{default:o(()=>t[18]||(t[18]=[m(" 開始匯入 ")])),_:1},8,["disabled","loading"])])],64)):F("",!0)]),_:1},8,["model-value"])}}},Me=oe(De,[["__scopeId","data-v-d43047d3"]]),Te={class:"attendance-mgmt-setting"},Se={__name:"AttendanceManagementSetting",setup(W){const R=w(!1),n=w({enableImport:!1,importFormat:"",importMapping:"",allowMakeUpClock:!0,makeUpDays:3,makeUpNeedApprove:!0,supervisorCrossDept:!1,hrAllDept:!0,employeeHistoryMonths:6,nonExtWorkAlert:!1,overtimeNoClockNotify:!0,notifyTargets:["員工","主管"]}),M=w("");async function H(){const p=await J("/api/attendance-settings");if(!p.ok)return;const l=await p.json(),f=Array.isArray(l)?l[0]:l;if(f){const b=f.management||f;Object.assign(n.value,b),M.value=f._id||""}}async function T(){const p={management:{...n.value}},l=await J("/api/attendance-settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});if(l.ok){const f=await l.json();f.management&&Object.assign(n.value,f.management),M.value=f._id||M.value,alert("已儲存「考勤管理設定」")}}function k(){alert("考勤資料匯入完成")}return ve(H),(p,l)=>{const f=r("el-divider"),b=r("el-switch"),u=r("el-form-item"),v=r("el-option"),L=r("el-select"),B=r("el-input"),O=r("el-button"),j=r("el-input-number"),E=r("el-checkbox"),h=r("el-checkbox-group"),$=r("el-form");return d(),C(K,null,[g("div",Te,[l[22]||(l[22]=g("h2",null,"考勤管理設定",-1)),e($,{model:n.value,"label-width":"180px",class:"setting-form"},{default:o(()=>[e(f,{"content-position":"left"},{default:o(()=>l[14]||(l[14]=[m("資料匯入設定")])),_:1}),e(u,{label:"是否啟用外部刷卡匯入"},{default:o(()=>[e(b,{modelValue:n.value.enableImport,"onUpdate:modelValue":l[0]||(l[0]=i=>n.value.enableImport=i),"active-text":"啟用","inactive-text":"停用"},null,8,["modelValue"])]),_:1}),e(u,{label:"匯入檔案格式"},{default:o(()=>[e(L,{modelValue:n.value.importFormat,"onUpdate:modelValue":l[1]||(l[1]=i=>n.value.importFormat=i),placeholder:"選擇匯入檔格式",disabled:!n.value.enableImport},{default:o(()=>[e(v,{label:"CSV",value:"csv"}),e(v,{label:"Excel (XLSX)",value:"xlsx"}),e(v,{label:"TXT (定長欄位)",value:"txt"})]),_:1},8,["modelValue","disabled"])]),_:1}),e(u,{label:"匯入欄位對應 (範例)"},{default:o(()=>[e(B,{modelValue:n.value.importMapping,"onUpdate:modelValue":l[2]||(l[2]=i=>n.value.importMapping=i),placeholder:"如：員工編號→Column A, 日期→Column B, 上班時間→Column C...",disabled:!n.value.enableImport},null,8,["modelValue","disabled"])]),_:1}),e(u,{label:"考勤資料匯入"},{default:o(()=>[e(O,{type:"primary",disabled:!n.value.enableImport,"data-test":"attendance-import-button",onClick:l[3]||(l[3]=i=>R.value=!0)},{default:o(()=>l[15]||(l[15]=[m(" 開啟匯入流程 ")])),_:1},8,["disabled"])]),_:1}),e(f,{"content-position":"left"},{default:o(()=>l[16]||(l[16]=[m("補打卡審核設定")])),_:1}),e(u,{label:"是否允許員工提出補打卡"},{default:o(()=>[e(b,{modelValue:n.value.allowMakeUpClock,"onUpdate:modelValue":l[4]||(l[4]=i=>n.value.allowMakeUpClock=i),"active-text":"允許","inactive-text":"不允許"},null,8,["modelValue"])]),_:1}),e(u,{label:"最晚可補打卡天數"},{default:o(()=>[e(j,{modelValue:n.value.makeUpDays,"onUpdate:modelValue":l[5]||(l[5]=i=>n.value.makeUpDays=i),min:0,disabled:!n.value.allowMakeUpClock},null,8,["modelValue","disabled"]),l[17]||(l[17]=g("small",null,"（允許員工多少天之內可以補打卡）",-1))]),_:1}),e(u,{label:"補打卡是否需主管簽核"},{default:o(()=>[e(b,{modelValue:n.value.makeUpNeedApprove,"onUpdate:modelValue":l[6]||(l[6]=i=>n.value.makeUpNeedApprove=i),disabled:!n.value.allowMakeUpClock},null,8,["modelValue","disabled"])]),_:1}),e(f,{"content-position":"left"},{default:o(()=>l[18]||(l[18]=[m("查詢權限設定")])),_:1}),e(u,{label:"主管是否可查跨部門考勤"},{default:o(()=>[e(b,{modelValue:n.value.supervisorCrossDept,"onUpdate:modelValue":l[7]||(l[7]=i=>n.value.supervisorCrossDept=i),"active-text":"是","inactive-text":"否"},null,8,["modelValue"])]),_:1}),e(u,{label:"HR 是否可查所有部門"},{default:o(()=>[e(b,{modelValue:n.value.hrAllDept,"onUpdate:modelValue":l[8]||(l[8]=i=>n.value.hrAllDept=i),"active-text":"是","inactive-text":"否"},null,8,["modelValue"])]),_:1}),e(u,{label:"員工可查詢歷史紀錄(月)"},{default:o(()=>[e(j,{modelValue:n.value.employeeHistoryMonths,"onUpdate:modelValue":l[9]||(l[9]=i=>n.value.employeeHistoryMonths=i),min:1},null,8,["modelValue"]),l[19]||(l[19]=g("small",null,"（員工可往前查詢幾個月？）",-1))]),_:1}),e(f,{"content-position":"left"},{default:o(()=>l[20]||(l[20]=[m("異常提醒")])),_:1}),e(u,{label:"非延長工時提醒"},{default:o(()=>[e(b,{modelValue:n.value.nonExtWorkAlert,"onUpdate:modelValue":l[10]||(l[10]=i=>n.value.nonExtWorkAlert=i),"active-text":"啟用","inactive-text":"停用"},null,8,["modelValue"])]),_:1}),e(u,{label:"逾時未打卡是否自動通知"},{default:o(()=>[e(b,{modelValue:n.value.overtimeNoClockNotify,"onUpdate:modelValue":l[11]||(l[11]=i=>n.value.overtimeNoClockNotify=i),"active-text":"啟用","inactive-text":"停用"},null,8,["modelValue"])]),_:1}),e(u,{label:"通知對象"},{default:o(()=>[e(h,{modelValue:n.value.notifyTargets,"onUpdate:modelValue":l[12]||(l[12]=i=>n.value.notifyTargets=i)},{default:o(()=>[e(E,{label:"員工"}),e(E,{label:"主管"}),e(E,{label:"HR"})]),_:1},8,["modelValue"])]),_:1}),e(u,null,{default:o(()=>[e(O,{type:"primary",onClick:T},{default:o(()=>l[21]||(l[21]=[m("儲存設定")])),_:1})]),_:1})]),_:1},8,["model"])]),e(Me,{modelValue:R.value,"onUpdate:modelValue":l[13]||(l[13]=i=>R.value=i),onImportComplete:k},null,8,["modelValue"])],64)}}},Ke=oe(Se,[["__scopeId","data-v-2e813ea5"]]);export{Ke as default};
