import{A as Et,r as b,q as $t,_ as Xe,v as x,C as At,D as Ze,G as et,c as _,o as m,F as U,m as B,e as O,l as I,w as y,b as p,H as Te,I as jt,t as A,J as R,k as ge,j as xt,d as f,x as L,a as Ut,h as oe,E as F,u as Mt,g as N,n as Ot,f as Lt,z as Se,K as Nt}from"./index-DTgl98wj.js";import{a as j}from"./api-DiKkRxLO.js";const zt=Et("auth",()=>{const te=b("employee");function k(){const v=$t();if(v)try{const P=JSON.parse(atob(v.split(".")[1]));te.value=P.role||"employee"}catch{te.value="employee"}else te.value="employee"}return{role:te,loadUser:k}}),Tt={class:"dashboard"},Rt={class:"metric-label"},Ft={class:"metric-value"},Bt=Object.assign({name:"ScheduleDashboard"},{__name:"ScheduleDashboard",props:{summary:{type:Object,default:()=>({direct:0,unscheduled:0,onLeave:0})}},setup(te){const k=te,v=x(()=>[{label:"直屬員工數",value:k.summary.direct,icon:At,color:"#0f766e"},{label:"未排班員工",value:k.summary.unscheduled,icon:Ze,color:"#dc2626"},{label:"請假中員工",value:k.summary.onLeave,icon:et,color:"#f59e0b"}]);return(P,E)=>{const re=O("el-card");return m(),_("div",Tt,[(m(!0),_(U,null,B(v.value,D=>(m(),I(re,{class:"metric-card",key:D.label},{default:y(()=>[(m(),I(Te(D.icon),{class:"metric-icon",style:jt({color:D.color})},null,8,["style"])),p("div",Rt,A(D.label),1),p("div",Ft,A(D.value),1)]),_:2},1024))),128))])}}}),Pt=Xe(Bt,[["__scopeId","data-v-ceb5c889"]]),Jt={class:"schedule-page"},Wt={class:"filters-card"},Kt={class:"filters-content"},Yt={class:"filter-group"},qt={class:"filter-group"},Ht={class:"filter-group"},Gt={key:0,class:"filter-group include-self-group"},Qt={class:"actions-card"},Xt={class:"primary-actions"},Zt={class:"secondary-actions"},ea={class:"range-picker-wrapper"},ta={class:"schedule-card"},aa={class:"schedule-header"},la={key:0,class:"batch-toolbar"},sa={class:"employee-info"},na={class:"department-name"},oa={key:0,class:"sub-department"},ra={class:"employee-name"},ia={class:"day-header"},ua=["title"],da={key:0,class:"leave-indicator","data-test":"leave-indicator"},ca={class:"department-selects"},va={class:"shift-details"},pa={class:"detail-row"},ma={class:"detail-value"},fa={class:"detail-row"},ha={class:"detail-value"},ya={key:0,class:"detail-row"},ba={class:"detail-value"},_a={class:"modern-shift-tag"},ga={key:3,class:"missing-label"},Sa={key:2,class:"empty-cell"},wa={key:1,class:"modern-schedule-cell collapsed-cell"},ka={key:0,class:"approval-card"},Da={class:"approval-header"},Ca={class:"approval-count"},Ia={class:"applicant-name"},Va={class:"form-type"},Ea={__name:"Schedule",setup(te){const k=b(R().format("YYYY-MM")),v=b({}),P=b([]),E=b([]),re=b([]),D=b([]),J=b([]),w=b(""),C=b(""),$=b(""),z=b(""),S=b(""),de=b(""),Q=b([]),ce=b(null),ie=b(!1),Re=b({direct:0,unscheduled:0,onLeave:0}),we=b(""),ke=b("all"),De=b(new Set),X=b(new Set),W=b(new Set),ae=b(new Set),je=b([]),ve=b(""),Z=b(""),K=b(""),Ce=b(!1),tt=x(()=>X.value),at=x(()=>W.value),lt=x(()=>ae.value),le=(t,e)=>`${t}-${e}`,xe=t=>{const[e,a]=String(t).split("-");return{empId:e,day:Number(a)}},Ie=(t,e)=>{const a=v.value[t];if(!a)return!1;const l=a[e];return l?!l.leave:!1},Ue=x(()=>{const t=new Set,e=Y.value,a=E.value,l=(n,o)=>{Ie(n,o)&&t.add(le(n,o))};return ae.value.forEach(n=>{const{empId:o,day:c}=xe(n);l(o,c)}),X.value.forEach(n=>{e.forEach(o=>l(n,o.date))}),W.value.forEach(n=>{a.forEach(o=>l(o._id,n))}),t}),Me=x(()=>Ue.value.size>0),Fe=x(()=>Z.value?Ge(Z.value):[]),st=(t,e)=>Ue.value.has(le(t,e)),Ve=()=>{const t=new Set(E.value.map(l=>l._id)),e=new Set(Y.value.map(l=>l.date));X.value=new Set(Array.from(X.value).filter(l=>t.has(l))),W.value=new Set(Array.from(W.value).filter(l=>e.has(l)));const a=new Set;ae.value.forEach(l=>{const{empId:n,day:o}=xe(l);t.has(n)&&e.has(o)&&Ie(n,o)&&a.add(le(n,o))}),ae.value=a},nt=()=>{X.value=new Set,W.value=new Set,ae.value=new Set,je.value=[]},ot=(t,e)=>{const a=new Set(X.value);(typeof e=="boolean"?e:!a.has(t))?a.add(t):a.delete(t),X.value=a},rt=(t,e)=>{const a=new Set(W.value);(typeof e=="boolean"?e:!a.has(t))?a.add(t):a.delete(t),W.value=a},it=(t,e,a)=>{if(!Ie(t,e))return;const l=le(t,e),n=new Set(ae.value);(typeof a=="boolean"?a:!n.has(l))?n.add(l):n.delete(l),ae.value=n},ut=()=>{X.value=new Set(E.value.map(t=>t._id))},dt=()=>{W.value=new Set(Y.value.map(t=>t.date))},Be=t=>[...t].sort((e,a)=>{const l=(e.department||"").localeCompare(a.department||"");return l!==0?l:(e.name||"").localeCompare(a.name||"")}),ct=t=>{if(!Array.isArray(t)||t.length!==2)return;const[e,a]=t;if(!e||!a)return;const l=R(`${k.value}-01`),n=R(e),o=R(a);if(!n.isValid()||!o.isValid())return;const c=l.endOf("month");let u=n.isBefore(l)?l:n;const r=[];for(;(u.isBefore(o)||u.isSame(o,"day"))&&(u.year()===l.year()&&u.month()===l.month()&&r.push(u.date()),!u.isSame(c,"day"));)u=u.add(1,"day");W.value=new Set(r)};ge(Z,(t,e)=>{t!==e&&(K.value="")}),ge(Fe,t=>{K.value&&!t.some(e=>e._id===K.value)&&(K.value="")}),ge(ie,async(t,e)=>{t!==e&&pe.value&&(await he(w.value,C.value),await fe(),await ze())});const Oe=t=>{const e=v.value[t]||{},a=Object.values(e),l=a.some(o=>o.shiftId),n=a.some(o=>o.leave);return l?n?"onLeave":"scheduled":"unscheduled"},vt=x(()=>{let t=we.value?E.value.filter(e=>e.name.includes(we.value)):E.value;return ke.value!=="all"&&(t=t.filter(e=>Oe(e._id)===ke.value)),t}),Pe=x(()=>E.value.length>50),pt=t=>{De.value.has(t)?De.value.delete(t):De.value.add(t)},mt=x(()=>J.value.filter(t=>t.department===w.value)),ft=Mt(),ue=zt();ue.loadUser();const Je=x(()=>["supervisor","admin"].includes(ue.role)),pe=x(()=>ue.role==="supervisor"),me=Je,We=t=>{var l,n;const e=(l=F)==null?void 0:l.warning;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.warning:void 0;typeof a=="function"&&a!==e&&a(t)},Le=t=>{var l,n;const e=(l=F)==null?void 0:l.info;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.info:void 0;typeof a=="function"&&a!==e&&a(t)},ht=t=>{var l,n;const e=(l=F)==null?void 0:l.success;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.success:void 0;typeof a=="function"&&a!==e&&a(t)},yt=(t,e)=>{var l,n;const a=(n=(l=v.value)==null?void 0:l[t])==null?void 0:n[e];return a!=null&&a.leave?"已核准請假，該日不列入工作時數":""},Y=x(()=>{const t=R(k.value+"-01"),e=t.endOf("month").date(),a=["日","一","二","三","四","五","六"];return Array.from({length:e},(l,n)=>{const o=n+1,c=a[t.date(o).day()];return{date:o,label:`${o}(${c})`}})});ge(E,Ve),ge(Y,Ve);async function bt(){const t=await j("/api/shifts");if(t.ok){const e=await t.json(),a=Array.isArray(e==null?void 0:e.shifts)?e.shifts:Array.isArray(e)?e:[];Array.isArray(a)&&(P.value=a.map(l=>({_id:l._id,code:l.code,name:l.name??"",startTime:l.startTime,endTime:l.endTime,remark:l.remark})))}else t.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",t.status)}async function Ke(t=""){try{const e=t||$.value,a=e?`/api/sub-departments?department=${e}`:"/api/sub-departments",l=await j(a);if(!l.ok)throw new Error("Failed to fetch sub departments");const n=await l.json(),o=D.value.reduce((r,d)=>{const h=String(d._id);return r[h]=h,d.name&&(r[d.name]=h),r},{});$.value&&(o[$.value]=$.value),z.value&&(o[z.value]=$.value||z.value);const c=Array.isArray(n)?n.map(r=>{const d=r==null?void 0:r.department;let h="";return d&&typeof d=="object"?h=(d==null?void 0:d._id)||(d==null?void 0:d.id)||o[d==null?void 0:d.name]||"":h=o[d]||d||"",{...r,_id:String((r==null?void 0:r._id)??(r==null?void 0:r.id)??""),department:String(h)}}).filter(r=>r._id):[];let u=c;if(e&&(u=c.filter(r=>r.department===String(e)),!u.length&&S.value)){const r=c.find(d=>d._id===S.value);r?u=[r]:u=[{_id:S.value,name:de.value||"",department:String(e)}]}if(ue.role==="supervisor"){const r=Q.value.length?Q.value:S.value?[S.value]:[],d=new Set(r.map(h=>String(h)));d.size?u=u.filter(h=>d.has(String(h._id))):u=[]}J.value=u,J.value.length?S.value&&J.value.some(r=>r._id===S.value)?C.value=S.value:C.value&&J.value.some(r=>r._id===C.value)||(C.value=J.value[0]._id):C.value=""}catch(e){console.error(e),J.value=[],C.value=""}}async function _t(){var t;try{const e=await j("/api/departments"),a=e.ok?await e.json():[],l=Array.isArray(a)?a.map(u=>{const r=(u==null?void 0:u._id)??(u==null?void 0:u.id)??(u==null?void 0:u.value)??"";return{...u,_id:String(r),name:(u==null?void 0:u.name)??""}}).filter(u=>u._id):[],n=w.value||$.value;let o=l;n&&(o=l.filter(u=>u._id===n||z.value&&u.name===z.value),!o.length&&n&&(o=[{_id:n,name:z.value||((t=l.find(u=>u._id===n))==null?void 0:t.name)||""}])),D.value=o.length?o:l,D.value.length?D.value.some(u=>u._id===w.value)||(w.value=D.value[0]._id):!w.value&&n&&(w.value=n);const c=w.value||$.value||(D.value.length?D.value[0]._id:"");await Ke(c)}catch(e){console.error(e)}}const Ee=()=>{var a,l;if(!Je.value||typeof window>"u")return"";const t=(a=window.sessionStorage)==null?void 0:a.getItem("employeeId");if(t&&t!=="undefined")return t;const e=(l=window.localStorage)==null?void 0:l.getItem("employeeId");return e&&e!=="undefined"?e:""};async function gt(){if(ue.role!=="supervisor"){$.value="",z.value="",S.value="",de.value="",Q.value=[],ce.value=null;return}const t=Ee();if(!t){$.value="",z.value="",S.value="",de.value="",Q.value=[],ce.value=null;return}let e=null;try{const r=await j(`/api/employees/${t}`);if(!r.ok)throw new Error("Failed to fetch supervisor context");e=await r.json()}catch(r){console.error(r),ce.value=null}ce.value=e||null;const a=e==null?void 0:e.department,l=typeof a=="object"?(a==null?void 0:a._id)||(a==null?void 0:a.id)||(a==null?void 0:a.value):a,n=typeof a=="object"?(a==null?void 0:a.name)||"":(e==null?void 0:e.departmentName)||"";$.value=l?String(l):"",z.value=n?String(n):"",$.value?w.value=$.value:w.value="";const o=e==null?void 0:e.subDepartment,c=typeof o=="object"?(o==null?void 0:o._id)||(o==null?void 0:o.id)||(o==null?void 0:o.value):o,u=typeof o=="object"?(o==null?void 0:o.name)||"":(e==null?void 0:e.subDepartmentName)||"";S.value=c?String(c):"",de.value=u?String(u):"",S.value?C.value=S.value:C.value="",await St(t)}async function St(t=""){if(ue.role!=="supervisor"){Q.value=[];return}const e=t||Ee();if(!e){Q.value=S.value?[String(S.value)]:[];return}try{const a=await j(`/api/employees?supervisor=${e}`);if(!a.ok)throw new Error("Failed to fetch direct reports");const l=await a.json(),n=Array.isArray(l)?l:[],o=new Set,c=[],u=r=>{if(!r&&r!==0)return;const d=String(r);d&&(o.has(d)||(o.add(d),c.push(d)))};n.forEach(r=>{const d=r==null?void 0:r.subDepartment;u(d&&typeof d=="object"?(d==null?void 0:d._id)||(d==null?void 0:d.id)||(d==null?void 0:d.value):d)}),u(S.value),Q.value=c}catch(a){console.error(a),Q.value=S.value?[String(S.value)]:[]}}async function fe(){const t=Ee(),e=[`month=${k.value}`];t&&e.push(`supervisor=${t}`),ie.value&&pe.value&&e.push("includeSelf=true");const a=`?${e.join("&")}`;try{const l=await j(`/api/schedules/monthly${a}`);if(!l.ok)throw new Error("Failed to fetch schedules");const n=await l.json(),o=Array.isArray(n)?n:[],c=Y.value;v.value={},!E.value.length&&o.length&&await he(w.value,C.value),E.value.forEach(r=>{const d=String(r._id);v.value[d]={},c.forEach(h=>{v.value[d][h.date]={shiftId:"",department:r.departmentId,subDepartment:r.subDepartmentId}})}),o.forEach(r=>{var s;const d=((s=r.employee)==null?void 0:s._id)||r.employee;if(!d)return;const h=String(d);v.value[h]||(v.value[h]={},c.forEach(i=>{v.value[h][i.date]={shiftId:"",department:"",subDepartment:""}}));const M=R(r.date).date(),T=E.value.find(i=>String(i._id)===h)||{};v.value[h][M]={id:r._id,shiftId:r.shiftId,department:r.department||T.departmentId,subDepartment:r.subDepartment||T.subDepartmentId}});const u=await j(`/api/schedules/leave-approvals${a}`);if(u.ok){const r=await u.json(),d=Array.isArray(r==null?void 0:r.approvals)?r.approvals:[],h=Array.isArray(r==null?void 0:r.leaves)?r.leaves:[];re.value=d;const M=R(`${k.value}-01`).startOf("day"),T=M.endOf("month").startOf("day");h.forEach(s=>{var ee,ye,be;if(s.status!=="approved")return;const i=((ee=s.employee)==null?void 0:ee._id)||s.employee;if(!i)return;const V=String(i),q=R(s.startDate).startOf("day"),H=R(s.endDate).startOf("day");if(!q.isValid()||!H.isValid())return;let G=q.isBefore(M)?M:q;const ne=H.isAfter(T)?T:H;for(;!G.isAfter(ne);){const Ae=G.date(),_e=(be=(ye=v.value)==null?void 0:ye[V])==null?void 0:be[Ae];_e&&(_e.leave={type:s.leaveType,startDate:s.startDate,endDate:s.endDate,excludesHours:!0}),G=G.add(1,"day")}})}Ve()}catch(l){console.error(l),F.error("取得排班資料失敗")}}function Ye(t){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:v.value,employees:E.value,days:Y.value,shifts:P.value})),ft.push({name:t==="week"?"PreviewWeek":"PreviewMonth"})}async function qe(t){try{const e=await j(`/api/schedules/export?month=${k.value}&format=${t}`);if(!e.ok)throw new Error;const a=await e.blob(),l=URL.createObjectURL(a),n=document.createElement("a");n.href=l,n.download=`schedules-${k.value}.${t==="excel"?"xlsx":"pdf"}`,n.click(),URL.revokeObjectURL(l)}catch{F.error("匯出失敗")}}async function wt(t,e,a){const l=`${k.value}-${String(e).padStart(2,"0")}`,n=v.value[t][e];if(n!=null&&n.leave){Le("該日已核准請假，無法調整排班");return}const o=(n==null?void 0:n.shiftId)??"";if(n&&n.id)try{const c=await j(`/api/schedules/${n.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:a,department:n.department,subDepartment:n.subDepartment})});c.ok||await $e(c,"更新排班失敗",t,e,o)}catch{await $e(null,"更新排班失敗",t,e,o)}else try{const c=await j("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:t,date:l,shiftId:a,department:n.department,subDepartment:n.subDepartment})});if(c.ok){const u=await c.json();v.value[t][e]={id:u._id,shiftId:u.shiftId,department:n.department,subDepartment:n.subDepartment}}else await $e(c,"新增排班失敗",t,e,o)}catch{await $e(null,"新增排班失敗",t,e,o)}}async function kt(){C.value="",await Ke(w.value),await he(w.value,""),await fe()}async function Dt(){await he(w.value,C.value),await fe()}async function $e(t,e,a,l,n){v.value[a]||(v.value[a]={});const o=v.value[a][l]||{shiftId:"",department:"",subDepartment:""};o.shiftId=n,v.value[a][l]=o;let c="";try{if(t){const u=await t.json();c=(u==null?void 0:u.error)||""}}catch{}c==="employee conflict"?Se.alert("人員衝突"):c==="department overlap"?Se.alert("跨區重複"):c==="leave conflict"?Se.alert("請假衝突"):F.error(e)}async function He(t,e="批次套用失敗"){let a="";try{if(t){const l=await t.json();a=(l==null?void 0:l.error)||""}}catch{}a==="employee conflict"?F.warning("部分員工既有排班已更新，請重新整理檢查"):a==="department overlap"?Se.alert("部門或單位與既有資料不一致，無法套用"):a==="leave conflict"?Se.alert("選取日期包含已核准請假，無法套用"):a?F.error(a):F.error(e)}async function Ct(){if(!Me.value){We("請先選取要套用的儲存格");return}if(!ve.value){We("請選擇欲套用的班別");return}const t=[];if(Ue.value.forEach(l=>{var d;const{empId:n,day:o}=xe(l),c=(d=v.value[n])==null?void 0:d[o];if(!c||c.leave)return;const u=Z.value||c.department||"";let r=c.subDepartment||"";Z.value?r=K.value||"":K.value&&(r=K.value),t.push({employee:n,day:o,date:`${k.value}-${String(o).padStart(2,"0")}`,shiftId:ve.value,department:u,subDepartment:r})}),!t.length){Le("選取的儲存格皆無需更新");return}const e=new Map;t.forEach(l=>{e.set(le(l.employee,l.day),l)}),Ce.value=!0;const a=Nt.service({fullscreen:!0,lock:!0,text:"批次套用中..."});try{let l;try{l=await j("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:t.map(({day:o,...c})=>c)})})}catch{await He(null);return}if(!l.ok){await He(l);return}const n=await l.json();if(!Array.isArray(n)||!n.length){Le("沒有可更新的資料");return}n.forEach(o=>{var M;const c=((M=o.employee)==null?void 0:M._id)||o.employee,u=R(o.date).date();v.value[c]||(v.value[c]={});const r=le(c,u),d=e.get(r)||{},h=v.value[c][u]||{};v.value[c][u]={...h,id:o._id||d.id||h.id,shiftId:o.shiftId||d.shiftId||h.shiftId,department:d.department??o.department??h.department??"",subDepartment:d.subDepartment??o.subDepartment??h.subDepartment??""},delete v.value[c][u].leave}),ht("批次套用完成")}finally{a==null||a.close(),Ce.value=!1}}function se(t){return P.value.find(e=>e._id===t)}function Ne(t){if(!t)return"";const e=t.code??"",a=t.name??"";return!e&&!a?"":a?`${e}(${a})`:e}function It(t){const e=se(t);return e?/早/.test(e.code)?"shift-morning":/晚|夜/.test(e.code)?"shift-evening":"shift-normal":""}function Ge(t){return J.value.filter(e=>e.department===t)}async function he(t="",e=""){var u;const a=Ee(),l=[],n=t||w.value||$.value,o=e||C.value;a&&l.push(`supervisor=${a}`),n&&l.push(`department=${n}`),o&&l.push(`subDepartment=${o}`);const c=`/api/employees${l.length?`?${l.join("&")}`:""}`;try{const r=await j(c);if(!r.ok)throw new Error("Failed to fetch employees");const d=await r.json(),h=D.value.reduce((i,V)=>(i[V._id]=V.name,i),{}),M=J.value.reduce((i,V)=>(i[V._id]=V.name,i),{}),T=d.map(i=>{const V=(i==null?void 0:i._id)??(i==null?void 0:i.id)??"",q=(i==null?void 0:i.department)??"",H=(i==null?void 0:i.subDepartment)??"",G=V?String(V):"",ne=q?String(q):"",ee=H?String(H):"";return{_id:G,name:i.name,departmentId:ne,subDepartmentId:ee,department:h[ne]||"",subDepartment:M[ee]||""}});let s=Be(T);if(ie.value&&pe.value){const i=a?String(a):"";i&&!s.some(V=>V._id===i)&&(s=Be([...s,{_id:i,name:((u=ce.value)==null?void 0:u.name)||"主管本人",departmentId:$.value||"",subDepartmentId:S.value||"",department:z.value||"",subDepartment:de.value||""}]))}E.value=s,Ve()}catch(r){console.error(r),F.error("取得員工資料失敗")}}async function ze(){try{const t=[`month=${k.value}`];ie.value&&pe.value&&t.push("includeSelf=true");const e=await j(`/api/schedules/summary?${t.join("&")}`);if(e.ok){const a=await e.json();Re.value={direct:a.length,unscheduled:a.filter(l=>l.shiftCount===0).length,onLeave:a.filter(l=>l.leaveCount>0).length}}}catch(t){console.error(t)}}async function Vt(){await fe(),await ze()}return xt(async()=>{await ze(),await bt(),await gt(),await _t(),await he(w.value,C.value),await fe()}),(t,e)=>{const a=O("el-date-picker"),l=O("el-option"),n=O("el-select"),o=O("el-switch"),c=O("el-button"),u=O("el-input"),r=O("el-table-column"),d=O("el-checkbox"),h=O("el-tag"),M=O("el-popover"),T=O("el-table");return m(),_("div",Jt,[e[37]||(e[37]=p("div",{class:"page-header"},[p("h1",{class:"page-title"},"排班管理"),p("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),f(Pt,{summary:Re.value},null,8,["summary"]),p("div",Wt,[e[20]||(e[20]=p("div",{class:"filters-header"},[p("h3",{class:"filters-title"},"篩選條件")],-1)),p("div",Kt,[p("div",Yt,[e[16]||(e[16]=p("label",{class:"filter-label"},"選擇月份",-1)),f(a,{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=s=>k.value=s),type:"month",onChange:Vt,class:"modern-date-picker"},null,8,["modelValue"])]),p("div",qt,[e[17]||(e[17]=p("label",{class:"filter-label"},"部門",-1)),f(n,{modelValue:w.value,"onUpdate:modelValue":e[1]||(e[1]=s=>w.value=s),placeholder:"請選擇部門",onChange:kt,disabled:!0,class:"modern-select"},{default:y(()=>[(m(!0),_(U,null,B(D.value,s=>(m(),I(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),p("div",Ht,[e[18]||(e[18]=p("label",{class:"filter-label"},"單位",-1)),f(n,{modelValue:C.value,"onUpdate:modelValue":e[2]||(e[2]=s=>C.value=s),placeholder:"請選擇單位",onChange:Dt,class:"modern-select"},{default:y(()=>[(m(!0),_(U,null,B(mt.value,s=>(m(),I(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),pe.value?(m(),_("div",Gt,[e[19]||(e[19]=p("label",{class:"filter-label"},"包含自己",-1)),f(o,{modelValue:ie.value,"onUpdate:modelValue":e[3]||(e[3]=s=>ie.value=s),"active-text":"是","inactive-text":"否","inline-prompt":""},null,8,["modelValue"])])):L("",!0)])]),p("div",Qt,[p("div",Xt,[f(c,{type:"primary",class:"action-btn primary",onClick:nt,disabled:!Me.value},{default:y(()=>e[21]||(e[21]=[p("i",{class:"el-icon-close"},null,-1),N(" 清除選取 ")])),_:1},8,["disabled"]),f(c,{type:"primary",class:"action-btn primary",plain:"",onClick:ut,disabled:!E.value.length},{default:y(()=>e[22]||(e[22]=[p("i",{class:"el-icon-user"},null,-1),N(" 全選員工 ")])),_:1},8,["disabled"]),f(c,{type:"primary",class:"action-btn primary",plain:"",onClick:dt,disabled:!Y.value.length},{default:y(()=>e[23]||(e[23]=[p("i",{class:"el-icon-date"},null,-1),N(" 全選日期 ")])),_:1},8,["disabled"])]),p("div",Zt,[p("div",ea,[e[24]||(e[24]=p("label",{class:"range-label"},"自訂日期範圍",-1)),f(a,{modelValue:je.value,"onUpdate:modelValue":e[4]||(e[4]=s=>je.value=s),type:"daterange","start-placeholder":"開始日期","end-placeholder":"結束日期","range-separator":"至","unlink-panels":"",disabled:!Y.value.length,class:"modern-date-picker range-picker",onChange:ct},null,8,["modelValue","disabled"])]),f(c,{onClick:e[5]||(e[5]=s=>Ye("week")),class:"action-btn secondary"},{default:y(()=>e[25]||(e[25]=[p("i",{class:"el-icon-calendar"},null,-1),N(" 預覽週表 ")])),_:1}),f(c,{onClick:e[6]||(e[6]=s=>Ye("month")),class:"action-btn secondary"},{default:y(()=>e[26]||(e[26]=[p("i",{class:"el-icon-date"},null,-1),N(" 預覽月表 ")])),_:1}),f(c,{onClick:e[7]||(e[7]=()=>qe("pdf")),class:"action-btn export"},{default:y(()=>e[27]||(e[27]=[p("i",{class:"el-icon-download"},null,-1),N(" 匯出 PDF ")])),_:1}),f(c,{onClick:e[8]||(e[8]=()=>qe("excel")),class:"action-btn export"},{default:y(()=>e[28]||(e[28]=[p("i",{class:"el-icon-s-grid"},null,-1),N(" 匯出 Excel ")])),_:1})])]),p("div",ta,[p("div",aa,[e[29]||(e[29]=Ut('<h3 class="schedule-title" data-v-d3c16bd4>員工排班表</h3><div class="schedule-legend" data-v-d3c16bd4><span class="legend-item morning" data-v-d3c16bd4>早班</span><span class="legend-item evening" data-v-d3c16bd4>晚班</span><span class="legend-item normal" data-v-d3c16bd4>正常班</span><span class="legend-item leave" data-v-d3c16bd4>請假</span></div>',2)),f(u,{modelValue:we.value,"onUpdate:modelValue":e[9]||(e[9]=s=>we.value=s),placeholder:"搜尋員工",clearable:"",class:"employee-search"},null,8,["modelValue"]),f(n,{modelValue:ke.value,"onUpdate:modelValue":e[10]||(e[10]=s=>ke.value=s),placeholder:"狀態",class:"status-filter"},{default:y(()=>[f(l,{label:"全部",value:"all"}),f(l,{label:"缺班",value:"unscheduled"}),f(l,{label:"待審核請假",value:"onLeave"})]),_:1},8,["modelValue"])]),oe(me)?(m(),_("div",la,[f(n,{modelValue:ve.value,"onUpdate:modelValue":e[11]||(e[11]=s=>ve.value=s),placeholder:"套用班別",class:"modern-select batch-select",filterable:"","data-test":"batch-shift-select"},{default:y(()=>[(m(!0),_(U,null,B(P.value,s=>(m(),I(l,{key:s._id,label:Ne(s),value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(n,{modelValue:Z.value,"onUpdate:modelValue":e[12]||(e[12]=s=>Z.value=s),placeholder:"套用部門",clearable:"",class:"modern-select batch-select","data-test":"batch-dept-select"},{default:y(()=>[(m(!0),_(U,null,B(D.value,s=>(m(),I(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(n,{modelValue:K.value,"onUpdate:modelValue":e[13]||(e[13]=s=>K.value=s),placeholder:"套用單位",clearable:"",class:"modern-select batch-select",disabled:!Z.value,"data-test":"batch-subdept-select"},{default:y(()=>[(m(!0),_(U,null,B(Fe.value,s=>(m(),I(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),f(c,{type:"primary",class:"action-btn primary apply-btn",disabled:!Me.value||!ve.value||Ce.value,loading:Ce.value,onClick:Ct,"data-test":"batch-apply-button"},{default:y(()=>e[30]||(e[30]=[N(" 套用至選取 ")])),_:1},8,["disabled","loading"])])):L("",!0),f(T,{class:"modern-schedule-table",data:vt.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"},onRowClick:e[15]||(e[15]=s=>Pe.value&&pt(s._id))},{default:y(()=>[f(r,{label:"部門／單位",width:"180",fixed:"left"},{default:y(({row:s})=>[p("div",sa,[p("div",na,A(s.department),1),s.subDepartment?(m(),_("div",oa,A(s.subDepartment),1)):L("",!0)])]),_:1}),f(r,{prop:"name",label:"員工姓名",width:"150",fixed:"left"},{default:y(({row:s})=>[p("div",ra,[oe(me)?(m(),I(d,{key:0,class:"row-checkbox","model-value":tt.value.has(s._id),onChange:i=>ot(s._id,i)},null,8,["model-value","onChange"])):L("",!0),Oe(s._id)==="unscheduled"?(m(),I(Te(oe(Ze)),{key:1,class:"status-icon unscheduled"})):Oe(s._id)==="onLeave"?(m(),I(Te(oe(et)),{key:2,class:"status-icon on-leave"})):L("",!0),N(" "+A(s.name),1)])]),_:1}),(m(!0),_(U,null,B(Y.value,s=>(m(),I(r,{key:s.date,label:s.label,width:"140",align:"center"},{header:y(()=>[p("div",ia,[p("span",null,A(s.label),1),oe(me)?(m(),I(d,{key:0,class:"day-checkbox","model-value":at.value.has(s.date),onChange:i=>rt(s.date,i)},null,8,["model-value","onChange"])):L("",!0)])]),default:y(({row:i})=>{var V,q,H,G,ne,ee,ye,be,Ae,_e,Qe;return[!Pe.value||De.value.has(i._id)?(m(),_("div",{key:0,class:Ot(["modern-schedule-cell",[(q=(V=v.value[i._id])==null?void 0:V[s.date])!=null&&q.leave?"":It((G=(H=v.value[i._id])==null?void 0:H[s.date])==null?void 0:G.shiftId),{"has-leave":(ee=(ne=v.value[i._id])==null?void 0:ne[s.date])==null?void 0:ee.leave,"missing-shift":!((be=(ye=v.value[i._id])==null?void 0:ye[s.date])!=null&&be.shiftId)&&!((_e=(Ae=v.value[i._id])==null?void 0:Ae[s.date])!=null&&_e.leave),"is-selected":st(i._id,s.date)}]]),title:yt(i._id,s.date)},[oe(me)?(m(),_("div",{key:0,class:"cell-selection",onClick:e[14]||(e[14]=Lt(()=>{},["stop"]))},[f(d,{"model-value":lt.value.has(le(i._id,s.date)),disabled:!Ie(i._id,s.date),onChange:g=>it(i._id,s.date,g),size:"small"},null,8,["model-value","disabled","onChange"])])):L("",!0),(Qe=v.value[i._id])!=null&&Qe[s.date]?(m(),_(U,{key:1},[v.value[i._id][s.date].leave?(m(),_("div",da,[f(h,{type:"warning",effect:"light",size:"small",class:"leave-tag"},{default:y(()=>e[31]||(e[31]=[N(" 休假中 ")])),_:1}),e[32]||(e[32]=p("span",{class:"leave-note"},"已核准請假，不列入工時",-1))])):oe(me)?(m(),_(U,{key:1},[f(n,{modelValue:v.value[i._id][s.date].shiftId,"onUpdate:modelValue":g=>v.value[i._id][s.date].shiftId=g,placeholder:"選擇班別",onChange:g=>wt(i._id,s.date,g),class:"cell-select shift-select",size:"small"},{default:y(()=>[(m(!0),_(U,null,B(P.value,g=>(m(),I(l,{key:g._id,label:Ne(g),value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),p("div",ca,[f(n,{modelValue:v.value[i._id][s.date].department,"onUpdate:modelValue":g=>v.value[i._id][s.date].department=g,placeholder:"部門",size:"small",onChange:()=>v.value[i._id][s.date].subDepartment="",class:"cell-select dept-select"},{default:y(()=>[(m(!0),_(U,null,B(D.value,g=>(m(),I(l,{key:g._id,label:g.name,value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),f(n,{modelValue:v.value[i._id][s.date].subDepartment,"onUpdate:modelValue":g=>v.value[i._id][s.date].subDepartment=g,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:y(()=>[(m(!0),_(U,null,B(Ge(v.value[i._id][s.date].department),g=>(m(),I(l,{key:g._id,label:g.name,value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(m(),_(U,{key:2},[se(v.value[i._id][s.date].shiftId)?(m(),I(M,{key:0,placement:"top",trigger:"hover",width:200},{reference:y(()=>[p("div",_a,A(Ne(se(v.value[i._id][s.date].shiftId))),1)]),default:y(()=>[p("div",va,[p("div",pa,[e[33]||(e[33]=p("span",{class:"detail-label"},"上班時間：",-1)),p("span",ma,A(se(v.value[i._id][s.date].shiftId).startTime),1)]),p("div",fa,[e[34]||(e[34]=p("span",{class:"detail-label"},"下班時間：",-1)),p("span",ha,A(se(v.value[i._id][s.date].shiftId).endTime),1)]),se(v.value[i._id][s.date].shiftId).remark?(m(),_("div",ya,[e[35]||(e[35]=p("span",{class:"detail-label"},"備註：",-1)),p("span",ba,A(se(v.value[i._id][s.date].shiftId).remark),1)])):L("",!0)])]),_:2},1024)):L("",!0)],64)),!v.value[i._id][s.date].shiftId&&!v.value[i._id][s.date].leave?(m(),_("div",ga," 未排班 ")):L("",!0)],64)):(m(),_("span",Sa,"-"))],10,ua)):(m(),_("div",wa,"展開班表"))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])]),re.value.length?(m(),_("div",ka,[p("div",Da,[e[36]||(e[36]=p("h3",{class:"approval-title"},"待處理審批",-1)),p("div",Ca,A(re.value.length)+" 項待處理",1)]),f(T,{class:"modern-approval-table",data:re.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:y(()=>[f(r,{label:"申請人",width:"120"},{default:y(({row:s})=>{var i;return[p("div",Ia,A((i=s.applicant_employee)==null?void 0:i.name),1)]}),_:1}),f(r,{label:"申請類型",width:"150"},{default:y(({row:s})=>{var i;return[p("div",Va,A(((i=s.form)==null?void 0:i.name)||"未知類型"),1)]}),_:1}),f(r,{prop:"status",label:"狀態",width:"100"},{default:y(({row:s})=>[f(h,{type:s.status==="approved"?"success":s.status==="rejected"?"danger":"warning",class:"status-tag"},{default:y(()=>[N(A(s.status),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])):L("",!0)])}}},ja=Xe(Ea,[["__scopeId","data-v-d3c16bd4"]]);export{ja as default};
