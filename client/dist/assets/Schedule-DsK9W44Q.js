import{_ as Dt,v as O,G as tl,H as It,I as Ct,c as b,o as f,F as x,m as P,e as $,l as A,w as y,b as d,J as Qe,z as Ye,t as w,r as g,K as R,q as kt,k as ye,j as ll,d as m,x as K,h as fe,E as X,u as al,g as I,n as nl,f as sl,A as Ee,L as ol}from"./index-BclQli2C.js";import{a as N}from"./api-BujQ9oFr.js";import{u as rl}from"./auth-blEWLvRV.js";import{b as il}from"./shiftColors-BbvJ2s1U.js";const ul={class:"dashboard"},dl={class:"metric-label"},cl={class:"metric-value"},vl=Object.assign({name:"ScheduleDashboard"},{__name:"ScheduleDashboard",props:{summary:{type:Object,default:()=>({direct:0,unscheduled:0,onLeave:0})}},setup(Xe){const he=Xe,Fe=O(()=>[{label:"直屬員工數",value:he.summary.direct,icon:tl,color:"#0f766e"},{label:"未排班員工",value:he.summary.unscheduled,icon:It,color:"#dc2626"},{label:"請假中員工",value:he.summary.onLeave,icon:Ct,color:"#f59e0b"}]);return(Ze,et)=>{const L=$("el-card");return f(),b("div",ul,[(f(!0),b(x,null,P(Fe.value,v=>(f(),A(L,{class:"metric-card",key:v.label},{default:y(()=>[(f(),A(Qe(v.icon),{class:"metric-icon",style:Ye({color:v.color})},null,8,["style"])),d("div",dl,w(v.label),1),d("div",cl,w(v.value),1)]),_:2},1024))),128))])}}}),pl=Dt(vl,[["__scopeId","data-v-ceb5c889"]]),fl={class:"schedule-page"},ml={class:"filters-card"},yl={class:"filters-content"},hl={class:"filter-group"},_l={class:"filter-group"},bl={class:"filter-group"},gl={key:0,class:"filter-group include-self-group"},Sl={class:"actions-card"},wl={class:"primary-actions"},kl={class:"secondary-actions"},Dl={class:"range-picker-wrapper"},Il={class:"schedule-card"},Cl={class:"schedule-header"},Vl={class:"schedule-legend","data-test":"schedule-legend"},El={key:1,class:"legend-empty","data-test":"shift-legend-empty"},$l={key:0,class:"batch-toolbar"},Al={class:"employee-info"},jl={class:"department-name"},xl={key:0,class:"sub-department"},Ml={class:"employee-name"},Ul={class:"day-header"},Ll=["title"],zl={key:0,class:"leave-indicator","data-test":"leave-indicator"},Nl={class:"department-selects"},Ol={class:"shift-details"},Tl={class:"detail-row"},Yl={class:"detail-value"},Fl={class:"detail-row"},Rl={class:"detail-value"},Pl={key:0,class:"detail-row"},Bl={class:"detail-value"},Wl={key:3,class:"missing-label"},Jl={key:2,class:"empty-cell"},Kl={key:1,class:"modern-schedule-cell collapsed-cell"},ql={key:0,class:"approval-card"},Gl={class:"approval-header"},Hl={class:"approval-count"},Ql={class:"applicant-name"},Xl={class:"form-type"},Zl={key:0},ea={class:"mb-2"},ta={class:"mb-2"},la={class:"mb-2"},aa={class:"mb-1"},na={class:"mr-2"},sa="schedule-include-self",oa={__name:"Schedule",setup(Xe){const he=t=>t?new Date(t).toLocaleString():"-",Fe=t=>Array.isArray(t)?t.join(", "):t??"-",Ze={leave:"請假",attendance:"出勤",overtime:"加班",shift:"排班",reimbursement:"報銷",expense:"費用",travel:"出差",recruitment:"招募",onboarding:"入職",general:"一般"},et=(t,e="")=>{if(t==null)return e||"未知類型";const l=String(t).trim();return l?Ze[l.toLowerCase()]||l:e||"未知類型"},L=g(R().format("YYYY-MM")),v=g({}),ne=g([]),T=g([]),$e=g([]),B=g([]),q=g([]),C=g(""),j=g(""),z=g(""),G=g(""),V=g(""),_e=g(""),se=g([]),be=g(null),W=g(!1);let tt=!0;const lt=g({direct:0,unscheduled:0,onLeave:0}),Ae=g(""),je=g("all"),xe=g(new Set),oe=g(new Set),Z=g(new Set),de=g(new Set),Re=g([]),ge=g(""),re=g(""),ee=g(""),Me=g(!1),E=kt({visible:!1,doc:null}),Pe=kt({});function ce(){var l,a;if(typeof window>"u")return"";const t=(l=window.sessionStorage)==null?void 0:l.getItem("employeeId");if(t&&t!=="undefined")return t;const e=(a=window.localStorage)==null?void 0:a.getItem("employeeId");return e&&e!=="undefined"?e:""}function at(t){return t?`${sa}:${String(t)}`:""}function nt(t=ce()){var a;if(typeof window>"u")return null;const e=at(t);if(!e)return null;const l=(a=window.localStorage)==null?void 0:a.getItem(e);return l==="true"?!0:l==="false"?!1:null}function Ue(t,e=ce()){var a;if(typeof window>"u")return;const l=at(e);if(l)try{(a=window.localStorage)==null||a.setItem(l,t?"true":"false")}catch(s){console.warn("Failed to persist includeSelf preference",s)}}const Vt=O(()=>oe.value),Et=O(()=>Z.value),$t=O(()=>de.value),st=O(()=>{if(!Array.isArray(ne.value)||!ne.value.length)return[];const t=new Set;return ne.value.reduce((e,l)=>{if(!l)return e;const a=Oe(l)||l.name||l.code||"未命名班別",s=String(l._id||`${l.code??""}-${l.name??""}`);return!s||t.has(s)||(t.add(s),e.push({key:s,label:a,style:Ge(l)})),e},[])}),ve=(t,e)=>`${t}-${e}`,Be=t=>{const[e,l]=String(t).split("-");return{empId:e,day:Number(l)}},Le=(t,e)=>{const l=v.value[t];if(!l)return!1;const a=l[e];return a?!a.leave:!1},We=O(()=>{const t=new Set,e=te.value,l=T.value,a=(s,o)=>{Le(s,o)&&t.add(ve(s,o))};return de.value.forEach(s=>{const{empId:o,day:c}=Be(s);a(o,c)}),oe.value.forEach(s=>{e.forEach(o=>a(s,o.date))}),Z.value.forEach(s=>{l.forEach(o=>a(o._id,s))}),t}),Je=O(()=>We.value.size>0),ot=O(()=>re.value?yt(re.value):[]),At=(t,e)=>We.value.has(ve(t,e)),ze=()=>{const t=new Set(T.value.map(a=>a._id)),e=new Set(te.value.map(a=>a.date));oe.value=new Set(Array.from(oe.value).filter(a=>t.has(a))),Z.value=new Set(Array.from(Z.value).filter(a=>e.has(a)));const l=new Set;de.value.forEach(a=>{const{empId:s,day:o}=Be(a);t.has(s)&&e.has(o)&&Le(s,o)&&l.add(ve(s,o))}),de.value=l},jt=()=>{oe.value=new Set,Z.value=new Set,de.value=new Set,Re.value=[]},xt=(t,e)=>{const l=new Set(oe.value);(typeof e=="boolean"?e:!l.has(t))?l.add(t):l.delete(t),oe.value=l},Mt=(t,e)=>{const l=new Set(Z.value);(typeof e=="boolean"?e:!l.has(t))?l.add(t):l.delete(t),Z.value=l},Ut=(t,e,l)=>{if(!Le(t,e))return;const a=ve(t,e),s=new Set(de.value);(typeof l=="boolean"?l:!s.has(a))?s.add(a):s.delete(a),de.value=s},Lt=()=>{oe.value=new Set(T.value.map(t=>t._id))},zt=()=>{Z.value=new Set(te.value.map(t=>t.date))},rt=t=>[...t].sort((e,l)=>{const a=(e.department||"").localeCompare(l.department||"");return a!==0?a:(e.name||"").localeCompare(l.name||"")}),Nt=t=>{if(!Array.isArray(t)||t.length!==2)return;const[e,l]=t;if(!e||!l)return;const a=R(`${L.value}-01`),s=R(e),o=R(l);if(!s.isValid()||!o.isValid())return;const c=a.endOf("month");let u=s.isBefore(a)?a:s;const r=[];for(;(u.isBefore(o)||u.isSame(o,"day"))&&(u.year()===a.year()&&u.month()===a.month()&&r.push(u.date()),!u.isSame(c,"day"));)u=u.add(1,"day");Z.value=new Set(r)};ye(re,(t,e)=>{t!==e&&(ee.value="")}),ye(ot,t=>{ee.value&&!t.some(e=>e._id===ee.value)&&(ee.value="")}),ye(W,async(t,e)=>{if(t===e)return;const l=pe()||ce();Ue(t,l),!tt&&ie.value&&(await ke(C.value,j.value),await we(),await He())});const Ke=t=>{const e=v.value[t]||{},l=Object.values(e),a=l.some(o=>o.shiftId),s=l.some(o=>o.leave);return a?s?"onLeave":"scheduled":"unscheduled"},Ot=O(()=>{let t=Ae.value?T.value.filter(e=>e.name.includes(Ae.value)):T.value;return je.value!=="all"&&(t=t.filter(e=>Ke(e._id)===je.value)),t}),it=O(()=>T.value.length>50),Tt=t=>{xe.value.has(t)?xe.value.delete(t):xe.value.add(t)},Yt=O(()=>q.value.filter(t=>t.department===C.value)),Ft=al(),me=rl();me.loadUser();const ut=O(()=>["supervisor","admin"].includes(me.role)),ie=O(()=>me.role==="supervisor"),Se=ut;ye(ie,t=>{const e=pe()||ce();if(!t){W.value&&(W.value=!1),Ue(!1,e);return}const l=nt(e);l===!0?W.value=!0:l===!1&&e&&Ue(!1,e)});const dt=t=>{var a,s;const e=(a=X)==null?void 0:a.warning;typeof e=="function"&&e(t);const l=typeof window<"u"?(s=window.ElMessage)==null?void 0:s.warning:void 0;typeof l=="function"&&l!==e&&l(t)},qe=t=>{var a,s;const e=(a=X)==null?void 0:a.info;typeof e=="function"&&e(t);const l=typeof window<"u"?(s=window.ElMessage)==null?void 0:s.info:void 0;typeof l=="function"&&l!==e&&l(t)},Rt=t=>{var a,s;const e=(a=X)==null?void 0:a.success;typeof e=="function"&&e(t);const l=typeof window<"u"?(s=window.ElMessage)==null?void 0:s.success:void 0;typeof l=="function"&&l!==e&&l(t)},ct=t=>({pending:"待簽核",approved:"已核可",rejected:"已否決",returned:"已退簽"})[t]||t||"-",Pt=t=>{if(t&&typeof t=="object"){const e=t._id||t.employeeId||"";return t.name||Pe[e]||e}return Pe[t]||t||"-"},Bt=(t,e)=>{var a,s;const l=(s=(a=v.value)==null?void 0:a[t])==null?void 0:s[e];return l!=null&&l.leave?"已核准請假，該日不列入工作時數":""},te=O(()=>{const t=R(L.value+"-01"),e=t.endOf("month").date(),l=["日","一","二","三","四","五","六"];return Array.from({length:e},(a,s)=>{const o=s+1,c=l[t.date(o).day()];return{date:o,label:`${o}(${c})`}})});ye(T,ze),ye(te,ze);async function Wt(){const t=await N("/api/shifts");if(t.ok){const e=await t.json(),l=Array.isArray(e==null?void 0:e.shifts)?e.shifts:Array.isArray(e)?e:[];Array.isArray(l)&&(ne.value=l.map(a=>({_id:a._id,code:a.code,name:a.name??"",startTime:a.startTime,endTime:a.endTime,remark:a.remark})))}else t.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",t.status)}async function vt(t=""){try{const e=t||z.value,l=e?`/api/sub-departments?department=${e}`:"/api/sub-departments",a=await N(l);if(!a.ok)throw new Error("Failed to fetch sub departments");const s=await a.json(),o=B.value.reduce((r,i)=>{const k=String(i._id);return r[k]=k,i.name&&(r[i.name]=k),r},{});z.value&&(o[z.value]=z.value),G.value&&(o[G.value]=z.value||G.value);const c=Array.isArray(s)?s.map(r=>{const i=r==null?void 0:r.department;let k="";return i&&typeof i=="object"?k=(i==null?void 0:i._id)||(i==null?void 0:i.id)||o[i==null?void 0:i.name]||"":k=o[i]||i||"",{...r,_id:String((r==null?void 0:r._id)??(r==null?void 0:r.id)??""),department:String(k)}}).filter(r=>r._id):[];let u=c;if(e&&(u=c.filter(r=>r.department===String(e)),!u.length&&V.value)){const r=c.find(i=>i._id===V.value);r?u=[r]:u=[{_id:V.value,name:_e.value||"",department:String(e)}]}if(me.role==="supervisor"){const r=se.value.length?se.value:V.value?[V.value]:[],i=new Set(r.map(k=>String(k)));i.size?u=u.filter(k=>i.has(String(k._id))):u=[]}q.value=u,q.value.length?V.value&&q.value.some(r=>r._id===V.value)?j.value=V.value:j.value&&q.value.some(r=>r._id===j.value)||(j.value=q.value[0]._id):j.value=""}catch(e){console.error(e),q.value=[],j.value=""}}async function Jt(){var t;try{const e=await N("/api/departments"),l=e.ok?await e.json():[],a=Array.isArray(l)?l.map(u=>{const r=(u==null?void 0:u._id)??(u==null?void 0:u.id)??(u==null?void 0:u.value)??"";return{...u,_id:String(r),name:(u==null?void 0:u.name)??""}}).filter(u=>u._id):[],s=C.value||z.value;let o=a;s&&(o=a.filter(u=>u._id===s||G.value&&u.name===G.value),!o.length&&s&&(o=[{_id:s,name:G.value||((t=a.find(u=>u._id===s))==null?void 0:t.name)||""}])),B.value=o.length?o:a,B.value.length?B.value.some(u=>u._id===C.value)||(C.value=B.value[0]._id):!C.value&&s&&(C.value=s);const c=C.value||z.value||(B.value.length?B.value[0]._id:"");await vt(c)}catch(e){console.error(e)}}function pe(){return ut.value?ce():""}async function Kt(){if(me.role!=="supervisor"){z.value="",G.value="",V.value="",_e.value="",se.value=[],be.value=null;return}const t=pe();if(!t){z.value="",G.value="",V.value="",_e.value="",se.value=[],be.value=null;return}let e=null;try{const r=await N(`/api/employees/${t}`);if(!r.ok)throw new Error("Failed to fetch supervisor context");e=await r.json()}catch(r){console.error(r),be.value=null}be.value=e||null;const l=e==null?void 0:e.department;let a="",s="";if(l&&typeof l=="object")a=(l==null?void 0:l._id)||(l==null?void 0:l.id)||(l==null?void 0:l.value)||"",s=(l==null?void 0:l.name)||(e==null?void 0:e.departmentName)||"";else if(typeof l=="string"){const r=B.value.find(i=>String(i==null?void 0:i._id)===l||String((i==null?void 0:i.id)??"")===l||(i==null?void 0:i.code)===l||(i==null?void 0:i.name)===l);a=(r==null?void 0:r._id)||(r==null?void 0:r.id)||l,s=(r==null?void 0:r.name)||(e==null?void 0:e.departmentName)||l}z.value=a?String(a):"",G.value=s?String(s):"",z.value?C.value=z.value:C.value="";const o=e==null?void 0:e.subDepartment;let c="",u="";if(o&&typeof o=="object")c=(o==null?void 0:o._id)||(o==null?void 0:o.id)||(o==null?void 0:o.value)||"",u=(o==null?void 0:o.name)||(e==null?void 0:e.subDepartmentName)||"";else if(typeof o=="string"){const r=q.value.find(i=>String(i==null?void 0:i._id)===o||String((i==null?void 0:i.id)??"")===o||(i==null?void 0:i.code)===o||(i==null?void 0:i.name)===o);c=(r==null?void 0:r._id)||(r==null?void 0:r.id)||o,u=(r==null?void 0:r.name)||(e==null?void 0:e.subDepartmentName)||o}V.value=c?String(c):"",_e.value=u?String(u):"",V.value?j.value=V.value:j.value="",await qt(t)}async function qt(t=""){if(me.role!=="supervisor"){se.value=[];return}const e=t||pe();if(!e){se.value=V.value?[String(V.value)]:[];return}try{const l=await N(`/api/employees?supervisor=${e}`);if(!l.ok)throw new Error("Failed to fetch direct reports");const a=await l.json(),s=Array.isArray(a)?a:[],o=new Set,c=[],u=r=>{if(!r&&r!==0)return;const i=String(r);i&&(o.has(i)||(o.add(i),c.push(i)))};s.forEach(r=>{const i=r==null?void 0:r.subDepartment;u(i&&typeof i=="object"?(i==null?void 0:i._id)||(i==null?void 0:i.id)||(i==null?void 0:i.value):i)}),u(V.value),se.value=c}catch(l){console.error(l),se.value=V.value?[String(V.value)]:[]}}async function we(){const t=pe(),e=[`month=${L.value}`];t&&e.push(`supervisor=${t}`),W.value&&ie.value&&e.push("includeSelf=true");const l=`?${e.join("&")}`;try{const a=await N(`/api/schedules/monthly${l}`);if(!a.ok)throw new Error("Failed to fetch schedules");const s=await a.json(),o=Array.isArray(s)?s:[],c=te.value;v.value={},!T.value.length&&o.length&&await ke(C.value,j.value),T.value.forEach(_=>{const h=String(_._id);v.value[h]={},c.forEach(S=>{v.value[h][S.date]={shiftId:"",department:_.departmentId,subDepartment:_.subDepartmentId}})}),o.forEach(_=>{var M;const h=((M=_.employee)==null?void 0:M._id)||_.employee;if(!h)return;const S=String(h);v.value[S]||(v.value[S]={},c.forEach(n=>{v.value[S][n.date]={shiftId:"",department:"",subDepartment:""}}));const H=R(_.date).date(),Q=T.value.find(n=>String(n._id)===S)||{};v.value[S][H]={id:_._id,shiftId:_.shiftId,department:_.department||Q.departmentId,subDepartment:_.subDepartment||Q.subDepartmentId}});const u=e.slice(),r=C.value,i=j.value;r&&u.push(`department=${r}`),i&&u.push(`subDepartment=${i}`);const k=`?${u.join("&")}`,le=await N(`/api/schedules/leave-approvals${k}`);if(le.ok){const _=await le.json(),h=Array.isArray(_==null?void 0:_.approvals)?_.approvals:[],S=Array.isArray(_==null?void 0:_.leaves)?_.leaves:[];$e.value=h;const H=R(`${L.value}-01`).startOf("day"),Q=H.endOf("month").startOf("day");S.forEach(M=>{var De,Ie,Ce;if(M.status!=="approved")return;const n=((De=M.employee)==null?void 0:De._id)||M.employee;if(!n)return;const p=String(n),J=R(M.startDate).startOf("day"),Y=R(M.endDate).startOf("day");if(!J.isValid()||!Y.isValid())return;let U=J.isBefore(H)?H:J;const F=Y.isAfter(Q)?Q:Y;for(;!U.isAfter(F);){const Te=U.date(),Ve=(Ce=(Ie=v.value)==null?void 0:Ie[p])==null?void 0:Ce[Te];Ve&&(Ve.leave={type:M.leaveType,startDate:M.startDate,endDate:M.endDate,excludesHours:!0}),U=U.add(1,"day")}})}const ae=pe()||ce();W.value&&ie.value&&ae&&!o.some(_=>{var S;const h=((S=_==null?void 0:_.employee)==null?void 0:S._id)||(_==null?void 0:_.employee);return h&&String(h)===ae})&&(W.value=!1,Ue(!1,ae)),ze()}catch(a){console.error(a),X.error("取得排班資料失敗")}}async function Gt(t){var s;if(!t)return;E.visible=!1,E.doc=null;const e=await N(`/api/approvals/${t}`);if(!e.ok)return;const l=await e.json();E.doc=l,E.visible=!0,(Array.isArray((s=E.doc)==null?void 0:s.steps)?E.doc.steps:[]).forEach(o=>{(Array.isArray(o==null?void 0:o.approvers)?o.approvers:[]).forEach(u=>{var r,i;(r=u==null?void 0:u.approver)!=null&&r._id&&((i=u==null?void 0:u.approver)!=null&&i.name)&&(Pe[u.approver._id]=u.approver.name)})})}function pt(t){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:v.value,employees:T.value,days:te.value,shifts:ne.value})),Ft.push({name:t==="week"?"PreviewWeek":"PreviewMonth"})}async function ft(t){try{const e=await N(`/api/schedules/export?month=${L.value}&format=${t}`);if(!e.ok)throw new Error;const l=await e.blob(),a=URL.createObjectURL(l),s=document.createElement("a");s.href=a,s.download=`schedules-${L.value}.${t==="excel"?"xlsx":"pdf"}`,s.click(),URL.revokeObjectURL(a)}catch{X.error("匯出失敗")}}async function Ht(t,e,l){const a=`${L.value}-${String(e).padStart(2,"0")}`,s=v.value[t][e];if(s!=null&&s.leave){qe("該日已核准請假，無法調整排班");return}const o=(s==null?void 0:s.shiftId)??"";if(s&&s.id)try{const c=await N(`/api/schedules/${s.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:l,department:s.department,subDepartment:s.subDepartment})});c.ok||await Ne(c,"更新排班失敗",t,e,o)}catch{await Ne(null,"更新排班失敗",t,e,o)}else try{const c=await N("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:t,date:a,shiftId:l,department:s.department,subDepartment:s.subDepartment})});if(c.ok){const u=await c.json();v.value[t][e]={id:u._id,shiftId:u.shiftId,department:s.department,subDepartment:s.subDepartment}}else await Ne(c,"新增排班失敗",t,e,o)}catch{await Ne(null,"新增排班失敗",t,e,o)}}async function Qt(){j.value="",await vt(C.value),await ke(C.value,""),await we()}async function Xt(){await ke(C.value,j.value),await we()}async function Ne(t,e,l,a,s){v.value[l]||(v.value[l]={});const o=v.value[l][a]||{shiftId:"",department:"",subDepartment:""};o.shiftId=s,v.value[l][a]=o;let c="";try{if(t){const u=await t.json();c=(u==null?void 0:u.error)||""}}catch{}c==="employee conflict"?Ee.alert("人員衝突"):c==="department overlap"?Ee.alert("跨區重複"):c==="leave conflict"?Ee.alert("請假衝突"):X.error(e)}async function mt(t,e="批次套用失敗"){let l="";try{if(t){const a=await t.json();l=(a==null?void 0:a.error)||""}}catch{}l==="employee conflict"?X.warning("部分員工既有排班已更新，請重新整理檢查"):l==="department overlap"?Ee.alert("部門或單位與既有資料不一致，無法套用"):l==="leave conflict"?Ee.alert("選取日期包含已核准請假，無法套用"):l?X.error(l):X.error(e)}async function Zt(){if(!Je.value){dt("請先選取要套用的儲存格");return}if(!ge.value){dt("請選擇欲套用的班別");return}const t=[];if(We.value.forEach(a=>{var i;const{empId:s,day:o}=Be(a),c=(i=v.value[s])==null?void 0:i[o];if(!c||c.leave)return;const u=re.value||c.department||"";let r=c.subDepartment||"";re.value?r=ee.value||"":ee.value&&(r=ee.value),t.push({employee:s,day:o,date:`${L.value}-${String(o).padStart(2,"0")}`,shiftId:ge.value,department:u,subDepartment:r})}),!t.length){qe("選取的儲存格皆無需更新");return}const e=new Map;t.forEach(a=>{e.set(ve(a.employee,a.day),a)}),Me.value=!0;const l=ol.service({fullscreen:!0,lock:!0,text:"批次套用中..."});try{let a;try{a=await N("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:t.map(({day:o,...c})=>c)})})}catch{await mt(null);return}if(!a.ok){await mt(a);return}const s=await a.json();if(!Array.isArray(s)||!s.length){qe("沒有可更新的資料");return}s.forEach(o=>{var le;const c=((le=o.employee)==null?void 0:le._id)||o.employee,u=R(o.date).date();v.value[c]||(v.value[c]={});const r=ve(c,u),i=e.get(r)||{},k=v.value[c][u]||{};v.value[c][u]={...k,id:o._id||i.id||k.id,shiftId:o.shiftId||i.shiftId||k.shiftId,department:i.department??o.department??k.department??"",subDepartment:i.subDepartment??o.subDepartment??k.subDepartment??""},delete v.value[c][u].leave}),Rt("批次套用完成")}finally{l==null||l.close(),Me.value=!1}}function ue(t){return ne.value.find(e=>e._id===t)}function Oe(t){if(!t)return"";const e=t.code??"",l=t.name??"";return!e&&!l?"":l?`${e}(${l})`:e}function Ge(t){const e=t&&typeof t=="object"?t:ue(t);return e?il(e):{}}function yt(t){return q.value.filter(e=>e.department===t)}async function ke(t="",e=""){var u;const l=pe(),a=[],s=t||C.value||z.value,o=e||j.value;l&&a.push(`supervisor=${l}`),s&&a.push(`department=${s}`),o&&a.push(`subDepartment=${o}`);const c=`/api/employees${a.length?`?${a.join("&")}`:""}`;try{const r=await N(c);if(!r.ok)throw new Error("Failed to fetch employees");const i=await r.json(),k=B.value.reduce((h,S)=>(h[S._id]=S.name,h),{}),le=q.value.reduce((h,S)=>(h[S._id]=S.name,h),{}),ae=i.map(h=>{const S=(h==null?void 0:h._id)??(h==null?void 0:h.id)??"",H=(h==null?void 0:h.department)??"",Q=(h==null?void 0:h.subDepartment)??"",M=S?String(S):"",n=H?String(H):"",p=Q?String(Q):"";return{_id:M,name:h.name,departmentId:n,subDepartmentId:p,department:k[n]||"",subDepartment:le[p]||""}});let _=rt(ae);if(W.value&&ie.value){const h=l?String(l):"";h&&!_.some(S=>S._id===h)&&(_=rt([..._,{_id:h,name:((u=be.value)==null?void 0:u.name)||"主管本人",departmentId:z.value||"",subDepartmentId:V.value||"",department:G.value||"",subDepartment:_e.value||""}]))}T.value=_,ze()}catch(r){console.error(r),X.error("取得員工資料失敗")}}async function He(){try{const t=[`month=${L.value}`];W.value&&ie.value&&t.push("includeSelf=true");const e=await N(`/api/schedules/summary?${t.join("&")}`);if(e.ok){const l=await e.json();lt.value={direct:l.length,unscheduled:l.filter(a=>a.shiftCount===0).length,onLeave:l.filter(a=>a.leaveCount>0).length}}}catch(t){console.error(t)}}async function el(t){const e=t?R(t):R();L.value=e.isValid()?e.format("YYYY-MM"):R().format("YYYY-MM"),await we(),await He()}return ll(async()=>{const t=ce();nt(t)===!0&&ie.value&&(W.value=!0);try{await He(),await Wt(),await Kt(),await Jt(),await ke(C.value,j.value),await we()}finally{tt=!1}}),(t,e)=>{const l=$("el-date-picker"),a=$("el-option"),s=$("el-select"),o=$("el-switch"),c=$("el-button"),u=$("el-input"),r=$("el-table-column"),i=$("el-checkbox"),k=$("el-tag"),le=$("el-popover"),ae=$("el-table"),_=$("el-divider"),h=$("el-descriptions-item"),S=$("el-descriptions"),H=$("el-timeline-item"),Q=$("el-timeline"),M=$("el-dialog");return f(),b(x,null,[d("div",fl,[e[41]||(e[41]=d("div",{class:"page-header"},[d("h1",{class:"page-title"},"排班管理"),d("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),m(pl,{summary:lt.value},null,8,["summary"]),d("div",ml,[e[22]||(e[22]=d("div",{class:"filters-header"},[d("h3",{class:"filters-title"},"篩選條件")],-1)),d("div",yl,[d("div",hl,[e[18]||(e[18]=d("label",{class:"filter-label"},"選擇月份",-1)),m(l,{modelValue:L.value,"onUpdate:modelValue":e[0]||(e[0]=n=>L.value=n),type:"month","value-format":"YYYY-MM",onChange:el,class:"modern-date-picker"},null,8,["modelValue"])]),d("div",_l,[e[19]||(e[19]=d("label",{class:"filter-label"},"部門",-1)),m(s,{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=n=>C.value=n),placeholder:"請選擇部門",onChange:Qt,disabled:!0,class:"modern-select"},{default:y(()=>[(f(!0),b(x,null,P(B.value,n=>(f(),A(a,{key:n._id,label:n.name,value:n._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),d("div",bl,[e[20]||(e[20]=d("label",{class:"filter-label"},"單位",-1)),m(s,{modelValue:j.value,"onUpdate:modelValue":e[2]||(e[2]=n=>j.value=n),placeholder:"請選擇單位",onChange:Xt,class:"modern-select"},{default:y(()=>[(f(!0),b(x,null,P(Yt.value,n=>(f(),A(a,{key:n._id,label:n.name,value:n._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),ie.value?(f(),b("div",gl,[e[21]||(e[21]=d("label",{class:"filter-label"},"包含自己",-1)),m(o,{modelValue:W.value,"onUpdate:modelValue":e[3]||(e[3]=n=>W.value=n),"active-text":"是","inactive-text":"否","inline-prompt":""},null,8,["modelValue"])])):K("",!0)])]),d("div",Sl,[d("div",wl,[m(c,{type:"primary",class:"action-btn primary",onClick:jt,disabled:!Je.value},{default:y(()=>e[23]||(e[23]=[d("i",{class:"el-icon-close"},null,-1),I(" 清除選取 ")])),_:1},8,["disabled"]),m(c,{type:"primary",class:"action-btn primary",plain:"",onClick:Lt,disabled:!T.value.length},{default:y(()=>e[24]||(e[24]=[d("i",{class:"el-icon-user"},null,-1),I(" 全選員工 ")])),_:1},8,["disabled"]),m(c,{type:"primary",class:"action-btn primary",plain:"",onClick:zt,disabled:!te.value.length},{default:y(()=>e[25]||(e[25]=[d("i",{class:"el-icon-date"},null,-1),I(" 全選日期 ")])),_:1},8,["disabled"])]),d("div",kl,[d("div",Dl,[e[26]||(e[26]=d("label",{class:"range-label"},"自訂日期範圍",-1)),m(l,{modelValue:Re.value,"onUpdate:modelValue":e[4]||(e[4]=n=>Re.value=n),type:"daterange","start-placeholder":"開始日期","end-placeholder":"結束日期","range-separator":"至","unlink-panels":"",disabled:!te.value.length,class:"modern-date-picker range-picker",onChange:Nt},null,8,["modelValue","disabled"])]),m(c,{onClick:e[5]||(e[5]=n=>pt("week")),class:"action-btn secondary"},{default:y(()=>e[27]||(e[27]=[d("i",{class:"el-icon-calendar"},null,-1),I(" 預覽週表 ")])),_:1}),m(c,{onClick:e[6]||(e[6]=n=>pt("month")),class:"action-btn secondary"},{default:y(()=>e[28]||(e[28]=[d("i",{class:"el-icon-date"},null,-1),I(" 預覽月表 ")])),_:1}),m(c,{onClick:e[7]||(e[7]=()=>ft("pdf")),class:"action-btn export"},{default:y(()=>e[29]||(e[29]=[d("i",{class:"el-icon-download"},null,-1),I(" 匯出 PDF ")])),_:1}),m(c,{onClick:e[8]||(e[8]=()=>ft("excel")),class:"action-btn export"},{default:y(()=>e[30]||(e[30]=[d("i",{class:"el-icon-s-grid"},null,-1),I(" 匯出 Excel ")])),_:1})])]),d("div",Il,[d("div",Cl,[e[32]||(e[32]=d("h3",{class:"schedule-title"},"員工排班表",-1)),d("div",Vl,[st.value.length?(f(!0),b(x,{key:0},P(st.value,n=>(f(),b("span",{key:n.key,class:"legend-item",style:Ye(n.style),"data-test":"shift-legend-item"},w(n.label),5))),128)):(f(),b("span",El," 尚未設定班別 ")),e[31]||(e[31]=d("span",{class:"legend-item leave"},"請假",-1))]),m(u,{modelValue:Ae.value,"onUpdate:modelValue":e[9]||(e[9]=n=>Ae.value=n),placeholder:"搜尋員工",clearable:"",class:"employee-search"},null,8,["modelValue"]),m(s,{modelValue:je.value,"onUpdate:modelValue":e[10]||(e[10]=n=>je.value=n),placeholder:"狀態",class:"status-filter"},{default:y(()=>[m(a,{label:"全部",value:"all"}),m(a,{label:"缺班",value:"unscheduled"}),m(a,{label:"待審核請假",value:"onLeave"})]),_:1},8,["modelValue"])]),fe(Se)?(f(),b("div",$l,[m(s,{modelValue:ge.value,"onUpdate:modelValue":e[11]||(e[11]=n=>ge.value=n),placeholder:"套用班別",class:"modern-select batch-select",filterable:"","data-test":"batch-shift-select"},{default:y(()=>[(f(!0),b(x,null,P(ne.value,n=>(f(),A(a,{key:n._id,label:Oe(n),value:n._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),m(s,{modelValue:re.value,"onUpdate:modelValue":e[12]||(e[12]=n=>re.value=n),placeholder:"套用部門",clearable:"",class:"modern-select batch-select","data-test":"batch-dept-select"},{default:y(()=>[(f(!0),b(x,null,P(B.value,n=>(f(),A(a,{key:n._id,label:n.name,value:n._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),m(s,{modelValue:ee.value,"onUpdate:modelValue":e[13]||(e[13]=n=>ee.value=n),placeholder:"套用單位",clearable:"",class:"modern-select batch-select",disabled:!re.value,"data-test":"batch-subdept-select"},{default:y(()=>[(f(!0),b(x,null,P(ot.value,n=>(f(),A(a,{key:n._id,label:n.name,value:n._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),m(c,{type:"primary",class:"action-btn primary apply-btn",disabled:!Je.value||!ge.value||Me.value,loading:Me.value,onClick:Zt,"data-test":"batch-apply-button"},{default:y(()=>e[33]||(e[33]=[I(" 套用至選取 ")])),_:1},8,["disabled","loading"])])):K("",!0),m(ae,{class:"modern-schedule-table",data:Ot.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"},onRowClick:e[15]||(e[15]=n=>it.value&&Tt(n._id))},{default:y(()=>[m(r,{label:"部門／單位",width:"180",fixed:"left"},{default:y(({row:n})=>[d("div",Al,[d("div",jl,w(n.department),1),n.subDepartment?(f(),b("div",xl,w(n.subDepartment),1)):K("",!0)])]),_:1}),m(r,{prop:"name",label:"員工姓名",width:"150",fixed:"left"},{default:y(({row:n})=>[d("div",Ml,[fe(Se)?(f(),A(i,{key:0,class:"row-checkbox","model-value":Vt.value.has(n._id),onChange:p=>xt(n._id,p)},null,8,["model-value","onChange"])):K("",!0),Ke(n._id)==="unscheduled"?(f(),A(Qe(fe(It)),{key:1,class:"status-icon unscheduled"})):Ke(n._id)==="onLeave"?(f(),A(Qe(fe(Ct)),{key:2,class:"status-icon on-leave"})):K("",!0),I(" "+w(n.name),1)])]),_:1}),(f(!0),b(x,null,P(te.value,n=>(f(),A(r,{key:n.date,label:n.label,width:"140",align:"center"},{header:y(()=>[d("div",Ul,[d("span",null,w(n.label),1),fe(Se)?(f(),A(i,{key:0,class:"day-checkbox","model-value":Et.value.has(n.date),onChange:p=>Mt(n.date,p)},null,8,["model-value","onChange"])):K("",!0)])]),default:y(({row:p})=>{var J,Y,U,F,De,Ie,Ce,Te,Ve,ht,_t,bt,gt,St,wt;return[!it.value||xe.value.has(p._id)?(f(),b("div",{key:0,class:nl(["modern-schedule-cell",[{"has-leave":(Y=(J=v.value[p._id])==null?void 0:J[n.date])==null?void 0:Y.leave,"missing-shift":!((F=(U=v.value[p._id])==null?void 0:U[n.date])!=null&&F.shiftId)&&!((Ie=(De=v.value[p._id])==null?void 0:De[n.date])!=null&&Ie.leave),"is-selected":At(p._id,n.date),"has-shift":!((Te=(Ce=v.value[p._id])==null?void 0:Ce[n.date])!=null&&Te.leave)&&!!((ht=(Ve=v.value[p._id])==null?void 0:Ve[n.date])!=null&&ht.shiftId)}]]),style:Ye((bt=(_t=v.value[p._id])==null?void 0:_t[n.date])!=null&&bt.leave?void 0:Ge((St=(gt=v.value[p._id])==null?void 0:gt[n.date])==null?void 0:St.shiftId)),title:Bt(p._id,n.date)},[fe(Se)?(f(),b("div",{key:0,class:"cell-selection",onClick:e[14]||(e[14]=sl(()=>{},["stop"]))},[m(i,{"model-value":$t.value.has(ve(p._id,n.date)),disabled:!Le(p._id,n.date),onChange:D=>Ut(p._id,n.date,D),size:"small"},null,8,["model-value","disabled","onChange"])])):K("",!0),(wt=v.value[p._id])!=null&&wt[n.date]?(f(),b(x,{key:1},[v.value[p._id][n.date].leave?(f(),b("div",zl,[m(k,{type:"warning",effect:"light",size:"small",class:"leave-tag"},{default:y(()=>e[34]||(e[34]=[I(" 休假中 ")])),_:1}),e[35]||(e[35]=d("span",{class:"leave-note"},"已核准請假，不列入工時",-1))])):fe(Se)?(f(),b(x,{key:1},[m(s,{modelValue:v.value[p._id][n.date].shiftId,"onUpdate:modelValue":D=>v.value[p._id][n.date].shiftId=D,placeholder:"選擇班別",onChange:D=>Ht(p._id,n.date,D),class:"cell-select shift-select",size:"small"},{default:y(()=>[(f(!0),b(x,null,P(ne.value,D=>(f(),A(a,{key:D._id,label:Oe(D),value:D._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),d("div",Nl,[m(s,{modelValue:v.value[p._id][n.date].department,"onUpdate:modelValue":D=>v.value[p._id][n.date].department=D,placeholder:"部門",size:"small",onChange:()=>v.value[p._id][n.date].subDepartment="",class:"cell-select dept-select"},{default:y(()=>[(f(!0),b(x,null,P(B.value,D=>(f(),A(a,{key:D._id,label:D.name,value:D._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),m(s,{modelValue:v.value[p._id][n.date].subDepartment,"onUpdate:modelValue":D=>v.value[p._id][n.date].subDepartment=D,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:y(()=>[(f(!0),b(x,null,P(yt(v.value[p._id][n.date].department),D=>(f(),A(a,{key:D._id,label:D.name,value:D._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(f(),b(x,{key:2},[ue(v.value[p._id][n.date].shiftId)?(f(),A(le,{key:0,placement:"top",trigger:"hover",width:200},{reference:y(()=>[d("div",{class:"modern-shift-tag",style:Ye(Ge(ue(v.value[p._id][n.date].shiftId)))},w(Oe(ue(v.value[p._id][n.date].shiftId))),5)]),default:y(()=>[d("div",Ol,[d("div",Tl,[e[36]||(e[36]=d("span",{class:"detail-label"},"上班時間：",-1)),d("span",Yl,w(ue(v.value[p._id][n.date].shiftId).startTime),1)]),d("div",Fl,[e[37]||(e[37]=d("span",{class:"detail-label"},"下班時間：",-1)),d("span",Rl,w(ue(v.value[p._id][n.date].shiftId).endTime),1)]),ue(v.value[p._id][n.date].shiftId).remark?(f(),b("div",Pl,[e[38]||(e[38]=d("span",{class:"detail-label"},"備註：",-1)),d("span",Bl,w(ue(v.value[p._id][n.date].shiftId).remark),1)])):K("",!0)])]),_:2},1024)):K("",!0)],64)),!v.value[p._id][n.date].shiftId&&!v.value[p._id][n.date].leave?(f(),b("div",Wl," 未排班 ")):K("",!0)],64)):(f(),b("span",Jl,"-"))],14,Ll)):(f(),b("div",Kl,"展開班表"))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])]),$e.value.length?(f(),b("div",ql,[d("div",Gl,[e[39]||(e[39]=d("h3",{class:"approval-title"},"待處理審批",-1)),d("div",Hl,w($e.value.length)+" 項待處理",1)]),m(ae,{class:"modern-approval-table",data:$e.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:y(()=>[m(r,{label:"申請人",width:"120"},{default:y(({row:n})=>{var p;return[d("div",Ql,w((p=n.applicant_employee)==null?void 0:p.name),1)]}),_:1}),m(r,{label:"申請類型",width:"150"},{default:y(({row:n})=>{var p,J;return[d("div",Xl,w(et((p=n.form)==null?void 0:p.category,(J=n.form)==null?void 0:J.name)),1)]}),_:1}),m(r,{prop:"status",label:"狀態",width:"100"},{default:y(({row:n})=>[m(k,{type:n.status==="approved"?"success":n.status==="rejected"?"danger":"warning",class:"status-tag"},{default:y(()=>[I(w(n.status),1)]),_:2},1032,["type"])]),_:1}),m(r,{label:"操作",width:"120"},{default:y(({row:n})=>[m(c,{size:"small",onClick:p=>Gt(n._id),disabled:!n._id},{default:y(()=>e[40]||(e[40]=[I(" 查看 ")])),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"])])):K("",!0)]),m(M,{modelValue:E.visible,"onUpdate:modelValue":e[17]||(e[17]=n=>E.visible=n),title:"申請單明細",width:"760px"},{footer:y(()=>[m(c,{onClick:e[16]||(e[16]=n=>E.visible=!1)},{default:y(()=>e[47]||(e[47]=[I("關閉")])),_:1})]),default:y(()=>{var n,p,J;return[E.doc?(f(),b("div",Zl,[d("p",ea,[e[42]||(e[42]=d("b",null,"表單：",-1)),I(w((n=E.doc.form)==null?void 0:n.name)+"（"+w((p=E.doc.form)==null?void 0:p.category)+"）",1)]),d("p",ta,[e[43]||(e[43]=d("b",null,"申請人：",-1)),I(w(((J=E.doc.applicant_employee)==null?void 0:J.name)||"-"),1)]),d("p",la,[e[44]||(e[44]=d("b",null,"狀態：",-1)),I(w(ct(E.doc.status)),1)]),m(_,{"content-position":"left"},{default:y(()=>e[45]||(e[45]=[I("填寫內容")])),_:1}),m(S,{column:1,size:"small",border:""},{default:y(()=>{var Y;return[(f(!0),b(x,null,P(((Y=E.doc.form)==null?void 0:Y.fields)||[],U=>(f(),A(h,{key:U._id,label:U.label},{default:y(()=>{var F;return[d("span",null,w(Fe((F=E.doc.form_data)==null?void 0:F[U._id])),1)]}),_:2},1032,["label"]))),128))]}),_:1}),m(_,{"content-position":"left"},{default:y(()=>e[46]||(e[46]=[I("流程")])),_:1}),m(Q,null,{default:y(()=>[(f(!0),b(x,null,P(E.doc.steps,(Y,U)=>(f(),A(H,{key:U,timestamp:`第 ${U+1} 關`,type:U===E.doc.current_step_index?"primary":"info"},{default:y(()=>[d("div",aa,[d("span",na,"需全員同意："+w(Y.all_must_approve?"是":"否"),1),d("span",null,"必簽："+w(Y.is_required?"是":"否"),1)]),m(ae,{data:Y.approvers,size:"small",border:""},{default:y(()=>[m(r,{label:"審核人",width:"200"},{default:y(({row:F})=>[I(w(Pt(F.approver)),1)]),_:1}),m(r,{label:"決議",width:"120"},{default:y(({row:F})=>[I(w(ct(F.decision)),1)]),_:1}),m(r,{label:"時間",width:"200"},{default:y(({row:F})=>[I(w(he(F.decided_at)),1)]),_:1}),m(r,{prop:"comment",label:"意見"})]),_:2},1032,["data"])]),_:2},1032,["timestamp","type"]))),128))]),_:1})])):K("",!0)]}),_:1},8,["modelValue"])],64)}}},ca=Dt(oa,[["__scopeId","data-v-03ea8a59"]]);export{ca as default};
