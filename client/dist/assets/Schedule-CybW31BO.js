import{_ as tt,v as j,D as At,G as at,H as lt,c as _,o as m,F as x,m as O,e as N,l as C,w as y,b as v,I as Oe,J as jt,t as E,r as b,K as B,k as be,j as xt,d as f,x as L,h as ne,E as P,u as Ut,g as z,n as et,f as Mt,z as ge,L as Nt}from"./index-CebWlRJQ.js";import{a as U}from"./api-CqhP5PeV.js";import{u as Lt}from"./auth-DAtzNEr4.js";const zt={class:"dashboard"},Ot={class:"metric-label"},Tt={class:"metric-value"},Rt=Object.assign({name:"ScheduleDashboard"},{__name:"ScheduleDashboard",props:{summary:{type:Object,default:()=>({direct:0,unscheduled:0,onLeave:0})}},setup(Te){const I=Te,p=j(()=>[{label:"直屬員工數",value:I.summary.direct,icon:At,color:"#0f766e"},{label:"未排班員工",value:I.summary.unscheduled,icon:at,color:"#dc2626"},{label:"請假中員工",value:I.summary.onLeave,icon:lt,color:"#f59e0b"}]);return(W,$)=>{const oe=N("el-card");return m(),_("div",zt,[(m(!0),_(x,null,O(p.value,w=>(m(),C(oe,{class:"metric-card",key:w.label},{default:y(()=>[(m(),C(Oe(w.icon),{class:"metric-icon",style:jt({color:w.color})},null,8,["style"])),v("div",Ot,E(w.label),1),v("div",Tt,E(w.value),1)]),_:2},1024))),128))])}}}),Ft=tt(Rt,[["__scopeId","data-v-ceb5c889"]]),Bt={class:"schedule-page"},Pt={class:"filters-card"},Wt={class:"filters-content"},Jt={class:"filter-group"},Kt={class:"filter-group"},Yt={class:"filter-group"},Ht={key:0,class:"filter-group include-self-group"},qt={class:"actions-card"},Gt={class:"primary-actions"},Qt={class:"secondary-actions"},Xt={class:"range-picker-wrapper"},Zt={class:"schedule-card"},ea={class:"schedule-header"},ta={class:"schedule-legend","data-test":"schedule-legend"},aa={key:1,class:"legend-empty","data-test":"shift-legend-empty"},la={key:0,class:"batch-toolbar"},sa={class:"employee-info"},na={class:"department-name"},oa={key:0,class:"sub-department"},ra={class:"employee-name"},ia={class:"day-header"},ua=["title"],da={key:0,class:"leave-indicator","data-test":"leave-indicator"},ca={class:"department-selects"},va={class:"shift-details"},pa={class:"detail-row"},ma={class:"detail-value"},fa={class:"detail-row"},ha={class:"detail-value"},ya={key:0,class:"detail-row"},_a={class:"detail-value"},ba={class:"modern-shift-tag"},ga={key:3,class:"missing-label"},Sa={key:2,class:"empty-cell"},wa={key:1,class:"modern-schedule-cell collapsed-cell"},ka={key:0,class:"approval-card"},Da={class:"approval-header"},Ca={class:"approval-count"},Ia={class:"applicant-name"},Va={class:"form-type"},Ea={__name:"Schedule",setup(Te){const I=b(B().format("YYYY-MM")),p=b({}),W=b([]),$=b([]),oe=b([]),w=b([]),T=b([]),k=b(""),D=b(""),A=b(""),R=b(""),S=b(""),ue=b(""),Q=b([]),de=b(null),re=b(!1),Re=b({direct:0,unscheduled:0,onLeave:0}),Se=b(""),we=b("all"),ke=b(new Set),X=b(new Set),J=b(new Set),te=b(new Set),je=b([]),ce=b(""),Z=b(""),K=b(""),De=b(!1),st=j(()=>X.value),nt=j(()=>J.value),ot=j(()=>te.value),Fe=j(()=>{if(!Array.isArray(W.value)||!W.value.length)return[];const a=new Set;return W.value.reduce((e,t)=>{if(!t)return e;const l=$e(t)||t.name||t.code||"未命名班別",n=String(t._id||`${t.code??""}-${t.name??""}`);return!n||a.has(n)||(a.add(n),e.push({key:n,label:l,className:Qe(t)||"shift-normal"})),e},[])}),ae=(a,e)=>`${a}-${e}`,xe=a=>{const[e,t]=String(a).split("-");return{empId:e,day:Number(t)}},Ce=(a,e)=>{const t=p.value[a];if(!t)return!1;const l=t[e];return l?!l.leave:!1},Ue=j(()=>{const a=new Set,e=Y.value,t=$.value,l=(n,r)=>{Ce(n,r)&&a.add(ae(n,r))};return te.value.forEach(n=>{const{empId:r,day:c}=xe(n);l(r,c)}),X.value.forEach(n=>{e.forEach(r=>l(n,r.date))}),J.value.forEach(n=>{t.forEach(r=>l(r._id,n))}),a}),Me=j(()=>Ue.value.size>0),Be=j(()=>Z.value?Xe(Z.value):[]),rt=(a,e)=>Ue.value.has(ae(a,e)),Ie=()=>{const a=new Set($.value.map(l=>l._id)),e=new Set(Y.value.map(l=>l.date));X.value=new Set(Array.from(X.value).filter(l=>a.has(l))),J.value=new Set(Array.from(J.value).filter(l=>e.has(l)));const t=new Set;te.value.forEach(l=>{const{empId:n,day:r}=xe(l);a.has(n)&&e.has(r)&&Ce(n,r)&&t.add(ae(n,r))}),te.value=t},it=()=>{X.value=new Set,J.value=new Set,te.value=new Set,je.value=[]},ut=(a,e)=>{const t=new Set(X.value);(typeof e=="boolean"?e:!t.has(a))?t.add(a):t.delete(a),X.value=t},dt=(a,e)=>{const t=new Set(J.value);(typeof e=="boolean"?e:!t.has(a))?t.add(a):t.delete(a),J.value=t},ct=(a,e,t)=>{if(!Ce(a,e))return;const l=ae(a,e),n=new Set(te.value);(typeof t=="boolean"?t:!n.has(l))?n.add(l):n.delete(l),te.value=n},vt=()=>{X.value=new Set($.value.map(a=>a._id))},pt=()=>{J.value=new Set(Y.value.map(a=>a.date))},Pe=a=>[...a].sort((e,t)=>{const l=(e.department||"").localeCompare(t.department||"");return l!==0?l:(e.name||"").localeCompare(t.name||"")}),mt=a=>{if(!Array.isArray(a)||a.length!==2)return;const[e,t]=a;if(!e||!t)return;const l=B(`${I.value}-01`),n=B(e),r=B(t);if(!n.isValid()||!r.isValid())return;const c=l.endOf("month");let u=n.isBefore(l)?l:n;const o=[];for(;(u.isBefore(r)||u.isSame(r,"day"))&&(u.year()===l.year()&&u.month()===l.month()&&o.push(u.date()),!u.isSame(c,"day"));)u=u.add(1,"day");J.value=new Set(o)};be(Z,(a,e)=>{a!==e&&(K.value="")}),be(Be,a=>{K.value&&!a.some(e=>e._id===K.value)&&(K.value="")}),be(re,async(a,e)=>{a!==e&&ve.value&&(await fe(k.value,D.value),await me(),await ze())});const Ne=a=>{const e=p.value[a]||{},t=Object.values(e),l=t.some(r=>r.shiftId),n=t.some(r=>r.leave);return l?n?"onLeave":"scheduled":"unscheduled"},ft=j(()=>{let a=Se.value?$.value.filter(e=>e.name.includes(Se.value)):$.value;return we.value!=="all"&&(a=a.filter(e=>Ne(e._id)===we.value)),a}),We=j(()=>$.value.length>50),ht=a=>{ke.value.has(a)?ke.value.delete(a):ke.value.add(a)},yt=j(()=>T.value.filter(a=>a.department===k.value)),_t=Ut(),ie=Lt();ie.loadUser();const Je=j(()=>["supervisor","admin"].includes(ie.role)),ve=j(()=>ie.role==="supervisor"),pe=Je,Ke=a=>{var l,n;const e=(l=P)==null?void 0:l.warning;typeof e=="function"&&e(a);const t=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.warning:void 0;typeof t=="function"&&t!==e&&t(a)},Le=a=>{var l,n;const e=(l=P)==null?void 0:l.info;typeof e=="function"&&e(a);const t=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.info:void 0;typeof t=="function"&&t!==e&&t(a)},bt=a=>{var l,n;const e=(l=P)==null?void 0:l.success;typeof e=="function"&&e(a);const t=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.success:void 0;typeof t=="function"&&t!==e&&t(a)},gt=(a,e)=>{var l,n;const t=(n=(l=p.value)==null?void 0:l[a])==null?void 0:n[e];return t!=null&&t.leave?"已核准請假，該日不列入工作時數":""},Y=j(()=>{const a=B(I.value+"-01"),e=a.endOf("month").date(),t=["日","一","二","三","四","五","六"];return Array.from({length:e},(l,n)=>{const r=n+1,c=t[a.date(r).day()];return{date:r,label:`${r}(${c})`}})});be($,Ie),be(Y,Ie);async function St(){const a=await U("/api/shifts");if(a.ok){const e=await a.json(),t=Array.isArray(e==null?void 0:e.shifts)?e.shifts:Array.isArray(e)?e:[];Array.isArray(t)&&(W.value=t.map(l=>({_id:l._id,code:l.code,name:l.name??"",startTime:l.startTime,endTime:l.endTime,remark:l.remark})))}else a.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",a.status)}async function Ye(a=""){try{const e=a||A.value,t=e?`/api/sub-departments?department=${e}`:"/api/sub-departments",l=await U(t);if(!l.ok)throw new Error("Failed to fetch sub departments");const n=await l.json(),r=w.value.reduce((o,i)=>{const h=String(i._id);return o[h]=h,i.name&&(o[i.name]=h),o},{});A.value&&(r[A.value]=A.value),R.value&&(r[R.value]=A.value||R.value);const c=Array.isArray(n)?n.map(o=>{const i=o==null?void 0:o.department;let h="";return i&&typeof i=="object"?h=(i==null?void 0:i._id)||(i==null?void 0:i.id)||r[i==null?void 0:i.name]||"":h=r[i]||i||"",{...o,_id:String((o==null?void 0:o._id)??(o==null?void 0:o.id)??""),department:String(h)}}).filter(o=>o._id):[];let u=c;if(e&&(u=c.filter(o=>o.department===String(e)),!u.length&&S.value)){const o=c.find(i=>i._id===S.value);o?u=[o]:u=[{_id:S.value,name:ue.value||"",department:String(e)}]}if(ie.role==="supervisor"){const o=Q.value.length?Q.value:S.value?[S.value]:[],i=new Set(o.map(h=>String(h)));i.size?u=u.filter(h=>i.has(String(h._id))):u=[]}T.value=u,T.value.length?S.value&&T.value.some(o=>o._id===S.value)?D.value=S.value:D.value&&T.value.some(o=>o._id===D.value)||(D.value=T.value[0]._id):D.value=""}catch(e){console.error(e),T.value=[],D.value=""}}async function wt(){var a;try{const e=await U("/api/departments"),t=e.ok?await e.json():[],l=Array.isArray(t)?t.map(u=>{const o=(u==null?void 0:u._id)??(u==null?void 0:u.id)??(u==null?void 0:u.value)??"";return{...u,_id:String(o),name:(u==null?void 0:u.name)??""}}).filter(u=>u._id):[],n=k.value||A.value;let r=l;n&&(r=l.filter(u=>u._id===n||R.value&&u.name===R.value),!r.length&&n&&(r=[{_id:n,name:R.value||((a=l.find(u=>u._id===n))==null?void 0:a.name)||""}])),w.value=r.length?r:l,w.value.length?w.value.some(u=>u._id===k.value)||(k.value=w.value[0]._id):!k.value&&n&&(k.value=n);const c=k.value||A.value||(w.value.length?w.value[0]._id:"");await Ye(c)}catch(e){console.error(e)}}const Ve=()=>{var t,l;if(!Je.value||typeof window>"u")return"";const a=(t=window.sessionStorage)==null?void 0:t.getItem("employeeId");if(a&&a!=="undefined")return a;const e=(l=window.localStorage)==null?void 0:l.getItem("employeeId");return e&&e!=="undefined"?e:""};async function kt(){if(ie.role!=="supervisor"){A.value="",R.value="",S.value="",ue.value="",Q.value=[],de.value=null;return}const a=Ve();if(!a){A.value="",R.value="",S.value="",ue.value="",Q.value=[],de.value=null;return}let e=null;try{const o=await U(`/api/employees/${a}`);if(!o.ok)throw new Error("Failed to fetch supervisor context");e=await o.json()}catch(o){console.error(o),de.value=null}de.value=e||null;const t=e==null?void 0:e.department;let l="",n="";if(t&&typeof t=="object")l=(t==null?void 0:t._id)||(t==null?void 0:t.id)||(t==null?void 0:t.value)||"",n=(t==null?void 0:t.name)||(e==null?void 0:e.departmentName)||"";else if(typeof t=="string"){const o=w.value.find(i=>String(i==null?void 0:i._id)===t||String((i==null?void 0:i.id)??"")===t||(i==null?void 0:i.code)===t||(i==null?void 0:i.name)===t);l=(o==null?void 0:o._id)||(o==null?void 0:o.id)||t,n=(o==null?void 0:o.name)||(e==null?void 0:e.departmentName)||t}A.value=l?String(l):"",R.value=n?String(n):"",A.value?k.value=A.value:k.value="";const r=e==null?void 0:e.subDepartment;let c="",u="";if(r&&typeof r=="object")c=(r==null?void 0:r._id)||(r==null?void 0:r.id)||(r==null?void 0:r.value)||"",u=(r==null?void 0:r.name)||(e==null?void 0:e.subDepartmentName)||"";else if(typeof r=="string"){const o=T.value.find(i=>String(i==null?void 0:i._id)===r||String((i==null?void 0:i.id)??"")===r||(i==null?void 0:i.code)===r||(i==null?void 0:i.name)===r);c=(o==null?void 0:o._id)||(o==null?void 0:o.id)||r,u=(o==null?void 0:o.name)||(e==null?void 0:e.subDepartmentName)||r}S.value=c?String(c):"",ue.value=u?String(u):"",S.value?D.value=S.value:D.value="",await Dt(a)}async function Dt(a=""){if(ie.role!=="supervisor"){Q.value=[];return}const e=a||Ve();if(!e){Q.value=S.value?[String(S.value)]:[];return}try{const t=await U(`/api/employees?supervisor=${e}`);if(!t.ok)throw new Error("Failed to fetch direct reports");const l=await t.json(),n=Array.isArray(l)?l:[],r=new Set,c=[],u=o=>{if(!o&&o!==0)return;const i=String(o);i&&(r.has(i)||(r.add(i),c.push(i)))};n.forEach(o=>{const i=o==null?void 0:o.subDepartment;u(i&&typeof i=="object"?(i==null?void 0:i._id)||(i==null?void 0:i.id)||(i==null?void 0:i.value):i)}),u(S.value),Q.value=c}catch(t){console.error(t),Q.value=S.value?[String(S.value)]:[]}}async function me(){const a=Ve(),e=[`month=${I.value}`];a&&e.push(`supervisor=${a}`),re.value&&ve.value&&e.push("includeSelf=true");const t=`?${e.join("&")}`;try{const l=await U(`/api/schedules/monthly${t}`);if(!l.ok)throw new Error("Failed to fetch schedules");const n=await l.json(),r=Array.isArray(n)?n:[],c=Y.value;p.value={},!$.value.length&&r.length&&await fe(k.value,D.value),$.value.forEach(o=>{const i=String(o._id);p.value[i]={},c.forEach(h=>{p.value[i][h.date]={shiftId:"",department:o.departmentId,subDepartment:o.subDepartmentId}})}),r.forEach(o=>{var s;const i=((s=o.employee)==null?void 0:s._id)||o.employee;if(!i)return;const h=String(i);p.value[h]||(p.value[h]={},c.forEach(d=>{p.value[h][d.date]={shiftId:"",department:"",subDepartment:""}}));const M=B(o.date).date(),F=$.value.find(d=>String(d._id)===h)||{};p.value[h][M]={id:o._id,shiftId:o.shiftId,department:o.department||F.departmentId,subDepartment:o.subDepartment||F.subDepartmentId}});const u=await U(`/api/schedules/leave-approvals${t}`);if(u.ok){const o=await u.json(),i=Array.isArray(o==null?void 0:o.approvals)?o.approvals:[],h=Array.isArray(o==null?void 0:o.leaves)?o.leaves:[];oe.value=i;const M=B(`${I.value}-01`).startOf("day"),F=M.endOf("month").startOf("day");h.forEach(s=>{var ee,he,ye;if(s.status!=="approved")return;const d=((ee=s.employee)==null?void 0:ee._id)||s.employee;if(!d)return;const V=String(d),H=B(s.startDate).startOf("day"),q=B(s.endDate).startOf("day");if(!H.isValid()||!q.isValid())return;let G=H.isBefore(M)?M:H;const se=q.isAfter(F)?F:q;for(;!G.isAfter(se);){const Ae=G.date(),_e=(ye=(he=p.value)==null?void 0:he[V])==null?void 0:ye[Ae];_e&&(_e.leave={type:s.leaveType,startDate:s.startDate,endDate:s.endDate,excludesHours:!0}),G=G.add(1,"day")}})}Ie()}catch(l){console.error(l),P.error("取得排班資料失敗")}}function He(a){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:p.value,employees:$.value,days:Y.value,shifts:W.value})),_t.push({name:a==="week"?"PreviewWeek":"PreviewMonth"})}async function qe(a){try{const e=await U(`/api/schedules/export?month=${I.value}&format=${a}`);if(!e.ok)throw new Error;const t=await e.blob(),l=URL.createObjectURL(t),n=document.createElement("a");n.href=l,n.download=`schedules-${I.value}.${a==="excel"?"xlsx":"pdf"}`,n.click(),URL.revokeObjectURL(l)}catch{P.error("匯出失敗")}}async function Ct(a,e,t){const l=`${I.value}-${String(e).padStart(2,"0")}`,n=p.value[a][e];if(n!=null&&n.leave){Le("該日已核准請假，無法調整排班");return}const r=(n==null?void 0:n.shiftId)??"";if(n&&n.id)try{const c=await U(`/api/schedules/${n.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:t,department:n.department,subDepartment:n.subDepartment})});c.ok||await Ee(c,"更新排班失敗",a,e,r)}catch{await Ee(null,"更新排班失敗",a,e,r)}else try{const c=await U("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:a,date:l,shiftId:t,department:n.department,subDepartment:n.subDepartment})});if(c.ok){const u=await c.json();p.value[a][e]={id:u._id,shiftId:u.shiftId,department:n.department,subDepartment:n.subDepartment}}else await Ee(c,"新增排班失敗",a,e,r)}catch{await Ee(null,"新增排班失敗",a,e,r)}}async function It(){D.value="",await Ye(k.value),await fe(k.value,""),await me()}async function Vt(){await fe(k.value,D.value),await me()}async function Ee(a,e,t,l,n){p.value[t]||(p.value[t]={});const r=p.value[t][l]||{shiftId:"",department:"",subDepartment:""};r.shiftId=n,p.value[t][l]=r;let c="";try{if(a){const u=await a.json();c=(u==null?void 0:u.error)||""}}catch{}c==="employee conflict"?ge.alert("人員衝突"):c==="department overlap"?ge.alert("跨區重複"):c==="leave conflict"?ge.alert("請假衝突"):P.error(e)}async function Ge(a,e="批次套用失敗"){let t="";try{if(a){const l=await a.json();t=(l==null?void 0:l.error)||""}}catch{}t==="employee conflict"?P.warning("部分員工既有排班已更新，請重新整理檢查"):t==="department overlap"?ge.alert("部門或單位與既有資料不一致，無法套用"):t==="leave conflict"?ge.alert("選取日期包含已核准請假，無法套用"):t?P.error(t):P.error(e)}async function Et(){if(!Me.value){Ke("請先選取要套用的儲存格");return}if(!ce.value){Ke("請選擇欲套用的班別");return}const a=[];if(Ue.value.forEach(l=>{var i;const{empId:n,day:r}=xe(l),c=(i=p.value[n])==null?void 0:i[r];if(!c||c.leave)return;const u=Z.value||c.department||"";let o=c.subDepartment||"";Z.value?o=K.value||"":K.value&&(o=K.value),a.push({employee:n,day:r,date:`${I.value}-${String(r).padStart(2,"0")}`,shiftId:ce.value,department:u,subDepartment:o})}),!a.length){Le("選取的儲存格皆無需更新");return}const e=new Map;a.forEach(l=>{e.set(ae(l.employee,l.day),l)}),De.value=!0;const t=Nt.service({fullscreen:!0,lock:!0,text:"批次套用中..."});try{let l;try{l=await U("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:a.map(({day:r,...c})=>c)})})}catch{await Ge(null);return}if(!l.ok){await Ge(l);return}const n=await l.json();if(!Array.isArray(n)||!n.length){Le("沒有可更新的資料");return}n.forEach(r=>{var M;const c=((M=r.employee)==null?void 0:M._id)||r.employee,u=B(r.date).date();p.value[c]||(p.value[c]={});const o=ae(c,u),i=e.get(o)||{},h=p.value[c][u]||{};p.value[c][u]={...h,id:r._id||i.id||h.id,shiftId:r.shiftId||i.shiftId||h.shiftId,department:i.department??r.department??h.department??"",subDepartment:i.subDepartment??r.subDepartment??h.subDepartment??""},delete p.value[c][u].leave}),bt("批次套用完成")}finally{t==null||t.close(),De.value=!1}}function le(a){return W.value.find(e=>e._id===a)}function $e(a){if(!a)return"";const e=a.code??"",t=a.name??"";return!e&&!t?"":t?`${e}(${t})`:e}function Qe(a){const e=a&&typeof a=="object"?a:le(a);if(!e)return"";const t=`${e.code??""}${e.name??""}`;return/早/.test(t)?"shift-morning":/晚|夜/.test(t)?"shift-evening":"shift-normal"}function Xe(a){return T.value.filter(e=>e.department===a)}async function fe(a="",e=""){var u;const t=Ve(),l=[],n=a||k.value||A.value,r=e||D.value;t&&l.push(`supervisor=${t}`),n&&l.push(`department=${n}`),r&&l.push(`subDepartment=${r}`);const c=`/api/employees${l.length?`?${l.join("&")}`:""}`;try{const o=await U(c);if(!o.ok)throw new Error("Failed to fetch employees");const i=await o.json(),h=w.value.reduce((d,V)=>(d[V._id]=V.name,d),{}),M=T.value.reduce((d,V)=>(d[V._id]=V.name,d),{}),F=i.map(d=>{const V=(d==null?void 0:d._id)??(d==null?void 0:d.id)??"",H=(d==null?void 0:d.department)??"",q=(d==null?void 0:d.subDepartment)??"",G=V?String(V):"",se=H?String(H):"",ee=q?String(q):"";return{_id:G,name:d.name,departmentId:se,subDepartmentId:ee,department:h[se]||"",subDepartment:M[ee]||""}});let s=Pe(F);if(re.value&&ve.value){const d=t?String(t):"";d&&!s.some(V=>V._id===d)&&(s=Pe([...s,{_id:d,name:((u=de.value)==null?void 0:u.name)||"主管本人",departmentId:A.value||"",subDepartmentId:S.value||"",department:R.value||"",subDepartment:ue.value||""}]))}$.value=s,Ie()}catch(o){console.error(o),P.error("取得員工資料失敗")}}async function ze(){try{const a=[`month=${I.value}`];re.value&&ve.value&&a.push("includeSelf=true");const e=await U(`/api/schedules/summary?${a.join("&")}`);if(e.ok){const t=await e.json();Re.value={direct:t.length,unscheduled:t.filter(l=>l.shiftCount===0).length,onLeave:t.filter(l=>l.leaveCount>0).length}}}catch(a){console.error(a)}}async function $t(){await me(),await ze()}return xt(async()=>{await ze(),await St(),await kt(),await wt(),await fe(k.value,D.value),await me()}),(a,e)=>{const t=N("el-date-picker"),l=N("el-option"),n=N("el-select"),r=N("el-switch"),c=N("el-button"),u=N("el-input"),o=N("el-table-column"),i=N("el-checkbox"),h=N("el-tag"),M=N("el-popover"),F=N("el-table");return m(),_("div",Bt,[e[38]||(e[38]=v("div",{class:"page-header"},[v("h1",{class:"page-title"},"排班管理"),v("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),f(Ft,{summary:Re.value},null,8,["summary"]),v("div",Pt,[e[20]||(e[20]=v("div",{class:"filters-header"},[v("h3",{class:"filters-title"},"篩選條件")],-1)),v("div",Wt,[v("div",Jt,[e[16]||(e[16]=v("label",{class:"filter-label"},"選擇月份",-1)),f(t,{modelValue:I.value,"onUpdate:modelValue":e[0]||(e[0]=s=>I.value=s),type:"month",onChange:$t,class:"modern-date-picker"},null,8,["modelValue"])]),v("div",Kt,[e[17]||(e[17]=v("label",{class:"filter-label"},"部門",-1)),f(n,{modelValue:k.value,"onUpdate:modelValue":e[1]||(e[1]=s=>k.value=s),placeholder:"請選擇部門",onChange:It,disabled:!0,class:"modern-select"},{default:y(()=>[(m(!0),_(x,null,O(w.value,s=>(m(),C(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),v("div",Yt,[e[18]||(e[18]=v("label",{class:"filter-label"},"單位",-1)),f(n,{modelValue:D.value,"onUpdate:modelValue":e[2]||(e[2]=s=>D.value=s),placeholder:"請選擇單位",onChange:Vt,class:"modern-select"},{default:y(()=>[(m(!0),_(x,null,O(yt.value,s=>(m(),C(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),ve.value?(m(),_("div",Ht,[e[19]||(e[19]=v("label",{class:"filter-label"},"包含自己",-1)),f(r,{modelValue:re.value,"onUpdate:modelValue":e[3]||(e[3]=s=>re.value=s),"active-text":"是","inactive-text":"否","inline-prompt":""},null,8,["modelValue"])])):L("",!0)])]),v("div",qt,[v("div",Gt,[f(c,{type:"primary",class:"action-btn primary",onClick:it,disabled:!Me.value},{default:y(()=>e[21]||(e[21]=[v("i",{class:"el-icon-close"},null,-1),z(" 清除選取 ")])),_:1},8,["disabled"]),f(c,{type:"primary",class:"action-btn primary",plain:"",onClick:vt,disabled:!$.value.length},{default:y(()=>e[22]||(e[22]=[v("i",{class:"el-icon-user"},null,-1),z(" 全選員工 ")])),_:1},8,["disabled"]),f(c,{type:"primary",class:"action-btn primary",plain:"",onClick:pt,disabled:!Y.value.length},{default:y(()=>e[23]||(e[23]=[v("i",{class:"el-icon-date"},null,-1),z(" 全選日期 ")])),_:1},8,["disabled"])]),v("div",Qt,[v("div",Xt,[e[24]||(e[24]=v("label",{class:"range-label"},"自訂日期範圍",-1)),f(t,{modelValue:je.value,"onUpdate:modelValue":e[4]||(e[4]=s=>je.value=s),type:"daterange","start-placeholder":"開始日期","end-placeholder":"結束日期","range-separator":"至","unlink-panels":"",disabled:!Y.value.length,class:"modern-date-picker range-picker",onChange:mt},null,8,["modelValue","disabled"])]),f(c,{onClick:e[5]||(e[5]=s=>He("week")),class:"action-btn secondary"},{default:y(()=>e[25]||(e[25]=[v("i",{class:"el-icon-calendar"},null,-1),z(" 預覽週表 ")])),_:1}),f(c,{onClick:e[6]||(e[6]=s=>He("month")),class:"action-btn secondary"},{default:y(()=>e[26]||(e[26]=[v("i",{class:"el-icon-date"},null,-1),z(" 預覽月表 ")])),_:1}),f(c,{onClick:e[7]||(e[7]=()=>qe("pdf")),class:"action-btn export"},{default:y(()=>e[27]||(e[27]=[v("i",{class:"el-icon-download"},null,-1),z(" 匯出 PDF ")])),_:1}),f(c,{onClick:e[8]||(e[8]=()=>qe("excel")),class:"action-btn export"},{default:y(()=>e[28]||(e[28]=[v("i",{class:"el-icon-s-grid"},null,-1),z(" 匯出 Excel ")])),_:1})])]),v("div",Zt,[v("div",ea,[e[30]||(e[30]=v("h3",{class:"schedule-title"},"員工排班表",-1)),v("div",ta,[Fe.value.length?(m(!0),_(x,{key:0},O(Fe.value,s=>(m(),_("span",{key:s.key,class:et(["legend-item",s.className]),"data-test":"shift-legend-item"},E(s.label),3))),128)):(m(),_("span",aa," 尚未設定班別 ")),e[29]||(e[29]=v("span",{class:"legend-item leave"},"請假",-1))]),f(u,{modelValue:Se.value,"onUpdate:modelValue":e[9]||(e[9]=s=>Se.value=s),placeholder:"搜尋員工",clearable:"",class:"employee-search"},null,8,["modelValue"]),f(n,{modelValue:we.value,"onUpdate:modelValue":e[10]||(e[10]=s=>we.value=s),placeholder:"狀態",class:"status-filter"},{default:y(()=>[f(l,{label:"全部",value:"all"}),f(l,{label:"缺班",value:"unscheduled"}),f(l,{label:"待審核請假",value:"onLeave"})]),_:1},8,["modelValue"])]),ne(pe)?(m(),_("div",la,[f(n,{modelValue:ce.value,"onUpdate:modelValue":e[11]||(e[11]=s=>ce.value=s),placeholder:"套用班別",class:"modern-select batch-select",filterable:"","data-test":"batch-shift-select"},{default:y(()=>[(m(!0),_(x,null,O(W.value,s=>(m(),C(l,{key:s._id,label:$e(s),value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(n,{modelValue:Z.value,"onUpdate:modelValue":e[12]||(e[12]=s=>Z.value=s),placeholder:"套用部門",clearable:"",class:"modern-select batch-select","data-test":"batch-dept-select"},{default:y(()=>[(m(!0),_(x,null,O(w.value,s=>(m(),C(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(n,{modelValue:K.value,"onUpdate:modelValue":e[13]||(e[13]=s=>K.value=s),placeholder:"套用單位",clearable:"",class:"modern-select batch-select",disabled:!Z.value,"data-test":"batch-subdept-select"},{default:y(()=>[(m(!0),_(x,null,O(Be.value,s=>(m(),C(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),f(c,{type:"primary",class:"action-btn primary apply-btn",disabled:!Me.value||!ce.value||De.value,loading:De.value,onClick:Et,"data-test":"batch-apply-button"},{default:y(()=>e[31]||(e[31]=[z(" 套用至選取 ")])),_:1},8,["disabled","loading"])])):L("",!0),f(F,{class:"modern-schedule-table",data:ft.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"},onRowClick:e[15]||(e[15]=s=>We.value&&ht(s._id))},{default:y(()=>[f(o,{label:"部門／單位",width:"180",fixed:"left"},{default:y(({row:s})=>[v("div",sa,[v("div",na,E(s.department),1),s.subDepartment?(m(),_("div",oa,E(s.subDepartment),1)):L("",!0)])]),_:1}),f(o,{prop:"name",label:"員工姓名",width:"150",fixed:"left"},{default:y(({row:s})=>[v("div",ra,[ne(pe)?(m(),C(i,{key:0,class:"row-checkbox","model-value":st.value.has(s._id),onChange:d=>ut(s._id,d)},null,8,["model-value","onChange"])):L("",!0),Ne(s._id)==="unscheduled"?(m(),C(Oe(ne(at)),{key:1,class:"status-icon unscheduled"})):Ne(s._id)==="onLeave"?(m(),C(Oe(ne(lt)),{key:2,class:"status-icon on-leave"})):L("",!0),z(" "+E(s.name),1)])]),_:1}),(m(!0),_(x,null,O(Y.value,s=>(m(),C(o,{key:s.date,label:s.label,width:"140",align:"center"},{header:y(()=>[v("div",ia,[v("span",null,E(s.label),1),ne(pe)?(m(),C(i,{key:0,class:"day-checkbox","model-value":nt.value.has(s.date),onChange:d=>dt(s.date,d)},null,8,["model-value","onChange"])):L("",!0)])]),default:y(({row:d})=>{var V,H,q,G,se,ee,he,ye,Ae,_e,Ze;return[!We.value||ke.value.has(d._id)?(m(),_("div",{key:0,class:et(["modern-schedule-cell",[(H=(V=p.value[d._id])==null?void 0:V[s.date])!=null&&H.leave?"":Qe((G=(q=p.value[d._id])==null?void 0:q[s.date])==null?void 0:G.shiftId),{"has-leave":(ee=(se=p.value[d._id])==null?void 0:se[s.date])==null?void 0:ee.leave,"missing-shift":!((ye=(he=p.value[d._id])==null?void 0:he[s.date])!=null&&ye.shiftId)&&!((_e=(Ae=p.value[d._id])==null?void 0:Ae[s.date])!=null&&_e.leave),"is-selected":rt(d._id,s.date)}]]),title:gt(d._id,s.date)},[ne(pe)?(m(),_("div",{key:0,class:"cell-selection",onClick:e[14]||(e[14]=Mt(()=>{},["stop"]))},[f(i,{"model-value":ot.value.has(ae(d._id,s.date)),disabled:!Ce(d._id,s.date),onChange:g=>ct(d._id,s.date,g),size:"small"},null,8,["model-value","disabled","onChange"])])):L("",!0),(Ze=p.value[d._id])!=null&&Ze[s.date]?(m(),_(x,{key:1},[p.value[d._id][s.date].leave?(m(),_("div",da,[f(h,{type:"warning",effect:"light",size:"small",class:"leave-tag"},{default:y(()=>e[32]||(e[32]=[z(" 休假中 ")])),_:1}),e[33]||(e[33]=v("span",{class:"leave-note"},"已核准請假，不列入工時",-1))])):ne(pe)?(m(),_(x,{key:1},[f(n,{modelValue:p.value[d._id][s.date].shiftId,"onUpdate:modelValue":g=>p.value[d._id][s.date].shiftId=g,placeholder:"選擇班別",onChange:g=>Ct(d._id,s.date,g),class:"cell-select shift-select",size:"small"},{default:y(()=>[(m(!0),_(x,null,O(W.value,g=>(m(),C(l,{key:g._id,label:$e(g),value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),v("div",ca,[f(n,{modelValue:p.value[d._id][s.date].department,"onUpdate:modelValue":g=>p.value[d._id][s.date].department=g,placeholder:"部門",size:"small",onChange:()=>p.value[d._id][s.date].subDepartment="",class:"cell-select dept-select"},{default:y(()=>[(m(!0),_(x,null,O(w.value,g=>(m(),C(l,{key:g._id,label:g.name,value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),f(n,{modelValue:p.value[d._id][s.date].subDepartment,"onUpdate:modelValue":g=>p.value[d._id][s.date].subDepartment=g,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:y(()=>[(m(!0),_(x,null,O(Xe(p.value[d._id][s.date].department),g=>(m(),C(l,{key:g._id,label:g.name,value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(m(),_(x,{key:2},[le(p.value[d._id][s.date].shiftId)?(m(),C(M,{key:0,placement:"top",trigger:"hover",width:200},{reference:y(()=>[v("div",ba,E($e(le(p.value[d._id][s.date].shiftId))),1)]),default:y(()=>[v("div",va,[v("div",pa,[e[34]||(e[34]=v("span",{class:"detail-label"},"上班時間：",-1)),v("span",ma,E(le(p.value[d._id][s.date].shiftId).startTime),1)]),v("div",fa,[e[35]||(e[35]=v("span",{class:"detail-label"},"下班時間：",-1)),v("span",ha,E(le(p.value[d._id][s.date].shiftId).endTime),1)]),le(p.value[d._id][s.date].shiftId).remark?(m(),_("div",ya,[e[36]||(e[36]=v("span",{class:"detail-label"},"備註：",-1)),v("span",_a,E(le(p.value[d._id][s.date].shiftId).remark),1)])):L("",!0)])]),_:2},1024)):L("",!0)],64)),!p.value[d._id][s.date].shiftId&&!p.value[d._id][s.date].leave?(m(),_("div",ga," 未排班 ")):L("",!0)],64)):(m(),_("span",Sa,"-"))],10,ua)):(m(),_("div",wa,"展開班表"))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])]),oe.value.length?(m(),_("div",ka,[v("div",Da,[e[37]||(e[37]=v("h3",{class:"approval-title"},"待處理審批",-1)),v("div",Ca,E(oe.value.length)+" 項待處理",1)]),f(F,{class:"modern-approval-table",data:oe.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:y(()=>[f(o,{label:"申請人",width:"120"},{default:y(({row:s})=>{var d;return[v("div",Ia,E((d=s.applicant_employee)==null?void 0:d.name),1)]}),_:1}),f(o,{label:"申請類型",width:"150"},{default:y(({row:s})=>{var d;return[v("div",Va,E(((d=s.form)==null?void 0:d.name)||"未知類型"),1)]}),_:1}),f(o,{prop:"status",label:"狀態",width:"100"},{default:y(({row:s})=>[f(h,{type:s.status==="approved"?"success":s.status==="rejected"?"danger":"warning",class:"status-tag"},{default:y(()=>[z(E(s.status),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])):L("",!0)])}}},xa=tt(Ea,[["__scopeId","data-v-dcbafa04"]]);export{xa as default};
