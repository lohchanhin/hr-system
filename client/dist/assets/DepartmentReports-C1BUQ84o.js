import{_ as ue,r as h,J as z,L as J,x as M,j as ce,E as v,c as k,b as o,d as y,k as N,y as U,w as b,e as x,o as d,F as $,l as A,g as K,t as Q}from"./index-aC1k_6wM.js";import{a as D}from"./api-zZL8ssGi.js";const de={class:"department-reports-page"},me={class:"filters-grid"},ve={class:"filter-item"},pe={class:"filter-item"},fe={class:"filter-item"},ye={class:"filter-item"},be={class:"actions"},ge={key:0,class:"summary-grid"},we={class:"summary-label"},_e={class:"summary-value"},he={__name:"DepartmentReports",setup(ke){const g=h([]),C=h(""),S=h(""),I=[{value:"attendance",label:"出勤統計"},{value:"leave",label:"請假統計"}],G=[{value:"excel",label:"Excel (.xlsx)"},{value:"pdf",label:"PDF (.pdf)"}],V=h(z().format("YYYY-MM")),p=h(""),f=h("attendance"),T=h("excel"),j=h(!1),t=J({loading:!1,state:"idle",summary:null,records:[]}),Y=J({departments:!1}),R={attendance:"/api/reports/department/attendance/export",leave:"/api/reports/department/leave/export"},H={excel:"xlsx",pdf:"pdf"},B=M(()=>!!(p.value&&g.value.some(s=>String(s==null?void 0:s._id)===String(p.value)))),L=M(()=>!!(V.value&&B.value&&R[f.value])),W=M(()=>L.value),X=M(()=>f.value==="attendance"?[{prop:"scheduled",label:"排班天數",minWidth:120},{prop:"attended",label:"出勤天數",minWidth:120},{prop:"absent",label:"缺勤天數",minWidth:120}]:f.value==="leave"?[{prop:"leaveType",label:"假別",minWidth:160},{prop:"startDate",label:"開始日期",minWidth:140},{prop:"endDate",label:"結束日期",minWidth:140},{prop:"days",label:"天數",minWidth:100}]:[]),Z=M(()=>{if(!t.summary)return[];if(f.value==="attendance")return[{label:"排班總計",value:t.summary.scheduled},{label:"出勤總計",value:t.summary.attended},{label:"缺勤總計",value:t.summary.absent}];if(f.value==="leave"){const s=[{label:"總請假件數",value:t.summary.totalLeaves},{label:"總請假天數",value:t.summary.totalDays}],a=Array.isArray(t.summary.byType)?t.summary.byType.map(r=>({label:`${r.leaveType||r.leaveCode} 件數`,value:`${r.count??0} 筆 / ${r.days??0} 天`})):[];return[...s,...a]}return[]});ce(async()=>{Y.departments=!0;try{await ae(),await le()}catch(s){v.error(s.message||"載入主管部門資訊失敗")}finally{Y.departments=!1}});const ee=()=>{var r,l;if(typeof window>"u")return"";const s=(r=window.sessionStorage)==null?void 0:r.getItem("employeeId");if(s&&s!=="undefined")return s;const a=(l=window.localStorage)==null?void 0:l.getItem("employeeId");return a&&a!=="undefined"?a:""};async function ae(){const s=ee();if(!s){C.value="",S.value="",v.warning("尚未取得登入者資料，請重新登入後再試");return}const a=await D(`/api/employees/${s}`);if(!a.ok)throw new Error("無法取得主管資訊");const r=await a.json(),l=r==null?void 0:r.department,u=typeof l=="object"?(l==null?void 0:l._id)||(l==null?void 0:l.id)||(l==null?void 0:l.value):l,c=typeof l=="object"?(l==null?void 0:l.name)||"":(r==null?void 0:r.departmentName)||"";C.value=u?String(u):"",S.value=c?String(c):""}async function le(){if(!C.value&&!S.value){g.value=[],p.value="",v.warning("尚未為您設定可管理的部門，請聯絡系統管理員");return}const s=await D("/api/departments");if(!s.ok)throw new Error("無法取得部門清單");const a=await s.json(),r=Array.isArray(a)?a.map(e=>{const w=(e==null?void 0:e._id)??(e==null?void 0:e.id)??(e==null?void 0:e.value)??(typeof e=="string"?e:""),_=(e==null?void 0:e.name)??(e==null?void 0:e.label)??(e==null?void 0:e.departmentName)??"";return{...e,_id:w?String(w):"",name:String(_||(e==null?void 0:e.name)||"")}}):[],l=C.value,u=S.value.trim().toLowerCase();let c=r.filter(e=>{const w=String((e==null?void 0:e._id)||""),_=String((e==null?void 0:e.name)||"").trim().toLowerCase();return l&&w===l||u&&_&&_===u});if(!c.length&&l&&(c=[{_id:l,name:S.value||"主管部門"}]),c=c.filter(e=>e==null?void 0:e._id),g.value=c,!g.value.length){p.value="",v.warning("未找到與您相符的部門，請聯絡系統管理員");return}const i=g.value.find(e=>e._id===l);p.value=(i==null?void 0:i._id)||g.value[0]._id||""}function F(){return B.value?!0:(v.warning("目前無可操作的部門，請確認您的部門權限設定"),!1)}function P(s){return`?${new URLSearchParams(s).toString()}`}async function te(){var a,r;if(!W.value&&!F()||!W.value)return;const s=R[f.value];if(!s){v.warning("此報表尚未開放預覽");return}t.loading=!0,t.state="loading";try{const l=P({month:V.value,department:p.value,format:"json"}),u=await D(`${s}${l}`,{headers:{Accept:"application/json"}}),c=((r=(a=u.headers)==null?void 0:a.get)==null?void 0:r.call(a,"content-type"))||"";if(!u.ok){const e=c.includes("application/json")?await u.json():null;throw new Error((e==null?void 0:e.error)||(e==null?void 0:e.message)||"預覽失敗")}if(!c.includes("application/json")){t.state="idle",t.summary=null,t.records=[],v.info("此報表不提供預覽，請直接匯出");return}const i=await u.json();t.summary=(i==null?void 0:i.summary)??null,t.records=Array.isArray(i==null?void 0:i.records)?i.records:[],!t.records.length&&!t.summary?t.state="empty":t.state="success"}catch(l){t.state="idle",t.summary=null,t.records=[],v.error(l.message||"預覽失敗")}finally{t.loading=!1}}async function ne(){var a,r,l,u,c;if(j.value||!L.value&&!F()||!L.value)return;const s=R[f.value];if(!s){v.error("尚未提供此報表的匯出服務");return}j.value=!0;try{const i=P({month:V.value,department:p.value,format:T.value}),e=await D(`${s}${i}`,{headers:{Accept:"application/octet-stream"}}),w=((r=(a=e.headers)==null?void 0:a.get)==null?void 0:r.call(a,"content-type"))||"";if(!e.ok){const m=w.includes("application/json")?await e.json():null;throw new Error((m==null?void 0:m.error)||(m==null?void 0:m.message)||"匯出失敗")}const _=await e.blob(),n=H[T.value]||"dat",se=((l=V.value)==null?void 0:l.replace("-",""))||z().format("YYYYMM"),re=((u=g.value.find(m=>m._id===p.value))==null?void 0:u.name)||"department",oe=((c=I.find(m=>m.value===f.value))==null?void 0:c.value)||"report",O=m=>String(m).trim().replace(/\s+/g,"-").replace(/[^\w\u4e00-\u9fa5-]+/gi,""),ie=`${se}-${O(re)}-${O(oe)}.${n}`,q=window.URL.createObjectURL(_),E=document.createElement("a");E.href=q,E.download=ie,document.body.appendChild(E),E.click(),document.body.removeChild(E),window.URL.revokeObjectURL(q),v.success("匯出成功")}catch(i){v.error(i.message||"匯出失敗")}finally{j.value=!1}}return(s,a)=>{const r=x("el-date-picker"),l=x("el-option"),u=x("el-select"),c=x("el-button"),i=x("el-card"),e=x("el-alert"),w=x("el-table-column"),_=x("el-table");return d(),k("div",de,[a[12]||(a[12]=o("header",{class:"page-header"},[o("h1",{class:"page-title"},"部門報表中心"),o("p",{class:"page-subtitle"},"彙整各部門出勤與請假統計")],-1)),y(i,{class:"filters-card",shadow:"never"},{header:b(()=>a[4]||(a[4]=[o("div",{class:"card-header"},[o("h2",null,"匯出條件"),o("span",{class:"card-tip"},"請先選擇月份、部門與報表種類")],-1)])),default:b(()=>[o("div",me,[o("div",ve,[a[5]||(a[5]=o("label",{class:"filter-label"},"月份",-1)),y(r,{modelValue:V.value,"onUpdate:modelValue":a[0]||(a[0]=n=>V.value=n),type:"month",placeholder:"選擇月份",format:"YYYY 年 MM 月","value-format":"YYYY-MM",disabled:Y.departments,class:"w-full"},null,8,["modelValue","disabled"])]),o("div",pe,[a[6]||(a[6]=o("label",{class:"filter-label"},"部門",-1)),y(u,{modelValue:p.value,"onUpdate:modelValue":a[1]||(a[1]=n=>p.value=n),placeholder:"選擇部門",filterable:"",loading:Y.departments,disabled:Y.departments||g.value.length===0,class:"w-full"},{default:b(()=>[(d(!0),k($,null,A(g.value,n=>(d(),N(l,{key:n._id,label:n.name,value:n._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),o("div",fe,[a[7]||(a[7]=o("label",{class:"filter-label"},"報表種類",-1)),y(u,{modelValue:f.value,"onUpdate:modelValue":a[2]||(a[2]=n=>f.value=n),placeholder:"選擇報表",class:"w-full"},{default:b(()=>[(d(),k($,null,A(I,n=>y(l,{key:n.value,label:n.label,value:n.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),o("div",ye,[a[8]||(a[8]=o("label",{class:"filter-label"},"匯出格式",-1)),y(u,{modelValue:T.value,"onUpdate:modelValue":a[3]||(a[3]=n=>T.value=n),placeholder:"選擇格式",class:"w-full"},{default:b(()=>[(d(),k($,null,A(G,n=>y(l,{key:n.value,label:n.label,value:n.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])])]),o("div",be,[y(c,{disabled:!W.value||t.loading,loading:t.loading,onClick:te},{default:b(()=>a[9]||(a[9]=[K(" 預覽摘要 ")])),_:1},8,["disabled","loading"]),y(c,{type:"primary",disabled:!L.value||j.value,loading:j.value,onClick:ne},{default:b(()=>a[10]||(a[10]=[K(" 匯出報表 ")])),_:1},8,["disabled","loading"])])]),_:1}),t.state==="empty"?(d(),N(e,{key:0,type:"info","show-icon":"",class:"mt-4",title:"目前條件下沒有可供預覽的資料"})):U("",!0),t.state==="success"?(d(),N(i,{key:1,class:"preview-card",shadow:"never"},{header:b(()=>a[11]||(a[11]=[o("div",{class:"card-header"},[o("h2",null,"報表摘要"),o("span",{class:"card-tip"},"以下內容來自後端 JSON 預覽")],-1)])),default:b(()=>[t.summary?(d(),k("div",ge,[(d(!0),k($,null,A(Z.value,n=>(d(),k("div",{class:"summary-item",key:n.label},[o("span",we,Q(n.label),1),o("span",_e,Q(n.value),1)]))),128))])):U("",!0),t.records.length?(d(),N(_,{key:1,data:t.records,border:"",class:"preview-table"},{default:b(()=>[y(w,{prop:"name",label:"員工","min-width":"140"}),(d(!0),k($,null,A(X.value,n=>(d(),N(w,{key:n.prop,prop:n.prop,label:n.label,"min-width":n.minWidth||120},null,8,["prop","label","min-width"]))),128))]),_:1},8,["data"])):U("",!0)]),_:1})):U("",!0)])}}},Se=ue(he,[["__scopeId","data-v-e2faa4e3"]]);export{Se as default};
