import{A as pe,r as k,p as me,_ as ve,B as T,x as Y,h as fe,c as h,b as n,y as P,d as f,e as C,w as m,a as he,t as y,E as O,u as _e,o as c,F as S,k as M,i as x,j as A,n as be,C as W}from"./index-BOg20HvU.js";import{a as g}from"./api-D4yO7thr.js";const ye=pe("auth",()=>{const N=k("employee");function _(){const r=me();if(r)try{const V=JSON.parse(atob(r.split(".")[1]));N.value=V.role||"employee"}catch{N.value="employee"}else N.value="employee"}return{role:N,loadUser:_}}),ge={class:"schedule-page"},ke={class:"filters-card"},we={class:"filters-content"},De={class:"filter-group"},Ie={class:"filter-group"},Se={class:"filter-group"},Ce={class:"actions-card"},Ve={class:"primary-actions"},Ee={class:"secondary-actions"},$e={class:"schedule-card"},je={class:"employee-info"},xe={class:"department-name"},Ue={key:0,class:"sub-department"},Te={class:"employee-name"},Oe={class:"department-selects"},Me={class:"shift-details"},Ae={class:"detail-row"},Ne={class:"detail-value"},Fe={class:"detail-row"},Pe={class:"detail-value"},Re={key:0,class:"detail-row"},Be={class:"detail-value"},Le={class:"modern-shift-tag"},Je={key:2,class:"leave-indicator"},ze={key:1,class:"empty-cell"},Ye={key:0,class:"approval-card"},We={class:"approval-header"},qe={class:"approval-count"},Ge={class:"applicant-name"},He={class:"form-type"},Ke={__name:"Schedule",setup(N){const _=k(T().format("YYYY-MM")),r=k({}),V=k([]),U=k([]),R=k([]),F=k([]),E=k([]),w=k(""),D=k(""),te=Y(()=>E.value.filter(l=>l.department===w.value)),ae=_e(),q=ye();q.loadUser();const le=Y(()=>["supervisor","admin"].includes(q.role)),z=Y(()=>{const l=T(_.value+"-01"),e=l.endOf("month").date(),u=["日","一","二","三","四","五","六"];return Array.from({length:e},(o,d)=>{const a=d+1,s=u[l.date(a).day()];return{date:a,label:`${a}(${s})`}})});async function se(){const l=await g("/api/attendance-settings");if(l.ok){const e=await l.json(),u=Array.isArray(e==null?void 0:e.shifts)?e.shifts:e;Array.isArray(u)&&(V.value=u.map(o=>({_id:o._id,code:o.code,startTime:o.startTime,endTime:o.endTime,remark:o.remark})))}else l.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",l.status)}async function G(l=""){try{const e=l?`/api/sub-departments?department=${l}`:"/api/sub-departments",u=await g(e);if(!u.ok)throw new Error("Failed to fetch sub departments");const o=await u.json(),d=F.value.reduce((a,s)=>(a[s._id]=s._id,a[s.name]=s._id,a),{});E.value=Array.isArray(o)?o.map(a=>{let s="";return a&&typeof a.department=="object"?s=a.department._id||d[a.department.name]||"":s=d[a.department]||a.department||"",{...a,_id:String(a._id),department:String(s)}}):[],E.value.length&&!D.value&&(D.value=E.value[0]._id)}catch(e){console.error(e),E.value=[],D.value=""}}async function ne(){try{const l=await g("/api/departments");F.value=l.ok?await l.json():[],await G(w.value)}catch(l){console.error(l)}}async function B(){const l=localStorage.getItem("employeeId")||"";try{const e=await g(`/api/schedules/monthly?month=${_.value}&supervisor=${l}`);if(!e.ok)throw new Error("Failed to fetch schedules");const u=await e.json();console.log("Schedules:",u);const o=z.value;r.value={},U.value.length||await J(w.value,D.value),U.value.forEach(a=>{r.value[a._id]={},o.forEach(s=>{r.value[a._id][s.date]={shiftId:"",department:a.departmentId,subDepartment:a.subDepartmentId}})}),u.forEach(a=>{var p;const s=((p=a.employee)==null?void 0:p._id)||a.employee,b=T(a.date).date(),I=U.value.find(t=>t._id===s)||{};r.value[s][b]={id:a._id,shiftId:a.shiftId,department:a.department||I.departmentId,subDepartment:a.subDepartment||I.subDepartmentId}});const d=await g(`/api/schedules/leave-approvals?month=${_.value}&supervisor=${l}`);if(d.ok){const a=await d.json();R.value=a.approvals||[],(a.leaves||[]).forEach(s=>{var t,i;if(s.status!=="approved")return;const b=((t=s.employee)==null?void 0:t._id)||s.employee,I=T(s.startDate).date(),p=T(s.endDate).date();for(let j=I;j<=p;j++)(i=r.value[b])!=null&&i[j]&&(r.value[b][j].leave={type:s.leaveType})})}}catch(e){console.error(e),O.error("取得排班資料失敗")}}async function oe(){const l=[];if(Object.keys(r.value).forEach(e=>{Object.keys(r.value[e]).forEach(u=>{const o=r.value[e][u];o.shiftId&&!o.id&&l.push({employee:e,date:`${_.value}-${String(u).padStart(2,"0")}`,shiftId:o.shiftId,department:o.department,subDepartment:o.subDepartment})})}),!!l.length)try{const e=await g("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:l})});if(!e.ok)throw new Error("save failed");(await e.json()).forEach(o=>{var s;const d=((s=o.employee)==null?void 0:s._id)||o.employee,a=T(o.date).date();r.value[d]||(r.value[d]={}),r.value[d][a]={id:o._id,shiftId:o.shiftId}}),O.success("儲存完成")}catch{O.error("儲存失敗")}}function H(l){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:r.value,employees:U.value,days:z.value,shifts:V.value})),ae.push({name:l==="week"?"PreviewWeek":"PreviewMonth"})}async function K(l){try{const e=await g(`/api/schedules/export?month=${_.value}&format=${l}`);if(!e.ok)throw new Error;const u=await e.blob(),o=URL.createObjectURL(u),d=document.createElement("a");d.href=o,d.download=`schedules-${_.value}.${l==="excel"?"xlsx":"pdf"}`,d.click(),URL.revokeObjectURL(o)}catch{O.error("匯出失敗")}}async function de(l,e,u){const o=`${_.value}-${String(e).padStart(2,"0")}`,d=r.value[l][e],a=d.shiftId;if(d&&d.id)try{const s=await g(`/api/schedules/${d.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:u,department:d.department,subDepartment:d.subDepartment})});s.ok||await L(s,"更新排班失敗",l,e,a)}catch{await L(null,"更新排班失敗",l,e,a)}else try{const s=await g("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:l,date:o,shiftId:u,department:d.department,subDepartment:d.subDepartment})});if(s.ok){const b=await s.json();r.value[l][e]={id:b._id,shiftId:b.shiftId,department:d.department,subDepartment:d.subDepartment}}else await L(s,"新增排班失敗",l,e,a)}catch{await L(null,"新增排班失敗",l,e,a)}}async function re(){D.value="",await G(w.value),await J(w.value,""),await B()}async function ie(){await J(w.value,D.value),await B()}async function L(l,e,u,o,d){r.value[u][o].shiftId=d;let a="";try{if(l){const s=await l.json();a=(s==null?void 0:s.error)||""}}catch{}a==="employee conflict"?W.alert("人員衝突"):a==="department overlap"?W.alert("跨區重複"):a==="leave conflict"?W.alert("請假衝突"):O.error(e)}function $(l){return V.value.find(e=>e._id===l)}function ue(l){const e=$(l);return e?/早/.test(e.code)?"shift-morning":/晚|夜/.test(e.code)?"shift-evening":"shift-normal":""}function ce(l){return E.value.filter(e=>e.department===l)}async function J(l="",e=""){let o=`/api/employees?supervisor=${localStorage.getItem("employeeId")||""}`;l&&(o+=`&department=${l}`),e&&(o+=`&subDepartment=${e}`);try{const d=await g(o);if(!d.ok)throw new Error("Failed to fetch employees");const a=await d.json(),s=F.value.reduce((p,t)=>(p[t._id]=t.name,p),{}),b=E.value.reduce((p,t)=>(p[t._id]=t.name,p),{}),I=a.map(p=>({_id:p._id,name:p.name,departmentId:p.department,subDepartmentId:p.subDepartment,department:s[p.department]||"",subDepartment:b[p.subDepartment]||""})).sort((p,t)=>p.department.localeCompare(t.department));U.value=I}catch(d){console.error(d),O.error("取得員工資料失敗")}}return fe(async()=>{await se(),await ne(),await J(w.value,D.value),await B()}),(l,e)=>{const u=C("el-date-picker"),o=C("el-option"),d=C("el-select"),a=C("el-button"),s=C("el-table-column"),b=C("el-popover"),I=C("el-table"),p=C("el-tag");return c(),h("div",ge,[e[22]||(e[22]=n("div",{class:"page-header"},[n("h1",{class:"page-title"},"排班管理"),n("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),n("div",ke,[e[10]||(e[10]=n("div",{class:"filters-header"},[n("h3",{class:"filters-title"},"篩選條件")],-1)),n("div",we,[n("div",De,[e[7]||(e[7]=n("label",{class:"filter-label"},"選擇月份",-1)),f(u,{modelValue:_.value,"onUpdate:modelValue":e[0]||(e[0]=t=>_.value=t),type:"month",onChange:B,class:"modern-date-picker"},null,8,["modelValue"])]),n("div",Ie,[e[8]||(e[8]=n("label",{class:"filter-label"},"部門",-1)),f(d,{modelValue:w.value,"onUpdate:modelValue":e[1]||(e[1]=t=>w.value=t),placeholder:"請選擇部門",onChange:re,class:"modern-select"},{default:m(()=>[(c(!0),h(S,null,M(F.value,t=>(c(),x(o,{key:t._id,label:t.name,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),n("div",Se,[e[9]||(e[9]=n("label",{class:"filter-label"},"單位",-1)),f(d,{modelValue:D.value,"onUpdate:modelValue":e[2]||(e[2]=t=>D.value=t),placeholder:"請選擇單位",onChange:ie,class:"modern-select"},{default:m(()=>[(c(!0),h(S,null,M(te.value,t=>(c(),x(o,{key:t._id,label:t.name,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])]),n("div",Ce,[n("div",Ve,[f(a,{type:"primary",onClick:oe,class:"action-btn primary"},{default:m(()=>e[11]||(e[11]=[n("i",{class:"el-icon-check"},null,-1),A(" 儲存排班 ")])),_:1})]),n("div",Ee,[f(a,{onClick:e[3]||(e[3]=t=>H("week")),class:"action-btn secondary"},{default:m(()=>e[12]||(e[12]=[n("i",{class:"el-icon-calendar"},null,-1),A(" 預覽週表 ")])),_:1}),f(a,{onClick:e[4]||(e[4]=t=>H("month")),class:"action-btn secondary"},{default:m(()=>e[13]||(e[13]=[n("i",{class:"el-icon-date"},null,-1),A(" 預覽月表 ")])),_:1}),f(a,{onClick:e[5]||(e[5]=()=>K("pdf")),class:"action-btn export"},{default:m(()=>e[14]||(e[14]=[n("i",{class:"el-icon-download"},null,-1),A(" 匯出 PDF ")])),_:1}),f(a,{onClick:e[6]||(e[6]=()=>K("excel")),class:"action-btn export"},{default:m(()=>e[15]||(e[15]=[n("i",{class:"el-icon-s-grid"},null,-1),A(" 匯出 Excel ")])),_:1})])]),n("div",$e,[e[20]||(e[20]=he('<div class="schedule-header" data-v-63c0bbde><h3 class="schedule-title" data-v-63c0bbde>員工排班表</h3><div class="schedule-legend" data-v-63c0bbde><span class="legend-item morning" data-v-63c0bbde>早班</span><span class="legend-item evening" data-v-63c0bbde>晚班</span><span class="legend-item normal" data-v-63c0bbde>正常班</span><span class="legend-item leave" data-v-63c0bbde>請假</span></div></div>',1)),f(I,{class:"modern-schedule-table",data:U.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"}},{default:m(()=>[f(s,{label:"部門／單位",width:"180",fixed:"left"},{default:m(({row:t})=>[n("div",je,[n("div",xe,y(t.department),1),t.subDepartment?(c(),h("div",Ue,y(t.subDepartment),1)):P("",!0)])]),_:1}),f(s,{prop:"name",label:"員工姓名",width:"120",fixed:"left"},{default:m(({row:t})=>[n("div",Te,y(t.name),1)]),_:1}),(c(!0),h(S,null,M(z.value,t=>(c(),x(s,{key:t.date,label:t.label,width:"140",align:"center"},{default:m(({row:i})=>{var j,Q,X,Z,ee;return[n("div",{class:be(["modern-schedule-cell",[ue((Q=(j=r.value[i._id])==null?void 0:j[t.date])==null?void 0:Q.shiftId),{"has-leave":(Z=(X=r.value[i._id])==null?void 0:X[t.date])==null?void 0:Z.leave}]])},[(ee=r.value[i._id])!=null&&ee[t.date]?(c(),h(S,{key:0},[le.value?(c(),h(S,{key:0},[f(d,{modelValue:r.value[i._id][t.date].shiftId,"onUpdate:modelValue":v=>r.value[i._id][t.date].shiftId=v,placeholder:"選擇班別",onChange:v=>de(i._id,t.date,v),class:"cell-select shift-select",size:"small"},{default:m(()=>[(c(!0),h(S,null,M(V.value,v=>(c(),x(o,{key:v._id,label:v.code,value:v._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),n("div",Oe,[f(d,{modelValue:r.value[i._id][t.date].department,"onUpdate:modelValue":v=>r.value[i._id][t.date].department=v,placeholder:"部門",size:"small",onChange:()=>r.value[i._id][t.date].subDepartment="",class:"cell-select dept-select"},{default:m(()=>[(c(!0),h(S,null,M(F.value,v=>(c(),x(o,{key:v._id,label:v.name,value:v._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),f(d,{modelValue:r.value[i._id][t.date].subDepartment,"onUpdate:modelValue":v=>r.value[i._id][t.date].subDepartment=v,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:m(()=>[(c(!0),h(S,null,M(ce(r.value[i._id][t.date].department),v=>(c(),x(o,{key:v._id,label:v.name,value:v._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(c(),h(S,{key:1},[$(r.value[i._id][t.date].shiftId)?(c(),x(b,{key:0,placement:"top",trigger:"hover",width:200},{reference:m(()=>[n("div",Le,y($(r.value[i._id][t.date].shiftId).code),1)]),default:m(()=>[n("div",Me,[n("div",Ae,[e[16]||(e[16]=n("span",{class:"detail-label"},"上班時間：",-1)),n("span",Ne,y($(r.value[i._id][t.date].shiftId).startTime),1)]),n("div",Fe,[e[17]||(e[17]=n("span",{class:"detail-label"},"下班時間：",-1)),n("span",Pe,y($(r.value[i._id][t.date].shiftId).endTime),1)]),$(r.value[i._id][t.date].shiftId).remark?(c(),h("div",Re,[e[18]||(e[18]=n("span",{class:"detail-label"},"備註：",-1)),n("span",Be,y($(r.value[i._id][t.date].shiftId).remark),1)])):P("",!0)])]),_:2},1024)):P("",!0)],64)),r.value[i._id][t.date].leave?(c(),h("div",Je,e[19]||(e[19]=[n("i",{class:"el-icon-warning-outline"},null,-1),n("span",null,"請假",-1)]))):P("",!0)],64)):(c(),h("span",ze,"-"))],2)]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])]),R.value.length?(c(),h("div",Ye,[n("div",We,[e[21]||(e[21]=n("h3",{class:"approval-title"},"待處理審批",-1)),n("div",qe,y(R.value.length)+" 項待處理",1)]),f(I,{class:"modern-approval-table",data:R.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:m(()=>[f(s,{label:"申請人",width:"120"},{default:m(({row:t})=>{var i;return[n("div",Ge,y((i=t.applicant_employee)==null?void 0:i.name),1)]}),_:1}),f(s,{label:"申請類型",width:"150"},{default:m(({row:t})=>{var i;return[n("div",He,y(((i=t.form)==null?void 0:i.name)||"未知類型"),1)]}),_:1}),f(s,{prop:"status",label:"狀態",width:"100"},{default:m(({row:t})=>[f(p,{type:t.status==="approved"?"success":t.status==="rejected"?"danger":"warning",class:"status-tag"},{default:m(()=>[A(y(t.status),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])):P("",!0)])}}},Ze=ve(Ke,[["__scopeId","data-v-63c0bbde"]]);export{Ze as default};
