import{a as y}from"./api-D4yO7thr.js";import{_ as ye,r as b,q as _e,h as be,c,b as F,d as a,w as t,e as V,o as v,i as C,F as T,k as D,j as r,t as X}from"./index-BOg20HvU.js";const Ve={class:"approval-flow-setting"},ge={class:"flex items-center gap-2 mb-2"},ke={key:1,class:"text-gray-500"},ce={class:"tab-content"},we={class:"mb-2"},Ce={class:"tab-content"},Ue={class:"flex items-center gap-2 mb-2"},xe={key:1,class:"text-gray-500"},Se={__name:"ApprovalFlowSetting",setup($e){const f={forms:"/api/approvals/forms",workflow:o=>`/api/approvals/forms/${o}/workflow`,fields:o=>`/api/approvals/forms/${o}/fields`,field:(o,e)=>`/api/approvals/forms/${o}/fields/${e}`,employees:"/api/employees/options",roles:"/api/roles"},Z=["人事類","總務類","請假類","其他"],h=["manager","tag","user","role","department","org","group"],P=b("commonRule"),O=b([]),d=b(""),x=b([]),g=b({maxApprovalLevel:5,allowDelegate:!1,overdueDays:3,overdueAction:"none"}),j=b(!1),z=b("create"),k=b({_id:"",name:"",category:"其他",is_active:!0,description:""}),E=b(!1),U=b([]),Y=b([]),G=b([]),A=b(!1),L=b("create"),i=b({_id:"",label:"",type_1:"text",type_2:"",required:!1,optionsStr:"",placeholder:"",order:0}),ee=["text","textarea","number","select","checkbox","date","time","datetime","file","user","department","org"];_e([P,d],()=>{P.value==="fields"&&d.value&&q()});function le(o){if(o)try{return JSON.parse(o)}catch{return o.split(",").map(e=>e.trim()).filter(Boolean)}}async function q(){if(!d.value)return;const o=await y(f.fields(d.value));if(o.ok){const e=await o.json();x.value=Array.isArray(e)?e.sort((n,m)=>(n.order??0)-(m.order??0)):[]}}function H(o="create",e=null){L.value=o,o==="edit"&&e?i.value={...e,optionsStr:e.options?JSON.stringify(e.options):""}:i.value={_id:"",label:"",type_1:"text",type_2:"",required:!1,optionsStr:"",placeholder:"",order:x.value.length},A.value=!0}async function ae(){if(!d.value)return;const o={label:i.value.label,type_1:i.value.type_1,type_2:i.value.type_2,required:i.value.required,options:le(i.value.optionsStr),placeholder:i.value.placeholder,order:i.value.order??x.value.length};let e;L.value==="edit"&&i.value._id?e=await y(f.field(d.value,i.value._id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}):e=await y(f.fields(d.value),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),e.ok&&(A.value=!1,await q())}async function te(o){const e={label:o.label,type_1:o.type_1,type_2:o.type_2,required:o.required,options:o.options,placeholder:o.placeholder,order:o.order};await y(f.field(d.value,o._id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async function oe(o){await y(f.field(d.value,o._id),{method:"DELETE"}),await q()}async function K(o,e){const n=o+e;if(n<0||n>=x.value.length)return;const m=x.value,[s]=m.splice(o,1);m.splice(n,0,s);for(let w=0;w<m.length;w++)m[w].order=w,await y(f.field(d.value,m[w]._id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:w})})}async function I(){const o=await y(f.forms);o.ok&&(O.value=await o.json())}async function ue(){const o=await y(f.employees);if(o.ok){const e=await o.json();Y.value=Array.isArray(e)?e.map(n=>({id:n.id,name:n.name})):[]}}async function de(){const o=await y(f.roles);o.ok&&(G.value=await o.json())}async function N(){if(!d.value)return;const o=await y(f.workflow(d.value));if(o.ok){const e=await o.json();g.value={...g.value,...(e==null?void 0:e.policy)||{}}}}async function ne(){d.value&&(await y(f.workflow(d.value),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({policy:g.value})}),ElMessage.success("已儲存通用規則"))}function J(o="create",e=null){z.value=o,o==="edit"&&e?k.value={_id:e._id,name:e.name,category:e.category,is_active:e.is_active,description:e.description||""}:k.value={_id:"",name:"",category:"其他",is_active:!0,description:""},j.value=!0}async function ie(){var n;const o={...k.value};let e;z.value==="edit"?e=await y(`${f.forms}/${o._id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}):e=await y(f.forms,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),e.ok&&(j.value=!1,await I(),d.value||(d.value=((n=O.value[0])==null?void 0:n._id)||""),await N())}async function Q(o=null){const e=(o==null?void 0:o._id)||d.value;e&&(await y(`${f.forms}/${e}`,{method:"DELETE"}),d.value===e&&(d.value=""),await I())}function se(o){d.value=o._id,N().then(async()=>{const e=await y(f.workflow(d.value)),n=e.ok?await e.json():{};U.value=((n==null?void 0:n.steps)||[]).map(m=>({...m})),E.value=!0})}function re(){U.value.push({step_order:U.value.length+1,approver_type:"user",approver_value:[],scope_type:"none",is_required:!0,all_must_approve:!0,can_return:!0})}function pe(o){U.value.splice(o,1),U.value=U.value.map((e,n)=>({...e,step_order:n+1}))}async function me(){const o={steps:U.value.map((e,n)=>({...e,step_order:n+1})),policy:g.value};await y(f.workflow(d.value),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),E.value=!1,ElMessage.success("流程已儲存")}return be(async()=>{var o;await I(),d.value=((o=O.value[0])==null?void 0:o._id)||"",d.value&&await N(),await ue(),await de()}),(o,e)=>{const n=V("el-option"),m=V("el-select"),s=V("el-button"),w=V("el-input-number"),_=V("el-form-item"),S=V("el-switch"),R=V("el-form"),B=V("el-tab-pane"),p=V("el-table-column"),ve=V("el-tag"),M=V("el-table"),$=V("el-input"),W=V("el-dialog"),fe=V("el-tabs");return v(),c("div",Ve,[e[48]||(e[48]=F("h2",null,"簽核流程設定",-1)),a(fe,{modelValue:P.value,"onUpdate:modelValue":e[26]||(e[26]=l=>P.value=l),type:"card"},{default:t(()=>[a(B,{label:"通用流程規則",name:"commonRule"},{default:t(()=>[F("div",ge,[a(m,{modelValue:d.value,"onUpdate:modelValue":e[0]||(e[0]=l=>d.value=l),placeholder:"選擇表單樣板",style:{width:"320px"},onChange:N},{default:t(()=>[(v(!0),c(T,null,D(O.value,l=>(v(),C(n,{key:l._id,label:`${l.name}（${l.category}）`,value:l._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(s,{type:"primary",onClick:e[1]||(e[1]=l=>J())},{default:t(()=>e[27]||(e[27]=[r("新增樣板")])),_:1}),a(s,{disabled:!d.value,onClick:e[2]||(e[2]=l=>J("edit"))},{default:t(()=>e[28]||(e[28]=[r("編輯樣板")])),_:1},8,["disabled"]),a(s,{type:"danger",disabled:!d.value,onClick:Q},{default:t(()=>e[29]||(e[29]=[r("刪除樣板")])),_:1},8,["disabled"])]),d.value?(v(),C(R,{key:0,model:g.value,"label-width":"160px",class:"rule-form"},{default:t(()=>[a(_,{label:"最大簽核關卡數"},{default:t(()=>[a(w,{modelValue:g.value.maxApprovalLevel,"onUpdate:modelValue":e[3]||(e[3]=l=>g.value.maxApprovalLevel=l),min:1},null,8,["modelValue"])]),_:1}),a(_,{label:"是否允許代理簽核"},{default:t(()=>[a(S,{modelValue:g.value.allowDelegate,"onUpdate:modelValue":e[4]||(e[4]=l=>g.value.allowDelegate=l)},null,8,["modelValue"])]),_:1}),a(_,{label:"逾時提醒(天)"},{default:t(()=>[a(w,{modelValue:g.value.overdueDays,"onUpdate:modelValue":e[5]||(e[5]=l=>g.value.overdueDays=l),min:1},null,8,["modelValue"])]),_:1}),a(_,{label:"逾時處理方式"},{default:t(()=>[a(m,{modelValue:g.value.overdueAction,"onUpdate:modelValue":e[6]||(e[6]=l=>g.value.overdueAction=l),placeholder:"選擇逾時行為"},{default:t(()=>[a(n,{label:"不處理",value:"none"}),a(n,{label:"自動通過",value:"autoPass"}),a(n,{label:"自動退回",value:"autoReject"})]),_:1},8,["modelValue"])]),_:1}),a(_,null,{default:t(()=>[a(s,{type:"primary",onClick:ne},{default:t(()=>e[30]||(e[30]=[r("儲存通用規則")])),_:1})]),_:1})]),_:1},8,["model"])):(v(),c("div",ke,"請先從上方下拉選擇一個表單樣板。"))]),_:1}),a(B,{label:"申請類型 / 關卡",name:"approvalLevels"},{default:t(()=>[F("div",ce,[a(s,{type:"primary",onClick:e[7]||(e[7]=l=>J())},{default:t(()=>e[31]||(e[31]=[r("新增表單樣板")])),_:1}),a(M,{data:O.value,style:{"margin-top":"20px"}},{default:t(()=>[a(p,{prop:"name",label:"表單名稱",width:"220"}),a(p,{prop:"category",label:"分類",width:"120"}),a(p,{prop:"is_active",label:"啟用",width:"100"},{default:t(({row:l})=>[a(ve,{type:l.is_active?"success":"info"},{default:t(()=>[r(X(l.is_active?"啟用":"停用"),1)]),_:2},1032,["type"])]),_:1}),a(p,{label:"流程關卡","min-width":"300"},{default:t(({row:l})=>[a(s,{size:"small",onClick:u=>se(l)},{default:t(()=>e[32]||(e[32]=[r("設定關卡")])),_:2},1032,["onClick"])]),_:1}),a(p,{label:"操作",width:"220"},{default:t(({row:l})=>[a(s,{size:"small",type:"primary",onClick:u=>J("edit",l)},{default:t(()=>e[33]||(e[33]=[r("編輯")])),_:2},1032,["onClick"]),a(s,{size:"small",type:"danger",onClick:u=>Q(l)},{default:t(()=>e[34]||(e[34]=[r("刪除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),a(W,{modelValue:j.value,"onUpdate:modelValue":e[13]||(e[13]=l=>j.value=l),title:z.value==="edit"?"編輯表單樣板":"新增表單樣板",width:"520px"},{footer:t(()=>[a(s,{onClick:e[12]||(e[12]=l=>j.value=!1)},{default:t(()=>e[35]||(e[35]=[r("取消")])),_:1}),a(s,{type:"primary",onClick:ie},{default:t(()=>e[36]||(e[36]=[r("儲存")])),_:1})]),default:t(()=>[a(R,{model:k.value,"label-width":"120px"},{default:t(()=>[a(_,{label:"表單名稱"},{default:t(()=>[a($,{modelValue:k.value.name,"onUpdate:modelValue":e[8]||(e[8]=l=>k.value.name=l)},null,8,["modelValue"])]),_:1}),a(_,{label:"分類"},{default:t(()=>[a(m,{modelValue:k.value.category,"onUpdate:modelValue":e[9]||(e[9]=l=>k.value.category=l),placeholder:"選擇分類"},{default:t(()=>[(v(),c(T,null,D(Z,l=>a(n,{key:l,label:l,value:l},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),a(_,{label:"啟用"},{default:t(()=>[a(S,{modelValue:k.value.is_active,"onUpdate:modelValue":e[10]||(e[10]=l=>k.value.is_active=l)},null,8,["modelValue"])]),_:1}),a(_,{label:"說明"},{default:t(()=>[a($,{modelValue:k.value.description,"onUpdate:modelValue":e[11]||(e[11]=l=>k.value.description=l),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(W,{modelValue:E.value,"onUpdate:modelValue":e[15]||(e[15]=l=>E.value=l),title:"流程關卡設定",width:"800px"},{footer:t(()=>[a(s,{onClick:e[14]||(e[14]=l=>E.value=!1)},{default:t(()=>e[39]||(e[39]=[r("取消")])),_:1}),a(s,{type:"primary",onClick:me},{default:t(()=>e[40]||(e[40]=[r("儲存")])),_:1})]),default:t(()=>[F("div",we,[a(s,{size:"small",onClick:re},{default:t(()=>e[37]||(e[37]=[r("新增關卡")])),_:1})]),a(M,{data:U.value,border:""},{default:t(()=>[a(p,{label:"#",width:"60"},{default:t(({$index:l})=>[r(X(l+1),1)]),_:1}),a(p,{label:"簽核類型",width:"150"},{default:t(({row:l})=>[a(m,{modelValue:l.approver_type,"onUpdate:modelValue":u=>l.approver_type=u,placeholder:"選擇類型",style:{width:"140px"}},{default:t(()=>[(v(),c(T,null,D(h,u=>a(n,{key:u,label:u,value:u},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:1}),a(p,{label:"簽核對象",width:"200"},{default:t(({row:l})=>[l.approver_type==="user"?(v(),C(m,{key:0,modelValue:l.approver_value,"onUpdate:modelValue":u=>l.approver_value=u,placeholder:"選擇員工",multiple:""},{default:t(()=>[(v(!0),c(T,null,D(Y.value,u=>(v(),C(n,{key:u.id,label:u.name,value:u.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):l.approver_type==="role"?(v(),C(m,{key:1,modelValue:l.approver_value,"onUpdate:modelValue":u=>l.approver_value=u,placeholder:"選擇角色"},{default:t(()=>[(v(!0),c(T,null,D(G.value,u=>(v(),C(n,{key:u.id,label:u.name,value:u.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):(v(),C($,{key:2,modelValue:l.approver_value,"onUpdate:modelValue":u=>l.approver_value=u,placeholder:"userId/標籤/角色..."},null,8,["modelValue","onUpdate:modelValue"]))]),_:1}),a(p,{label:"範圍",width:"120"},{default:t(({row:l})=>[a(m,{modelValue:l.scope_type,"onUpdate:modelValue":u=>l.scope_type=u,style:{width:"110px"}},{default:t(()=>[a(n,{label:"none",value:"none"}),a(n,{label:"dept",value:"dept"}),a(n,{label:"org",value:"org"})]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:1}),a(p,{label:"必簽",width:"90"},{default:t(({row:l})=>[a(S,{modelValue:l.is_required,"onUpdate:modelValue":u=>l.is_required=u},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),a(p,{label:"需全員同意",width:"120"},{default:t(({row:l})=>[a(S,{modelValue:l.all_must_approve,"onUpdate:modelValue":u=>l.all_must_approve=u},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),a(p,{label:"允許退簽",width:"110"},{default:t(({row:l})=>[a(S,{modelValue:l.can_return,"onUpdate:modelValue":u=>l.can_return=u},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),a(p,{label:"操作",width:"120"},{default:t(({$index:l})=>[a(s,{size:"small",type:"danger",onClick:u=>pe(l)},{default:t(()=>e[38]||(e[38]=[r("刪除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"])])]),_:1}),a(B,{label:"欄位設定",name:"fields"},{default:t(()=>[F("div",Ce,[F("div",Ue,[a(m,{modelValue:d.value,"onUpdate:modelValue":e[16]||(e[16]=l=>d.value=l),placeholder:"選擇表單樣板",style:{width:"320px"},onChange:q},{default:t(()=>[(v(!0),c(T,null,D(O.value,l=>(v(),C(n,{key:l._id,label:`${l.name}（${l.category}）`,value:l._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a(s,{type:"primary",disabled:!d.value,onClick:e[17]||(e[17]=l=>H())},{default:t(()=>e[41]||(e[41]=[r("新增欄位")])),_:1},8,["disabled"])]),d.value?(v(),C(M,{key:0,data:x.value,border:""},{default:t(()=>[a(p,{type:"index",label:"#",width:"50"}),a(p,{prop:"label",label:"欄位名稱"}),a(p,{prop:"type_1",label:"型別1",width:"120"}),a(p,{prop:"type_2",label:"型別2",width:"120"}),a(p,{label:"必填",width:"80"},{default:t(({row:l})=>[a(S,{modelValue:l.required,"onUpdate:modelValue":u=>l.required=u,onChange:u=>te(l)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),a(p,{label:"排序",width:"140"},{default:t(({$index:l})=>[a(s,{size:"small",onClick:u=>K(l,-1),disabled:l===0},{default:t(()=>e[42]||(e[42]=[r("上移")])),_:2},1032,["onClick","disabled"]),a(s,{size:"small",onClick:u=>K(l,1),disabled:l===x.value.length-1},{default:t(()=>e[43]||(e[43]=[r("下移")])),_:2},1032,["onClick","disabled"])]),_:1}),a(p,{label:"操作",width:"180"},{default:t(({row:l})=>[a(s,{size:"small",onClick:u=>H("edit",l)},{default:t(()=>e[44]||(e[44]=[r("編輯")])),_:2},1032,["onClick"]),a(s,{size:"small",type:"danger",onClick:u=>oe(l)},{default:t(()=>e[45]||(e[45]=[r("刪除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])):(v(),c("div",xe,"請先從上方選擇表單樣板。"))]),a(W,{modelValue:A.value,"onUpdate:modelValue":e[25]||(e[25]=l=>A.value=l),title:L.value==="edit"?"編輯欄位":"新增欄位",width:"520px"},{footer:t(()=>[a(s,{onClick:e[24]||(e[24]=l=>A.value=!1)},{default:t(()=>e[46]||(e[46]=[r("取消")])),_:1}),a(s,{type:"primary",onClick:ae},{default:t(()=>e[47]||(e[47]=[r("儲存")])),_:1})]),default:t(()=>[a(R,{model:i.value,"label-width":"120px"},{default:t(()=>[a(_,{label:"標籤"},{default:t(()=>[a($,{modelValue:i.value.label,"onUpdate:modelValue":e[18]||(e[18]=l=>i.value.label=l)},null,8,["modelValue"])]),_:1}),a(_,{label:"型別1"},{default:t(()=>[a(m,{modelValue:i.value.type_1,"onUpdate:modelValue":e[19]||(e[19]=l=>i.value.type_1=l),placeholder:"選擇型別"},{default:t(()=>[(v(),c(T,null,D(ee,l=>a(n,{key:l,label:l,value:l},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),a(_,{label:"型別2"},{default:t(()=>[a($,{modelValue:i.value.type_2,"onUpdate:modelValue":e[20]||(e[20]=l=>i.value.type_2=l)},null,8,["modelValue"])]),_:1}),a(_,{label:"必填"},{default:t(()=>[a(S,{modelValue:i.value.required,"onUpdate:modelValue":e[21]||(e[21]=l=>i.value.required=l)},null,8,["modelValue"])]),_:1}),a(_,{label:"選項"},{default:t(()=>[a($,{modelValue:i.value.optionsStr,"onUpdate:modelValue":e[22]||(e[22]=l=>i.value.optionsStr=l),type:"textarea",rows:2,placeholder:"JSON 或以逗號分隔"},null,8,["modelValue"])]),_:1}),a(_,{label:"提示文字"},{default:t(()=>[a($,{modelValue:i.value.placeholder,"onUpdate:modelValue":e[23]||(e[23]=l=>i.value.placeholder=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})]),_:1},8,["modelValue"])])}}},Oe=ye(Se,[["__scopeId","data-v-12bfe41d"]]);export{Oe as default};
