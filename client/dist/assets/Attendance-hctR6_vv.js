import{_ as ct,r as N,j as Z,k as lt,N as ut,c as dt,b as a,d as k,v as V,w,e as Y,D as F,z as mt,o as ft,p as tt,g as R,E as J}from"./index-BrcIUlQl.js";import{a as B}from"./api-Dn_BGH9X.js";const K={},U=(K==null?void 0:K.VITE_TIMEZONE)||"Asia/Taipei",H=60*1e3,at=24*60*60*1e3,pt=Object.freeze({clockIn:{earlyMinutes:60,lateMinutes:240},clockOut:{earlyMinutes:240,lateMinutes:120}}),gt=Object.freeze({clockIn:"上班簽到",clockOut:"下班簽退"});function q(t){const n=Number(t);return Number.isFinite(n)?n:NaN}function et(t){if(!t||typeof t!="string")return null;const n=t.trim().match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);if(!n)return null;const i=q(n[1]),s=q(n[2]),r=n[3]?q(n[3]):0;return Number.isNaN(i)||Number.isNaN(s)||Number.isNaN(r)||i<0||i>=24||s<0||s>=60||r<0||r>=60?null:{hour:i,minute:s,second:r}}function G(t,n=U){const{year:i,month:s,day:r,hour:d=0,minute:c=0,second:l=0}=t||{};if(!i||!s||!r)return null;const m=Date.UTC(i,s-1,r,d,c,l),I=new Date(m),p=new Intl.DateTimeFormat("en-US",{timeZone:n,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(I).reduce((h,M)=>(M.type!=="literal"&&(h[M.type]=M.value),h),{}),T=Date.UTC(Number(p.year),Number(p.month)-1,Number(p.day),Number(p.hour),Number(p.minute),Number(p.second))-I.getTime();return new Date(m-T)}function Q(t,n=U){if(!t)return null;const s=new Intl.DateTimeFormat("en-US",{timeZone:n,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(new Date(t)).reduce((l,m)=>(m.type!=="literal"&&(l[m.type]=m.value),l),{}),r=Number(s.year),d=Number(s.month),c=Number(s.day);return!r||!d||!c?null:{year:r,month:d,day:c}}function nt({year:t,month:n,day:i}){return!t||!n||!i?null:new Date(Date.UTC(t,n-1,i))}function ht(t,n=U){if(!t&&t!==0)return null;if(t instanceof Date)return new Date(t);if(typeof t=="string"){const s=t.trim().match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);if(!s)return null;const r=Number(s[1]),d=Number(s[2]),c=Number(s[3]);return!r||!d||!c?null:new Date(Date.UTC(r,d-1,c))}return null}function bt(t,n,i=U){if(!t||!n)return null;const s=Q(t,i),r=et(n.startTime),d=et(n.endTime);if(!s||!r||!d)return null;const c=G({...s,...r},i);let l=G({...s,...d},i);return!c||!l?null:((n.crossDay||l<=c)&&(l=new Date(l.getTime()+at)),{start:c,end:l})}function yt(t,n,i){if(!n||!i)return null;const s=pt[t];if(!s)return null;const{earlyMinutes:r,lateMinutes:d}=s;if(t==="clockIn"){const c=new Date(n.getTime()-r*H),l=new Date(n.getTime()+d*H),m=l<i?l:i;return{start:c,end:m}}if(t==="clockOut"){const c=new Date(i.getTime()-r*H),l=c>n?c:n,m=new Date(i.getTime()+d*H);return{start:l,end:m}}return null}function vt(t,n){if(!t||!n)return!1;const i=new Date(t).getTime();return Number.isNaN(i)?!1:i>=n.start.getTime()&&i<=n.end.getTime()}function kt(t,n=U){if(!t)return null;const i=new Intl.DateTimeFormat("zh-TW",{timeZone:n,hour:"2-digit",minute:"2-digit",hour12:!1});return{start:i.format(t.start),end:i.format(t.end)}}function wt(t){return t&&typeof t=="object"&&typeof t.toString=="function"?t.toString():t||t===0?String(t):""}function ot({now:t=new Date,schedules:n=[],shifts:i=[],timeZone:s=U}={}){const r=new Map;i.forEach(u=>{u!=null&&u._id&&r.set(String(u._id),u)});const d=[];n.forEach(u=>{const b=ht(u.date,s);if(!b)return;const g=wt(u.shiftId),S=r.get(g);if(!S)return;const D=bt(b,S,s);D&&d.push({schedule:u,shift:S,scheduleDate:b,shiftStart:D.start,shiftEnd:D.end})});const c=Q(t,s),l=c?nt(c):null,m=c?G(c,s):null,I=m?new Date(m.getTime()-at):null,O=I?Q(I,s):null,p=O?nt(O):null;if(!d.length)return{context:null,actions:{clockIn:{disabled:!0,reason:"今日未設定班表，無法打卡",window:null,formatted:null},clockOut:{disabled:!0,reason:"今日未設定班表，無法打卡",window:null,formatted:null}},timeZone:s};const A=l==null?void 0:l.getTime(),T=p==null?void 0:p.getTime(),h=t.getTime(),M=d.find(u=>h>=u.shiftStart.getTime()&&h<=u.shiftEnd.getTime()),W=d.find(u=>A!==void 0&&u.scheduleDate.getTime()===A),L=d.find(u=>T!==void 0&&u.scheduleDate.getTime()===T),x=M||W||L||d[0],P={};return["clockIn","clockOut"].forEach(u=>{const b=yt(u,x.shiftStart,x.shiftEnd);if(!b){P[u]={disabled:!0,reason:"班別尚未設定簽到簽退時間",window:null,formatted:null};return}const g=kt(b,s),S=vt(t,b),D=h<b.start.getTime(),C=gt[u]||u;let E;S?E=g?`${C}開放時段：${g.start} ~ ${g.end}`:`${C}開放中`:D?E=g?`${C}尚未開放，允許時段為 ${g.start} ~ ${g.end}`:`${C}尚未開放`:E=g?`${C}時段已結束，允許時段為 ${g.start} ~ ${g.end}`:`${C}時段已結束`,P[u]={disabled:!S,reason:E,window:b,formatted:g}}),{context:x,actions:P,timeZone:s}}function Tt(){return U}const Dt={class:"attendance-page"},_t={class:"page-header"},Nt={class:"current-time"},It={class:"time-display"},Mt={class:"date-display"},St={class:"punch-section"},Ct={class:"punch-grid"},Ot={class:"records-section"},At={class:"table-container"},Et={class:"time-cell"},Yt={class:"remark-text"},Ut={class:"dialog-footer"},$t={__name:"Attendance",setup(t){const n={上班簽到:"clockIn",下班簽退:"clockOut",外出登記:"outing",中午休息:"breakIn"},i=Object.fromEntries(Object.entries(n).map(([o,e])=>[e,o])),s=N([]),r=N(""),d=N("");let c=null;const l=N(!1),m=N(""),I=N(""),O=N([]),p=N([]),A=N(ot()),T=Z(()=>{var o;return((o=A.value.actions)==null?void 0:o.clockIn)||{disabled:!0,reason:"今日未設定班表，無法打卡"}}),h=Z(()=>{var o;return((o=A.value.actions)==null?void 0:o.clockOut)||{disabled:!0,reason:"今日未設定班表，無法打卡"}});function M(o=new Date){A.value=ot({now:o,schedules:p.value,shifts:O.value,timeZone:Tt()})}async function W(){const o=await B("/api/attendance");if(o.ok){const e=await o.json();s.value=e.map(f=>{const y=f.timestamp;return{action:i[f.action]||f.action,time:y?F(y).format("YYYY/MM/DD HH:mm:ss"):"",remark:f.remark||"",timestamp:y}})}}async function L(){try{const o=await B("/api/shifts");if(!o.ok)throw new Error("failed");const e=await o.json().catch(()=>[]);O.value=Array.isArray(e)?e:[]}catch(o){console.error(o),O.value=[]}}async function x(){const o=E();if(!o){p.value=[];return}try{const e=F().format("YYYY-MM"),f=new URLSearchParams({month:e,employee:o}),y=await B(`/api/schedules/monthly?${f.toString()}`);if(!y.ok)throw new Error("failed");const _=await y.json().catch(()=>[]);p.value=Array.isArray(_)?_:[]}catch(e){console.error(e),p.value=[]}}async function P(){await Promise.all([L(),x()]),M(new Date)}function u(){if(T.value.disabled){J.warning(T.value.reason);return}D("上班簽到")}function b(){if(h.value.disabled){J.warning(h.value.reason);return}D("下班簽退")}function g(){D("外出登記")}function S(){D("中午休息")}function D(o){I.value=o,m.value="",l.value=!0}async function C(){l.value=!1,await st(I.value,m.value)}function E(){let o=localStorage.getItem("employeeId");if(!o){const e=mt();if(e)try{const f=JSON.parse(atob(e.split(".")[1]));o=f.employeeId||f.id}catch{o=null}}return o}async function st(o,e=""){const f=E();if(!f){J.warning("請重新登入");return}const y={action:n[o]||o,timestamp:new Date,remark:e,employee:f},_=await B("/api/attendance",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(y)});if(_.ok){const $=await _.json(),j=$.timestamp||y.timestamp,z={action:i[$.action]||$.action,time:j?F(j).format("YYYY/MM/DD HH:mm:ss"):"",remark:$.remark||"",timestamp:j};s.value.unshift(z)}}function X(){const o=F();r.value=o.format("HH:mm:ss"),d.value=o.format("YYYY/MM/DD"),M(o.toDate())}function it(o){return{上班簽到:"success",下班簽退:"warning",外出登記:"info",中午休息:"primary"}[o]||"default"}return lt(()=>{W(),P(),X(),c=setInterval(X,1e3)}),ut(()=>{c&&clearInterval(c)}),(o,e)=>{const f=Y("el-tooltip"),y=Y("el-tag"),_=Y("el-table-column"),$=Y("el-table"),j=Y("el-input"),z=Y("el-button"),rt=Y("el-dialog");return ft(),dt("div",Dt,[a("div",_t,[e[3]||(e[3]=a("div",{class:"header-content"},[a("h1",{class:"page-title"},"出勤打卡"),a("p",{class:"page-description"},"快速進行上下班打卡、外出登記和補卡操作")],-1)),a("div",Nt,[a("div",It,V(r.value),1),a("div",Mt,V(d.value),1)])]),a("div",St,[e[8]||(e[8]=a("h2",{class:"section-title"},"快速打卡",-1)),a("div",Ct,[k(f,{disabled:!T.value.reason,content:T.value.reason,placement:"bottom"},{default:w(()=>[a("div",{class:tt(["punch-card",{disabled:T.value.disabled}]),onClick:u},e[4]||(e[4]=[a("div",{class:"punch-icon clock-in"},[a("i",{class:"el-icon-sunrise"})],-1),a("h3",{class:"punch-title"},"上班簽到",-1),a("p",{class:"punch-desc"},"開始新的一天",-1)]),2)]),_:1},8,["disabled","content"]),k(f,{disabled:!h.value.reason,content:h.value.reason,placement:"bottom"},{default:w(()=>[a("div",{class:tt(["punch-card",{disabled:h.value.disabled}]),onClick:b},e[5]||(e[5]=[a("div",{class:"punch-icon clock-out"},[a("i",{class:"el-icon-sunset"})],-1),a("h3",{class:"punch-title"},"下班簽退",-1),a("p",{class:"punch-desc"},"結束工作時間",-1)]),2)]),_:1},8,["disabled","content"]),a("div",{class:"punch-card",onClick:g},e[6]||(e[6]=[a("div",{class:"punch-icon outing"},[a("i",{class:"el-icon-position"})],-1),a("h3",{class:"punch-title"},"外出登記",-1),a("p",{class:"punch-desc"},"臨時外出記錄",-1)])),a("div",{class:"punch-card",onClick:S},e[7]||(e[7]=[a("div",{class:"punch-icon break-time"},[a("i",{class:"el-icon-coffee-cup"})],-1),a("h3",{class:"punch-title"},"休息時間",-1),a("p",{class:"punch-desc"},"中午休息登記",-1)]))])]),a("div",Ot,[e[10]||(e[10]=a("h2",{class:"section-title"},"今日打卡記錄",-1)),a("div",At,[k($,{data:s.value,class:"records-table","header-cell-style":{background:"#f8fafc",color:"#475569",fontWeight:"600"},"row-style":{height:"56px"}},{default:w(()=>[k(_,{prop:"action",label:"打卡類型",width:"140"},{default:w(({row:v})=>[k(y,{type:it(v.action),class:"action-tag"},{default:w(()=>[R(V(v.action),1)]),_:2},1032,["type"])]),_:1}),k(_,{prop:"time",label:"打卡時間",width:"200"},{default:w(({row:v})=>[a("div",Et,[e[9]||(e[9]=a("i",{class:"el-icon-time time-icon"},null,-1)),R(" "+V(v.time),1)])]),_:1}),k(_,{prop:"remark",label:"備註說明"},{default:w(({row:v})=>[a("span",Yt,V(v.remark||"無備註"),1)]),_:1})]),_:1},8,["data"])])]),k(rt,{modelValue:l.value,"onUpdate:modelValue":e[2]||(e[2]=v=>l.value=v),title:"新增備註",width:"400px"},{footer:w(()=>[a("span",Ut,[k(z,{onClick:e[1]||(e[1]=v=>l.value=!1)},{default:w(()=>e[11]||(e[11]=[R("取消")])),_:1}),k(z,{type:"primary",onClick:C},{default:w(()=>e[12]||(e[12]=[R("確認")])),_:1})])]),default:w(()=>[k(j,{modelValue:m.value,"onUpdate:modelValue":e[0]||(e[0]=v=>m.value=v),placeholder:"請輸入備註（可留空）"},null,8,["modelValue"])]),_:1},8,["modelValue"])])}}},jt=ct($t,[["__scopeId","data-v-1390b53d"]]);export{jt as default};
