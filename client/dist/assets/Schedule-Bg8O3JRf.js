import{_ as O,r as f,v as g,m as A,g as z,c as u,d as M,a as k,b as m,w as S,x as y,o as i,F as T,i as j,h as b,t as N}from"./index-BZkZtvsR.js";import{a as _}from"./api-ZZnZ46lj.js";const U={class:"schedule-page"},Y={key:1},F={key:1},J={__name:"Schedule",setup(P){const p=f(g().format("YYYY-MM")),l=f({}),$=f([]),v=f([]),x=A(()=>{const o=localStorage.getItem("role")||"employee";return["supervisor","admin"].includes(o)}),w=A(()=>{const e=g(p.value+"-01").endOf("month").date();return Array.from({length:e},(t,s)=>s+1)});async function C(){const o=y()||"",e=await _("/api/attendance-settings",{headers:{Authorization:`Bearer ${o}`}});if(e.ok){const t=await e.json();Array.isArray(t.shifts)&&($.value=t.shifts.map(s=>s.name))}}async function B(){const o=y()||"",e=localStorage.getItem("employeeId")||"",t=await _(`/api/schedules/monthly?month=${p.value}&supervisor=${e}`,{headers:{Authorization:`Bearer ${o}`}});if(t.ok){const s=await t.json(),h=w.value;l.value={},v.value.forEach(a=>{l.value[a._id]={},h.forEach(c=>{l.value[a._id][c]={shiftType:""}})}),s.forEach(a=>{var r;const c=((r=a.employee)==null?void 0:r._id)||a.employee,n=g(a.date).date();l.value[c][n]={id:a._id,shiftType:a.shiftType}})}}async function I(o,e,t){const s=y()||"",h=`${p.value}-${String(e).padStart(2,"0")}`,a=l.value[o][e];if(a&&a.id)await _(`/api/schedules/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({shiftType:t})});else{const c=await _("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({employee:o,date:h,shiftType:t})});if(c.ok){const n=await c.json();l.value[o][e]={id:n._id,shiftType:n.shiftType}}}}async function E(){const o=y()||"",e=localStorage.getItem("employeeId")||"",t=await _(`/api/employees?supervisor=${e}`,{headers:{Authorization:`Bearer ${o}`}});t.ok&&(v.value=await t.json())}return z(async()=>{await C(),await E(),await B()}),(o,e)=>{const t=m("el-date-picker"),s=m("el-table-column"),h=m("el-option"),a=m("el-select"),c=m("el-table");return i(),u("div",U,[e[1]||(e[1]=M("h2",null,"排班管理",-1)),k(t,{modelValue:p.value,"onUpdate:modelValue":e[0]||(e[0]=n=>p.value=n),type:"month",onChange:B},null,8,["modelValue"]),k(c,{data:v.value,style:{"margin-top":"20px"}},{default:S(()=>[k(s,{prop:"name",label:"員工"}),(i(!0),u(T,null,j(w.value,n=>(i(),b(s,{key:n,label:n},{default:S(({row:r})=>{var V;return[l.value[r._id]?(i(),u(T,{key:0},[x.value?(i(),b(a,{key:0,modelValue:l.value[r._id][n].shiftType,"onUpdate:modelValue":d=>l.value[r._id][n].shiftType=d,placeholder:"",onChange:d=>I(r._id,n,d)},{default:S(()=>[(i(!0),u(T,null,j($.value,d=>(i(),b(h,{key:d,label:d,value:d},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])):(i(),u("span",Y,N(((V=l.value[r._id][n])==null?void 0:V.shiftType)||""),1))],64)):(i(),u("span",F,"-"))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])])}}},q=O(J,[["__scopeId","data-v-e88f619d"]]);export{q as default};
