import{_ as ae,r as i,D as P,j as N,k as se,c,b as l,d as b,n as m,q as le,w as p,e as u,F as h,t as g,E as T,o as r,g as ne,v,p as re}from"./index-BrcIUlQl.js";import{a as x}from"./api-Dn_BGH9X.js";const oe={class:"schedule-overview-page"},ie={class:"filters-grid"},ce={class:"filter-item"},de={class:"filter-item"},ue={class:"filter-item"},me={class:"filter-item"},pe={key:3,class:"overview-results"},ve={class:"organization-header"},fe={class:"organization-title"},_e={class:"organization-meta"},be={class:"department-header"},he={class:"department-title"},ge={class:"department-meta"},ye={class:"unit-header"},ke={class:"unit-title"},we={class:"unit-meta"},De={class:"unit-table-wrapper"},Ve={__name:"ScheduleOverview",setup(ze){const V=i(P().format("YYYY-MM")),y=i(""),f=i(""),_=i(""),U=i([]),z=i([]),B=i([]),E=i(!1),D=i(""),C=i([]),S=i([]),L=i(!1);let A=0;const d=t=>{if(!t&&t!==0)return"";if(typeof t=="string")return t;if(typeof t=="object"){if(t!=null&&t._id)return String(t._id);if(t!=null&&t.id)return String(t.id)}return String(t)},$=N(()=>{const t=y.value;return t?z.value.filter(e=>d(e.organization)===t):z.value}),q=N(()=>{const t=f.value,e=y.value;return B.value.filter(n=>{const a=d(n.department);if(t)return a===t;if(!e)return!0;const o=z.value.find(k=>d(k._id)===a);return o?d(o.organization)===e:!1})}),H=N(()=>S.value.some(t=>t.departments.some(e=>e.subDepartments.some(n=>n.employees.length)))),G=t=>{const e=P(t);return e.isValid()?e.format("MM/DD"):t},J=t=>t.employees.map(e=>{const n={};return C.value.forEach(a=>{n[a]=""}),e.schedules.forEach(a=>{const o=a.date;n[o]||(n[o]=a.shiftName||"")}),{id:e.id,name:e.name,title:e.title||"",entries:n}}).sort((e,n)=>e.name.localeCompare(n.name,"zh-Hant",{sensitivity:"base"}));async function M(t,e){if(!t.ok){let n=e;try{const a=await t.json();n=(a==null?void 0:a.error)||(a==null?void 0:a.message)||n}catch{}throw new Error(n)}return t.json()}async function K(){try{const[t,e,n]=await Promise.all([x("/api/organizations"),x("/api/departments"),x("/api/sub-departments")]),[a,o,k]=await Promise.all([M(t,"無法載入機構資料"),M(e,"無法載入部門資料"),M(n,"無法載入小單位資料")]);U.value=Array.isArray(a)?a:[],z.value=Array.isArray(o)?o:[],B.value=Array.isArray(k)?k:[],L.value=!0}catch(t){const e=(t==null?void 0:t.message)||"無法載入必要資料";D.value=e,T.error(e)}}async function O(){if(!L.value||!V.value)return;const t=++A;E.value=!0,D.value="";try{const e=new URLSearchParams({month:V.value});y.value&&e.set("organization",y.value),f.value&&e.set("department",f.value),_.value&&e.set("subDepartment",_.value);const n=await x(`/api/schedules/overview?${e.toString()}`),a=await M(n,"無法載入班表總覽資料");if(t!==A)return;C.value=Array.isArray(a==null?void 0:a.days)?a.days:[],S.value=Array.isArray(a==null?void 0:a.organizations)?a.organizations:[]}catch(e){if(t!==A)return;const n=(e==null?void 0:e.message)||"載入班表總覽失敗";D.value=n,S.value=[],C.value=[],T.error(n)}finally{t===A&&(E.value=!1)}}function F(){O()}function Q(){$.value.some(t=>d(t._id)===f.value)||(f.value=""),_.value="",O()}function W(){q.value.some(t=>d(t._id)===_.value)||(_.value=""),O()}return se(async()=>{await K(),await O()}),(t,e)=>{const n=u("el-date-picker"),a=u("el-option"),o=u("el-select"),k=u("el-card"),X=u("el-alert"),Z=u("el-skeleton"),ee=u("el-empty"),j=u("el-table-column"),te=u("el-table");return r(),c("div",oe,[e[9]||(e[9]=l("div",{class:"page-header"},[l("h1",{class:"page-title"},"班表總覽"),l("p",{class:"page-subtitle"},"依照機構、部門與小單位快速檢視每月排班狀態")],-1)),b(k,{class:"filters-card",shadow:"never"},{header:p(()=>e[4]||(e[4]=[l("div",{class:"filters-header"},"篩選條件",-1)])),default:p(()=>[l("div",ie,[l("div",ce,[e[5]||(e[5]=l("label",{class:"filter-label"},"月份",-1)),b(n,{modelValue:V.value,"onUpdate:modelValue":e[0]||(e[0]=s=>V.value=s),type:"month","value-format":"YYYY-MM",placeholder:"選擇月份",class:"filter-control",onChange:F},null,8,["modelValue"])]),l("div",de,[e[6]||(e[6]=l("label",{class:"filter-label"},"機構",-1)),b(o,{modelValue:y.value,"onUpdate:modelValue":e[1]||(e[1]=s=>y.value=s),placeholder:"全部機構",clearable:"",class:"filter-control",onChange:Q},{default:p(()=>[(r(!0),c(h,null,g(U.value,s=>(r(),m(a,{key:s._id||s.id,label:s.name,value:d(s._id||s.id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),l("div",ue,[e[7]||(e[7]=l("label",{class:"filter-label"},"部門",-1)),b(o,{modelValue:f.value,"onUpdate:modelValue":e[2]||(e[2]=s=>f.value=s),placeholder:"全部部門",clearable:"",class:"filter-control",onChange:W},{default:p(()=>[(r(!0),c(h,null,g($.value,s=>(r(),m(a,{key:s._id,label:s.name,value:d(s._id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),l("div",me,[e[8]||(e[8]=l("label",{class:"filter-label"},"小單位",-1)),b(o,{modelValue:_.value,"onUpdate:modelValue":e[3]||(e[3]=s=>_.value=s),placeholder:"全部小單位",clearable:"",class:"filter-control",onChange:F},{default:p(()=>[(r(!0),c(h,null,g(q.value,s=>(r(),m(a,{key:s._id,label:s.name,value:d(s._id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])]),_:1}),D.value?(r(),m(X,{key:0,type:"error",closable:!1,"show-icon":"",class:"message-block"},{default:p(()=>[ne(v(D.value),1)]),_:1})):le("",!0),E.value?(r(),m(Z,{key:1,animated:"",rows:4,class:"overview-skeleton"})):H.value?(r(),c("div",pe,[(r(!0),c(h,null,g(S.value,s=>(r(),c("section",{key:s.id,class:"organization-block","data-test":"organization-block"},[l("header",ve,[l("h2",fe,v(s.name),1),l("span",_e,v(s.departments.length)+" 個部門",1)]),(r(!0),c(h,null,g(s.departments,R=>(r(),c("article",{key:R.id,class:"department-block","data-test":"department-block"},[l("header",be,[l("h3",he,v(R.name),1),l("span",ge,v(R.subDepartments.length)+" 個小單位",1)]),(r(!0),c(h,null,g(R.subDepartments,w=>(r(),c("div",{key:w.id,class:"unit-card","data-test":"subdepartment-block"},[l("div",ye,[l("h4",ke,v(w.name),1),l("span",we,v(w.employees.length)+" 位人員",1)]),l("div",De,[(r(),m(te,{data:J(w),border:"",stripe:"",class:"overview-table",key:`${w.id}-table`},{default:p(()=>[b(j,{prop:"name",label:"姓名",fixed:"left","min-width":"140"}),b(j,{prop:"title",label:"職稱","min-width":"140"}),(r(!0),c(h,null,g(C.value,Y=>(r(),m(j,{key:`${w.id}-${Y}`,label:G(Y),"min-width":110},{default:p(({row:I})=>[l("span",{class:re(["shift-label",{empty:!I.entries[Y]}])},v(I.entries[Y]||"—"),3)]),_:2},1032,["label"]))),128))]),_:2},1032,["data"]))])]))),128))]))),128))]))),128))])):(r(),m(ee,{key:2,description:"目前沒有符合條件的班表資料",class:"empty-state"}))])}}},Ae=ae(Ve,[["__scopeId","data-v-89f326be"]]);export{Ae as default};
