import{_ as we,r as _,j as h,D as ae,y as le,m as te,k as _e,E as b,c as W,b as c,d as A,n as j,q as U,w as x,e as L,o as m,F as Y,t as $,g as re,v as ne}from"./index-BkCwXqkM.js";import{a as N}from"./api-747mdiEG.js";const xe={class:"department-reports-page"},ke={class:"filters-grid"},Se={class:"filter-item"},We={class:"filter-item"},Ae={class:"filter-item"},Le={class:"filter-item"},Ee={class:"actions"},Me={key:0,class:"summary-grid"},je={class:"summary-label"},Ce={class:"summary-value"},Re={__name:"DepartmentReports",setup(Ve){const f=_([]),C=_(""),E=_(""),H=_([]),I=_(Q()),se=h(()=>I.value==="admin"),J=h(()=>I.value==="supervisor"),M=_(ae().format("YYYY-MM")),y=_(""),o=_(""),k=_(""),R=_(!1),r=le({loading:!1,state:"idle",summary:null,records:[]}),g=le({departments:!1,templates:!1}),V={attendance:"/api/reports/department/attendance/export",leave:"/api/reports/department/leave/export",tardiness:"/api/reports/department/tardiness/export",earlyLeave:"/api/reports/department/early-leave/export",workHours:"/api/reports/department/work-hours/export",overtime:"/api/reports/department/overtime/export",compTime:"/api/reports/department/comp-time/export",makeUp:"/api/reports/department/make-up/export",specialLeave:"/api/reports/department/special-leave/export"},K={excel:"Excel (.xlsx)",pdf:"PDF (.pdf)"},oe={excel:"xlsx",pdf:"pdf"},q=h(()=>!!(y.value&&f.value.some(l=>String(l==null?void 0:l._id)===String(y.value)))),ue=h(()=>{const l=new Map;return H.value.forEach(a=>{a!=null&&a.type&&!l.has(a.type)&&l.set(a.type,a)}),l}),B=h(()=>{const l=[],a=new Set;return H.value.forEach(n=>{var u,i;const e=n==null?void 0:n.type;if(!e||a.has(e)||!V[e])return;const d=((i=(u=n==null?void 0:n.name)==null?void 0:u.trim)==null?void 0:i.call(u))||e;l.push({value:e,label:d}),a.add(e)}),l}),O=h(()=>o.value&&ue.value.get(o.value)||null),F=h(()=>{const l=O.value;if(!l)return[];const a=new Set;return(Array.isArray(l.exportFormats)?l.exportFormats:[]).map(e=>typeof e=="string"?e.trim().toLowerCase():"").filter(e=>!e||!K[e]||a.has(e)?!1:(a.add(e),!0)).map(e=>({value:e,label:K[e]}))}),P=h(()=>!M.value||!q.value||!o.value||!V[o.value]?!1:F.value.some(l=>l.value===k.value)),z=h(()=>!!(M.value&&q.value&&o.value&&V[o.value]&&O.value));te(B,l=>{if(!Array.isArray(l)||l.length===0){o.value="";return}l.some(n=>n.value===o.value)||(o.value=l[0].value)},{immediate:!0}),te(F,l=>{if(!Array.isArray(l)||l.length===0){k.value="";return}l.some(n=>n.value===k.value)||(k.value=l[0].value)},{immediate:!0});const ie=h(()=>o.value==="attendance"?[{prop:"scheduled",label:"排班天數",minWidth:120},{prop:"attended",label:"出勤天數",minWidth:120},{prop:"absent",label:"缺勤天數",minWidth:120}]:o.value==="leave"?[{prop:"leaveType",label:"假別",minWidth:160},{prop:"startDate",label:"開始日期",minWidth:140},{prop:"endDate",label:"結束日期",minWidth:140},{prop:"days",label:"天數",minWidth:100}]:o.value==="tardiness"?[{prop:"date",label:"日期",minWidth:140},{prop:"scheduledStart",label:"排定上班",minWidth:140},{prop:"actualClockIn",label:"實際打卡",minWidth:140},{prop:"minutesLate",label:"遲到分鐘",minWidth:120}]:o.value==="earlyLeave"?[{prop:"date",label:"日期",minWidth:140},{prop:"scheduledEnd",label:"排定下班",minWidth:140},{prop:"actualClockOut",label:"實際打卡",minWidth:140},{prop:"minutesEarly",label:"早退分鐘",minWidth:120}]:o.value==="workHours"?[{prop:"date",label:"日期",minWidth:140},{prop:"scheduledHours",label:"排定工時(小時)",minWidth:160},{prop:"workedHours",label:"實際工時(小時)",minWidth:160},{prop:"differenceHours",label:"差異(小時)",minWidth:140}]:o.value==="overtime"?[{prop:"date",label:"日期",minWidth:140},{prop:"startTime",label:"開始時間",minWidth:120},{prop:"endTime",label:"結束時間",minWidth:120},{prop:"hours",label:"時數",minWidth:100},{prop:"reason",label:"原因",minWidth:180}]:o.value==="compTime"?[{prop:"date",label:"日期",minWidth:140},{prop:"hours",label:"補休時數",minWidth:120},{prop:"overtimeReference",label:"來源加班單",minWidth:180}]:o.value==="makeUp"?[{prop:"date",label:"日期",minWidth:140},{prop:"category",label:"補卡類別",minWidth:160},{prop:"note",label:"補卡說明",minWidth:200}]:o.value==="specialLeave"?[{prop:"startDate",label:"開始日期",minWidth:140},{prop:"endDate",label:"結束日期",minWidth:140},{prop:"days",label:"天數",minWidth:100}]:[]),de=h(()=>{if(!r.summary)return[];if(o.value==="attendance")return[{label:"排班總計",value:r.summary.scheduled},{label:"出勤總計",value:r.summary.attended},{label:"缺勤總計",value:r.summary.absent}];if(o.value==="leave"){const l=[{label:"總請假件數",value:r.summary.totalLeaves},{label:"總請假天數",value:r.summary.totalDays}],a=Array.isArray(r.summary.byType)?r.summary.byType.map(n=>({label:`${n.leaveType||n.leaveCode} 件數`,value:`${n.count??0} 筆 / ${n.days??0} 天`})):[];return[...l,...a]}if(o.value==="tardiness")return[{label:"遲到件數",value:r.summary.totalLateCount??0},{label:"遲到總分鐘",value:r.summary.totalLateMinutes??0},{label:"平均遲到分鐘",value:r.summary.averageLateMinutes??0}];if(o.value==="earlyLeave")return[{label:"早退件數",value:r.summary.totalEarlyLeaveCount??0},{label:"早退總分鐘",value:r.summary.totalEarlyMinutes??0},{label:"平均早退分鐘",value:r.summary.averageEarlyMinutes??0}];if(o.value==="workHours")return[{label:"排定總工時",value:r.summary.totalScheduledHours??0},{label:"實際總工時",value:r.summary.totalWorkedHours??0},{label:"工時差異",value:r.summary.differenceHours??0}];if(o.value==="overtime")return[{label:"加班申請數",value:r.summary.totalRequests??0},{label:"加班總時數",value:r.summary.totalHours??0}];if(o.value==="compTime")return[{label:"補休申請數",value:r.summary.totalRequests??0},{label:"補休總時數",value:r.summary.totalHours??0}];if(o.value==="makeUp"){const l=[{label:"補卡申請數",value:r.summary.totalRequests??0}],a=Array.isArray(r.summary.byCategory)?r.summary.byCategory.map(n=>({label:`${n.label??"未分類"} 件數`,value:`${n.count??0} 筆`})):[];return[...l,...a]}return o.value==="specialLeave"?[{label:"特休申請數",value:r.summary.totalRequests??0},{label:"特休總天數",value:r.summary.totalDays??0}]:[]});_e(async()=>{I.value=Q(),g.departments=!0,g.templates=!0;try{J.value?await me():(C.value="",E.value=""),await pe(),await ve()}catch(l){b.error(l.message||"載入主管報表資訊失敗")}finally{g.departments=!1,g.templates=!1}});const ce=()=>{var n,e;if(typeof window>"u")return"";const l=(n=window.sessionStorage)==null?void 0:n.getItem("employeeId");if(l&&l!=="undefined")return l;const a=(e=window.localStorage)==null?void 0:e.getItem("employeeId");return a&&a!=="undefined"?a:""};function Q(){var n,e;if(typeof window>"u")return"";const l=(n=window.sessionStorage)==null?void 0:n.getItem("role");if(l&&l!=="undefined")return l;const a=(e=window.localStorage)==null?void 0:e.getItem("role");return a&&a!=="undefined"?a:""}async function me(){if(!J.value){C.value="",E.value="";return}const l=ce();if(!l){C.value="",E.value="",b.warning("尚未取得登入者資料，請重新登入後再試");return}const a=await N(`/api/employees/${l}`);if(!a.ok)throw new Error("無法取得主管資訊");const n=await a.json(),e=n==null?void 0:n.department,d=typeof e=="object"?(e==null?void 0:e._id)||(e==null?void 0:e.id)||(e==null?void 0:e.value):e,u=typeof e=="object"?(e==null?void 0:e.name)||"":(n==null?void 0:n.departmentName)||"";C.value=d?String(d):"",E.value=u?String(u):""}async function pe(){const l=await N("/api/departments");if(!l.ok)throw new Error("無法取得部門清單");const a=await l.json(),n=Array.isArray(a)?a.map(t=>{const p=(t==null?void 0:t._id)??(t==null?void 0:t.id)??(t==null?void 0:t.value)??(typeof t=="string"?t:""),v=(t==null?void 0:t.name)??(t==null?void 0:t.label)??(t==null?void 0:t.departmentName)??"";return{...t,_id:p?String(p):"",name:String(v||(t==null?void 0:t.name)||"")}}):[];if(se.value){const t=n.filter(s=>s==null?void 0:s._id);if(f.value=t,!f.value.length){y.value="",b.warning("目前沒有可供查詢的部門資料，請先建立部門資訊");return}const p=y.value,v=p?f.value.find(s=>s._id===p):null;y.value=(v==null?void 0:v._id)||f.value[0]._id||"";return}if(!C.value&&!E.value){f.value=[],y.value="",b.warning("尚未為您設定可管理的部門，請聯絡系統管理員");return}const e=C.value,d=E.value.trim().toLowerCase();let u=n.filter(t=>{const p=String((t==null?void 0:t._id)||""),v=String((t==null?void 0:t.name)||"").trim().toLowerCase();return e&&p===e||d&&v&&v===d});if(!u.length&&e&&(u=[{_id:e,name:E.value||"主管部門"}]),u=u.filter(t=>t==null?void 0:t._id),f.value=u,!f.value.length){y.value="",b.warning("未找到與您相符的部門，請聯絡系統管理員");return}const i=f.value.find(t=>t._id===e);y.value=(i==null?void 0:i._id)||f.value[0]._id||""}async function ve(){const l=await N("/api/reports/department/templates");if(!l.ok)throw new Error("無法取得主管報表設定");const a=await l.json(),n=Array.isArray(a)?a.map(e=>{var D;const d=(e==null?void 0:e.id)??(e==null?void 0:e._id)??"",u=typeof(e==null?void 0:e.type)=="string"?e.type.trim():"",i=typeof(e==null?void 0:e.name)=="string"?e.name.trim():"",p=(Array.isArray((D=e==null?void 0:e.exportSettings)==null?void 0:D.formats)?e.exportSettings.formats:Array.isArray(e==null?void 0:e.exportFormats)?e.exportFormats:[]).map(S=>typeof S=="string"?S.trim().toLowerCase():"").filter(Boolean),v=e!=null&&e.permissionSettings&&typeof e.permissionSettings=="object"?{...e.permissionSettings}:{},s=e!=null&&e.exportSettings&&typeof e.exportSettings=="object"?{...e.exportSettings}:{formats:[]};return{id:d?String(d):"",type:u,name:i||u,exportFormats:p,permissionSettings:v,exportSettings:s}}).filter(e=>e.type):[];H.value=n,n.length||(o.value="",k.value="",b.warning("目前沒有開放的主管報表模板"))}function G(){return q.value?!0:(b.warning("目前無可操作的部門，請確認您的部門權限設定"),!1)}function X(l){return`?${new URLSearchParams(l).toString()}`}async function fe(){var a,n;if(!z.value&&!G()||!z.value)return;const l=V[o.value];if(!l){b.warning("此報表尚未開放預覽");return}r.loading=!0,r.state="loading";try{const e=X({month:M.value,department:y.value,format:"json"}),d=await N(`${l}${e}`,{headers:{Accept:"application/json"}}),u=((n=(a=d.headers)==null?void 0:a.get)==null?void 0:n.call(a,"content-type"))||"";if(!d.ok){const t=u.includes("application/json")?await d.json():null;throw new Error((t==null?void 0:t.error)||(t==null?void 0:t.message)||"預覽失敗")}if(!u.includes("application/json")){r.state="idle",r.summary=null,r.records=[],b.info("此報表不提供預覽，請直接匯出");return}const i=await d.json();r.summary=(i==null?void 0:i.summary)??null,r.records=Array.isArray(i==null?void 0:i.records)?i.records:[],!r.records.length&&!r.summary?r.state="empty":r.state="success"}catch(e){r.state="idle",r.summary=null,r.records=[],b.error(e.message||"預覽失敗")}finally{r.loading=!1}}async function ye(){var a,n,e,d;if(R.value||!P.value&&!G()||!P.value)return;const l=V[o.value];if(!l){b.error("尚未提供此報表的匯出服務");return}R.value=!0;try{const u=X({month:M.value,department:y.value,format:k.value}),i=await N(`${l}${u}`,{headers:{Accept:"application/octet-stream"}}),t=((n=(a=i.headers)==null?void 0:a.get)==null?void 0:n.call(a,"content-type"))||"";if(!i.ok){const w=t.includes("application/json")?await i.json():null;throw new Error((w==null?void 0:w.error)||(w==null?void 0:w.message)||"匯出失敗")}const p=await i.blob(),v=oe[k.value]||"dat",s=((e=M.value)==null?void 0:e.replace("-",""))||ae().format("YYYYMM"),D=((d=f.value.find(w=>w._id===y.value))==null?void 0:d.name)||"department",S=O.value,be=(S==null?void 0:S.type)||o.value||"report",ge=(S==null?void 0:S.name)||be,Z=w=>String(w).trim().replace(/\s+/g,"-").replace(/[^\w\u4e00-\u9fa5-]+/gi,""),he=`${s}-${Z(D)}-${Z(ge)}.${v}`,ee=window.URL.createObjectURL(p),T=document.createElement("a");T.href=ee,T.download=he,document.body.appendChild(T),T.click(),document.body.removeChild(T),window.URL.revokeObjectURL(ee),b.success("匯出成功")}catch(u){b.error(u.message||"匯出失敗")}finally{R.value=!1}}return(l,a)=>{const n=L("el-date-picker"),e=L("el-option"),d=L("el-select"),u=L("el-button"),i=L("el-card"),t=L("el-alert"),p=L("el-table-column"),v=L("el-table");return m(),W("div",xe,[a[12]||(a[12]=c("header",{class:"page-header"},[c("h1",{class:"page-title"},"部門報表中心"),c("p",{class:"page-subtitle"},"彙整各部門出勤與請假統計")],-1)),A(i,{class:"filters-card",shadow:"never"},{header:x(()=>[...a[4]||(a[4]=[c("div",{class:"card-header"},[c("h2",null,"匯出條件"),c("span",{class:"card-tip"},"請先選擇月份、部門與報表種類")],-1)])]),default:x(()=>[c("div",ke,[c("div",Se,[a[5]||(a[5]=c("label",{class:"filter-label"},"月份",-1)),A(n,{modelValue:M.value,"onUpdate:modelValue":a[0]||(a[0]=s=>M.value=s),type:"month",placeholder:"選擇月份",format:"YYYY 年 MM 月","value-format":"YYYY-MM",disabled:g.departments,class:"w-full"},null,8,["modelValue","disabled"])]),c("div",We,[a[6]||(a[6]=c("label",{class:"filter-label"},"部門",-1)),A(d,{modelValue:y.value,"onUpdate:modelValue":a[1]||(a[1]=s=>y.value=s),placeholder:"選擇部門",filterable:"",loading:g.departments,disabled:g.departments||f.value.length===0,class:"w-full"},{default:x(()=>[(m(!0),W(Y,null,$(f.value,s=>(m(),j(e,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),c("div",Ae,[a[7]||(a[7]=c("label",{class:"filter-label"},"報表種類",-1)),A(d,{modelValue:o.value,"onUpdate:modelValue":a[2]||(a[2]=s=>o.value=s),placeholder:"選擇報表",class:"w-full",disabled:g.templates||B.value.length===0,loading:g.templates},{default:x(()=>[(m(!0),W(Y,null,$(B.value,s=>(m(),j(e,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled","loading"])]),c("div",Le,[a[8]||(a[8]=c("label",{class:"filter-label"},"匯出格式",-1)),A(d,{modelValue:k.value,"onUpdate:modelValue":a[3]||(a[3]=s=>k.value=s),placeholder:"選擇格式",class:"w-full",disabled:g.templates||F.value.length===0,loading:g.templates},{default:x(()=>[(m(!0),W(Y,null,$(F.value,s=>(m(),j(e,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled","loading"])])]),c("div",Ee,[A(u,{disabled:!z.value||r.loading,loading:r.loading,onClick:fe},{default:x(()=>[...a[9]||(a[9]=[re(" 預覽摘要 ",-1)])]),_:1},8,["disabled","loading"]),A(u,{type:"primary",disabled:!P.value||R.value,loading:R.value,onClick:ye},{default:x(()=>[...a[10]||(a[10]=[re(" 匯出報表 ",-1)])]),_:1},8,["disabled","loading"])])]),_:1}),r.state==="empty"?(m(),j(t,{key:0,type:"info","show-icon":"",class:"mt-4",title:"目前條件下沒有可供預覽的資料"})):U("",!0),r.state==="success"?(m(),j(i,{key:1,class:"preview-card",shadow:"never"},{header:x(()=>[...a[11]||(a[11]=[c("div",{class:"card-header"},[c("h2",null,"報表摘要"),c("span",{class:"card-tip"},"以下內容來自後端 JSON 預覽")],-1)])]),default:x(()=>[r.summary?(m(),W("div",Me,[(m(!0),W(Y,null,$(de.value,s=>(m(),W("div",{class:"summary-item",key:s.label},[c("span",je,ne(s.label),1),c("span",Ce,ne(s.value),1)]))),128))])):U("",!0),r.records.length?(m(),j(v,{key:1,data:r.records,border:"",class:"preview-table"},{default:x(()=>[A(p,{prop:"name",label:"員工","min-width":"140"}),(m(!0),W(Y,null,$(ie.value,s=>(m(),j(p,{key:s.prop,prop:s.prop,label:s.label,"min-width":s.minWidth||120},null,8,["prop","label","min-width"]))),128))]),_:1},8,["data"])):U("",!0)]),_:1})):U("",!0)])}}},$e=we(Re,[["__scopeId","data-v-1dba1cc4"]]);export{$e as default};
