import{_ as ea,j as w,I as Ja,J as ta,K as aa,c as y,o as p,F as O,t as W,n as T,w as h,b as d,L as Et,A as dt,v as S,e as x,r as g,D as K,y as Xt,m as me,k as Ka,d as f,q as N,h as Se,p as Zt,E as ce,u as Wa,g as V,f as qa,B as $e,M as Ha}from"./index-BRi7JFWd.js";import{a as Y}from"./api-BYlMASy1.js";import{u as Ga}from"./auth-BcpWOB7V.js";import{b as Qa}from"./shiftColors-BbvJ2s1U.js";const Xa={class:"dashboard"},Za={class:"metric-label"},el={class:"metric-value"},tl=Object.assign({name:"ScheduleDashboard"},{__name:"ScheduleDashboard",props:{summary:{type:Object,default:()=>({direct:0,unscheduled:0,onLeave:0})}},setup(Dt){const Fe=Dt,ct=w(()=>[{label:"直屬員工數",value:Fe.summary.direct,icon:Ja,color:"#0f766e"},{label:"未排班員工",value:Fe.summary.unscheduled,icon:ta,color:"#dc2626"},{label:"請假中員工",value:Fe.summary.onLeave,icon:aa,color:"#f59e0b"}]);return(At,It)=>{const L=x("el-card");return p(),y("div",Xa,[(p(!0),y(O,null,W(ct.value,m=>(p(),T(L,{class:"metric-card",key:m.label},{default:h(()=>[(p(),T(Et(m.icon),{class:"metric-icon",style:dt({color:m.color})},null,8,["style"])),d("div",Za,S(m.label),1),d("div",el,S(m.value),1)]),_:2},1024))),128))])}}}),al=ea(tl,[["__scopeId","data-v-ffe8883b"]]),ll={class:"schedule-page"},sl={class:"filters-card"},nl={class:"filters-content"},ol={class:"filter-group"},il={class:"filter-group"},rl={class:"filter-group"},ul={key:0,class:"filter-group include-self-group"},dl={key:0,class:"publish-card"},cl={class:"publish-header"},pl={class:"publish-progress","data-test":"publish-steps"},vl={class:"publish-meta-row"},fl={key:0,class:"publish-meta","data-test":"publish-meta"},ml={key:1,class:"publish-meta","data-test":"publish-meta"},hl={key:2,class:"publish-progress-indicator"},yl={class:"progress-label"},_l={class:"publish-actions"},gl={class:"publish-stats"},bl={key:0,class:"status-card pending","data-test":"pending-card"},Sl={class:"card-header"},wl={class:"card-badge"},kl={class:"card-list"},Cl={class:"card-name"},El={class:"card-count"},Dl={key:1,class:"status-card disputed","data-test":"disputed-card"},Al={class:"card-header"},Il={class:"card-badge"},$l={class:"card-list"},Vl={class:"card-item-main"},xl={class:"card-name"},zl={class:"card-count"},Ml={key:0,class:"card-note"},jl={key:2,class:"status-card ready","data-test":"ready-card"},Nl={key:3,class:"status-card finalized","data-test":"finalized-card"},Pl={class:"actions-card"},Ol={class:"primary-actions"},Ll={class:"secondary-actions"},Rl={class:"range-picker-wrapper"},Tl={class:"schedule-card"},Fl={class:"schedule-header"},Ul={class:"schedule-legend","data-test":"schedule-legend"},Yl={key:1,class:"legend-empty","data-test":"shift-legend-empty"},Bl={key:0,class:"batch-toolbar"},Jl={class:"employee-info"},Kl={class:"department-name"},Wl={key:0,class:"sub-department"},ql={class:"employee-name"},Hl={class:"day-header"},Gl=["title"],Ql={key:0,class:"leave-indicator","data-test":"leave-indicator"},Xl={class:"department-selects"},Zl={class:"shift-details"},es={class:"detail-row"},ts={class:"detail-value"},as={class:"detail-row"},ls={class:"detail-value"},ss={key:0,class:"detail-row"},ns={class:"detail-value"},os={key:3,class:"missing-label"},is={key:2,class:"empty-cell"},rs={key:1,class:"modern-schedule-cell collapsed-cell"},us={key:1,class:"pagination-bar"},ds={key:1,class:"approval-card"},cs={class:"approval-header"},ps={class:"approval-count"},vs={class:"applicant-name"},fs={class:"form-type"},ms={key:0},hs={class:"mb-2"},ys={class:"mb-2"},_s={class:"mb-2"},gs={class:"mb-1"},bs={class:"mr-2"},Ss="schedule-include-self",ws={__name:"Schedule",setup(Dt){const Fe=t=>t?new Date(t).toLocaleString():"-",ct=t=>Array.isArray(t)?t.join(", "):t??"-",At={leave:"請假",attendance:"出勤",overtime:"加班",shift:"排班",reimbursement:"報銷",expense:"費用",travel:"出差",recruitment:"招募",onboarding:"入職",general:"一般"},It=(t,e="")=>{if(t==null)return e||"未知類型";const a=String(t).trim();return a?At[a.toLowerCase()]||a:e||"未知類型"},L=g(K().format("YYYY-MM")),m=g({}),Ue=g([]),he=g([]),B=g([]),Ve=g([]),ee=g([]),ne=g([]),$=g(""),z=g(""),q=g(""),oe=g(""),P=g(""),Ye=g(""),ye=g([]),Be=g(null),Q=g(!1);let $t=!0;const Vt=g({direct:0,unscheduled:0,onLeave:0}),Je=g(""),Ke=g("all"),et=g(new Set),pe=g(new Set),le=g(new Set),we=g(new Set),We=g(new Map),pt=g([]),qe=g(""),_e=g(""),ve=g(""),tt=g(!1),He=g(!1),Ge=g(!1),R=Xt({visible:!1,doc:null}),vt=Xt({}),fe=g(20),X=g(1),at=g(null),lt=g(new Set),ft=g(!1);function ke(){var a,l;if(typeof window>"u")return"";const t=(a=window.sessionStorage)==null?void 0:a.getItem("employeeId");if(t&&t!=="undefined")return t;const e=(l=window.localStorage)==null?void 0:l.getItem("employeeId");return e&&e!=="undefined"?e:""}function xt(t){return t?`${Ss}:${String(t)}`:""}function zt(t=ke()){var l;if(typeof window>"u")return null;const e=xt(t);if(!e)return null;const a=(l=window.localStorage)==null?void 0:l.getItem(e);return a==="true"?!0:a==="false"?!1:null}function mt(t,e=ke()){var l;if(typeof window>"u")return;const a=xt(e);if(a)try{(l=window.localStorage)==null||l.setItem(a,t?"true":"false")}catch(s){console.warn("Failed to persist includeSelf preference",s)}}const la=w(()=>pe.value),sa=w(()=>le.value),na=w(()=>we.value),ge=(t,e)=>`${t}::${e}`,ht=t=>{const e=String(t),a=e.lastIndexOf("::");if(a===-1)return{empId:e,day:NaN};const l=e.slice(0,a),s=Number(e.slice(a+2));return{empId:l,day:s}},Qe=g({}),Z=(t,e)=>{const a=Qe.value[String(t)];return a?!!a[Number(e)]:!1},Ce=(t,e)=>{const a=m.value[t];return!a||!a[e]?!1:!Z(t,e)},Mt=w(()=>{if(!Array.isArray(he.value)||!he.value.length)return[];const t=new Set;return he.value.reduce((e,a)=>{if(!a)return e;const l=it(a)||a.name||a.code||"未命名班別",s=String(a._id||`${a.code??""}-${a.name??""}`);return!s||t.has(s)||(t.add(s),e.push({key:s,label:l,style:kt(a)})),e},[])}),yt=w(()=>new Set(We.value.keys())),xe=t=>{const e=new Map(We.value);t(e),We.value=e},Ee=(t,e,a,l,s)=>{const i=ge(e,a);if(!Ce(e,a)){t.delete(i);return}if(!s){const r=t.get(i);if(!r)return;r[l]=!1,r.manual||r.employee||r.day?t.set(i,r):t.delete(i);return}const c=t.get(i)||{manual:!1,employee:!1,day:!1};c[l]=!0,t.set(i,c)},oa=()=>{const t=new Map,e=(a,l,s)=>{if(!Ce(a,l))return;const i=ge(a,l),c=t.get(i)||{manual:!1,employee:!1,day:!1};c[s]=!0,t.set(i,c)};we.value.forEach(a=>{const{empId:l,day:s}=ht(a);e(l,s,"manual")}),pe.value.forEach(a=>{re.value.forEach(l=>e(a,l.date,"employee"))}),le.value.forEach(a=>{B.value.forEach(l=>e(l._id,a,"day"))}),We.value=t},_t=w(()=>yt.value.size>0),jt=w(()=>_e.value?Wt(_e.value):[]),ia=(t,e)=>Ce(t,e)?yt.value.has(ge(t,e)):!1,st=()=>{const t=new Set(B.value.map(l=>l._id)),e=new Set(re.value.map(l=>l.date));pe.value=new Set(Array.from(pe.value).filter(l=>t.has(l))),le.value=new Set(Array.from(le.value).filter(l=>e.has(l)));const a=new Set;we.value.forEach(l=>{const{empId:s,day:i}=ht(l);t.has(s)&&e.has(i)&&Ce(s,i)&&a.add(ge(s,i))}),we.value=a,oa()},ra=()=>{pe.value=new Set,le.value=new Set,we.value=new Set,We.value=new Map,pt.value=[]},ua=(t,e)=>{const a=new Set(pe.value),l=typeof e=="boolean"?e:!a.has(t);l?a.add(t):a.delete(t),pe.value=a,xe(s=>{re.value.forEach(i=>Ee(s,t,i.date,"employee",l))})},da=(t,e)=>{const a=new Set(le.value),l=typeof e=="boolean"?e:!a.has(t);l?a.add(t):a.delete(t),le.value=a,xe(s=>{B.value.forEach(i=>Ee(s,i._id,t,"day",l))})},ca=(t,e,a)=>{if(!Ce(t,e))return;const l=ge(t,e),s=new Set(we.value),i=typeof a=="boolean"?a:!s.has(l);i?s.add(l):s.delete(l),we.value=s,xe(c=>Ee(c,t,e,"manual",i))},pa=()=>{const t=Me.value.map(s=>s._id),e=pe.value,a=new Set(e);let l=!1;t.some(s=>!a.has(s))&&(l=!0),l?t.forEach(s=>a.add(s)):t.forEach(s=>a.delete(s)),pe.value=a,xe(s=>{t.forEach(i=>{re.value.forEach(c=>{Ce(i,c.date)&&Ee(s,i,c.date,"employee",l)})})})},va=()=>{const t=le.value,e=re.value.map(i=>i.date),a=e.every(i=>t.has(i)),l=new Set(t);a?e.forEach(i=>l.delete(i)):e.forEach(i=>l.add(i)),le.value=l;const s=!a;xe(i=>{e.forEach(c=>{Me.value.forEach(r=>{Ce(r._id,c)&&Ee(i,r._id,c,"day",s)})})})},Nt=t=>[...t].sort((e,a)=>{const l=(e.department||"").localeCompare(a.department||"");return l!==0?l:(e.name||"").localeCompare(a.name||"")}),fa=t=>{if(!Array.isArray(t)||t.length!==2)return;const[e,a]=t;if(!e||!a)return;const l=K(`${L.value}-01`),s=K(e),i=K(a);if(!s.isValid()||!i.isValid())return;const c=l.endOf("month");let r=s.isBefore(l)?l:s;const u=[];for(;(r.isBefore(i)||r.isSame(i,"day"))&&(r.year()===l.year()&&r.month()===l.month()&&u.push(r.date()),!r.isSame(c,"day"));)r=r.add(1,"day");const n=le.value,_=new Set(u);le.value=_;const E=u.filter(F=>!n.has(F)),I=Array.from(n).filter(F=>!_.has(F));xe(F=>{E.forEach(M=>{Me.value.forEach(b=>Ee(F,b._id,M,"day",!0))}),I.forEach(M=>{Me.value.forEach(b=>Ee(F,b._id,M,"day",!1))})})};me(_e,(t,e)=>{t!==e&&(ve.value="")}),me(jt,t=>{ve.value&&!t.some(e=>e._id===ve.value)&&(ve.value="")}),me(Q,async(t,e)=>{if(t===e)return;const a=Ie()||ke();mt(t,a),De.refreshRole({forceRefresh:!0}),!$t&&ie.value&&(X.value=1,await rt($.value,z.value),await te({reset:!0}),await ue())}),me([Je,Ke],()=>{X.value=1,te({reset:!0})});const gt=t=>{const e=m.value[t]||{},a=Object.values(e);if(!a.length)return"unscheduled";const l=a.some(i=>!i.shiftId&&!i.leave&&!Z(t,i.day)),s=a.some(i=>i.leave||Z(t,i.day));return l?"unscheduled":s?"onLeave":"scheduled"},ze=w(()=>{let t=Je.value?B.value.filter(e=>e.name.includes(Je.value)):B.value;return Ke.value!=="all"&&(t=t.filter(e=>gt(e._id)===Ke.value)),t}),ma=w(()=>ze.value.length?Math.max(1,Math.ceil(ze.value.length/fe.value)):1),Me=w(()=>{const t=(X.value-1)*fe.value,e=t+fe.value;return ze.value.slice(t,e)}),Pt=w(()=>Me.value.map(t=>String(t._id)));me([ze,fe],()=>{const t=ma.value;X.value>t&&(X.value=t)}),me(Pt,()=>{te()}),me(B,st),me(Qe,st);const Ot=w(()=>B.value.length>50),ha=t=>{et.value.has(t)?et.value.delete(t):et.value.add(t)},ya=w(()=>ne.value.filter(t=>t.department===$.value)),_a=Wa(),De=Ga();De.loadUser();const Lt=w(()=>["supervisor","admin"].includes(De.role)),ie=w(()=>De.role==="supervisor"),je=Lt,Ne=g(""),C=w(()=>{if(at.value){const n=at.value;return{status:n.status||"draft",pendingEmployees:n.pendingEmployees||[],disputedEmployees:n.disputedEmployees||[],publishedAt:n.publishedAt||null,hasSchedules:n.hasSchedules??!1,totalEmployees:n.totalEmployees??0,allEmployeesConfirmed:n.allEmployeesConfirmed??!1}}const t={status:"draft",pendingEmployees:[],disputedEmployees:[],publishedAt:null,hasSchedules:!1,totalEmployees:0,allEmployeesConfirmed:!1},e=Array.isArray(Ue.value)?Ue.value:[];if(!e.length)return t;t.hasSchedules=!0;const a=new Map;let l=null,s=!1,i=!1,c=!1;e.forEach(n=>{if(!n)return;const _=n.state||"draft",E=n.employeeResponse||"pending",I=n.employee||{},F=(I==null?void 0:I._id)??(I==null?void 0:I.id)??n.employee,M=F?String(F):"",b=(I==null?void 0:I.name)||n.employeeName||M;if(_!=="draft"&&(s=!0),(_==="changes_requested"||E==="disputed")&&(i=!0),_==="finalized"&&(c=!0),n!=null&&n.publishedAt){const U=new Date(n.publishedAt);Number.isNaN(U)||(!l||l<U)&&(l=U)}if(!M)return;a.has(M)||a.set(M,{id:M,name:b||M,pendingCount:0,disputedCount:0,latestNote:"",latestResponseAt:null});const D=a.get(M);if(_==="pending_confirmation"&&E==="pending"&&(D.pendingCount+=1),(E==="disputed"||_==="changes_requested")&&(D.disputedCount+=1,n!=null&&n.responseNote&&(D.latestNote=n.responseNote)),n!=null&&n.responseAt){const U=new Date(n.responseAt);Number.isNaN(U)||(!D.latestResponseAt||D.latestResponseAt<U)&&(D.latestResponseAt=U)}});const r=[],u=[];return a.forEach(n=>{n.pendingCount>0&&r.push({id:n.id,name:n.name,pendingCount:n.pendingCount}),n.disputedCount>0&&u.push({id:n.id,name:n.name,disputedCount:n.disputedCount,latestNote:n.latestNote,latestResponseAt:n.latestResponseAt?n.latestResponseAt.toISOString():null})}),t.pendingEmployees=r,t.disputedEmployees=u,t.totalEmployees=a.size,t.publishedAt=l?l.toISOString():null,c?t.status="finalized":i?t.status="disputed":s?t.status=r.length?"pending":"ready":t.status="draft",t.allEmployeesConfirmed=t.status==="ready"&&r.length===0&&u.length===0,t}),ga=w(()=>({draft:"尚未發布",pending:"待員工確認",ready:"可完成發布",disputed:"需處理異議",finalized:"已完成發布"})[C.value.status]||"尚未發布"),Pe=w(()=>C.value.pendingEmployees.reduce((t,e)=>t+(Number(e==null?void 0:e.pendingCount)||0),0)),Oe=w(()=>C.value.disputedEmployees.reduce((t,e)=>t+(Number(e==null?void 0:e.disputedCount)||0),0)),ba=w(()=>{const t=C.value.status;return t==="pending"?1:t==="disputed"?2:t==="ready"||t==="finalized"?3:0}),nt=w(()=>{const t=C.value.status,e=Pe.value>0,a=Oe.value>0;return{draft:t==="draft"?"process":"finish",pending:t==="draft"?"wait":e||t==="pending"?"process":"finish",disputed:a?"error":t==="draft"||t==="pending"?"wait":"finish",finalized:t==="finalized"?"success":t==="ready"?"process":"wait"}}),Sa=w(()=>C.value.hasSchedules?Pe.value>0?`${Pe.value} 筆待回覆`:"員工已完成回覆":"尚未發送確認"),wa=w(()=>C.value.hasSchedules?Oe.value>0?`${Oe.value} 筆異議待處理`:"無異議紀錄":"尚未進入異議流程"),ka=w(()=>C.value.status==="finalized"?"班表已鎖定":C.value.status==="ready"?"可執行最終發布":"等待完成發布"),bt=w(()=>{if(C.value.status==="finalized")return 100;const t=C.value.totalEmployees;if(!t||t<=0)return C.value.status==="draft"?0:20;const e=Math.max(t-C.value.pendingEmployees.length,0),a=Math.round(e/t*100);return Math.min(Math.max(a,0),100)}),Rt=w(()=>He.value||!C.value.hasSchedules||C.value.status==="finalized"),Tt=w(()=>Ge.value||C.value.status!=="ready");me(ie,t=>{const e=Ie()||ke();if(!t){Q.value&&(Q.value=!1),mt(!1,e);return}const a=zt(e);a===!0?Q.value=!0:a===!1&&e&&mt(!1,e)});const Ae=t=>{var l,s;const e=(l=ce)==null?void 0:l.warning;typeof e=="function"&&e(t);const a=typeof window<"u"?(s=window.ElMessage)==null?void 0:s.warning:void 0;typeof a=="function"&&a!==e&&a(t)},Xe=t=>{var l,s;const e=(l=ce)==null?void 0:l.info;typeof e=="function"&&e(t);const a=typeof window<"u"?(s=window.ElMessage)==null?void 0:s.info:void 0;typeof a=="function"&&a!==e&&a(t)},St=t=>{var l,s;const e=(l=ce)==null?void 0:l.success;typeof e=="function"&&e(t);const a=typeof window<"u"?(s=window.ElMessage)==null?void 0:s.success:void 0;typeof a=="function"&&a!==e&&a(t)},Ca=t=>{if(!t)return"";const e=K(t);return e.isValid()?e.format("YYYY/MM/DD HH:mm"):""};function Ft(){const t={month:L.value};return $.value&&(t.department=$.value),z.value&&(t.subDepartment=z.value),Q.value&&ie.value&&(t.includeSelf=!0),t}async function Ea(){if(!He.value)try{He.value=!0;const t=await Y("/api/schedules/publish",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Ft())});if(!t.ok){let e="發布失敗";try{const a=await t.json();a!=null&&a.error&&(e=a.error)}catch{}throw new Error(e)}St("已將班表發送給員工確認"),await te(),await ue()}catch(t){Ae((t==null?void 0:t.message)||"發布失敗")}finally{He.value=!1}}async function Da(){if(!Ge.value)try{Ge.value=!0;const t=await Y("/api/schedules/publish/finalize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Ft())});if(t.status===409){let e="仍有員工未回覆";try{const a=await t.json();a!=null&&a.error&&(e=a.error)}catch{}Ae(e),await te();return}if(!t.ok){let e="完成發布失敗";try{const a=await t.json();a!=null&&a.error&&(e=a.error)}catch{}throw new Error(e)}St("班表已完成發布"),await te(),await ue()}catch(t){Ae((t==null?void 0:t.message)||"完成發布失敗")}finally{Ge.value=!1}}async function Aa(){if(Rt.value){Ae("目前沒有可發布的班表");return}try{await $e.confirm("確認要將本月班表發送給員工確認嗎？","批次發布",{type:"warning",confirmButtonText:"送出",cancelButtonText:"取消"})}catch{return}await Ea()}async function Ia(){if(C.value.status==="finalized"){Xe("班表已完成發布");return}if(Tt.value){Ae("仍有員工尚未回覆，請確認後再完成發布");return}try{await $e.confirm("全部員工已確認，是否完成發布並鎖定班表？","完成發布",{type:"success",confirmButtonText:"完成",cancelButtonText:"取消"})}catch{return}await Da()}const Ut=t=>({pending:"待簽核",approved:"已核可",rejected:"已否決",returned:"已退簽"})[t]||t||"-",$a=t=>{if(t&&typeof t=="object"){const e=t._id||t.employeeId||"";return t.name||vt[e]||e}return vt[t]||t||"-"},Va=(t,e)=>Z(t,e)?"已核准請假，該日不列入工作時數":"",re=w(()=>{const t=K(L.value+"-01"),e=t.endOf("month").date(),a=["日","一","二","三","四","五","六"];return Array.from({length:e},(l,s)=>{const i=s+1,c=a[t.date(i).day()];return{date:i,label:`${i}(${c})`}})});async function xa(){const t=await Y("/api/shifts");if(t.ok){const e=await t.json(),a=Array.isArray(e==null?void 0:e.shifts)?e.shifts:Array.isArray(e)?e:[];Array.isArray(a)&&(he.value=a.map(l=>({_id:l._id,code:l.code,name:l.name??"",startTime:l.startTime,endTime:l.endTime,remark:l.remark})))}else t.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",t.status)}async function Yt(t=""){try{const e=t||q.value,a=e?`/api/sub-departments?department=${e}`:"/api/sub-departments",l=await Y(a);if(!l.ok)throw new Error("Failed to fetch sub departments");const s=await l.json(),i=ee.value.reduce((u,n)=>{const _=String(n._id);return u[_]=_,n.name&&(u[n.name]=_),u},{});q.value&&(i[q.value]=q.value),oe.value&&(i[oe.value]=q.value||oe.value);const c=Array.isArray(s)?s.map(u=>{const n=u==null?void 0:u.department;let _="";return n&&typeof n=="object"?_=(n==null?void 0:n._id)||(n==null?void 0:n.id)||i[n==null?void 0:n.name]||"":_=i[n]||n||"",{...u,_id:String((u==null?void 0:u._id)??(u==null?void 0:u.id)??""),department:String(_)}}).filter(u=>u._id):[];let r=c;if(e&&(r=c.filter(u=>u.department===String(e)),!r.length&&P.value)){const u=c.find(n=>n._id===P.value);u?r=[u]:r=[{_id:P.value,name:Ye.value||"",department:String(e)}]}if(!r.length&&c.length&&(r=c),De.role==="supervisor"){const u=ye.value.length?ye.value:P.value?[P.value]:[],n=new Set(u.map(_=>String(_)));n.size&&(r=r.filter(_=>n.has(String(_._id))))}ne.value=r,ne.value.length?P.value&&ne.value.some(u=>u._id===P.value)?z.value=P.value:z.value&&ne.value.some(u=>u._id===z.value)||(z.value=ne.value[0]._id):z.value=""}catch(e){console.error(e),ne.value=[],z.value=""}}async function za(){var t;try{const e=await Y("/api/departments"),a=e.ok?await e.json():[],l=Array.isArray(a)?a.map(r=>{const u=(r==null?void 0:r._id)??(r==null?void 0:r.id)??(r==null?void 0:r.value)??"";return{...r,_id:String(u),name:(r==null?void 0:r.name)??""}}).filter(r=>r._id):[],s=$.value||q.value;let i=l;s&&(i=l.filter(r=>r._id===s||oe.value&&r.name===oe.value),!i.length&&s&&(i=[{_id:s,name:oe.value||((t=l.find(r=>r._id===s))==null?void 0:t.name)||""}])),ee.value=i.length?i:l,ee.value.length?ee.value.some(r=>r._id===$.value)||($.value=ee.value[0]._id):!$.value&&s&&($.value=s);const c=$.value||q.value||(ee.value.length?ee.value[0]._id:"");await Yt(c)}catch(e){console.error(e)}}function Ie(){return Lt.value?ke():""}async function Ma(){if(De.role!=="supervisor"){q.value="",oe.value="",P.value="",Ye.value="",ye.value=[],Be.value=null;return}const t=Ie();if(!t){q.value="",oe.value="",P.value="",Ye.value="",ye.value=[],Be.value=null;return}let e=null;try{const u=await Y(`/api/employees/${t}`);if(!u.ok)throw new Error("Failed to fetch supervisor context");e=await u.json()}catch(u){console.error(u),Be.value=null}Be.value=e||null;const a=e==null?void 0:e.department;let l="",s="";if(a&&typeof a=="object")l=(a==null?void 0:a._id)||(a==null?void 0:a.id)||(a==null?void 0:a.value)||"",s=(a==null?void 0:a.name)||(e==null?void 0:e.departmentName)||"";else if(typeof a=="string"){const u=ee.value.find(n=>String(n==null?void 0:n._id)===a||String((n==null?void 0:n.id)??"")===a||(n==null?void 0:n.code)===a||(n==null?void 0:n.name)===a);l=(u==null?void 0:u._id)||(u==null?void 0:u.id)||a,s=(u==null?void 0:u.name)||(e==null?void 0:e.departmentName)||a}q.value=l?String(l):"",oe.value=s?String(s):"",q.value?$.value=q.value:$.value="";const i=e==null?void 0:e.subDepartment;let c="",r="";if(i&&typeof i=="object")c=(i==null?void 0:i._id)||(i==null?void 0:i.id)||(i==null?void 0:i.value)||"",r=(i==null?void 0:i.name)||(e==null?void 0:e.subDepartmentName)||"";else if(typeof i=="string"){const u=ne.value.find(n=>String(n==null?void 0:n._id)===i||String((n==null?void 0:n.id)??"")===i||(n==null?void 0:n.code)===i||(n==null?void 0:n.name)===i);c=(u==null?void 0:u._id)||(u==null?void 0:u.id)||i,r=(u==null?void 0:u.name)||(e==null?void 0:e.subDepartmentName)||i}P.value=c?String(c):"",Ye.value=r?String(r):"",P.value?z.value=P.value:z.value="",await ja(t)}async function ja(t=""){if(De.role!=="supervisor"){ye.value=[];return}const e=t||Ie();if(!e){ye.value=P.value?[String(P.value)]:[];return}try{const a=await Y(`/api/employees?supervisor=${e}`);if(!a.ok)throw new Error("Failed to fetch direct reports");const l=await a.json(),s=Array.isArray(l)?l:[],i=new Set,c=[],r=u=>{if(!u&&u!==0)return;const n=String(u);n&&(i.has(n)||(i.add(n),c.push(n)))};s.forEach(u=>{const n=u==null?void 0:u.subDepartment;r(n&&typeof n=="object"?(n==null?void 0:n._id)||(n==null?void 0:n.id)||(n==null?void 0:n.value):n)}),r(P.value),ye.value=c}catch(a){console.error(a),ye.value=P.value?[String(P.value)]:[]}}function wt(t){const e=String(t);m.value[e]||(m.value[e]={});const a=B.value.find(s=>String(s._id)===e)||{},l={shiftId:"",department:a.departmentId||"",subDepartment:a.subDepartmentId||""};re.value.forEach(s=>{m.value[e][s.date]?(m.value[e][s.date].shiftId=m.value[e][s.date].shiftId||"",m.value[e][s.date].department=m.value[e][s.date].department||l.department,m.value[e][s.date].subDepartment=m.value[e][s.date].subDepartment||l.subDepartment):m.value[e][s.date]={...l}})}function Na(){m.value={},Ue.value=[],at.value=null,lt.value=new Set,Ve.value=[],Qe.value={}}async function te({reset:t=!1}={}){let e=Pt.value;if(!e.length&&B.value.length){const r=(X.value-1)*fe.value,u=r+fe.value;e=B.value.slice(r,u).map(n=>String(n._id))}const a=e.length>0;if(t&&Na(),!(t||!a||e.some(r=>!lt.value.has(r)))||ft.value)return;ft.value=!0;const s=Ie(),i=[`month=${L.value}`];(a||s)&&(i.push(`page=${X.value}`),i.push(`limit=${fe.value}`),i.push(`employeeIds=${e.join(",")}`)),s&&i.push(`supervisor=${s}`),Q.value&&ie.value&&i.push("includeSelf=true");const c=`?${i.join("&")}`;try{const r=await Y(`/api/schedules/monthly${c}`);if(!r.ok)throw new Error("Failed to fetch schedules");const u=await r.json(),n=Array.isArray(u)?u:Array.isArray(u==null?void 0:u.schedules)?u.schedules:[],_=Array.isArray(u)?null:u==null?void 0:u.publishSummary;at.value=_?{status:_.status||"draft",pendingEmployees:_.pendingEmployees||[],disputedEmployees:_.disputedEmployees||[],publishedAt:_.publishedAt||null,hasSchedules:_.hasSchedules??!1,totalEmployees:_.totalEmployees??0,allEmployeesConfirmed:_.allEmployeesConfirmed??!1}:null,Ue.value=n;const E=new Set(e);e.forEach(k=>wt(k)),n.forEach(k=>{var H;const ae=((H=k.employee)==null?void 0:H._id)||k.employee;if(!ae)return;const J=String(ae);if(!E.has(J))return;wt(J);const o=K(k.date).date(),v=B.value.find(j=>String(j._id)===J)||{};m.value[J][o]={id:k._id,shiftId:k.shiftId,department:k.department||v.departmentId,subDepartment:k.subDepartment||v.subDepartmentId}});const I=[`month=${L.value}`];(a||s)&&I.push(`employeeIds=${e.join(",")}`),Q.value&&ie.value&&I.push("includeSelf=true"),s&&I.push(`supervisor=${s}`);const F=$.value,M=z.value;F&&I.push(`department=${F}`),M&&I.push(`subDepartment=${M}`);const b=`?${I.join("&")}`,D=await Y(`/api/schedules/leave-approvals${b}`);if(D!=null&&D.ok&&typeof D.json=="function"){const k=await D.json(),ae=Array.isArray(k==null?void 0:k.approvals)?k.approvals:[],J=Array.isArray(k==null?void 0:k.leaves)?k.leaves:[];Ve.value=ae;const o={},v=K(`${L.value}-01`).startOf("day"),H=v.endOf("month").startOf("day");J.forEach(j=>{var qt,Ht,Gt;if(String(j.status||j.decision||"").toLowerCase()!=="approved")return;const G=((qt=j.employee)==null?void 0:qt._id)||j.employee;if(!G)return;const de=String(G);if(!(E.size>0?E.has(de):B.value.some(Te=>String(Te==null?void 0:Te._id)===de)))return;wt(de);const Re=K(j.startDate).startOf("day"),A=K(j.endDate).startOf("day");if(!Re.isValid()||!A.isValid())return;let ut=Re.isBefore(v)?v:Re;const Ba=A.isAfter(H)?H:A;for(;!ut.isAfter(Ba);){const Te=ut.date();o[de]||(o[de]={}),o[de][Te]=!0;const Qt=(Gt=(Ht=m.value)==null?void 0:Ht[de])==null?void 0:Gt[Te];Qt&&(Qt.leave={type:j.leaveType,startDate:j.startDate,endDate:j.endDate,excludesHours:!0}),ut=ut.add(1,"day")}}),Qe.value=o}else Ve.value=[],Qe.value={};const U=Ie()||ke();if(Q.value&&ie.value&&U){const k=n.some(J=>{var v;const o=((v=J==null?void 0:J.employee)==null?void 0:v._id)||(J==null?void 0:J.employee);return o&&String(o)===U}),ae=[L.value,$.value||"",z.value||""].join("|");k?Ne.value&&(Ne.value=""):Ne.value!==ae&&(Xe("尚未為主管建立班表，請先建立排班。"),Ne.value=ae)}else Ne.value&&(Ne.value="");const Le=new Set(lt.value);e.forEach(k=>Le.add(k)),lt.value=Le,st()}catch(r){console.error(r),ce.error("取得排班資料失敗"),Ue.value=[]}finally{ft.value=!1}}function Pa(t){X.value=t,te()}function Oa(t){fe.value=t,X.value=1,te()}async function La(t){var s;if(!t)return;R.visible=!1,R.doc=null;const e=await Y(`/api/approvals/${t}`);if(!e.ok)return;const a=await e.json();R.doc=a,R.visible=!0,(Array.isArray((s=R.doc)==null?void 0:s.steps)?R.doc.steps:[]).forEach(i=>{(Array.isArray(i==null?void 0:i.approvers)?i.approvers:[]).forEach(r=>{var u,n;(u=r==null?void 0:r.approver)!=null&&u._id&&((n=r==null?void 0:r.approver)!=null&&n.name)&&(vt[r.approver._id]=r.approver.name)})})}function Bt(t){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:m.value,employees:B.value,days:re.value,shifts:he.value})),_a.push({name:t==="week"?"PreviewWeek":"PreviewMonth"})}async function Jt(t){try{const e=await Y(`/api/schedules/export?month=${L.value}&format=${t}`);if(!e.ok)throw new Error;const a=await e.blob(),l=URL.createObjectURL(a),s=document.createElement("a");s.href=l,s.download=`schedules-${L.value}.${t==="excel"?"xlsx":"pdf"}`,s.click(),URL.revokeObjectURL(l)}catch{ce.error("匯出失敗")}}async function Ra(t,e,a){const l=`${L.value}-${String(e).padStart(2,"0")}`,s=m.value[t][e];if(s!=null&&s.leave||Z(t,e)){Xe("該日已核准請假，無法調整排班");return}const i=(s==null?void 0:s.shiftId)??"";if(s&&s.id)try{const c=await Y(`/api/schedules/${s.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:a,department:s.department,subDepartment:s.subDepartment})});c.ok?await ue():await ot(c,"更新排班失敗",t,e,i)}catch{await ot(null,"更新排班失敗",t,e,i)}else try{const c=await Y("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:t,date:l,shiftId:a,department:s.department,subDepartment:s.subDepartment})});if(c.ok){const r=await c.json();m.value[t][e]={id:r._id,shiftId:r.shiftId,department:s.department,subDepartment:s.subDepartment},await ue()}else await ot(c,"新增排班失敗",t,e,i)}catch{await ot(null,"新增排班失敗",t,e,i)}}async function Ta(){z.value="",await Yt($.value),await rt($.value,""),X.value=1,await te({reset:!0}),await ue()}async function Fa(){await rt($.value,z.value),X.value=1,await te({reset:!0}),await ue()}async function ot(t,e,a,l,s){m.value[a]||(m.value[a]={});const i=m.value[a][l]||{shiftId:"",department:"",subDepartment:""};i.shiftId=s,m.value[a][l]=i;let c="";try{if(t){const r=await t.json();c=(r==null?void 0:r.error)||""}}catch{}c==="employee conflict"?$e.alert("人員衝突"):c==="department overlap"?$e.alert("跨區重複"):c==="leave conflict"?$e.alert("請假衝突"):ce.error(e)}async function Kt(t,e="批次套用失敗"){let a="";try{if(t){const l=await t.json();a=(l==null?void 0:l.error)||""}}catch{}a==="employee conflict"?ce.warning("部分員工既有排班已更新，請重新整理檢查"):a==="department overlap"?$e.alert("部門或單位與既有資料不一致，無法套用"):a==="leave conflict"?$e.alert("選取日期包含已核准請假，無法套用"):a?ce.error(a):ce.error(e)}async function Ua(){if(!_t.value){Ae("請先選取要套用的儲存格");return}if(!qe.value){Ae("請選擇欲套用的班別");return}const t=[];if(yt.value.forEach(l=>{var n;const{empId:s,day:i}=ht(l),c=(n=m.value[s])==null?void 0:n[i];if(!c||Z(s,i))return;const r=_e.value||c.department||"";let u=c.subDepartment||"";_e.value?u=ve.value||"":ve.value&&(u=ve.value),t.push({employee:s,day:i,date:`${L.value}-${String(i).padStart(2,"0")}`,shiftId:qe.value,department:r,subDepartment:u})}),!t.length){Xe("選取的儲存格皆無需更新（或皆為請假日）");return}const e=new Map;t.forEach(l=>{e.set(ge(l.employee,l.day),l)}),tt.value=!0;const a=Ha.service({fullscreen:!0,lock:!0,text:"批次套用中..."});try{let l;try{l=await Y("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:t.map(({day:i,...c})=>c)})})}catch{await Kt(null);return}if(!l.ok){await Kt(l);return}const s=await l.json();if(!Array.isArray(s)||!s.length){Xe("沒有可更新的資料");return}s.forEach(i=>{var E;const c=((E=i.employee)==null?void 0:E._id)||i.employee,r=K(i.date).date();m.value[c]||(m.value[c]={});const u=ge(c,r),n=e.get(u)||{},_=m.value[c][r]||{};m.value[c][r]={..._,id:i._id||n.id||_.id,shiftId:i.shiftId||n.shiftId||_.shiftId,department:n.department??i.department??_.department??"",subDepartment:n.subDepartment??i.subDepartment??_.subDepartment??""}}),St("批次套用完成"),await ue()}finally{a==null||a.close(),tt.value=!1}}function be(t){return he.value.find(e=>e._id===t)}function it(t){if(!t)return"";const e=t.code??"",a=t.name??"";return!e&&!a?"":a?`${e}(${a})`:e}function kt(t){const e=t&&typeof t=="object"?t:be(t);return e?Qa(e):{}}function Wt(t){return ne.value.filter(e=>e.department===t)}async function rt(t="",e=""){var r;const a=Ie(),l=[],s=t||$.value||q.value,i=e||z.value;a&&l.push(`supervisor=${a}`),s&&l.push(`department=${s}`),i&&l.push(`subDepartment=${i}`);const c=`/api/employees${l.length?`?${l.join("&")}`:""}`;try{const u=await Y(c);if(!u.ok)throw new Error("Failed to fetch employees");const n=typeof u.json=="function"?await u.json():[],_=Array.isArray(n)?n:[],E=ee.value.reduce((b,D)=>(b[D._id]=D.name,b),{}),I=ne.value.reduce((b,D)=>(b[D._id]=D.name,b),{}),F=_.map(b=>{const D=(b==null?void 0:b._id)??(b==null?void 0:b.id)??"",U=(b==null?void 0:b.department)??"",Ze=(b==null?void 0:b.subDepartment)??"",Le=D?String(D):"",k=U?String(U):"",ae=Ze?String(Ze):"";return{_id:Le,name:b.name,departmentId:k,subDepartmentId:ae,department:E[k]||"",subDepartment:I[ae]||""}});let M=Nt(F);if(Q.value&&ie.value){const b=a?String(a):"";b&&!M.some(D=>D._id===b)&&(M=Nt([...M,{_id:b,name:((r=Be.value)==null?void 0:r.name)||"主管本人",departmentId:q.value||"",subDepartmentId:P.value||"",department:oe.value||"",subDepartment:Ye.value||""}]))}B.value=M,st()}catch(u){console.error(u),ce.error("取得員工資料失敗")}}async function ue(){try{const t=[`month=${L.value}`];$.value&&t.push(`department=${$.value}`),z.value&&t.push(`subDepartment=${z.value}`),Q.value&&ie.value&&t.push("includeSelf=true");const e=await Y(`/api/schedules/summary?${t.join("&")}`);if(!e.ok)return;const a=await e.json(),l=Array.isArray(a)?a:[],s=K(`${L.value}-01`).daysInMonth();Vt.value={direct:l.length,unscheduled:l.filter(i=>{const c=Number(i.shiftCount||0),r=Number(i.leaveCount||0);return c+r<s}).length,onLeave:l.filter(i=>Number(i.leaveCount||0)>0).length}}catch(t){console.error(t)}}async function Ya(t){const e=t?K(t):K();L.value=e.isValid()?e.format("YYYY-MM"):K().format("YYYY-MM"),X.value=1,await te({reset:!0}),await ue()}return Ka(async()=>{const t=ke();zt(t)===!0&&ie.value&&(Q.value=!0);try{await ue(),await xa(),await Ma(),await za(),await rt($.value,z.value),await te({reset:!0})}finally{$t=!1}}),(t,e)=>{const a=x("el-date-picker"),l=x("el-option"),s=x("el-select"),i=x("el-switch"),c=x("el-step"),r=x("el-steps"),u=x("el-progress"),n=x("el-button"),_=x("el-input"),E=x("el-table-column"),I=x("el-checkbox"),F=x("el-tag"),M=x("el-popover"),b=x("el-table"),D=x("el-pagination"),U=x("el-divider"),Ze=x("el-descriptions-item"),Le=x("el-descriptions"),k=x("el-timeline-item"),ae=x("el-timeline"),J=x("el-dialog");return p(),y(O,null,[d("div",ll,[e[48]||(e[48]=d("div",{class:"page-header"},[d("h1",{class:"page-title"},"排班管理"),d("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),f(al,{summary:Vt.value},null,8,["summary"]),d("div",sl,[e[22]||(e[22]=d("div",{class:"filters-header"},[d("h3",{class:"filters-title"},"篩選條件")],-1)),d("div",nl,[d("div",ol,[e[18]||(e[18]=d("label",{class:"filter-label"},"選擇月份",-1)),f(a,{modelValue:L.value,"onUpdate:modelValue":e[0]||(e[0]=o=>L.value=o),type:"month","value-format":"YYYY-MM",onChange:Ya,class:"modern-date-picker"},null,8,["modelValue"])]),d("div",il,[e[19]||(e[19]=d("label",{class:"filter-label"},"部門",-1)),f(s,{modelValue:$.value,"onUpdate:modelValue":e[1]||(e[1]=o=>$.value=o),placeholder:"請選擇部門",onChange:Ta,disabled:!0,class:"modern-select"},{default:h(()=>[(p(!0),y(O,null,W(ee.value,o=>(p(),T(l,{key:o._id,label:o.name,value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),d("div",rl,[e[20]||(e[20]=d("label",{class:"filter-label"},"單位",-1)),f(s,{modelValue:z.value,"onUpdate:modelValue":e[2]||(e[2]=o=>z.value=o),placeholder:"請選擇單位",onChange:Fa,class:"modern-select"},{default:h(()=>[(p(!0),y(O,null,W(ya.value,o=>(p(),T(l,{key:o._id,label:o.name,value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),ie.value?(p(),y("div",ul,[e[21]||(e[21]=d("label",{class:"filter-label"},"包含自己",-1)),f(i,{modelValue:Q.value,"onUpdate:modelValue":e[3]||(e[3]=o=>Q.value=o),"active-text":"是","inactive-text":"否","inline-prompt":""},null,8,["modelValue"])])):N("",!0)])]),Se(je)?(p(),y("div",dl,[d("div",cl,[e[23]||(e[23]=d("div",{class:"publish-header-text"},[d("h3",{class:"publish-title"},"發布狀態"),d("p",{class:"publish-subtitle"},"追蹤班表送審、回覆與鎖定流程")],-1)),d("span",{class:Zt(["status-badge",`status-${C.value.status}`]),"data-test":"publish-status-badge"},S(ga.value),3)]),d("div",pl,[f(r,{active:ba.value,"finish-status":"success","align-center":""},{default:h(()=>[f(c,{title:"草稿",description:"建立班表草稿",status:nt.value.draft},null,8,["status"]),f(c,{title:"待確認",description:Sa.value,status:nt.value.pending},null,8,["description","status"]),f(c,{title:"異議",description:wa.value,status:nt.value.disputed},null,8,["description","status"]),f(c,{title:"完成",description:ka.value,status:nt.value.finalized},null,8,["description","status"])]),_:1},8,["active"])]),d("div",vl,[C.value.publishedAt?(p(),y("p",fl," 最近發布："+S(Ca(C.value.publishedAt)),1)):(p(),y("p",ml,"本月尚未發布。")),bt.value>0&&C.value.status!=="finalized"?(p(),y("div",hl,[f(u,{percentage:bt.value,"stroke-width":8,status:"success","show-text":!1},null,8,["percentage"]),d("span",yl,S(bt.value)+"% 完成",1)])):N("",!0)]),d("div",_l,[f(n,{type:"primary",class:"publish-btn",loading:He.value,disabled:Rt.value,onClick:Aa},{default:h(()=>[...e[24]||(e[24]=[V(" 發送待確認 ",-1)])]),_:1},8,["loading","disabled"]),f(n,{type:"success",plain:"",class:"publish-btn",loading:Ge.value,disabled:Tt.value,onClick:Ia},{default:h(()=>[...e[25]||(e[25]=[V(" 完成發布 ",-1)])]),_:1},8,["loading","disabled"])]),d("div",gl,[Pe.value?(p(),y("div",bl,[d("div",Sl,[e[26]||(e[26]=d("span",{class:"card-title"},"待回覆",-1)),d("span",wl,S(Pe.value),1)]),d("ul",kl,[(p(!0),y(O,null,W(C.value.pendingEmployees,o=>(p(),y("li",{key:o.id,class:"card-item"},[d("span",Cl,S(o.name),1),d("span",El,S(o.pendingCount)+" 筆",1)]))),128))])])):N("",!0),Oe.value?(p(),y("div",Dl,[d("div",Al,[e[27]||(e[27]=d("span",{class:"card-title"},"異議",-1)),d("span",Il,S(Oe.value),1)]),d("ul",$l,[(p(!0),y(O,null,W(C.value.disputedEmployees,o=>(p(),y("li",{key:o.id,class:"card-item"},[d("div",Vl,[d("span",xl,S(o.name),1),d("span",zl,S(o.disputedCount)+" 筆",1)]),o.latestNote?(p(),y("div",Ml," 最新意見："+S(o.latestNote),1)):N("",!0)]))),128))])])):N("",!0),!Pe.value&&!Oe.value&&C.value.status!=="draft"&&C.value.status!=="finalized"?(p(),y("div",jl,[...e[28]||(e[28]=[d("div",{class:"card-header"},[d("span",{class:"card-title"},"回覆完成"),d("span",{class:"card-badge success"},"✓")],-1),d("p",{class:"card-message"},"所有員工已完成回覆，可執行最終發布。",-1)])])):N("",!0),C.value.status==="finalized"?(p(),y("div",Nl,[...e[29]||(e[29]=[d("div",{class:"card-header"},[d("span",{class:"card-title"},"已鎖定"),d("span",{class:"card-badge success"},"100%")],-1),d("p",{class:"card-message"},"班表已完成發布並鎖定。",-1)])])):N("",!0)])])):N("",!0),d("div",Pl,[d("div",Ol,[f(n,{type:"primary",class:"action-btn primary",onClick:ra,disabled:!_t.value},{default:h(()=>[...e[30]||(e[30]=[d("i",{class:"el-icon-close"},null,-1),V(" 清除選取 ",-1)])]),_:1},8,["disabled"]),f(n,{type:"primary",class:"action-btn primary",plain:"",onClick:pa,disabled:!B.value.length},{default:h(()=>[...e[31]||(e[31]=[d("i",{class:"el-icon-user"},null,-1),V(" 全選員工 ",-1)])]),_:1},8,["disabled"]),f(n,{type:"primary",class:"action-btn primary",plain:"",onClick:va,disabled:!re.value.length},{default:h(()=>[...e[32]||(e[32]=[d("i",{class:"el-icon-date"},null,-1),V(" 全選日期 ",-1)])]),_:1},8,["disabled"])]),d("div",Ll,[d("div",Rl,[e[33]||(e[33]=d("label",{class:"range-label"},"自訂日期範圍",-1)),f(a,{modelValue:pt.value,"onUpdate:modelValue":e[4]||(e[4]=o=>pt.value=o),type:"daterange","start-placeholder":"開始日期","end-placeholder":"結束日期","range-separator":"至","unlink-panels":"",disabled:!re.value.length,class:"modern-date-picker range-picker",onChange:fa},null,8,["modelValue","disabled"])]),f(n,{onClick:e[5]||(e[5]=o=>Bt("week")),class:"action-btn secondary"},{default:h(()=>[...e[34]||(e[34]=[d("i",{class:"el-icon-calendar"},null,-1),V(" 預覽週表 ",-1)])]),_:1}),f(n,{onClick:e[6]||(e[6]=o=>Bt("month")),class:"action-btn secondary"},{default:h(()=>[...e[35]||(e[35]=[d("i",{class:"el-icon-date"},null,-1),V(" 預覽月表 ",-1)])]),_:1}),f(n,{onClick:e[7]||(e[7]=()=>Jt("pdf")),class:"action-btn export"},{default:h(()=>[...e[36]||(e[36]=[d("i",{class:"el-icon-download"},null,-1),V(" 匯出 PDF ",-1)])]),_:1}),f(n,{onClick:e[8]||(e[8]=()=>Jt("excel")),class:"action-btn export"},{default:h(()=>[...e[37]||(e[37]=[d("i",{class:"el-icon-s-grid"},null,-1),V(" 匯出 Excel ",-1)])]),_:1})])]),d("div",Tl,[d("div",Fl,[e[39]||(e[39]=d("h3",{class:"schedule-title"},"員工排班表",-1)),d("div",Ul,[Mt.value.length?(p(!0),y(O,{key:0},W(Mt.value,o=>(p(),y("span",{key:o.key,class:"legend-item",style:dt(o.style),"data-test":"shift-legend-item"},S(o.label),5))),128)):(p(),y("span",Yl," 尚未設定班別 ")),e[38]||(e[38]=d("span",{class:"legend-item leave"},"請假",-1))]),f(_,{modelValue:Je.value,"onUpdate:modelValue":e[9]||(e[9]=o=>Je.value=o),placeholder:"搜尋員工",clearable:"",class:"employee-search"},null,8,["modelValue"]),f(s,{modelValue:Ke.value,"onUpdate:modelValue":e[10]||(e[10]=o=>Ke.value=o),placeholder:"狀態",class:"status-filter"},{default:h(()=>[f(l,{label:"全部",value:"all"}),f(l,{label:"缺班",value:"unscheduled"}),f(l,{label:"待審核請假",value:"onLeave"})]),_:1},8,["modelValue"])]),Se(je)?(p(),y("div",Bl,[f(s,{modelValue:qe.value,"onUpdate:modelValue":e[11]||(e[11]=o=>qe.value=o),placeholder:"套用班別",class:"modern-select batch-select",filterable:"","data-test":"batch-shift-select"},{default:h(()=>[(p(!0),y(O,null,W(he.value,o=>(p(),T(l,{key:o._id,label:it(o),value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(s,{modelValue:_e.value,"onUpdate:modelValue":e[12]||(e[12]=o=>_e.value=o),placeholder:"套用部門",clearable:"",class:"modern-select batch-select","data-test":"batch-dept-select"},{default:h(()=>[(p(!0),y(O,null,W(ee.value,o=>(p(),T(l,{key:o._id,label:o.name,value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(s,{modelValue:ve.value,"onUpdate:modelValue":e[13]||(e[13]=o=>ve.value=o),placeholder:"套用單位",clearable:"",class:"modern-select batch-select",disabled:!_e.value,"data-test":"batch-subdept-select"},{default:h(()=>[(p(!0),y(O,null,W(jt.value,o=>(p(),T(l,{key:o._id,label:o.name,value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),f(n,{type:"primary",class:"action-btn primary apply-btn",disabled:!_t.value||!qe.value||tt.value,loading:tt.value,onClick:Ua,"data-test":"batch-apply-button"},{default:h(()=>[...e[40]||(e[40]=[V(" 套用至選取 ",-1)])]),_:1},8,["disabled","loading"])])):N("",!0),f(b,{class:"modern-schedule-table",data:Me.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"},onRowClick:e[15]||(e[15]=o=>Ot.value&&ha(o._id))},{default:h(()=>[f(E,{label:"部門／單位",width:"180",fixed:"left"},{default:h(({row:o})=>[d("div",Jl,[d("div",Kl,S(o.department),1),o.subDepartment?(p(),y("div",Wl,S(o.subDepartment),1)):N("",!0)])]),_:1}),f(E,{prop:"name",label:"員工姓名",width:"150",fixed:"left"},{default:h(({row:o})=>[d("div",ql,[Se(je)?(p(),T(I,{key:0,class:"row-checkbox","model-value":la.value.has(o._id),onChange:v=>ua(o._id,v)},null,8,["model-value","onChange"])):N("",!0),gt(o._id)==="unscheduled"?(p(),T(Et(Se(ta)),{key:1,class:"status-icon unscheduled"})):gt(o._id)==="onLeave"?(p(),T(Et(Se(aa)),{key:2,class:"status-icon on-leave"})):N("",!0),V(" "+S(o.name),1)])]),_:1}),(p(!0),y(O,null,W(re.value,o=>(p(),T(E,{key:o.date,label:o.label,width:"140",align:"center"},{header:h(()=>[d("div",Hl,[d("span",null,S(o.label),1),Se(je)?(p(),T(I,{key:0,class:"day-checkbox","model-value":sa.value.has(o.date),onChange:v=>da(o.date,v)},null,8,["model-value","onChange"])):N("",!0)])]),default:h(({row:v})=>{var H,j,se,G,de,Ct,Re;return[!Ot.value||et.value.has(v._id)?(p(),y("div",{key:0,class:Zt(["modern-schedule-cell",[{"has-leave":Z(v._id,o.date),"missing-shift":!((j=(H=m.value[v._id])==null?void 0:H[o.date])!=null&&j.shiftId)&&!Z(v._id,o.date),"is-selected":ia(v._id,o.date),"has-shift":!Z(v._id,o.date)&&!!((G=(se=m.value[v._id])==null?void 0:se[o.date])!=null&&G.shiftId)}]]),style:dt(Z(v._id,o.date)?void 0:kt((Ct=(de=m.value[v._id])==null?void 0:de[o.date])==null?void 0:Ct.shiftId)),title:Va(v._id,o.date)},[Se(je)&&!Z(v._id,o.date)?(p(),y("div",{key:0,class:"cell-selection",onClick:e[14]||(e[14]=qa(()=>{},["stop"]))},[f(I,{"model-value":na.value.has(ge(v._id,o.date)),onChange:A=>ca(v._id,o.date,A),size:"small"},null,8,["model-value","onChange"])])):N("",!0),(Re=m.value[v._id])!=null&&Re[o.date]?(p(),y(O,{key:1},[Z(v._id,o.date)?(p(),y("div",Ql,[f(F,{type:"warning",effect:"light",size:"small",class:"leave-tag"},{default:h(()=>[...e[41]||(e[41]=[V(" 休假中 ",-1)])]),_:1}),e[42]||(e[42]=d("span",{class:"leave-note"},"已核准請假，不列入工時",-1))])):Se(je)?(p(),y(O,{key:1},[f(s,{modelValue:m.value[v._id][o.date].shiftId,"onUpdate:modelValue":A=>m.value[v._id][o.date].shiftId=A,placeholder:"選擇班別",onChange:A=>Ra(v._id,o.date,A),class:"cell-select shift-select",size:"small"},{default:h(()=>[(p(!0),y(O,null,W(he.value,A=>(p(),T(l,{key:A._id,label:it(A),value:A._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),d("div",Xl,[f(s,{modelValue:m.value[v._id][o.date].department,"onUpdate:modelValue":A=>m.value[v._id][o.date].department=A,placeholder:"部門",size:"small",onChange:()=>m.value[v._id][o.date].subDepartment="",class:"cell-select dept-select"},{default:h(()=>[(p(!0),y(O,null,W(ee.value,A=>(p(),T(l,{key:A._id,label:A.name,value:A._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"]),f(s,{modelValue:m.value[v._id][o.date].subDepartment,"onUpdate:modelValue":A=>m.value[v._id][o.date].subDepartment=A,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:h(()=>[(p(!0),y(O,null,W(Wt(m.value[v._id][o.date].department),A=>(p(),T(l,{key:A._id,label:A.name,value:A._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(p(),y(O,{key:2},[be(m.value[v._id][o.date].shiftId)?(p(),T(M,{key:0,placement:"top",trigger:"hover",width:200},{reference:h(()=>[d("div",{class:"modern-shift-tag",style:dt(kt(be(m.value[v._id][o.date].shiftId)))},S(it(be(m.value[v._id][o.date].shiftId))),5)]),default:h(()=>[d("div",Zl,[d("div",es,[e[43]||(e[43]=d("span",{class:"detail-label"},"上班時間：",-1)),d("span",ts,S(be(m.value[v._id][o.date].shiftId).startTime),1)]),d("div",as,[e[44]||(e[44]=d("span",{class:"detail-label"},"下班時間：",-1)),d("span",ls,S(be(m.value[v._id][o.date].shiftId).endTime),1)]),be(m.value[v._id][o.date].shiftId).remark?(p(),y("div",ss,[e[45]||(e[45]=d("span",{class:"detail-label"},"備註：",-1)),d("span",ns,S(be(m.value[v._id][o.date].shiftId).remark),1)])):N("",!0)])]),_:2},1024)):N("",!0)],64)),!m.value[v._id][o.date].shiftId&&!Z(v._id,o.date)?(p(),y("div",os," 未排班 ")):N("",!0)],64)):(p(),y("span",is,"-"))],14,Gl)):(p(),y("div",rs," 展開班表 "))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"]),ze.value.length?(p(),y("div",us,[f(D,{background:"",layout:"prev, pager, next, ->, sizes, total",total:ze.value.length,"page-size":fe.value,"current-page":X.value,"page-sizes":[10,20,30,50],onCurrentChange:Pa,onSizeChange:Oa},null,8,["total","page-size","current-page"])])):N("",!0)]),Ve.value.length?(p(),y("div",ds,[d("div",cs,[e[46]||(e[46]=d("h3",{class:"approval-title"},"待處理審批",-1)),d("div",ps,S(Ve.value.length)+" 項待處理",1)]),f(b,{class:"modern-approval-table",data:Ve.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:h(()=>[f(E,{label:"申請人",width:"120"},{default:h(({row:o})=>{var v;return[d("div",vs,S((v=o.applicant_employee)==null?void 0:v.name),1)]}),_:1}),f(E,{label:"申請類型",width:"150"},{default:h(({row:o})=>{var v,H;return[d("div",fs,S(It((v=o.form)==null?void 0:v.category,(H=o.form)==null?void 0:H.name)),1)]}),_:1}),f(E,{prop:"status",label:"狀態",width:"100"},{default:h(({row:o})=>[f(F,{type:o.status==="approved"?"success":o.status==="rejected"?"danger":"warning",class:"status-tag"},{default:h(()=>[V(S(o.status),1)]),_:2},1032,["type"])]),_:1}),f(E,{label:"操作",width:"120"},{default:h(({row:o})=>[f(n,{size:"small",onClick:v=>La(o._id),disabled:!o._id},{default:h(()=>[...e[47]||(e[47]=[V(" 查看 ",-1)])]),_:1},8,["onClick","disabled"])]),_:1})]),_:1},8,["data"])])):N("",!0)]),f(J,{modelValue:R.visible,"onUpdate:modelValue":e[17]||(e[17]=o=>R.visible=o),title:"申請單明細",width:"760px"},{footer:h(()=>[f(n,{onClick:e[16]||(e[16]=o=>R.visible=!1)},{default:h(()=>[...e[54]||(e[54]=[V("關閉",-1)])]),_:1})]),default:h(()=>{var o,v,H;return[R.doc?(p(),y("div",ms,[d("p",hs,[e[49]||(e[49]=d("b",null,"表單：",-1)),V(S((o=R.doc.form)==null?void 0:o.name)+"（"+S((v=R.doc.form)==null?void 0:v.category)+"） ",1)]),d("p",ys,[e[50]||(e[50]=d("b",null,"申請人：",-1)),V(S(((H=R.doc.applicant_employee)==null?void 0:H.name)||"-"),1)]),d("p",_s,[e[51]||(e[51]=d("b",null,"狀態：",-1)),V(S(Ut(R.doc.status)),1)]),f(U,{"content-position":"left"},{default:h(()=>[...e[52]||(e[52]=[V("填寫內容",-1)])]),_:1}),f(Le,{column:1,size:"small",border:""},{default:h(()=>{var j;return[(p(!0),y(O,null,W(((j=R.doc.form)==null?void 0:j.fields)||[],se=>(p(),T(Ze,{key:se._id,label:se.label},{default:h(()=>{var G;return[d("span",null,S(ct((G=R.doc.form_data)==null?void 0:G[se._id])),1)]}),_:2},1032,["label"]))),128))]}),_:1}),f(U,{"content-position":"left"},{default:h(()=>[...e[53]||(e[53]=[V("流程",-1)])]),_:1}),f(ae,null,{default:h(()=>[(p(!0),y(O,null,W(R.doc.steps,(j,se)=>(p(),T(k,{key:se,timestamp:`第 ${se+1} 關`,type:se===R.doc.current_step_index?"primary":"info"},{default:h(()=>[d("div",gs,[d("span",bs,"需全員同意："+S(j.all_must_approve?"是":"否"),1),d("span",null,"必簽："+S(j.is_required?"是":"否"),1)]),f(b,{data:j.approvers,size:"small",border:""},{default:h(()=>[f(E,{label:"審核人",width:"200"},{default:h(({row:G})=>[V(S($a(G.approver)),1)]),_:1}),f(E,{label:"決議",width:"120"},{default:h(({row:G})=>[V(S(Ut(G.decision)),1)]),_:1}),f(E,{label:"時間",width:"200"},{default:h(({row:G})=>[V(S(Fe(G.decided_at)),1)]),_:1}),f(E,{prop:"comment",label:"意見"})]),_:1},8,["data"])]),_:2},1032,["timestamp","type"]))),128))]),_:1})])):N("",!0)]}),_:1},8,["modelValue"])],64)}}},As=ea(ws,[["__scopeId","data-v-11172d69"]]);export{As as default};
