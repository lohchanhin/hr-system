import{_ as fe,r as k,J as X,y as Z,v as W,k as ee,j as be,E as m,c as S,b as c,d as A,l as M,x as D,w as h,e as L,o as p,F as Y,m as R,g as ae,t as le}from"./index-DJQU6_8E.js";import{a as $}from"./api-RXpq1hcj.js";const ge={class:"department-reports-page"},he={class:"filters-grid"},we={class:"filter-item"},_e={class:"filter-item"},xe={class:"filter-item"},ke={class:"filter-item"},We={class:"actions"},Se={key:0,class:"summary-grid"},Ae={class:"summary-label"},Le={class:"summary-value"},Ee={__name:"DepartmentReports",setup(Me){const w=k([]),N=k(""),j=k(""),H=k([]),E=k(X().format("YYYY-MM")),f=k(""),n=k(""),_=k(""),C=k(!1),r=Z({loading:!1,state:"idle",summary:null,records:[]}),v=Z({departments:!1,templates:!1}),V={attendance:"/api/reports/department/attendance/export",leave:"/api/reports/department/leave/export",tardiness:"/api/reports/department/tardiness/export",earlyLeave:"/api/reports/department/early-leave/export",workHours:"/api/reports/department/work-hours/export",overtime:"/api/reports/department/overtime/export",compTime:"/api/reports/department/comp-time/export",makeUp:"/api/reports/department/make-up/export",specialLeave:"/api/reports/department/special-leave/export"},z={excel:"Excel (.xlsx)",pdf:"PDF (.pdf)"},te={excel:"xlsx",pdf:"pdf"},I=W(()=>!!(f.value&&w.value.some(l=>String(l==null?void 0:l._id)===String(f.value)))),re=W(()=>{const l=new Map;return H.value.forEach(a=>{a!=null&&a.type&&!l.has(a.type)&&l.set(a.type,a)}),l}),B=W(()=>{const l=[],a=new Set;return H.value.forEach(s=>{var u,i;const e=s==null?void 0:s.type;if(!e||a.has(e)||!V[e])return;const d=((i=(u=s==null?void 0:s.name)==null?void 0:u.trim)==null?void 0:i.call(u))||e;l.push({value:e,label:d}),a.add(e)}),l}),q=W(()=>n.value&&re.value.get(n.value)||null),F=W(()=>{const l=q.value;if(!l)return[];const a=new Set;return(Array.isArray(l.exportFormats)?l.exportFormats:[]).map(e=>typeof e=="string"?e.trim().toLowerCase():"").filter(e=>!e||!z[e]||a.has(e)?!1:(a.add(e),!0)).map(e=>({value:e,label:z[e]}))}),O=W(()=>!E.value||!I.value||!n.value||!V[n.value]?!1:F.value.some(l=>l.value===_.value)),P=W(()=>!!(E.value&&I.value&&n.value&&V[n.value]&&q.value));ee(B,l=>{if(!Array.isArray(l)||l.length===0){n.value="";return}l.some(s=>s.value===n.value)||(n.value=l[0].value)},{immediate:!0}),ee(F,l=>{if(!Array.isArray(l)||l.length===0){_.value="";return}l.some(s=>s.value===_.value)||(_.value=l[0].value)},{immediate:!0});const se=W(()=>n.value==="attendance"?[{prop:"scheduled",label:"排班天數",minWidth:120},{prop:"attended",label:"出勤天數",minWidth:120},{prop:"absent",label:"缺勤天數",minWidth:120}]:n.value==="leave"?[{prop:"leaveType",label:"假別",minWidth:160},{prop:"startDate",label:"開始日期",minWidth:140},{prop:"endDate",label:"結束日期",minWidth:140},{prop:"days",label:"天數",minWidth:100}]:n.value==="tardiness"?[{prop:"date",label:"日期",minWidth:140},{prop:"scheduledStart",label:"排定上班",minWidth:140},{prop:"actualClockIn",label:"實際打卡",minWidth:140},{prop:"minutesLate",label:"遲到分鐘",minWidth:120}]:n.value==="earlyLeave"?[{prop:"date",label:"日期",minWidth:140},{prop:"scheduledEnd",label:"排定下班",minWidth:140},{prop:"actualClockOut",label:"實際打卡",minWidth:140},{prop:"minutesEarly",label:"早退分鐘",minWidth:120}]:n.value==="workHours"?[{prop:"date",label:"日期",minWidth:140},{prop:"scheduledHours",label:"排定工時(小時)",minWidth:160},{prop:"workedHours",label:"實際工時(小時)",minWidth:160},{prop:"differenceHours",label:"差異(小時)",minWidth:140}]:n.value==="overtime"?[{prop:"date",label:"日期",minWidth:140},{prop:"startTime",label:"開始時間",minWidth:120},{prop:"endTime",label:"結束時間",minWidth:120},{prop:"hours",label:"時數",minWidth:100},{prop:"reason",label:"原因",minWidth:180}]:n.value==="compTime"?[{prop:"date",label:"日期",minWidth:140},{prop:"hours",label:"補休時數",minWidth:120},{prop:"overtimeReference",label:"來源加班單",minWidth:180}]:n.value==="makeUp"?[{prop:"date",label:"日期",minWidth:140},{prop:"category",label:"補卡類別",minWidth:160},{prop:"note",label:"補卡說明",minWidth:200}]:n.value==="specialLeave"?[{prop:"startDate",label:"開始日期",minWidth:140},{prop:"endDate",label:"結束日期",minWidth:140},{prop:"days",label:"天數",minWidth:100}]:[]),ne=W(()=>{if(!r.summary)return[];if(n.value==="attendance")return[{label:"排班總計",value:r.summary.scheduled},{label:"出勤總計",value:r.summary.attended},{label:"缺勤總計",value:r.summary.absent}];if(n.value==="leave"){const l=[{label:"總請假件數",value:r.summary.totalLeaves},{label:"總請假天數",value:r.summary.totalDays}],a=Array.isArray(r.summary.byType)?r.summary.byType.map(s=>({label:`${s.leaveType||s.leaveCode} 件數`,value:`${s.count??0} 筆 / ${s.days??0} 天`})):[];return[...l,...a]}if(n.value==="tardiness")return[{label:"遲到件數",value:r.summary.totalLateCount??0},{label:"遲到總分鐘",value:r.summary.totalLateMinutes??0},{label:"平均遲到分鐘",value:r.summary.averageLateMinutes??0}];if(n.value==="earlyLeave")return[{label:"早退件數",value:r.summary.totalEarlyLeaveCount??0},{label:"早退總分鐘",value:r.summary.totalEarlyMinutes??0},{label:"平均早退分鐘",value:r.summary.averageEarlyMinutes??0}];if(n.value==="workHours")return[{label:"排定總工時",value:r.summary.totalScheduledHours??0},{label:"實際總工時",value:r.summary.totalWorkedHours??0},{label:"工時差異",value:r.summary.differenceHours??0}];if(n.value==="overtime")return[{label:"加班申請數",value:r.summary.totalRequests??0},{label:"加班總時數",value:r.summary.totalHours??0}];if(n.value==="compTime")return[{label:"補休申請數",value:r.summary.totalRequests??0},{label:"補休總時數",value:r.summary.totalHours??0}];if(n.value==="makeUp"){const l=[{label:"補卡申請數",value:r.summary.totalRequests??0}],a=Array.isArray(r.summary.byCategory)?r.summary.byCategory.map(s=>({label:`${s.label??"未分類"} 件數`,value:`${s.count??0} 筆`})):[];return[...l,...a]}return n.value==="specialLeave"?[{label:"特休申請數",value:r.summary.totalRequests??0},{label:"特休總天數",value:r.summary.totalDays??0}]:[]});be(async()=>{v.departments=!0,v.templates=!0;try{await ue(),await ie(),await de()}catch(l){m.error(l.message||"載入主管報表資訊失敗")}finally{v.departments=!1,v.templates=!1}});const oe=()=>{var s,e;if(typeof window>"u")return"";const l=(s=window.sessionStorage)==null?void 0:s.getItem("employeeId");if(l&&l!=="undefined")return l;const a=(e=window.localStorage)==null?void 0:e.getItem("employeeId");return a&&a!=="undefined"?a:""};async function ue(){const l=oe();if(!l){N.value="",j.value="",m.warning("尚未取得登入者資料，請重新登入後再試");return}const a=await $(`/api/employees/${l}`);if(!a.ok)throw new Error("無法取得主管資訊");const s=await a.json(),e=s==null?void 0:s.department,d=typeof e=="object"?(e==null?void 0:e._id)||(e==null?void 0:e.id)||(e==null?void 0:e.value):e,u=typeof e=="object"?(e==null?void 0:e.name)||"":(s==null?void 0:s.departmentName)||"";N.value=d?String(d):"",j.value=u?String(u):""}async function ie(){if(!N.value&&!j.value){w.value=[],f.value="",m.warning("尚未為您設定可管理的部門，請聯絡系統管理員");return}const l=await $("/api/departments");if(!l.ok)throw new Error("無法取得部門清單");const a=await l.json(),s=Array.isArray(a)?a.map(t=>{const y=(t==null?void 0:t._id)??(t==null?void 0:t.id)??(t==null?void 0:t.value)??(typeof t=="string"?t:""),b=(t==null?void 0:t.name)??(t==null?void 0:t.label)??(t==null?void 0:t.departmentName)??"";return{...t,_id:y?String(y):"",name:String(b||(t==null?void 0:t.name)||"")}}):[],e=N.value,d=j.value.trim().toLowerCase();let u=s.filter(t=>{const y=String((t==null?void 0:t._id)||""),b=String((t==null?void 0:t.name)||"").trim().toLowerCase();return e&&y===e||d&&b&&b===d});if(!u.length&&e&&(u=[{_id:e,name:j.value||"主管部門"}]),u=u.filter(t=>t==null?void 0:t._id),w.value=u,!w.value.length){f.value="",m.warning("未找到與您相符的部門，請聯絡系統管理員");return}const i=w.value.find(t=>t._id===e);f.value=(i==null?void 0:i._id)||w.value[0]._id||""}async function de(){const l=await $("/api/reports/department/templates");if(!l.ok)throw new Error("無法取得主管報表設定");const a=await l.json(),s=Array.isArray(a)?a.map(e=>{var U;const d=(e==null?void 0:e.id)??(e==null?void 0:e._id)??"",u=typeof(e==null?void 0:e.type)=="string"?e.type.trim():"",i=typeof(e==null?void 0:e.name)=="string"?e.name.trim():"",y=(Array.isArray((U=e==null?void 0:e.exportSettings)==null?void 0:U.formats)?e.exportSettings.formats:Array.isArray(e==null?void 0:e.exportFormats)?e.exportFormats:[]).map(x=>typeof x=="string"?x.trim().toLowerCase():"").filter(Boolean),b=e!=null&&e.permissionSettings&&typeof e.permissionSettings=="object"?{...e.permissionSettings}:{},o=e!=null&&e.exportSettings&&typeof e.exportSettings=="object"?{...e.exportSettings}:{formats:[]};return{id:d?String(d):"",type:u,name:i||u,exportFormats:y,permissionSettings:b,exportSettings:o}}).filter(e=>e.type):[];H.value=s,s.length||(n.value="",_.value="",m.warning("目前沒有開放的主管報表模板"))}function J(){return I.value?!0:(m.warning("目前無可操作的部門，請確認您的部門權限設定"),!1)}function K(l){return`?${new URLSearchParams(l).toString()}`}async function ce(){var a,s;if(!P.value&&!J()||!P.value)return;const l=V[n.value];if(!l){m.warning("此報表尚未開放預覽");return}r.loading=!0,r.state="loading";try{const e=K({month:E.value,department:f.value,format:"json"}),d=await $(`${l}${e}`,{headers:{Accept:"application/json"}}),u=((s=(a=d.headers)==null?void 0:a.get)==null?void 0:s.call(a,"content-type"))||"";if(!d.ok){const t=u.includes("application/json")?await d.json():null;throw new Error((t==null?void 0:t.error)||(t==null?void 0:t.message)||"預覽失敗")}if(!u.includes("application/json")){r.state="idle",r.summary=null,r.records=[],m.info("此報表不提供預覽，請直接匯出");return}const i=await d.json();r.summary=(i==null?void 0:i.summary)??null,r.records=Array.isArray(i==null?void 0:i.records)?i.records:[],!r.records.length&&!r.summary?r.state="empty":r.state="success"}catch(e){r.state="idle",r.summary=null,r.records=[],m.error(e.message||"預覽失敗")}finally{r.loading=!1}}async function pe(){var a,s,e,d;if(C.value||!O.value&&!J()||!O.value)return;const l=V[n.value];if(!l){m.error("尚未提供此報表的匯出服務");return}C.value=!0;try{const u=K({month:E.value,department:f.value,format:_.value}),i=await $(`${l}${u}`,{headers:{Accept:"application/octet-stream"}}),t=((s=(a=i.headers)==null?void 0:a.get)==null?void 0:s.call(a,"content-type"))||"";if(!i.ok){const g=t.includes("application/json")?await i.json():null;throw new Error((g==null?void 0:g.error)||(g==null?void 0:g.message)||"匯出失敗")}const y=await i.blob(),b=te[_.value]||"dat",o=((e=E.value)==null?void 0:e.replace("-",""))||X().format("YYYYMM"),U=((d=w.value.find(g=>g._id===f.value))==null?void 0:d.name)||"department",x=q.value,me=(x==null?void 0:x.type)||n.value||"report",ve=(x==null?void 0:x.name)||me,Q=g=>String(g).trim().replace(/\s+/g,"-").replace(/[^\w\u4e00-\u9fa5-]+/gi,""),ye=`${o}-${Q(U)}-${Q(ve)}.${b}`,G=window.URL.createObjectURL(y),T=document.createElement("a");T.href=G,T.download=ye,document.body.appendChild(T),T.click(),document.body.removeChild(T),window.URL.revokeObjectURL(G),m.success("匯出成功")}catch(u){m.error(u.message||"匯出失敗")}finally{C.value=!1}}return(l,a)=>{const s=L("el-date-picker"),e=L("el-option"),d=L("el-select"),u=L("el-button"),i=L("el-card"),t=L("el-alert"),y=L("el-table-column"),b=L("el-table");return p(),S("div",ge,[a[12]||(a[12]=c("header",{class:"page-header"},[c("h1",{class:"page-title"},"部門報表中心"),c("p",{class:"page-subtitle"},"彙整各部門出勤與請假統計")],-1)),A(i,{class:"filters-card",shadow:"never"},{header:h(()=>a[4]||(a[4]=[c("div",{class:"card-header"},[c("h2",null,"匯出條件"),c("span",{class:"card-tip"},"請先選擇月份、部門與報表種類")],-1)])),default:h(()=>[c("div",he,[c("div",we,[a[5]||(a[5]=c("label",{class:"filter-label"},"月份",-1)),A(s,{modelValue:E.value,"onUpdate:modelValue":a[0]||(a[0]=o=>E.value=o),type:"month",placeholder:"選擇月份",format:"YYYY 年 MM 月","value-format":"YYYY-MM",disabled:v.departments,class:"w-full"},null,8,["modelValue","disabled"])]),c("div",_e,[a[6]||(a[6]=c("label",{class:"filter-label"},"部門",-1)),A(d,{modelValue:f.value,"onUpdate:modelValue":a[1]||(a[1]=o=>f.value=o),placeholder:"選擇部門",filterable:"",loading:v.departments,disabled:v.departments||w.value.length===0,class:"w-full"},{default:h(()=>[(p(!0),S(Y,null,R(w.value,o=>(p(),M(e,{key:o._id,label:o.name,value:o._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),c("div",xe,[a[7]||(a[7]=c("label",{class:"filter-label"},"報表種類",-1)),A(d,{modelValue:n.value,"onUpdate:modelValue":a[2]||(a[2]=o=>n.value=o),placeholder:"選擇報表",class:"w-full",disabled:v.templates||B.value.length===0,loading:v.templates},{default:h(()=>[(p(!0),S(Y,null,R(B.value,o=>(p(),M(e,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled","loading"])]),c("div",ke,[a[8]||(a[8]=c("label",{class:"filter-label"},"匯出格式",-1)),A(d,{modelValue:_.value,"onUpdate:modelValue":a[3]||(a[3]=o=>_.value=o),placeholder:"選擇格式",class:"w-full",disabled:v.templates||F.value.length===0,loading:v.templates},{default:h(()=>[(p(!0),S(Y,null,R(F.value,o=>(p(),M(e,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled","loading"])])]),c("div",We,[A(u,{disabled:!P.value||r.loading,loading:r.loading,onClick:ce},{default:h(()=>a[9]||(a[9]=[ae(" 預覽摘要 ")])),_:1},8,["disabled","loading"]),A(u,{type:"primary",disabled:!O.value||C.value,loading:C.value,onClick:pe},{default:h(()=>a[10]||(a[10]=[ae(" 匯出報表 ")])),_:1},8,["disabled","loading"])])]),_:1}),r.state==="empty"?(p(),M(t,{key:0,type:"info","show-icon":"",class:"mt-4",title:"目前條件下沒有可供預覽的資料"})):D("",!0),r.state==="success"?(p(),M(i,{key:1,class:"preview-card",shadow:"never"},{header:h(()=>a[11]||(a[11]=[c("div",{class:"card-header"},[c("h2",null,"報表摘要"),c("span",{class:"card-tip"},"以下內容來自後端 JSON 預覽")],-1)])),default:h(()=>[r.summary?(p(),S("div",Se,[(p(!0),S(Y,null,R(ne.value,o=>(p(),S("div",{class:"summary-item",key:o.label},[c("span",Ae,le(o.label),1),c("span",Le,le(o.value),1)]))),128))])):D("",!0),r.records.length?(p(),M(b,{key:1,data:r.records,border:"",class:"preview-table"},{default:h(()=>[A(y,{prop:"name",label:"員工","min-width":"140"}),(p(!0),S(Y,null,R(se.value,o=>(p(),M(y,{key:o.prop,prop:o.prop,label:o.label,"min-width":o.minWidth||120},null,8,["prop","label","min-width"]))),128))]),_:1},8,["data"])):D("",!0)]),_:1})):D("",!0)])}}},Ve=fe(Ee,[["__scopeId","data-v-a677290f"]]);export{Ve as default};
