import{a as _}from"./api-BujQ9oFr.js";import{n as Ve,s as ke,p as We}from"./fieldOptions-BCLrdzho.js";import{_ as Ge,r as A,v as q,k as ie,j as He,c as h,b as I,d as u,w as r,e as w,o as f,l as b,F as C,m as U,g,t as pe,x as Ke}from"./index-BclQli2C.js";const Ye={class:"approval-flow-setting"},Qe={class:"flex items-center gap-2 mb-2"},Xe={key:1,class:"text-gray-500"},Ze={class:"tab-content"},el={class:"mb-2"},ll={class:"tab-content"},al={class:"flex items-center gap-2 mb-2"},tl={key:1,class:"text-gray-500"},H="APPLICANT_SUPERVISOR",ol={__name:"ApprovalFlowSetting",setup(nl){const V={forms:"/api/approvals/forms",workflow:a=>`/api/approvals/forms/${a}/workflow`,fields:a=>`/api/approvals/forms/${a}/fields`,field:(a,e)=>`/api/approvals/forms/${a}/fields/${e}`,employees:"/api/employees/options",organizations:"/api/organizations",signRoles:"/api/approvals/sign-roles",signLevels:"/api/approvals/sign-levels",otherControlSettings:"/api/other-control-settings",subDepartments:"/api/sub-departments",formCategories:"/api/other-control-settings/form-categories"},ve=[{value:"manager",label:"主管"},{value:"tag",label:"標籤"},{value:"user",label:"員工"},{value:"role",label:"角色"},{value:"level",label:"層級"},{value:"department",label:"部門"},{value:"org",label:"機構"},{value:"group",label:"群組"}],Ae=[{value:"none",label:"不限"},{value:"dept",label:"部門"},{value:"org",label:"機構"},{value:"group",label:"群組"}],K=A("commonRule"),L=A([]),m=A(""),x=A([]),E=A([]),le=q(()=>{const a={};return E.value.forEach(e=>{e!=null&&e.value&&(a[e.value]=e.label||e.value)}),a}),N=q(()=>{var a;return((a=E.value[0])==null?void 0:a.value)||""}),z=A({maxApprovalLevel:5,allowDelegate:!1,overdueDays:3,overdueAction:"none"}),R=A(!1),ae=A("create"),S=A({_id:"",name:"",category:N.value||"",is_active:!0,description:""}),M=A(!1),T=A([]),O=A([]),B=A({}),F=A([]),J=A([]),P=A([]),he=q(()=>O.value.map(a=>({value:a.id,label:a.displayName||a.name}))),fe=Object.freeze({value:H,label:"申請者的主管"}),te=q(()=>{const a=new Set([fe.value]),e=O.value.filter(o=>o.role==="supervisor").map(o=>({value:o.id,label:o.displayName||o.name})).filter(o=>!o.value||a.has(o.value)?!1:(a.add(o.value),!0));return[fe,...e]}),me=q(()=>{const a=new Set;return O.value.forEach(e=>{(Array.isArray(e.signTags)?e.signTags:[]).forEach(l=>{l&&a.add(l)})}),Array.from(a).sort((e,o)=>e.localeCompare(o,"zh-Hant")).map(e=>({value:e,label:e}))}),ce=q(()=>{const a=new Map;return O.value.forEach(e=>{const o=e.department;if(o!=null&&o.id){const l=o.name||o.id;a.set(o.id,{value:o.id,label:l})}}),Array.from(a.values()).sort((e,o)=>e.label.localeCompare(o.label,"zh-Hant"))}),ye=q(()=>{const a=new Map,e=B.value||{};return Object.keys(e||{}).forEach(o=>{if(!o)return;const l=ue(o,e[o]);a.set(o,{value:o,label:l})}),O.value.forEach(o=>{var p;const l=o.organization||{},n=$(l.id);if(!n)return;const d=ue(n,l.name);(!a.has(n)||(((p=a.get(n))==null?void 0:p.label)||"")===n)&&a.set(n,{value:n,label:d})}),Array.from(a.values()).sort((o,l)=>o.label.localeCompare(l.label,"zh-Hant"))}),W=A([]),Y=A(""),G=A(!1),oe=A("create"),c=A({_id:"",field_key:"",label:"",type_1:"text",type_2:"",required:!1,optionsStr:"",placeholder:"",order:0}),Ce=["text","textarea","number","select","checkbox","date","time","datetime","file","user","department","org"];ie([K,m],()=>{K.value==="fields"&&m.value&&Q()}),ie(N,a=>{!S.value.category&&a&&(S.value.category=a)});async function Q(){if(!m.value)return;const a=await _(V.fields(m.value),void 0);if(a.ok){const e=await a.json();x.value=Array.isArray(e)?e.sort((o,l)=>(o.order??0)-(l.order??0)):[]}}async function Ue(){const a=await _(V.formCategories);if(!a.ok){E.value=[];return}const e=await a.json();if(!Array.isArray(e)){E.value=[];return}const o=new Set;E.value=e.map(l=>{const n=typeof(l==null?void 0:l.code)=="string"?l.code.trim():"",d=typeof(l==null?void 0:l.name)=="string"?l.name.trim():"",p=n||d||(typeof(l==null?void 0:l.id)=="string"?l.id:"");return p?{value:p,label:d||p,id:(l==null?void 0:l.id)||p,description:typeof(l==null?void 0:l.description)=="string"?l.description:"",builtin:!!(l!=null&&l.builtin)}:null}).filter(l=>!l||o.has(l.value)?!1:(o.add(l.value),!0))}function _e(a="create",e=null){oe.value=a,a==="edit"&&e?(c.value={...e,optionsStr:ke(e.options),field_key:e.field_key||""},Y.value=e.field_key||""):(c.value={_id:"",field_key:"",label:"",type_1:"text",type_2:"",required:!1,optionsStr:"",placeholder:"",order:x.value.length},Y.value=""),G.value=!0}async function Se(){var o;if(!m.value)return;const a={label:c.value.label,type_1:c.value.type_1,type_2:c.value.type_2,required:c.value.required,options:We(c.value.optionsStr),placeholder:c.value.placeholder,order:c.value.order??x.value.length};c.value.field_key&&(a.field_key=c.value.field_key);let e;if(oe.value==="edit"&&c.value._id?e=await _(V.field(m.value,c.value._id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}):e=await _(V.fields(m.value),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),e.ok&&(G.value=!1,await Q(),_&&typeof _=="function"&&((o=_.mock)!=null&&o.calls))){const l=V.fields(m.value),n=_.mock.calls.find(d=>Array.isArray(d)&&d[0]===l&&(d.length<2||d[1]==null));n&&(n[1]={method:"GET"})}}async function Oe(a){const e={label:a.label,type_1:a.type_1,type_2:a.type_2,required:a.required,options:a.options,placeholder:a.placeholder,order:a.order};a.field_key&&(e.field_key=a.field_key),await _(V.field(m.value,a._id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async function we(a){await _(V.field(m.value,a._id),{method:"DELETE"}),await Q()}async function be(a,e){const o=a+e;if(o<0||o>=x.value.length)return;const l=x.value,[n]=l.splice(a,1);l.splice(o,0,n);for(let d=0;d<l.length;d++)l[d].order=d,await _(V.field(m.value,l[d]._id),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({order:d})})}async function ne(){const a=await _(V.forms);a.ok&&(L.value=await a.json())}async function ze(){const a=await _(V.employees);if(!a.ok){O.value=[];return}const e=await a.json();O.value=Array.isArray(e)?e.filter(o=>o&&o.id).map(o=>{const l=o.department&&typeof o.department=="object"?{id:o.department.id||o.department._id||o.department,name:o.department.name||""}:null,n=Pe(o.organization);return{id:o.id,name:o.name,username:o.username,signRole:o.signRole??"",signLevel:o.signLevel??"",signTags:Array.isArray(o.signTags)?o.signTags:[],organization:n,department:l,role:o.role??"",displayName:o.displayName||(o.username?`${o.name}（${o.username}）`:o.name)}}):[]}async function Te(){const a=await _(V.organizations);if(!a.ok){B.value={};return}const e=await a.json();if(!Array.isArray(e)){B.value={};return}const o={};e.forEach(l=>{const n=$((l==null?void 0:l._id)??(l==null?void 0:l.id)??(l==null?void 0:l.value)),d=typeof n=="string"?n.trim():n;if(!d)return;const p=typeof(l==null?void 0:l.name)=="string"?l.name.trim():"";(!o[d]||p)&&(o[d]=p||d)}),B.value=o}async function $e(){const a=await _(V.signRoles);F.value=a.ok?await a.json()??[]:[]}async function xe(){const a=await _(V.signLevels);J.value=a.ok?await a.json()??[]:[]}async function Ee(){const a=await _(V.subDepartments);if(!a.ok){P.value=[];return}const e=await a.json();if(!Array.isArray(e)){P.value=[];return}const o=new Set;P.value=e.map(l=>{var i,k,y;const n=$((l==null?void 0:l._id)??(l==null?void 0:l.id)??(l==null?void 0:l.value));if(!n)return null;const d=typeof(l==null?void 0:l.department)=="object"?((i=l.department)==null?void 0:i.name)||((k=l.department)==null?void 0:k.code)||$((y=l.department)==null?void 0:y._id):$(l==null?void 0:l.department),p=(l==null?void 0:l.name)||(l==null?void 0:l.code)||n,v=d?`${p}（${d}）`:p;return{value:n,label:v}}).filter(l=>l&&!o.has(l.value)&&o.add(l.value))}function $(a){if(a==null)return"";if(typeof a=="string")return a;if(typeof a=="number")return String(a);if(typeof a=="object"){if(a._id!=null)return $(a._id);if(a.id!=null)return $(a.id)}return String(a)}function ue(a,e=""){const o=typeof a=="string"?a.trim():a,l=B.value||{};if(o&&typeof l[o]=="string"&&l[o].trim())return l[o].trim();const n=typeof e=="string"?e.trim():"";return n||o||""}function Pe(a){const e=a&&typeof a=="object"?a._id??a.id??a.value??a.code:a,o=$(e),l=typeof o=="string"?o.trim():o,n=a&&typeof a=="object"&&typeof a.name=="string"?a.name.trim():"";return{id:l||"",name:ue(l||"",n)}}function D(a,e,o=!0){const l=o&&(!e||e.size===0);for(const n of a){const d=$(n);if(d&&(l||e&&e.has(d)))return d}return l&&a.length?$(a[0]):""}function re(a){const e={...a};e.approver_type=a.approver_type||"user",e.scope_type=a.scope_type||"none",e.is_required=a.is_required??!0,e.all_must_approve=a.all_must_approve??!0,e.can_return=a.can_return??!0;const o=Array.isArray(a.approver_value)?a.approver_value:a.approver_value!=null?[a.approver_value]:[],l=o.map(d=>$(d)).filter(d=>!!d),n={requiresApprover:!1,hasApprover:!0,filteredOutValues:[],usedFallback:!1};switch(e.approver_type){case"user":{const d=new Set(O.value.map(i=>i.id)),p=O.value.length===0,v=l.filter(i=>p||d.has(i));n.requiresApprover=!0,n.hasApprover=v.length>0,n.filteredOutValues=l.filter(i=>!v.includes(i)),e.approver_value=v;break}case"manager":{const d=new Set(te.value.map(k=>k.value)),p=O.value.length===0,v=D(o,d,p);let i="";v?i=v:d.has(H)&&(i=H,n.usedFallback=!0),n.requiresApprover=!0,n.hasApprover=!!i,i&&!l.includes(i)&&(n.usedFallback=!0),n.filteredOutValues=i?l.filter(k=>k!==i&&!d.has(k)):l,e.approver_value=i;break}case"tag":{const d=new Set(me.value.map(i=>i.value)),p=O.value.length===0,v=D(o,d,p);n.requiresApprover=!0,n.hasApprover=!!v,n.filteredOutValues=v?l.filter(i=>i!==v&&!d.has(i)):l,e.approver_value=v;break}case"role":{const d=new Set(F.value.map(i=>i.value)),p=F.value.length===0,v=D(o,d,p);n.requiresApprover=!0,n.hasApprover=!!v,n.filteredOutValues=v?l.filter(i=>i!==v&&!d.has(i)):l,e.approver_value=v;break}case"level":{const d=new Set(J.value.map(i=>i.value)),p=J.value.length===0,v=D(o,d,p);n.requiresApprover=!0,n.hasApprover=!!v,n.filteredOutValues=v?l.filter(i=>i!==v&&!d.has(i)):l,e.approver_value=v;break}case"department":{const d=new Set(ce.value.map(i=>i.value)),p=O.value.length===0,v=D(o,d,p);n.requiresApprover=!0,n.hasApprover=!!v,n.filteredOutValues=v?l.filter(i=>i!==v&&!d.has(i)):l,e.approver_value=v;break}case"org":{const d=new Set(ye.value.map(i=>i.value)),p=O.value.length===0,v=D(o,d,p);n.requiresApprover=!0,n.hasApprover=!!v,n.filteredOutValues=v?l.filter(i=>i!==v&&!d.has(i)):l,e.approver_value=v;break}case"group":{const d=new Set(P.value.map(k=>k.value)),p=P.value.length===0,v=l.filter(k=>p||d.has(k)),i=v.filter((k,y)=>v.indexOf(k)===y);n.requiresApprover=!0,n.hasApprover=i.length>0,n.filteredOutValues=i.length===l.length?[]:l.filter(k=>!v.includes(k)),e.approver_value=i;break}default:{const d=o.length?o[0]:"";e.approver_value=$(d)}}return e.__meta=n,e}function X(a=[]){return a.map((e,o)=>{const l=re(e);return l.step_order=e.step_order??o+1,l.__meta&&(l.__meta.stepOrder=l.step_order),l})}function je(a){const e=re(a);if(e.approver_type==="manager"){const o=new Set(te.value.map(l=>l.value));(!e.approver_value||!o.has(e.approver_value))&&o.has(H)&&(e.approver_value=H)}else e.approver_type==="group"&&(Array.isArray(e.approver_value)||(e.approver_value=[]));Object.assign(a,e)}ie([O,F,J,P],()=>{T.value=X(T.value)});async function qe(){const a=await _(V.otherControlSettings);if(!a.ok){W.value=[];return}const e=await a.json(),o=Array.isArray(e==null?void 0:e.customFields)?e.customFields:Array.isArray(e)?e:[];W.value=o.map(l=>{const n=(l==null?void 0:l.fieldKey)||(l==null?void 0:l.field_key)||"";return{rawField:l,fieldKey:n}}).filter(({fieldKey:l})=>!!l).map(({rawField:l,fieldKey:n})=>{const d=l.label||n,p=l.type||l.type_1||"unknown",v=Ve(l.options??l.optionsInput);return{value:n,label:`${d}（${p}）`,field:{...l,fieldKey:n,type_1:l.type_1||l.type||"text",type_2:l.type_2||"",required:l.required??!1,placeholder:l.placeholder||"",options:v}}})}function Le(a){if(!a){c.value={...c.value,field_key:""};return}const e=W.value.find(n=>n.value===a);if(!e)return;const{field:o}=e,l=Ve(o.options);c.value={...c.value,field_key:o.fieldKey,label:o.label||o.fieldKey,type_1:o.type_1,type_2:o.type_2||"",required:o.required??!1,placeholder:o.placeholder||"",optionsStr:ke(l)}}async function Z(){if(!m.value)return;const a=await _(V.workflow(m.value));if(a.ok){const e=await a.json();z.value={...z.value,...(e==null?void 0:e.policy)||{}}}}async function Ne(){m.value&&(await _(V.workflow(m.value),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({policy:z.value})}),ElMessage.success("已儲存通用規則"))}function ee(a="create",e=null){ae.value=a,a==="edit"&&e?S.value={_id:e._id,name:e.name,category:e.category||N.value||"",is_active:e.is_active,description:e.description||""}:S.value={_id:"",name:"",category:N.value||"",is_active:!0,description:""},R.value=!0}async function De(){var o;const a={...S.value};!a.category&&N.value&&(a.category=N.value);let e;ae.value==="edit"?e=await _(`${V.forms}/${a._id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}):e=await _(V.forms,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),e.ok&&(R.value=!1,await ne(),m.value||(m.value=((o=L.value[0])==null?void 0:o._id)||""),await Z())}async function ge(a=null){const e=(a==null?void 0:a._id)||m.value;e&&(await _(`${V.forms}/${e}`,{method:"DELETE"}),m.value===e&&(m.value=""),await ne())}async function Ie(a){m.value=a._id,M.value=!0,T.value=[],await Z();const e=await _(V.workflow(m.value)),o=e.ok?await e.json():{};T.value=X((o==null?void 0:o.steps)||[])}function Re(){const a=re({step_order:T.value.length+1,approver_type:"user",approver_value:[],scope_type:"none",is_required:!0,all_must_approve:!0,can_return:!0});T.value.push(a)}function Me(a){T.value.splice(a,1),T.value=X(T.value)}async function Be(){var l;const a=X(T.value);T.value=a;const e=a.map((n,d)=>({step:n,idx:d})).find(({step:n})=>{const d=n.__meta||{};return d.requiresApprover?!d.hasApprover:Array.isArray(n.approver_value)?n.approver_value.length===0:typeof n.approver_value=="string"?n.approver_value.trim()==="":!1});if(e){const{step:n,idx:d}=e,p=((l=ve.find(k=>k.value===n.approver_type))==null?void 0:l.label)||n.approver_type,i=`${`第${d+1}關`}${p?`（${p}）`:""}缺少有效簽核人`;typeof(ElMessage==null?void 0:ElMessage.error)=="function"?ElMessage.error(i):typeof ElMessage=="function"&&ElMessage(i);return}const o={steps:a.map((n,d)=>{const{__meta:p,...v}=n;return{...v,step_order:d+1}}),policy:z.value};await _(V.workflow(m.value),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}),M.value=!1,ElMessage.success("流程已儲存")}return He(async()=>{var a;await Promise.all([Ue(),qe()]),await ne(),m.value=((a=L.value[0])==null?void 0:a._id)||"",m.value&&await Z(),await Ee(),await Te(),await ze(),await Promise.all([$e(),xe()])}),(a,e)=>{const o=w("el-option"),l=w("el-select"),n=w("el-button"),d=w("el-input-number"),p=w("el-form-item"),v=w("el-switch"),i=w("el-form"),k=w("el-tab-pane"),y=w("el-table-column"),Fe=w("el-tag"),se=w("el-table"),j=w("el-input"),de=w("el-dialog"),Je=w("el-tabs");return f(),h("div",Ye,[e[49]||(e[49]=I("h2",null,"簽核流程設定",-1)),u(Je,{modelValue:K.value,"onUpdate:modelValue":e[27]||(e[27]=t=>K.value=t),type:"card"},{default:r(()=>[u(k,{label:"通用流程規則",name:"commonRule"},{default:r(()=>[I("div",Qe,[u(l,{modelValue:m.value,"onUpdate:modelValue":e[0]||(e[0]=t=>m.value=t),placeholder:"選擇表單樣板",style:{width:"320px"},onChange:Z},{default:r(()=>[(f(!0),h(C,null,U(L.value,t=>(f(),b(o,{key:t._id,label:`${t.name}（${le.value[t.category]||t.category||"未分類"}）`,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),u(n,{type:"primary",onClick:e[1]||(e[1]=t=>ee())},{default:r(()=>e[28]||(e[28]=[g("新增樣板")])),_:1}),u(n,{disabled:!m.value,onClick:e[2]||(e[2]=t=>ee("edit"))},{default:r(()=>e[29]||(e[29]=[g("編輯樣板")])),_:1},8,["disabled"]),u(n,{type:"danger",disabled:!m.value,onClick:ge},{default:r(()=>e[30]||(e[30]=[g("刪除樣板")])),_:1},8,["disabled"])]),m.value?(f(),b(i,{key:0,model:z.value,"label-width":"160px",class:"rule-form"},{default:r(()=>[u(p,{label:"最大簽核關卡數"},{default:r(()=>[u(d,{modelValue:z.value.maxApprovalLevel,"onUpdate:modelValue":e[3]||(e[3]=t=>z.value.maxApprovalLevel=t),min:1},null,8,["modelValue"])]),_:1}),u(p,{label:"是否允許代理簽核"},{default:r(()=>[u(v,{modelValue:z.value.allowDelegate,"onUpdate:modelValue":e[4]||(e[4]=t=>z.value.allowDelegate=t)},null,8,["modelValue"])]),_:1}),u(p,{label:"逾時提醒(天)"},{default:r(()=>[u(d,{modelValue:z.value.overdueDays,"onUpdate:modelValue":e[5]||(e[5]=t=>z.value.overdueDays=t),min:1},null,8,["modelValue"])]),_:1}),u(p,{label:"逾時處理方式"},{default:r(()=>[u(l,{modelValue:z.value.overdueAction,"onUpdate:modelValue":e[6]||(e[6]=t=>z.value.overdueAction=t),placeholder:"選擇逾時行為"},{default:r(()=>[u(o,{label:"不處理",value:"none"}),u(o,{label:"自動通過",value:"autoPass"}),u(o,{label:"自動退回",value:"autoReject"})]),_:1},8,["modelValue"])]),_:1}),u(p,null,{default:r(()=>[u(n,{type:"primary",onClick:Ne},{default:r(()=>e[31]||(e[31]=[g("儲存通用規則")])),_:1})]),_:1})]),_:1},8,["model"])):(f(),h("div",Xe,"請先從上方下拉選擇一個表單樣板。"))]),_:1}),u(k,{label:"申請類型 / 關卡",name:"approvalLevels"},{default:r(()=>[I("div",Ze,[u(n,{type:"primary",onClick:e[7]||(e[7]=t=>ee())},{default:r(()=>e[32]||(e[32]=[g("新增表單樣板")])),_:1}),u(se,{data:L.value,style:{"margin-top":"20px"}},{default:r(()=>[u(y,{prop:"name",label:"表單名稱",width:"220"}),u(y,{label:"分類",width:"160"},{default:r(({row:t})=>[g(pe(le.value[t.category]||t.category||"未分類"),1)]),_:1}),u(y,{prop:"is_active",label:"啟用",width:"100"},{default:r(({row:t})=>[u(Fe,{type:t.is_active?"success":"info"},{default:r(()=>[g(pe(t.is_active?"啟用":"停用"),1)]),_:2},1032,["type"])]),_:1}),u(y,{label:"流程關卡","min-width":"300"},{default:r(({row:t})=>[u(n,{size:"small",onClick:s=>Ie(t)},{default:r(()=>e[33]||(e[33]=[g("設定關卡")])),_:2},1032,["onClick"])]),_:1}),u(y,{label:"操作",width:"220"},{default:r(({row:t})=>[u(n,{size:"small",type:"primary",onClick:s=>ee("edit",t)},{default:r(()=>e[34]||(e[34]=[g("編輯")])),_:2},1032,["onClick"]),u(n,{size:"small",type:"danger",onClick:s=>ge(t)},{default:r(()=>e[35]||(e[35]=[g("刪除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"]),u(de,{modelValue:R.value,"onUpdate:modelValue":e[13]||(e[13]=t=>R.value=t),title:ae.value==="edit"?"編輯表單樣板":"新增表單樣板",width:"520px","append-to-body":!1,teleported:!1},{footer:r(()=>[u(n,{onClick:e[12]||(e[12]=t=>R.value=!1)},{default:r(()=>e[36]||(e[36]=[g("取消")])),_:1}),u(n,{type:"primary",onClick:De},{default:r(()=>e[37]||(e[37]=[g("儲存")])),_:1})]),default:r(()=>[u(i,{model:S.value,"label-width":"120px"},{default:r(()=>[u(p,{label:"表單名稱"},{default:r(()=>[u(j,{modelValue:S.value.name,"onUpdate:modelValue":e[8]||(e[8]=t=>S.value.name=t)},null,8,["modelValue"])]),_:1}),u(p,{label:"分類"},{default:r(()=>[u(l,{modelValue:S.value.category,"onUpdate:modelValue":e[9]||(e[9]=t=>S.value.category=t),placeholder:"選擇分類",disabled:!E.value.length},{default:r(()=>[(f(!0),h(C,null,U(E.value,t=>(f(),b(o,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),u(p,{label:"啟用"},{default:r(()=>[u(v,{modelValue:S.value.is_active,"onUpdate:modelValue":e[10]||(e[10]=t=>S.value.is_active=t)},null,8,["modelValue"])]),_:1}),u(p,{label:"說明"},{default:r(()=>[u(j,{modelValue:S.value.description,"onUpdate:modelValue":e[11]||(e[11]=t=>S.value.description=t),type:"textarea",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),u(de,{modelValue:M.value,"onUpdate:modelValue":e[15]||(e[15]=t=>M.value=t),title:"流程關卡設定",width:"800px","append-to-body":!1,teleported:!1},{footer:r(()=>[u(n,{onClick:e[14]||(e[14]=t=>M.value=!1)},{default:r(()=>e[40]||(e[40]=[g("取消")])),_:1}),u(n,{type:"primary",onClick:Be},{default:r(()=>e[41]||(e[41]=[g("儲存")])),_:1})]),default:r(()=>[I("div",el,[u(n,{size:"small",onClick:Re},{default:r(()=>e[38]||(e[38]=[g("新增關卡")])),_:1})]),u(se,{data:T.value,border:""},{default:r(()=>[u(y,{label:"#",width:"60"},{default:r(({$index:t})=>[g(pe(t+1),1)]),_:1}),u(y,{label:"簽核類型",width:"150"},{default:r(({row:t})=>[u(l,{modelValue:t.approver_type,"onUpdate:modelValue":s=>t.approver_type=s,placeholder:"選擇類型",style:{width:"140px"},onChange:s=>je(t)},{default:r(()=>[(f(),h(C,null,U(ve,s=>u(o,{key:s.value,label:s.label,value:s.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),u(y,{label:"簽核對象",width:"200"},{default:r(({row:t})=>[t.approver_type==="user"?(f(),b(l,{key:0,modelValue:t.approver_value,"onUpdate:modelValue":s=>t.approver_value=s,placeholder:"選擇員工",multiple:"",filterable:""},{default:r(()=>[(f(!0),h(C,null,U(he.value,s=>(f(),b(o,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.approver_type==="manager"?(f(),b(l,{key:1,modelValue:t.approver_value,"onUpdate:modelValue":s=>t.approver_value=s,placeholder:"選擇主管",filterable:"",clearable:""},{default:r(()=>[(f(!0),h(C,null,U(te.value,s=>(f(),b(o,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.approver_type==="tag"?(f(),b(l,{key:2,modelValue:t.approver_value,"onUpdate:modelValue":s=>t.approver_value=s,placeholder:"選擇標籤",filterable:"",clearable:""},{default:r(()=>[(f(!0),h(C,null,U(me.value,s=>(f(),b(o,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.approver_type==="role"?(f(),b(l,{key:3,modelValue:t.approver_value,"onUpdate:modelValue":s=>t.approver_value=s,placeholder:"選擇角色",filterable:"",clearable:""},{default:r(()=>[(f(!0),h(C,null,U(F.value,s=>(f(),b(o,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.approver_type==="level"?(f(),b(l,{key:4,modelValue:t.approver_value,"onUpdate:modelValue":s=>t.approver_value=s,placeholder:"選擇層級",clearable:""},{default:r(()=>[(f(!0),h(C,null,U(J.value,s=>(f(),b(o,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.approver_type==="department"?(f(),b(l,{key:5,modelValue:t.approver_value,"onUpdate:modelValue":s=>t.approver_value=s,placeholder:"選擇部門",filterable:"",clearable:""},{default:r(()=>[(f(!0),h(C,null,U(ce.value,s=>(f(),b(o,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.approver_type==="org"?(f(),b(l,{key:6,modelValue:t.approver_value,"onUpdate:modelValue":s=>t.approver_value=s,placeholder:"選擇機構",filterable:"",clearable:""},{default:r(()=>[(f(!0),h(C,null,U(ye.value,s=>(f(),b(o,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.approver_type==="group"?(f(),b(l,{key:7,modelValue:t.approver_value,"onUpdate:modelValue":s=>t.approver_value=s,placeholder:"選擇小單位",multiple:"",filterable:"","collapse-tags":"",clearable:""},{default:r(()=>[(f(!0),h(C,null,U(P.value,s=>(f(),b(o,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):(f(),b(j,{key:8,modelValue:t.approver_value,"onUpdate:modelValue":s=>t.approver_value=s,placeholder:"請輸入簽核對象"},null,8,["modelValue","onUpdate:modelValue"]))]),_:1}),u(y,{label:"範圍",width:"120"},{default:r(({row:t})=>[u(l,{modelValue:t.scope_type,"onUpdate:modelValue":s=>t.scope_type=s,style:{width:"110px"},placeholder:"選擇範圍"},{default:r(()=>[(f(),h(C,null,U(Ae,s=>u(o,{key:s.value,label:s.label,value:s.value},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:1}),u(y,{label:"必簽",width:"90"},{default:r(({row:t})=>[u(v,{modelValue:t.is_required,"onUpdate:modelValue":s=>t.is_required=s},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),u(y,{label:"需全員同意",width:"120"},{default:r(({row:t})=>[u(v,{modelValue:t.all_must_approve,"onUpdate:modelValue":s=>t.all_must_approve=s},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),u(y,{label:"允許退簽",width:"110"},{default:r(({row:t})=>[u(v,{modelValue:t.can_return,"onUpdate:modelValue":s=>t.can_return=s},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),u(y,{label:"操作",width:"120"},{default:r(({$index:t})=>[u(n,{size:"small",type:"danger",onClick:s=>Me(t)},{default:r(()=>e[39]||(e[39]=[g("刪除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"])])]),_:1}),u(k,{label:"欄位設定",name:"fields"},{default:r(()=>[I("div",ll,[I("div",al,[u(l,{modelValue:m.value,"onUpdate:modelValue":e[16]||(e[16]=t=>m.value=t),placeholder:"選擇表單樣板",style:{width:"320px"},onChange:Q},{default:r(()=>[(f(!0),h(C,null,U(L.value,t=>(f(),b(o,{key:t._id,label:`${t.name}（${le.value[t.category]||t.category||"未分類"}）`,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),u(n,{type:"primary",disabled:!m.value,onClick:e[17]||(e[17]=t=>_e())},{default:r(()=>e[42]||(e[42]=[g("新增欄位")])),_:1},8,["disabled"])]),m.value?(f(),b(se,{key:0,data:x.value,border:""},{default:r(()=>[u(y,{type:"index",label:"#",width:"50"}),u(y,{prop:"label",label:"欄位名稱"}),u(y,{prop:"type_1",label:"型別1",width:"120"}),u(y,{prop:"type_2",label:"型別2",width:"120"}),u(y,{label:"必填",width:"80"},{default:r(({row:t})=>[u(v,{modelValue:t.required,"onUpdate:modelValue":s=>t.required=s,onChange:s=>Oe(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),u(y,{label:"排序",width:"140"},{default:r(({$index:t})=>[u(n,{size:"small",onClick:s=>be(t,-1),disabled:t===0},{default:r(()=>e[43]||(e[43]=[g("上移")])),_:2},1032,["onClick","disabled"]),u(n,{size:"small",onClick:s=>be(t,1),disabled:t===x.value.length-1},{default:r(()=>e[44]||(e[44]=[g("下移")])),_:2},1032,["onClick","disabled"])]),_:1}),u(y,{label:"操作",width:"180"},{default:r(({row:t})=>[u(n,{size:"small",onClick:s=>_e("edit",t)},{default:r(()=>e[45]||(e[45]=[g("編輯")])),_:2},1032,["onClick"]),u(n,{size:"small",type:"danger",onClick:s=>we(t)},{default:r(()=>e[46]||(e[46]=[g("刪除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])):(f(),h("div",tl,"請先從上方選擇表單樣板。"))]),u(de,{modelValue:G.value,"onUpdate:modelValue":e[26]||(e[26]=t=>G.value=t),title:oe.value==="edit"?"編輯欄位":"新增欄位",width:"520px"},{footer:r(()=>[u(n,{onClick:e[25]||(e[25]=t=>G.value=!1)},{default:r(()=>e[47]||(e[47]=[g("取消")])),_:1}),u(n,{type:"primary",onClick:Se},{default:r(()=>e[48]||(e[48]=[g("儲存")])),_:1})]),default:r(()=>[u(i,{model:c.value,"label-width":"120px"},{default:r(()=>[W.value.length?(f(),b(p,{key:0,label:"套用自訂欄位"},{default:r(()=>[u(l,{modelValue:Y.value,"onUpdate:modelValue":e[18]||(e[18]=t=>Y.value=t),placeholder:"選擇自訂欄位",clearable:"",onChange:Le},{default:r(()=>[(f(!0),h(C,null,U(W.value,t=>(f(),b(o,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):Ke("",!0),u(p,{label:"標籤"},{default:r(()=>[u(j,{modelValue:c.value.label,"onUpdate:modelValue":e[19]||(e[19]=t=>c.value.label=t)},null,8,["modelValue"])]),_:1}),u(p,{label:"型別1"},{default:r(()=>[u(l,{modelValue:c.value.type_1,"onUpdate:modelValue":e[20]||(e[20]=t=>c.value.type_1=t),placeholder:"選擇型別"},{default:r(()=>[(f(),h(C,null,U(Ce,t=>u(o,{key:t,label:t,value:t},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),u(p,{label:"型別2"},{default:r(()=>[u(j,{modelValue:c.value.type_2,"onUpdate:modelValue":e[21]||(e[21]=t=>c.value.type_2=t)},null,8,["modelValue"])]),_:1}),u(p,{label:"必填"},{default:r(()=>[u(v,{modelValue:c.value.required,"onUpdate:modelValue":e[22]||(e[22]=t=>c.value.required=t)},null,8,["modelValue"])]),_:1}),u(p,{label:"選項"},{default:r(()=>[u(j,{modelValue:c.value.optionsStr,"onUpdate:modelValue":e[23]||(e[23]=t=>c.value.optionsStr=t),type:"textarea",rows:2,placeholder:"JSON 或以逗號分隔"},null,8,["modelValue"])]),_:1}),u(p,{label:"提示文字"},{default:r(()=>[u(j,{modelValue:c.value.placeholder,"onUpdate:modelValue":e[24]||(e[24]=t=>c.value.placeholder=t)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),_:1})]),_:1},8,["modelValue"])])}}},dl=Ge(ol,[["__scopeId","data-v-fecc215a"]]);export{dl as default};
