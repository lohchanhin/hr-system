import{_ as A,r as v,v as g,m as B,g as M,c as u,d as O,a as _,b as m,w as k,x as T,o as r,F as S,i as w,h as x,t as z}from"./index-DZsOhPq3.js";import{a as y}from"./api-DfziFdQJ.js";const N={class:"schedule-page"},U={key:1},Y={key:1},F={__name:"Schedule",setup(J){const p=v(g().format("YYYY-MM")),s=v({}),C=["早班","中班","晚班"],f=v([]),I=B(()=>{const o=localStorage.getItem("role")||"employee";return["supervisor","admin"].includes(o)}),b=B(()=>{const e=g(p.value+"-01").endOf("month").date();return Array.from({length:e},(n,l)=>l+1)});async function $(){const o=T()||"",e=localStorage.getItem("employeeId")||"",n=await y(`/api/schedules/monthly?month=${p.value}&supervisor=${e}`,{headers:{Authorization:`Bearer ${o}`}});if(n.ok){const l=await n.json(),h=b.value;s.value={},f.value.forEach(t=>{s.value[t._id]={},h.forEach(i=>{s.value[t._id][i]={shiftType:""}})}),l.forEach(t=>{var c;const i=((c=t.employee)==null?void 0:c._id)||t.employee,a=g(t.date).date();s.value[i][a]={id:t._id,shiftType:t.shiftType}})}}async function j(o,e,n){const l=T()||"",h=`${p.value}-${String(e).padStart(2,"0")}`,t=s.value[o][e];if(t&&t.id)await y(`/api/schedules/${t.id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({shiftType:n})});else{const i=await y("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({employee:o,date:h,shiftType:n})});if(i.ok){const a=await i.json();s.value[o][e]={id:a._id,shiftType:a.shiftType}}}}async function E(){const o=T()||"",e=localStorage.getItem("employeeId")||"",n=await y(`/api/employees?supervisor=${e}`,{headers:{Authorization:`Bearer ${o}`}});n.ok&&(f.value=await n.json())}return M(async()=>{await E(),await $()}),(o,e)=>{const n=m("el-date-picker"),l=m("el-table-column"),h=m("el-option"),t=m("el-select"),i=m("el-table");return r(),u("div",N,[e[1]||(e[1]=O("h2",null,"排班管理",-1)),_(n,{modelValue:p.value,"onUpdate:modelValue":e[0]||(e[0]=a=>p.value=a),type:"month",onChange:$},null,8,["modelValue"]),_(i,{data:f.value,style:{"margin-top":"20px"}},{default:k(()=>[_(l,{prop:"name",label:"員工"}),(r(!0),u(S,null,w(b.value,a=>(r(),x(l,{key:a,label:a},{default:k(({row:c})=>{var V;return[s.value[c._id]?(r(),u(S,{key:0},[I.value?(r(),x(t,{key:0,modelValue:s.value[c._id][a].shiftType,"onUpdate:modelValue":d=>s.value[c._id][a].shiftType=d,placeholder:"",onChange:d=>j(c._id,a,d)},{default:k(()=>[(r(),u(S,null,w(C,d=>_(h,{key:d,label:d,value:d},null,8,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])):(r(),u("span",U,z(((V=s.value[c._id][a])==null?void 0:V.shiftType)||""),1))],64)):(r(),u("span",Y,"-"))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])])}}},L=A(F,[["__scopeId","data-v-c69ed7b3"]]);export{L as default};
