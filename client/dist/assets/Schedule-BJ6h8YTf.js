import{_ as Ut,j as D,I as Ea,J as Ft,K as Yt,c as _,o as c,F as x,t as F,n as T,w as y,b as r,L as ut,A as Ge,v as b,e as z,r as g,D as J,y as Ot,m as Ie,k as Aa,d as m,q as N,h as fe,p as Lt,E as le,u as Va,g as E,f as $a,B as Se,M as za}from"./index-BtRsP1Ch.js";import{a as U}from"./api-BbRE8XJ9.js";import{u as ja}from"./auth-DCeZYvS0.js";import{b as Ma}from"./shiftColors-BbvJ2s1U.js";const Na={class:"dashboard"},xa={class:"metric-label"},Pa={class:"metric-value"},Ra=Object.assign({name:"ScheduleDashboard"},{__name:"ScheduleDashboard",props:{summary:{type:Object,default:()=>({direct:0,unscheduled:0,onLeave:0})}},setup(dt){const Ee=dt,Qe=D(()=>[{label:"直屬員工數",value:Ee.summary.direct,icon:Ea,color:"#0f766e"},{label:"未排班員工",value:Ee.summary.unscheduled,icon:Ft,color:"#dc2626"},{label:"請假中員工",value:Ee.summary.onLeave,icon:Yt,color:"#f59e0b"}]);return(ct,pt)=>{const O=z("el-card");return c(),_("div",Na,[(c(!0),_(x,null,F(Qe.value,v=>(c(),T(O,{class:"metric-card",key:v.label},{default:y(()=>[(c(),T(ut(v.icon),{class:"metric-icon",style:Ge({color:v.color})},null,8,["style"])),r("div",xa,b(v.label),1),r("div",Pa,b(v.value),1)]),_:2},1024))),128))])}}}),Ta=Ut(Ra,[["__scopeId","data-v-ceb5c889"]]),Oa={class:"schedule-page"},La={class:"filters-card"},Ua={class:"filters-content"},Fa={class:"filter-group"},Ya={class:"filter-group"},Ba={class:"filter-group"},Ja={key:0,class:"filter-group include-self-group"},Ka={key:0,class:"publish-card"},Wa={class:"publish-header"},qa={class:"publish-progress","data-test":"publish-steps"},Ha={class:"publish-meta-row"},Ga={key:0,class:"publish-meta","data-test":"publish-meta"},Qa={key:1,class:"publish-meta","data-test":"publish-meta"},Xa={key:2,class:"publish-progress-indicator"},Za={class:"progress-label"},el={class:"publish-actions"},tl={class:"publish-stats"},al={key:0,class:"status-card pending","data-test":"pending-card"},ll={class:"card-header"},sl={class:"card-badge"},nl={class:"card-list"},ol={class:"card-name"},il={class:"card-count"},rl={key:1,class:"status-card disputed","data-test":"disputed-card"},ul={class:"card-header"},dl={class:"card-badge"},cl={class:"card-list"},pl={class:"card-item-main"},vl={class:"card-name"},fl={class:"card-count"},ml={key:0,class:"card-note"},hl={key:2,class:"status-card ready","data-test":"ready-card"},yl={key:3,class:"status-card finalized","data-test":"finalized-card"},_l={class:"actions-card"},bl={class:"primary-actions"},gl={class:"secondary-actions"},Sl={class:"range-picker-wrapper"},wl={class:"schedule-card"},kl={class:"schedule-header"},Cl={class:"schedule-legend","data-test":"schedule-legend"},Dl={key:1,class:"legend-empty","data-test":"shift-legend-empty"},Il={key:0,class:"batch-toolbar"},El={class:"employee-info"},Al={class:"department-name"},Vl={key:0,class:"sub-department"},$l={class:"employee-name"},zl={class:"day-header"},jl=["title"],Ml={key:0,class:"leave-indicator","data-test":"leave-indicator"},Nl={class:"department-selects"},xl={class:"shift-details"},Pl={class:"detail-row"},Rl={class:"detail-value"},Tl={class:"detail-row"},Ol={class:"detail-value"},Ll={key:0,class:"detail-row"},Ul={class:"detail-value"},Fl={key:3,class:"missing-label"},Yl={key:2,class:"empty-cell"},Bl={key:1,class:"modern-schedule-cell collapsed-cell"},Jl={key:1,class:"approval-card"},Kl={class:"approval-header"},Wl={class:"approval-count"},ql={class:"applicant-name"},Hl={class:"form-type"},Gl={key:0},Ql={class:"mb-2"},Xl={class:"mb-2"},Zl={class:"mb-2"},es={class:"mb-1"},ts={class:"mr-2"},as="schedule-include-self",ls={__name:"Schedule",setup(dt){const Ee=t=>t?new Date(t).toLocaleString():"-",Qe=t=>Array.isArray(t)?t.join(", "):t??"-",ct={leave:"請假",attendance:"出勤",overtime:"加班",shift:"排班",reimbursement:"報銷",expense:"費用",travel:"出差",recruitment:"招募",onboarding:"入職",general:"一般"},pt=(t,e="")=>{if(t==null)return e||"未知類型";const a=String(t).trim();return a?ct[a.toLowerCase()]||a:e||"未知類型"},O=g(J().format("YYYY-MM")),v=g({}),Te=g([]),re=g([]),K=g([]),Oe=g([]),H=g([]),te=g([]),A=g(""),j=g(""),Y=g(""),ae=g(""),M=g(""),Ae=g(""),ue=g([]),Ve=g(null),G=g(!1);let vt=!0;const ft=g({direct:0,unscheduled:0,onLeave:0}),Le=g(""),Ue=g("all"),Fe=g(new Set),de=g(new Set),se=g(new Set),me=g(new Set),Xe=g([]),$e=g(""),ce=g(""),ne=g(""),Ye=g(!1),ze=g(!1),je=g(!1),P=Ot({visible:!1,doc:null}),Ze=Ot({});function he(){var a,l;if(typeof window>"u")return"";const t=(a=window.sessionStorage)==null?void 0:a.getItem("employeeId");if(t&&t!=="undefined")return t;const e=(l=window.localStorage)==null?void 0:l.getItem("employeeId");return e&&e!=="undefined"?e:""}function mt(t){return t?`${as}:${String(t)}`:""}function ht(t=he()){var l;if(typeof window>"u")return null;const e=mt(t);if(!e)return null;const a=(l=window.localStorage)==null?void 0:l.getItem(e);return a==="true"?!0:a==="false"?!1:null}function et(t,e=he()){var l;if(typeof window>"u")return;const a=mt(e);if(a)try{(l=window.localStorage)==null||l.setItem(a,t?"true":"false")}catch(o){console.warn("Failed to persist includeSelf preference",o)}}const Bt=D(()=>de.value),Jt=D(()=>se.value),Kt=D(()=>me.value),yt=D(()=>{if(!Array.isArray(re.value)||!re.value.length)return[];const t=new Set;return re.value.reduce((e,a)=>{if(!a)return e;const l=qe(a)||a.name||a.code||"未命名班別",o=String(a._id||`${a.code??""}-${a.name??""}`);return!o||t.has(o)||(t.add(o),e.push({key:o,label:l,style:it(a)})),e},[])}),ye=(t,e)=>`${t}-${e}`,tt=t=>{const[e,a]=String(t).split("-");return{empId:e,day:Number(a)}},Be=(t,e)=>{const a=v.value[t];if(!a)return!1;const l=a[e];return l?!l.leave:!1},at=D(()=>{const t=new Set,e=ie.value,a=K.value,l=(o,i)=>{Be(o,i)&&t.add(ye(o,i))};return me.value.forEach(o=>{const{empId:i,day:p}=tt(o);l(i,p)}),de.value.forEach(o=>{e.forEach(i=>l(o,i.date))}),se.value.forEach(o=>{a.forEach(i=>l(i._id,o))}),t}),lt=D(()=>at.value.size>0),_t=D(()=>ce.value?$t(ce.value):[]),Wt=(t,e)=>at.value.has(ye(t,e)),Je=()=>{const t=new Set(K.value.map(l=>l._id)),e=new Set(ie.value.map(l=>l.date));de.value=new Set(Array.from(de.value).filter(l=>t.has(l))),se.value=new Set(Array.from(se.value).filter(l=>e.has(l)));const a=new Set;me.value.forEach(l=>{const{empId:o,day:i}=tt(l);t.has(o)&&e.has(i)&&Be(o,i)&&a.add(ye(o,i))}),me.value=a},qt=()=>{de.value=new Set,se.value=new Set,me.value=new Set,Xe.value=[]},Ht=(t,e)=>{const a=new Set(de.value);(typeof e=="boolean"?e:!a.has(t))?a.add(t):a.delete(t),de.value=a},Gt=(t,e)=>{const a=new Set(se.value);(typeof e=="boolean"?e:!a.has(t))?a.add(t):a.delete(t),se.value=a},Qt=(t,e,a)=>{if(!Be(t,e))return;const l=ye(t,e),o=new Set(me.value);(typeof a=="boolean"?a:!o.has(l))?o.add(l):o.delete(l),me.value=o},Xt=()=>{de.value=new Set(K.value.map(t=>t._id))},Zt=()=>{se.value=new Set(ie.value.map(t=>t.date))},bt=t=>[...t].sort((e,a)=>{const l=(e.department||"").localeCompare(a.department||"");return l!==0?l:(e.name||"").localeCompare(a.name||"")}),ea=t=>{if(!Array.isArray(t)||t.length!==2)return;const[e,a]=t;if(!e||!a)return;const l=J(`${O.value}-01`),o=J(e),i=J(a);if(!o.isValid()||!i.isValid())return;const p=l.endOf("month");let d=o.isBefore(l)?l:o;const u=[];for(;(d.isBefore(i)||d.isSame(i,"day"))&&(d.year()===l.year()&&d.month()===l.month()&&u.push(d.date()),!d.isSame(p,"day"));)d=d.add(1,"day");se.value=new Set(u)};Ie(ce,(t,e)=>{t!==e&&(ne.value="")}),Ie(_t,t=>{ne.value&&!t.some(e=>e._id===ne.value)&&(ne.value="")}),Ie(G,async(t,e)=>{if(t===e)return;const a=ge()||he();et(t,a),_e.refreshRole({forceRefresh:!0}),!vt&&oe.value&&(await Ne(A.value,j.value),await pe(),await xe())});const st=t=>{const e=v.value[t]||{},a=Object.values(e),l=a.some(i=>i.shiftId),o=a.some(i=>i.leave);return l?o?"onLeave":"scheduled":"unscheduled"},ta=D(()=>{let t=Le.value?K.value.filter(e=>e.name.includes(Le.value)):K.value;return Ue.value!=="all"&&(t=t.filter(e=>st(e._id)===Ue.value)),t}),gt=D(()=>K.value.length>50),aa=t=>{Fe.value.has(t)?Fe.value.delete(t):Fe.value.add(t)},la=D(()=>te.value.filter(t=>t.department===A.value)),sa=Va(),_e=ja();_e.loadUser();const St=D(()=>["supervisor","admin"].includes(_e.role)),oe=D(()=>_e.role==="supervisor"),we=St,ke=g(""),C=D(()=>{const t={status:"draft",pendingEmployees:[],disputedEmployees:[],publishedAt:null,hasSchedules:!1,totalEmployees:0,allEmployeesConfirmed:!1},e=Array.isArray(Te.value)?Te.value:[];if(!e.length)return t;t.hasSchedules=!0;const a=new Map;let l=null,o=!1,i=!1,p=!1;e.forEach(n=>{if(!n)return;const S=n.state||"draft",I=n.employeeResponse||"pending",R=n.employee||{},X=(R==null?void 0:R._id)??(R==null?void 0:R.id)??n.employee,f=X?String(X):"",k=(R==null?void 0:R.name)||n.employeeName||f;if(S!=="draft"&&(o=!0),(S==="changes_requested"||I==="disputed")&&(i=!0),S==="finalized"&&(p=!0),n!=null&&n.publishedAt){const V=new Date(n.publishedAt);Number.isNaN(V)||(!l||l<V)&&(l=V)}if(!f)return;a.has(f)||a.set(f,{id:f,name:k||f,pendingCount:0,disputedCount:0,latestNote:"",latestResponseAt:null});const w=a.get(f);if(S==="pending_confirmation"&&I==="pending"&&(w.pendingCount+=1),(I==="disputed"||S==="changes_requested")&&(w.disputedCount+=1,n!=null&&n.responseNote&&(w.latestNote=n.responseNote)),n!=null&&n.responseAt){const V=new Date(n.responseAt);Number.isNaN(V)||(!w.latestResponseAt||w.latestResponseAt<V)&&(w.latestResponseAt=V)}});const d=[],u=[];return a.forEach(n=>{n.pendingCount>0&&d.push({id:n.id,name:n.name,pendingCount:n.pendingCount}),n.disputedCount>0&&u.push({id:n.id,name:n.name,disputedCount:n.disputedCount,latestNote:n.latestNote,latestResponseAt:n.latestResponseAt?n.latestResponseAt.toISOString():null})}),t.pendingEmployees=d,t.disputedEmployees=u,t.totalEmployees=a.size,t.publishedAt=l?l.toISOString():null,p?t.status="finalized":i?t.status="disputed":o?t.status=d.length?"pending":"ready":t.status="draft",t.allEmployeesConfirmed=t.status==="ready"&&d.length===0&&u.length===0,t}),na=D(()=>({draft:"尚未發布",pending:"待員工確認",ready:"可完成發布",disputed:"需處理異議",finalized:"已完成發布"})[C.value.status]||"尚未發布"),Ce=D(()=>C.value.pendingEmployees.reduce((t,e)=>t+(Number(e==null?void 0:e.pendingCount)||0),0)),De=D(()=>C.value.disputedEmployees.reduce((t,e)=>t+(Number(e==null?void 0:e.disputedCount)||0),0)),oa=D(()=>{const t=C.value.status;return t==="pending"?1:t==="disputed"?2:t==="ready"||t==="finalized"?3:0}),Ke=D(()=>{const t=C.value.status,e=Ce.value>0,a=De.value>0;return{draft:t==="draft"?"process":"finish",pending:t==="draft"?"wait":e||t==="pending"?"process":"finish",disputed:a?"error":t==="draft"||t==="pending"?"wait":"finish",finalized:t==="finalized"?"success":t==="ready"?"process":"wait"}}),ia=D(()=>C.value.hasSchedules?Ce.value>0?`${Ce.value} 筆待回覆`:"員工已完成回覆":"尚未發送確認"),ra=D(()=>C.value.hasSchedules?De.value>0?`${De.value} 筆異議待處理`:"無異議紀錄":"尚未進入異議流程"),ua=D(()=>C.value.status==="finalized"?"班表已鎖定":C.value.status==="ready"?"可執行最終發布":"等待完成發布"),nt=D(()=>{if(C.value.status==="finalized")return 100;const t=C.value.totalEmployees;if(!t||t<=0)return C.value.status==="draft"?0:20;const e=Math.max(t-C.value.pendingEmployees.length,0),a=Math.round(e/t*100);return Math.min(Math.max(a,0),100)}),wt=D(()=>ze.value||!C.value.hasSchedules||C.value.status==="finalized"),kt=D(()=>je.value||C.value.status!=="ready");Ie(oe,t=>{const e=ge()||he();if(!t){G.value&&(G.value=!1),et(!1,e);return}const a=ht(e);a===!0?G.value=!0:a===!1&&e&&et(!1,e)});const be=t=>{var l,o;const e=(l=le)==null?void 0:l.warning;typeof e=="function"&&e(t);const a=typeof window<"u"?(o=window.ElMessage)==null?void 0:o.warning:void 0;typeof a=="function"&&a!==e&&a(t)},Me=t=>{var l,o;const e=(l=le)==null?void 0:l.info;typeof e=="function"&&e(t);const a=typeof window<"u"?(o=window.ElMessage)==null?void 0:o.info:void 0;typeof a=="function"&&a!==e&&a(t)},ot=t=>{var l,o;const e=(l=le)==null?void 0:l.success;typeof e=="function"&&e(t);const a=typeof window<"u"?(o=window.ElMessage)==null?void 0:o.success:void 0;typeof a=="function"&&a!==e&&a(t)},da=t=>{if(!t)return"";const e=J(t);return e.isValid()?e.format("YYYY/MM/DD HH:mm"):""};function Ct(){const t={month:O.value};return A.value&&(t.department=A.value),j.value&&(t.subDepartment=j.value),G.value&&oe.value&&(t.includeSelf=!0),t}async function ca(){if(!ze.value)try{ze.value=!0;const t=await U("/api/schedules/publish",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Ct())});if(!t.ok){let e="發布失敗";try{const a=await t.json();a!=null&&a.error&&(e=a.error)}catch{}throw new Error(e)}ot("已將班表發送給員工確認"),await pe(),await xe()}catch(t){be((t==null?void 0:t.message)||"發布失敗")}finally{ze.value=!1}}async function pa(){if(!je.value)try{je.value=!0;const t=await U("/api/schedules/publish/finalize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Ct())});if(t.status===409){let e="仍有員工未回覆";try{const a=await t.json();a!=null&&a.error&&(e=a.error)}catch{}be(e),await pe();return}if(!t.ok){let e="完成發布失敗";try{const a=await t.json();a!=null&&a.error&&(e=a.error)}catch{}throw new Error(e)}ot("班表已完成發布"),await pe(),await xe()}catch(t){be((t==null?void 0:t.message)||"完成發布失敗")}finally{je.value=!1}}async function va(){if(wt.value){be("目前沒有可發布的班表");return}try{await Se.confirm("確認要將本月班表發送給員工確認嗎？","批次發布",{type:"warning",confirmButtonText:"送出",cancelButtonText:"取消"})}catch{return}await ca()}async function fa(){if(C.value.status==="finalized"){Me("班表已完成發布");return}if(kt.value){be("仍有員工尚未回覆，請確認後再完成發布");return}try{await Se.confirm("全部員工已確認，是否完成發布並鎖定班表？","完成發布",{type:"success",confirmButtonText:"完成",cancelButtonText:"取消"})}catch{return}await pa()}const Dt=t=>({pending:"待簽核",approved:"已核可",rejected:"已否決",returned:"已退簽"})[t]||t||"-",ma=t=>{if(t&&typeof t=="object"){const e=t._id||t.employeeId||"";return t.name||Ze[e]||e}return Ze[t]||t||"-"},ha=(t,e)=>{var l,o;const a=(o=(l=v.value)==null?void 0:l[t])==null?void 0:o[e];return a!=null&&a.leave?"已核准請假，該日不列入工作時數":""},ie=D(()=>{const t=J(O.value+"-01"),e=t.endOf("month").date(),a=["日","一","二","三","四","五","六"];return Array.from({length:e},(l,o)=>{const i=o+1,p=a[t.date(i).day()];return{date:i,label:`${i}(${p})`}})});Ie(K,Je),Ie(ie,Je);async function ya(){const t=await U("/api/shifts");if(t.ok){const e=await t.json(),a=Array.isArray(e==null?void 0:e.shifts)?e.shifts:Array.isArray(e)?e:[];Array.isArray(a)&&(re.value=a.map(l=>({_id:l._id,code:l.code,name:l.name??"",startTime:l.startTime,endTime:l.endTime,remark:l.remark})))}else t.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",t.status)}async function It(t=""){try{const e=t||Y.value,a=e?`/api/sub-departments?department=${e}`:"/api/sub-departments",l=await U(a);if(!l.ok)throw new Error("Failed to fetch sub departments");const o=await l.json(),i=H.value.reduce((u,n)=>{const S=String(n._id);return u[S]=S,n.name&&(u[n.name]=S),u},{});Y.value&&(i[Y.value]=Y.value),ae.value&&(i[ae.value]=Y.value||ae.value);const p=Array.isArray(o)?o.map(u=>{const n=u==null?void 0:u.department;let S="";return n&&typeof n=="object"?S=(n==null?void 0:n._id)||(n==null?void 0:n.id)||i[n==null?void 0:n.name]||"":S=i[n]||n||"",{...u,_id:String((u==null?void 0:u._id)??(u==null?void 0:u.id)??""),department:String(S)}}).filter(u=>u._id):[];let d=p;if(e&&(d=p.filter(u=>u.department===String(e)),!d.length&&M.value)){const u=p.find(n=>n._id===M.value);u?d=[u]:d=[{_id:M.value,name:Ae.value||"",department:String(e)}]}if(_e.role==="supervisor"){const u=ue.value.length?ue.value:M.value?[M.value]:[],n=new Set(u.map(S=>String(S)));n.size?d=d.filter(S=>n.has(String(S._id))):d=[]}te.value=d,te.value.length?M.value&&te.value.some(u=>u._id===M.value)?j.value=M.value:j.value&&te.value.some(u=>u._id===j.value)||(j.value=te.value[0]._id):j.value=""}catch(e){console.error(e),te.value=[],j.value=""}}async function _a(){var t;try{const e=await U("/api/departments"),a=e.ok?await e.json():[],l=Array.isArray(a)?a.map(d=>{const u=(d==null?void 0:d._id)??(d==null?void 0:d.id)??(d==null?void 0:d.value)??"";return{...d,_id:String(u),name:(d==null?void 0:d.name)??""}}).filter(d=>d._id):[],o=A.value||Y.value;let i=l;o&&(i=l.filter(d=>d._id===o||ae.value&&d.name===ae.value),!i.length&&o&&(i=[{_id:o,name:ae.value||((t=l.find(d=>d._id===o))==null?void 0:t.name)||""}])),H.value=i.length?i:l,H.value.length?H.value.some(d=>d._id===A.value)||(A.value=H.value[0]._id):!A.value&&o&&(A.value=o);const p=A.value||Y.value||(H.value.length?H.value[0]._id:"");await It(p)}catch(e){console.error(e)}}function ge(){return St.value?he():""}async function ba(){if(_e.role!=="supervisor"){Y.value="",ae.value="",M.value="",Ae.value="",ue.value=[],Ve.value=null;return}const t=ge();if(!t){Y.value="",ae.value="",M.value="",Ae.value="",ue.value=[],Ve.value=null;return}let e=null;try{const u=await U(`/api/employees/${t}`);if(!u.ok)throw new Error("Failed to fetch supervisor context");e=await u.json()}catch(u){console.error(u),Ve.value=null}Ve.value=e||null;const a=e==null?void 0:e.department;let l="",o="";if(a&&typeof a=="object")l=(a==null?void 0:a._id)||(a==null?void 0:a.id)||(a==null?void 0:a.value)||"",o=(a==null?void 0:a.name)||(e==null?void 0:e.departmentName)||"";else if(typeof a=="string"){const u=H.value.find(n=>String(n==null?void 0:n._id)===a||String((n==null?void 0:n.id)??"")===a||(n==null?void 0:n.code)===a||(n==null?void 0:n.name)===a);l=(u==null?void 0:u._id)||(u==null?void 0:u.id)||a,o=(u==null?void 0:u.name)||(e==null?void 0:e.departmentName)||a}Y.value=l?String(l):"",ae.value=o?String(o):"",Y.value?A.value=Y.value:A.value="";const i=e==null?void 0:e.subDepartment;let p="",d="";if(i&&typeof i=="object")p=(i==null?void 0:i._id)||(i==null?void 0:i.id)||(i==null?void 0:i.value)||"",d=(i==null?void 0:i.name)||(e==null?void 0:e.subDepartmentName)||"";else if(typeof i=="string"){const u=te.value.find(n=>String(n==null?void 0:n._id)===i||String((n==null?void 0:n.id)??"")===i||(n==null?void 0:n.code)===i||(n==null?void 0:n.name)===i);p=(u==null?void 0:u._id)||(u==null?void 0:u.id)||i,d=(u==null?void 0:u.name)||(e==null?void 0:e.subDepartmentName)||i}M.value=p?String(p):"",Ae.value=d?String(d):"",M.value?j.value=M.value:j.value="",await ga(t)}async function ga(t=""){if(_e.role!=="supervisor"){ue.value=[];return}const e=t||ge();if(!e){ue.value=M.value?[String(M.value)]:[];return}try{const a=await U(`/api/employees?supervisor=${e}`);if(!a.ok)throw new Error("Failed to fetch direct reports");const l=await a.json(),o=Array.isArray(l)?l:[],i=new Set,p=[],d=u=>{if(!u&&u!==0)return;const n=String(u);n&&(i.has(n)||(i.add(n),p.push(n)))};o.forEach(u=>{const n=u==null?void 0:u.subDepartment;d(n&&typeof n=="object"?(n==null?void 0:n._id)||(n==null?void 0:n.id)||(n==null?void 0:n.value):n)}),d(M.value),ue.value=p}catch(a){console.error(a),ue.value=M.value?[String(M.value)]:[]}}async function pe(){const t=ge(),e=[`month=${O.value}`];t&&e.push(`supervisor=${t}`),G.value&&oe.value&&e.push("includeSelf=true");const a=`?${e.join("&")}`;try{const l=await U(`/api/schedules/monthly${a}`);if(!l.ok)throw new Error("Failed to fetch schedules");const o=await l.json(),i=Array.isArray(o)?o:[];Te.value=i;const p=ie.value;v.value={},!K.value.length&&i.length&&await Ne(A.value,j.value),K.value.forEach(f=>{const k=String(f._id);v.value[k]={},p.forEach(w=>{v.value[k][w.date]={shiftId:"",department:f.departmentId,subDepartment:f.subDepartmentId}})}),i.forEach(f=>{var L;const k=((L=f.employee)==null?void 0:L._id)||f.employee;if(!k)return;const w=String(k);v.value[w]||(v.value[w]={},p.forEach(Z=>{v.value[w][Z.date]={shiftId:"",department:"",subDepartment:""}}));const V=J(f.date).date(),Q=K.value.find(Z=>String(Z._id)===w)||{};v.value[w][V]={id:f._id,shiftId:f.shiftId,department:f.department||Q.departmentId,subDepartment:f.subDepartment||Q.subDepartmentId}});const d=e.slice(),u=A.value,n=j.value;u&&d.push(`department=${u}`),n&&d.push(`subDepartment=${n}`);const S=`?${d.join("&")}`,I=await U(`/api/schedules/leave-approvals${S}`);if(I.ok){const f=await I.json(),k=Array.isArray(f==null?void 0:f.approvals)?f.approvals:[],w=Array.isArray(f==null?void 0:f.leaves)?f.leaves:[];Oe.value=k;const V=J(`${O.value}-01`).startOf("day"),Q=V.endOf("month").startOf("day");w.forEach(L=>{var q,B,Pe;if(L.status!=="approved")return;const Z=((q=L.employee)==null?void 0:q._id)||L.employee;if(!Z)return;const rt=String(Z),s=J(L.startDate).startOf("day"),h=J(L.endDate).startOf("day");if(!s.isValid()||!h.isValid())return;let W=s.isBefore(V)?V:s;const ee=h.isAfter(Q)?Q:h;for(;!W.isAfter(ee);){const He=W.date(),Re=(Pe=(B=v.value)==null?void 0:B[rt])==null?void 0:Pe[He];Re&&(Re.leave={type:L.leaveType,startDate:L.startDate,endDate:L.endDate,excludesHours:!0}),W=W.add(1,"day")}})}const R=ge()||he();if(G.value&&oe.value&&R){const f=i.some(w=>{var Q;const V=((Q=w==null?void 0:w.employee)==null?void 0:Q._id)||(w==null?void 0:w.employee);return V&&String(V)===R}),k=[O.value,A.value||"",j.value||""].join("|");f?ke.value&&(ke.value=""):ke.value!==k&&(Me("尚未為主管建立班表，請先建立排班。"),ke.value=k)}else ke.value&&(ke.value="");Je()}catch(l){console.error(l),le.error("取得排班資料失敗"),Te.value=[]}}async function Sa(t){var o;if(!t)return;P.visible=!1,P.doc=null;const e=await U(`/api/approvals/${t}`);if(!e.ok)return;const a=await e.json();P.doc=a,P.visible=!0,(Array.isArray((o=P.doc)==null?void 0:o.steps)?P.doc.steps:[]).forEach(i=>{(Array.isArray(i==null?void 0:i.approvers)?i.approvers:[]).forEach(d=>{var u,n;(u=d==null?void 0:d.approver)!=null&&u._id&&((n=d==null?void 0:d.approver)!=null&&n.name)&&(Ze[d.approver._id]=d.approver.name)})})}function Et(t){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:v.value,employees:K.value,days:ie.value,shifts:re.value})),sa.push({name:t==="week"?"PreviewWeek":"PreviewMonth"})}async function At(t){try{const e=await U(`/api/schedules/export?month=${O.value}&format=${t}`);if(!e.ok)throw new Error;const a=await e.blob(),l=URL.createObjectURL(a),o=document.createElement("a");o.href=l,o.download=`schedules-${O.value}.${t==="excel"?"xlsx":"pdf"}`,o.click(),URL.revokeObjectURL(l)}catch{le.error("匯出失敗")}}async function wa(t,e,a){const l=`${O.value}-${String(e).padStart(2,"0")}`,o=v.value[t][e];if(o!=null&&o.leave){Me("該日已核准請假，無法調整排班");return}const i=(o==null?void 0:o.shiftId)??"";if(o&&o.id)try{const p=await U(`/api/schedules/${o.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:a,department:o.department,subDepartment:o.subDepartment})});p.ok||await We(p,"更新排班失敗",t,e,i)}catch{await We(null,"更新排班失敗",t,e,i)}else try{const p=await U("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:t,date:l,shiftId:a,department:o.department,subDepartment:o.subDepartment})});if(p.ok){const d=await p.json();v.value[t][e]={id:d._id,shiftId:d.shiftId,department:o.department,subDepartment:o.subDepartment}}else await We(p,"新增排班失敗",t,e,i)}catch{await We(null,"新增排班失敗",t,e,i)}}async function ka(){j.value="",await It(A.value),await Ne(A.value,""),await pe()}async function Ca(){await Ne(A.value,j.value),await pe()}async function We(t,e,a,l,o){v.value[a]||(v.value[a]={});const i=v.value[a][l]||{shiftId:"",department:"",subDepartment:""};i.shiftId=o,v.value[a][l]=i;let p="";try{if(t){const d=await t.json();p=(d==null?void 0:d.error)||""}}catch{}p==="employee conflict"?Se.alert("人員衝突"):p==="department overlap"?Se.alert("跨區重複"):p==="leave conflict"?Se.alert("請假衝突"):le.error(e)}async function Vt(t,e="批次套用失敗"){let a="";try{if(t){const l=await t.json();a=(l==null?void 0:l.error)||""}}catch{}a==="employee conflict"?le.warning("部分員工既有排班已更新，請重新整理檢查"):a==="department overlap"?Se.alert("部門或單位與既有資料不一致，無法套用"):a==="leave conflict"?Se.alert("選取日期包含已核准請假，無法套用"):a?le.error(a):le.error(e)}async function Da(){if(!lt.value){be("請先選取要套用的儲存格");return}if(!$e.value){be("請選擇欲套用的班別");return}const t=[];if(at.value.forEach(l=>{var n;const{empId:o,day:i}=tt(l),p=(n=v.value[o])==null?void 0:n[i];if(!p||p.leave)return;const d=ce.value||p.department||"";let u=p.subDepartment||"";ce.value?u=ne.value||"":ne.value&&(u=ne.value),t.push({employee:o,day:i,date:`${O.value}-${String(i).padStart(2,"0")}`,shiftId:$e.value,department:d,subDepartment:u})}),!t.length){Me("選取的儲存格皆無需更新");return}const e=new Map;t.forEach(l=>{e.set(ye(l.employee,l.day),l)}),Ye.value=!0;const a=za.service({fullscreen:!0,lock:!0,text:"批次套用中..."});try{let l;try{l=await U("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:t.map(({day:i,...p})=>p)})})}catch{await Vt(null);return}if(!l.ok){await Vt(l);return}const o=await l.json();if(!Array.isArray(o)||!o.length){Me("沒有可更新的資料");return}o.forEach(i=>{var I;const p=((I=i.employee)==null?void 0:I._id)||i.employee,d=J(i.date).date();v.value[p]||(v.value[p]={});const u=ye(p,d),n=e.get(u)||{},S=v.value[p][d]||{};v.value[p][d]={...S,id:i._id||n.id||S.id,shiftId:i.shiftId||n.shiftId||S.shiftId,department:n.department??i.department??S.department??"",subDepartment:n.subDepartment??i.subDepartment??S.subDepartment??""},delete v.value[p][d].leave}),ot("批次套用完成")}finally{a==null||a.close(),Ye.value=!1}}function ve(t){return re.value.find(e=>e._id===t)}function qe(t){if(!t)return"";const e=t.code??"",a=t.name??"";return!e&&!a?"":a?`${e}(${a})`:e}function it(t){const e=t&&typeof t=="object"?t:ve(t);return e?Ma(e):{}}function $t(t){return te.value.filter(e=>e.department===t)}async function Ne(t="",e=""){var d;const a=ge(),l=[],o=t||A.value||Y.value,i=e||j.value;a&&l.push(`supervisor=${a}`),o&&l.push(`department=${o}`),i&&l.push(`subDepartment=${i}`);const p=`/api/employees${l.length?`?${l.join("&")}`:""}`;try{const u=await U(p);if(!u.ok)throw new Error("Failed to fetch employees");const n=await u.json(),S=H.value.reduce((f,k)=>(f[k._id]=k.name,f),{}),I=te.value.reduce((f,k)=>(f[k._id]=k.name,f),{}),R=n.map(f=>{const k=(f==null?void 0:f._id)??(f==null?void 0:f.id)??"",w=(f==null?void 0:f.department)??"",V=(f==null?void 0:f.subDepartment)??"",Q=k?String(k):"",L=w?String(w):"",Z=V?String(V):"";return{_id:Q,name:f.name,departmentId:L,subDepartmentId:Z,department:S[L]||"",subDepartment:I[Z]||""}});let X=bt(R);if(G.value&&oe.value){const f=a?String(a):"";f&&!X.some(k=>k._id===f)&&(X=bt([...X,{_id:f,name:((d=Ve.value)==null?void 0:d.name)||"主管本人",departmentId:Y.value||"",subDepartmentId:M.value||"",department:ae.value||"",subDepartment:Ae.value||""}]))}K.value=X,Je()}catch(u){console.error(u),le.error("取得員工資料失敗")}}async function xe(){try{const t=[`month=${O.value}`];G.value&&oe.value&&t.push("includeSelf=true");const e=await U(`/api/schedules/summary?${t.join("&")}`);if(e.ok){const a=await e.json();ft.value={direct:a.length,unscheduled:a.filter(l=>l.shiftCount===0).length,onLeave:a.filter(l=>l.leaveCount>0).length}}}catch(t){console.error(t)}}async function Ia(t){const e=t?J(t):J();O.value=e.isValid()?e.format("YYYY-MM"):J().format("YYYY-MM"),await pe(),await xe()}return Aa(async()=>{const t=he();ht(t)===!0&&oe.value&&(G.value=!0);try{await xe(),await ya(),await ba(),await _a(),await Ne(A.value,j.value),await pe()}finally{vt=!1}}),(t,e)=>{const a=z("el-date-picker"),l=z("el-option"),o=z("el-select"),i=z("el-switch"),p=z("el-step"),d=z("el-steps"),u=z("el-progress"),n=z("el-button"),S=z("el-input"),I=z("el-table-column"),R=z("el-checkbox"),X=z("el-tag"),f=z("el-popover"),k=z("el-table"),w=z("el-divider"),V=z("el-descriptions-item"),Q=z("el-descriptions"),L=z("el-timeline-item"),Z=z("el-timeline"),rt=z("el-dialog");return c(),_(x,null,[r("div",Oa,[e[48]||(e[48]=r("div",{class:"page-header"},[r("h1",{class:"page-title"},"排班管理"),r("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),m(Ta,{summary:ft.value},null,8,["summary"]),r("div",La,[e[22]||(e[22]=r("div",{class:"filters-header"},[r("h3",{class:"filters-title"},"篩選條件")],-1)),r("div",Ua,[r("div",Fa,[e[18]||(e[18]=r("label",{class:"filter-label"},"選擇月份",-1)),m(a,{modelValue:O.value,"onUpdate:modelValue":e[0]||(e[0]=s=>O.value=s),type:"month","value-format":"YYYY-MM",onChange:Ia,class:"modern-date-picker"},null,8,["modelValue"])]),r("div",Ya,[e[19]||(e[19]=r("label",{class:"filter-label"},"部門",-1)),m(o,{modelValue:A.value,"onUpdate:modelValue":e[1]||(e[1]=s=>A.value=s),placeholder:"請選擇部門",onChange:ka,disabled:!0,class:"modern-select"},{default:y(()=>[(c(!0),_(x,null,F(H.value,s=>(c(),T(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),r("div",Ba,[e[20]||(e[20]=r("label",{class:"filter-label"},"單位",-1)),m(o,{modelValue:j.value,"onUpdate:modelValue":e[2]||(e[2]=s=>j.value=s),placeholder:"請選擇單位",onChange:Ca,class:"modern-select"},{default:y(()=>[(c(!0),_(x,null,F(la.value,s=>(c(),T(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),oe.value?(c(),_("div",Ja,[e[21]||(e[21]=r("label",{class:"filter-label"},"包含自己",-1)),m(i,{modelValue:G.value,"onUpdate:modelValue":e[3]||(e[3]=s=>G.value=s),"active-text":"是","inactive-text":"否","inline-prompt":""},null,8,["modelValue"])])):N("",!0)])]),fe(we)?(c(),_("div",Ka,[r("div",Wa,[e[23]||(e[23]=r("div",{class:"publish-header-text"},[r("h3",{class:"publish-title"},"發布狀態"),r("p",{class:"publish-subtitle"},"追蹤班表送審、回覆與鎖定流程")],-1)),r("span",{class:Lt(["status-badge",`status-${C.value.status}`]),"data-test":"publish-status-badge"},b(na.value),3)]),r("div",qa,[m(d,{active:oa.value,"finish-status":"success","align-center":""},{default:y(()=>[m(p,{title:"草稿",description:"建立班表草稿",status:Ke.value.draft},null,8,["status"]),m(p,{title:"待確認",description:ia.value,status:Ke.value.pending},null,8,["description","status"]),m(p,{title:"異議",description:ra.value,status:Ke.value.disputed},null,8,["description","status"]),m(p,{title:"完成",description:ua.value,status:Ke.value.finalized},null,8,["description","status"])]),_:1},8,["active"])]),r("div",Ha,[C.value.publishedAt?(c(),_("p",Ga," 最近發布："+b(da(C.value.publishedAt)),1)):(c(),_("p",Qa,"本月尚未發布。")),nt.value>0&&C.value.status!=="finalized"?(c(),_("div",Xa,[m(u,{percentage:nt.value,"stroke-width":8,status:"success","show-text":!1},null,8,["percentage"]),r("span",Za,b(nt.value)+"% 完成",1)])):N("",!0)]),r("div",el,[m(n,{type:"primary",class:"publish-btn",loading:ze.value,disabled:wt.value,onClick:va},{default:y(()=>e[24]||(e[24]=[E(" 發送待確認 ")])),_:1},8,["loading","disabled"]),m(n,{type:"success",plain:"",class:"publish-btn",loading:je.value,disabled:kt.value,onClick:fa},{default:y(()=>e[25]||(e[25]=[E(" 完成發布 ")])),_:1},8,["loading","disabled"])]),r("div",tl,[Ce.value?(c(),_("div",al,[r("div",ll,[e[26]||(e[26]=r("span",{class:"card-title"},"待回覆",-1)),r("span",sl,b(Ce.value),1)]),r("ul",nl,[(c(!0),_(x,null,F(C.value.pendingEmployees,s=>(c(),_("li",{key:s.id,class:"card-item"},[r("span",ol,b(s.name),1),r("span",il,b(s.pendingCount)+" 筆",1)]))),128))])])):N("",!0),De.value?(c(),_("div",rl,[r("div",ul,[e[27]||(e[27]=r("span",{class:"card-title"},"異議",-1)),r("span",dl,b(De.value),1)]),r("ul",cl,[(c(!0),_(x,null,F(C.value.disputedEmployees,s=>(c(),_("li",{key:s.id,class:"card-item"},[r("div",pl,[r("span",vl,b(s.name),1),r("span",fl,b(s.disputedCount)+" 筆",1)]),s.latestNote?(c(),_("div",ml," 最新意見："+b(s.latestNote),1)):N("",!0)]))),128))])])):N("",!0),!Ce.value&&!De.value&&C.value.status!=="draft"&&C.value.status!=="finalized"?(c(),_("div",hl,e[28]||(e[28]=[r("div",{class:"card-header"},[r("span",{class:"card-title"},"回覆完成"),r("span",{class:"card-badge success"},"✓")],-1),r("p",{class:"card-message"},"所有員工已完成回覆，可執行最終發布。",-1)]))):N("",!0),C.value.status==="finalized"?(c(),_("div",yl,e[29]||(e[29]=[r("div",{class:"card-header"},[r("span",{class:"card-title"},"已鎖定"),r("span",{class:"card-badge success"},"100%")],-1),r("p",{class:"card-message"},"班表已完成發布並鎖定。",-1)]))):N("",!0)])])):N("",!0),r("div",_l,[r("div",bl,[m(n,{type:"primary",class:"action-btn primary",onClick:qt,disabled:!lt.value},{default:y(()=>e[30]||(e[30]=[r("i",{class:"el-icon-close"},null,-1),E(" 清除選取 ")])),_:1},8,["disabled"]),m(n,{type:"primary",class:"action-btn primary",plain:"",onClick:Xt,disabled:!K.value.length},{default:y(()=>e[31]||(e[31]=[r("i",{class:"el-icon-user"},null,-1),E(" 全選員工 ")])),_:1},8,["disabled"]),m(n,{type:"primary",class:"action-btn primary",plain:"",onClick:Zt,disabled:!ie.value.length},{default:y(()=>e[32]||(e[32]=[r("i",{class:"el-icon-date"},null,-1),E(" 全選日期 ")])),_:1},8,["disabled"])]),r("div",gl,[r("div",Sl,[e[33]||(e[33]=r("label",{class:"range-label"},"自訂日期範圍",-1)),m(a,{modelValue:Xe.value,"onUpdate:modelValue":e[4]||(e[4]=s=>Xe.value=s),type:"daterange","start-placeholder":"開始日期","end-placeholder":"結束日期","range-separator":"至","unlink-panels":"",disabled:!ie.value.length,class:"modern-date-picker range-picker",onChange:ea},null,8,["modelValue","disabled"])]),m(n,{onClick:e[5]||(e[5]=s=>Et("week")),class:"action-btn secondary"},{default:y(()=>e[34]||(e[34]=[r("i",{class:"el-icon-calendar"},null,-1),E(" 預覽週表 ")])),_:1}),m(n,{onClick:e[6]||(e[6]=s=>Et("month")),class:"action-btn secondary"},{default:y(()=>e[35]||(e[35]=[r("i",{class:"el-icon-date"},null,-1),E(" 預覽月表 ")])),_:1}),m(n,{onClick:e[7]||(e[7]=()=>At("pdf")),class:"action-btn export"},{default:y(()=>e[36]||(e[36]=[r("i",{class:"el-icon-download"},null,-1),E(" 匯出 PDF ")])),_:1}),m(n,{onClick:e[8]||(e[8]=()=>At("excel")),class:"action-btn export"},{default:y(()=>e[37]||(e[37]=[r("i",{class:"el-icon-s-grid"},null,-1),E(" 匯出 Excel ")])),_:1})])]),r("div",wl,[r("div",kl,[e[39]||(e[39]=r("h3",{class:"schedule-title"},"員工排班表",-1)),r("div",Cl,[yt.value.length?(c(!0),_(x,{key:0},F(yt.value,s=>(c(),_("span",{key:s.key,class:"legend-item",style:Ge(s.style),"data-test":"shift-legend-item"},b(s.label),5))),128)):(c(),_("span",Dl," 尚未設定班別 ")),e[38]||(e[38]=r("span",{class:"legend-item leave"},"請假",-1))]),m(S,{modelValue:Le.value,"onUpdate:modelValue":e[9]||(e[9]=s=>Le.value=s),placeholder:"搜尋員工",clearable:"",class:"employee-search"},null,8,["modelValue"]),m(o,{modelValue:Ue.value,"onUpdate:modelValue":e[10]||(e[10]=s=>Ue.value=s),placeholder:"狀態",class:"status-filter"},{default:y(()=>[m(l,{label:"全部",value:"all"}),m(l,{label:"缺班",value:"unscheduled"}),m(l,{label:"待審核請假",value:"onLeave"})]),_:1},8,["modelValue"])]),fe(we)?(c(),_("div",Il,[m(o,{modelValue:$e.value,"onUpdate:modelValue":e[11]||(e[11]=s=>$e.value=s),placeholder:"套用班別",class:"modern-select batch-select",filterable:"","data-test":"batch-shift-select"},{default:y(()=>[(c(!0),_(x,null,F(re.value,s=>(c(),T(l,{key:s._id,label:qe(s),value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),m(o,{modelValue:ce.value,"onUpdate:modelValue":e[12]||(e[12]=s=>ce.value=s),placeholder:"套用部門",clearable:"",class:"modern-select batch-select","data-test":"batch-dept-select"},{default:y(()=>[(c(!0),_(x,null,F(H.value,s=>(c(),T(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),m(o,{modelValue:ne.value,"onUpdate:modelValue":e[13]||(e[13]=s=>ne.value=s),placeholder:"套用單位",clearable:"",class:"modern-select batch-select",disabled:!ce.value,"data-test":"batch-subdept-select"},{default:y(()=>[(c(!0),_(x,null,F(_t.value,s=>(c(),T(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),m(n,{type:"primary",class:"action-btn primary apply-btn",disabled:!lt.value||!$e.value||Ye.value,loading:Ye.value,onClick:Da,"data-test":"batch-apply-button"},{default:y(()=>e[40]||(e[40]=[E(" 套用至選取 ")])),_:1},8,["disabled","loading"])])):N("",!0),m(k,{class:"modern-schedule-table",data:ta.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"},onRowClick:e[15]||(e[15]=s=>gt.value&&aa(s._id))},{default:y(()=>[m(I,{label:"部門／單位",width:"180",fixed:"left"},{default:y(({row:s})=>[r("div",El,[r("div",Al,b(s.department),1),s.subDepartment?(c(),_("div",Vl,b(s.subDepartment),1)):N("",!0)])]),_:1}),m(I,{prop:"name",label:"員工姓名",width:"150",fixed:"left"},{default:y(({row:s})=>[r("div",$l,[fe(we)?(c(),T(R,{key:0,class:"row-checkbox","model-value":Bt.value.has(s._id),onChange:h=>Ht(s._id,h)},null,8,["model-value","onChange"])):N("",!0),st(s._id)==="unscheduled"?(c(),T(ut(fe(Ft)),{key:1,class:"status-icon unscheduled"})):st(s._id)==="onLeave"?(c(),T(ut(fe(Yt)),{key:2,class:"status-icon on-leave"})):N("",!0),E(" "+b(s.name),1)])]),_:1}),(c(!0),_(x,null,F(ie.value,s=>(c(),T(I,{key:s.date,label:s.label,width:"140",align:"center"},{header:y(()=>[r("div",zl,[r("span",null,b(s.label),1),fe(we)?(c(),T(R,{key:0,class:"day-checkbox","model-value":Jt.value.has(s.date),onChange:h=>Gt(s.date,h)},null,8,["model-value","onChange"])):N("",!0)])]),default:y(({row:h})=>{var W,ee,q,B,Pe,He,Re,zt,jt,Mt,Nt,xt,Pt,Rt,Tt;return[!gt.value||Fe.value.has(h._id)?(c(),_("div",{key:0,class:Lt(["modern-schedule-cell",[{"has-leave":(ee=(W=v.value[h._id])==null?void 0:W[s.date])==null?void 0:ee.leave,"missing-shift":!((B=(q=v.value[h._id])==null?void 0:q[s.date])!=null&&B.shiftId)&&!((He=(Pe=v.value[h._id])==null?void 0:Pe[s.date])!=null&&He.leave),"is-selected":Wt(h._id,s.date),"has-shift":!((zt=(Re=v.value[h._id])==null?void 0:Re[s.date])!=null&&zt.leave)&&!!((Mt=(jt=v.value[h._id])==null?void 0:jt[s.date])!=null&&Mt.shiftId)}]]),style:Ge((xt=(Nt=v.value[h._id])==null?void 0:Nt[s.date])!=null&&xt.leave?void 0:it((Rt=(Pt=v.value[h._id])==null?void 0:Pt[s.date])==null?void 0:Rt.shiftId)),title:ha(h._id,s.date)},[fe(we)?(c(),_("div",{key:0,class:"cell-selection",onClick:e[14]||(e[14]=$a(()=>{},["stop"]))},[m(R,{"model-value":Kt.value.has(ye(h._id,s.date)),disabled:!Be(h._id,s.date),onChange:$=>Qt(h._id,s.date,$),size:"small"},null,8,["model-value","disabled","onChange"])])):N("",!0),(Tt=v.value[h._id])!=null&&Tt[s.date]?(c(),_(x,{key:1},[v.value[h._id][s.date].leave?(c(),_("div",Ml,[m(X,{type:"warning",effect:"light",size:"small",class:"leave-tag"},{default:y(()=>e[41]||(e[41]=[E(" 休假中 ")])),_:1}),e[42]||(e[42]=r("span",{class:"leave-note"},"已核准請假，不列入工時",-1))])):fe(we)?(c(),_(x,{key:1},[m(o,{modelValue:v.value[h._id][s.date].shiftId,"onUpdate:modelValue":$=>v.value[h._id][s.date].shiftId=$,placeholder:"選擇班別",onChange:$=>wa(h._id,s.date,$),class:"cell-select shift-select",size:"small"},{default:y(()=>[(c(!0),_(x,null,F(re.value,$=>(c(),T(l,{key:$._id,label:qe($),value:$._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),r("div",Nl,[m(o,{modelValue:v.value[h._id][s.date].department,"onUpdate:modelValue":$=>v.value[h._id][s.date].department=$,placeholder:"部門",size:"small",onChange:()=>v.value[h._id][s.date].subDepartment="",class:"cell-select dept-select"},{default:y(()=>[(c(!0),_(x,null,F(H.value,$=>(c(),T(l,{key:$._id,label:$.name,value:$._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),m(o,{modelValue:v.value[h._id][s.date].subDepartment,"onUpdate:modelValue":$=>v.value[h._id][s.date].subDepartment=$,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:y(()=>[(c(!0),_(x,null,F($t(v.value[h._id][s.date].department),$=>(c(),T(l,{key:$._id,label:$.name,value:$._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(c(),_(x,{key:2},[ve(v.value[h._id][s.date].shiftId)?(c(),T(f,{key:0,placement:"top",trigger:"hover",width:200},{reference:y(()=>[r("div",{class:"modern-shift-tag",style:Ge(it(ve(v.value[h._id][s.date].shiftId)))},b(qe(ve(v.value[h._id][s.date].shiftId))),5)]),default:y(()=>[r("div",xl,[r("div",Pl,[e[43]||(e[43]=r("span",{class:"detail-label"},"上班時間：",-1)),r("span",Rl,b(ve(v.value[h._id][s.date].shiftId).startTime),1)]),r("div",Tl,[e[44]||(e[44]=r("span",{class:"detail-label"},"下班時間：",-1)),r("span",Ol,b(ve(v.value[h._id][s.date].shiftId).endTime),1)]),ve(v.value[h._id][s.date].shiftId).remark?(c(),_("div",Ll,[e[45]||(e[45]=r("span",{class:"detail-label"},"備註：",-1)),r("span",Ul,b(ve(v.value[h._id][s.date].shiftId).remark),1)])):N("",!0)])]),_:2},1024)):N("",!0)],64)),!v.value[h._id][s.date].shiftId&&!v.value[h._id][s.date].leave?(c(),_("div",Fl," 未排班 ")):N("",!0)],64)):(c(),_("span",Yl,"-"))],14,jl)):(c(),_("div",Bl,"展開班表"))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])]),Oe.value.length?(c(),_("div",Jl,[r("div",Kl,[e[46]||(e[46]=r("h3",{class:"approval-title"},"待處理審批",-1)),r("div",Wl,b(Oe.value.length)+" 項待處理",1)]),m(k,{class:"modern-approval-table",data:Oe.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:y(()=>[m(I,{label:"申請人",width:"120"},{default:y(({row:s})=>{var h;return[r("div",ql,b((h=s.applicant_employee)==null?void 0:h.name),1)]}),_:1}),m(I,{label:"申請類型",width:"150"},{default:y(({row:s})=>{var h,W;return[r("div",Hl,b(pt((h=s.form)==null?void 0:h.category,(W=s.form)==null?void 0:W.name)),1)]}),_:1}),m(I,{prop:"status",label:"狀態",width:"100"},{default:y(({row:s})=>[m(X,{type:s.status==="approved"?"success":s.status==="rejected"?"danger":"warning",class:"status-tag"},{default:y(()=>[E(b(s.status),1)]),_:2},1032,["type"])]),_:1}),m(I,{label:"操作",width:"120"},{default:y(({row:s})=>[m(n,{size:"small",onClick:h=>Sa(s._id),disabled:!s._id},{default:y(()=>e[47]||(e[47]=[E(" 查看 ")])),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"])])):N("",!0)]),m(rt,{modelValue:P.visible,"onUpdate:modelValue":e[17]||(e[17]=s=>P.visible=s),title:"申請單明細",width:"760px"},{footer:y(()=>[m(n,{onClick:e[16]||(e[16]=s=>P.visible=!1)},{default:y(()=>e[54]||(e[54]=[E("關閉")])),_:1})]),default:y(()=>{var s,h,W;return[P.doc?(c(),_("div",Gl,[r("p",Ql,[e[49]||(e[49]=r("b",null,"表單：",-1)),E(b((s=P.doc.form)==null?void 0:s.name)+"（"+b((h=P.doc.form)==null?void 0:h.category)+"）",1)]),r("p",Xl,[e[50]||(e[50]=r("b",null,"申請人：",-1)),E(b(((W=P.doc.applicant_employee)==null?void 0:W.name)||"-"),1)]),r("p",Zl,[e[51]||(e[51]=r("b",null,"狀態：",-1)),E(b(Dt(P.doc.status)),1)]),m(w,{"content-position":"left"},{default:y(()=>e[52]||(e[52]=[E("填寫內容")])),_:1}),m(Q,{column:1,size:"small",border:""},{default:y(()=>{var ee;return[(c(!0),_(x,null,F(((ee=P.doc.form)==null?void 0:ee.fields)||[],q=>(c(),T(V,{key:q._id,label:q.label},{default:y(()=>{var B;return[r("span",null,b(Qe((B=P.doc.form_data)==null?void 0:B[q._id])),1)]}),_:2},1032,["label"]))),128))]}),_:1}),m(w,{"content-position":"left"},{default:y(()=>e[53]||(e[53]=[E("流程")])),_:1}),m(Z,null,{default:y(()=>[(c(!0),_(x,null,F(P.doc.steps,(ee,q)=>(c(),T(L,{key:q,timestamp:`第 ${q+1} 關`,type:q===P.doc.current_step_index?"primary":"info"},{default:y(()=>[r("div",es,[r("span",ts,"需全員同意："+b(ee.all_must_approve?"是":"否"),1),r("span",null,"必簽："+b(ee.is_required?"是":"否"),1)]),m(k,{data:ee.approvers,size:"small",border:""},{default:y(()=>[m(I,{label:"審核人",width:"200"},{default:y(({row:B})=>[E(b(ma(B.approver)),1)]),_:1}),m(I,{label:"決議",width:"120"},{default:y(({row:B})=>[E(b(Dt(B.decision)),1)]),_:1}),m(I,{label:"時間",width:"200"},{default:y(({row:B})=>[E(b(Ee(B.decided_at)),1)]),_:1}),m(I,{prop:"comment",label:"意見"})]),_:2},1032,["data"])]),_:2},1032,["timestamp","type"]))),128))]),_:1})])):N("",!0)]}),_:1},8,["modelValue"])],64)}}},rs=Ut(ls,[["__scopeId","data-v-a41c5f75"]]);export{rs as default};
