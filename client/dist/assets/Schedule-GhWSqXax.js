import{A as pe,r as g,p as me,_ as fe,B as T,x as W,j as ve,c as h,b as s,y as R,d as f,e as C,w as p,a as he,t as b,E as O,u as _e,o as c,F as I,l as M,k as x,g as A,n as be,C as q}from"./index-umFJ41UP.js";import{a as y}from"./api-B8tfGK9d.js";const ye=pe("auth",()=>{const N=g("employee");function _(){const r=me();if(r)try{const V=JSON.parse(atob(r.split(".")[1]));N.value=V.role||"employee"}catch{N.value="employee"}else N.value="employee"}return{role:N,loadUser:_}}),ge={class:"schedule-page"},ke={class:"filters-card"},we={class:"filters-content"},De={class:"filter-group"},Ie={class:"filter-group"},Se={class:"filter-group"},Ce={class:"actions-card"},Ve={class:"primary-actions"},$e={class:"secondary-actions"},je={class:"schedule-card"},Ee={class:"employee-info"},xe={class:"department-name"},Ue={key:0,class:"sub-department"},Te={class:"employee-name"},Oe={class:"department-selects"},Me={class:"shift-details"},Ae={class:"detail-row"},Ne={class:"detail-value"},Fe={class:"detail-row"},Pe={class:"detail-value"},Re={key:0,class:"detail-row"},Be={class:"detail-value"},Le={class:"modern-shift-tag"},Je={key:2,class:"leave-indicator"},ze={key:1,class:"empty-cell"},Ye={key:0,class:"approval-card"},We={class:"approval-header"},qe={class:"approval-count"},Ge={class:"applicant-name"},He={class:"form-type"},Ke={__name:"Schedule",setup(N){const _=g(T().format("YYYY-MM")),r=g({}),V=g([]),U=g([]),B=g([]),F=g([]),$=g([]),k=g(""),w=g(""),te=W(()=>$.value.filter(l=>l.department===k.value)),ae=_e(),G=ye();G.loadUser();const le=W(()=>["supervisor","admin"].includes(G.role)),Y=W(()=>{const l=T(_.value+"-01"),e=l.endOf("month").date(),u=["日","一","二","三","四","五","六"];return Array.from({length:e},(n,i)=>{const o=i+1,a=u[l.date(o).day()];return{date:o,label:`${o}(${a})`}})});async function se(){const l=await y("/api/attendance-settings");if(l.ok){const e=await l.json(),u=Array.isArray(e==null?void 0:e.shifts)?e.shifts:e;Array.isArray(u)&&(V.value=u.map(n=>({_id:n._id,code:n.code,startTime:n.startTime,endTime:n.endTime,remark:n.remark})))}else l.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",l.status)}async function H(l=""){try{const e=l?`/api/sub-departments?department=${l}`:"/api/sub-departments",u=await y(e);if(!u.ok)throw new Error("Failed to fetch sub departments");const n=await u.json(),i=F.value.reduce((o,a)=>(o[a._id]=a._id,o[a.name]=a._id,o),{});$.value=Array.isArray(n)?n.map(o=>{let a="";return o&&typeof o.department=="object"?a=o.department._id||i[o.department.name]||"":a=i[o.department]||o.department||"",{...o,_id:String(o._id),department:String(a)}}):[],$.value.length&&!w.value&&(w.value=$.value[0]._id)}catch(e){console.error(e),$.value=[],w.value=""}}async function ne(){try{const l=await y("/api/departments");F.value=l.ok?await l.json():[],await H(k.value)}catch(l){console.error(l)}}async function L(){const l=localStorage.getItem("employeeId"),e=l&&l!=="undefined"?`&supervisor=${l}`:"";try{const u=await y(`/api/schedules/monthly?month=${_.value}${e}`);if(!u.ok)throw new Error("Failed to fetch schedules");const n=await u.json();console.log("Schedules:",n);const i=Y.value;r.value={},U.value.length||await z(k.value,w.value),U.value.forEach(a=>{r.value[a._id]={},i.forEach(v=>{r.value[a._id][v.date]={shiftId:"",department:a.departmentId,subDepartment:a.subDepartmentId}})}),n.forEach(a=>{var t;const v=((t=a.employee)==null?void 0:t._id)||a.employee,D=T(a.date).date(),S=U.value.find(d=>d._id===v)||{};r.value[v][D]={id:a._id,shiftId:a.shiftId,department:a.department||S.departmentId,subDepartment:a.subDepartment||S.subDepartmentId}});const o=await y(`/api/schedules/leave-approvals?month=${_.value}${e}`);if(o.ok){const a=await o.json();B.value=a.approvals||[],(a.leaves||[]).forEach(v=>{var d,P;if(v.status!=="approved")return;const D=((d=v.employee)==null?void 0:d._id)||v.employee,S=T(v.startDate).date(),t=T(v.endDate).date();for(let E=S;E<=t;E++)(P=r.value[D])!=null&&P[E]&&(r.value[D][E].leave={type:v.leaveType})})}}catch(u){console.error(u),O.error("取得排班資料失敗")}}async function oe(){const l=[];if(Object.keys(r.value).forEach(e=>{Object.keys(r.value[e]).forEach(u=>{const n=r.value[e][u];n.shiftId&&!n.id&&l.push({employee:e,date:`${_.value}-${String(u).padStart(2,"0")}`,shiftId:n.shiftId,department:n.department,subDepartment:n.subDepartment})})}),!!l.length)try{const e=await y("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:l})});if(!e.ok)throw new Error("save failed");(await e.json()).forEach(n=>{var a;const i=((a=n.employee)==null?void 0:a._id)||n.employee,o=T(n.date).date();r.value[i]||(r.value[i]={}),r.value[i][o]={id:n._id,shiftId:n.shiftId}}),O.success("儲存完成")}catch{O.error("儲存失敗")}}function K(l){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:r.value,employees:U.value,days:Y.value,shifts:V.value})),ae.push({name:l==="week"?"PreviewWeek":"PreviewMonth"})}async function Q(l){try{const e=await y(`/api/schedules/export?month=${_.value}&format=${l}`);if(!e.ok)throw new Error;const u=await e.blob(),n=URL.createObjectURL(u),i=document.createElement("a");i.href=n,i.download=`schedules-${_.value}.${l==="excel"?"xlsx":"pdf"}`,i.click(),URL.revokeObjectURL(n)}catch{O.error("匯出失敗")}}async function de(l,e,u){const n=`${_.value}-${String(e).padStart(2,"0")}`,i=r.value[l][e],o=i.shiftId;if(i&&i.id)try{const a=await y(`/api/schedules/${i.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:u,department:i.department,subDepartment:i.subDepartment})});a.ok||await J(a,"更新排班失敗",l,e,o)}catch{await J(null,"更新排班失敗",l,e,o)}else try{const a=await y("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:l,date:n,shiftId:u,department:i.department,subDepartment:i.subDepartment})});if(a.ok){const v=await a.json();r.value[l][e]={id:v._id,shiftId:v.shiftId,department:i.department,subDepartment:i.subDepartment}}else await J(a,"新增排班失敗",l,e,o)}catch{await J(null,"新增排班失敗",l,e,o)}}async function re(){w.value="",await H(k.value),await z(k.value,""),await L()}async function ie(){await z(k.value,w.value),await L()}async function J(l,e,u,n,i){r.value[u][n].shiftId=i;let o="";try{if(l){const a=await l.json();o=(a==null?void 0:a.error)||""}}catch{}o==="employee conflict"?q.alert("人員衝突"):o==="department overlap"?q.alert("跨區重複"):o==="leave conflict"?q.alert("請假衝突"):O.error(e)}function j(l){return V.value.find(e=>e._id===l)}function ue(l){const e=j(l);return e?/早/.test(e.code)?"shift-morning":/晚|夜/.test(e.code)?"shift-evening":"shift-normal":""}function ce(l){return $.value.filter(e=>e.department===l)}async function z(l="",e=""){const u=localStorage.getItem("employeeId"),n=[];u&&u!=="undefined"&&n.push(`supervisor=${u}`),l&&n.push(`department=${l}`),e&&n.push(`subDepartment=${e}`);const i=`/api/employees${n.length?`?${n.join("&")}`:""}`;try{const o=await y(i);if(!o.ok)throw new Error("Failed to fetch employees");const a=await o.json(),v=F.value.reduce((t,d)=>(t[d._id]=d.name,t),{}),D=$.value.reduce((t,d)=>(t[d._id]=d.name,t),{}),S=a.map(t=>({_id:t._id,name:t.name,departmentId:t.department,subDepartmentId:t.subDepartment,department:v[t.department]||"",subDepartment:D[t.subDepartment]||""})).sort((t,d)=>t.department.localeCompare(d.department));U.value=S}catch(o){console.error(o),O.error("取得員工資料失敗")}}return ve(async()=>{await se(),await ne(),await z(k.value,w.value),await L()}),(l,e)=>{const u=C("el-date-picker"),n=C("el-option"),i=C("el-select"),o=C("el-button"),a=C("el-table-column"),v=C("el-popover"),D=C("el-table"),S=C("el-tag");return c(),h("div",ge,[e[22]||(e[22]=s("div",{class:"page-header"},[s("h1",{class:"page-title"},"排班管理"),s("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),s("div",ke,[e[10]||(e[10]=s("div",{class:"filters-header"},[s("h3",{class:"filters-title"},"篩選條件")],-1)),s("div",we,[s("div",De,[e[7]||(e[7]=s("label",{class:"filter-label"},"選擇月份",-1)),f(u,{modelValue:_.value,"onUpdate:modelValue":e[0]||(e[0]=t=>_.value=t),type:"month",onChange:L,class:"modern-date-picker"},null,8,["modelValue"])]),s("div",Ie,[e[8]||(e[8]=s("label",{class:"filter-label"},"部門",-1)),f(i,{modelValue:k.value,"onUpdate:modelValue":e[1]||(e[1]=t=>k.value=t),placeholder:"請選擇部門",onChange:re,class:"modern-select"},{default:p(()=>[(c(!0),h(I,null,M(F.value,t=>(c(),x(n,{key:t._id,label:t.name,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),s("div",Se,[e[9]||(e[9]=s("label",{class:"filter-label"},"單位",-1)),f(i,{modelValue:w.value,"onUpdate:modelValue":e[2]||(e[2]=t=>w.value=t),placeholder:"請選擇單位",onChange:ie,class:"modern-select"},{default:p(()=>[(c(!0),h(I,null,M(te.value,t=>(c(),x(n,{key:t._id,label:t.name,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])]),s("div",Ce,[s("div",Ve,[f(o,{type:"primary",onClick:oe,class:"action-btn primary"},{default:p(()=>e[11]||(e[11]=[s("i",{class:"el-icon-check"},null,-1),A(" 儲存排班 ")])),_:1})]),s("div",$e,[f(o,{onClick:e[3]||(e[3]=t=>K("week")),class:"action-btn secondary"},{default:p(()=>e[12]||(e[12]=[s("i",{class:"el-icon-calendar"},null,-1),A(" 預覽週表 ")])),_:1}),f(o,{onClick:e[4]||(e[4]=t=>K("month")),class:"action-btn secondary"},{default:p(()=>e[13]||(e[13]=[s("i",{class:"el-icon-date"},null,-1),A(" 預覽月表 ")])),_:1}),f(o,{onClick:e[5]||(e[5]=()=>Q("pdf")),class:"action-btn export"},{default:p(()=>e[14]||(e[14]=[s("i",{class:"el-icon-download"},null,-1),A(" 匯出 PDF ")])),_:1}),f(o,{onClick:e[6]||(e[6]=()=>Q("excel")),class:"action-btn export"},{default:p(()=>e[15]||(e[15]=[s("i",{class:"el-icon-s-grid"},null,-1),A(" 匯出 Excel ")])),_:1})])]),s("div",je,[e[20]||(e[20]=he('<div class="schedule-header" data-v-9b83fa7f><h3 class="schedule-title" data-v-9b83fa7f>員工排班表</h3><div class="schedule-legend" data-v-9b83fa7f><span class="legend-item morning" data-v-9b83fa7f>早班</span><span class="legend-item evening" data-v-9b83fa7f>晚班</span><span class="legend-item normal" data-v-9b83fa7f>正常班</span><span class="legend-item leave" data-v-9b83fa7f>請假</span></div></div>',1)),f(D,{class:"modern-schedule-table",data:U.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"}},{default:p(()=>[f(a,{label:"部門／單位",width:"180",fixed:"left"},{default:p(({row:t})=>[s("div",Ee,[s("div",xe,b(t.department),1),t.subDepartment?(c(),h("div",Ue,b(t.subDepartment),1)):R("",!0)])]),_:1}),f(a,{prop:"name",label:"員工姓名",width:"120",fixed:"left"},{default:p(({row:t})=>[s("div",Te,b(t.name),1)]),_:1}),(c(!0),h(I,null,M(Y.value,t=>(c(),x(a,{key:t.date,label:t.label,width:"140",align:"center"},{default:p(({row:d})=>{var P,E,X,Z,ee;return[s("div",{class:be(["modern-schedule-cell",[ue((E=(P=r.value[d._id])==null?void 0:P[t.date])==null?void 0:E.shiftId),{"has-leave":(Z=(X=r.value[d._id])==null?void 0:X[t.date])==null?void 0:Z.leave}]])},[(ee=r.value[d._id])!=null&&ee[t.date]?(c(),h(I,{key:0},[le.value?(c(),h(I,{key:0},[f(i,{modelValue:r.value[d._id][t.date].shiftId,"onUpdate:modelValue":m=>r.value[d._id][t.date].shiftId=m,placeholder:"選擇班別",onChange:m=>de(d._id,t.date,m),class:"cell-select shift-select",size:"small"},{default:p(()=>[(c(!0),h(I,null,M(V.value,m=>(c(),x(n,{key:m._id,label:m.code,value:m._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),s("div",Oe,[f(i,{modelValue:r.value[d._id][t.date].department,"onUpdate:modelValue":m=>r.value[d._id][t.date].department=m,placeholder:"部門",size:"small",onChange:()=>r.value[d._id][t.date].subDepartment="",class:"cell-select dept-select"},{default:p(()=>[(c(!0),h(I,null,M(F.value,m=>(c(),x(n,{key:m._id,label:m.name,value:m._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),f(i,{modelValue:r.value[d._id][t.date].subDepartment,"onUpdate:modelValue":m=>r.value[d._id][t.date].subDepartment=m,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:p(()=>[(c(!0),h(I,null,M(ce(r.value[d._id][t.date].department),m=>(c(),x(n,{key:m._id,label:m.name,value:m._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(c(),h(I,{key:1},[j(r.value[d._id][t.date].shiftId)?(c(),x(v,{key:0,placement:"top",trigger:"hover",width:200},{reference:p(()=>[s("div",Le,b(j(r.value[d._id][t.date].shiftId).code),1)]),default:p(()=>[s("div",Me,[s("div",Ae,[e[16]||(e[16]=s("span",{class:"detail-label"},"上班時間：",-1)),s("span",Ne,b(j(r.value[d._id][t.date].shiftId).startTime),1)]),s("div",Fe,[e[17]||(e[17]=s("span",{class:"detail-label"},"下班時間：",-1)),s("span",Pe,b(j(r.value[d._id][t.date].shiftId).endTime),1)]),j(r.value[d._id][t.date].shiftId).remark?(c(),h("div",Re,[e[18]||(e[18]=s("span",{class:"detail-label"},"備註：",-1)),s("span",Be,b(j(r.value[d._id][t.date].shiftId).remark),1)])):R("",!0)])]),_:2},1024)):R("",!0)],64)),r.value[d._id][t.date].leave?(c(),h("div",Je,e[19]||(e[19]=[s("i",{class:"el-icon-warning-outline"},null,-1),s("span",null,"請假",-1)]))):R("",!0)],64)):(c(),h("span",ze,"-"))],2)]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])]),B.value.length?(c(),h("div",Ye,[s("div",We,[e[21]||(e[21]=s("h3",{class:"approval-title"},"待處理審批",-1)),s("div",qe,b(B.value.length)+" 項待處理",1)]),f(D,{class:"modern-approval-table",data:B.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:p(()=>[f(a,{label:"申請人",width:"120"},{default:p(({row:t})=>{var d;return[s("div",Ge,b((d=t.applicant_employee)==null?void 0:d.name),1)]}),_:1}),f(a,{label:"申請類型",width:"150"},{default:p(({row:t})=>{var d;return[s("div",He,b(((d=t.form)==null?void 0:d.name)||"未知類型"),1)]}),_:1}),f(a,{prop:"status",label:"狀態",width:"100"},{default:p(({row:t})=>[f(S,{type:t.status==="approved"?"success":t.status==="rejected"?"danger":"warning",class:"status-tag"},{default:p(()=>[A(b(t.status),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])):R("",!0)])}}},Ze=fe(Ke,[["__scopeId","data-v-9b83fa7f"]]);export{Ze as default};
