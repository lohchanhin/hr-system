import{_ as tt,v as j,D as At,G as at,H as lt,c as _,o as m,F as x,m as O,e as L,l as C,w as y,b as v,I as Oe,J as jt,t as E,r as b,K as F,k as be,j as xt,d as f,x as N,h as ne,E as B,u as Ut,g as z,n as et,f as Mt,z as ge,L as Lt}from"./index-B6oJpjLF.js";import{a as U}from"./api-C-QqRWhG.js";import{u as Nt}from"./auth-DyrWvZMu.js";const zt={class:"dashboard"},Ot={class:"metric-label"},Tt={class:"metric-value"},Rt=Object.assign({name:"ScheduleDashboard"},{__name:"ScheduleDashboard",props:{summary:{type:Object,default:()=>({direct:0,unscheduled:0,onLeave:0})}},setup(Te){const I=Te,p=j(()=>[{label:"直屬員工數",value:I.summary.direct,icon:At,color:"#0f766e"},{label:"未排班員工",value:I.summary.unscheduled,icon:at,color:"#dc2626"},{label:"請假中員工",value:I.summary.onLeave,icon:lt,color:"#f59e0b"}]);return(P,$)=>{const oe=L("el-card");return m(),_("div",zt,[(m(!0),_(x,null,O(p.value,k=>(m(),C(oe,{class:"metric-card",key:k.label},{default:y(()=>[(m(),C(Oe(k.icon),{class:"metric-icon",style:jt({color:k.color})},null,8,["style"])),v("div",Ot,E(k.label),1),v("div",Tt,E(k.value),1)]),_:2},1024))),128))])}}}),Ft=tt(Rt,[["__scopeId","data-v-ceb5c889"]]),Bt={class:"schedule-page"},Pt={class:"filters-card"},Wt={class:"filters-content"},Jt={class:"filter-group"},Kt={class:"filter-group"},Yt={class:"filter-group"},Ht={key:0,class:"filter-group include-self-group"},qt={class:"actions-card"},Gt={class:"primary-actions"},Qt={class:"secondary-actions"},Xt={class:"range-picker-wrapper"},Zt={class:"schedule-card"},ea={class:"schedule-header"},ta={class:"schedule-legend","data-test":"schedule-legend"},aa={key:1,class:"legend-empty","data-test":"shift-legend-empty"},la={key:0,class:"batch-toolbar"},sa={class:"employee-info"},na={class:"department-name"},oa={key:0,class:"sub-department"},ra={class:"employee-name"},ua={class:"day-header"},ia=["title"],da={key:0,class:"leave-indicator","data-test":"leave-indicator"},ca={class:"department-selects"},va={class:"shift-details"},pa={class:"detail-row"},ma={class:"detail-value"},fa={class:"detail-row"},ha={class:"detail-value"},ya={key:0,class:"detail-row"},_a={class:"detail-value"},ba={class:"modern-shift-tag"},ga={key:3,class:"missing-label"},Sa={key:2,class:"empty-cell"},wa={key:1,class:"modern-schedule-cell collapsed-cell"},ka={key:0,class:"approval-card"},Da={class:"approval-header"},Ca={class:"approval-count"},Ia={class:"applicant-name"},Va={class:"form-type"},Ea={__name:"Schedule",setup(Te){const I=b(F().format("YYYY-MM")),p=b({}),P=b([]),$=b([]),oe=b([]),k=b([]),W=b([]),w=b(""),D=b(""),A=b(""),T=b(""),S=b(""),ie=b(""),Q=b([]),de=b(null),re=b(!1),Re=b({direct:0,unscheduled:0,onLeave:0}),Se=b(""),we=b("all"),ke=b(new Set),X=b(new Set),J=b(new Set),te=b(new Set),je=b([]),ce=b(""),Z=b(""),K=b(""),De=b(!1),st=j(()=>X.value),nt=j(()=>J.value),ot=j(()=>te.value),Fe=j(()=>{if(!Array.isArray(P.value)||!P.value.length)return[];const t=new Set;return P.value.reduce((e,a)=>{if(!a)return e;const l=$e(a)||a.name||a.code||"未命名班別",n=String(a._id||`${a.code??""}-${a.name??""}`);return!n||t.has(n)||(t.add(n),e.push({key:n,label:l,className:Qe(a)||"shift-normal"})),e},[])}),ae=(t,e)=>`${t}-${e}`,xe=t=>{const[e,a]=String(t).split("-");return{empId:e,day:Number(a)}},Ce=(t,e)=>{const a=p.value[t];if(!a)return!1;const l=a[e];return l?!l.leave:!1},Ue=j(()=>{const t=new Set,e=Y.value,a=$.value,l=(n,o)=>{Ce(n,o)&&t.add(ae(n,o))};return te.value.forEach(n=>{const{empId:o,day:c}=xe(n);l(o,c)}),X.value.forEach(n=>{e.forEach(o=>l(n,o.date))}),J.value.forEach(n=>{a.forEach(o=>l(o._id,n))}),t}),Me=j(()=>Ue.value.size>0),Be=j(()=>Z.value?Xe(Z.value):[]),rt=(t,e)=>Ue.value.has(ae(t,e)),Ie=()=>{const t=new Set($.value.map(l=>l._id)),e=new Set(Y.value.map(l=>l.date));X.value=new Set(Array.from(X.value).filter(l=>t.has(l))),J.value=new Set(Array.from(J.value).filter(l=>e.has(l)));const a=new Set;te.value.forEach(l=>{const{empId:n,day:o}=xe(l);t.has(n)&&e.has(o)&&Ce(n,o)&&a.add(ae(n,o))}),te.value=a},ut=()=>{X.value=new Set,J.value=new Set,te.value=new Set,je.value=[]},it=(t,e)=>{const a=new Set(X.value);(typeof e=="boolean"?e:!a.has(t))?a.add(t):a.delete(t),X.value=a},dt=(t,e)=>{const a=new Set(J.value);(typeof e=="boolean"?e:!a.has(t))?a.add(t):a.delete(t),J.value=a},ct=(t,e,a)=>{if(!Ce(t,e))return;const l=ae(t,e),n=new Set(te.value);(typeof a=="boolean"?a:!n.has(l))?n.add(l):n.delete(l),te.value=n},vt=()=>{X.value=new Set($.value.map(t=>t._id))},pt=()=>{J.value=new Set(Y.value.map(t=>t.date))},Pe=t=>[...t].sort((e,a)=>{const l=(e.department||"").localeCompare(a.department||"");return l!==0?l:(e.name||"").localeCompare(a.name||"")}),mt=t=>{if(!Array.isArray(t)||t.length!==2)return;const[e,a]=t;if(!e||!a)return;const l=F(`${I.value}-01`),n=F(e),o=F(a);if(!n.isValid()||!o.isValid())return;const c=l.endOf("month");let i=n.isBefore(l)?l:n;const r=[];for(;(i.isBefore(o)||i.isSame(o,"day"))&&(i.year()===l.year()&&i.month()===l.month()&&r.push(i.date()),!i.isSame(c,"day"));)i=i.add(1,"day");J.value=new Set(r)};be(Z,(t,e)=>{t!==e&&(K.value="")}),be(Be,t=>{K.value&&!t.some(e=>e._id===K.value)&&(K.value="")}),be(re,async(t,e)=>{t!==e&&ve.value&&(await fe(w.value,D.value),await me(),await ze())});const Le=t=>{const e=p.value[t]||{},a=Object.values(e),l=a.some(o=>o.shiftId),n=a.some(o=>o.leave);return l?n?"onLeave":"scheduled":"unscheduled"},ft=j(()=>{let t=Se.value?$.value.filter(e=>e.name.includes(Se.value)):$.value;return we.value!=="all"&&(t=t.filter(e=>Le(e._id)===we.value)),t}),We=j(()=>$.value.length>50),ht=t=>{ke.value.has(t)?ke.value.delete(t):ke.value.add(t)},yt=j(()=>W.value.filter(t=>t.department===w.value)),_t=Ut(),ue=Nt();ue.loadUser();const Je=j(()=>["supervisor","admin"].includes(ue.role)),ve=j(()=>ue.role==="supervisor"),pe=Je,Ke=t=>{var l,n;const e=(l=B)==null?void 0:l.warning;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.warning:void 0;typeof a=="function"&&a!==e&&a(t)},Ne=t=>{var l,n;const e=(l=B)==null?void 0:l.info;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.info:void 0;typeof a=="function"&&a!==e&&a(t)},bt=t=>{var l,n;const e=(l=B)==null?void 0:l.success;typeof e=="function"&&e(t);const a=typeof window<"u"?(n=window.ElMessage)==null?void 0:n.success:void 0;typeof a=="function"&&a!==e&&a(t)},gt=(t,e)=>{var l,n;const a=(n=(l=p.value)==null?void 0:l[t])==null?void 0:n[e];return a!=null&&a.leave?"已核准請假，該日不列入工作時數":""},Y=j(()=>{const t=F(I.value+"-01"),e=t.endOf("month").date(),a=["日","一","二","三","四","五","六"];return Array.from({length:e},(l,n)=>{const o=n+1,c=a[t.date(o).day()];return{date:o,label:`${o}(${c})`}})});be($,Ie),be(Y,Ie);async function St(){const t=await U("/api/shifts");if(t.ok){const e=await t.json(),a=Array.isArray(e==null?void 0:e.shifts)?e.shifts:Array.isArray(e)?e:[];Array.isArray(a)&&(P.value=a.map(l=>({_id:l._id,code:l.code,name:l.name??"",startTime:l.startTime,endTime:l.endTime,remark:l.remark})))}else t.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",t.status)}async function Ye(t=""){try{const e=t||A.value,a=e?`/api/sub-departments?department=${e}`:"/api/sub-departments",l=await U(a);if(!l.ok)throw new Error("Failed to fetch sub departments");const n=await l.json(),o=k.value.reduce((r,d)=>{const h=String(d._id);return r[h]=h,d.name&&(r[d.name]=h),r},{});A.value&&(o[A.value]=A.value),T.value&&(o[T.value]=A.value||T.value);const c=Array.isArray(n)?n.map(r=>{const d=r==null?void 0:r.department;let h="";return d&&typeof d=="object"?h=(d==null?void 0:d._id)||(d==null?void 0:d.id)||o[d==null?void 0:d.name]||"":h=o[d]||d||"",{...r,_id:String((r==null?void 0:r._id)??(r==null?void 0:r.id)??""),department:String(h)}}).filter(r=>r._id):[];let i=c;if(e&&(i=c.filter(r=>r.department===String(e)),!i.length&&S.value)){const r=c.find(d=>d._id===S.value);r?i=[r]:i=[{_id:S.value,name:ie.value||"",department:String(e)}]}if(ue.role==="supervisor"){const r=Q.value.length?Q.value:S.value?[S.value]:[],d=new Set(r.map(h=>String(h)));d.size?i=i.filter(h=>d.has(String(h._id))):i=[]}W.value=i,W.value.length?S.value&&W.value.some(r=>r._id===S.value)?D.value=S.value:D.value&&W.value.some(r=>r._id===D.value)||(D.value=W.value[0]._id):D.value=""}catch(e){console.error(e),W.value=[],D.value=""}}async function wt(){var t;try{const e=await U("/api/departments"),a=e.ok?await e.json():[],l=Array.isArray(a)?a.map(i=>{const r=(i==null?void 0:i._id)??(i==null?void 0:i.id)??(i==null?void 0:i.value)??"";return{...i,_id:String(r),name:(i==null?void 0:i.name)??""}}).filter(i=>i._id):[],n=w.value||A.value;let o=l;n&&(o=l.filter(i=>i._id===n||T.value&&i.name===T.value),!o.length&&n&&(o=[{_id:n,name:T.value||((t=l.find(i=>i._id===n))==null?void 0:t.name)||""}])),k.value=o.length?o:l,k.value.length?k.value.some(i=>i._id===w.value)||(w.value=k.value[0]._id):!w.value&&n&&(w.value=n);const c=w.value||A.value||(k.value.length?k.value[0]._id:"");await Ye(c)}catch(e){console.error(e)}}const Ve=()=>{var a,l;if(!Je.value||typeof window>"u")return"";const t=(a=window.sessionStorage)==null?void 0:a.getItem("employeeId");if(t&&t!=="undefined")return t;const e=(l=window.localStorage)==null?void 0:l.getItem("employeeId");return e&&e!=="undefined"?e:""};async function kt(){if(ue.role!=="supervisor"){A.value="",T.value="",S.value="",ie.value="",Q.value=[],de.value=null;return}const t=Ve();if(!t){A.value="",T.value="",S.value="",ie.value="",Q.value=[],de.value=null;return}let e=null;try{const r=await U(`/api/employees/${t}`);if(!r.ok)throw new Error("Failed to fetch supervisor context");e=await r.json()}catch(r){console.error(r),de.value=null}de.value=e||null;const a=e==null?void 0:e.department,l=typeof a=="object"?(a==null?void 0:a._id)||(a==null?void 0:a.id)||(a==null?void 0:a.value):a,n=typeof a=="object"?(a==null?void 0:a.name)||"":(e==null?void 0:e.departmentName)||"";A.value=l?String(l):"",T.value=n?String(n):"",A.value?w.value=A.value:w.value="";const o=e==null?void 0:e.subDepartment,c=typeof o=="object"?(o==null?void 0:o._id)||(o==null?void 0:o.id)||(o==null?void 0:o.value):o,i=typeof o=="object"?(o==null?void 0:o.name)||"":(e==null?void 0:e.subDepartmentName)||"";S.value=c?String(c):"",ie.value=i?String(i):"",S.value?D.value=S.value:D.value="",await Dt(t)}async function Dt(t=""){if(ue.role!=="supervisor"){Q.value=[];return}const e=t||Ve();if(!e){Q.value=S.value?[String(S.value)]:[];return}try{const a=await U(`/api/employees?supervisor=${e}`);if(!a.ok)throw new Error("Failed to fetch direct reports");const l=await a.json(),n=Array.isArray(l)?l:[],o=new Set,c=[],i=r=>{if(!r&&r!==0)return;const d=String(r);d&&(o.has(d)||(o.add(d),c.push(d)))};n.forEach(r=>{const d=r==null?void 0:r.subDepartment;i(d&&typeof d=="object"?(d==null?void 0:d._id)||(d==null?void 0:d.id)||(d==null?void 0:d.value):d)}),i(S.value),Q.value=c}catch(a){console.error(a),Q.value=S.value?[String(S.value)]:[]}}async function me(){const t=Ve(),e=[`month=${I.value}`];t&&e.push(`supervisor=${t}`),re.value&&ve.value&&e.push("includeSelf=true");const a=`?${e.join("&")}`;try{const l=await U(`/api/schedules/monthly${a}`);if(!l.ok)throw new Error("Failed to fetch schedules");const n=await l.json(),o=Array.isArray(n)?n:[],c=Y.value;p.value={},!$.value.length&&o.length&&await fe(w.value,D.value),$.value.forEach(r=>{const d=String(r._id);p.value[d]={},c.forEach(h=>{p.value[d][h.date]={shiftId:"",department:r.departmentId,subDepartment:r.subDepartmentId}})}),o.forEach(r=>{var s;const d=((s=r.employee)==null?void 0:s._id)||r.employee;if(!d)return;const h=String(d);p.value[h]||(p.value[h]={},c.forEach(u=>{p.value[h][u.date]={shiftId:"",department:"",subDepartment:""}}));const M=F(r.date).date(),R=$.value.find(u=>String(u._id)===h)||{};p.value[h][M]={id:r._id,shiftId:r.shiftId,department:r.department||R.departmentId,subDepartment:r.subDepartment||R.subDepartmentId}});const i=await U(`/api/schedules/leave-approvals${a}`);if(i.ok){const r=await i.json(),d=Array.isArray(r==null?void 0:r.approvals)?r.approvals:[],h=Array.isArray(r==null?void 0:r.leaves)?r.leaves:[];oe.value=d;const M=F(`${I.value}-01`).startOf("day"),R=M.endOf("month").startOf("day");h.forEach(s=>{var ee,he,ye;if(s.status!=="approved")return;const u=((ee=s.employee)==null?void 0:ee._id)||s.employee;if(!u)return;const V=String(u),H=F(s.startDate).startOf("day"),q=F(s.endDate).startOf("day");if(!H.isValid()||!q.isValid())return;let G=H.isBefore(M)?M:H;const se=q.isAfter(R)?R:q;for(;!G.isAfter(se);){const Ae=G.date(),_e=(ye=(he=p.value)==null?void 0:he[V])==null?void 0:ye[Ae];_e&&(_e.leave={type:s.leaveType,startDate:s.startDate,endDate:s.endDate,excludesHours:!0}),G=G.add(1,"day")}})}Ie()}catch(l){console.error(l),B.error("取得排班資料失敗")}}function He(t){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:p.value,employees:$.value,days:Y.value,shifts:P.value})),_t.push({name:t==="week"?"PreviewWeek":"PreviewMonth"})}async function qe(t){try{const e=await U(`/api/schedules/export?month=${I.value}&format=${t}`);if(!e.ok)throw new Error;const a=await e.blob(),l=URL.createObjectURL(a),n=document.createElement("a");n.href=l,n.download=`schedules-${I.value}.${t==="excel"?"xlsx":"pdf"}`,n.click(),URL.revokeObjectURL(l)}catch{B.error("匯出失敗")}}async function Ct(t,e,a){const l=`${I.value}-${String(e).padStart(2,"0")}`,n=p.value[t][e];if(n!=null&&n.leave){Ne("該日已核准請假，無法調整排班");return}const o=(n==null?void 0:n.shiftId)??"";if(n&&n.id)try{const c=await U(`/api/schedules/${n.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:a,department:n.department,subDepartment:n.subDepartment})});c.ok||await Ee(c,"更新排班失敗",t,e,o)}catch{await Ee(null,"更新排班失敗",t,e,o)}else try{const c=await U("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:t,date:l,shiftId:a,department:n.department,subDepartment:n.subDepartment})});if(c.ok){const i=await c.json();p.value[t][e]={id:i._id,shiftId:i.shiftId,department:n.department,subDepartment:n.subDepartment}}else await Ee(c,"新增排班失敗",t,e,o)}catch{await Ee(null,"新增排班失敗",t,e,o)}}async function It(){D.value="",await Ye(w.value),await fe(w.value,""),await me()}async function Vt(){await fe(w.value,D.value),await me()}async function Ee(t,e,a,l,n){p.value[a]||(p.value[a]={});const o=p.value[a][l]||{shiftId:"",department:"",subDepartment:""};o.shiftId=n,p.value[a][l]=o;let c="";try{if(t){const i=await t.json();c=(i==null?void 0:i.error)||""}}catch{}c==="employee conflict"?ge.alert("人員衝突"):c==="department overlap"?ge.alert("跨區重複"):c==="leave conflict"?ge.alert("請假衝突"):B.error(e)}async function Ge(t,e="批次套用失敗"){let a="";try{if(t){const l=await t.json();a=(l==null?void 0:l.error)||""}}catch{}a==="employee conflict"?B.warning("部分員工既有排班已更新，請重新整理檢查"):a==="department overlap"?ge.alert("部門或單位與既有資料不一致，無法套用"):a==="leave conflict"?ge.alert("選取日期包含已核准請假，無法套用"):a?B.error(a):B.error(e)}async function Et(){if(!Me.value){Ke("請先選取要套用的儲存格");return}if(!ce.value){Ke("請選擇欲套用的班別");return}const t=[];if(Ue.value.forEach(l=>{var d;const{empId:n,day:o}=xe(l),c=(d=p.value[n])==null?void 0:d[o];if(!c||c.leave)return;const i=Z.value||c.department||"";let r=c.subDepartment||"";Z.value?r=K.value||"":K.value&&(r=K.value),t.push({employee:n,day:o,date:`${I.value}-${String(o).padStart(2,"0")}`,shiftId:ce.value,department:i,subDepartment:r})}),!t.length){Ne("選取的儲存格皆無需更新");return}const e=new Map;t.forEach(l=>{e.set(ae(l.employee,l.day),l)}),De.value=!0;const a=Lt.service({fullscreen:!0,lock:!0,text:"批次套用中..."});try{let l;try{l=await U("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:t.map(({day:o,...c})=>c)})})}catch{await Ge(null);return}if(!l.ok){await Ge(l);return}const n=await l.json();if(!Array.isArray(n)||!n.length){Ne("沒有可更新的資料");return}n.forEach(o=>{var M;const c=((M=o.employee)==null?void 0:M._id)||o.employee,i=F(o.date).date();p.value[c]||(p.value[c]={});const r=ae(c,i),d=e.get(r)||{},h=p.value[c][i]||{};p.value[c][i]={...h,id:o._id||d.id||h.id,shiftId:o.shiftId||d.shiftId||h.shiftId,department:d.department??o.department??h.department??"",subDepartment:d.subDepartment??o.subDepartment??h.subDepartment??""},delete p.value[c][i].leave}),bt("批次套用完成")}finally{a==null||a.close(),De.value=!1}}function le(t){return P.value.find(e=>e._id===t)}function $e(t){if(!t)return"";const e=t.code??"",a=t.name??"";return!e&&!a?"":a?`${e}(${a})`:e}function Qe(t){const e=t&&typeof t=="object"?t:le(t);if(!e)return"";const a=`${e.code??""}${e.name??""}`;return/早/.test(a)?"shift-morning":/晚|夜/.test(a)?"shift-evening":"shift-normal"}function Xe(t){return W.value.filter(e=>e.department===t)}async function fe(t="",e=""){var i;const a=Ve(),l=[],n=t||w.value||A.value,o=e||D.value;a&&l.push(`supervisor=${a}`),n&&l.push(`department=${n}`),o&&l.push(`subDepartment=${o}`);const c=`/api/employees${l.length?`?${l.join("&")}`:""}`;try{const r=await U(c);if(!r.ok)throw new Error("Failed to fetch employees");const d=await r.json(),h=k.value.reduce((u,V)=>(u[V._id]=V.name,u),{}),M=W.value.reduce((u,V)=>(u[V._id]=V.name,u),{}),R=d.map(u=>{const V=(u==null?void 0:u._id)??(u==null?void 0:u.id)??"",H=(u==null?void 0:u.department)??"",q=(u==null?void 0:u.subDepartment)??"",G=V?String(V):"",se=H?String(H):"",ee=q?String(q):"";return{_id:G,name:u.name,departmentId:se,subDepartmentId:ee,department:h[se]||"",subDepartment:M[ee]||""}});let s=Pe(R);if(re.value&&ve.value){const u=a?String(a):"";u&&!s.some(V=>V._id===u)&&(s=Pe([...s,{_id:u,name:((i=de.value)==null?void 0:i.name)||"主管本人",departmentId:A.value||"",subDepartmentId:S.value||"",department:T.value||"",subDepartment:ie.value||""}]))}$.value=s,Ie()}catch(r){console.error(r),B.error("取得員工資料失敗")}}async function ze(){try{const t=[`month=${I.value}`];re.value&&ve.value&&t.push("includeSelf=true");const e=await U(`/api/schedules/summary?${t.join("&")}`);if(e.ok){const a=await e.json();Re.value={direct:a.length,unscheduled:a.filter(l=>l.shiftCount===0).length,onLeave:a.filter(l=>l.leaveCount>0).length}}}catch(t){console.error(t)}}async function $t(){await me(),await ze()}return xt(async()=>{await ze(),await St(),await kt(),await wt(),await fe(w.value,D.value),await me()}),(t,e)=>{const a=L("el-date-picker"),l=L("el-option"),n=L("el-select"),o=L("el-switch"),c=L("el-button"),i=L("el-input"),r=L("el-table-column"),d=L("el-checkbox"),h=L("el-tag"),M=L("el-popover"),R=L("el-table");return m(),_("div",Bt,[e[38]||(e[38]=v("div",{class:"page-header"},[v("h1",{class:"page-title"},"排班管理"),v("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),f(Ft,{summary:Re.value},null,8,["summary"]),v("div",Pt,[e[20]||(e[20]=v("div",{class:"filters-header"},[v("h3",{class:"filters-title"},"篩選條件")],-1)),v("div",Wt,[v("div",Jt,[e[16]||(e[16]=v("label",{class:"filter-label"},"選擇月份",-1)),f(a,{modelValue:I.value,"onUpdate:modelValue":e[0]||(e[0]=s=>I.value=s),type:"month",onChange:$t,class:"modern-date-picker"},null,8,["modelValue"])]),v("div",Kt,[e[17]||(e[17]=v("label",{class:"filter-label"},"部門",-1)),f(n,{modelValue:w.value,"onUpdate:modelValue":e[1]||(e[1]=s=>w.value=s),placeholder:"請選擇部門",onChange:It,disabled:!0,class:"modern-select"},{default:y(()=>[(m(!0),_(x,null,O(k.value,s=>(m(),C(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),v("div",Yt,[e[18]||(e[18]=v("label",{class:"filter-label"},"單位",-1)),f(n,{modelValue:D.value,"onUpdate:modelValue":e[2]||(e[2]=s=>D.value=s),placeholder:"請選擇單位",onChange:Vt,class:"modern-select"},{default:y(()=>[(m(!0),_(x,null,O(yt.value,s=>(m(),C(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),ve.value?(m(),_("div",Ht,[e[19]||(e[19]=v("label",{class:"filter-label"},"包含自己",-1)),f(o,{modelValue:re.value,"onUpdate:modelValue":e[3]||(e[3]=s=>re.value=s),"active-text":"是","inactive-text":"否","inline-prompt":""},null,8,["modelValue"])])):N("",!0)])]),v("div",qt,[v("div",Gt,[f(c,{type:"primary",class:"action-btn primary",onClick:ut,disabled:!Me.value},{default:y(()=>e[21]||(e[21]=[v("i",{class:"el-icon-close"},null,-1),z(" 清除選取 ")])),_:1},8,["disabled"]),f(c,{type:"primary",class:"action-btn primary",plain:"",onClick:vt,disabled:!$.value.length},{default:y(()=>e[22]||(e[22]=[v("i",{class:"el-icon-user"},null,-1),z(" 全選員工 ")])),_:1},8,["disabled"]),f(c,{type:"primary",class:"action-btn primary",plain:"",onClick:pt,disabled:!Y.value.length},{default:y(()=>e[23]||(e[23]=[v("i",{class:"el-icon-date"},null,-1),z(" 全選日期 ")])),_:1},8,["disabled"])]),v("div",Qt,[v("div",Xt,[e[24]||(e[24]=v("label",{class:"range-label"},"自訂日期範圍",-1)),f(a,{modelValue:je.value,"onUpdate:modelValue":e[4]||(e[4]=s=>je.value=s),type:"daterange","start-placeholder":"開始日期","end-placeholder":"結束日期","range-separator":"至","unlink-panels":"",disabled:!Y.value.length,class:"modern-date-picker range-picker",onChange:mt},null,8,["modelValue","disabled"])]),f(c,{onClick:e[5]||(e[5]=s=>He("week")),class:"action-btn secondary"},{default:y(()=>e[25]||(e[25]=[v("i",{class:"el-icon-calendar"},null,-1),z(" 預覽週表 ")])),_:1}),f(c,{onClick:e[6]||(e[6]=s=>He("month")),class:"action-btn secondary"},{default:y(()=>e[26]||(e[26]=[v("i",{class:"el-icon-date"},null,-1),z(" 預覽月表 ")])),_:1}),f(c,{onClick:e[7]||(e[7]=()=>qe("pdf")),class:"action-btn export"},{default:y(()=>e[27]||(e[27]=[v("i",{class:"el-icon-download"},null,-1),z(" 匯出 PDF ")])),_:1}),f(c,{onClick:e[8]||(e[8]=()=>qe("excel")),class:"action-btn export"},{default:y(()=>e[28]||(e[28]=[v("i",{class:"el-icon-s-grid"},null,-1),z(" 匯出 Excel ")])),_:1})])]),v("div",Zt,[v("div",ea,[e[30]||(e[30]=v("h3",{class:"schedule-title"},"員工排班表",-1)),v("div",ta,[Fe.value.length?(m(!0),_(x,{key:0},O(Fe.value,s=>(m(),_("span",{key:s.key,class:et(["legend-item",s.className]),"data-test":"shift-legend-item"},E(s.label),3))),128)):(m(),_("span",aa," 尚未設定班別 ")),e[29]||(e[29]=v("span",{class:"legend-item leave"},"請假",-1))]),f(i,{modelValue:Se.value,"onUpdate:modelValue":e[9]||(e[9]=s=>Se.value=s),placeholder:"搜尋員工",clearable:"",class:"employee-search"},null,8,["modelValue"]),f(n,{modelValue:we.value,"onUpdate:modelValue":e[10]||(e[10]=s=>we.value=s),placeholder:"狀態",class:"status-filter"},{default:y(()=>[f(l,{label:"全部",value:"all"}),f(l,{label:"缺班",value:"unscheduled"}),f(l,{label:"待審核請假",value:"onLeave"})]),_:1},8,["modelValue"])]),ne(pe)?(m(),_("div",la,[f(n,{modelValue:ce.value,"onUpdate:modelValue":e[11]||(e[11]=s=>ce.value=s),placeholder:"套用班別",class:"modern-select batch-select",filterable:"","data-test":"batch-shift-select"},{default:y(()=>[(m(!0),_(x,null,O(P.value,s=>(m(),C(l,{key:s._id,label:$e(s),value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(n,{modelValue:Z.value,"onUpdate:modelValue":e[12]||(e[12]=s=>Z.value=s),placeholder:"套用部門",clearable:"",class:"modern-select batch-select","data-test":"batch-dept-select"},{default:y(()=>[(m(!0),_(x,null,O(k.value,s=>(m(),C(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),f(n,{modelValue:K.value,"onUpdate:modelValue":e[13]||(e[13]=s=>K.value=s),placeholder:"套用單位",clearable:"",class:"modern-select batch-select",disabled:!Z.value,"data-test":"batch-subdept-select"},{default:y(()=>[(m(!0),_(x,null,O(Be.value,s=>(m(),C(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),f(c,{type:"primary",class:"action-btn primary apply-btn",disabled:!Me.value||!ce.value||De.value,loading:De.value,onClick:Et,"data-test":"batch-apply-button"},{default:y(()=>e[31]||(e[31]=[z(" 套用至選取 ")])),_:1},8,["disabled","loading"])])):N("",!0),f(R,{class:"modern-schedule-table",data:ft.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"},onRowClick:e[15]||(e[15]=s=>We.value&&ht(s._id))},{default:y(()=>[f(r,{label:"部門／單位",width:"180",fixed:"left"},{default:y(({row:s})=>[v("div",sa,[v("div",na,E(s.department),1),s.subDepartment?(m(),_("div",oa,E(s.subDepartment),1)):N("",!0)])]),_:1}),f(r,{prop:"name",label:"員工姓名",width:"150",fixed:"left"},{default:y(({row:s})=>[v("div",ra,[ne(pe)?(m(),C(d,{key:0,class:"row-checkbox","model-value":st.value.has(s._id),onChange:u=>it(s._id,u)},null,8,["model-value","onChange"])):N("",!0),Le(s._id)==="unscheduled"?(m(),C(Oe(ne(at)),{key:1,class:"status-icon unscheduled"})):Le(s._id)==="onLeave"?(m(),C(Oe(ne(lt)),{key:2,class:"status-icon on-leave"})):N("",!0),z(" "+E(s.name),1)])]),_:1}),(m(!0),_(x,null,O(Y.value,s=>(m(),C(r,{key:s.date,label:s.label,width:"140",align:"center"},{header:y(()=>[v("div",ua,[v("span",null,E(s.label),1),ne(pe)?(m(),C(d,{key:0,class:"day-checkbox","model-value":nt.value.has(s.date),onChange:u=>dt(s.date,u)},null,8,["model-value","onChange"])):N("",!0)])]),default:y(({row:u})=>{var V,H,q,G,se,ee,he,ye,Ae,_e,Ze;return[!We.value||ke.value.has(u._id)?(m(),_("div",{key:0,class:et(["modern-schedule-cell",[(H=(V=p.value[u._id])==null?void 0:V[s.date])!=null&&H.leave?"":Qe((G=(q=p.value[u._id])==null?void 0:q[s.date])==null?void 0:G.shiftId),{"has-leave":(ee=(se=p.value[u._id])==null?void 0:se[s.date])==null?void 0:ee.leave,"missing-shift":!((ye=(he=p.value[u._id])==null?void 0:he[s.date])!=null&&ye.shiftId)&&!((_e=(Ae=p.value[u._id])==null?void 0:Ae[s.date])!=null&&_e.leave),"is-selected":rt(u._id,s.date)}]]),title:gt(u._id,s.date)},[ne(pe)?(m(),_("div",{key:0,class:"cell-selection",onClick:e[14]||(e[14]=Mt(()=>{},["stop"]))},[f(d,{"model-value":ot.value.has(ae(u._id,s.date)),disabled:!Ce(u._id,s.date),onChange:g=>ct(u._id,s.date,g),size:"small"},null,8,["model-value","disabled","onChange"])])):N("",!0),(Ze=p.value[u._id])!=null&&Ze[s.date]?(m(),_(x,{key:1},[p.value[u._id][s.date].leave?(m(),_("div",da,[f(h,{type:"warning",effect:"light",size:"small",class:"leave-tag"},{default:y(()=>e[32]||(e[32]=[z(" 休假中 ")])),_:1}),e[33]||(e[33]=v("span",{class:"leave-note"},"已核准請假，不列入工時",-1))])):ne(pe)?(m(),_(x,{key:1},[f(n,{modelValue:p.value[u._id][s.date].shiftId,"onUpdate:modelValue":g=>p.value[u._id][s.date].shiftId=g,placeholder:"選擇班別",onChange:g=>Ct(u._id,s.date,g),class:"cell-select shift-select",size:"small"},{default:y(()=>[(m(!0),_(x,null,O(P.value,g=>(m(),C(l,{key:g._id,label:$e(g),value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),v("div",ca,[f(n,{modelValue:p.value[u._id][s.date].department,"onUpdate:modelValue":g=>p.value[u._id][s.date].department=g,placeholder:"部門",size:"small",onChange:()=>p.value[u._id][s.date].subDepartment="",class:"cell-select dept-select"},{default:y(()=>[(m(!0),_(x,null,O(k.value,g=>(m(),C(l,{key:g._id,label:g.name,value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),f(n,{modelValue:p.value[u._id][s.date].subDepartment,"onUpdate:modelValue":g=>p.value[u._id][s.date].subDepartment=g,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:y(()=>[(m(!0),_(x,null,O(Xe(p.value[u._id][s.date].department),g=>(m(),C(l,{key:g._id,label:g.name,value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(m(),_(x,{key:2},[le(p.value[u._id][s.date].shiftId)?(m(),C(M,{key:0,placement:"top",trigger:"hover",width:200},{reference:y(()=>[v("div",ba,E($e(le(p.value[u._id][s.date].shiftId))),1)]),default:y(()=>[v("div",va,[v("div",pa,[e[34]||(e[34]=v("span",{class:"detail-label"},"上班時間：",-1)),v("span",ma,E(le(p.value[u._id][s.date].shiftId).startTime),1)]),v("div",fa,[e[35]||(e[35]=v("span",{class:"detail-label"},"下班時間：",-1)),v("span",ha,E(le(p.value[u._id][s.date].shiftId).endTime),1)]),le(p.value[u._id][s.date].shiftId).remark?(m(),_("div",ya,[e[36]||(e[36]=v("span",{class:"detail-label"},"備註：",-1)),v("span",_a,E(le(p.value[u._id][s.date].shiftId).remark),1)])):N("",!0)])]),_:2},1024)):N("",!0)],64)),!p.value[u._id][s.date].shiftId&&!p.value[u._id][s.date].leave?(m(),_("div",ga," 未排班 ")):N("",!0)],64)):(m(),_("span",Sa,"-"))],10,ia)):(m(),_("div",wa,"展開班表"))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])]),oe.value.length?(m(),_("div",ka,[v("div",Da,[e[37]||(e[37]=v("h3",{class:"approval-title"},"待處理審批",-1)),v("div",Ca,E(oe.value.length)+" 項待處理",1)]),f(R,{class:"modern-approval-table",data:oe.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:y(()=>[f(r,{label:"申請人",width:"120"},{default:y(({row:s})=>{var u;return[v("div",Ia,E((u=s.applicant_employee)==null?void 0:u.name),1)]}),_:1}),f(r,{label:"申請類型",width:"150"},{default:y(({row:s})=>{var u;return[v("div",Va,E(((u=s.form)==null?void 0:u.name)||"未知類型"),1)]}),_:1}),f(r,{prop:"status",label:"狀態",width:"100"},{default:y(({row:s})=>[f(h,{type:s.status==="approved"?"success":s.status==="rejected"?"danger":"warning",class:"status-tag"},{default:y(()=>[z(E(s.status),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])):N("",!0)])}}},xa=tt(Ea,[["__scopeId","data-v-6b1d1639"]]);export{xa as default};
