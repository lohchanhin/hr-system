import{A as wt,r as _,q as kt,_ as Ye,v as U,C as Dt,D as Ke,G as He,c as b,o as f,F as j,m as R,e as M,l as C,w as h,b as v,H as xe,I as Ct,t as E,J as L,k as Ce,j as It,d as m,x as z,a as Vt,h as se,E as T,u as Et,g as x,n as $t,f as At,z as pe}from"./index-BjMeatmk.js";import{a as A}from"./api-ByRlNxon.js";const jt=wt("auth",()=>{const X=_("employee");function S(){const c=kt();if(c)try{const F=JSON.parse(atob(c.split(".")[1]));X.value=F.role||"employee"}catch{X.value="employee"}else X.value="employee"}return{role:X,loadUser:S}}),Ut={class:"dashboard"},xt={class:"metric-label"},Mt={class:"metric-value"},Ot=Object.assign({name:"ScheduleDashboard"},{__name:"ScheduleDashboard",props:{summary:{type:Object,default:()=>({direct:0,unscheduled:0,onLeave:0})}},setup(X){const S=X,c=U(()=>[{label:"直屬員工數",value:S.summary.direct,icon:Dt,color:"#0f766e"},{label:"未排班員工",value:S.summary.unscheduled,icon:Ke,color:"#dc2626"},{label:"請假中員工",value:S.summary.onLeave,icon:He,color:"#f59e0b"}]);return(F,V)=>{const ne=M("el-card");return f(),b("div",Ut,[(f(!0),b(j,null,R(c.value,k=>(f(),C(ne,{class:"metric-card",key:k.label},{default:h(()=>[(f(),C(xe(k.icon),{class:"metric-icon",style:Ct({color:k.color})},null,8,["style"])),v("div",xt,E(k.label),1),v("div",Mt,E(k.value),1)]),_:2},1024))),128))])}}}),Nt=Ye(Ot,[["__scopeId","data-v-ceb5c889"]]),Lt={class:"schedule-page"},zt={class:"filters-card"},Tt={class:"filters-content"},Rt={class:"filter-group"},Ft={class:"filter-group"},Bt={class:"filter-group"},Pt={class:"actions-card"},Jt={class:"primary-actions"},Wt={class:"secondary-actions"},Yt={class:"range-picker-wrapper"},Kt={class:"schedule-card"},Ht={class:"schedule-header"},qt={key:0,class:"batch-toolbar"},Gt={class:"employee-info"},Qt={class:"department-name"},Xt={key:0,class:"sub-department"},Zt={class:"employee-name"},ea={class:"day-header"},ta=["title"],aa={key:0,class:"leave-indicator","data-test":"leave-indicator"},la={class:"department-selects"},sa={class:"shift-details"},na={class:"detail-row"},oa={class:"detail-value"},ra={class:"detail-row"},ia={class:"detail-value"},ua={key:0,class:"detail-row"},da={class:"detail-value"},ca={class:"modern-shift-tag"},va={key:3,class:"missing-label"},pa={key:2,class:"empty-cell"},fa={key:1,class:"modern-schedule-cell collapsed-cell"},ma={key:0,class:"approval-card"},ha={class:"approval-header"},ya={class:"approval-count"},_a={class:"applicant-name"},ba={class:"form-type"},ga={__name:"Schedule",setup(X){const S=_(L().format("YYYY-MM")),c=_({}),F=_([]),V=_([]),ne=_([]),k=_([]),B=_([]),D=_(""),I=_(""),$=_(""),P=_(""),w=_(""),fe=_(""),H=_([]),Me=_({direct:0,unscheduled:0,onLeave:0}),me=_(""),he=_("all"),ye=_(new Set),q=_(new Set),J=_(new Set),Z=_(new Set),Ie=_([]),oe=_(""),G=_(""),W=_(""),qe=U(()=>q.value),Ge=U(()=>J.value),Qe=U(()=>Z.value),ee=(a,e)=>`${a}-${e}`,Ve=a=>{const[e,l]=String(a).split("-");return{empId:e,day:Number(l)}},_e=(a,e)=>{const l=c.value[a];if(!l)return!1;const n=l[e];return n?!n.leave:!1},Ee=U(()=>{const a=new Set,e=Y.value,l=V.value,n=(s,r)=>{_e(s,r)&&a.add(ee(s,r))};return Z.value.forEach(s=>{const{empId:r,day:p}=Ve(s);n(r,p)}),q.value.forEach(s=>{e.forEach(r=>n(s,r.date))}),J.value.forEach(s=>{l.forEach(r=>n(r._id,s))}),a}),$e=U(()=>Ee.value.size>0),Oe=U(()=>G.value?Pe(G.value):[]),Xe=(a,e)=>Ee.value.has(ee(a,e)),be=()=>{const a=new Set(V.value.map(n=>n._id)),e=new Set(Y.value.map(n=>n.date));q.value=new Set(Array.from(q.value).filter(n=>a.has(n))),J.value=new Set(Array.from(J.value).filter(n=>e.has(n)));const l=new Set;Z.value.forEach(n=>{const{empId:s,day:r}=Ve(n);a.has(s)&&e.has(r)&&_e(s,r)&&l.add(ee(s,r))}),Z.value=l},Ze=()=>{q.value=new Set,J.value=new Set,Z.value=new Set,Ie.value=[]},et=(a,e)=>{const l=new Set(q.value);(typeof e=="boolean"?e:!l.has(a))?l.add(a):l.delete(a),q.value=l},tt=(a,e)=>{const l=new Set(J.value);(typeof e=="boolean"?e:!l.has(a))?l.add(a):l.delete(a),J.value=l},at=(a,e,l)=>{if(!_e(a,e))return;const n=ee(a,e),s=new Set(Z.value);(typeof l=="boolean"?l:!s.has(n))?s.add(n):s.delete(n),Z.value=s},lt=()=>{q.value=new Set(V.value.map(a=>a._id))},st=()=>{J.value=new Set(Y.value.map(a=>a.date))},nt=a=>{if(!Array.isArray(a)||a.length!==2)return;const[e,l]=a;if(!e||!l)return;const n=L(`${S.value}-01`),s=L(e),r=L(l);if(!s.isValid()||!r.isValid())return;const p=n.endOf("month");let o=s.isBefore(n)?n:s;const i=[];for(;(o.isBefore(r)||o.isSame(r,"day"))&&(o.year()===n.year()&&o.month()===n.month()&&i.push(o.date()),!o.isSame(p,"day"));)o=o.add(1,"day");J.value=new Set(i)};Ce(G,(a,e)=>{a!==e&&(W.value="")}),Ce(Oe,a=>{W.value&&!a.some(e=>e._id===W.value)&&(W.value="")});const Ae=a=>{const e=c.value[a]||{},l=Object.values(e),n=l.some(r=>r.shiftId),s=l.some(r=>r.leave);return n?s?"onLeave":"scheduled":"unscheduled"},ot=U(()=>{let a=me.value?V.value.filter(e=>e.name.includes(me.value)):V.value;return he.value!=="all"&&(a=a.filter(e=>Ae(e._id)===he.value)),a}),Ne=U(()=>V.value.length>50),rt=a=>{ye.value.has(a)?ye.value.delete(a):ye.value.add(a)},it=U(()=>B.value.filter(a=>a.department===D.value)),ut=Et(),re=jt();re.loadUser();const Le=U(()=>["supervisor","admin"].includes(re.role)),ie=Le,ze=a=>{var n,s;const e=(n=T)==null?void 0:n.warning;typeof e=="function"&&e(a);const l=typeof window<"u"?(s=window.ElMessage)==null?void 0:s.warning:void 0;typeof l=="function"&&l!==e&&l(a)},je=a=>{var n,s;const e=(n=T)==null?void 0:n.info;typeof e=="function"&&e(a);const l=typeof window<"u"?(s=window.ElMessage)==null?void 0:s.info:void 0;typeof l=="function"&&l!==e&&l(a)},dt=a=>{var n,s;const e=(n=T)==null?void 0:n.success;typeof e=="function"&&e(a);const l=typeof window<"u"?(s=window.ElMessage)==null?void 0:s.success:void 0;typeof l=="function"&&l!==e&&l(a)},ct=(a,e)=>{var n,s;const l=(s=(n=c.value)==null?void 0:n[a])==null?void 0:s[e];return l!=null&&l.leave?"已核准請假，該日不列入工作時數":""},Y=U(()=>{const a=L(S.value+"-01"),e=a.endOf("month").date(),l=["日","一","二","三","四","五","六"];return Array.from({length:e},(n,s)=>{const r=s+1,p=l[a.date(r).day()];return{date:r,label:`${r}(${p})`}})});Ce(V,be),Ce(Y,be);async function vt(){const a=await A("/api/shifts");if(a.ok){const e=await a.json(),l=Array.isArray(e==null?void 0:e.shifts)?e.shifts:Array.isArray(e)?e:[];Array.isArray(l)&&(F.value=l.map(n=>({_id:n._id,code:n.code,name:n.name??"",startTime:n.startTime,endTime:n.endTime,remark:n.remark})))}else a.status===403?alert("缺少權限，請重新登入或聯絡管理員"):console.error("取得班表設定失敗",a.status)}async function Te(a=""){try{const e=a||$.value,l=e?`/api/sub-departments?department=${e}`:"/api/sub-departments",n=await A(l);if(!n.ok)throw new Error("Failed to fetch sub departments");const s=await n.json(),r=k.value.reduce((i,u)=>{const y=String(u._id);return i[y]=y,u.name&&(i[u.name]=y),i},{});$.value&&(r[$.value]=$.value),P.value&&(r[P.value]=$.value||P.value);const p=Array.isArray(s)?s.map(i=>{const u=i==null?void 0:i.department;let y="";return u&&typeof u=="object"?y=(u==null?void 0:u._id)||(u==null?void 0:u.id)||r[u==null?void 0:u.name]||"":y=r[u]||u||"",{...i,_id:String((i==null?void 0:i._id)??(i==null?void 0:i.id)??""),department:String(y)}}).filter(i=>i._id):[];let o=p;if(e&&(o=p.filter(i=>i.department===String(e)),!o.length&&w.value)){const i=p.find(u=>u._id===w.value);i?o=[i]:o=[{_id:w.value,name:fe.value||"",department:String(e)}]}if(re.role==="supervisor"){const i=H.value.length?H.value:w.value?[w.value]:[],u=new Set(i.map(y=>String(y)));u.size?o=o.filter(y=>u.has(String(y._id))):o=[]}B.value=o,B.value.length?w.value&&B.value.some(i=>i._id===w.value)?I.value=w.value:I.value&&B.value.some(i=>i._id===I.value)||(I.value=B.value[0]._id):I.value=""}catch(e){console.error(e),B.value=[],I.value=""}}async function pt(){var a;try{const e=await A("/api/departments"),l=e.ok?await e.json():[],n=Array.isArray(l)?l.map(o=>{const i=(o==null?void 0:o._id)??(o==null?void 0:o.id)??(o==null?void 0:o.value)??"";return{...o,_id:String(i),name:(o==null?void 0:o.name)??""}}).filter(o=>o._id):[],s=D.value||$.value;let r=n;s&&(r=n.filter(o=>o._id===s||P.value&&o.name===P.value),!r.length&&s&&(r=[{_id:s,name:P.value||((a=n.find(o=>o._id===s))==null?void 0:a.name)||""}])),k.value=r.length?r:n,k.value.length?k.value.some(o=>o._id===D.value)||(D.value=k.value[0]._id):!D.value&&s&&(D.value=s);const p=D.value||$.value||(k.value.length?k.value[0]._id:"");await Te(p)}catch(e){console.error(e)}}const ge=()=>{var l,n;if(!Le.value||typeof window>"u")return"";const a=(l=window.sessionStorage)==null?void 0:l.getItem("employeeId");if(a&&a!=="undefined")return a;const e=(n=window.localStorage)==null?void 0:n.getItem("employeeId");return e&&e!=="undefined"?e:""};async function ft(){if(re.role!=="supervisor"){$.value="",P.value="",w.value="",fe.value="",H.value=[];return}const a=ge();if(!a){$.value="",P.value="",w.value="",fe.value="",H.value=[];return}let e=null;try{const i=await A(`/api/employees/${a}`);if(!i.ok)throw new Error("Failed to fetch supervisor context");e=await i.json()}catch(i){console.error(i)}const l=e==null?void 0:e.department,n=typeof l=="object"?(l==null?void 0:l._id)||(l==null?void 0:l.id)||(l==null?void 0:l.value):l,s=typeof l=="object"?(l==null?void 0:l.name)||"":(e==null?void 0:e.departmentName)||"";$.value=n?String(n):"",P.value=s?String(s):"",$.value?D.value=$.value:D.value="";const r=e==null?void 0:e.subDepartment,p=typeof r=="object"?(r==null?void 0:r._id)||(r==null?void 0:r.id)||(r==null?void 0:r.value):r,o=typeof r=="object"?(r==null?void 0:r.name)||"":(e==null?void 0:e.subDepartmentName)||"";w.value=p?String(p):"",fe.value=o?String(o):"",w.value?I.value=w.value:I.value="",await mt(a)}async function mt(a=""){if(re.role!=="supervisor"){H.value=[];return}const e=a||ge();if(!e){H.value=w.value?[String(w.value)]:[];return}try{const l=await A(`/api/employees?supervisor=${e}`);if(!l.ok)throw new Error("Failed to fetch direct reports");const n=await l.json(),s=Array.isArray(n)?n:[],r=new Set,p=[],o=i=>{if(!i&&i!==0)return;const u=String(i);u&&(r.has(u)||(r.add(u),p.push(u)))};s.forEach(i=>{const u=i==null?void 0:i.subDepartment;o(u&&typeof u=="object"?(u==null?void 0:u._id)||(u==null?void 0:u.id)||(u==null?void 0:u.value):u)}),o(w.value),H.value=p}catch(l){console.error(l),H.value=w.value?[String(w.value)]:[]}}async function Se(){const a=ge(),e=a?`&supervisor=${a}`:"";try{const l=await A(`/api/schedules/monthly?month=${S.value}${e}`);if(!l.ok)throw new Error("Failed to fetch schedules");const n=await l.json(),s=Array.isArray(n)?n:[],r=Y.value;c.value={},!V.value.length&&s.length&&await ke(D.value,I.value),V.value.forEach(o=>{const i=String(o._id);c.value[i]={},r.forEach(u=>{c.value[i][u.date]={shiftId:"",department:o.departmentId,subDepartment:o.subDepartmentId}})}),s.forEach(o=>{var t;const i=((t=o.employee)==null?void 0:t._id)||o.employee;if(!i)return;const u=String(i);c.value[u]||(c.value[u]={},r.forEach(d=>{c.value[u][d.date]={shiftId:"",department:"",subDepartment:""}}));const y=L(o.date).date(),O=V.value.find(d=>String(d._id)===u)||{};c.value[u][y]={id:o._id,shiftId:o.shiftId,department:o.department||O.departmentId,subDepartment:o.subDepartment||O.subDepartmentId}});const p=await A(`/api/schedules/leave-approvals?month=${S.value}${e}`);if(p.ok){const o=await p.json(),i=Array.isArray(o==null?void 0:o.approvals)?o.approvals:[],u=Array.isArray(o==null?void 0:o.leaves)?o.leaves:[];ne.value=i;const y=L(`${S.value}-01`).startOf("day"),O=y.endOf("month").startOf("day");u.forEach(t=>{var ue,de,ce;if(t.status!=="approved")return;const d=((ue=t.employee)==null?void 0:ue._id)||t.employee;if(!d)return;const ae=String(d),K=L(t.startDate).startOf("day"),Q=L(t.endDate).startOf("day");if(!K.isValid()||!Q.isValid())return;let N=K.isBefore(y)?y:K;const le=Q.isAfter(O)?O:Q;for(;!N.isAfter(le);){const De=N.date(),ve=(ce=(de=c.value)==null?void 0:de[ae])==null?void 0:ce[De];ve&&(ve.leave={type:t.leaveType,startDate:t.startDate,endDate:t.endDate,excludesHours:!0}),N=N.add(1,"day")}})}be()}catch(l){console.error(l),T.error("取得排班資料失敗")}}function Re(a){sessionStorage.setItem("schedulePreview",JSON.stringify({scheduleMap:c.value,employees:V.value,days:Y.value,shifts:F.value})),ut.push({name:a==="week"?"PreviewWeek":"PreviewMonth"})}async function Fe(a){try{const e=await A(`/api/schedules/export?month=${S.value}&format=${a}`);if(!e.ok)throw new Error;const l=await e.blob(),n=URL.createObjectURL(l),s=document.createElement("a");s.href=n,s.download=`schedules-${S.value}.${a==="excel"?"xlsx":"pdf"}`,s.click(),URL.revokeObjectURL(n)}catch{T.error("匯出失敗")}}async function ht(a,e,l){const n=`${S.value}-${String(e).padStart(2,"0")}`,s=c.value[a][e];if(s!=null&&s.leave){je("該日已核准請假，無法調整排班");return}const r=(s==null?void 0:s.shiftId)??"";if(s&&s.id)try{const p=await A(`/api/schedules/${s.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({shiftId:l,department:s.department,subDepartment:s.subDepartment})});p.ok||await we(p,"更新排班失敗",a,e,r)}catch{await we(null,"更新排班失敗",a,e,r)}else try{const p=await A("/api/schedules",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({employee:a,date:n,shiftId:l,department:s.department,subDepartment:s.subDepartment})});if(p.ok){const o=await p.json();c.value[a][e]={id:o._id,shiftId:o.shiftId,department:s.department,subDepartment:s.subDepartment}}else await we(p,"新增排班失敗",a,e,r)}catch{await we(null,"新增排班失敗",a,e,r)}}async function yt(){I.value="",await Te(D.value),await ke(D.value,""),await Se()}async function _t(){await ke(D.value,I.value),await Se()}async function we(a,e,l,n,s){c.value[l]||(c.value[l]={});const r=c.value[l][n]||{shiftId:"",department:"",subDepartment:""};r.shiftId=s,c.value[l][n]=r;let p="";try{if(a){const o=await a.json();p=(o==null?void 0:o.error)||""}}catch{}p==="employee conflict"?pe.alert("人員衝突"):p==="department overlap"?pe.alert("跨區重複"):p==="leave conflict"?pe.alert("請假衝突"):T.error(e)}async function Be(a,e="批次套用失敗"){let l="";try{if(a){const n=await a.json();l=(n==null?void 0:n.error)||""}}catch{}l==="employee conflict"?T.warning("部分員工既有排班已更新，請重新整理檢查"):l==="department overlap"?pe.alert("部門或單位與既有資料不一致，無法套用"):l==="leave conflict"?pe.alert("選取日期包含已核准請假，無法套用"):l?T.error(l):T.error(e)}async function bt(){if(!$e.value){ze("請先選取要套用的儲存格");return}if(!oe.value){ze("請選擇欲套用的班別");return}const a=[];if(Ee.value.forEach(s=>{var y;const{empId:r,day:p}=Ve(s),o=(y=c.value[r])==null?void 0:y[p];if(!o||o.leave)return;const i=G.value||o.department||"";let u=o.subDepartment||"";G.value?u=W.value||"":W.value&&(u=W.value),a.push({employee:r,day:p,date:`${S.value}-${String(p).padStart(2,"0")}`,shiftId:oe.value,department:i,subDepartment:u})}),!a.length){je("選取的儲存格皆無需更新");return}const e=new Map;a.forEach(s=>{e.set(ee(s.employee,s.day),s)});let l;try{l=await A("/api/schedules/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({schedules:a.map(({day:s,...r})=>r)})})}catch{await Be(null);return}if(!l.ok){await Be(l);return}const n=await l.json();if(!Array.isArray(n)||!n.length){je("沒有可更新的資料");return}n.forEach(s=>{var y;const r=((y=s.employee)==null?void 0:y._id)||s.employee,p=L(s.date).date();c.value[r]||(c.value[r]={});const o=ee(r,p),i=e.get(o)||{},u=c.value[r][p]||{};c.value[r][p]={...u,id:s._id||i.id||u.id,shiftId:s.shiftId||i.shiftId||u.shiftId,department:i.department??s.department??u.department??"",subDepartment:i.subDepartment??s.subDepartment??u.subDepartment??""},delete c.value[r][p].leave}),dt("批次套用完成")}function te(a){return F.value.find(e=>e._id===a)}function Ue(a){if(!a)return"";const e=a.code??"",l=a.name??"";return!e&&!l?"":l?`${e}(${l})`:e}function gt(a){const e=te(a);return e?/早/.test(e.code)?"shift-morning":/晚|夜/.test(e.code)?"shift-evening":"shift-normal":""}function Pe(a){return B.value.filter(e=>e.department===a)}async function ke(a="",e=""){const l=ge(),n=[],s=a||D.value||$.value,r=e||I.value;l&&n.push(`supervisor=${l}`),s&&n.push(`department=${s}`),r&&n.push(`subDepartment=${r}`);const p=`/api/employees${n.length?`?${n.join("&")}`:""}`;try{const o=await A(p);if(!o.ok)throw new Error("Failed to fetch employees");const i=await o.json(),u=k.value.reduce((t,d)=>(t[d._id]=d.name,t),{}),y=B.value.reduce((t,d)=>(t[d._id]=d.name,t),{}),O=i.map(t=>{const d=(t==null?void 0:t._id)??(t==null?void 0:t.id)??"",ae=(t==null?void 0:t.department)??"",K=(t==null?void 0:t.subDepartment)??"",Q=d?String(d):"",N=ae?String(ae):"",le=K?String(K):"";return{_id:Q,name:t.name,departmentId:N,subDepartmentId:le,department:u[N]||"",subDepartment:y[le]||""}}).sort((t,d)=>t.department.localeCompare(d.department));V.value=O,be()}catch(o){console.error(o),T.error("取得員工資料失敗")}}async function Je(){try{const a=await A(`/api/schedules/summary?month=${S.value}`);if(a.ok){const e=await a.json();Me.value={direct:e.length,unscheduled:e.filter(l=>l.shiftCount===0).length,onLeave:e.filter(l=>l.leaveCount>0).length}}}catch(a){console.error(a)}}async function St(){await Se(),await Je()}return It(async()=>{await Je(),await vt(),await ft(),await pt(),await ke(D.value,I.value),await Se()}),(a,e)=>{const l=M("el-date-picker"),n=M("el-option"),s=M("el-select"),r=M("el-button"),p=M("el-input"),o=M("el-table-column"),i=M("el-checkbox"),u=M("el-tag"),y=M("el-popover"),O=M("el-table");return f(),b("div",Lt,[e[35]||(e[35]=v("div",{class:"page-header"},[v("h1",{class:"page-title"},"排班管理"),v("p",{class:"page-subtitle"},"管理員工排班與班表預覽")],-1)),m(Nt,{summary:Me.value},null,8,["summary"]),v("div",zt,[e[18]||(e[18]=v("div",{class:"filters-header"},[v("h3",{class:"filters-title"},"篩選條件")],-1)),v("div",Tt,[v("div",Rt,[e[15]||(e[15]=v("label",{class:"filter-label"},"選擇月份",-1)),m(l,{modelValue:S.value,"onUpdate:modelValue":e[0]||(e[0]=t=>S.value=t),type:"month",onChange:St,class:"modern-date-picker"},null,8,["modelValue"])]),v("div",Ft,[e[16]||(e[16]=v("label",{class:"filter-label"},"部門",-1)),m(s,{modelValue:D.value,"onUpdate:modelValue":e[1]||(e[1]=t=>D.value=t),placeholder:"請選擇部門",onChange:yt,disabled:!0,class:"modern-select"},{default:h(()=>[(f(!0),b(j,null,R(k.value,t=>(f(),C(n,{key:t._id,label:t.name,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),v("div",Bt,[e[17]||(e[17]=v("label",{class:"filter-label"},"單位",-1)),m(s,{modelValue:I.value,"onUpdate:modelValue":e[2]||(e[2]=t=>I.value=t),placeholder:"請選擇單位",onChange:_t,class:"modern-select"},{default:h(()=>[(f(!0),b(j,null,R(it.value,t=>(f(),C(n,{key:t._id,label:t.name,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])])]),v("div",Pt,[v("div",Jt,[m(r,{type:"primary",class:"action-btn primary",onClick:Ze,disabled:!$e.value},{default:h(()=>e[19]||(e[19]=[v("i",{class:"el-icon-close"},null,-1),x(" 清除選取 ")])),_:1},8,["disabled"]),m(r,{type:"primary",class:"action-btn primary",plain:"",onClick:lt,disabled:!V.value.length},{default:h(()=>e[20]||(e[20]=[v("i",{class:"el-icon-user"},null,-1),x(" 全選員工 ")])),_:1},8,["disabled"]),m(r,{type:"primary",class:"action-btn primary",plain:"",onClick:st,disabled:!Y.value.length},{default:h(()=>e[21]||(e[21]=[v("i",{class:"el-icon-date"},null,-1),x(" 全選日期 ")])),_:1},8,["disabled"])]),v("div",Wt,[v("div",Yt,[e[22]||(e[22]=v("label",{class:"range-label"},"自訂日期範圍",-1)),m(l,{modelValue:Ie.value,"onUpdate:modelValue":e[3]||(e[3]=t=>Ie.value=t),type:"daterange","start-placeholder":"開始日期","end-placeholder":"結束日期","range-separator":"至","unlink-panels":"",disabled:!Y.value.length,class:"modern-date-picker range-picker",onChange:nt},null,8,["modelValue","disabled"])]),m(r,{onClick:e[4]||(e[4]=t=>Re("week")),class:"action-btn secondary"},{default:h(()=>e[23]||(e[23]=[v("i",{class:"el-icon-calendar"},null,-1),x(" 預覽週表 ")])),_:1}),m(r,{onClick:e[5]||(e[5]=t=>Re("month")),class:"action-btn secondary"},{default:h(()=>e[24]||(e[24]=[v("i",{class:"el-icon-date"},null,-1),x(" 預覽月表 ")])),_:1}),m(r,{onClick:e[6]||(e[6]=()=>Fe("pdf")),class:"action-btn export"},{default:h(()=>e[25]||(e[25]=[v("i",{class:"el-icon-download"},null,-1),x(" 匯出 PDF ")])),_:1}),m(r,{onClick:e[7]||(e[7]=()=>Fe("excel")),class:"action-btn export"},{default:h(()=>e[26]||(e[26]=[v("i",{class:"el-icon-s-grid"},null,-1),x(" 匯出 Excel ")])),_:1})])]),v("div",Kt,[v("div",Ht,[e[27]||(e[27]=Vt('<h3 class="schedule-title" data-v-e9f6ea74>員工排班表</h3><div class="schedule-legend" data-v-e9f6ea74><span class="legend-item morning" data-v-e9f6ea74>早班</span><span class="legend-item evening" data-v-e9f6ea74>晚班</span><span class="legend-item normal" data-v-e9f6ea74>正常班</span><span class="legend-item leave" data-v-e9f6ea74>請假</span></div>',2)),m(p,{modelValue:me.value,"onUpdate:modelValue":e[8]||(e[8]=t=>me.value=t),placeholder:"搜尋員工",clearable:"",class:"employee-search"},null,8,["modelValue"]),m(s,{modelValue:he.value,"onUpdate:modelValue":e[9]||(e[9]=t=>he.value=t),placeholder:"狀態",class:"status-filter"},{default:h(()=>[m(n,{label:"全部",value:"all"}),m(n,{label:"缺班",value:"unscheduled"}),m(n,{label:"待審核請假",value:"onLeave"})]),_:1},8,["modelValue"])]),se(ie)?(f(),b("div",qt,[m(s,{modelValue:oe.value,"onUpdate:modelValue":e[10]||(e[10]=t=>oe.value=t),placeholder:"套用班別",class:"modern-select batch-select",filterable:"","data-test":"batch-shift-select"},{default:h(()=>[(f(!0),b(j,null,R(F.value,t=>(f(),C(n,{key:t._id,label:Ue(t),value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),m(s,{modelValue:G.value,"onUpdate:modelValue":e[11]||(e[11]=t=>G.value=t),placeholder:"套用部門",clearable:"",class:"modern-select batch-select","data-test":"batch-dept-select"},{default:h(()=>[(f(!0),b(j,null,R(k.value,t=>(f(),C(n,{key:t._id,label:t.name,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),m(s,{modelValue:W.value,"onUpdate:modelValue":e[12]||(e[12]=t=>W.value=t),placeholder:"套用單位",clearable:"",class:"modern-select batch-select",disabled:!G.value,"data-test":"batch-subdept-select"},{default:h(()=>[(f(!0),b(j,null,R(Oe.value,t=>(f(),C(n,{key:t._id,label:t.name,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),m(r,{type:"primary",class:"action-btn primary apply-btn",disabled:!$e.value||!oe.value,onClick:bt,"data-test":"batch-apply-button"},{default:h(()=>e[28]||(e[28]=[x(" 套用至選取 ")])),_:1},8,["disabled"])])):z("",!0),m(O,{class:"modern-schedule-table",data:ot.value,"header-cell-style":{backgroundColor:"#ecfeff",color:"#164e63",fontWeight:"600"},"row-style":{backgroundColor:"#ffffff"},onRowClick:e[14]||(e[14]=t=>Ne.value&&rt(t._id))},{default:h(()=>[m(o,{label:"部門／單位",width:"180",fixed:"left"},{default:h(({row:t})=>[v("div",Gt,[v("div",Qt,E(t.department),1),t.subDepartment?(f(),b("div",Xt,E(t.subDepartment),1)):z("",!0)])]),_:1}),m(o,{prop:"name",label:"員工姓名",width:"150",fixed:"left"},{default:h(({row:t})=>[v("div",Zt,[se(ie)?(f(),C(i,{key:0,class:"row-checkbox","model-value":qe.value.has(t._id),onChange:d=>et(t._id,d)},null,8,["model-value","onChange"])):z("",!0),Ae(t._id)==="unscheduled"?(f(),C(xe(se(Ke)),{key:1,class:"status-icon unscheduled"})):Ae(t._id)==="onLeave"?(f(),C(xe(se(He)),{key:2,class:"status-icon on-leave"})):z("",!0),x(" "+E(t.name),1)])]),_:1}),(f(!0),b(j,null,R(Y.value,t=>(f(),C(o,{key:t.date,label:t.label,width:"140",align:"center"},{header:h(()=>[v("div",ea,[v("span",null,E(t.label),1),se(ie)?(f(),C(i,{key:0,class:"day-checkbox","model-value":Ge.value.has(t.date),onChange:d=>tt(t.date,d)},null,8,["model-value","onChange"])):z("",!0)])]),default:h(({row:d})=>{var ae,K,Q,N,le,ue,de,ce,De,ve,We;return[!Ne.value||ye.value.has(d._id)?(f(),b("div",{key:0,class:$t(["modern-schedule-cell",[(K=(ae=c.value[d._id])==null?void 0:ae[t.date])!=null&&K.leave?"":gt((N=(Q=c.value[d._id])==null?void 0:Q[t.date])==null?void 0:N.shiftId),{"has-leave":(ue=(le=c.value[d._id])==null?void 0:le[t.date])==null?void 0:ue.leave,"missing-shift":!((ce=(de=c.value[d._id])==null?void 0:de[t.date])!=null&&ce.shiftId)&&!((ve=(De=c.value[d._id])==null?void 0:De[t.date])!=null&&ve.leave),"is-selected":Xe(d._id,t.date)}]]),title:ct(d._id,t.date)},[se(ie)?(f(),b("div",{key:0,class:"cell-selection",onClick:e[13]||(e[13]=At(()=>{},["stop"]))},[m(i,{"model-value":Qe.value.has(ee(d._id,t.date)),disabled:!_e(d._id,t.date),onChange:g=>at(d._id,t.date,g),size:"small"},null,8,["model-value","disabled","onChange"])])):z("",!0),(We=c.value[d._id])!=null&&We[t.date]?(f(),b(j,{key:1},[c.value[d._id][t.date].leave?(f(),b("div",aa,[m(u,{type:"warning",effect:"light",size:"small",class:"leave-tag"},{default:h(()=>e[29]||(e[29]=[x(" 休假中 ")])),_:1}),e[30]||(e[30]=v("span",{class:"leave-note"},"已核准請假，不列入工時",-1))])):se(ie)?(f(),b(j,{key:1},[m(s,{modelValue:c.value[d._id][t.date].shiftId,"onUpdate:modelValue":g=>c.value[d._id][t.date].shiftId=g,placeholder:"選擇班別",onChange:g=>ht(d._id,t.date,g),class:"cell-select shift-select",size:"small"},{default:h(()=>[(f(!0),b(j,null,R(F.value,g=>(f(),C(n,{key:g._id,label:Ue(g),value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),v("div",la,[m(s,{modelValue:c.value[d._id][t.date].department,"onUpdate:modelValue":g=>c.value[d._id][t.date].department=g,placeholder:"部門",size:"small",onChange:()=>c.value[d._id][t.date].subDepartment="",class:"cell-select dept-select"},{default:h(()=>[(f(!0),b(j,null,R(k.value,g=>(f(),C(n,{key:g._id,label:g.name,value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),m(s,{modelValue:c.value[d._id][t.date].subDepartment,"onUpdate:modelValue":g=>c.value[d._id][t.date].subDepartment=g,placeholder:"單位",size:"small",class:"cell-select sub-dept-select"},{default:h(()=>[(f(!0),b(j,null,R(Pe(c.value[d._id][t.date].department),g=>(f(),C(n,{key:g._id,label:g.name,value:g._id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])])],64)):(f(),b(j,{key:2},[te(c.value[d._id][t.date].shiftId)?(f(),C(y,{key:0,placement:"top",trigger:"hover",width:200},{reference:h(()=>[v("div",ca,E(Ue(te(c.value[d._id][t.date].shiftId))),1)]),default:h(()=>[v("div",sa,[v("div",na,[e[31]||(e[31]=v("span",{class:"detail-label"},"上班時間：",-1)),v("span",oa,E(te(c.value[d._id][t.date].shiftId).startTime),1)]),v("div",ra,[e[32]||(e[32]=v("span",{class:"detail-label"},"下班時間：",-1)),v("span",ia,E(te(c.value[d._id][t.date].shiftId).endTime),1)]),te(c.value[d._id][t.date].shiftId).remark?(f(),b("div",ua,[e[33]||(e[33]=v("span",{class:"detail-label"},"備註：",-1)),v("span",da,E(te(c.value[d._id][t.date].shiftId).remark),1)])):z("",!0)])]),_:2},1024)):z("",!0)],64)),!c.value[d._id][t.date].shiftId&&!c.value[d._id][t.date].leave?(f(),b("div",va," 未排班 ")):z("",!0)],64)):(f(),b("span",pa,"-"))],10,ta)):(f(),b("div",fa,"展開班表"))]}),_:2},1032,["label"]))),128))]),_:1},8,["data"])]),ne.value.length?(f(),b("div",ma,[v("div",ha,[e[34]||(e[34]=v("h3",{class:"approval-title"},"待處理審批",-1)),v("div",ya,E(ne.value.length)+" 項待處理",1)]),m(O,{class:"modern-approval-table",data:ne.value,"header-cell-style":{backgroundColor:"#f1f5f9",color:"#164e63",fontWeight:"600"}},{default:h(()=>[m(o,{label:"申請人",width:"120"},{default:h(({row:t})=>{var d;return[v("div",_a,E((d=t.applicant_employee)==null?void 0:d.name),1)]}),_:1}),m(o,{label:"申請類型",width:"150"},{default:h(({row:t})=>{var d;return[v("div",ba,E(((d=t.form)==null?void 0:d.name)||"未知類型"),1)]}),_:1}),m(o,{prop:"status",label:"狀態",width:"100"},{default:h(({row:t})=>[m(u,{type:t.status==="approved"?"success":t.status==="rejected"?"danger":"warning",class:"status-tag"},{default:h(()=>[x(E(t.status),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])):z("",!0)])}}},ka=Ye(ga,[["__scopeId","data-v-e9f6ea74"]]);export{ka as default};
