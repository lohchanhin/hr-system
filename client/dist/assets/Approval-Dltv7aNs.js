import{a as x}from"./api-6fBn2dnK.js";import{u as Ge}from"./auth-BSBzcQTF.js";import{_ as Re,r as V,x as ie,v as M,j as Ye,k as be,c as g,b as s,d as n,w as o,e as f,O as Ke,o as r,l as _,m as I,F as A,p as U,g as c,t as m,P as Qe}from"./index-BsavUnBu.js";const Xe={class:"approval-page"},Ze={class:"tab-content"},et={class:"form-section"},tt={class:"selector-row"},at={key:0,class:"form-content"},lt={class:"form-fields"},ot={key:0,class:"workflow-preview"},st={class:"workflow-steps"},nt={class:"step-number"},it={class:"step-content"},rt={class:"step-title"},dt={class:"step-approvers"},ut={class:"form-actions"},pt={key:0,class:"error-message"},ct={key:1,class:"empty-state"},mt={class:"tab-label"},_t={class:"tab-content"},ft={class:"table-section"},vt={class:"table-container"},yt={class:"form-name"},bt={class:"applicant-info"},kt={class:"progress-info"},gt={class:"progress-text"},wt={class:"time-info"},ht={class:"action-buttons"},Vt={class:"tab-content"},xt={class:"table-section"},Dt={class:"table-container"},At={class:"form-name"},Ut={class:"applicant-info"},jt={class:"tab-content"},Ct={class:"table-section"},Tt={class:"table-container"},$t={key:4},It={key:0},St={class:"mb-2"},Et={class:"mb-2"},Lt={class:"mb-2"},Nt={class:"mb-1"},zt={class:"mr-2"},Ot={__name:"Approval",setup(Ft){const N=V("inbox"),re=Ge(),S=ie(()=>["manager","admin"].includes(re.role)),q=l=>l?new Date(l).toLocaleString():"-",ke=l=>Array.isArray(l)?l.join(", "):l??"-",j=M({});function ge(l){if(l&&typeof l=="object"){const e=l._id||l.employeeId||"";return l.name||j[e]||e}return j[l]||l}const Q=V([]),p=M({formId:"",formData:{}}),H=ie(()=>{const l=Q.value.find(e=>e.name==="請假");return(l==null?void 0:l._id)||""});function we(){H.value&&(p.formId=H.value,Z(H.value))}const z=V([]),W=V([]),O=V({}),X=V(!1),F=V(""),de=V([]),ue=V([]),pe=V([]);async function he(){const l=await x("/api/employees");if(l.ok){const e=await l.json();de.value=e.map(i=>({value:i._id,label:`${i.name}${i.employeeId?" ("+i.employeeId+")":""}`})),e.forEach(i=>{j[i._id]=i.name})}}async function Ve(){const l=await x("/api/departments");if(l.ok){const e=await l.json();ue.value=e.map(i=>({value:i._id||i.code||i.name,label:i.name}))}}async function xe(){const l=await x("/api/organizations");if(l.ok){const e=await l.json();pe.value=e.map(i=>({value:i._id||i.code||i.name,label:i.name}))}}async function De(){const l=await x("/api/approvals/forms");l.ok&&(Q.value=await l.json())}async function Ae(l){if(!(Array.isArray(l)?l:[l]).filter(u=>!j[u]).length)return;const d=await x("/api/employees");d.ok&&(await d.json()).forEach(v=>{j[v._id]=v.name})}async function Z(){if(z.value=[],p.formData={},O.value={},W.value=[],!p.formId)return;const l=await x(`/api/approvals/forms/${p.formId}/fields`);if(l.ok){const i=await l.json();z.value=(i||[]).sort((d,u)=>(d.order||0)-(u.order||0)),z.value.forEach(d=>{d.type_1==="checkbox"?p.formData[d._id]=[]:p.formData[d._id]=""})}const e=await x(`/api/approvals/forms/${p.formId}/workflow`);if(e.ok){const i=await e.json();W.value=await Promise.all((i.steps||[]).map(async(d,u)=>{let v="";if(d.approver_type==="user")await Ae(d.approver_value),v=(Array.isArray(d.approver_value)?d.approver_value:[d.approver_value]).map(h=>j[h]||h).join(", ");else{const b=Array.isArray(d.approver_value)?d.approver_value.join(", "):d.approver_value;v=`${d.approver_type}${b?"："+b:""}`}return{label:d.name||`第 ${u+1} 關`,approvers:v}}))}}function Ue(){p.formId&&Z()}function ce(l){const e=l.options;return e?Array.isArray(e)?e.map(i=>typeof i=="string"?{label:i,value:i}:{label:i.label??i.value,value:i.value??i.label}):Object.entries(e).map(([i,d])=>({label:String(d),value:String(i)})):[]}async function je(){if(!p.formId){alert("請先選擇表單樣板");return}X.value=!0;try{const l={...p.formData};Object.keys(O.value).forEach(i=>{const d=O.value[i]||[];l[i]=Array.isArray(d)?d.map(u=>u.name):[]}),F.value="";const e=await x("/api/approvals",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({form_id:p.formId,form_data:l})});if(e.ok)alert("送出申請成功！"),N.value="mine",await se();else{const i=await e.json().catch(()=>({}));F.value=i.error||`HTTP ${e.status}`,alert(`送出失敗：${F.value}`)}}finally{X.value=!1}}const J=V([]);async function ee(){const l=await x("/api/approvals/inbox");if(l.ok){const e=await l.json(),i=u=>{const v=new Date(u??0).getTime();return Number.isFinite(v)?v:0},d=Array.isArray(e)?[...e].sort((u,v)=>i(v==null?void 0:v.createdAt)-i(u==null?void 0:u.createdAt)):[];J.value=d,d.forEach(u=>{var v,b;(((b=(v=u.steps)==null?void 0:v[u.current_step_index])==null?void 0:b.approvers)||[]).forEach(h=>{h.approver&&h.approver.name&&(j[h.approver._id]=h.approver.name)})})}}const k=M({visible:!1,loading:!1,decision:"approve",comment:"",target:null}),Ce=ie(()=>k.decision==="approve"?"核可":k.decision==="reject"?"否決":"退簽");function te(l,e){k.visible=!0,k.decision=e,k.comment="",k.target=l}async function Te(){if(k.target){k.loading=!0;try{const l=await x(`/api/approvals/${k.target._id}/act`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({decision:k.decision,comment:k.comment})});if(l.ok)k.visible=!1,await ee(),S.value&&await G(),alert("已送出！");else{const e=await l.json().catch(()=>({}));alert(`動作失敗：${e.error||l.status}`)}}finally{k.loading=!1}}}const ae=V([]),me=M({}),E=V([]),le=V(!1),C=V("");function oe(l){var i;const e=Array.isArray(l==null?void 0:l.my_approvals)?l.my_approvals:[];return e.length?((i=e.reduce((d,u)=>{const v=(d==null?void 0:d.time)??Number.NEGATIVE_INFINITY,b=new Date(u.decided_at||u.updatedAt||u.createdAt||0).getTime();return b>v?{time:b,record:u}:d},null))==null?void 0:i.record)||e[e.length-1]:null}async function G(){if(!S.value){E.value=[],C.value="";return}le.value=!0,C.value="";try{const l=await x("/api/approvals/history");if(l.ok){const e=await l.json(),i=Array.isArray(e)?[...e].sort((d,u)=>{const v=oe(d),b=oe(u),h=new Date((v==null?void 0:v.decided_at)||0).getTime();return new Date((b==null?void 0:b.decided_at)||0).getTime()-h}):[];E.value=i.map(d=>({...d,__latest:oe(d)}))}else l.status===401||l.status===403?(E.value=[],C.value="您沒有權限查看歷史簽核紀錄",alert(C.value)):C.value=`載入歷史簽核失敗（HTTP ${l.status}）`}catch(l){C.value=(l==null?void 0:l.message)||"載入歷史簽核失敗"}finally{le.value=!1}}async function se(){const l=await x("/api/approvals");l.ok&&(ae.value=await l.json(),await Promise.all(ae.value.map(async e=>{var i;if(!e.form||!e.form.name){const d=await x(`/api/approvals/${e._id}`);if(d.ok){const u=await d.json();me[e._id]=((i=u==null?void 0:u.form)==null?void 0:i.name)||""}}})))}const w=M({visible:!1,doc:null});async function ne(l){w.visible=!1,w.doc=null;const e=await x(`/api/approvals/${l}`);if(e.ok){const i=await e.json();w.doc=i,w.visible=!0,(Array.isArray(w.doc.steps)?w.doc.steps:[]).forEach(u=>{(Array.isArray(u.approvers)?u.approvers:[]).forEach(b=>{var h,P;(h=b.approver)!=null&&h._id&&((P=b.approver)!=null&&P.name)&&(j[b.approver._id]=b.approver.name)})})}}Ye(async()=>{re.loadUser(),await Promise.all([De(),he(),Ve(),xe()]),await Promise.all([ee(),se()]),S.value&&await G()}),be(N,async l=>{l==="inbox"?await ee():l==="mine"?await se():l==="history"&&S.value&&await G()}),be(S,async l=>{l?N.value==="history"&&await G():E.value=[]});function $e(l){return{pending:"warning",approved:"success",rejected:"danger",returned:"info"}[l]||"default"}function R(l){return{pending:"待簽核",approved:"已核可",rejected:"已否決",returned:"已退簽"}[l]||l}return(l,e)=>{const i=f("el-option"),d=f("el-select"),u=f("el-button"),v=f("el-form-item"),b=f("el-divider"),h=f("el-input"),P=f("el-input-number"),Ie=f("el-checkbox"),Se=f("el-checkbox-group"),_e=f("el-date-picker"),Ee=f("el-time-picker"),Le=f("el-upload"),fe=f("el-form"),Ne=f("el-card"),Y=f("el-tab-pane"),ze=f("el-badge"),y=f("el-table-column"),ve=f("el-avatar"),B=f("el-tag"),Oe=f("el-progress"),K=f("el-table"),Fe=f("el-alert"),Pe=f("el-empty"),Be=f("el-tabs"),Me=f("el-descriptions-item"),qe=f("el-descriptions"),He=f("el-timeline-item"),We=f("el-timeline"),ye=f("el-dialog"),Je=Ke("loading");return r(),g("div",Xe,[e[45]||(e[45]=s("div",{class:"page-header"},[s("h1",{class:"page-title"},"簽核流程管理"),s("p",{class:"page-description"},"申請表單、審核流程、狀態追蹤一站式管理")],-1)),n(Be,{modelValue:N.value,"onUpdate:modelValue":e[1]||(e[1]=t=>N.value=t),type:"card",class:"approval-tabs"},{default:o(()=>[n(Y,{name:"apply"},{label:o(()=>e[7]||(e[7]=[s("div",{class:"tab-label"},[s("i",{class:"el-icon-edit-outline"}),s("span",null,"申請表單")],-1)])),default:o(()=>[s("div",Ze,[s("div",et,[e[16]||(e[16]=s("h2",{class:"section-title"},"建立新申請",-1)),n(Ne,{class:"form-card"},{default:o(()=>[n(fe,{"label-width":"140px",model:p,class:"apply-form"},{default:o(()=>[n(v,{label:"選擇表單樣板",class:"template-selector"},{default:o(()=>[s("div",tt,[n(d,{modelValue:p.formId,"onUpdate:modelValue":e[0]||(e[0]=t=>p.formId=t),placeholder:"請選擇申請表單類型",class:"form-select",onChange:Z},{default:o(()=>[(r(!0),g(A,null,U(Q.value,t=>(r(),_(i,{key:t._id,label:`${t.name}（${t.category}）`,value:t._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),n(u,{type:"primary",disabled:!p.formId,onClick:Ue,class:"reload-btn"},{default:o(()=>e[8]||(e[8]=[s("i",{class:"el-icon-refresh"},null,-1),c(" 重新載入 ")])),_:1},8,["disabled"]),H.value?(r(),_(u,{key:0,type:"success",onClick:we,class:"quick-btn"},{default:o(()=>e[9]||(e[9]=[s("i",{class:"el-icon-time"},null,-1),c(" 快速請假 ")])),_:1})):I("",!0)])]),_:1}),z.value.length?(r(),g("div",at,[n(b,{"content-position":"left"},{default:o(()=>e[10]||(e[10]=[s("span",{class:"divider-text"},"表單內容",-1)])),_:1}),s("div",lt,[(r(!0),g(A,null,U(z.value,t=>(r(),_(v,{key:t._id,label:t.label,required:!!t.required,class:"form-field"},{default:o(()=>[t.type_1==="text"?(r(),_(h,{key:0,modelValue:p.formData[t._id],"onUpdate:modelValue":a=>p.formData[t._id]=a,placeholder:t.placeholder||"",class:"field-input"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):t.type_1==="textarea"?(r(),_(h,{key:1,type:"textarea",rows:4,modelValue:p.formData[t._id],"onUpdate:modelValue":a=>p.formData[t._id]=a,placeholder:t.placeholder||"",class:"field-textarea"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):t.type_1==="number"?(r(),_(P,{key:2,modelValue:p.formData[t._id],"onUpdate:modelValue":a=>p.formData[t._id]=a,min:0,step:1},null,8,["modelValue","onUpdate:modelValue"])):t.type_1==="select"?(r(),_(d,{key:3,modelValue:p.formData[t._id],"onUpdate:modelValue":a=>p.formData[t._id]=a,filterable:"",placeholder:t.placeholder||"請選擇",style:{width:"320px"}},{default:o(()=>[(r(!0),g(A,null,U(ce(t),a=>(r(),_(i,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder"])):t.type_1==="checkbox"?(r(),_(Se,{key:4,modelValue:p.formData[t._id],"onUpdate:modelValue":a=>p.formData[t._id]=a},{default:o(()=>[(r(!0),g(A,null,U(ce(t),a=>(r(),_(Ie,{key:a.value,label:a.value},{default:o(()=>[c(m(a.label),1)]),_:2},1032,["label"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.type_1==="date"?(r(),_(_e,{key:5,modelValue:p.formData[t._id],"onUpdate:modelValue":a=>p.formData[t._id]=a,type:"date",style:{width:"220px"}},null,8,["modelValue","onUpdate:modelValue"])):t.type_1==="time"?(r(),_(Ee,{key:6,modelValue:p.formData[t._id],"onUpdate:modelValue":a=>p.formData[t._id]=a,style:{width:"220px"}},null,8,["modelValue","onUpdate:modelValue"])):t.type_1==="datetime"?(r(),_(_e,{key:7,modelValue:p.formData[t._id],"onUpdate:modelValue":a=>p.formData[t._id]=a,type:"datetime",style:{width:"260px"}},null,8,["modelValue","onUpdate:modelValue"])):t.type_1==="file"?(r(),_(Le,{key:8,"auto-upload":!1,"file-list":O.value[t._id],"onUpdate:fileList":a=>O.value[t._id]=a,"list-type":"text"},{default:o(()=>[n(u,null,{default:o(()=>e[11]||(e[11]=[c("選擇檔案")])),_:1})]),_:2},1032,["file-list","onUpdate:fileList"])):t.type_1==="user"?(r(),_(d,{key:9,modelValue:p.formData[t._id],"onUpdate:modelValue":a=>p.formData[t._id]=a,filterable:"",style:{width:"320px"},placeholder:"選擇員工"},{default:o(()=>[(r(!0),g(A,null,U(de.value,a=>(r(),_(i,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.type_1==="department"?(r(),_(d,{key:10,modelValue:p.formData[t._id],"onUpdate:modelValue":a=>p.formData[t._id]=a,filterable:"",style:{width:"320px"},placeholder:"選擇部門"},{default:o(()=>[(r(!0),g(A,null,U(ue.value,a=>(r(),_(i,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):t.type_1==="org"?(r(),_(d,{key:11,modelValue:p.formData[t._id],"onUpdate:modelValue":a=>p.formData[t._id]=a,filterable:"",style:{width:"320px"},placeholder:"選擇機構"},{default:o(()=>[(r(!0),g(A,null,U(pe.value,a=>(r(),_(i,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):(r(),_(h,{key:12,modelValue:p.formData[t._id],"onUpdate:modelValue":a=>p.formData[t._id]=a,placeholder:t.placeholder||""},null,8,["modelValue","onUpdate:modelValue","placeholder"]))]),_:2},1032,["label","required"]))),128))]),W.value.length?(r(),g("div",ot,[n(b,{"content-position":"left"},{default:o(()=>e[12]||(e[12]=[s("span",{class:"divider-text"},"簽核流程預覽",-1)])),_:1}),s("div",st,[(r(!0),g(A,null,U(W.value,(t,a)=>(r(),g("div",{key:a,class:"workflow-step"},[s("div",nt,m(a+1),1),s("div",it,[s("h4",rt,m(t.label),1),s("p",dt,m(t.approvers),1)])]))),128))])])):I("",!0),s("div",ut,[n(u,{type:"primary",size:"large",loading:X.value,onClick:je,class:"submit-btn"},{default:o(()=>e[13]||(e[13]=[s("i",{class:"el-icon-check"},null,-1),c(" 送出申請 ")])),_:1},8,["loading"]),F.value?(r(),g("div",pt,[e[14]||(e[14]=s("i",{class:"el-icon-warning"},null,-1)),c(" "+m(F.value),1)])):I("",!0)])])):(r(),g("div",ct,e[15]||(e[15]=[s("i",{class:"el-icon-document"},null,-1),s("p",null,"請先選擇一個表單樣板開始申請",-1)])))]),_:1},8,["model"])]),_:1})])])]),_:1}),n(Y,{name:"inbox"},{label:o(()=>[s("div",mt,[e[17]||(e[17]=s("i",{class:"el-icon-message"},null,-1)),e[18]||(e[18]=s("span",null,"待我簽核",-1)),J.value.length?(r(),_(ze,{key:0,value:J.value.length,class:"tab-badge"},null,8,["value"])):I("",!0)])]),default:o(()=>[s("div",_t,[s("div",ft,[e[25]||(e[25]=s("h2",{class:"section-title"},"待處理申請",-1)),s("div",vt,[n(K,{data:J.value,class:"approval-table","header-cell-style":{background:"#f8fafc",color:"#475569",fontWeight:"600"},"row-style":{height:"64px"}},{default:o(()=>[n(y,{label:"#",width:"60",type:"index"}),n(y,{label:"表單名稱",width:"220"},{default:o(({row:t})=>{var a;return[s("div",yt,[e[19]||(e[19]=s("i",{class:"el-icon-document"},null,-1)),c(" "+m(((a=t.form)==null?void 0:a.name)||"-"),1)])]}),_:1}),n(y,{prop:"applicant_employee.name",label:"申請人",width:"140"},{default:o(({row:t})=>{var a;return[s("div",bt,[n(ve,{size:32,class:"applicant-avatar"},{default:o(()=>{var D;return[c(m((((D=t.applicant_employee)==null?void 0:D.name)||"-").charAt(0)),1)]}),_:2},1024),s("span",null,m(((a=t.applicant_employee)==null?void 0:a.name)||"-"),1)])]}),_:1}),n(y,{label:"狀態",width:"120"},{default:o(({row:t})=>[n(B,{type:$e(t.status),class:"status-tag"},{default:o(()=>[c(m(R(t.status)),1)]),_:2},1032,["type"])]),_:1}),n(y,{label:"目前關卡",width:"120"},{default:o(({row:t})=>{var a,D;return[s("div",kt,[s("span",gt,m(t.current_step_index+1)+"/"+m(((a=t.steps)==null?void 0:a.length)||0),1),n(Oe,{percentage:(t.current_step_index+1)/(((D=t.steps)==null?void 0:D.length)||1)*100,"show-text":!1,"stroke-width":4,class:"progress-bar"},null,8,["percentage"])])]}),_:1}),n(y,{label:"建立時間",width:"180"},{default:o(({row:t})=>[s("div",wt,[e[20]||(e[20]=s("i",{class:"el-icon-time"},null,-1)),c(" "+m(q(t.createdAt)),1)])]),_:1}),n(y,{label:"操作",width:"320"},{default:o(({row:t})=>[s("div",ht,[n(u,{size:"small",onClick:a=>ne(t._id),class:"view-btn"},{default:o(()=>e[21]||(e[21]=[s("i",{class:"el-icon-view"},null,-1),c(" 查看 ")])),_:2},1032,["onClick"]),n(u,{type:"success",size:"small",onClick:a=>te(t,"approve"),class:"approve-btn"},{default:o(()=>e[22]||(e[22]=[s("i",{class:"el-icon-check"},null,-1),c(" 核可 ")])),_:2},1032,["onClick"]),n(u,{type:"danger",size:"small",onClick:a=>te(t,"reject"),class:"reject-btn"},{default:o(()=>e[23]||(e[23]=[s("i",{class:"el-icon-close"},null,-1),c(" 否決 ")])),_:2},1032,["onClick"]),n(u,{size:"small",onClick:a=>te(t,"return"),class:"return-btn"},{default:o(()=>e[24]||(e[24]=[s("i",{class:"el-icon-back"},null,-1),c(" 退簽 ")])),_:2},1032,["onClick"])])]),_:1})]),_:1},8,["data"])])])])]),_:1}),S.value?(r(),_(Y,{key:0,name:"history"},{label:o(()=>e[26]||(e[26]=[s("div",{class:"tab-label"},[s("i",{class:"el-icon-finished"}),s("span",null,"我已簽核")],-1)])),default:o(()=>[s("div",Vt,[s("div",xt,[e[29]||(e[29]=s("h2",{class:"section-title"},"歷史簽核紀錄",-1)),Qe((r(),g("div",Dt,[C.value?(r(),_(Fe,{key:0,type:"error",closable:!1,class:"mb-3",title:C.value},null,8,["title"])):I("",!0),E.value.length?(r(),_(K,{key:1,data:E.value,class:"approval-table","header-cell-style":{background:"#f8fafc",color:"#475569",fontWeight:"600"},"row-style":{height:"64px"}},{default:o(()=>[n(y,{type:"index",label:"#",width:"60"}),n(y,{label:"表單名稱",width:"240"},{default:o(({row:t})=>{var a;return[s("div",At,[e[27]||(e[27]=s("i",{class:"el-icon-document"},null,-1)),c(" "+m(((a=t.form)==null?void 0:a.name)||"-"),1)])]}),_:1}),n(y,{label:"申請人",width:"200"},{default:o(({row:t})=>{var a;return[s("div",Ut,[n(ve,{size:32,class:"applicant-avatar"},{default:o(()=>{var D;return[c(m((((D=t.applicant_employee)==null?void 0:D.name)||"-").charAt(0)),1)]}),_:2},1024),s("span",null,m(((a=t.applicant_employee)==null?void 0:a.name)||"-"),1)])]}),_:1}),n(y,{label:"決策結果",width:"150"},{default:o(({row:t})=>{var a;return[s("span",null,m(R((a=t.__latest)==null?void 0:a.decision)),1)]}),_:1}),n(y,{label:"簽核時間",width:"200"},{default:o(({row:t})=>{var a;return[c(m(q((a=t.__latest)==null?void 0:a.decided_at)),1)]}),_:1}),n(y,{prop:"comment",label:"備註","min-width":"220"},{default:o(({row:t})=>{var a;return[s("span",null,m(((a=t.__latest)==null?void 0:a.comment)||"-"),1)]}),_:1}),n(y,{label:"操作",width:"120"},{default:o(({row:t})=>[n(u,{size:"small",onClick:a=>ne(t._id)},{default:o(()=>e[28]||(e[28]=[c("查看")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])):(r(),_(Pe,{key:2,description:"尚未簽核過任何申請",class:"history-empty"}))])),[[Je,le.value]])])])]),_:1})):I("",!0),n(Y,{name:"mine"},{label:o(()=>e[30]||(e[30]=[s("div",{class:"tab-label"},[s("i",{class:"el-icon-user"}),s("span",null,"我的申請")],-1)])),default:o(()=>[s("div",jt,[s("div",Ct,[e[36]||(e[36]=s("h2",{class:"section-title"},"申請記錄",-1)),s("div",Tt,[n(K,{data:ae.value,class:"approval-table","header-cell-style":{background:"#f8fafc",color:"#475569",fontWeight:"600"},"row-style":{height:"64px"}},{default:o(()=>[n(y,{type:"index",label:"#",width:"60"}),n(y,{label:"表單名稱",width:"240"},{default:o(({row:t})=>{var a;return[c(m(((a=t.form)==null?void 0:a.name)||me[t._id]||"-"),1)]}),_:1}),n(y,{label:"狀態",width:"120"},{default:o(({row:t})=>[t.status==="pending"?(r(),_(B,{key:0,type:"warning"},{default:o(()=>e[31]||(e[31]=[c("處理中")])),_:1})):t.status==="approved"?(r(),_(B,{key:1,type:"success"},{default:o(()=>e[32]||(e[32]=[c("已核可")])),_:1})):t.status==="rejected"?(r(),_(B,{key:2,type:"danger"},{default:o(()=>e[33]||(e[33]=[c("已否決")])),_:1})):t.status==="returned"?(r(),_(B,{key:3},{default:o(()=>e[34]||(e[34]=[c("已退簽")])),_:1})):(r(),g("span",$t,m(t.status),1))]),_:1}),n(y,{label:"目前關卡",width:"120"},{default:o(({row:t})=>{var a;return[c(m(t.current_step_index+1)+"/"+m(((a=t.steps)==null?void 0:a.length)||0),1)]}),_:1}),n(y,{label:"建立時間",width:"180"},{default:o(({row:t})=>[c(m(q(t.createdAt)),1)]),_:1}),n(y,{label:"操作",width:"140"},{default:o(({row:t})=>[n(u,{size:"small",onClick:a=>ne(t._id)},{default:o(()=>e[35]||(e[35]=[c("查看")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])])])])]),_:1})]),_:1},8,["modelValue"]),n(ye,{modelValue:w.visible,"onUpdate:modelValue":e[3]||(e[3]=t=>w.visible=t),title:"申請單明細",width:"760px"},{footer:o(()=>[n(u,{onClick:e[2]||(e[2]=t=>w.visible=!1)},{default:o(()=>e[42]||(e[42]=[c("關閉")])),_:1})]),default:o(()=>{var t,a,D;return[w.doc?(r(),g("div",It,[s("p",St,[e[37]||(e[37]=s("b",null,"表單：",-1)),c(m((t=w.doc.form)==null?void 0:t.name)+"（"+m((a=w.doc.form)==null?void 0:a.category)+"）",1)]),s("p",Et,[e[38]||(e[38]=s("b",null,"申請人：",-1)),c(m(((D=w.doc.applicant_employee)==null?void 0:D.name)||"-"),1)]),s("p",Lt,[e[39]||(e[39]=s("b",null,"狀態：",-1)),c(m(R(w.doc.status)),1)]),n(b,{"content-position":"left"},{default:o(()=>e[40]||(e[40]=[c("填寫內容")])),_:1}),n(qe,{column:1,size:"small",border:""},{default:o(()=>{var L;return[(r(!0),g(A,null,U(((L=w.doc.form)==null?void 0:L.fields)||[],$=>(r(),_(Me,{key:$._id,label:$.label},{default:o(()=>{var T;return[s("span",null,m(ke((T=w.doc.form_data)==null?void 0:T[$._id])),1)]}),_:2},1032,["label"]))),128))]}),_:1}),n(b,{"content-position":"left"},{default:o(()=>e[41]||(e[41]=[c("流程")])),_:1}),n(We,null,{default:o(()=>[(r(!0),g(A,null,U(w.doc.steps,(L,$)=>(r(),_(He,{key:$,timestamp:`第 ${$+1} 關`,type:$===w.doc.current_step_index?"primary":"info"},{default:o(()=>[s("div",Nt,[s("span",zt,"需全員同意："+m(L.all_must_approve?"是":"否"),1),s("span",null,"必簽："+m(L.is_required?"是":"否"),1)]),n(K,{data:L.approvers,size:"small",border:""},{default:o(()=>[n(y,{label:"審核人",width:"200"},{default:o(({row:T})=>[c(m(ge(T.approver)),1)]),_:1}),n(y,{label:"決議",width:"120"},{default:o(({row:T})=>[c(m(R(T.decision)),1)]),_:1}),n(y,{label:"時間",width:"200"},{default:o(({row:T})=>[c(m(q(T.decided_at)),1)]),_:1}),n(y,{prop:"comment",label:"意見"})]),_:2},1032,["data"])]),_:2},1032,["timestamp","type"]))),128))]),_:1})])):I("",!0)]}),_:1},8,["modelValue"]),n(ye,{modelValue:k.visible,"onUpdate:modelValue":e[6]||(e[6]=t=>k.visible=t),title:Ce.value,width:"520px"},{footer:o(()=>[n(u,{onClick:e[5]||(e[5]=t=>k.visible=!1)},{default:o(()=>e[43]||(e[43]=[c("取消")])),_:1}),n(u,{type:"primary",loading:k.loading,onClick:Te},{default:o(()=>e[44]||(e[44]=[c("送出")])),_:1},8,["loading"])]),default:o(()=>[n(fe,{"label-width":"100px"},{default:o(()=>[n(v,{label:"意見／備註"},{default:o(()=>[n(h,{modelValue:k.comment,"onUpdate:modelValue":e[4]||(e[4]=t=>k.comment=t),type:"textarea",rows:3,placeholder:"（可留空）"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue","title"])])}}},qt=Re(Ot,[["__scopeId","data-v-2b470737"]]);export{qt as default};
