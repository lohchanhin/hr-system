# 考勤資料匯入格式說明

後台管理者可透過「考勤資料匯入」功能匯入多筆打卡紀錄。此功能支援 Excel (XLSX) 與 CSV 檔案，並提供欄位對應、員工映射與預覽匯入流程。

## 基本欄位

匯入檔案需至少包含下列欄位，可於匯入介面調整欄位對應：

| 欄位 | 說明 |
| ---- | ---- |
| `USERID` | 打卡資料來源的員工識別值，可對應員工編號 (`employeeId`)、Email 或資料庫 `_id`。 |
| `CHECKTIME` | 打卡時間。支援 `yyyy-MM-dd HH:mm:ss`、`yyyy/MM/dd HH:mm`、`MM/dd/yyyy HH:mm` 等常見格式，以及 Excel 日期欄位。亦接受 12 小時制（例如 `2024-01-05 06:30 PM`）與含中文 `上午`/`下午` 標記（例如 `2024/01/05 下午 06:30:00`），系統會自動換算為 24 小時制。 |
| `CHECKTYPE` | 打卡動作，系統會將 `I` 轉換為 `clockIn`、`O` 轉換為 `clockOut`。亦支援直接填寫 `clockIn` / `clockOut`，或中文的 `上班簽到` / `下班簽退`。 |
| `REMARK` (選填) | 額外備註內容，將原樣寫入資料庫。 |
| `NAME` (選填) | 員工姓名，配合 `USERID` 使用可提高員工匹配準確度。 |

## 新格式支援

系統支援新的考勤機匯出格式，包含以下欄位：

| 中文欄位名稱 | 說明 | 對應欄位 |
| ---- | ---- | ---- |
| 部門 | 部門名稱 | (選填) |
| 姓名 | 員工姓名 | `NAME` |
| 差勤號碼 | 考勤系統編號 | (選填) |
| 日期時間 | 打卡日期時間 | `CHECKTIME` |
| 簽到/退 | 打卡類型（上班簽到/下班簽退） | `CHECKTYPE` |
| 機器號 | 打卡機編號 | (選填) |
| 編號 | 員工證件編號/員工編號 | `USERID` |
| 比對方式 | 識別方式（指紋/人臉等） | (選填) |

### 新格式範例

```
部門	姓名	差勤號碼	日期時間	簽到/退	機器號	編號	比對方式
迦美	楊世任	23	2025/11/1 上午 07:54:21	上班簽到	104	D0021	指紋
迦美	楊世任	23	2025/11/1 下午 12:00:03	下班簽退	104	D0021	指紋
迦美	楊世任	23	2025/11/3 上午 07:57:34	上班簽到	104	D0021	指紋
迦美	楊世任	23	2025/11/3 下午 05:01:47	下班簽退	104	D0021	指紋
```

使用新格式時，請在匯入介面設定欄位對應：
- `USERID` 欄位 → `編號`
- `NAME` 欄位 → `姓名`
- `CHECKTIME` 欄位 → `日期時間`
- `CHECKTYPE` 欄位 → `簽到/退`

## 時區與重複打卡

- 可於匯入介面選擇時區（預設為 `Asia/Taipei`）。未帶有時區資訊的時間將依此設定換算為 UTC 儲存。
- 系統不會移除重複打卡紀錄，將依檔案內容逐筆新增。

## 員工對應機制

1. 匯入時會先依照 `USERID` 與 `NAME` 組合嘗試精確匹配員工。
2. 若組合匹配失敗，系統會嘗試單獨使用 `USERID` 比對員工編號、Email 及 `_id`。
3. 若 `USERID` 匹配失敗但有提供 `NAME`，且系統中僅有一位員工姓名符合，則會自動匹配該員工。
4. 若仍有無法對應的員工，API 會於回應的 `missingUsers` 欄位列出識別值、出現列號與樣本資料，前端可於對話框中選擇對應員工或標記忽略。
5. 完成映射後重新送出即可完成匯入，忽略的識別值將不會建立紀錄。

## API 路由

- `POST /api/attendance/import`
  - 需使用 `multipart/form-data`，欄位包含：
    - `file`：上傳之 Excel/CSV 檔案。
    - `mappings`：欄位對應設定（JSON）。
    - `options`：包含 `timezone` 與 `dryRun` 的設定（JSON）。
    - `userMappings`：重新對應使用者的設定（JSON，選填）。
    - `ignoreUsers`：欲忽略的識別值清單（JSON 陣列，選填）。
  - `dryRun: true` 時僅回傳預覽結果，不會寫入資料庫。

## 回應結構重點

- `preview`：每列的解析結果、錯誤與對應狀態。
- `missingUsers`：需人工映射或忽略的識別值清單。
- `summary`：包含總筆數、已就緒筆數、缺少對應筆數、忽略筆數、錯誤筆數與實際匯入筆數。

若需要建立匯入範例，可使用下列最小範本：

```csv
USERID,CHECKTIME,CHECKTYPE,REMARK
A001,2024-01-05 08:00:00,I,早班
A001,2024-01-05 17:30:00,O,下班
```

或使用新格式範本：

```csv
編號,姓名,日期時間,簽到/退
D0021,楊世任,2025/11/1 上午 07:54:21,上班簽到
D0021,楊世任,2025/11/1 下午 12:00:03,下班簽退
```

將此檔案與對應欄位設定上傳，即可測試整體流程。
