# 薪資計算系統設計文件

## 目錄
1. [考勤管理規則](#考勤管理規則)
2. [請假簽核流程](#請假簽核流程)
3. [薪資計算邏輯](#薪資計算邏輯)
4. [實例說明](#實例說明)

---

## 考勤管理規則

### 基本原則
- **法定工作天數**：台灣勞基法規定週休二日，一個月正常工作天數約為 22 天（假設 30 天月份扣除 8 天休假日）
- **打卡記錄**：員工需於上下班時間打卡，系統記錄 `clockIn`（上班）、`clockOut`（下班）、`breakIn`（休息開始）、`outing`（外出）等動作
- **排班制度**：依據部門排班設定，員工需依照指定班別上班

### 考勤狀態判定

#### 1. 正常出勤
- 員工在排班時間範圍內打卡上下班
- 無遲到、早退情況
- 符合班別規定的工作時數

#### 2. 遲到 (Late)
- **定義**：實際上班打卡時間晚於排班開始時間
- **寬限時間**：可設定寬限時間（如 5 分鐘），在寬限時間內不算遲到
- **計算方式**：
  - 遲到分鐘數 = 實際打卡時間 - 排班開始時間 - 寬限時間
  - 若遲到超過 30 分鐘，可能計為半日曠職
  - 若遲到超過 2 小時，可能計為全日曠職

#### 3. 早退 (Early Leave)
- **定義**：實際下班打卡時間早於排班結束時間
- **計算方式**：
  - 早退分鐘數 = 排班結束時間 - 實際打卡時間
  - 扣薪方式同遲到計算

#### 4. 曠職 (Absence)
- **定義**：
  - 排班日期無任何打卡記錄
  - 未經核准請假而缺勤
- **處理方式**：
  - 全日曠職扣除當日薪資
  - 可能影響全勤獎金或績效考核

#### 5. 加班 (Overtime)
- **定義**：超過正常工作時間的額外工作時數
- **類型**：
  - **平日加班**：工作日超過 8 小時的時數
  - **休息日加班**：週休二日的加班
  - **國定假日加班**：國定假日的加班
- **計算標準**（依勞基法第24條、第32條、第39條）：
  - 平日加班（前 2 小時）：1.34 倍
  - 平日加班（超過 2 小時）：1.67 倍
  - 休息日加班（前 2 小時）：1.34 倍
  - 休息日加班（第 3-8 小時）：1.67 倍
  - 休息日加班（超過 8 小時）：2.67 倍
  - 國定假日加班：2 倍
  - *註：加班費倍率依勞基法規定，如法規修訂需同步更新*

### 考勤數據收集

系統需收集以下數據：
1. **打卡記錄** (`AttendanceRecord`)
   - 員工 ID
   - 打卡動作 (clockIn, clockOut, breakIn, outing)
   - 時間戳記
   - 備註

2. **排班資料** (`ShiftSchedule`)
   - 員工 ID
   - 日期
   - 班別 ID
   - 班別時間（開始、結束）

3. **請假記錄** (來自 `ApprovalRequest`)
   - 請假類型
   - 請假起訖日期
   - 請假時數
   - 審核狀態

---

## 請假簽核流程

### 請假類型

常見假別及影響：

| 假別 | 代碼 | 是否扣薪 | 說明 |
|------|------|---------|------|
| 特休假 | ANNUAL | 否 | 有薪年假，依年資給假 |
| 病假 | SICK | 部分扣薪 | 半薪，年度有上限 |
| 事假 | PERSONAL | 是 | 扣除當日薪資 |
| 婚假 | MARRIAGE | 否 | 8 天有薪婚假 |
| 喪假 | BEREAVEMENT | 否 | 依親等關係給假 |
| 產假 | MATERNITY | 部分有薪 | 56 天，薪資依規定 |
| 陪產假 | PATERNITY | 否 | 7 天有薪陪產假 |

### 簽核流程

#### 申請階段
1. **員工申請**
   - 填寫請假表單，包含：
     - 請假類型
     - 起訖日期與時間
     - 請假事由
     - 代理人（如需要）
   
2. **系統檢查**
   - 檢查假別餘額是否足夠
   - 檢查是否與現有班表衝突
   - 檢查是否有其他待審批假單

#### 審核階段
3. **主管審核**
   - 直屬主管收到待辦通知
   - 審核假單合理性及人力配置
   - 可核准、退回或要求修改

4. **人資審核**（依公司規定）
   - 特定假別需人資複核
   - 確認假別使用符合規定
   - 更新員工假別餘額

#### 完成階段
5. **系統更新**
   - 更新員工請假記錄
   - 扣除對應假別額度
   - 標記該日期為請假日
   - 通知相關人員（代理人、部門同仁）

### 請假對薪資的影響

根據不同假別，計算當月薪資時需要調整：

- **有薪假**（特休、婚假、喪假、陪產假）：不扣薪
- **半薪假**（病假）：扣除 50% 當日薪資
- **無薪假**（事假）：扣除 100% 當日薪資
- **特殊假別**：依照勞基法或公司規定計算

---

## 薪資計算邏輯

### 計算公式

#### 基本架構

```
實領薪資 = 基本薪資 
         + 加班費 
         + 其他津貼（夜班津貼、績效獎金等）
         - 請假扣款
         - 遲到早退扣款
         - 法定扣繳項（勞保、健保、勞退）
         - 其他扣款（借支、債權扣押等）
```

### 詳細計算步驟

#### Step 1: 計算應出勤天數

```
應出勤天數 = 當月日曆天數 - 週休假日 - 國定假日
```

例如：2024年5月
- 日曆天數：31 天
- 週休假日：8-9 天（依排班）
- 國定假日：0 天
- **應出勤天數 = 31 - 8 = 23 天**

#### Step 2: 計算實際出勤天數

```
實際出勤天數 = 打卡正常出勤天數 + 有薪請假天數
```

考勤狀態判定：
- ✓ **正常出勤**：有完整上下班打卡且無遲到早退
- ✓ **有薪請假**：特休、婚假等核准假別
- ✗ **曠職**：未打卡且無請假
- ✗ **無薪請假**：事假等需扣薪假別

#### Step 3: 計算日薪

```
日薪 = 月薪 ÷ 當月應出勤天數
```

例如：月薪 50,000 元，5月應出勤 23 天
```
日薪 = 50,000 ÷ 23 = 2,173.91 元/天（保留小數供後續計算）
```

#### Step 4: 計算時薪（用於遲到早退及加班）

```
時薪 = 月薪 ÷ 當月應出勤天數 ÷ 每日工作時數
```

例如：月薪 50,000 元，5月應出勤 23 天，每日 8 小時
```
時薪 = 50,000 ÷ 23 ÷ 8 = 271.74 元/小時（保留小數供後續計算）
```

#### Step 5: 計算請假扣款

```
請假扣款 = Σ(各類請假天數 × 日薪 × 扣薪比例)
```

使用日薪 2,173.91 元計算：
- 事假（扣薪比例 100%）：1天 × 2,173.91 × 100% = 2,173.91 元
- 病假（扣薪比例 50%）：1天 × 2,173.91 × 50% = 1,086.96 元
- 特休（扣薪比例 0%）：1天 × 2,173.91 × 0% = 0 元

#### Step 6: 計算遲到早退扣款

```
遲到早退扣款 = Σ(遲到早退總分鐘數 ÷ 60 × 時薪)
```

例如：當月累計遲到 90 分鐘（1.5 小時），使用時薪 271.74 元
```
扣款 = 1.5 × 271.74 = 407.61 元
```

#### Step 7: 計算加班費

```
加班費 = Σ(加班時數 × 時薪 × 加班倍率)
```

例如：平日加班 4 小時（前2小時 + 後2小時），使用時薪 271.74 元
```
加班費 = (2 × 271.74 × 1.34) + (2 × 271.74 × 1.67)
       = 728.26 + 907.45
       = 1,635.71 元
```

#### Step 8: 計算法定扣繳

```
勞保費 = 依投保薪資級距計算（勞工自付 20%）
健保費 = 依投保薪資級距計算（勞工自付約 30%）
勞退提繳 = 月薪 × 6%（雇主法定義務提繳，由雇主負擔，不從員工薪資扣除）
勞退自提 = 月薪 × 自提比例（0-6%，員工自願額外提繳，從員工薪資中扣除）

註：雇主提繳 6% 是法定義務，員工自提 0-6% 是自願性質，兩者獨立計算
```

#### Step 9: 計算實領薪資

```
實領薪資 = 基本薪資
         - 請假扣款
         - 遲到早退扣款
         + 加班費
         + 其他津貼
         - 勞保費
         - 健保費
         - 勞退自提
         - 其他扣款
```

---

## 實例說明

### 案例一：一般月份正常出勤

**員工資料**
- 姓名：張小明
- 月薪：50,000 元
- 月份：2024年5月

**排班與考勤**
- 應出勤天數：22 天
- 實際出勤：22 天（完整打卡）
- 請假：0 天
- 遲到早退：0 分鐘
- 加班：0 小時

**薪資計算**
```
基本薪資：50,000 元
請假扣款：0 元
遲到早退扣款：0 元
加班費：0 元
其他津貼：0 元

法定扣繳：
- 勞保費：900 元（假設，依級距）
- 健保費：750 元（假設，依級距）
- 勞退自提：0 元

實領薪資 = 50,000 - 900 - 750 = 48,350 元
```

---

### 案例二：有請假、遲到及加班

**員工資料**
- 姓名：李小華
- 月薪：50,000 元
- 月份：2024年5月

**排班與考勤**
- 應出勤天數：22 天
- 實際出勤：19 天
- 請假：
  - 特休：2 天（有薪）
  - 事假：1 天（無薪）
- 遲到早退：累計 90 分鐘
- 加班：平日加班 6 小時

**詳細計算**

1. **日薪與時薪**
```
日薪 = 50,000 ÷ 22 = 2,272.7273 元/天
時薪 = 50,000 ÷ 22 ÷ 8 = 284.0909 元/小時
```

2. **請假扣款**
```
特休扣款 = 2 × 2,272.7273 × 0% = 0 元
事假扣款 = 1 × 2,272.7273 × 100% = 2,272.7273 元
總扣款 = 2,272.7273 元
```

3. **遲到早退扣款**
```
扣款 = 90 ÷ 60 × 284.0909 = 426.14 元
```

4. **加班費**
```
前 2 小時 = 2 × 284.0909 × 1.34 = 761.36 元
第 3-4 小時 = 2 × 284.0909 × 1.67 = 948.46 元
第 5-6 小時 = 2 × 284.0909 × 1.67 = 948.46 元
總加班費 = 2,658.28 元
```

5. **法定扣繳**
```
勞保費：900 元
健保費：750 元
```

6. **實領薪資**
```
實領薪資 = 50,000 
         - 2,272.73（事假）
         - 426.14（遲到早退）
         + 2,658.28（加班費）
         - 900（勞保）
         - 750（健保）
         = 48,309.41 → 48,309 元（四捨五入到整數）
```

---

### 案例三：曠職情況

**員工資料**
- 姓名：王小美
- 月薪：50,000 元
- 月份：2024年5月

**排班與考勤**
- 應出勤天數：22 天
- 實際出勤：20 天
- 曠職：2 天（無打卡記錄，未請假）
- 請假：0 天
- 遲到早退：0 分鐘
- 加班：0 小時

**詳細計算**

1. **日薪**
```
日薪 = 50,000 ÷ 22 = 2,272.7273 元/天
```

2. **曠職扣款**
```
曠職扣款 = 2 × 2,272.7273 = 4,545.4546 元
```

3. **額外懲處**（依公司規定）
```
全勤獎金：取消（假設 2,000 元）
```

4. **實領薪資**
```
實領薪資 = 50,000
         - 4,545.45（曠職）
         - 2,000（全勤獎金取消）
         - 900（勞保）
         - 750（健保）
         = 41,804.55 → 41,805 元（四捨五入到整數）
```

---

## 系統實作建議

### 資料庫設計

#### 1. 月度考勤彙總表 (MonthlyAttendanceSummary)
```javascript
{
  employee: ObjectId,
  month: Date,
  scheduledDays: Number,        // 應出勤天數
  actualWorkDays: Number,        // 實際出勤天數
  paidLeaveDays: Number,         // 有薪請假天數
  unpaidLeaveDays: Number,       // 無薪請假天數
  absenceDays: Number,           // 曠職天數
  lateMinutes: Number,           // 遲到分鐘數
  earlyLeaveMinutes: Number,     // 早退分鐘數
  overtimeHours: {               // 加班時數
    weekday: Number,
    weekend: Number,
    holiday: Number
  }
}
```

#### 2. 薪資計算明細表 (PayrollRecord)
```javascript
{
  employee: ObjectId,
  month: Date,
  baseSalary: Number,            // 基本薪資
  
  // 扣款項目
  leaveDeductions: Number,       // 請假扣款
  lateDeductions: Number,        // 遲到早退扣款
  absenceDeductions: Number,     // 曠職扣款
  
  // 加項
  overtimePay: Number,           // 加班費
  nightShiftAllowance: Number,   // 夜班津貼
  performanceBonus: Number,      // 績效獎金
  otherBonuses: Number,          // 其他獎金
  
  // 法定扣繳
  laborInsuranceFee: Number,     // 勞保費
  healthInsuranceFee: Number,    // 健保費
  laborPensionSelf: Number,      // 勞退自提
  
  // 其他扣款
  employeeAdvance: Number,       // 員工借支
  debtGarnishment: Number,       // 債權扣押
  otherDeductions: Number,       // 其他扣款
  
  // 結果
  netPay: Number,                // 實領薪資
  
  // 計算依據
  dailyWage: Number,             // 日薪
  hourlyWage: Number,            // 時薪
  workingDaysInMonth: Number,    // 當月工作天數
  
  createdAt: Date,
  updatedAt: Date
}
```

### 計算流程

```javascript
// 1. 彙整當月考勤數據
const attendanceSummary = await calculateMonthlyAttendance(employeeId, month);

// 2. 計算基本薪資參數
const workingDays = getWorkingDaysInMonth(month);
const dailyWage = baseSalary / workingDays;
const hourlyWage = dailyWage / 8;

// 3. 計算各項扣款
const leaveDeductions = calculateLeaveDeductions(attendanceSummary, dailyWage);
const lateDeductions = calculateLateDeductions(attendanceSummary, hourlyWage);
const absenceDeductions = attendanceSummary.absenceDays * dailyWage;

// 4. 計算加班費
const overtimePay = calculateOvertimePay(attendanceSummary, hourlyWage);

// 5. 計算法定扣繳
const insuranceFees = calculateInsuranceFees(baseSalary);

// 6. 計算實領薪資
const netPay = baseSalary
             - leaveDeductions
             - lateDeductions
             - absenceDeductions
             + overtimePay
             + otherBonuses
             - insuranceFees.labor
             - insuranceFees.health
             - laborPensionSelf
             - otherDeductions;
```

### API 端點建議

```
POST /api/payroll/calculate
     - 計算指定員工月份薪資（即時計算，不儲存）
     - Body: { employeeId, month }

POST /api/payroll/batch-calculate
     - 批次計算多位員工薪資
     - Body: { employeeIds[], month }

GET  /api/attendance/summary/:employeeId/:month
     - 取得員工月度考勤彙總

GET  /api/payroll/:employeeId/:month
     - 取得已儲存的薪資記錄

POST /api/payroll
     - 計算並儲存薪資記錄
     - Body: { employeeId, month, customData }
```

---

## 注意事項

### 法規遵循
1. **勞基法規定**
   - 正常工時：每日 8 小時，每週 40 小時
   - 延長工時：每日最多 12 小時，每月最多 46 小時
   - 休息日加班：應依法給付加班費

2. **特殊情況處理**
   - 部分工時員工：依實際工作時數比例計算
   - 變形工時：依核准的變形工時制度計算
   - 責任制員工：需另行約定

### 系統設計考量
1. **精確度**：
   - 中間計算過程保留到小數點後 4 位，避免累積誤差
   - 最終實領薪資四捨五入到整數（元）
   - 例如：日薪 = 50,000 ÷ 23 = 2,173.9130（保留小數）
   - 最後實領薪資才進位，如 48,308.65 → 48,309 元
2. **審計追蹤**：保留所有計算過程與依據
3. **例外處理**：提供手動調整機制，記錄調整原因
4. **通知機制**：薪資計算完成後通知員工確認
5. **報表產出**：提供薪資明細表供員工查閱

### 未來擴充
1. 彈性薪資項目設定
2. 不同職級/部門的薪資規則
3. 季度/年度獎金計算
4. 個人所得稅代扣代繳
5. 銀行轉帳批次處理

---

## 結論

本文件定義了一套完整的考勤、請假與薪資計算邏輯：

1. **考勤管理**：明確定義遲到、早退、曠職、加班的判定標準
2. **請假流程**：建立完整的請假申請與簽核機制
3. **薪資計算**：提供詳細的計算公式與實例說明

實作時應確保：
- 計算邏輯符合勞基法規定
- 系統自動化處理，減少人工錯誤
- 提供透明的薪資明細給員工
- 保留完整的計算記錄供查核

此設計可作為系統開發的規格文件，後續可依實際需求調整細節。
