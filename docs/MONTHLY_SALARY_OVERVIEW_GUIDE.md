# 月薪資總覽表完整操作指南

## 概述

本文檔詳細說明所有影響「月薪資總覽表」數據的來源、計算方式、以及如何正確設定和操作，以確保薪資數據的準確性和完整性。

## 月薪資總覽表顯示的項目

月薪資總覽表包含以下主要項目：

### 基本資訊
- 員工編號
- 姓名
- 部門
- 單位
- 薪資類型（月薪/日薪/時薪）

### 工作時數相關
- 上班天數
- 實際工時
- 時薪

### 請假相關
- 請假時數
- 請假扣款

### 加班相關
- 加班時數
- 加班費

### 夜班相關
- 夜班天數
- 夜班時數
- 夜班津貼

### 薪資計算
- 基本薪資
- 勞保費
- 健保費
- 勞退
- 其他扣款
- 績效獎金
- 其他獎金
- 定期津貼（薪資項目設定金額，匯入銀行B）
- **實發金額（總計）**

---

## 各項目的數據來源和設定方式

### 1. 基本薪資

#### 數據來源
- **員工個人資料** → 薪資設定

#### 計算方式
根據薪資類型不同：

**月薪制：**
```
基本薪資 = 員工設定的月薪金額
```

**日薪制：**
```
基本薪資 = 實際上班天數 × 日薪
```

**時薪制：**
```
基本薪資 = 實際工作時數 × 時薪
```

#### 設定步驟
1. 進入「員工管理」頁面
2. 選擇要編輯的員工，點擊「編輯」
3. 在「薪資資訊」區塊中設定：
   - **薪資類型**：選擇「月薪」、「日薪」或「時薪」
   - **薪資金額**：填寫對應的薪資數額
4. 點擊「儲存」

#### 注意事項
- 薪資類型一旦設定，影響整個薪資計算邏輯
- 日薪和時薪員工需要有完整的出勤記錄才能正確計算
- 月薪員工的基本薪資固定，不受出勤影響（但請假會扣款）

---

### 2. 上班天數和實際工時

#### 數據來源
1. **排班系統** → 班表設定（ShiftSchedule）
2. **出勤管理** → 打卡記錄（AttendanceRecord）
3. **考勤設定** → 班別設定（包含工作時間、休息時間）

#### 計算方式
```
上班天數 = 該月有出勤記錄的天數
實際工時 = Σ(每日下班時間 - 上班時間 - 休息時間)
```

#### 設定步驟

**步驟 1：設定班別**
1. 進入「考勤設定」頁面
2. 選擇「班別管理」分頁
3. 新增或編輯班別：
   - 班別名稱（如：早班、晚班、夜班）
   - 上班時間（如：08:00）
   - 下班時間（如：17:00）
   - 休息時間（如：12:00-13:00，共 60 分鐘）
   - 是否跨日（夜班需勾選）
   - **是否為夜班**（會影響夜班津貼計算）
   - **夜班津貼設定**（如有）

**步驟 2：建立排班**
1. 進入「排班管理」頁面
2. 選擇月份
3. 為每位員工分配班別：
   - 選擇員工
   - 選擇日期
   - 選擇班別
4. 可使用批次排班功能加速作業

**步驟 3：員工打卡**
1. 員工使用出勤系統打卡
2. 或由管理員在「出勤管理」頁面手動建立/修正打卡記錄
3. 確保上班和下班都有完整打卡

#### 注意事項
- 缺勤（未打卡）會影響日薪和時薪員工的薪資
- 月薪員工即使未打卡，基本薪資仍會發放（除非有請假）
- 遲到早退可能會有額外扣款（需在系統中啟用遲到早退自動扣款功能）

---

### 3. 請假扣款

#### 數據來源
- **簽核系統** → 請假申請表單（ApprovalRequest）
- 只計算狀態為「已核准」（status: approved）的請假申請

#### 計算方式

**時薪換算：**
- 月薪制：`時薪 = 月薪 ÷ 30天 ÷ 8小時`
- 日薪制：`時薪 = 日薪 ÷ 8小時`
- 時薪制：直接使用設定的時薪

**請假扣款計算：**
```
有薪假（不扣款）：特休、年假、婚假、喪假、產假、陪產假
半薪假（扣50%）：病假、生理假
無薪假（全額扣款）：事假、其他無薪假

請假扣款 = 無薪假時數 × 時薪
病假扣款 = 病假時數 × 時薪 × 0.5
```

#### 設定步驟

**步驟 1：設定假別**
1. 進入「簽核管理」→「表單設定」
2. 確認「請假申請」表單存在且已啟用
3. 表單欄位應包含：
   - 假別（下拉選單）
   - 開始日期
   - 結束日期
   - 請假天數/時數
   - 請假原因

**步驟 2：員工提交請假申請**
1. 員工在前台系統提交請假申請
2. 填寫完整的請假資訊
3. 提交簽核流程

**步驟 3：主管審核**
1. 主管在「簽核管理」頁面查看待審核請假
2. 審核通過（Approve）或駁回（Reject）
3. 只有「已核准」的請假會影響薪資計算

#### 注意事項
- 請假申請必須在當月提交並核准，才會影響當月薪資
- 假別名稱必須符合系統預設（如：特休、事假、病假等）
- 如需調整請假給薪規則，需修改後端程式碼

---

### 4. 加班費

#### 數據來源
- **簽核系統** → 加班申請表單（ApprovalRequest）
- 只計算狀態為「已核准」（status: approved）的加班申請
- 員工必須啟用「自動加班計算」功能（autoOvertimeCalc = true）

#### 計算方式
```
加班費 = 加班時數 × 時薪 × 1.5倍
```

註：實際應依勞基法規定計算不同倍率：
- 平日延長工時前2小時：1.33倍
- 平日延長工時第3小時起：1.66倍
- 休息日：前2小時1.33倍，後續1.66倍
- 例假日/國定假日：2倍

#### 設定步驟

**步驟 1：啟用員工自動加班計算**
1. 進入「員工管理」頁面
2. 選擇要編輯的員工，點擊「編輯」
3. 在「薪資設定」區塊中：
   - 勾選「自動加班計算」（autoOvertimeCalc）
4. 點擊「儲存」

**步驟 2：設定加班申請表單**
1. 進入「簽核管理」→「表單設定」
2. 確認「加班申請」或「加班單」表單存在且已啟用
3. 表單欄位應包含：
   - 加班日期
   - 加班時數
   - 加班原因

**步驟 3：員工提交加班申請**
1. 員工在前台系統提交加班申請
2. 填寫加班日期、時數、原因
3. 提交簽核流程

**步驟 4：主管審核**
1. 主管在「簽核管理」頁面查看待審核加班申請
2. 審核通過（Approve）或駁回（Reject）
3. 只有「已核准」的加班會計算加班費

#### 注意事項
- 必須先啟用「自動加班計算」，加班費才會自動計入薪資
- 加班費會匯入「銀行B」（獎金帳戶），與基本薪資分開
- 表單名稱必須包含「加班」字眼，系統才能正確識別

---

### 5. 夜班津貼

#### 數據來源
1. **考勤設定** → 班別設定（isNightShift = true 的班別）
2. **排班系統** → 夜班排班記錄
3. **出勤管理** → 實際夜班打卡記錄

#### 計算方式

**動態計算（根據實際排班）：**
```
時薪 = 月薪 ÷ 30 ÷ 8（月薪制）
夜班工作時數 = 夜班總時數 - 休息時間
夜班津貼倍數 = 班別設定的 allowanceMultiplier（如：0.34 = 34%）

單班津貼 = 時薪 × 夜班工作時數 × 津貼倍數
月夜班津貼 = Σ(所有夜班的單班津貼)
```

**固定津貼：**
```
月夜班津貼 = 固定金額 × 夜班天數
```

#### 設定步驟

**步驟 1：設定夜班班別**
1. 進入「考勤設定」頁面
2. 選擇「班別管理」分頁
3. 新增或編輯夜班班別：
   - 班別名稱（如：夜班）
   - 上班時間（如：22:00）
   - 下班時間（如：06:00）
   - **勾選「是否跨日」**
   - **勾選「是否為夜班」**
   - **勾選「是否有夜班津貼」**
   - **固定津貼金額**：填寫每班的固定津貼（如：500 元）
     - 或使用「津貼倍數」：填寫倍數（如：0.34 表示 34%）

**步驟 2：為夜班員工建立排班**
1. 進入「排班管理」頁面
2. 選擇月份
3. 為夜班員工分配夜班班別

**步驟 3：確認夜班員工打卡**
1. 確保夜班員工有完整的打卡記錄
2. 系統會自動識別夜班並計算津貼

**步驟 4（可選）：設定員工固定夜班津貼**
1. 進入「員工管理」頁面
2. 選擇員工，點擊「編輯」
3. 在「每月薪資調整項目」區塊：
   - **夜班補助津貼**：填寫固定月津貼金額
4. 點擊「儲存」

註：固定津貼會作為備用值，當無法從排班計算時使用

#### 注意事項
- **夜班津貼會匯入「銀行B」（獎金帳戶）**
- 夜班班別必須正確設定「是否為夜班」和津貼相關欄位
- 如果夜班津貼顯示為 0，請檢查：
  1. 班別設定是否正確（isNightShift = true, hasAllowance = true）
  2. 津貼金額或倍數是否已設定（fixedAllowanceAmount > 0 或 allowanceMultiplier > 0）
  3. 該月是否有夜班排班記錄
  4. 員工是否有夜班打卡記錄
- 可執行修復腳本自動檢查並修正夜班設定：
  ```bash
  cd server
  node scripts/fix-night-shift-allowance.js
  ```

---

### 6. 績效獎金和其他獎金

#### 數據來源
- **員工管理** → 每月薪資調整項目

#### 設定步驟
1. 進入「員工管理」頁面
2. 選擇員工，點擊「編輯」
3. 在「每月薪資調整項目」區塊中設定：
   - **人力績效獎金**：填寫固定月獎金
   - **其他獎金**：填寫其他固定獎金
4. 點擊「儲存」

#### 注意事項
- 這些獎金每月固定發放，不需簽核
- 獎金會匯入「銀行B」（獎金帳戶）
- 如需一次性獎金，應透過簽核流程處理

---

### 7. 勞保費、健保費、勞退

#### 數據來源
1. **勞保級距表** → 系統內建（LaborInsuranceRate）
2. **員工個人資料** → 健保費自付額、勞退自提比例

#### 計算方式

**勞保費：**
```
系統根據員工基本薪資自動查找對應的勞保級距
勞保費 = 勞保級距對應的員工自付額
```

**健保費：**
```
健保費 = 員工設定的健保費自付額（固定金額）
```

**勞退：**
```
勞退提繳 = 員工設定的勞退自提金額或比例
```

#### 設定步驟

**勞保級距（系統自動）：**
- 系統會根據基本薪資自動匹配勞保級距
- 如需更新勞保級距表，使用 API：
  ```
  POST /api/payroll/labor-insurance-rates/refresh
  ```

**健保費和勞退（員工個別設定）：**
1. 進入「員工管理」頁面
2. 選擇員工，點擊「編輯」
3. 在「每月薪資調整項目」區塊中設定：
   - **健保費自付額**：填寫每月健保費
   - **勞退個人提繳**：填寫勞退自提金額
4. 點擊「儲存」

---

### 8. 其他扣款

#### 數據來源
1. **員工管理** → 每月薪資調整項目
   - 債權扣押
   - 其他扣款
2. **系統自動計算** → 遲到早退扣款（如啟用）

#### 設定步驟

**固定扣款：**
1. 進入「員工管理」頁面
2. 選擇員工，點擊「編輯」
3. 在「每月薪資調整項目」區塊中設定：
   - **債權扣押**：填寫法院判決的扣押金額
   - **其他扣款**：填寫其他固定扣款（如制服費、員工借支等）
4. 點擊「儲存」

**遲到早退自動扣款：**
- 系統會自動根據出勤記錄計算遲到早退次數和時數
- 依設定的扣款規則自動計入「其他扣款」

---

## 銀行帳戶分配

系統支援雙銀行帳戶分配：

### 銀行 A（薪資帳戶）
**匯入金額：實發薪資**
```
實發薪資 = 基本薪資 
           - 請假扣款
           - 勞保費
           - 健保費
           - 勞退
           - 其他扣款
```

**包含項目：**
- 基本薪資（扣除請假後）
- 扣除所有保險和扣款項目

### 銀行 B（獎金帳戶）
**匯入金額：獎金總額**
```
獎金總額 = 加班費 
         + 夜班津貼
         + 績效獎金
         + 其他獎金
```

**包含項目：**
- 加班費（經簽核核准）
- 夜班津貼（根據排班自動計算或固定設定）
- 績效獎金（員工個人設定）
- 其他獎金（員工個人設定）

**特點：**
- 獎金不扣除任何費用
- 所有獎金項目加總
- 可能為零（無獎金時）

---

## 查看和匯出月薪資總覽

### 查看步驟
1. 進入「薪資管理設定」頁面
2. 選擇「月薪資總覽」分頁
3. 選擇要查詢的月份
4. （可選）使用篩選條件：
   - 機構
   - 部門
   - 單位
   - 員工姓名搜尋
5. 點擊「查詢」按鈕
6. 系統會顯示該月所有符合條件的員工薪資資料

### 查看員工詳細資料
1. 在薪資總覽表格中，找到要查看的員工
2. 點擊該員工列的「詳細」按鈕
3. 彈出對話框顯示完整資訊：
   - 基本資訊
   - 工作時數統計（含每日明細）
   - 請假統計（含請假記錄）
   - 加班統計（含加班記錄）
   - **夜班統計（含夜班天數、時數、津貼）**
   - 勞保級距資訊
   - 薪資計算明細（逐項列出）

### 匯出薪資資料
1. 在月薪資總覽頁面
2. 選擇匯出格式：
   - 臺灣企銀格式
   - 台中銀行格式
   - 個人獎金紙條
3. （可選）點擊「顯示示意表格」預覽格式
4. 點擊「下載匯出」按鈕
5. 系統會生成 Excel 檔案供下載

---

## 常見問題排解

### 問題 1：夜班津貼顯示為 0

**可能原因：**
1. 夜班班別未正確設定
2. 夜班津貼未啟用或金額為 0
3. 該月沒有夜班排班記錄
4. 員工沒有夜班打卡記錄

**解決方法：**
1. 檢查班別設定：
   - 確認「是否為夜班」已勾選
   - 確認「是否有夜班津貼」已勾選
   - 確認「固定津貼金額」或「津貼倍數」已填寫
2. 執行修復腳本：
   ```bash
   cd server
   node scripts/fix-night-shift-allowance.js
   ```
3. 檢查排班記錄：確認該員工該月有夜班排班
4. 檢查打卡記錄：確認員工有完整的夜班打卡

### 問題 2：加班費未顯示

**可能原因：**
1. 員工未啟用「自動加班計算」
2. 加班申請尚未核准
3. 加班表單名稱不符

**解決方法：**
1. 啟用自動加班計算：
   - 進入「員工管理」
   - 編輯員工
   - 勾選「自動加班計算」
2. 確認加班申請狀態：
   - 進入「簽核管理」
   - 確認加班申請為「已核准」狀態
3. 檢查表單名稱：
   - 表單名稱應包含「加班」字眼

### 問題 3：請假扣款不正確

**可能原因：**
1. 請假申請尚未核准
2. 假別設定錯誤
3. 請假政策與系統預設不符

**解決方法：**
1. 確認請假申請狀態為「已核准」
2. 檢查假別名稱是否正確（如：特休、事假、病假）
3. 如需調整請假給薪規則，聯絡系統管理員修改程式碼

### 問題 4：基本薪資計算錯誤

**可能原因：**
1. 薪資類型設定錯誤
2. 薪資金額未填寫或錯誤
3. 出勤記錄不完整（日薪/時薪員工）

**解決方法：**
1. 檢查員工薪資設定：
   - 確認薪資類型正確
   - 確認薪資金額正確填寫
2. 檢查出勤記錄（日薪/時薪員工）：
   - 確認有完整的排班
   - 確認有完整的打卡記錄

### 問題 5：月薪資總覽表顯示數據不齊全

**症狀：**
- 總覽表中某些項目（如夜班津貼）顯示為 0
- 點擊「詳細」按鈕後才看到正確數據

**原因：**
- 系統可能使用了舊的薪資記錄（PayrollRecord）
- 該記錄是在相關設定更新前建立的

**解決方法：**
1. **臨時解決**：點擊「詳細」按鈕查看正確數據
2. **永久解決**：刪除或更新舊的薪資記錄
   - 方法 1：在資料庫中刪除該月的 PayrollRecord
   - 方法 2：重新計算該月薪資
   - 方法 3：執行系統更新腳本（如有提供）

**預防措施：**
- 在更新班別設定、員工薪資設定等配置後，重新計算受影響月份的薪資
- 定期檢查薪資資料的準確性

---

## API 端點參考

### 獲取月薪資總覽
```
GET /api/payroll/overview/monthly?month=YYYY-MM-DD
```

**查詢參數：**
- `month`（必填）：月份，格式 YYYY-MM-DD
- `organization`（可選）：機構 ID
- `department`（可選）：部門 ID
- `subDepartment`（可選）：單位 ID
- `employeeId`（可選）：員工 ID

**回應範例：**
```json
[
  {
    "_id": "employee_id",
    "employeeId": "EMP001",
    "name": "王小明",
    "department": "工程部",
    "subDepartment": "開發組",
    "salaryType": "月薪",
    "workDays": 22,
    "actualWorkHours": 176.00,
    "hourlyRate": 166.67,
    "leaveHours": 8.00,
    "leaveDeduction": 1333,
    "overtimeHours": 10.00,
    "overtimePay": 2500,
    "nightShiftDays": 5,
    "nightShiftHours": 35.00,
    "nightShiftAllowance": 2000,
    "baseSalary": 40000,
    "laborInsuranceFee": 1000,
    "healthInsuranceFee": 500,
    "laborPensionSelf": 0,
    "otherDeductions": 0,
    "performanceBonus": 3000,
    "otherBonuses": 1000,
    "totalBonus": 8500,
    "netPay": 37167,
    "totalPayment": 45667,
    "hasPayrollRecord": false
  }
]
```

### 獲取員工完整工作資料
```
GET /api/payroll/complete-data/:employeeId/:month
```

**回應包含：**
- 工作時數統計
- 請假記錄和統計
- 加班記錄和統計
- 夜班統計和明細
- 每日出勤明細

---

## 系統限制和假設

1. **一天 8 小時制**：日薪和月薪換算時薪時，假設一天工作 8 小時
2. **一個月 30 天**：月薪換算日薪/時薪時，假設一個月 30 天
3. **加班費倍率**：目前簡化為統一 1.5 倍，未完全依照勞基法分級
4. **病假計算**：簡化為 0.5 倍扣款，未考慮年度累計天數

---

## 相關文件

- [薪資計算系統使用指南](./SALARY_CALCULATION_GUIDE.md)
- [夜班津貼功能實施總結](../NIGHT_SHIFT_ALLOWANCE_FIX_SUMMARY.md)
- [夜班津貼驗證指南](./NIGHT_SHIFT_VERIFICATION_GUIDE.md)
- [修復夜班津貼顯示為 0 的問題](../README_FIX_NOW.md)
- [員工每月薪資調整項目說明](./monthly-salary-adjustments.md)

---

## 總結

月薪資總覽表的數據來自多個系統模組的整合：

1. **員工管理** → 基本薪資、固定調整項目
2. **排班系統** → 工作時數、夜班安排
3. **出勤管理** → 實際打卡記錄
4. **簽核系統** → 請假和加班申請
5. **考勤設定** → 班別定義、夜班津貼規則
6. **系統計算** → 自動計算各項薪資和扣款

確保以上各項數據來源正確設定和維護，月薪資總覽表就能準確顯示所有員工的薪資資訊。
