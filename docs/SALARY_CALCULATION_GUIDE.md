# 薪資計算系統使用指南

## 概述

本系統整合了出勤記錄、請假審核、加班申請等資料，自動計算員工的月薪資。系統支援三種薪資類型：月薪、日薪、時薪。

## 薪資計算公式

### 1. 基本薪資計算

根據員工的薪資類型，基本薪資的計算方式不同：

#### 月薪制
```
基本薪資 = 固定月薪金額
```

#### 日薪制
```
基本薪資 = 上班天數 × 日薪
日薪 = 員工設定的日薪金額
```

#### 時薪制
```
基本薪資 = 實際工作時數 × 時薪
時薪 = 員工設定的時薪金額
```

### 2. 工作時數計算

系統會自動從出勤記錄計算工作時數：

```
實際工作時數 = Σ(每日下班打卡時間 - 上班打卡時間 - 休息時間)
上班天數 = 有出勤記錄的天數
```

### 3. 請假扣款計算

請假分為有薪假和無薪假：

**有薪假（不扣薪）：**
- 特休（年假）
- 婚假
- 喪假
- 產假
- 陪產假

**半薪假：**
- 病假（前30天半薪）
- 生理假

**無薪假（全額扣款）：**
- 事假
- 其他無薪假

**扣款計算公式：**
```
時薪換算：
- 月薪制：時薪 = 月薪 ÷ 30天 ÷ 8小時
- 日薪制：時薪 = 日薪 ÷ 8小時
- 時薪制：時薪 = 設定的時薪

請假扣款 = 無薪假時數 × 時薪
病假扣款 = 病假時數 × 時薪 × 0.5
```

### 4. 加班費計算

加班費根據勞基法規定計算（本系統簡化為1.5倍）：

```
加班費 = 加班時數 × 時薪 × 1.5
```

實際應依照勞基法：
- 平日延長工時前2小時：1.33倍
- 平日延長工時第3小時起：1.66倍
- 休息日：前2小時1.33倍，後續1.66倍
- 例假日/國定假日：2倍

### 5. 實發薪資計算

```
實發薪資 = 基本薪資 - 請假扣款 - 勞保費 - 健保費 - 勞退 - 其他扣款
```

### 6. 獎金計算

獎金項目單獨匯入指定銀行帳戶（銀行B）：

```
獎金總額 = 加班費 + 夜班津貼 + 績效獎金 + 其他獎金
```

## 銀行帳戶分配

系統支援雙帳戶匯款：

- **銀行A**：匯入實發薪資（基本薪資扣除所有扣款項目）
- **銀行B**：匯入獎金（加班費、績效獎金等）

## 資料來源

### 工作時數來源
1. 班表設定（ShiftSchedule）
2. 出勤打卡記錄（AttendanceRecord）
3. 班別設定（包含休息時間）

### 請假資料來源
1. 簽核系統的「請假」表單
2. 已核准（status: approved）的請假申請
3. 表單欄位：
   - 假別（typeId）
   - 開始日期（startId）
   - 結束日期（endId）
   - 天數/時數（days/hours）

### 加班資料來源
1. 簽核系統的「加班」表單
2. 已核准（status: approved）的加班申請
3. 表單欄位：
   - 加班日期
   - 加班時數
   - 加班原因

## API 端點

### 1. 獲取月薪資總覽
```
GET /api/payroll/overview/monthly?month=YYYY-MM-DD
```

支援篩選參數：
- `organization`: 機構ID
- `department`: 部門ID
- `subDepartment`: 單位ID
- `employeeId`: 員工ID

### 2. 獲取員工工作時數
```
GET /api/payroll/work-hours/:employeeId/:month
```

返回：
- 工作天數
- 應出勤時數
- 實際工作時數
- 每日出勤明細

### 3. 獲取請假影響
```
GET /api/payroll/leave-impact/:employeeId/:month
```

返回：
- 總請假時數
- 有薪假時數
- 無薪假時數
- 請假扣款金額
- 請假記錄明細

### 4. 獲取加班資料
```
GET /api/payroll/overtime/:employeeId/:month
```

返回：
- 加班時數
- 加班費
- 加班記錄明細

### 5. 獲取完整工作資料
```
GET /api/payroll/complete-data/:employeeId/:month
```

返回所有工作時數、請假、加班的完整資料。

## 使用流程

### 1. 查看月薪資總覽

1. 進入「薪資管理設定」頁面
2. 選擇「月薪資總覽」分頁
3. 選擇要查詢的月份
4. 可選擇機構、部門、單位進行篩選
5. 系統會自動計算並顯示所有員工的薪資資料

### 2. 查看員工詳細資料

1. 在薪資總覽表格中，點擊「詳細」按鈕
2. 彈出對話框顯示：
   - 基本資訊
   - 工作時數統計（包含每日明細）
   - 請假統計（包含請假記錄）
   - 加班統計（包含加班記錄）
   - 薪資計算明細

### 3. 薪資計算說明

在詳細對話框的「薪資計算明細」中，會顯示：

1. **基本薪資計算**
   - 月薪制：顯示固定月薪
   - 日薪制：顯示「天數 × 日薪」
   - 時薪制：顯示「工時 × 時薪」

2. **扣款項目**（紅色顯示）
   - 請假扣款：顯示無薪假時數
   - 勞保費
   - 健保費
   - 勞退提繳
   - 其他扣款

3. **獎金項目**（綠色顯示）
   - 加班費：顯示加班時數
   - 夜班津貼
   - 績效獎金
   - 其他獎金

4. **最終金額**
   - 實發金額（銀行A）
   - 獎金金額（銀行B）

## 注意事項

### 1. 資料準確性
- 確保班表已正確設定
- 確保員工有正確打卡
- 確保請假和加班申請已核准

### 2. 薪資類型設定
- 每位員工必須設定正確的薪資類型（月薪/日薪/時薪）
- 薪資金額必須正確填寫

### 3. 請假政策
- 系統預設的請假給薪規則可能與公司政策不同
- 如需調整，請修改 `workHoursCalculationService.js` 中的請假計算邏輯

### 4. 加班計算
- 員工必須啟用「自動加班計算」（autoOvertimeCalc = true）
- 加班費倍率目前設為1.5倍，如需調整請修改程式碼

### 5. 病假計算
- 病假目前設定為0.5倍扣款（半薪）
- 實際應依勞基法規定處理

## 自訂調整

### 修改請假政策

編輯 `server/src/services/workHoursCalculationService.js`，找到 `calculateLeaveImpact` 函數：

```javascript
// 根據假別分類
if (['特休', '年假', '婚假', '喪假', '產假', '陪產假'].includes(leaveType)) {
  paidLeaveHours += hours;
}
else if (['病假', '生理假'].includes(leaveType)) {
  sickLeaveHours += hours;
  unpaidLeaveHours += hours * 0.5; // 調整病假扣款比例
}
```

### 修改加班費倍率

編輯 `server/src/services/workHoursCalculationService.js`，找到 `calculateOvertimePay` 函數：

```javascript
const overtimePay = Math.round(totalOvertimeHours * hourlyRate * 1.5); // 調整倍率
```

## 疑難排解

### 問題：薪資顯示為 0

**可能原因：**
1. 該月份沒有班表
2. 員工沒有打卡記錄
3. 員工薪資金額未設定

**解決方法：**
1. 檢查班表設定
2. 檢查出勤記錄
3. 檢查員工資料中的薪資設定

### 問題：請假扣款不正確

**可能原因：**
1. 請假申請尚未核准
2. 假別設定錯誤
3. 請假政策與系統預設不符

**解決方法：**
1. 確認請假申請狀態
2. 檢查假別名稱是否正確
3. 調整請假計算邏輯

### 問題：加班費未顯示

**可能原因：**
1. 員工未啟用自動加班計算
2. 加班申請尚未核准
3. 加班表單名稱不符

**解決方法：**
1. 在員工設定中啟用 autoOvertimeCalc
2. 確認加班申請已核准
3. 檢查表單名稱是否為「加班」、「加班申請」或「加班單」

## 系統限制

1. **一天8小時制**：日薪和月薪換算時薪，假設一天工作8小時
2. **一個月30天**：月薪換算日薪/時薪時，假設一個月30天
3. **加班費倍率**：目前簡化為統一1.5倍，未完全依照勞基法分級
4. **病假計算**：簡化為0.5倍扣款，未考慮年度累計天數

## 未來改進方向

1. 支援更靈活的工時設定（如一天7.5小時、一週40小時）
2. 完整實現勞基法的加班費計算（1.33倍、1.66倍、2倍）
3. 支援病假年度累計計算（前30天全薪/半薪）
4. 支援更多假別（如公假、公傷假等）
5. 整合所得稅扣繳計算
6. 支援補休折抵加班費
7. 支援彈性工時制度

## 技術支援

如有任何問題，請聯繫系統管理員或參考以下文件：
- PayrollRecord 模型：`server/src/models/PayrollRecord.js`
- 工作時數計算服務：`server/src/services/workHoursCalculationService.js`
- 薪資計算服務：`server/src/services/payrollService.js`
- 前端界面：`client/src/components/backComponents/SalaryManagementSetting.vue`
