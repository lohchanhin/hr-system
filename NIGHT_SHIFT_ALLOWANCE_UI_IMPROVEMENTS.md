# 夜班津貼顯示改善說明

## 問題描述

點開薪資詳細的部分，夜班津貼可能顯示為 0，且沒有說明為什麼是 0 或如何計算。

## 解決方案

### 1. 薪資詳細頁面改善

#### 夜班統計區塊
在員工薪資詳細對話框中，夜班津貼現在會顯示計算方式：

- **根據排班計算**: 當津貼是根據實際排班動態計算時
- **固定津貼**: 當使用員工設定的固定津貼金額時
- **本月無夜班排班**: 當該月沒有夜班排班記錄時
- **未設定夜班班別**: 當班別設定中沒有夜班時

#### 薪資計算明細
在薪資計算明細表格中，夜班津貼項目會顯示：

- **動態計算**: "X 天夜班，共 X.XX 小時"
- **固定津貼**: "固定津貼"

### 2. 班別設定頁面改善

#### 倍率計算說明
```
倍率計算：津貼金額 = 基本時薪 × 夜班時數 × 津貼倍數
例如設定 0.5 表示夜班津貼為基本薪水的 50%
例如設定 1.5 表示夜班津貼為基本薪水的 1.5 倍
```

#### 固定津貼說明
```
固定津貼：每次上夜班可獲得固定金額的津貼
例如設定 200 元，則每上一次夜班可得 200 元津貼
```

## 計算邏輯說明

### 兩種津貼計算方式

#### 1. 固定津貼 (Fixed Allowance)
- **定義**: 每次上夜班可獲得固定金額的津貼
- **計算公式**: `津貼金額 = 固定津貼金額 × 夜班天數`
- **範例**:
  - 設定固定津貼：200 元/班
  - 當月夜班：20 天
  - 月津貼 = 200 × 20 = 4,000 元

#### 2. 倍率計算 (Multiplier Calculation)
- **定義**: 津貼金額根據基本薪水的倍數計算
- **計算公式**: `津貼金額 = 時薪 × 夜班工作時數 × 津貼倍數`
- **範例**:
  - 月薪：40,000 元
  - 時薪：40,000 ÷ 30天 ÷ 8小時 = 166.67 元/小時
  - 夜班時間：22:00-06:00，扣除 1 小時休息 = 7 小時
  - 津貼倍數：0.34 (34%)
  - 單班津貼 = 166.67 × 7 × 0.34 = 396.67 元
  - 月津貼（20 班）= 396.67 × 20 = 7,933 元

### 常見問題

#### Q1: 為什麼夜班津貼顯示為 0？
可能的原因：
1. **本月無夜班排班**: 該員工在這個月沒有被排到夜班
2. **未設定津貼倍數**: 班別雖然標記為夜班，但津貼倍數設定為 0
3. **未設定固定津貼**: 班別使用固定津貼模式，但固定金額為 0
4. **未設定夜班班別**: 出勤設定中沒有標記為夜班的班別

#### Q2: 如何設定夜班津貼？
1. 前往「班表設定」→「出勤設定」
2. 找到夜班班別（或新增一個）
3. 勾選「是否為夜班」
4. 勾選「是否有夜班津貼」
5. 選擇津貼計算方式：
   - **倍率計算**: 設定津貼倍數 > 0（例如 0.34 表示 34% 津貼）
   - **固定津貼**: 設定固定津貼金額 > 0（例如 200 元/班）

#### Q3: 倍率應該設定多少？
- **0.34**: 表示夜班津貼為基本薪水的 34%（常見於台灣勞基法夜班加成）
- **0.5**: 表示夜班津貼為基本薪水的 50%
- **1.0**: 表示夜班津貼等於基本薪水（雙倍薪）

#### Q4: 如何確認津貼計算正確？
1. 打開薪資管理 → 月薪資總覽
2. 選擇員工點擊「詳細」
3. 查看「夜班統計」區塊，確認：
   - 夜班天數
   - 夜班時數
   - 夜班津貼金額
   - 計算方式（根據排班計算/固定津貼/其他）
4. 查看「薪資計算明細」中的夜班津貼項目描述

## 技術細節

### 後端驗證
系統會在建立或更新班別時進行驗證：
- 倍率計算：`allowanceMultiplier` 必須 > 0
- 固定津貼：`fixedAllowanceAmount` 必須 > 0

### 計算優先順序
1. 自訂參數（如手動輸入）
2. 動態計算（根據排班和班別設定）
3. 固定設定（員工個人設定的固定津貼）

### 相關檔案
- **前端**: `client/src/components/backComponents/SalaryManagementSetting.vue`
- **前端**: `client/src/components/backComponents/ShiftScheduleSetting.vue`
- **後端**: `server/src/services/nightShiftAllowanceService.js`
- **後端**: `server/src/controllers/shiftController.js`
- **後端**: `server/src/models/AttendanceSetting.js`

## 測試建議

### 1. 測試倍率計算
1. 建立夜班班別，設定津貼倍數 0.34
2. 建立員工，設定月薪 40,000 元
3. 排班 20 天夜班
4. 查看薪資詳細，應顯示：
   - 夜班天數：20 天
   - 夜班時數：約 140 小時（20天 × 7小時）
   - 夜班津貼：約 7,933 元
   - 計算方式：根據排班計算

### 2. 測試固定津貼
1. 建立夜班班別，選擇固定津貼，設定 200 元/班
2. 建立員工
3. 排班 20 天夜班
4. 查看薪資詳細，應顯示：
   - 夜班天數：20 天
   - 夜班津貼：4,000 元（200 × 20）
   - 計算方式：根據排班計算

### 3. 測試無排班情況
1. 建立員工但不排夜班
2. 查看薪資詳細，應顯示：
   - 夜班天數：0 天
   - 夜班津貼：0 元或固定津貼
   - 計算方式：本月無夜班排班

## 更新日期
2025-12-22
